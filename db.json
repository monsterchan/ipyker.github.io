{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":0},{"_id":"source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":0},{"_id":"source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":0},{"_id":"source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":0},{"_id":"source/images/avatar.jpg","path":"images/avatar.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/1.jpg","path":"images/bar/1.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/3.jpg","path":"images/bar/3.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/42.jpg","path":"images/bar/42.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/6.jpg","path":"images/bar/6.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/beats.png","path":"images/bar/beats.png","modified":0,"renderable":0},{"_id":"source/images/bar/elasticsearch.png","path":"images/bar/elasticsearch.png","modified":0,"renderable":0},{"_id":"source/images/bar/gitcommand.jpg","path":"images/bar/gitcommand.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/gitlab.jpg","path":"images/bar/gitlab.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/http.jpg","path":"images/bar/http.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/https.jpg","path":"images/bar/https.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/markdown.jpg","path":"images/bar/markdown.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/mysql.jpg","path":"images/bar/mysql.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/nginx-variable.jpg","path":"images/bar/nginx-variable.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/playbook.jpg","path":"images/bar/playbook.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/xpack.png","path":"images/bar/xpack.png","modified":0,"renderable":0},{"_id":"source/images/pic/cerebro.png","path":"images/pic/cerebro.png","modified":0,"renderable":0},{"_id":"source/images/pic/http-cache.png","path":"images/pic/http-cache.png","modified":0,"renderable":0},{"_id":"source/images/pic/language.png","path":"images/pic/language.png","modified":0,"renderable":0},{"_id":"source/images/pic/multiline.jpg","path":"images/pic/multiline.jpg","modified":0,"renderable":0},{"_id":"source/images/pic/shouquanma.png","path":"images/pic/shouquanma.png","modified":0,"renderable":0},{"_id":"source/images/pic/tomcat1.png","path":"images/pic/tomcat1.png","modified":0,"renderable":0},{"_id":"source/images/pic/welcome-gitlab.png","path":"images/pic/welcome-gitlab.png","modified":0,"renderable":0},{"_id":"source/images/pic/x-pack.png","path":"images/pic/x-pack.png","modified":0,"renderable":0},{"_id":"themes/nexT/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/headbg.jpg","path":"images/headbg.jpg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/loading.gif","path":"images/loading.gif","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/placeholder.gif","path":"images/placeholder.gif","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/quote-l.svg","path":"images/quote-l.svg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/quote-r.svg","path":"images/quote-r.svg","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/searchicon.png","path":"images/searchicon.png","modified":0,"renderable":1},{"_id":"themes/nexT/source/images/sidebar-bg1.jpg","path":"images/sidebar-bg1.jpg","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/affix.js","path":"js/affix.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/algolia-search.js","path":"js/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/exturl.js","path":"js/exturl.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/js.cookie.js","path":"js/js.cookie.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/motion.js","path":"js/motion.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/next-boot.js","path":"js/next-boot.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/post-details.js","path":"js/post-details.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/scroll-cookie.js","path":"js/scroll-cookie.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/scrollspy.js","path":"js/scrollspy.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"source/images/bar/0.jpg","path":"images/bar/0.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/11.jpg","path":"images/bar/11.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/12.jpg","path":"images/bar/12.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/25.jpg","path":"images/bar/25.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/37.jpg","path":"images/bar/37.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/39.jpg","path":"images/bar/39.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/44.jpg","path":"images/bar/44.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/5.jpg","path":"images/bar/5.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/nginx.jpg","path":"images/bar/nginx.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/prometheus.jpg","path":"images/bar/prometheus.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/systemctl.jpg","path":"images/bar/systemctl.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/zabbix-02.jpg","path":"images/bar/zabbix-02.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/zabbix-03.jpg","path":"images/bar/zabbix-03.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/zabbix-05.jpg","path":"images/bar/zabbix-05.jpg","modified":0,"renderable":0},{"_id":"source/images/pic/tls.jpg","path":"images/pic/tls.jpg","modified":0,"renderable":0},{"_id":"themes/nexT/source/images/avatar.jpg","path":"images/avatar.jpg","modified":0,"renderable":1},{"_id":"source/images/bar/14.jpg","path":"images/bar/14.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/16.jpg","path":"images/bar/16.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/18.jpg","path":"images/bar/18.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/20.jpg","path":"images/bar/20.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/23.jpg","path":"images/bar/23.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/28.jpg","path":"images/bar/28.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/35.jpg","path":"images/bar/35.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/7.jpg","path":"images/bar/7.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/aliyun.jpg","path":"images/bar/aliyun.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/elastic-k8s.png","path":"images/bar/elastic-k8s.png","modified":0,"renderable":0},{"_id":"source/images/bar/kernel.jpg","path":"images/bar/kernel.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/tomcat.jpg","path":"images/bar/tomcat.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/zabbix-01.jpg","path":"images/bar/zabbix-01.jpg","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config011.png","path":"images/pic/zabbix/zabbix-config011.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config014.png","path":"images/pic/zabbix/zabbix-config014.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config015.png","path":"images/pic/zabbix/zabbix-config015.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config016.png","path":"images/pic/zabbix/zabbix-config016.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config017.png","path":"images/pic/zabbix/zabbix-config017.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config018.png","path":"images/pic/zabbix/zabbix-config018.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config019.png","path":"images/pic/zabbix/zabbix-config019.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config023.png","path":"images/pic/zabbix/zabbix-config023.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config024.png","path":"images/pic/zabbix/zabbix-config024.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config025.png","path":"images/pic/zabbix/zabbix-config025.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config027.png","path":"images/pic/zabbix/zabbix-config027.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config029.png","path":"images/pic/zabbix/zabbix-config029.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config031.png","path":"images/pic/zabbix/zabbix-config031.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config033.png","path":"images/pic/zabbix/zabbix-config033.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config034.png","path":"images/pic/zabbix/zabbix-config034.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config035.png","path":"images/pic/zabbix/zabbix-config035.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config037.png","path":"images/pic/zabbix/zabbix-config037.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config042.png","path":"images/pic/zabbix/zabbix-config042.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config043.png","path":"images/pic/zabbix/zabbix-config043.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix1.png","path":"images/pic/zabbix/zabbix1.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix2.png","path":"images/pic/zabbix/zabbix2.png","modified":0,"renderable":0},{"_id":"themes/nexT/source/images/reward/alipay.png","path":"images/reward/alipay.png","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/schemes/pisces.js","path":"js/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/js/src/clicklove.js","path":"js/src/clicklove.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/bookmark/LICENSE","path":"lib/bookmark/LICENSE","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/bookmark/README.md","path":"lib/bookmark/README.md","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/bookmark/bookmark.min.js","path":"lib/bookmark/bookmark.min.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/bookmark/index.js","path":"lib/bookmark/index.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/bookmark/package.json","path":"lib/bookmark/package.json","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/canvas-nest/LICENSE","path":"lib/canvas-nest/LICENSE","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/canvas-nest/README.md","path":"lib/canvas-nest/README.md","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/canvas-nest/canvas-nest.min.js","path":"lib/canvas-nest/canvas-nest.min.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/canvas-nest/canvas-nest-nomobile.min.js","path":"lib/canvas-nest/canvas-nest-nomobile.min.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/canvas-ribbon/LICENSE","path":"lib/canvas-ribbon/LICENSE","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/canvas-ribbon/README.md","path":"lib/canvas-ribbon/README.md","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/canvas-ribbon/canvas-ribbon.js","path":"lib/canvas-ribbon/canvas-ribbon.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/fancybox/LICENSE","path":"lib/fancybox/LICENSE","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/fancybox/README.md","path":"lib/fancybox/README.md","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/fastclick/LICENSE","path":"lib/fastclick/LICENSE","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/fastclick/README.md","path":"lib/fastclick/README.md","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/fastclick/bower.json","path":"lib/fastclick/bower.json","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/font-awesome/HELP-US-OUT.txt","path":"lib/font-awesome/HELP-US-OUT.txt","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/font-awesome/bower.json","path":"lib/font-awesome/bower.json","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/jquery_lazyload/LICENSE","path":"lib/jquery_lazyload/LICENSE","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/jquery_lazyload/README.md","path":"lib/jquery_lazyload/README.md","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/jquery_lazyload/bower.json","path":"lib/jquery_lazyload/bower.json","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/jquery_lazyload/jquery.lazyload.js","path":"lib/jquery_lazyload/jquery.lazyload.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/jquery_lazyload/jquery.scrollstop.js","path":"lib/jquery_lazyload/jquery.scrollstop.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/LICENSE","path":"lib/pace/LICENSE","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/README.md","path":"lib/pace/README.md","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-barber-shop.min.css","path":"lib/pace/pace-theme-barber-shop.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-big-counter.min.css","path":"lib/pace/pace-theme-big-counter.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-bounce.min.css","path":"lib/pace/pace-theme-bounce.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-center-atom.min.css","path":"lib/pace/pace-theme-center-atom.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-center-circle.min.css","path":"lib/pace/pace-theme-center-circle.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-center-radar.min.css","path":"lib/pace/pace-theme-center-radar.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-center-simple.min.css","path":"lib/pace/pace-theme-center-simple.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-corner-indicator.min.css","path":"lib/pace/pace-theme-corner-indicator.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-fill-left.min.css","path":"lib/pace/pace-theme-fill-left.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-flash.min.css","path":"lib/pace/pace-theme-flash.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-loading-bar.min.css","path":"lib/pace/pace-theme-loading-bar.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-mac-osx.min.css","path":"lib/pace/pace-theme-mac-osx.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace-theme-minimal.min.css","path":"lib/pace/pace-theme-minimal.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/pace/pace.min.js","path":"lib/pace/pace.min.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/quicklink/LICENSE","path":"lib/quicklink/LICENSE","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/quicklink/README.md","path":"lib/quicklink/README.md","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/quicklink/quicklink.umd.js","path":"lib/quicklink/quicklink.umd.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/LICENSE","path":"lib/three/LICENSE","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/README.md","path":"lib/three/README.md","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/canvas_lines.min.js","path":"lib/three/canvas_lines.min.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/canvas_sphere.min.js","path":"lib/three/canvas_sphere.min.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/gulpfile.js","path":"lib/three/gulpfile.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/package.json","path":"lib/three/package.json","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/three-waves.min.js","path":"lib/three/three-waves.min.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/yarn.lock","path":"lib/three/yarn.lock","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/velocity/velocity.ui.js","path":"lib/velocity/velocity.ui.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"source/images/bar/32.jpg","path":"images/bar/32.jpg","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config002.png","path":"images/pic/zabbix/zabbix-config002.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config004.png","path":"images/pic/zabbix/zabbix-config004.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config005.png","path":"images/pic/zabbix/zabbix-config005.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config007.png","path":"images/pic/zabbix/zabbix-config007.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config009.png","path":"images/pic/zabbix/zabbix-config009.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config010.png","path":"images/pic/zabbix/zabbix-config010.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config012.png","path":"images/pic/zabbix/zabbix-config012.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config013.png","path":"images/pic/zabbix/zabbix-config013.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config020.png","path":"images/pic/zabbix/zabbix-config020.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config021.png","path":"images/pic/zabbix/zabbix-config021.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config022.png","path":"images/pic/zabbix/zabbix-config022.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config030.png","path":"images/pic/zabbix/zabbix-config030.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config032.png","path":"images/pic/zabbix/zabbix-config032.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config036.png","path":"images/pic/zabbix/zabbix-config036.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config038.png","path":"images/pic/zabbix/zabbix-config038.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config039.png","path":"images/pic/zabbix/zabbix-config039.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config040.png","path":"images/pic/zabbix/zabbix-config040.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config041.png","path":"images/pic/zabbix/zabbix-config041.png","modified":0,"renderable":0},{"_id":"themes/nexT/source/images/reward/wechatpay.png","path":"images/reward/wechatpay.png","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/jquery/index.js","path":"lib/jquery/index.js","modified":0,"renderable":1},{"_id":"source/images/bar/13.jpg","path":"images/bar/13.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/ansible.jpg","path":"images/bar/ansible.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/docker.jpg","path":"images/bar/docker.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/zabbix-04.jpg","path":"images/bar/zabbix-04.jpg","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config001.png","path":"images/pic/zabbix/zabbix-config001.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config003.png","path":"images/pic/zabbix/zabbix-config003.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config008.png","path":"images/pic/zabbix/zabbix-config008.png","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config028.png","path":"images/pic/zabbix/zabbix-config028.png","modified":0,"renderable":0},{"_id":"themes/nexT/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/fancybox/source/jquery.fancybox.min.css","path":"lib/fancybox/source/jquery.fancybox.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/fastclick/lib/fastclick.js","path":"lib/fastclick/lib/fastclick.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/fastclick/lib/fastclick.min.js","path":"lib/fastclick/lib/fastclick.min.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/font-awesome/css/font-awesome.css.map","path":"lib/font-awesome/css/font-awesome.css.map","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/lib/CanvasRenderer.js","path":"lib/three/lib/CanvasRenderer.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/lib/Projector.js","path":"lib/three/lib/Projector.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/src/canvas_lines.js","path":"lib/three/src/canvas_lines.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/src/canvas_sphere.js","path":"lib/three/src/canvas_sphere.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/src/three-waves.js","path":"lib/three/src/three-waves.js","modified":0,"renderable":1},{"_id":"source/images/bar/15.jpg","path":"images/bar/15.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/8.jpg","path":"images/bar/8.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/9.jpg","path":"images/bar/9.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/kibana.jpg","path":"images/bar/kibana.jpg","modified":0,"renderable":0},{"_id":"source/images/pic/zabbix/zabbix-config026.png","path":"images/pic/zabbix/zabbix-config026.png","modified":0,"renderable":0},{"_id":"themes/nexT/source/lib/fancybox/source/jquery.fancybox.min.js","path":"lib/fancybox/source/jquery.fancybox.min.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"source/images/pic/zabbix/zabbix-config006.png","path":"images/pic/zabbix/zabbix-config006.png","modified":0,"renderable":0},{"_id":"themes/nexT/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/velocity/velocity.js","path":"lib/velocity/velocity.js","modified":0,"renderable":1},{"_id":"source/images/bar/36.jpg","path":"images/bar/36.jpg","modified":0,"renderable":0},{"_id":"source/images/bar/zabbix-06.jpg","path":"images/bar/zabbix-06.jpg","modified":0,"renderable":0},{"_id":"themes/nexT/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"source/images/bar/29.jpg","path":"images/bar/29.jpg","modified":0,"renderable":0},{"_id":"themes/nexT/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/nexT/source/lib/three/three.min.js","path":"lib/three/three.min.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"d6be0e55d7c1b1604530cae2cac8d54888839928","modified":1553515520128},{"_id":"themes/nexT/.all-contributorsrc","hash":"43eb0149c78e464c695f0dd758bb8c59353182b3","modified":1559008943718},{"_id":"themes/nexT/.bowerrc","hash":"334da94ca6f024d60d012cc26ea655681e724ad8","modified":1559008943718},{"_id":"themes/nexT/.editorconfig","hash":"211d2c92bfdddb3e81ea946f4ca7a539f150f4da","modified":1559008943719},{"_id":"themes/nexT/.eslintrc.json","hash":"d3c11de434171d55d70daadd3914bc33544b74b8","modified":1559008943719},{"_id":"themes/nexT/.gitattributes","hash":"8454b9313cb1a97b63fb87e2d29daee497ce6249","modified":1559008943720},{"_id":"themes/nexT/.gitignore","hash":"e1464a4807540f2a32d791140dd0471ea8b39c22","modified":1559008943730},{"_id":"themes/nexT/.stylintrc","hash":"3b7f9785e9ad0dab764e1c535b40df02f4ff5fd6","modified":1559008943730},{"_id":"themes/nexT/.travis.yml","hash":"fb9ac54e875f6ea16d5c83db497f6bd70ae83198","modified":1559008943731},{"_id":"themes/nexT/LICENSE.md","hash":"0a9c7399f102b4eb0a6950dd31264be421557c7d","modified":1559008943731},{"_id":"themes/nexT/README.md","hash":"3f72e5a5051ca2bdaccdda684c46dc4fdb4413a6","modified":1559008943732},{"_id":"themes/nexT/_config.yml","hash":"de3eeaa874e4b5ea2f14b0572166b05b2f4c41fa","modified":1559008943732},{"_id":"themes/nexT/bower.json","hash":"070292487d141982c9bef64bd32e1cb39d03d395","modified":1559008943732},{"_id":"themes/nexT/gulpfile.coffee","hash":"6407d9063bd88ede299ff7c2a59cf2c82e079476","modified":1559008943747},{"_id":"themes/nexT/crowdin.yml","hash":"4a53f5985e545c635cb56b2a57ed290cb8cf8942","modified":1559008943733},{"_id":"themes/nexT/package.json","hash":"d3ea523f723aafd6bebcd8a47a0d976c69dfeaf5","modified":1559008943793},{"_id":"source/_posts/Nginx-location.md","hash":"36299b21815bd9c106686eaa3012b71dc3f8e721","modified":1559008943500},{"_id":"source/_posts/aliyun-ecs-mail.md","hash":"f4ab05189f8d4d2a6ddde6920fad915ec2eeb818","modified":1559008943500},{"_id":"source/_posts/ansible-module.md","hash":"d61bdc465f5301ef4a231d066a380fd846517041","modified":1559008943501},{"_id":"source/_posts/ansible-playbook.md","hash":"fa471e516fbb3998a89435945a1b123251e5db21","modified":1559008943501},{"_id":"source/_posts/centos-kernel-analysis.md","hash":"2f0611cb447f7c1ee09c3d0d74564c6fbe45ed8a","modified":1559008943502},{"_id":"source/_posts/elastic-x-pack.md","hash":"c9a8219322303ca68a24d6e14830aa68d692884c","modified":1559008943502},{"_id":"source/_posts/filebeat.md","hash":"4c8847d1381186c52659dbc804254b2ef4ac99d9","modified":1559008943504},{"_id":"source/_posts/git-command.md","hash":"ffa8db0fc1e2b3bf95dd9549c43cec43238b65d6","modified":1559008943504},{"_id":"source/_posts/hexo-next.md","hash":"2967e065d99c832f8fbc99d5e5214377260ecba4","modified":1558855830604},{"_id":"source/_posts/http-header.md","hash":"ba456753052a9ba3968e07238e70d0b7be690b6e","modified":1559008943504},{"_id":"source/_posts/https-tls.md","hash":"cde1ac26eaef1dbe24f8f49da9e8ad0170f438b0","modified":1559008943504},{"_id":"source/_posts/install-docker-ce.md","hash":"427e697c218e4da387a1a23c6949326b8f9a46fc","modified":1559008943505},{"_id":"source/_posts/install-efk.md","hash":"a18f96ddbb17aefbc7f38b95ea1560152ccf02d3","modified":1559008943505},{"_id":"source/_posts/install-gitlab-ce.md","hash":"a9982b37b91f7d0f8abc16cb7bcbe2d7b892be5e","modified":1559008943505},{"_id":"source/_posts/markdown-format.md","hash":"bea24d7d297ee76a92c774bcb9f52c764916b98f","modified":1558944552894},{"_id":"source/_posts/mysql-status.md","hash":"fa6e609c8cc821a69024432a7d0d6631f42ad8ea","modified":1559008943506},{"_id":"source/_posts/nginx-variable.md","hash":"43f2083bc4e80396b33c5dca9a934fdce65d9d2f","modified":1559008943507},{"_id":"source/_posts/prometheus.md","hash":"7d7f4d6f08c7ffe91b40b93cc60f5b123ace7aa4","modified":1559008943507},{"_id":"source/_posts/systemctl-unit.md","hash":"9236b32afdd126a117a9c079d018c793f740949b","modified":1559008943508},{"_id":"source/_posts/tomcat-apr.md","hash":"b6bf36133afb85f56c1b1479f8949a55a8062028","modified":1559008943508},{"_id":"source/_posts/zabbix-agent.md","hash":"011b520915a36dcab7f3e171277f2dc021c5a334","modified":1559008943508},{"_id":"source/_posts/zabbix-item.md","hash":"222886179ab7cb3abd629ca265ceb361462c68c9","modified":1559008943509},{"_id":"source/_posts/zabbix-server.md","hash":"77c8cd88253d2baee56b6cc2b63b09ce3bca46b7","modified":1559008943509},{"_id":"source/_posts/zabbix-summarize.md","hash":"0eb8a66e0e92d96b8b0743cbc2321a6f7529e4c7","modified":1559008943510},{"_id":"source/_posts/zabbix-trigger.md","hash":"b7b417ac2d05ff71553dde14ab98b50a652b27e9","modified":1559008943510},{"_id":"source/_posts/zabbox-alert.md","hash":"3a535c3dfbde18a4d32f95e31952f258ca70f645","modified":1559008943510},{"_id":"source/about/index.md","hash":"81f44cba2f821bed6644a003fbb603e49dedee3d","modified":1558955679929},{"_id":"source/about/index.html","hash":"7ae65ac326f5e398a89784db60ab1fb9fc5d8304","modified":1559008943511},{"_id":"source/categories/index.md","hash":"4943137d32d9d5d077c1a655e7128fe0cc4c43cc","modified":1558765565293},{"_id":"source/guestbook/index.md","hash":"dccf6308fcd52af315d914435659139d1538eb2f","modified":1559008943512},{"_id":"source/images/apple-touch-icon-next.png","hash":"531900f543a4db1ec5b4f0a3b20c9cc7c4120b53","modified":1558700193204},{"_id":"source/images/favicon-16x16-next.png","hash":"dad40a34bfcc79c3ea2a502d5b60ce25362b81cf","modified":1558700193212},{"_id":"source/images/favicon-32x32-next.png","hash":"7366345ff442a170ff75154bb955d5c1ce8036d0","modified":1558700193212},{"_id":"source/images/logo.svg","hash":"20f66224fee48857fb5e3b4587d0d8a8ebdc1055","modified":1558700193212},{"_id":"source/tags/index.md","hash":"3f884b29fbee406ca2d60e43b0626f82b9db4d0c","modified":1558765552435},{"_id":"themes/nexT/.github/CODE_OF_CONDUCT.md","hash":"f7ddb7faed8031a9f40eae4ee7bb48c1bc50fd14","modified":1559008943720},{"_id":"themes/nexT/.github/CONTRIBUTING.md","hash":"046262c4b2f54b5ed8ac19b0c99aad04968e01e5","modified":1559008943721},{"_id":"themes/nexT/.github/ISSUE_TEMPLATE.md","hash":"1e212fe229bd659726b4a3bcf4b5b14e0310ba3a","modified":1559008943721},{"_id":"themes/nexT/.github/PULL_REQUEST_TEMPLATE.md","hash":"f1631b9bef922e7bc2db1e33badfad70fd88d459","modified":1559008943726},{"_id":"themes/nexT/.github/auto_assign.yml","hash":"9fe0dbe3f6edc59bf10ea25b14eba0e92e2c8f42","modified":1559008943727},{"_id":"themes/nexT/.github/config.yml","hash":"cbd06d0c40afa9fdf056765120e9085826b00d20","modified":1559008943727},{"_id":"themes/nexT/.github/eslint-disable-bot.yml","hash":"e06053d417579ed967a94166deb6bda5ce41d805","modified":1559008943727},{"_id":"themes/nexT/.github/mergeable.yml","hash":"1c1cb77a62df1e3654b151c2da34b4a10d351170","modified":1559008943728},{"_id":"themes/nexT/.github/lock.yml","hash":"4f1070097b614b24050f238694127e3573ce8472","modified":1559008943728},{"_id":"themes/nexT/.github/release-drafter.yml","hash":"d01b1e8f462af114e3934fef2ee654634d86b406","modified":1559008943728},{"_id":"themes/nexT/.github/stale.yml","hash":"85975c43d606c39b91c0ad32197154be9d482a09","modified":1559008943728},{"_id":"themes/nexT/.github/support.yml","hash":"7ce2722d6904c31a086444c422dc49b6aa310651","modified":1559008943729},{"_id":"themes/nexT/.github/topissuebot.yml","hash":"5091c3bc6f3df303d16d853ce65a302601c1e875","modified":1559008943729},{"_id":"themes/nexT/.github/weekly-digest.yml","hash":"6db3bcad65c3156de298f6a3ffd3ba887af4aa4f","modified":1559008943729},{"_id":"themes/nexT/docs/AGPL3.md","hash":"f463f95b169d64983f59fa6f3e4b6760290a0e6b","modified":1559008943735},{"_id":"themes/nexT/docs/ALGOLIA-SEARCH.md","hash":"1e49c08b446678336b2eacc8bf581faca969f34b","modified":1559008943735},{"_id":"themes/nexT/docs/AUTHORS.md","hash":"51a0a13da55ff3d596970b2f9ab4531c6b2211f2","modified":1559008943737},{"_id":"themes/nexT/docs/DATA-FILES.md","hash":"9a1895c0a0db705c4c48f512e86917f9af1ec3fb","modified":1559008943737},{"_id":"themes/nexT/docs/INSTALLATION.md","hash":"b74ef6fedf76cdb156e2265759ee0a789ddd49cc","modified":1559008943739},{"_id":"themes/nexT/docs/LEANCLOUD-COUNTER-SECURITY.md","hash":"721a1aa9feed1b580ab99af8e69ed22699121e88","modified":1559008943739},{"_id":"themes/nexT/docs/LICENSE.txt","hash":"ae5ad07e4f4106bad55535dba042221539e6c7f9","modified":1559008943740},{"_id":"themes/nexT/docs/MATH.md","hash":"7d0330c250082a86897d1c96fbb4ef5df59538af","modified":1559008943740},{"_id":"themes/nexT/docs/UPDATE-FROM-5.1.X.md","hash":"c9f2ed8e15c137b1885d9ca8b7197d9f457971e9","modified":1559008943741},{"_id":"themes/nexT/languages/de.yml","hash":"79b3221344da335743b5ef5a82efa9338d64feb0","modified":1559008943747},{"_id":"themes/nexT/languages/default.yml","hash":"ea5e6aee4cb14510793ac4593a3bddffe23e530c","modified":1558634875000},{"_id":"themes/nexT/languages/en.yml","hash":"d66b8b48840443a4f9c72c7696a21e292f685a47","modified":1559008943748},{"_id":"themes/nexT/languages/es.yml","hash":"db1a9f2af477212544c830c2dd986400e26ddd6a","modified":1559008943748},{"_id":"themes/nexT/languages/fa.yml","hash":"3227072c7e1bfb16ec0517394b60632f4be921dd","modified":1559008943749},{"_id":"themes/nexT/languages/fr.yml","hash":"2429c90dad5bb865e3a969be2b373f19b3a77b3b","modified":1559008943749},{"_id":"themes/nexT/languages/id.yml","hash":"f3302a4dfdc9be38a52d6e081411574b1ea01671","modified":1559008943749},{"_id":"themes/nexT/languages/it.yml","hash":"31eb878b53d60ff47e3e534cdd7a839c8801ac6e","modified":1559008943750},{"_id":"themes/nexT/languages/ja.yml","hash":"3f25eca504ee5a519987b4402731f1bb7f5191c9","modified":1559008943750},{"_id":"themes/nexT/languages/ko.yml","hash":"75f2fe142f76bf623e34ed3570598226f55f2b8b","modified":1559008943751},{"_id":"themes/nexT/languages/nl.yml","hash":"08f16ce395dacc88847fc30dc6b985ce22fb8948","modified":1559008943751},{"_id":"themes/nexT/languages/pt-BR.yml","hash":"c7de8b77f44e75be4f04423088a1c891537aa601","modified":1559008943751},{"_id":"themes/nexT/languages/pt.yml","hash":"ca5072c967e5eb1178ffed91827459eda6e4e6e2","modified":1559008943752},{"_id":"themes/nexT/languages/ru.yml","hash":"720b92a9ec075b68737d296b1f29ad8e01151c85","modified":1559008943752},{"_id":"themes/nexT/languages/tr.yml","hash":"6d2f53d3687a7a46c67c78ab47908accd8812add","modified":1559008943752},{"_id":"themes/nexT/languages/uk.yml","hash":"6320439c6e9ff81e5b8f8129ca16e9a744b37032","modified":1559008943753},{"_id":"themes/nexT/languages/vi.yml","hash":"e2f0dd7f020a36aa6b73ed4d00dcc4259a7e5e9d","modified":1559008943753},{"_id":"themes/nexT/languages/zh-CN.yml","hash":"069f15da910d6f9756be448167c07ea5aa5dc346","modified":1559008943753},{"_id":"themes/nexT/languages/zh-HK.yml","hash":"c22113c4a6c748c18093dae56da5a9e8c5b963cd","modified":1559008943754},{"_id":"themes/nexT/languages/zh-TW.yml","hash":"dbf4dd87716babb2db4f5332fae9ec190a6f636a","modified":1559008943754},{"_id":"themes/nexT/layout/_layout.swig","hash":"d94735de2f164b5893fef2ab092e68fb775df549","modified":1559008943756},{"_id":"themes/nexT/layout/archive.swig","hash":"61bc56e77e653684fc834f63dcbdadf18687c748","modified":1559008943791},{"_id":"themes/nexT/layout/category.swig","hash":"ad0ac6a1ff341f8eab9570e7fb443962948c5f9d","modified":1559008943791},{"_id":"themes/nexT/layout/index.swig","hash":"bdcc9f57adef49706b16b107791cacecbc23c1dc","modified":1559008943791},{"_id":"themes/nexT/layout/page.swig","hash":"5d06ee8f477ffc39932d0251aa792ffcaf8faf14","modified":1559008943792},{"_id":"themes/nexT/layout/post.swig","hash":"af74e97d57cf00cde6f8dbd4364f27910915454e","modified":1559008943792},{"_id":"themes/nexT/layout/schedule.swig","hash":"e79f43df0e9a6cf48bbf00882de48c5a58080247","modified":1559008943792},{"_id":"themes/nexT/layout/tag.swig","hash":"283519d4d5b67814412863a3e0212bac18bcc5a0","modified":1559008943793},{"_id":"themes/nexT/scripts/merge-configs.js","hash":"5f96f63e86825fd7028c2522e4111103e261a758","modified":1559008943795},{"_id":"themes/nexT/scripts/merge.js","hash":"39b84b937b2a9608b94e5872349a47200e1800ff","modified":1559008943796},{"_id":"themes/nexT/test/.jshintrc","hash":"c9fca43ae0d99718e45a6f5ce736a18ba5fc8fb6","modified":1559008943913},{"_id":"themes/nexT/test/helpers.js","hash":"f25e7f3265eb5a6e1ccbb5e5012fa9bebf134105","modified":1559008943914},{"_id":"themes/nexT/test/intern.js","hash":"db90b1063356727d72be0d77054fdc32fa882a66","modified":1559008943914},{"_id":"source/images/avatar.jpg","hash":"d415ffaf3157a079d8c5fc35c1ac56736256da0c","modified":1558765874722},{"_id":"themes/nexT/layout/_custom/sidebar.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1558777745667},{"_id":"themes/nexT/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1558634875000},{"_id":"source/images/bar/1.jpg","hash":"20ec429cac584672bfe974b0d0b0e3aaace99ebd","modified":1553357004353},{"_id":"source/images/bar/3.jpg","hash":"772cc34d670a67394f048ab4c4904b301c16495b","modified":1553357022864},{"_id":"source/images/bar/42.jpg","hash":"ee0db87420c90e7d1094932e1f8de0984f99c8e5","modified":1553403568964},{"_id":"source/images/bar/6.jpg","hash":"cd420156233418ffa06a7cc2c42d6b42d1efc00d","modified":1553356953121},{"_id":"source/images/bar/beats.png","hash":"bd0640099ff2265f53f6d1e55bd6cb1391472fe2","modified":1558356940009},{"_id":"source/images/bar/elasticsearch.png","hash":"061080ac7426a51fffafa0644c2ba7fd94463f06","modified":1558356940011},{"_id":"source/images/bar/gitcommand.jpg","hash":"9f7b7add770eb1345dba2decc32d0ade18a2bc05","modified":1557241327803},{"_id":"source/images/bar/gitlab.jpg","hash":"898ade9853ed181d21a69691d1c6ea45253d8836","modified":1553866728938},{"_id":"source/images/bar/http.jpg","hash":"fed4298d8b6e3e8831bbf21920c5cb0d8940c83e","modified":1553699666656},{"_id":"source/images/bar/https.jpg","hash":"7ddbf7f36d30fa7fa4bfa0ce6a843a0c21c80db0","modified":1553602989168},{"_id":"source/images/bar/markdown.jpg","hash":"af6d43429432bb5c623f6655ac7fa1ba63843790","modified":1553356966402},{"_id":"source/images/bar/mysql.jpg","hash":"b030d0e716acf323525a7dc6302c48f6f8f01ddc","modified":1553356977952},{"_id":"source/images/bar/nginx-variable.jpg","hash":"eabcfee98a77ff767af9cb2549f3d6cf70728e27","modified":1553403526577},{"_id":"source/images/bar/playbook.jpg","hash":"4a277e3710912cf0b991fe39e2cc8e46e95912e2","modified":1557245377339},{"_id":"source/images/bar/xpack.png","hash":"43e50ff7f1d4f12dfba14a337a4cc3f66ef85ed7","modified":1558356940016},{"_id":"source/images/pic/cerebro.png","hash":"de84fe740d7f6e7867e2f042113c7f5abfdf144b","modified":1558613362137},{"_id":"source/images/pic/http-cache.png","hash":"89934dca7bb847ad864a0afd80cf1225153599d9","modified":1555077389925},{"_id":"source/images/pic/language.png","hash":"d9f788d97861dcf48df39e76db8def7943a0ddef","modified":1553866320765},{"_id":"source/images/pic/multiline.jpg","hash":"1481fd7e7bb688b4b29b49d6861551ebbe35f8eb","modified":1558613362137},{"_id":"source/images/pic/shouquanma.png","hash":"b55a167280fa1eeb5b3223a3de82c312fc891c2c","modified":1553526151386},{"_id":"source/images/pic/tomcat1.png","hash":"bc1afbfca7f790a47c760f2da4f5bfe3566c2dd8","modified":1553602989168},{"_id":"source/images/pic/welcome-gitlab.png","hash":"374ace5280513d9c8eb8a7efb6747901481659d7","modified":1553866320765},{"_id":"source/images/pic/x-pack.png","hash":"16055d46f86bd08179e6791ce1485431f7ca91b3","modified":1558356940017},{"_id":"themes/nexT/.github/ISSUE_TEMPLATE/bug-report.md","hash":"795b8ddb251da8e2327299d5f7dbf446fb9867c6","modified":1559008943722},{"_id":"themes/nexT/.github/ISSUE_TEMPLATE/custom-issue-template.md","hash":"245917ffaa296bc2d9a85444acf639077ca25944","modified":1559008943725},{"_id":"themes/nexT/.github/ISSUE_TEMPLATE/feature-request.md","hash":"59b2b45e151972bbe08582cde22f398e58832765","modified":1559008943725},{"_id":"themes/nexT/.github/ISSUE_TEMPLATE/non-english.md","hash":"ae22e700b7c63c60746321719a20d34022ad78d9","modified":1559008943726},{"_id":"themes/nexT/docs/ru/DATA-FILES.md","hash":"a51de08657f5946f4028b11373280ddc04639525","modified":1559008943741},{"_id":"themes/nexT/docs/ru/INSTALLATION.md","hash":"7b2963daac19b0c14f98ebef375d5fbce8fc3f44","modified":1559008943742},{"_id":"themes/nexT/docs/ru/README.md","hash":"aeb95129ab1da9ec41786bfa86dc32c739ee6358","modified":1559008943742},{"_id":"themes/nexT/docs/ru/UPDATE-FROM-5.1.X.md","hash":"1a4e41adcf5831057f3f7b3025ed4a5ef7c442b4","modified":1559008943742},{"_id":"themes/nexT/docs/zh-CN/ALGOLIA-SEARCH.md","hash":"aaf25d304793344e2d026062768c93005723f5c6","modified":1559008943743},{"_id":"themes/nexT/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"018a259694f4a8c7c384e1f323531442cba5fbf3","modified":1559008943743},{"_id":"themes/nexT/docs/zh-CN/CONTRIBUTING.md","hash":"16d98708de86efe40ebcb02c02a01af0f160b80a","modified":1559008943744},{"_id":"themes/nexT/docs/zh-CN/DATA-FILES.md","hash":"67f4a987e7db0ab1ce1ea4c311f2961df07b6681","modified":1559008943744},{"_id":"themes/nexT/docs/zh-CN/INSTALLATION.md","hash":"baca12cc24be082f1db28c7f283493569666321c","modified":1559008943745},{"_id":"themes/nexT/docs/zh-CN/LEANCLOUD-COUNTER-SECURITY.md","hash":"b17fc344ff61603f83387c0f9b2b2189aae81d50","modified":1559008943745},{"_id":"themes/nexT/docs/zh-CN/MATH.md","hash":"db2797f161e1e7a4987cbfa3d1be682266dfbba6","modified":1559008943745},{"_id":"themes/nexT/docs/zh-CN/README.md","hash":"4016948fdb971e4f905efb7a5bb3add3dd58e7a8","modified":1559008943746},{"_id":"themes/nexT/docs/zh-CN/UPDATE-FROM-5.1.X.md","hash":"2095d1214a4e519a1d31b67b41c89080fa3285d3","modified":1559008943746},{"_id":"themes/nexT/layout/_custom/head.swig","hash":"a223919d2e1bf17ca4d6abb2c86f2efca9883dc1","modified":1559008943755},{"_id":"themes/nexT/layout/_custom/header.swig","hash":"ba8ab5a0280b953aa97435ff8946cbcbb2755a27","modified":1559008943755},{"_id":"themes/nexT/layout/_macro/passage-end-tag.swig","hash":"fc5158971d0972512f14765574ffb295d481b7fa","modified":1558724167956},{"_id":"themes/nexT/layout/_macro/post-collapse.swig","hash":"891ab67815969dd8736cb22fbbb3f791b8fff4e4","modified":1559008943758},{"_id":"themes/nexT/layout/_macro/post.swig","hash":"35850b88a102c5d82595d549bcafbcef9a0652e1","modified":1559008943758},{"_id":"themes/nexT/layout/_macro/sidebar.swig","hash":"91017f58f83d9505ce99109fffdc51c032bf017e","modified":1559008943759},{"_id":"themes/nexT/layout/_partials/comments.swig","hash":"d0b9e841d55c974d02f43823a06a2627f8e46431","modified":1559008943759},{"_id":"themes/nexT/layout/_partials/github-banner.swig","hash":"319a534c1c0bc5e8f916b4e57d794b2510ebf32d","modified":1559008943760},{"_id":"themes/nexT/layout/_partials/footer.swig","hash":"7b4cf6cc17247c5d34723356c2682a407fa4bd39","modified":1559008943760},{"_id":"themes/nexT/layout/_partials/pagination.swig","hash":"914155d5d758306cff405beefd4a07973fd8fc77","modified":1559008943765},{"_id":"themes/nexT/layout/_partials/post-edit.swig","hash":"dee345054d564dd56f74bb143942d3edd1cb8150","modified":1559008943765},{"_id":"themes/nexT/layout/_scripts/commons.swig","hash":"cccd93d30787675010b1a74ef02eb5b813ec1d96","modified":1559008943771},{"_id":"themes/nexT/layout/_scripts/exturl.swig","hash":"c2e8f4b3a2bf991320ecc827dcdc227399ad5b51","modified":1559008943771},{"_id":"themes/nexT/layout/_scripts/next-boot.swig","hash":"50c3ae6b50f173ae70f8c3312f7c6da1097eb9b6","modified":1559008943772},{"_id":"themes/nexT/layout/_scripts/noscript.swig","hash":"efb3404a3303622f3be60944d9d1926972c5c248","modified":1559008943772},{"_id":"themes/nexT/layout/_scripts/scroll-cookie.swig","hash":"8a992b7fe42b9c1a5eb9d937b0827aed91586d94","modified":1559008943774},{"_id":"themes/nexT/layout/_scripts/vendors.swig","hash":"4130f995f0c4f81a44266194ecae9df96fad174c","modified":1559008943775},{"_id":"themes/nexT/layout/_third-party/baidu-push.swig","hash":"87bcb495f7ddd81cc3fe2c2a886e51c08053019b","modified":1559008943780},{"_id":"themes/nexT/layout/_third-party/bookmark.swig","hash":"4b93dc7ac0573c402aabcb5c933bbcb893b07c51","modified":1559008943780},{"_id":"themes/nexT/layout/_third-party/chatra.swig","hash":"87182367d7954457cb2498bbfa9445c03c2d619e","modified":1559008943781},{"_id":"themes/nexT/layout/_third-party/copy-code.swig","hash":"e0d65688661875200cb4dd401fc5ac833c697f91","modified":1559008943784},{"_id":"themes/nexT/layout/_third-party/mermaid.swig","hash":"80dfc0879866e6512cb67590a3b2d8741a66f980","modified":1559008943786},{"_id":"themes/nexT/layout/_third-party/needsharebutton.swig","hash":"7db4ad4a8dd5420dad2f6890f5299945df0af970","modified":1559008943786},{"_id":"themes/nexT/layout/_third-party/pangu.swig","hash":"76f5933925670044ec65b454295ba7e0a8439986","modified":1559008943787},{"_id":"themes/nexT/layout/_third-party/pdf.swig","hash":"4ae61c7efb16e962385bfe522a38c4d29cdcccbe","modified":1559008943787},{"_id":"themes/nexT/layout/_third-party/quicklink.swig","hash":"8b1322a091355853db62a5aafb8886fdbd8ab56a","modified":1559008943787},{"_id":"themes/nexT/layout/_third-party/rating.swig","hash":"c476dc3693a9dd0be2d136a45b0d7fdef55d4d92","modified":1559008943788},{"_id":"themes/nexT/layout/_third-party/schedule.swig","hash":"882cd0b68c493af1b6d945660f9c21085e006ffc","modified":1559008943788},{"_id":"themes/nexT/layout/_third-party/tidio.swig","hash":"b44010cd577e4d063c3406772938c4b117ec7b7b","modified":1559008943790},{"_id":"themes/nexT/scripts/filters/exturl.js","hash":"b19c7c1021e57367b3b3bbf5678381017ed5667d","modified":1559008943794},{"_id":"themes/nexT/scripts/helpers/engine.js","hash":"cdb6152582313268d970ffeef99b4a8a7850f034","modified":1559008943794},{"_id":"themes/nexT/scripts/helpers/next-url.js","hash":"a40ce6bc852bb4bff8b9f984fa064741dd151e96","modified":1559008943795},{"_id":"themes/nexT/scripts/tags/button.js","hash":"95a520f6529424a03c7ead6dbfd5e626d672febb","modified":1559008943796},{"_id":"themes/nexT/scripts/tags/center-quote.js","hash":"4519ab8e6898f2ee90d05cde060375462b937a7d","modified":1559008943797},{"_id":"themes/nexT/scripts/tags/exturl.js","hash":"f9f25905adecfb8be49def4ff3b0b8bbc6955d84","modified":1559008943797},{"_id":"themes/nexT/scripts/tags/full-image.js","hash":"a6b2264215c555c553b2c5db85fa90678798d0d5","modified":1559008943797},{"_id":"themes/nexT/scripts/tags/group-pictures.js","hash":"23d839333422375e85d44e476f554faf49973a3c","modified":1559008943798},{"_id":"themes/nexT/scripts/tags/include-raw.js","hash":"ab4a82a7246265717556c7a42f897430340b88cf","modified":1559008943798},{"_id":"themes/nexT/scripts/tags/label.js","hash":"fc83f4e1be2c34e81cb79938f4f99973eba1ea60","modified":1559008943799},{"_id":"themes/nexT/scripts/tags/mermaid.js","hash":"81134494ff0134c0dae1b3815caf6606fccd4e46","modified":1559008943799},{"_id":"themes/nexT/scripts/tags/note.js","hash":"1fdf4f95810fdb983bfd5ad4c4f13fedd4ea2f8d","modified":1559008943799},{"_id":"themes/nexT/scripts/tags/pdf.js","hash":"ab995f0fc60d60f637220e2651111b775b8a06de","modified":1559008943799},{"_id":"themes/nexT/scripts/tags/tabs.js","hash":"72a5adbd8f300bee1d0c289367598ca06b2bed17","modified":1559008943800},{"_id":"themes/nexT/scripts/tags/video.js","hash":"944293fec96e568d9b09bc1280d5dbc9ee1bbd17","modified":1559008943800},{"_id":"themes/nexT/source/css/main.styl","hash":"b451349d86d280f271eafbdb0dea04f94aa83b88","modified":1559008943847},{"_id":"themes/nexT/source/images/algolia_logo.svg","hash":"45eeea0b5fba833e21e38ea10ed5ab385ceb4f01","modified":1559008943848},{"_id":"themes/nexT/source/images/apple-touch-icon-next.png","hash":"531900f543a4db1ec5b4f0a3b20c9cc7c4120b53","modified":1558700193204},{"_id":"themes/nexT/source/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1559008943850},{"_id":"themes/nexT/source/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1559008943850},{"_id":"themes/nexT/source/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1559008943851},{"_id":"themes/nexT/source/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1559008943851},{"_id":"themes/nexT/source/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1559008943851},{"_id":"themes/nexT/source/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1559008943852},{"_id":"themes/nexT/source/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1559008943852},{"_id":"themes/nexT/source/images/favicon-16x16-next.png","hash":"dad40a34bfcc79c3ea2a502d5b60ce25362b81cf","modified":1558700193212},{"_id":"themes/nexT/source/images/favicon-32x32-next.png","hash":"7366345ff442a170ff75154bb955d5c1ce8036d0","modified":1558700193212},{"_id":"themes/nexT/source/images/headbg.jpg","hash":"85e0b80411d54bf27bfffc1bbd40049ca1946dc3","modified":1558885948122},{"_id":"themes/nexT/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1558634875000},{"_id":"themes/nexT/source/images/logo.svg","hash":"20f66224fee48857fb5e3b4587d0d8a8ebdc1055","modified":1558700193212},{"_id":"themes/nexT/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1558634875000},{"_id":"themes/nexT/source/images/quote-l.svg","hash":"cd108d6f44351cadf8e6742565217f88818a0458","modified":1559008943855},{"_id":"themes/nexT/source/images/quote-r.svg","hash":"2a2a250b32a87c69dcc1b1976c74b747bedbfb41","modified":1559008943855},{"_id":"themes/nexT/source/images/searchicon.png","hash":"025d64ba0160a3a2257dd2b3032b5f7c9dd9b82b","modified":1558634875000},{"_id":"themes/nexT/source/images/sidebar-bg1.jpg","hash":"56143c34ae82ae734b54f65af4d8d06fc3092029","modified":1558775864768},{"_id":"themes/nexT/source/js/affix.js","hash":"ad343aa406fd8181b5f310434817ce98fc2219e3","modified":1559008943859},{"_id":"themes/nexT/source/js/algolia-search.js","hash":"84906eeae57bd06744dd20160b93eacf658f97e2","modified":1559008943859},{"_id":"themes/nexT/source/js/exturl.js","hash":"c48aa4b3c0e578a807fd3661e6cd4f3890777437","modified":1559008943859},{"_id":"themes/nexT/source/js/js.cookie.js","hash":"f11e84def0352b7dd6393f1b83e55a40ab468686","modified":1559008943860},{"_id":"themes/nexT/source/js/motion.js","hash":"d0a6d9dbcc57159e54bbb1f683b86632ae0b78f0","modified":1559008943860},{"_id":"themes/nexT/source/js/next-boot.js","hash":"696a0c2cf158001576d56b48195ec8e39e835b47","modified":1559008943860},{"_id":"themes/nexT/source/js/post-details.js","hash":"7d309b771e86c7e22ce11cc25625481ef7d5985c","modified":1559008943861},{"_id":"themes/nexT/source/js/scroll-cookie.js","hash":"c4867626afab749404daf321367f9b6b8e223f69","modified":1559008943863},{"_id":"themes/nexT/source/js/scrollspy.js","hash":"68d3690152c89e7adb08bb35ec28dbda2bd93686","modified":1559008943863},{"_id":"themes/nexT/source/js/utils.js","hash":"fed16cd4fa5fac8cb4a63633d1840792a056f2be","modified":1559008943864},{"_id":"source/images/bar/0.jpg","hash":"5122112eba55651d9fb982160eaf51cc3f237cdc","modified":1553357013818},{"_id":"source/images/bar/11.jpg","hash":"dc845f25ead88606c0ef40a9ba2689e3c809ddc7","modified":1553357501485},{"_id":"source/images/bar/12.jpg","hash":"01c14cb0dafa89755fa6d56366bd187e4f733378","modified":1553357520064},{"_id":"source/images/bar/25.jpg","hash":"15c21e56be49e0e8677509a661fd9855d628d350","modified":1553357873955},{"_id":"source/images/bar/37.jpg","hash":"a6e8ebafb7f339113e6b0479ef99bd6f49ea1c00","modified":1553358293507},{"_id":"source/images/bar/39.jpg","hash":"089eba8393ab7d5a8105adf6f2d46caaed24222f","modified":1553403494064},{"_id":"source/images/bar/44.jpg","hash":"5cf223855fd05b961a22ee935e526de0bc0e26a4","modified":1553403614532},{"_id":"source/images/bar/5.jpg","hash":"e322fcb931209a0c12f1df69d31da85e744d9681","modified":1553356992341},{"_id":"source/images/bar/nginx.jpg","hash":"3da99c0d508f72585eb9564673f74ccdfce4d9db","modified":1553357488204},{"_id":"source/images/bar/prometheus.jpg","hash":"ddcf444dd08e8367926cc81910e51c63e5577f56","modified":1556289122662},{"_id":"source/images/bar/systemctl.jpg","hash":"ed8449415e055c2f35ef10780910feacfdbbd681","modified":1558356940016},{"_id":"source/images/bar/zabbix-02.jpg","hash":"26fe72d7119977c01ff493602147debe7fe83a62","modified":1555077549230},{"_id":"source/images/bar/zabbix-03.jpg","hash":"c84d358df2fac3db521fe5c0dcdecca895d82c9f","modified":1553357799477},{"_id":"source/images/bar/zabbix-05.jpg","hash":"62e6dda8baec3890359d5b860291d46407bd2b96","modified":1556289122662},{"_id":"source/images/pic/tls.jpg","hash":"cbd3afe29b9a9d5286e107ee5249f9fdd264a840","modified":1553602989168},{"_id":"themes/nexT/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1558634875000},{"_id":"themes/nexT/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1558634875000},{"_id":"themes/nexT/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1558634875000},{"_id":"themes/nexT/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1558634875000},{"_id":"themes/nexT/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1558634875000},{"_id":"themes/nexT/source/images/avatar.jpg","hash":"d415ffaf3157a079d8c5fc35c1ac56736256da0c","modified":1558765874722},{"_id":"source/images/bar/14.jpg","hash":"aadba743ee97c06555ae486182c6d796cb23273c","modified":1553357615125},{"_id":"source/images/bar/16.jpg","hash":"ac4e5f55833628ce19258c1d9b0462f7c34c7036","modified":1553357659944},{"_id":"source/images/bar/18.jpg","hash":"c9e42307f8462b54a77d615db0568cbbe1cb0a56","modified":1553357698066},{"_id":"source/images/bar/20.jpg","hash":"97bc5b8e9807287f0b249e020948ab0f39c8059e","modified":1553357744370},{"_id":"source/images/bar/23.jpg","hash":"f15f3cd7a874ce47b452af9db42dd3c8973a915e","modified":1553357820167},{"_id":"source/images/bar/28.jpg","hash":"cd9348ac01bd5305c845af9675a37fc25a49391a","modified":1553358065617},{"_id":"source/images/bar/35.jpg","hash":"16bc623ca7e1c1257f99912a19e6091e635be8b6","modified":1553358249663},{"_id":"source/images/bar/7.jpg","hash":"d1aa303837c9eb2e01eeddb900d9d9f529b993eb","modified":1553357444543},{"_id":"source/images/bar/aliyun.jpg","hash":"241c9ff2b8acf2189495a07fc6dfa0ef669b98ca","modified":1553357835000},{"_id":"source/images/bar/elastic-k8s.png","hash":"4d5701d96467b1e6c18948ecd0f5a8103b627dc4","modified":1558356940010},{"_id":"source/images/bar/kernel.jpg","hash":"88cfc5e0ca681d1003e47cf36c7b11c033b892ea","modified":1553357680514},{"_id":"source/images/bar/tomcat.jpg","hash":"b350075c1f0fd0b1ad644b6536cb0934911f7fc6","modified":1553602989168},{"_id":"source/images/bar/zabbix-01.jpg","hash":"6915f40cc0f203e40d7fcb771b8f0793a2345ae0","modified":1555077549229},{"_id":"source/images/pic/zabbix/zabbix-config011.png","hash":"de76ce596395099216bc06a67f4aeddb3dc4b331","modified":1555214721052},{"_id":"source/images/pic/zabbix/zabbix-config014.png","hash":"1ccbd6cf303773b58c7cb5c36b6c6b09474e13b4","modified":1555224167136},{"_id":"source/images/pic/zabbix/zabbix-config015.png","hash":"083f64f50ff025c42ffbc23035956877a060bda4","modified":1555222737749},{"_id":"source/images/pic/zabbix/zabbix-config016.png","hash":"62d8d831e8ad84bc654043574361a2f7b5a704f4","modified":1555222833562},{"_id":"source/images/pic/zabbix/zabbix-config017.png","hash":"0080e9750b7b8ee2a4836123beee214f2b60fa11","modified":1555224506586},{"_id":"source/images/pic/zabbix/zabbix-config018.png","hash":"c4105e8ed25eb72f2bd55951908fa2140e448a5a","modified":1555237215884},{"_id":"source/images/pic/zabbix/zabbix-config019.png","hash":"fe78fdd516f75ddab3c389d83156636d18daef09","modified":1555230522905},{"_id":"source/images/pic/zabbix/zabbix-config023.png","hash":"e21b3c7541012d6486a6e0334a1f86a45e53d4a3","modified":1556289122672},{"_id":"source/images/pic/zabbix/zabbix-config024.png","hash":"ec65345b5c582dd892f9a692f6c33227b0f76f68","modified":1556289122672},{"_id":"source/images/pic/zabbix/zabbix-config025.png","hash":"57bb2c80b1271e2ee39d93350d54dd012e1787c1","modified":1556289122672},{"_id":"source/images/pic/zabbix/zabbix-config027.png","hash":"7faf357c870db01723441169800fd6e72c9f812a","modified":1556289122672},{"_id":"source/images/pic/zabbix/zabbix-config029.png","hash":"2eb8aaec04a722d8c2b86f42b5524c6caf41c30c","modified":1556289122672},{"_id":"source/images/pic/zabbix/zabbix-config031.png","hash":"fc7798b4b2e3217b2fbceb4083fe5ccbdd764435","modified":1556289122682},{"_id":"source/images/pic/zabbix/zabbix-config033.png","hash":"13ab08f5f8517d77ccc71ee6e32cee4db9ff187c","modified":1556289122682},{"_id":"source/images/pic/zabbix/zabbix-config034.png","hash":"6ad1e1cdb9fb561abe9bb6791b0c654ad813178a","modified":1556289122682},{"_id":"source/images/pic/zabbix/zabbix-config035.png","hash":"cf386ce64e84646e3adcfc3b692f6dc7e6d88164","modified":1556289122682},{"_id":"source/images/pic/zabbix/zabbix-config037.png","hash":"2d908db85daf40787c6bd9b9435f8e5f9af91744","modified":1556289122682},{"_id":"source/images/pic/zabbix/zabbix-config042.png","hash":"f14c98474a23fd1b71b2611b7b44c868ccdb1366","modified":1556289122692},{"_id":"source/images/pic/zabbix/zabbix-config043.png","hash":"87cd698636914f88a4e72aa4a693984f02e76bbc","modified":1556289122692},{"_id":"source/images/pic/zabbix/zabbix1.png","hash":"31931351749a8e815cd71a3be8db45b7aab7454c","modified":1555077389925},{"_id":"source/images/pic/zabbix/zabbix2.png","hash":"44027de4ad5aa697d68064231d77798502680791","modified":1555077389925},{"_id":"themes/nexT/layout/_macro/menu/menu-badge.swig","hash":"4eb8e222dc337211efb0d3bbdb5e29af3e6ecdb8","modified":1559008943757},{"_id":"themes/nexT/layout/_macro/menu/menu-item.swig","hash":"25aea3d764b952f3f6d28ab86d7212d138e892df","modified":1559008943757},{"_id":"themes/nexT/layout/_partials/head/external-fonts.swig","hash":"b57bf9c865bed0f22157176a8085de168a1aef77","modified":1559008943761},{"_id":"themes/nexT/layout/_partials/head/head-unique.swig","hash":"fd079a414ca0f42f4cddd00247a9d5a5f58c4d8e","modified":1559008943761},{"_id":"themes/nexT/layout/_partials/head/head.swig","hash":"bb20fbd6bd306f979c75e650ddae5ed2c76a8d08","modified":1559008943762},{"_id":"themes/nexT/layout/_partials/header/brand.swig","hash":"03f669356bbaa70144b743f3312178e1981ac3a8","modified":1559008943763},{"_id":"themes/nexT/layout/_partials/header/index.swig","hash":"c909f6e96373c151dea325bcddfdd8c9522421b6","modified":1559008943763},{"_id":"themes/nexT/layout/_partials/header/menu.swig","hash":"39c4ad0e36b7c1260da98ba345f7bd72a2ac0f2e","modified":1559008943763},{"_id":"themes/nexT/layout/_partials/header/sub-menu.swig","hash":"e015c7d9b84062b60b15b36be3ef11929dd10943","modified":1559008943764},{"_id":"themes/nexT/layout/_partials/page/breadcrumb.swig","hash":"2b905ddd5dea8558c3fd95aacad241da6b6800f4","modified":1559008943764},{"_id":"themes/nexT/layout/_partials/page/page-header.swig","hash":"f46699a9daa5fef599733cbab35cb75cf7a05444","modified":1559008943765},{"_id":"themes/nexT/layout/_partials/post/post-copyright.swig","hash":"be6683db6a269d83bb0441d7cf74db63a240fa8a","modified":1559008943766},{"_id":"themes/nexT/layout/_partials/post/post-related.swig","hash":"f331ad02beea8990066d32ad6ec9f859672c3615","modified":1559008943766},{"_id":"themes/nexT/layout/_partials/post/reward.swig","hash":"f62b801c7999da67b4bdca9c5e373b9b5ed039dc","modified":1559008943767},{"_id":"themes/nexT/layout/_partials/post/wechat-subscriber.swig","hash":"fb7727e8ec63a58238a7206bf70eb273c8879993","modified":1559008943767},{"_id":"themes/nexT/layout/_partials/search/algolia-search.swig","hash":"2530de0f3125a912756f6c0e9090cd012134a4c5","modified":1559008943768},{"_id":"themes/nexT/layout/_partials/search/index.swig","hash":"f14e9e8c27af82f1bfe794e252dec0d7e521f503","modified":1559008943768},{"_id":"themes/nexT/layout/_partials/search/localsearch.swig","hash":"b2f0d247b213e4cf8de47af6a304d98070cc7256","modified":1559008943769},{"_id":"themes/nexT/layout/_partials/search/swiftype.swig","hash":"31245e09ce0465b994cebd94223a531585c4eab4","modified":1559008943769},{"_id":"themes/nexT/layout/_partials/share/add-this.swig","hash":"c609097b95eb6127c2784f47f2230e6e6efc0be2","modified":1559008943769},{"_id":"themes/nexT/layout/_partials/share/baidushare.swig","hash":"54b43d406cf37932e7b60f46814e864d31b1842c","modified":1559008943770},{"_id":"themes/nexT/layout/_partials/share/likely.swig","hash":"647e8677d1ccfb3f7918dd3ea2ff7078504a845d","modified":1559008943770},{"_id":"themes/nexT/layout/_scripts/pages/post-details.swig","hash":"cf87ab778618a32119ec1c4ac2079a51385b1913","modified":1559008943772},{"_id":"themes/nexT/layout/_scripts/schemes/gemini.swig","hash":"a62c93f19429f159bcf0c2e533ffc619aa399755","modified":1559008943773},{"_id":"themes/nexT/layout/_scripts/schemes/mist.swig","hash":"3c548934b97cc426544947f7a2ae35c270b5e33f","modified":1559008943773},{"_id":"themes/nexT/layout/_scripts/schemes/muse.swig","hash":"7ef07edd2a97a3774229990d2f0a6eefa31bd015","modified":1559008943774},{"_id":"themes/nexT/layout/_scripts/schemes/pisces.swig","hash":"828eb9c47f34090c841a2e9a0b3f31b0e4ccf40a","modified":1559008943774},{"_id":"themes/nexT/layout/_third-party/analytics/analytics-with-widget.swig","hash":"66d562b3778dbc839f7c00103bd0099c5d61602a","modified":1559008943776},{"_id":"themes/nexT/layout/_third-party/analytics/application-insights.swig","hash":"83dd7df11b100bae38c9faab9a478f92149a0315","modified":1559008943776},{"_id":"themes/nexT/layout/_third-party/analytics/baidu-analytics.swig","hash":"73576c9683d9ad9b124916dc6c660607fe7cc1fa","modified":1559008943776},{"_id":"themes/nexT/layout/_third-party/analytics/busuanzi-counter.swig","hash":"b153837312c348aa0f5ce3f4d9f725a371d67d03","modified":1559008943777},{"_id":"themes/nexT/layout/_third-party/analytics/cnzz-analytics.swig","hash":"335005a9f8b36349f0ad0a7beeba6969c55fc7f7","modified":1559008943777},{"_id":"themes/nexT/layout/_third-party/analytics/facebook-sdk.swig","hash":"f648e5bf8c5dfc74143233976ed4ff5978deda43","modified":1559008943777},{"_id":"themes/nexT/layout/_third-party/analytics/firestore.swig","hash":"8ab040fccba41675bc835973515530af8a51f8bd","modified":1559008943778},{"_id":"themes/nexT/layout/_third-party/analytics/google-analytics.swig","hash":"d68da660cd1cc8fb3ff0a81178decadb620afc11","modified":1559008943778},{"_id":"themes/nexT/layout/_third-party/analytics/growingio.swig","hash":"623e73bedef067ac24a398ef27c8197295da872d","modified":1559008943778},{"_id":"themes/nexT/layout/_third-party/analytics/index.swig","hash":"39928f358dd13d9fc1a4641800e57be157ecd815","modified":1559008943779},{"_id":"themes/nexT/layout/_third-party/analytics/lean-analytics.swig","hash":"71fb01bcad43bc9410ab19190373b9f7e59215b5","modified":1559008943779},{"_id":"themes/nexT/layout/_third-party/analytics/tencent-analytics.swig","hash":"d18c87d7839e7407e39acd2998bcc9e0b34611b0","modified":1559008943779},{"_id":"themes/nexT/layout/_third-party/analytics/tencent-mta.swig","hash":"a22d1ea29a5ffe46199ab7d108a291a05af8d5b6","modified":1559008943780},{"_id":"themes/nexT/layout/_third-party/analytics/vkontakte-api.swig","hash":"4cff8bf5c42c62f7f0ac1f0d70f839dae39ba77a","modified":1559008943780},{"_id":"themes/nexT/layout/_third-party/comments/changyan.swig","hash":"bc3fc9d053b3d1fc0cd3918bf9a629a6f38f6414","modified":1559008943781},{"_id":"themes/nexT/layout/_third-party/comments/disqus.swig","hash":"d685df1516cb138d7a83bac5d7878a1e0fa8bc04","modified":1559008943782},{"_id":"themes/nexT/layout/_third-party/comments/disqusjs.swig","hash":"8b4a94dd80b3bac7c5390c8a7fd377b88c2cb78e","modified":1559008943782},{"_id":"themes/nexT/layout/_third-party/comments/gitalk.swig","hash":"4e86e1ace90a70bb8862f5e6de9dbe7bfc046bee","modified":1559008943782},{"_id":"themes/nexT/layout/_third-party/comments/gitment.swig","hash":"9a4923d2aa5182531ea7a7fb9abe824450026208","modified":1559008943783},{"_id":"themes/nexT/layout/_third-party/comments/index.swig","hash":"b3818fd0b3028dadf341b6d0b180e1243683de6a","modified":1559008943783},{"_id":"themes/nexT/layout/_third-party/comments/livere.swig","hash":"1a5d94f5779a2ce13abc886dd78e0617f89c34b9","modified":1559008943784},{"_id":"themes/nexT/layout/_third-party/comments/valine.swig","hash":"1b72c755101c9dfb85da13df9a0abccf37cd1dd2","modified":1559008943784},{"_id":"themes/nexT/layout/_third-party/math/index.swig","hash":"43a20fa0e9ae2f4254f04813f9c619dd36b49ae5","modified":1559008943785},{"_id":"themes/nexT/layout/_third-party/math/katex.swig","hash":"ea1c136f960667a0a13b334db497b9b19c41f629","modified":1559008943785},{"_id":"themes/nexT/layout/_third-party/math/mathjax.swig","hash":"767ba29f258db5d2e5baf875a6f36ac1d44df6a3","modified":1559008943786},{"_id":"themes/nexT/layout/_third-party/search/algolia-search.swig","hash":"143ef265c96a8ea2fb93c36c5ffb9c5e940f7693","modified":1559008943789},{"_id":"themes/nexT/layout/_third-party/search/index.swig","hash":"078bd2d5815eb23e8c5f74467dc0042babea00ae","modified":1559008943789},{"_id":"themes/nexT/layout/_third-party/search/localsearch.swig","hash":"d45ca53af17d1d83fd27f8ed0917a72f0060e1a9","modified":1559008943789},{"_id":"themes/nexT/source/css/_custom/custom.styl","hash":"77d385dda7c799ee0aaf41df3444961a0e8f0f61","modified":1558885317678},{"_id":"themes/nexT/source/css/_mixins/Gemini.styl","hash":"07f7da320689f828f6e36a6123807964a45157a0","modified":1559008943833},{"_id":"themes/nexT/source/css/_mixins/Pisces.styl","hash":"1aabac9e37a8f4451c86d09037b3a1f8b30eaf5e","modified":1559008943834},{"_id":"themes/nexT/source/css/_mixins/base.styl","hash":"21a14a19149f1cb8e011c477f29dd1352675605b","modified":1559008943834},{"_id":"themes/nexT/source/css/_variables/Gemini.styl","hash":"e9b0752f08398709e787546a246baca12b4c557f","modified":1559008943845},{"_id":"themes/nexT/source/css/_variables/Mist.styl","hash":"a25408534f8fe6e321db4bbf9dd03335d648fe17","modified":1559008943845},{"_id":"themes/nexT/source/css/_variables/Pisces.styl","hash":"da7049f3d9a157abe0ecc62611edcf43605ba84d","modified":1559008943846},{"_id":"themes/nexT/source/css/_variables/base.styl","hash":"ebc95eeb8966d17cdc7dd0de009deaef1fe65064","modified":1559008943847},{"_id":"themes/nexT/source/images/reward/alipay.png","hash":"f9f2493860e5e6c1fb93410e0a552d34f85a3a3b","modified":1558700193461},{"_id":"themes/nexT/source/js/schemes/muse.js","hash":"ccc0c5cd4ec6f8159c98990ad83f11a5c0b0234c","modified":1559008943862},{"_id":"themes/nexT/source/js/schemes/pisces.js","hash":"3eea56cc9ce47bb4760930c4c69cebf847a7fbb2","modified":1559008943862},{"_id":"themes/nexT/source/js/src/clicklove.js","hash":"9e8e79d69ad8338761272f86fe5cad0ad5e503cc","modified":1558723913897},{"_id":"themes/nexT/source/lib/bookmark/.eslintignore","hash":"bbd18f176a313f38aafbce58b55ad002563a689b","modified":1559008943865},{"_id":"themes/nexT/source/lib/bookmark/.eslintrc.js","hash":"21e561d7708a2c4884ba0d03f148ce46253b08ad","modified":1559008943865},{"_id":"themes/nexT/source/lib/bookmark/.gitignore","hash":"5410a1bef9807f666cd92a0d2020f700e67e4096","modified":1544895426000},{"_id":"themes/nexT/source/lib/bookmark/LICENSE","hash":"c3036598ab8f45797460e48880c9e859268d574a","modified":1559008943866},{"_id":"themes/nexT/source/lib/bookmark/README.md","hash":"aef0ed533378c45cadb548e4b26b375e2501fe07","modified":1559008943867},{"_id":"themes/nexT/source/lib/bookmark/bookmark.min.js","hash":"9e525329553335c2484f6faf9e933a6bbee9ab6d","modified":1544895426000},{"_id":"themes/nexT/source/lib/bookmark/index.js","hash":"1364ef511550daf991177d151a5fabc6539fced4","modified":1559008943867},{"_id":"themes/nexT/source/lib/bookmark/package.json","hash":"e3eedf4ba6fa086743553176f9526e1bf0b44439","modified":1559008943868},{"_id":"themes/nexT/source/lib/canvas-nest/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559008943869},{"_id":"themes/nexT/source/lib/canvas-nest/README.md","hash":"28bc2250a16e22c705cba7b3c17fcc15081e50f2","modified":1559008943869},{"_id":"themes/nexT/source/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1544895339000},{"_id":"themes/nexT/source/lib/canvas-nest/canvas-nest-nomobile.min.js","hash":"6b4437a9cd8aa04329cc6220a595acfe1fb9b598","modified":1559008943870},{"_id":"themes/nexT/source/lib/canvas-ribbon/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559008943871},{"_id":"themes/nexT/source/lib/canvas-ribbon/README.md","hash":"651b58ad95de624b02b7670f54f1c6aaeb5d7718","modified":1559008943872},{"_id":"themes/nexT/source/lib/canvas-ribbon/canvas-ribbon.js","hash":"b02737510e9b89aeed6b54f89f602a9c24b06ff2","modified":1559008943872},{"_id":"themes/nexT/source/lib/fancybox/.bower.json","hash":"9c0e38750e26eb9e83e2b5ab9e069b66f0965ce4","modified":1559008943872},{"_id":"themes/nexT/source/lib/fancybox/.gitattributes","hash":"672d3b5767e0eacd83bb41b188c913f2cf754793","modified":1559008943873},{"_id":"themes/nexT/source/lib/fancybox/LICENSE","hash":"7713a1753ce88f2c7e6b054ecc8e4c786df76300","modified":1559008943874},{"_id":"themes/nexT/source/lib/fancybox/README.md","hash":"10e4cb3bb98f6b9806bedbb8dbbc00151bad4c70","modified":1559008943874},{"_id":"themes/nexT/source/lib/fastclick/.bower.json","hash":"bf3eef9d647cd7c9b62feda3bc708c6cdd7c0877","modified":1559008943878},{"_id":"themes/nexT/source/lib/fastclick/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559008943879},{"_id":"themes/nexT/source/lib/fastclick/README.md","hash":"9f18b8b9a35b301805387f18cafd982404a3c1f9","modified":1559008943879},{"_id":"themes/nexT/source/lib/fastclick/bower.json","hash":"a9b3ee1e4db71a0e4ea6d5bed292d176dd68b261","modified":1559008943879},{"_id":"themes/nexT/source/lib/font-awesome/.bower.json","hash":"b4aefc910578d76b267e86dfffdd5121c8db9aec","modified":1559008943881},{"_id":"themes/nexT/source/lib/font-awesome/.gitignore","hash":"03ddbf76c1dd1afb93eed0b670d2eee747472ef1","modified":1559008943881},{"_id":"themes/nexT/source/lib/font-awesome/.npmignore","hash":"c31ff06a740955e44edd4403902e653ccabfd4db","modified":1559008943882},{"_id":"themes/nexT/source/lib/font-awesome/HELP-US-OUT.txt","hash":"ee33b2798b1e714b904d663436c6b3521011d1fa","modified":1559008943882},{"_id":"themes/nexT/source/lib/font-awesome/bower.json","hash":"71e7183634dc1b9449f590f15ebd7201add22ca7","modified":1559008943882},{"_id":"themes/nexT/source/lib/jquery_lazyload/.bower.json","hash":"90fa628f156d8045357ff11eaf32e61abacf10e8","modified":1559008943889},{"_id":"themes/nexT/source/lib/jquery_lazyload/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559008943890},{"_id":"themes/nexT/source/lib/jquery_lazyload/README.md","hash":"4d80ae239b597668665451a9515fba20543ac673","modified":1559008943891},{"_id":"themes/nexT/source/lib/jquery_lazyload/bower.json","hash":"e0acf1db27b0cc16128a59c46db1db406b5c4c58","modified":1559008943891},{"_id":"themes/nexT/source/lib/jquery_lazyload/jquery.lazyload.js","hash":"f4a570908f6c89c6edfb1c74959e733eaadea4f2","modified":1559008943891},{"_id":"themes/nexT/source/lib/jquery_lazyload/jquery.scrollstop.js","hash":"bf773ad48a0b9aa77681a89d7569eefc0f7b7b18","modified":1559008943892},{"_id":"themes/nexT/source/lib/pace/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559008943893},{"_id":"themes/nexT/source/lib/pace/README.md","hash":"ddcd2834d847f37b8ee77858bd03d31f70f55fb7","modified":1559008943893},{"_id":"themes/nexT/source/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1544895517000},{"_id":"themes/nexT/source/lib/pace/pace.min.js","hash":"8aaa675f577d5501f5f22d5ccb07c2b76310b690","modified":1559008943898},{"_id":"themes/nexT/source/lib/quicklink/LICENSE","hash":"78d636bebe5b99f30e0e0676ef71805ebf00c9b9","modified":1558450357000},{"_id":"themes/nexT/source/lib/quicklink/README.md","hash":"350a184f2d44ef0dd7e4dcece0b7cb1d16e15187","modified":1558450357000},{"_id":"themes/nexT/source/lib/quicklink/quicklink.umd.js","hash":"ddf1d9ed678876d9930501c43156ce0af5625d90","modified":1559008943900},{"_id":"themes/nexT/source/lib/three/.gitignore","hash":"5767276045f60da2350895a59aa6e138b0e83294","modified":1559008943901},{"_id":"themes/nexT/source/lib/three/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559008943901},{"_id":"themes/nexT/source/lib/three/README.md","hash":"6dd1906f6928a2d2dd5bfa12a28474e8cc650a77","modified":1559008943901},{"_id":"themes/nexT/source/lib/three/canvas_lines.min.js","hash":"97f0e67570574dc8597c5819970508d4e7f7af25","modified":1544895381000},{"_id":"themes/nexT/source/lib/three/canvas_sphere.min.js","hash":"333fed4c256c7081e07c7844c097b7970b45b248","modified":1544895381000},{"_id":"themes/nexT/source/lib/three/gulpfile.js","hash":"cca4caa79ab23db0e99ea35699212bb39b469db8","modified":1559008943903},{"_id":"themes/nexT/source/lib/three/package.json","hash":"74780a21c6e9e1e247f1fa18a0a4197e99d13fa8","modified":1559008943904},{"_id":"themes/nexT/source/lib/three/three-waves.min.js","hash":"704e860183acbaaf8de1be65fe5c958e8105f4bf","modified":1544895381000},{"_id":"themes/nexT/source/lib/three/yarn.lock","hash":"810564a91e67f570679915765fb1103b82a601a9","modified":1559008943910},{"_id":"themes/nexT/source/lib/velocity/velocity.min.js","hash":"bf172816a9c57f9040e3d19c24e181a142daf92b","modified":1559008943912},{"_id":"themes/nexT/source/lib/velocity/velocity.ui.js","hash":"dbbfb50f6502f6b81dcc9fee7b31f1e812da3464","modified":1559008943912},{"_id":"themes/nexT/source/lib/velocity/velocity.ui.min.js","hash":"dde584994ac13dc601836e86f4cf490e418d9723","modified":1559008943913},{"_id":"source/images/bar/32.jpg","hash":"7cc5909d3737cd4d18ee1e5cd82769562d7f3975","modified":1553358210408},{"_id":"source/images/pic/zabbix/zabbix-config002.png","hash":"6db85b3dcd969dda814cb9c425d66620cbc9e8ab","modified":1555078881655},{"_id":"source/images/pic/zabbix/zabbix-config004.png","hash":"af3c037130be5f1cf79ff233902b83663ed84510","modified":1555078908687},{"_id":"source/images/pic/zabbix/zabbix-config005.png","hash":"e7426e227e78b5a2c6a94141961182a6a1dc4367","modified":1555078921733},{"_id":"source/images/pic/zabbix/zabbix-config007.png","hash":"a52d19889300897c88ea1e3337b7889295141b16","modified":1555078951708},{"_id":"source/images/pic/zabbix/zabbix-config009.png","hash":"ff59364da3bc3d660cddc8c56b6957bb1db124a4","modified":1555079482401},{"_id":"source/images/pic/zabbix/zabbix-config010.png","hash":"dd3ac2756df294ff3937a9c593e7d86881da0983","modified":1555214654277},{"_id":"source/images/pic/zabbix/zabbix-config012.png","hash":"1a4c5cd1d0d91a86fcd6308ba9332ac60845181d","modified":1555215833643},{"_id":"source/images/pic/zabbix/zabbix-config013.png","hash":"9e75aa1cf2253ad3c7dba1a765c32c0430aa4a3e","modified":1555217056390},{"_id":"source/images/pic/zabbix/zabbix-config020.png","hash":"76d39b3ba31d9cbdbd812cf21dd23cc3b180c32b","modified":1555234372623},{"_id":"source/images/pic/zabbix/zabbix-config021.png","hash":"9ebfe24bd97c2340ad0c7fcd0268def4cc0f99cb","modified":1556289122672},{"_id":"source/images/pic/zabbix/zabbix-config022.png","hash":"1038dc19684fef2ee1cb133b367d574e76fc7500","modified":1556289122672},{"_id":"source/images/pic/zabbix/zabbix-config030.png","hash":"c4ee43e1aa74300afd7505e1e3c716e41fe3b82e","modified":1556289122682},{"_id":"source/images/pic/zabbix/zabbix-config032.png","hash":"39fe9b2146acfe83bf9681405e216b1aad87661c","modified":1556289122682},{"_id":"source/images/pic/zabbix/zabbix-config036.png","hash":"707abed4aec50af6fa363a3fef6960fc6691700a","modified":1556289122682},{"_id":"source/images/pic/zabbix/zabbix-config038.png","hash":"1c08f57c2e7193d14c570425561f0f6adeaa42fe","modified":1556289122682},{"_id":"source/images/pic/zabbix/zabbix-config039.png","hash":"dcede024c7640928482cee4cf84f5099fcab5198","modified":1556289122682},{"_id":"source/images/pic/zabbix/zabbix-config040.png","hash":"ed1df089699b1c00ea19b1f8e429c8fec092465b","modified":1556289122692},{"_id":"source/images/pic/zabbix/zabbix-config041.png","hash":"9061365de71b5d2daeb50193b420a5e16d078474","modified":1556289122692},{"_id":"themes/nexT/source/images/reward/wechatpay.png","hash":"56fe7d934e8506f4df54cd81bf6c3f93de0a8791","modified":1558700193464},{"_id":"themes/nexT/source/lib/jquery/index.js","hash":"17a740d68a1c330876c198b6a4d9319f379f3af2","modified":1559008943889},{"_id":"source/images/bar/13.jpg","hash":"3783e1e0f2b8c4ed71e6528c502a7e6810398b63","modified":1553357589561},{"_id":"source/images/bar/ansible.jpg","hash":"4c580ec5e227eab616e1418e54954ad6c0dbf7aa","modified":1553357948267},{"_id":"source/images/bar/docker.jpg","hash":"f85aef5813fd792fe4510704c980b06c60a01c1f","modified":1553358184025},{"_id":"source/images/bar/zabbix-04.jpg","hash":"218fe635bac0778c19e87a2f10e9260c37490db7","modified":1556289122662},{"_id":"source/images/pic/zabbix/zabbix-config001.png","hash":"62ccc84dce63e0a9704474ffcdcb61f215bca482","modified":1555078850399},{"_id":"source/images/pic/zabbix/zabbix-config003.png","hash":"5d9be33daa41e25627e0f05a3b83dedfe37de6ca","modified":1555078897176},{"_id":"source/images/pic/zabbix/zabbix-config008.png","hash":"635907314c737d46fbdaeb64842e2d5b91871a0f","modified":1555078964206},{"_id":"source/images/pic/zabbix/zabbix-config028.png","hash":"d365230f5e97be7e9cfc18429ca79f4df9a2b793","modified":1556289122672},{"_id":"themes/nexT/source/css/_common/components/back-to-top-sidebar.styl","hash":"5c0ca7f801859cff254d2f5b7d1a70d66ff61a8d","modified":1559008943801},{"_id":"themes/nexT/source/css/_common/components/back-to-top.styl","hash":"463817cbbd804ce134cb3e7e721431cb0e1616f2","modified":1559008943802},{"_id":"themes/nexT/source/css/_common/components/buttons.styl","hash":"9fd526db0527c71243f05e18086f937dc67b1c3e","modified":1559008943802},{"_id":"themes/nexT/source/css/_common/components/comments.styl","hash":"ff4489cd582f518bba6909a301ac1292a38b4e96","modified":1559008943802},{"_id":"themes/nexT/source/css/_common/components/components.styl","hash":"997058180065d986e05df72992cc2cbfd7febd7e","modified":1559008943803},{"_id":"themes/nexT/source/css/_common/components/pagination.styl","hash":"a4c6ee546a94fd69e5b7a1e4c054ab8cacb73d2a","modified":1559008943811},{"_id":"themes/nexT/source/css/_common/components/rainbow.styl","hash":"cfa64bd8ee2ff9f943673e339d69341e76fbf031","modified":1559008943817},{"_id":"themes/nexT/source/css/_common/components/scrollbar.styl","hash":"afdd21533db18d846e1a2663b1199761b1bd2c1e","modified":1559008943817},{"_id":"themes/nexT/source/css/_common/outline/outline.styl","hash":"1a4ac0d119f2126ef8951897338706edce112235","modified":1559008943829},{"_id":"themes/nexT/source/css/_common/scaffolding/base.styl","hash":"40144394fdfe05d400f39f6763f66f75479a2e34","modified":1559008943829},{"_id":"themes/nexT/source/css/_common/scaffolding/helpers.styl","hash":"35c6fd7eab3779bd9e38b7ba8825ab0c67a1be7a","modified":1559008943830},{"_id":"themes/nexT/source/css/_common/scaffolding/mobile.styl","hash":"9c6194177533619a6f6685dc7e890dcbec456241","modified":1559008943830},{"_id":"themes/nexT/source/css/_common/scaffolding/normalize.styl","hash":"fec36a14080104b5862e9f021eab117d87c5f7c5","modified":1559008943831},{"_id":"themes/nexT/source/css/_common/scaffolding/scaffolding.styl","hash":"a17e2b871a335f290afb392a08f94fd35f59c715","modified":1559008943831},{"_id":"themes/nexT/source/css/_common/scaffolding/tables.styl","hash":"107f42aa590ec4ba0765a0bc5d735f0f09edc0ff","modified":1559008943831},{"_id":"themes/nexT/source/css/_schemes/Gemini/index.styl","hash":"a609ff811f2b2764f5470236fe2fb1f3aa6ccba5","modified":1559008943835},{"_id":"themes/nexT/source/css/_schemes/Mist/_base.styl","hash":"d0e9065b0dbbc01811259f0597d1790268b4881b","modified":1559008943836},{"_id":"themes/nexT/source/css/_schemes/Mist/_header.styl","hash":"812913b28b77692dc129c640c8e906d74378c1e2","modified":1559008943837},{"_id":"themes/nexT/source/css/_schemes/Mist/_logo.styl","hash":"b1025c421406d2c24cc92a02ae28c1915b01e240","modified":1559008943837},{"_id":"themes/nexT/source/css/_schemes/Mist/_menu.styl","hash":"fed120b6e683bd5b11ec71ed935c89b134a2f23e","modified":1559008943837},{"_id":"themes/nexT/source/css/_schemes/Mist/_posts-expanded.styl","hash":"06d9d00257abd28414ec0b746f866bf9911cf5ec","modified":1559008943838},{"_id":"themes/nexT/source/css/_schemes/Mist/_search.styl","hash":"6aee54cd5a20181e18596565356bd54c66e33823","modified":1559008943838},{"_id":"themes/nexT/source/css/_schemes/Mist/index.styl","hash":"7972d3d0a4b335012844eddce042405d6c0c6cef","modified":1559008943839},{"_id":"themes/nexT/source/css/_schemes/Muse/_layout.styl","hash":"04706657af638f2746ae59520e6fc78577c7682c","modified":1559008943840},{"_id":"themes/nexT/source/css/_schemes/Muse/_logo.styl","hash":"157e6915dcf5990566e463acffa71043b2651c07","modified":1559008943841},{"_id":"themes/nexT/source/css/_schemes/Muse/_menu.styl","hash":"234b44cfd03f9c9e3e179ff5fd698ac876341913","modified":1559008943841},{"_id":"themes/nexT/source/css/_schemes/Muse/_search.styl","hash":"6aee54cd5a20181e18596565356bd54c66e33823","modified":1559008943841},{"_id":"themes/nexT/source/css/_schemes/Muse/index.styl","hash":"5dbc0d0c897e46760e5dbee416530d485c747bba","modified":1559008943842},{"_id":"themes/nexT/source/css/_schemes/Pisces/_brand.styl","hash":"b9619c9827f969ca2e2f5878552362a7b858918f","modified":1559008943843},{"_id":"themes/nexT/source/css/_schemes/Pisces/_layout.styl","hash":"e73d6da74c5755442e831d8fd7d922c5b32bd892","modified":1559008943843},{"_id":"themes/nexT/source/css/_schemes/Pisces/_menu.styl","hash":"0b3001909f3446843b226030524ea8498d4d8997","modified":1559008943843},{"_id":"themes/nexT/source/css/_schemes/Pisces/_sidebar.styl","hash":"5b5e0a02a7bf63de9efcd33a4e482939cce5822d","modified":1559008943844},{"_id":"themes/nexT/source/css/_schemes/Pisces/_sub-menu.styl","hash":"0d6f0df798449b710e1e5dbd43d470089b2a3c95","modified":1559008943844},{"_id":"themes/nexT/source/css/_schemes/Pisces/index.styl","hash":"adb7379f3b9001840eb38b260434e89365771a81","modified":1559008943845},{"_id":"themes/nexT/source/lib/bookmark/.github/stale.yml","hash":"dbd5e6bf89b76ad1f2b081578b239c7ae32755af","modified":1559008943866},{"_id":"themes/nexT/source/lib/canvas-nest/.github/stale.yml","hash":"dbd5e6bf89b76ad1f2b081578b239c7ae32755af","modified":1559008943869},{"_id":"themes/nexT/source/lib/canvas-ribbon/.github/stale.yml","hash":"dbd5e6bf89b76ad1f2b081578b239c7ae32755af","modified":1559008943871},{"_id":"themes/nexT/source/lib/fancybox/.github/stale.yml","hash":"dbd5e6bf89b76ad1f2b081578b239c7ae32755af","modified":1559008943873},{"_id":"themes/nexT/source/lib/fancybox/source/jquery.fancybox.css","hash":"b6964babd10efdeff086f91822b59c810a06d43d","modified":1559008943875},{"_id":"themes/nexT/source/lib/fancybox/source/jquery.fancybox.min.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1552839610000},{"_id":"themes/nexT/source/lib/fastclick/.github/stale.yml","hash":"dbd5e6bf89b76ad1f2b081578b239c7ae32755af","modified":1559008943879},{"_id":"themes/nexT/source/lib/fastclick/lib/fastclick.js","hash":"fda52d6fdfa88aa25b14a3c368174fb7795ab0f3","modified":1559008943880},{"_id":"themes/nexT/source/lib/fastclick/lib/fastclick.min.js","hash":"61a3106761dba3733c115ede9cb4639df482aafa","modified":1559008943880},{"_id":"themes/nexT/source/lib/font-awesome/css/font-awesome.css","hash":"3655f1fdf1e584c4d8e8d39026093ca306a5a341","modified":1559008943883},{"_id":"themes/nexT/source/lib/font-awesome/css/font-awesome.css.map","hash":"1573904b82807abbb32c97a3632c6c6808eaac50","modified":1559008943883},{"_id":"themes/nexT/source/lib/font-awesome/css/font-awesome.min.css","hash":"88af80502c44cd52ca81ffe7dc7276b7eccb06cf","modified":1559008943884},{"_id":"themes/nexT/source/lib/jquery_lazyload/.github/stale.yml","hash":"dbd5e6bf89b76ad1f2b081578b239c7ae32755af","modified":1559008943890},{"_id":"themes/nexT/source/lib/pace/.github/stale.yml","hash":"dbd5e6bf89b76ad1f2b081578b239c7ae32755af","modified":1559008943893},{"_id":"themes/nexT/source/lib/quicklink/.github/stale.yml","hash":"dbd5e6bf89b76ad1f2b081578b239c7ae32755af","modified":1559008943899},{"_id":"themes/nexT/source/lib/three/.github/stale.yml","hash":"dbd5e6bf89b76ad1f2b081578b239c7ae32755af","modified":1559008943901},{"_id":"themes/nexT/source/lib/three/lib/CanvasRenderer.js","hash":"71141daa39bbcedcf14ae95c05023a57828a5a43","modified":1559008943904},{"_id":"themes/nexT/source/lib/three/lib/Projector.js","hash":"69725cd0af6868c5aa059343cc6e18e0c10b2f2e","modified":1559008943904},{"_id":"themes/nexT/source/lib/three/src/canvas_lines.js","hash":"10795d7f1e5393b2b5e1529b017ee4e0ffe82ac9","modified":1559008943905},{"_id":"themes/nexT/source/lib/three/src/canvas_sphere.js","hash":"8381c792b161001a1b5cf39613c6d48e2588b3ce","modified":1559008943905},{"_id":"themes/nexT/source/lib/three/src/three-waves.js","hash":"ac382962d408f16acf07b925b94bb15495b5207c","modified":1559008943906},{"_id":"source/images/bar/15.jpg","hash":"dd4b6be4dfc443890ee7df15c365240d87c5648e","modified":1553357640597},{"_id":"source/images/bar/8.jpg","hash":"2e4712e4eea5ec877085644e44d09bfc135a3fd8","modified":1553357463054},{"_id":"source/images/bar/9.jpg","hash":"892218f0145fdb23bbb2c31ccd908d809980f9ce","modified":1553357475951},{"_id":"source/images/bar/kibana.jpg","hash":"2bb5bcc3893928637752148c20691e8722c4e291","modified":1558356940013},{"_id":"source/images/pic/zabbix/zabbix-config026.png","hash":"1bef3ee370134448e103c330c32f16777e08acc8","modified":1556289122672},{"_id":"themes/nexT/source/lib/fancybox/source/jquery.fancybox.min.js","hash":"eef46b6fb2e460838cd7328a6e13ecda0cb1e194","modified":1559008943876},{"_id":"themes/nexT/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1558634875000},{"_id":"source/images/pic/zabbix/zabbix-config006.png","hash":"bb7107ca2b900dc3dcfa4160ec55da7b5030dbf2","modified":1555078943067},{"_id":"themes/nexT/source/css/_common/components/footer/footer.styl","hash":"0b843c838f9f66e8374e808d869de9cd4833a34d","modified":1559008943804},{"_id":"themes/nexT/source/css/_common/components/header/github-banner.styl","hash":"a8f4d4b86acaa34c99111b2dde5d0779cc7e0de6","modified":1559008943804},{"_id":"themes/nexT/source/css/_common/components/header/header.styl","hash":"c9cfb4b99e1ec8ec9cf075cb761b8f7fa5fe63fd","modified":1559008943804},{"_id":"themes/nexT/source/css/_common/components/header/headerband.styl","hash":"d63e0cacc53dd375fcc113465a4328c59ff5f2c1","modified":1559008943805},{"_id":"themes/nexT/source/css/_common/components/header/menu.styl","hash":"33200f60bd6a8bbfc66dd49a239bcc75c2f564c1","modified":1559008943805},{"_id":"themes/nexT/source/css/_common/components/header/site-meta.styl","hash":"b8647d6140141b0a160607f6353e4d4594cca92e","modified":1559008943805},{"_id":"themes/nexT/source/css/_common/components/highlight/diff.styl","hash":"024e8ff40ca881c6fbf45712897e22f58a3811ab","modified":1559008943806},{"_id":"themes/nexT/source/css/_common/components/header/site-nav.styl","hash":"3a0efe849587b34f20d4e260028dc799215b0bb3","modified":1559008943806},{"_id":"themes/nexT/source/css/_common/components/highlight/highlight.styl","hash":"9c1a082e6c1f96187a099c3f4cb5424c0c9fd06e","modified":1559008943807},{"_id":"themes/nexT/source/css/_common/components/highlight/theme.styl","hash":"7fe4d4d656e86276c17cb4e48a560cb6a4def703","modified":1559008943807},{"_id":"themes/nexT/source/css/_common/components/pages/archive.styl","hash":"e5a5f8747fdf2ca960e4e73c081b8952afd62224","modified":1559008943808},{"_id":"themes/nexT/source/css/_common/components/pages/breadcrumb.styl","hash":"fa1cea6fcc3f552d57cc7d28380a304859139bf6","modified":1559008943808},{"_id":"themes/nexT/source/css/_common/components/pages/categories.styl","hash":"7fb593f90d74a99c21840679933b9ef6fdc16a61","modified":1559008943808},{"_id":"themes/nexT/source/css/_common/components/pages/pages.styl","hash":"9a8fb61bd2d184de9d206e62ba8961d1845c5669","modified":1559008943809},{"_id":"themes/nexT/source/css/_common/components/pages/post-detail.styl","hash":"4e3838d7ac81d9ad133960f0f7ed58a44a015285","modified":1559008943809},{"_id":"themes/nexT/source/css/_common/components/pages/schedule.styl","hash":"c27527cdeb9e3a9f447f7238f442a5dc33fde4e6","modified":1559008943809},{"_id":"themes/nexT/source/css/_common/components/pages/tag-cloud.styl","hash":"c97c819a65f6967485184399397601e5133deda6","modified":1559008943810},{"_id":"themes/nexT/source/css/_common/components/post/post-button.styl","hash":"62fbbd32cf5a99ae550c45c763a2c4813a138d01","modified":1559008943811},{"_id":"themes/nexT/source/css/_common/components/post/post-collapse.styl","hash":"f3b0d259e991ac86454ae5eac6bc94dc8691d8c9","modified":1559008943811},{"_id":"themes/nexT/source/css/_common/components/post/post-eof.styl","hash":"a73346f999b31355075cd58637946a8950cf6f7e","modified":1559008943812},{"_id":"themes/nexT/source/css/_common/components/post/post-copyright.styl","hash":"fc94dd09b4245143b452d6cf2fc4c12134d99d6d","modified":1559008943812},{"_id":"themes/nexT/source/css/_common/components/post/post-expand.styl","hash":"f14cefc99309934d4103a3aa785e1258d858813f","modified":1559008943813},{"_id":"themes/nexT/source/css/_common/components/post/post-gallery.styl","hash":"b6a241626783d2ac115d683fd59ec283af68e5bb","modified":1559008943813},{"_id":"themes/nexT/source/css/_common/components/post/post-meta.styl","hash":"d77f85d3af2d7090d84b28ab01c6a49f92eec647","modified":1559008943814},{"_id":"themes/nexT/source/css/_common/components/post/post-nav.styl","hash":"13d365ee626c01f17ec664b3f54f51d8b9ee7cf4","modified":1559008943814},{"_id":"themes/nexT/source/css/_common/components/post/post-reading_progress.styl","hash":"4aad8e36178faaa71a767af0084d578df4c09f73","modified":1559008943814},{"_id":"themes/nexT/source/css/_common/components/post/post-reward.styl","hash":"ccd0b1309acff0c676fdcc848a8ae2d05f0369ab","modified":1559008943814},{"_id":"themes/nexT/source/css/_common/components/post/post-rtl.styl","hash":"b2495ae5e04dcca610aacadc47881d9e716cd440","modified":1559008943815},{"_id":"themes/nexT/source/css/_common/components/post/post-tags.styl","hash":"5a982d8ef3b3623ea5f59e63728990f5623c1b57","modified":1559008943815},{"_id":"themes/nexT/source/css/_common/components/post/post-title.styl","hash":"539fc0880b2e035e8316d5d4b423703195c1b7ba","modified":1559008943816},{"_id":"themes/nexT/source/css/_common/components/post/post-type.styl","hash":"c8009fd9598a661b7d23158b5121b6ac266939e9","modified":1559008943816},{"_id":"themes/nexT/source/css/_common/components/post/post-widgets.styl","hash":"981795aad232c8bd3f52a0ed8720db696d18a234","modified":1559008943816},{"_id":"themes/nexT/source/css/_common/components/post/post.styl","hash":"615fca7dff197a2ca3df674cf963ce70b8525985","modified":1559008943817},{"_id":"themes/nexT/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"a5484d8436b2b7862faf6e7309a9e7b88cdd0027","modified":1559008943818},{"_id":"themes/nexT/source/css/_common/components/sidebar/sidebar-author.styl","hash":"ab1776c5dc537beabb0ab81a0f04e08bebad070b","modified":1559008943818},{"_id":"themes/nexT/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"03a4e75e963e3e7cc393d588b1495a88d52e0e40","modified":1559008943818},{"_id":"themes/nexT/source/css/_common/components/sidebar/sidebar-button.styl","hash":"b36eea093bd4b32056b5de6f370ff57e50b25a49","modified":1559008943819},{"_id":"themes/nexT/source/css/_common/components/sidebar/sidebar-dimmer.styl","hash":"e58bb8b7127aa21e8260493a425ec00fcb25d338","modified":1559008943819},{"_id":"themes/nexT/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"9204c79c05d620ecd5d411cdf11e27441b6281dc","modified":1559008943820},{"_id":"themes/nexT/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"7e2ba73073daaea0a18c3d67ff137dd683af7011","modified":1559008943820},{"_id":"themes/nexT/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"0eadef0381f696de7f88d7dc5f0ddc3cd5d309b3","modified":1559008943820},{"_id":"themes/nexT/source/css/_common/components/sidebar/sidebar.styl","hash":"780e1a51393810d8473009e83afd1414fcff7f14","modified":1559008943821},{"_id":"themes/nexT/source/css/_common/components/sidebar/site-state.styl","hash":"ed3a2960ebce7396d1893bb8e08c99c7d9259140","modified":1559008943821},{"_id":"themes/nexT/source/css/_common/components/tags/blockquote-center.styl","hash":"fde59300ec38868676ff5ed495b9dc9b02d07ffc","modified":1559008943822},{"_id":"themes/nexT/source/css/_common/components/tags/full-image.styl","hash":"2d58ad90f148e845bc7023751a7a13260600f8d6","modified":1559008943822},{"_id":"themes/nexT/source/css/_common/components/tags/group-pictures.styl","hash":"2ad1a2a9bbf6742d1b0762c4c623b68113d1e0fe","modified":1559008943822},{"_id":"themes/nexT/source/css/_common/components/tags/label.styl","hash":"b43421291bf85b589e8d0ec853e238d36ab80631","modified":1559008943823},{"_id":"themes/nexT/source/css/_common/components/tags/note.styl","hash":"020fac447d7a17c03e2802f0f724ae0738088354","modified":1559008943823},{"_id":"themes/nexT/source/css/_common/components/tags/pdf.styl","hash":"3baeeb51cfe123e99235ee1816d0e1f6a97c7852","modified":1559008943823},{"_id":"themes/nexT/source/css/_common/components/tags/tabs.styl","hash":"54c5398c7bf5b8bd9f38a9ece1dd82a9255f9a30","modified":1559008943824},{"_id":"themes/nexT/source/css/_common/components/tags/tags.styl","hash":"da7a21f5a2f7dcf4c5a4788d7670159ca4132b65","modified":1559008943824},{"_id":"themes/nexT/source/css/_common/components/third-party/algolia-search.styl","hash":"4305813408a1cd6aba764a7769b94b081d383d4f","modified":1559008943825},{"_id":"themes/nexT/source/css/_common/components/third-party/copy-code.styl","hash":"d9c244b1c3a09a7fccd3c3f732e6fb112a8cd565","modified":1559008943825},{"_id":"themes/nexT/source/css/_common/components/third-party/gitalk.styl","hash":"a01484e350ad5fc9b1fdfbfafb2ddd9687ad4d20","modified":1559008943825},{"_id":"themes/nexT/source/css/_common/components/third-party/gitment.styl","hash":"2fbe52f955da41c7a14eb09918bf86a252e4504f","modified":1559008943826},{"_id":"themes/nexT/source/css/_common/components/third-party/han.styl","hash":"2a1008f1044b450b806adc166754ba9513e68375","modified":1559008943826},{"_id":"themes/nexT/source/css/_common/components/third-party/localsearch.styl","hash":"ed8a12982c0497eeb9d7642781abeb801428f83d","modified":1559008943826},{"_id":"themes/nexT/source/css/_common/components/third-party/math.styl","hash":"6880467b4f6d7b057fb8291aa10966429a0a3bff","modified":1559008943827},{"_id":"themes/nexT/source/css/_common/components/third-party/needsharebutton.styl","hash":"35dc9f3990fadff3ea038d4e8ac75923219886ed","modified":1559008943827},{"_id":"themes/nexT/source/css/_common/components/third-party/related-posts.styl","hash":"9801977a23268e36c5deefd270423f6f1a0c3bb2","modified":1559008943828},{"_id":"themes/nexT/source/css/_common/components/third-party/third-party.styl","hash":"7cf42f96ba6b249c75e00dad251ebacf7de61e6c","modified":1559008943828},{"_id":"themes/nexT/source/css/_schemes/Mist/outline/outline.styl","hash":"a07aa12cc36ac5c819670c2a3c17d07ed7a08986","modified":1559008943839},{"_id":"themes/nexT/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"1f09be9bb38411f0629b58c3b23873589a6dbcaa","modified":1559008943840},{"_id":"themes/nexT/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"1f09be9bb38411f0629b58c3b23873589a6dbcaa","modified":1559008943842},{"_id":"themes/nexT/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"1151808c52451d1b39e74fb48283195adf40b9a1","modified":1559008943877},{"_id":"themes/nexT/source/lib/velocity/velocity.js","hash":"4237c6e9d59da349639de20e559e87c2c0218cfd","modified":1559008943911},{"_id":"source/images/bar/36.jpg","hash":"6eea937ab14cfdbc2d49f949a5c188793974581b","modified":1553358276147},{"_id":"source/images/bar/zabbix-06.jpg","hash":"cf8879168d8ac53c6b251c64a2e6eea1d845ca89","modified":1556289122672},{"_id":"themes/nexT/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1558634875000},{"_id":"source/images/bar/29.jpg","hash":"d12af2d79c59952f751901f2cec0807d538f268b","modified":1553358150763},{"_id":"themes/nexT/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1558634875000},{"_id":"themes/nexT/source/lib/three/three.min.js","hash":"26273b1cb4914850a89529b48091dc584f2c57b8","modified":1559008943909},{"_id":"public/atom.xml","hash":"2fa0ee5c83523d00b28943a550d4d096e65ca3e3","modified":1559013723844},{"_id":"public/search.xml","hash":"6bea9abf3669d4434f94cd3a20f685f846b04c8a","modified":1559013724009},{"_id":"public/about/index.html","hash":"fa35a2b96098acd75a0956dcb293d859dd2c9404","modified":1559013724059},{"_id":"public/categories/index.html","hash":"1549470adc0bcfb3d97be4e283aa1f01e3fa5a50","modified":1559013724059},{"_id":"public/guestbook/index.html","hash":"9b0706f5ad20a3cc2fccf62d841be48ec88176f9","modified":1559013724059},{"_id":"public/tags/index.html","hash":"58eea6013ed038d27a9b8d3c535cae3f1130e313","modified":1559013724060},{"_id":"public/2019/05/01/hexo-next.html","hash":"4784fa771495d0dcad76c8a84ca1ced296143832","modified":1559013724060},{"_id":"public/2019/03/21/install-docker-ce.html","hash":"b2eb6eb59f92c823dd63d5c137e20e25c65037b8","modified":1559013724060},{"_id":"public/2019/03/15/install-efk.html","hash":"f95e036a7d2bcb7319ad330c9e84a10e24901ca7","modified":1559013724060},{"_id":"public/2019/03/14/filebeat.html","hash":"5e1f8c4cc44819b156691af7a1edaf600fd6bf86","modified":1559013724060},{"_id":"public/2019/03/13/elastic-x-pack.html","hash":"e4f4c0192333c38ef850c59720da01a33f53854e","modified":1559013724060},{"_id":"public/2019/01/12/prometheus.html","hash":"604f4d7481077240ddd62f6baf31a686f80d67f1","modified":1559013724060},{"_id":"public/2018/12/14/tomcat-apr.html","hash":"ebf82e79b09e547839ead9e5f139231a858a76bc","modified":1559013724060},{"_id":"public/2018/11/30/git-command.html","hash":"e783a1b6c010cd81f75040acf838996b42d27c35","modified":1559013724060},{"_id":"public/2018/11/29/install-gitlab-ce.html","hash":"8d3d0f7bec251b9d206a1c24753a008e6744e68d","modified":1559013724060},{"_id":"public/2018/10/22/mysql-status.html","hash":"3118d5e44c96dda8f53ce819713791a04a309579","modified":1559013724060},{"_id":"public/2018/09/13/zabbox-alert.html","hash":"571d4b734d5bcb40e709f86067924845ab60916d","modified":1559013724060},{"_id":"public/2018/09/13/zabbix-trigger.html","hash":"ed0e7a6aa7d57750e9eae4baeb3ac780ae4ebe96","modified":1559013724060},{"_id":"public/2018/09/12/zabbix-item.html","hash":"6581740539961145bc15142be67b2ba459887db5","modified":1559013724060},{"_id":"public/2018/09/11/zabbix-agent.html","hash":"e67117985a0fcfdaf6dabef6a94ea2259a51b194","modified":1559013724060},{"_id":"public/2018/09/11/zabbix-server.html","hash":"854b938f7d0e37b922ab0c4f2b5c7c8613406cfb","modified":1559013724061},{"_id":"public/2018/09/11/zabbix-summarize.html","hash":"e2ab5af7adb5bca738936181fe1005ff9e0f484d","modified":1559013724061},{"_id":"public/2018/03/25/aliyun-ecs-mail.html","hash":"13bb96cc40d3a38e75a580f3665363c94519742d","modified":1559013724061},{"_id":"public/2018/03/23/ansible-playbook.html","hash":"108628ff18761dcabe545f92fb0404890ee4db87","modified":1559013724061},{"_id":"public/2018/03/22/ansible-module.html","hash":"7dfefe115d1032b7fde24a079e0d523ea52cb48b","modified":1559013724061},{"_id":"public/2018/01/23/nginx-variable.html","hash":"36c366a5981eb3746acd269dca12b55a000b77c0","modified":1559013724061},{"_id":"public/2018/01/23/Nginx-location.html","hash":"8d5ae441775c16d0c6c72adb2cfe770932be0b9c","modified":1559013724061},{"_id":"public/2017/12/26/http-header.html","hash":"fe60734e437b16d937055a183ab36167c6dba5f5","modified":1559013724061},{"_id":"public/2017/11/21/centos-kernel-analysis.html","hash":"b3d64de2dbf7c6d106f5ce3f492f35cf7c69c58b","modified":1559013724061},{"_id":"public/2017/11/16/systemctl-unit.html","hash":"f15b87320225c8d6837b34b157f1d9867aa7adea","modified":1559013724061},{"_id":"public/2017/10/26/https-tls.html","hash":"9a99825d53a9e092a4e2a5e16f2f10bde7c096e1","modified":1559013724061},{"_id":"public/2017/07/23/markdown-format.html","hash":"06bcdbf9eb4b1b80c0dc11454dd52ff3e2b07afa","modified":1559013724061},{"_id":"public/archives/index.html","hash":"30ed741040ec21c45ad1004ea03140a1e30cca05","modified":1559013724062},{"_id":"public/archives/page/2/index.html","hash":"821a3040a9dc27d48d52479add0e331291ebdda1","modified":1559013724062},{"_id":"public/archives/page/3/index.html","hash":"7eee21fc3238ad62e63a157e629fb6019fcc63d6","modified":1559013724062},{"_id":"public/archives/page/4/index.html","hash":"918076ad5307ad114c438e49684eb944ba3fff3b","modified":1559013724062},{"_id":"public/archives/2017/index.html","hash":"99a13ecf849f7c8ecd3d95765903f1df47bfab6f","modified":1559013724062},{"_id":"public/archives/2017/07/index.html","hash":"bb7708d065fb12f6104b73b76aea39937f854e18","modified":1559013724062},{"_id":"public/archives/2017/10/index.html","hash":"6c7ed309a43602c22a64c537ddda6db7220ae2d2","modified":1559013724062},{"_id":"public/archives/2017/11/index.html","hash":"2c311bac73aa22a58ff8bf032171edf5905039f5","modified":1559013724062},{"_id":"public/archives/2017/12/index.html","hash":"2594c21038abf923fa7db19eca8a40a928bb59a9","modified":1559013724062},{"_id":"public/archives/2018/index.html","hash":"70ffc3b70fee79bbe3e9bfd705e0195b045388bb","modified":1559013724062},{"_id":"public/archives/2018/page/2/index.html","hash":"75928e3b0f95456650d0ca5648197e58e8f7a5dd","modified":1559013724062},{"_id":"public/archives/2018/01/index.html","hash":"2ab10d6e729df8ed3e973c4f99cf2049623a577c","modified":1559013724063},{"_id":"public/archives/2018/03/index.html","hash":"b88cb0c166bfa17d7231a6db2b28ee30d7f78b3b","modified":1559013724063},{"_id":"public/archives/2018/09/index.html","hash":"f4cff11f0354366bddbad74828d78808ec130699","modified":1559013724063},{"_id":"public/archives/2018/10/index.html","hash":"3ad31390f62d6c7373074455c52ed3f4f1a3c50a","modified":1559013724063},{"_id":"public/archives/2018/11/index.html","hash":"7c014c0ba62da6ddc54cd0134e042fe9e8851f7c","modified":1559013724063},{"_id":"public/archives/2018/12/index.html","hash":"cbae31858426a7b3542506fced5f8443e148dda0","modified":1559013724063},{"_id":"public/archives/2019/index.html","hash":"6b28b754f54fe7d707718daee9b683f069e388fb","modified":1559013724063},{"_id":"public/archives/2019/01/index.html","hash":"abd0ff88dec2c594758273d1a956c91887f0535f","modified":1559013724063},{"_id":"public/archives/2019/03/index.html","hash":"5303503ef597a46ef9f6c72232a0443fc9c63b6c","modified":1559013724063},{"_id":"public/archives/2019/05/index.html","hash":"50ecd50877b974c026d104326f7084db02dfb8ef","modified":1559013724063},{"_id":"public/categories/Linux/index.html","hash":"b8a854fb7bf0d9f25692cdf86e73804dec80a9e5","modified":1559013724061},{"_id":"public/categories/hexo/index.html","hash":"16ba1c6380ac9ba002a18ad1299af808a0e77c79","modified":1559013724061},{"_id":"public/categories/web/index.html","hash":"2afed76ad295706c72f6b31fda53d8bca378c1bb","modified":1559013724061},{"_id":"public/categories/docker/index.html","hash":"8cd6197200e4966cdf800a6b53fc92c2945800a2","modified":1559013724062},{"_id":"public/categories/CI-CD/index.html","hash":"541c3cede064320d9cdb7f5d54b4c32a73660f50","modified":1559013724062},{"_id":"public/categories/Zabbix/index.html","hash":"f33f4e7c8a8b0778139a542a8d0ead88884db50a","modified":1559013724062},{"_id":"public/categories/elastic/index.html","hash":"ab8436526e70e2b1d9a17c133035330802b239f0","modified":1559013724062},{"_id":"public/categories/markdown/index.html","hash":"fe95125cb21a73cbee6286f857d3403a176f9274","modified":1559013724062},{"_id":"public/categories/prometheus/index.html","hash":"4ef3cdea1d5d93a1d13992037972cc4f6ba16c52","modified":1559013724062},{"_id":"public/categories/SQL/index.html","hash":"4dd7c7aa33f83520c22d80ab63bb9a84661c57a2","modified":1559013724062},{"_id":"public/index.html","hash":"c06c26549e46a84fa6e1cdf5b5ccfca50fd75729","modified":1559013724063},{"_id":"public/page/2/index.html","hash":"5030f992bfbb7d163a75228be250d8d135720e50","modified":1559013724063},{"_id":"public/page/3/index.html","hash":"a228c1e7038c7cf59d9eeece24564c9ecab6e29e","modified":1559013724063},{"_id":"public/tags/aliyun/index.html","hash":"6d74393af4ddc070a5e0eac419fc835b21075f3a","modified":1559013724063},{"_id":"public/tags/Linux/index.html","hash":"0396b5b5a7fc152459db6b23490680302668a141","modified":1559013724063},{"_id":"public/tags/hexo/index.html","hash":"0b4f9a144f114e3fef504085b5650bc2b957e192","modified":1559013724063},{"_id":"public/tags/https/index.html","hash":"8314bb6bb8d6a20853b2f29cbe1bc93e1ddb6e5a","modified":1559013724064},{"_id":"public/tags/docker/index.html","hash":"4ed5e98b29a300bd5df08511935dc6cbbec1df45","modified":1559013724064},{"_id":"public/tags/kubernetes/index.html","hash":"5d409cdc7af0c911560b0d250c46e904925847aa","modified":1559013724064},{"_id":"public/tags/git/index.html","hash":"032d7cde7aeb099c03af65298e3d25b029af897e","modified":1559013724064},{"_id":"public/tags/nginx/index.html","hash":"7ee19d8ee251559c53be6987f5abbade33a1836e","modified":1559013724064},{"_id":"public/tags/tomcat/index.html","hash":"eda18d5091100a7edb892e103d15f71b969a73ee","modified":1559013724064},{"_id":"public/tags/zabbix/index.html","hash":"c5cfc8c54973040aefd238ce3776b33cdcbcc6bc","modified":1559013724064},{"_id":"public/tags/ansible/index.html","hash":"17be28e7d94c3584918cd57bfcdb712d49410c89","modified":1559013724064},{"_id":"public/tags/x-pack/index.html","hash":"d6a697e07a0e17ccf0168e6086a0577776e301b4","modified":1559013724064},{"_id":"public/tags/elasticsearch/index.html","hash":"e9df9fb15efb995e67c27f4e2ba862c658dfd3a8","modified":1559013724064},{"_id":"public/tags/filebeat/index.html","hash":"fef3da91b0a348df109445d3eb82ac309a146ad6","modified":1559013724064},{"_id":"public/tags/kibana/index.html","hash":"acf25d45ab5ba9cfd0863c8a6c54e0d1219f8e9d","modified":1559013724064},{"_id":"public/tags/markdown/index.html","hash":"729c22780bcbfb0dbd5af446facf87346dab07b8","modified":1559013724064},{"_id":"public/tags/prometheus/index.html","hash":"58d211a20d2bf7890def0f9e8745d4098c9efa28","modified":1559013724064},{"_id":"public/tags/efk/index.html","hash":"4123f73d734a5ca004eb12ceed06b6349b70e2c7","modified":1559013724064},{"_id":"public/tags/mysql/index.html","hash":"b1369aae851b4dad976c2eee75f54d7d7a40aab1","modified":1559013724064},{"_id":"public/CNAME","hash":"d6be0e55d7c1b1604530cae2cac8d54888839928","modified":1559013724065},{"_id":"public/images/apple-touch-icon-next.png","hash":"531900f543a4db1ec5b4f0a3b20c9cc7c4120b53","modified":1559013724065},{"_id":"public/images/favicon-16x16-next.png","hash":"dad40a34bfcc79c3ea2a502d5b60ce25362b81cf","modified":1559013724065},{"_id":"public/images/favicon-32x32-next.png","hash":"7366345ff442a170ff75154bb955d5c1ce8036d0","modified":1559013724065},{"_id":"public/images/logo.svg","hash":"20f66224fee48857fb5e3b4587d0d8a8ebdc1055","modified":1559013724065},{"_id":"public/images/bar/3.jpg","hash":"772cc34d670a67394f048ab4c4904b301c16495b","modified":1559013724065},{"_id":"public/images/bar/1.jpg","hash":"20ec429cac584672bfe974b0d0b0e3aaace99ebd","modified":1559013724065},{"_id":"public/images/bar/42.jpg","hash":"ee0db87420c90e7d1094932e1f8de0984f99c8e5","modified":1559013724065},{"_id":"public/images/bar/beats.png","hash":"bd0640099ff2265f53f6d1e55bd6cb1391472fe2","modified":1559013724490},{"_id":"public/images/bar/elasticsearch.png","hash":"061080ac7426a51fffafa0644c2ba7fd94463f06","modified":1559013724065},{"_id":"public/images/bar/gitcommand.jpg","hash":"9f7b7add770eb1345dba2decc32d0ade18a2bc05","modified":1559013724065},{"_id":"public/images/bar/gitlab.jpg","hash":"898ade9853ed181d21a69691d1c6ea45253d8836","modified":1559013724065},{"_id":"public/images/bar/http.jpg","hash":"fed4298d8b6e3e8831bbf21920c5cb0d8940c83e","modified":1559013724065},{"_id":"public/images/bar/https.jpg","hash":"7ddbf7f36d30fa7fa4bfa0ce6a843a0c21c80db0","modified":1559013724065},{"_id":"public/images/bar/mysql.jpg","hash":"b030d0e716acf323525a7dc6302c48f6f8f01ddc","modified":1559013724065},{"_id":"public/images/bar/markdown.jpg","hash":"af6d43429432bb5c623f6655ac7fa1ba63843790","modified":1559013724065},{"_id":"public/images/bar/nginx-variable.jpg","hash":"eabcfee98a77ff767af9cb2549f3d6cf70728e27","modified":1559013724065},{"_id":"public/images/bar/playbook.jpg","hash":"4a277e3710912cf0b991fe39e2cc8e46e95912e2","modified":1559013724065},{"_id":"public/images/bar/xpack.png","hash":"43e50ff7f1d4f12dfba14a337a4cc3f66ef85ed7","modified":1559013724065},{"_id":"public/images/pic/cerebro.png","hash":"de84fe740d7f6e7867e2f042113c7f5abfdf144b","modified":1559013724066},{"_id":"public/images/pic/http-cache.png","hash":"89934dca7bb847ad864a0afd80cf1225153599d9","modified":1559013724066},{"_id":"public/images/pic/language.png","hash":"d9f788d97861dcf48df39e76db8def7943a0ddef","modified":1559013724066},{"_id":"public/images/pic/shouquanma.png","hash":"b55a167280fa1eeb5b3223a3de82c312fc891c2c","modified":1559013724066},{"_id":"public/images/pic/multiline.jpg","hash":"1481fd7e7bb688b4b29b49d6861551ebbe35f8eb","modified":1559013724066},{"_id":"public/images/pic/tomcat1.png","hash":"bc1afbfca7f790a47c760f2da4f5bfe3566c2dd8","modified":1559013724066},{"_id":"public/images/pic/welcome-gitlab.png","hash":"374ace5280513d9c8eb8a7efb6747901481659d7","modified":1559013724066},{"_id":"public/images/algolia_logo.svg","hash":"45eeea0b5fba833e21e38ea10ed5ab385ceb4f01","modified":1559013724066},{"_id":"public/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1559013724066},{"_id":"public/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1559013724066},{"_id":"public/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1559013724066},{"_id":"public/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1559013724489},{"_id":"public/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1559013724489},{"_id":"public/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1559013724489},{"_id":"public/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1559013724489},{"_id":"public/images/headbg.jpg","hash":"85e0b80411d54bf27bfffc1bbd40049ca1946dc3","modified":1559013724489},{"_id":"public/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1559013724490},{"_id":"public/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1559013724490},{"_id":"public/images/quote-l.svg","hash":"cd108d6f44351cadf8e6742565217f88818a0458","modified":1559013724490},{"_id":"public/images/searchicon.png","hash":"025d64ba0160a3a2257dd2b3032b5f7c9dd9b82b","modified":1559013724490},{"_id":"public/images/sidebar-bg1.jpg","hash":"56143c34ae82ae734b54f65af4d8d06fc3092029","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config011.png","hash":"de76ce596395099216bc06a67f4aeddb3dc4b331","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config015.png","hash":"083f64f50ff025c42ffbc23035956877a060bda4","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config018.png","hash":"c4105e8ed25eb72f2bd55951908fa2140e448a5a","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config019.png","hash":"fe78fdd516f75ddab3c389d83156636d18daef09","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config023.png","hash":"e21b3c7541012d6486a6e0334a1f86a45e53d4a3","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config024.png","hash":"ec65345b5c582dd892f9a692f6c33227b0f76f68","modified":1559013724534},{"_id":"public/images/pic/zabbix/zabbix-config025.png","hash":"57bb2c80b1271e2ee39d93350d54dd012e1787c1","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config033.png","hash":"13ab08f5f8517d77ccc71ee6e32cee4db9ff187c","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config035.png","hash":"cf386ce64e84646e3adcfc3b692f6dc7e6d88164","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config037.png","hash":"2d908db85daf40787c6bd9b9435f8e5f9af91744","modified":1559013724491},{"_id":"public/images/pic/zabbix/zabbix-config042.png","hash":"f14c98474a23fd1b71b2611b7b44c868ccdb1366","modified":1559013724491},{"_id":"public/images/pic/zabbix/zabbix-config043.png","hash":"87cd698636914f88a4e72aa4a693984f02e76bbc","modified":1559013724491},{"_id":"public/images/pic/zabbix/zabbix1.png","hash":"31931351749a8e815cd71a3be8db45b7aab7454c","modified":1559013724491},{"_id":"public/images/pic/zabbix/zabbix2.png","hash":"44027de4ad5aa697d68064231d77798502680791","modified":1559013724491},{"_id":"public/lib/bookmark/LICENSE","hash":"c3036598ab8f45797460e48880c9e859268d574a","modified":1559013724491},{"_id":"public/lib/canvas-nest/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559013724491},{"_id":"public/lib/canvas-ribbon/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559013724491},{"_id":"public/lib/fancybox/LICENSE","hash":"7713a1753ce88f2c7e6b054ecc8e4c786df76300","modified":1559013724491},{"_id":"public/lib/fastclick/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559013724491},{"_id":"public/lib/font-awesome/HELP-US-OUT.txt","hash":"ee33b2798b1e714b904d663436c6b3521011d1fa","modified":1559013724491},{"_id":"public/lib/jquery_lazyload/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559013724491},{"_id":"public/lib/pace/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559013724491},{"_id":"public/lib/quicklink/LICENSE","hash":"78d636bebe5b99f30e0e0676ef71805ebf00c9b9","modified":1559013724491},{"_id":"public/lib/three/LICENSE","hash":"336611e76f0638d3d8aeca6b1b97138d2a07523f","modified":1559013724491},{"_id":"public/lib/three/yarn.lock","hash":"810564a91e67f570679915765fb1103b82a601a9","modified":1559013724491},{"_id":"public/images/pic/zabbix/zabbix-config004.png","hash":"af3c037130be5f1cf79ff233902b83663ed84510","modified":1559013724491},{"_id":"public/images/pic/zabbix/zabbix-config005.png","hash":"e7426e227e78b5a2c6a94141961182a6a1dc4367","modified":1559013724491},{"_id":"public/images/pic/zabbix/zabbix-config007.png","hash":"a52d19889300897c88ea1e3337b7889295141b16","modified":1559013724491},{"_id":"public/images/pic/zabbix/zabbix-config009.png","hash":"ff59364da3bc3d660cddc8c56b6957bb1db124a4","modified":1559013724534},{"_id":"public/live2dw/assets/koharu.model.json","hash":"ceccdefd776b7c9475a29cff0842796e4f58b7e9","modified":1559013724492},{"_id":"public/live2dw/assets/koharu.physics.json","hash":"2fbf886979212357ba293bd35884f2cb5b26b6a6","modified":1559013724492},{"_id":"public/live2dw/assets/mtn/01.mtn","hash":"61d7d590d9feb71b32fd6bd142b59410d75bc1fa","modified":1559013724492},{"_id":"public/live2dw/assets/mtn/03.mtn","hash":"a72b697a92a7cff40d15774b143b465b34cee5e6","modified":1559013724492},{"_id":"public/live2dw/assets/mtn/02.mtn","hash":"efc99efdff39c93372cff0f6d62c4e748e1a5593","modified":1559013724492},{"_id":"public/live2dw/assets/mtn/04.mtn","hash":"32c888667455a3ff6f1b04f910c1a5cc4de30af0","modified":1559013724492},{"_id":"public/live2dw/assets/mtn/05.mtn","hash":"637e00442da4042cd4b0ed2cc62ffb1559881814","modified":1559013724492},{"_id":"public/live2dw/assets/mtn/06.mtn","hash":"df10cc1d333c96da1296a4853c1ddbd44d8a11f3","modified":1559013724492},{"_id":"public/live2dw/assets/mtn/08.mtn","hash":"9b95ef8548b979d1fca557c74f8d66fb15b34578","modified":1559013724492},{"_id":"public/live2dw/assets/mtn/07.mtn","hash":"d8c9410135c81604eba665b59808089808e0851a","modified":1559013724492},{"_id":"public/live2dw/assets/mtn/09.mtn","hash":"ecf1283b72e1c4b7e3a97343cd97726813f18790","modified":1559013724492},{"_id":"public/live2dw/assets/mtn/idle.mtn","hash":"058d4628ab04bf42c279501ba4fa37116d384e41","modified":1559013724492},{"_id":"public/live2dw/lib/L2Dwidget.min.js","hash":"5f1a807437cc723bcadc3791d37add5ceed566a2","modified":1559013724492},{"_id":"public/assets/css/APlayer.min.css","hash":"07372a2ba507388d0fed166d761b1c2c2a659dce","modified":1559013724492},{"_id":"public/assets/js/APlayer.min.js","hash":"22caa28ff6b41a16ff40f15d38f1739e22359478","modified":1559013724492},{"_id":"public/assets/js/Meting.min.js","hash":"a0585220b918d78649a7893279e1ec4fb5abe835","modified":1559013724492},{"_id":"public/images/bar/6.jpg","hash":"cd420156233418ffa06a7cc2c42d6b42d1efc00d","modified":1559013724490},{"_id":"public/images/pic/x-pack.png","hash":"16055d46f86bd08179e6791ce1485431f7ca91b3","modified":1559013724066},{"_id":"public/images/quote-r.svg","hash":"2a2a250b32a87c69dcc1b1976c74b747bedbfb41","modified":1559013724490},{"_id":"public/images/bar/0.jpg","hash":"5122112eba55651d9fb982160eaf51cc3f237cdc","modified":1559013724531},{"_id":"public/images/bar/11.jpg","hash":"dc845f25ead88606c0ef40a9ba2689e3c809ddc7","modified":1559013724548},{"_id":"public/images/bar/39.jpg","hash":"089eba8393ab7d5a8105adf6f2d46caaed24222f","modified":1559013724533},{"_id":"public/images/bar/44.jpg","hash":"5cf223855fd05b961a22ee935e526de0bc0e26a4","modified":1559013724533},{"_id":"public/images/bar/5.jpg","hash":"e322fcb931209a0c12f1df69d31da85e744d9681","modified":1559013724548},{"_id":"public/images/bar/systemctl.jpg","hash":"ed8449415e055c2f35ef10780910feacfdbbd681","modified":1559013724533},{"_id":"public/images/bar/prometheus.jpg","hash":"ddcf444dd08e8367926cc81910e51c63e5577f56","modified":1559013724533},{"_id":"public/images/bar/zabbix-03.jpg","hash":"c84d358df2fac3db521fe5c0dcdecca895d82c9f","modified":1559013724533},{"_id":"public/images/pic/tls.jpg","hash":"cbd3afe29b9a9d5286e107ee5249f9fdd264a840","modified":1559013724534},{"_id":"public/images/bar/aliyun.jpg","hash":"241c9ff2b8acf2189495a07fc6dfa0ef669b98ca","modified":1559013724534},{"_id":"public/images/bar/elastic-k8s.png","hash":"4d5701d96467b1e6c18948ecd0f5a8103b627dc4","modified":1559013724534},{"_id":"public/images/pic/zabbix/zabbix-config014.png","hash":"1ccbd6cf303773b58c7cb5c36b6c6b09474e13b4","modified":1559013724534},{"_id":"public/images/pic/zabbix/zabbix-config016.png","hash":"62d8d831e8ad84bc654043574361a2f7b5a704f4","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config017.png","hash":"0080e9750b7b8ee2a4836123beee214f2b60fa11","modified":1559013724534},{"_id":"public/images/pic/zabbix/zabbix-config027.png","hash":"7faf357c870db01723441169800fd6e72c9f812a","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config029.png","hash":"2eb8aaec04a722d8c2b86f42b5524c6caf41c30c","modified":1559013724490},{"_id":"public/images/pic/zabbix/zabbix-config031.png","hash":"fc7798b4b2e3217b2fbceb4083fe5ccbdd764435","modified":1559013724534},{"_id":"public/images/pic/zabbix/zabbix-config034.png","hash":"6ad1e1cdb9fb561abe9bb6791b0c654ad813178a","modified":1559013724490},{"_id":"public/images/reward/alipay.png","hash":"f9f2493860e5e6c1fb93410e0a552d34f85a3a3b","modified":1559013724534},{"_id":"public/images/pic/zabbix/zabbix-config002.png","hash":"6db85b3dcd969dda814cb9c425d66620cbc9e8ab","modified":1559013724534},{"_id":"public/images/pic/zabbix/zabbix-config010.png","hash":"dd3ac2756df294ff3937a9c593e7d86881da0983","modified":1559013724491},{"_id":"public/images/pic/zabbix/zabbix-config012.png","hash":"1a4c5cd1d0d91a86fcd6308ba9332ac60845181d","modified":1559013724492},{"_id":"public/images/pic/zabbix/zabbix-config020.png","hash":"76d39b3ba31d9cbdbd812cf21dd23cc3b180c32b","modified":1559013724534},{"_id":"public/images/pic/zabbix/zabbix-config021.png","hash":"9ebfe24bd97c2340ad0c7fcd0268def4cc0f99cb","modified":1559013724534},{"_id":"public/images/pic/zabbix/zabbix-config022.png","hash":"1038dc19684fef2ee1cb133b367d574e76fc7500","modified":1559013724549},{"_id":"public/images/pic/zabbix/zabbix-config030.png","hash":"c4ee43e1aa74300afd7505e1e3c716e41fe3b82e","modified":1559013724556},{"_id":"public/images/pic/zabbix/zabbix-config032.png","hash":"39fe9b2146acfe83bf9681405e216b1aad87661c","modified":1559013724556},{"_id":"public/images/pic/zabbix/zabbix-config036.png","hash":"707abed4aec50af6fa363a3fef6960fc6691700a","modified":1559013724571},{"_id":"public/images/pic/zabbix/zabbix-config038.png","hash":"1c08f57c2e7193d14c570425561f0f6adeaa42fe","modified":1559013724556},{"_id":"public/images/pic/zabbix/zabbix-config040.png","hash":"ed1df089699b1c00ea19b1f8e429c8fec092465b","modified":1559013724549},{"_id":"public/images/pic/zabbix/zabbix-config039.png","hash":"dcede024c7640928482cee4cf84f5099fcab5198","modified":1559013724535},{"_id":"public/images/pic/zabbix/zabbix-config041.png","hash":"9061365de71b5d2daeb50193b420a5e16d078474","modified":1559013724549},{"_id":"public/images/reward/wechatpay.png","hash":"56fe7d934e8506f4df54cd81bf6c3f93de0a8791","modified":1559013724549},{"_id":"public/images/pic/zabbix/zabbix-config001.png","hash":"62ccc84dce63e0a9704474ffcdcb61f215bca482","modified":1559013724535},{"_id":"public/lib/font-awesome/css/font-awesome.css.map","hash":"1573904b82807abbb32c97a3632c6c6808eaac50","modified":1559013724492},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1559013724535},{"_id":"public/images/pic/zabbix/zabbix-config006.png","hash":"bb7107ca2b900dc3dcfa4160ec55da7b5030dbf2","modified":1559013724492},{"_id":"public/live2dw/lib/L2Dwidget.min.js.map","hash":"3290fe2df45f065b51a1cd7b24ec325cbf9bb5ce","modified":1559013724535},{"_id":"public/js/affix.js","hash":"a2aab233d99297435a5274bf512c3c753fe08e80","modified":1559013724546},{"_id":"public/js/algolia-search.js","hash":"1f7f10c579e7703d0f6acb8b73f3d78a07d0c623","modified":1559013724546},{"_id":"public/js/exturl.js","hash":"54825acc8de4793feac415be227b965428f4e97d","modified":1559013724546},{"_id":"public/js/js.cookie.js","hash":"e0afce539f1fb81d59e3c6f0a68d736e2fb45d93","modified":1559013724546},{"_id":"public/js/next-boot.js","hash":"e0615efab5f81ba0fd39c0527eac31144deac7ce","modified":1559013724545},{"_id":"public/js/post-details.js","hash":"0dde5e6d4547587662a3256317a9d5d1db507692","modified":1559013724546},{"_id":"public/js/scroll-cookie.js","hash":"d07b3776708d4ae79ed2037c4c7391d5c9b06b19","modified":1559013724546},{"_id":"public/js/scrollspy.js","hash":"fa3c92968bcdbcb8d95a1729f7659d9753cbd077","modified":1559013724546},{"_id":"public/js/src/clicklove.js","hash":"9e8e79d69ad8338761272f86fe5cad0ad5e503cc","modified":1559013724546},{"_id":"public/js/schemes/muse.js","hash":"e9bfa6b343b67625f58757efce46ccdaac8f308c","modified":1559013724546},{"_id":"public/js/schemes/pisces.js","hash":"9eb63cba0327d3d11b6cbfcbe40b88e97a8378a3","modified":1559013724546},{"_id":"public/lib/bookmark/index.js","hash":"5e5cba645a1a4531ccbb4782df2f7a075626393f","modified":1559013724546},{"_id":"public/lib/bookmark/bookmark.min.js","hash":"9e525329553335c2484f6faf9e933a6bbee9ab6d","modified":1559013724546},{"_id":"public/lib/bookmark/package.json","hash":"9f06f3432c12b68a2c2fe3f318455b35a965a1da","modified":1559013724546},{"_id":"public/lib/canvas-nest/canvas-nest-nomobile.min.js","hash":"956eada198babd00f028e8908767cb158926c3f3","modified":1559013724546},{"_id":"public/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1559013724546},{"_id":"public/lib/canvas-ribbon/canvas-ribbon.js","hash":"ff5915eb2596e890a2fc6697c864f861a1995ec0","modified":1559013724546},{"_id":"public/lib/fastclick/bower.json","hash":"4dcecf83afddba148464d5339c93f6d0aa9f42e9","modified":1559013724546},{"_id":"public/lib/font-awesome/bower.json","hash":"64394a2a9aa00f8e321d8daa5e51a420f0e96dad","modified":1559013724546},{"_id":"public/lib/jquery_lazyload/bower.json","hash":"ae3c3b61e6e7f9e1d7e3585ad854380ecc04cf53","modified":1559013724546},{"_id":"public/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1559013724546},{"_id":"public/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1559013724546},{"_id":"public/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1559013724547},{"_id":"public/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1559013724546},{"_id":"public/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1559013724546},{"_id":"public/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1559013724547},{"_id":"public/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1559013724547},{"_id":"public/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1559013724547},{"_id":"public/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1559013724547},{"_id":"public/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1559013724547},{"_id":"public/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1559013724547},{"_id":"public/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1559013724547},{"_id":"public/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1559013724547},{"_id":"public/lib/quicklink/quicklink.umd.js","hash":"d18dc2633f75d7f3801649f4c4af4b11a291750c","modified":1559013724547},{"_id":"public/lib/three/gulpfile.js","hash":"edd1868be72fde796b0b1f3a7a0316b3c896962a","modified":1559013724547},{"_id":"public/lib/three/package.json","hash":"d64e9f4ce441b50e48aa0993e190481223665989","modified":1559013724547},{"_id":"public/lib/fastclick/lib/fastclick.min.js","hash":"4496faa08c7d2979747f15c7b79cdf79e5a91cc1","modified":1559013724547},{"_id":"public/lib/three/src/canvas_lines.js","hash":"650310ff6783671f8ceccf01f840b20d9c87b491","modified":1559013724547},{"_id":"public/lib/three/src/canvas_sphere.js","hash":"7614790c67d3e79e3390fe688f6b01afad7e3bb1","modified":1559013724547},{"_id":"public/lib/three/src/three-waves.js","hash":"e98e442f14920e9fb8691846dca3a2225d403048","modified":1559013724547},{"_id":"public/lib/bookmark/README.html","hash":"be0c3f6a13505fb32611ef5e7269a7e4f35eecc9","modified":1559013724547},{"_id":"public/lib/canvas-nest/README.html","hash":"dac952f5cf0e6eedfb8d33bab710356798bb0ca5","modified":1559013724547},{"_id":"public/lib/canvas-ribbon/README.html","hash":"712f095b72b24b2bafa3548404bb4062c7859304","modified":1559013724547},{"_id":"public/lib/fancybox/README.html","hash":"acfa25ca9b6457a4a70a4b35cf72c9dafc33584e","modified":1559013724547},{"_id":"public/lib/fastclick/README.html","hash":"337b62c056c5c5566d3cfe717551a4d9f9e99e3b","modified":1559013724547},{"_id":"public/lib/jquery_lazyload/README.html","hash":"44753ed8ad8422df87d297ed331ac27dfc7a00dc","modified":1559013724548},{"_id":"public/lib/pace/README.html","hash":"58f2105ada5cc52dff5aabcecb92569ee84493a0","modified":1559013724548},{"_id":"public/lib/quicklink/README.html","hash":"5b7c0cedd5f19177d3eb6795be53da1dc69e0c2c","modified":1559013724548},{"_id":"public/lib/three/README.html","hash":"b9ead5e5ec2847bc3ae33c34e5d1a2c39dd747e9","modified":1559013724548},{"_id":"public/css/main.css","hash":"c153eaa01a6c1a782170ed49313a9085b380441a","modified":1559013724525},{"_id":"public/images/avatar.jpg","hash":"d415ffaf3157a079d8c5fc35c1ac56736256da0c","modified":1559013724490},{"_id":"public/images/bar/12.jpg","hash":"01c14cb0dafa89755fa6d56366bd187e4f733378","modified":1559013724548},{"_id":"public/images/bar/25.jpg","hash":"15c21e56be49e0e8677509a661fd9855d628d350","modified":1559013724548},{"_id":"public/images/bar/37.jpg","hash":"a6e8ebafb7f339113e6b0479ef99bd6f49ea1c00","modified":1559013724548},{"_id":"public/images/bar/nginx.jpg","hash":"3da99c0d508f72585eb9564673f74ccdfce4d9db","modified":1559013724548},{"_id":"public/images/bar/zabbix-02.jpg","hash":"26fe72d7119977c01ff493602147debe7fe83a62","modified":1559013724548},{"_id":"public/images/bar/16.jpg","hash":"ac4e5f55833628ce19258c1d9b0462f7c34c7036","modified":1559013724548},{"_id":"public/images/bar/18.jpg","hash":"c9e42307f8462b54a77d615db0568cbbe1cb0a56","modified":1559013724548},{"_id":"public/images/bar/20.jpg","hash":"97bc5b8e9807287f0b249e020948ab0f39c8059e","modified":1559013724555},{"_id":"public/images/bar/7.jpg","hash":"d1aa303837c9eb2e01eeddb900d9d9f529b993eb","modified":1559013724534},{"_id":"public/images/bar/13.jpg","hash":"3783e1e0f2b8c4ed71e6528c502a7e6810398b63","modified":1559013724564},{"_id":"public/images/pic/zabbix/zabbix-config003.png","hash":"5d9be33daa41e25627e0f05a3b83dedfe37de6ca","modified":1559013724571},{"_id":"public/images/pic/zabbix/zabbix-config008.png","hash":"635907314c737d46fbdaeb64842e2d5b91871a0f","modified":1559013724549},{"_id":"public/images/pic/zabbix/zabbix-config028.png","hash":"d365230f5e97be7e9cfc18429ca79f4df9a2b793","modified":1559013724556},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1559013724535},{"_id":"public/live2dw/lib/L2Dwidget.0.min.js","hash":"35bb5b588b6de25c9be2dd51d3fd331feafac02d","modified":1559013724549},{"_id":"public/js/motion.js","hash":"a16bc0b701646bf6653484675f4d5dc0f892d184","modified":1559013724555},{"_id":"public/js/utils.js","hash":"81913c5f75d0949443833cf4269ad63bd7f9be6f","modified":1559013724555},{"_id":"public/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1559013724555},{"_id":"public/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1559013724555},{"_id":"public/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1559013724555},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1559013724555},{"_id":"public/lib/fancybox/source/jquery.fancybox.min.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1559013724555},{"_id":"public/images/bar/zabbix-05.jpg","hash":"62e6dda8baec3890359d5b860291d46407bd2b96","modified":1559013724534},{"_id":"public/images/bar/14.jpg","hash":"aadba743ee97c06555ae486182c6d796cb23273c","modified":1559013724564},{"_id":"public/images/bar/35.jpg","hash":"16bc623ca7e1c1257f99912a19e6091e635be8b6","modified":1559013724548},{"_id":"public/images/bar/zabbix-01.jpg","hash":"6915f40cc0f203e40d7fcb771b8f0793a2345ae0","modified":1559013724556},{"_id":"public/images/bar/32.jpg","hash":"7cc5909d3737cd4d18ee1e5cd82769562d7f3975","modified":1559013724737},{"_id":"public/images/bar/docker.jpg","hash":"f85aef5813fd792fe4510704c980b06c60a01c1f","modified":1559013724564},{"_id":"public/images/pic/zabbix/zabbix-config026.png","hash":"1bef3ee370134448e103c330c32f16777e08acc8","modified":1559013724556},{"_id":"public/lib/three/canvas_lines.min.js","hash":"97f0e67570574dc8597c5819970508d4e7f7af25","modified":1559013724563},{"_id":"public/lib/three/canvas_sphere.min.js","hash":"333fed4c256c7081e07c7844c097b7970b45b248","modified":1559013724563},{"_id":"public/lib/three/three-waves.min.js","hash":"704e860183acbaaf8de1be65fe5c958e8105f4bf","modified":1559013724564},{"_id":"public/lib/fancybox/source/jquery.fancybox.css","hash":"e43435fb9eaa918f5b8e35c9e110124b8bd13751","modified":1559013724564},{"_id":"public/lib/three/lib/Projector.js","hash":"1ad16e96cea2a8a9155bb429c83ef9bdd341ce99","modified":1559013724564},{"_id":"public/images/bar/23.jpg","hash":"f15f3cd7a874ce47b452af9db42dd3c8973a915e","modified":1559013724548},{"_id":"public/images/bar/28.jpg","hash":"cd9348ac01bd5305c845af9675a37fc25a49391a","modified":1559013724555},{"_id":"public/images/bar/kernel.jpg","hash":"88cfc5e0ca681d1003e47cf36c7b11c033b892ea","modified":1559013724549},{"_id":"public/images/bar/tomcat.jpg","hash":"b350075c1f0fd0b1ad644b6536cb0934911f7fc6","modified":1559013724549},{"_id":"public/images/pic/zabbix/zabbix-config013.png","hash":"9e75aa1cf2253ad3c7dba1a765c32c0430aa4a3e","modified":1559013724556},{"_id":"public/images/bar/zabbix-04.jpg","hash":"218fe635bac0778c19e87a2f10e9260c37490db7","modified":1559013724766},{"_id":"public/images/bar/15.jpg","hash":"dd4b6be4dfc443890ee7df15c365240d87c5648e","modified":1559013724766},{"_id":"public/live2dw/assets/moc/koharu.moc","hash":"5eec3fba21444dd6f774b913510b5955e2c0605b","modified":1559013724572},{"_id":"public/lib/fastclick/lib/fastclick.js","hash":"9782a228f911ef442a03390a0064b40102fc1682","modified":1559013724567},{"_id":"public/lib/three/lib/CanvasRenderer.js","hash":"cf8e1ce6e884023ad0d692cf30f399862407fb40","modified":1559013724567},{"_id":"public/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1559013724567},{"_id":"public/images/bar/8.jpg","hash":"2e4712e4eea5ec877085644e44d09bfc135a3fd8","modified":1559013724737},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1559013724557},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1559013724584},{"_id":"public/lib/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1559013724584},{"_id":"public/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1559013724584},{"_id":"public/images/bar/ansible.jpg","hash":"4c580ec5e227eab616e1418e54954ad6c0dbf7aa","modified":1559013724737},{"_id":"public/live2dw/assets/moc/koharu.2048/texture_00.png","hash":"0879b61b745084781722636bba9f278f31ce5fc1","modified":1559013724564},{"_id":"public/images/bar/zabbix-06.jpg","hash":"cf8879168d8ac53c6b251c64a2e6eea1d845ca89","modified":1559013724593},{"_id":"public/images/bar/9.jpg","hash":"892218f0145fdb23bbb2c31ccd908d809980f9ce","modified":1559013724737},{"_id":"public/lib/fancybox/source/jquery.fancybox.min.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1559013724821},{"_id":"public/images/bar/kibana.jpg","hash":"2bb5bcc3893928637752148c20691e8722c4e291","modified":1559013724686},{"_id":"public/images/bar/36.jpg","hash":"6eea937ab14cfdbc2d49f949a5c188793974581b","modified":1559013724838},{"_id":"public/images/bar/29.jpg","hash":"d12af2d79c59952f751901f2cec0807d538f268b","modified":1559013724737},{"_id":"public/live2dw/lib/L2Dwidget.0.min.js.map","hash":"35e71cc2a130199efb167b9a06939576602f0d75","modified":1559013724848},{"_id":"public/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1559013724848},{"_id":"public/lib/fancybox/source/jquery.fancybox.pack.js","hash":"27f034e5db8c32e268e2959b9a7c1258d36e4510","modified":1559013724860},{"_id":"public/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1559013724862},{"_id":"public/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1559013724866}],"Category":[{"name":"Linux","_id":"cjw6jleyc0004p4n73b3ire6w"},{"name":"hexo","_id":"cjw6jleyq000gp4n73z1rp93k"},{"name":"web","_id":"cjw6jleyu000np4n72e96y9pf"},{"name":"docker","_id":"cjw6jleyy000up4n7a1l4gum4"},{"name":"CI/CD","_id":"cjw6jlez20011p4n7evn1dq8l"},{"name":"Zabbix","_id":"cjw6jlez7001ep4n7saz58jkg"},{"name":"elastic","_id":"cjw6jlf0n002ep4n7u2z2i4fl"},{"name":"markdown","_id":"cjw6jlf0u002qp4n7r13m2w8g"},{"name":"prometheus","_id":"cjw6jlf0v002up4n7p5twjbg0"},{"name":"SQL","_id":"cjw6jlf23003bp4n7ti3zh1b5"}],"Data":[],"Page":[{"title":"About me","date":"2019-03-21T12:38:49.000Z","type":"about","comments":0,"_content":"2323\n{% echarts 400 '85%' %}\n{\n    tooltip : {\n        trigger: 'axis',\n        axisPointer : {            // 坐标轴指示器，坐标轴触发有效\n            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'\n        }\n    },\n    legend: {\n        data:['利润', '支出', '收入']\n    },\n    grid: {\n        left: '3%',\n        right: '4%',\n        bottom: '3%',\n        containLabel: true\n    },\n    xAxis : [\n        {\n            type : 'value'\n        }\n    ],\n    yAxis : [\n        {\n            type : 'category',\n            axisTick : {show: false},\n            data : ['周一','周二','周三','周四','周五','周六','周日']\n        }\n    ],\n    series : [\n        {\n            name:'利润',\n            type:'bar',\n            itemStyle : {\n                normal: {\n                    label: {show: true, position: 'inside'}\n                }\n            },\n            data:[200, 170, 240, 244, 200, 220, 210]\n        },\n        {\n            name:'收入',\n            type:'bar',\n            stack: '总量',\n            itemStyle: {\n                normal: {\n                    label : {show: true}\n                }\n            },\n            data:[320, 302, 341, 374, 390, 450, 420]\n        },\n        {\n            name:'支出',\n            type:'bar',\n            stack: '总量',\n            itemStyle: {normal: {\n                label : {show: true, position: 'left'}\n            }},\n            data:[-120, -132, -101, -134, -190, -230, -210]\n        }\n    ]\n};\n{% endecharts %}\n","source":"about/index.md","raw":"---\ntitle:  About me\ndate: 2019-03-21 20:38:49\ntype: \"about\"\n\ncomments: false\n---\n2323\n{% echarts 400 '85%' %}\n{\n    tooltip : {\n        trigger: 'axis',\n        axisPointer : {            // 坐标轴指示器，坐标轴触发有效\n            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'\n        }\n    },\n    legend: {\n        data:['利润', '支出', '收入']\n    },\n    grid: {\n        left: '3%',\n        right: '4%',\n        bottom: '3%',\n        containLabel: true\n    },\n    xAxis : [\n        {\n            type : 'value'\n        }\n    ],\n    yAxis : [\n        {\n            type : 'category',\n            axisTick : {show: false},\n            data : ['周一','周二','周三','周四','周五','周六','周日']\n        }\n    ],\n    series : [\n        {\n            name:'利润',\n            type:'bar',\n            itemStyle : {\n                normal: {\n                    label: {show: true, position: 'inside'}\n                }\n            },\n            data:[200, 170, 240, 244, 200, 220, 210]\n        },\n        {\n            name:'收入',\n            type:'bar',\n            stack: '总量',\n            itemStyle: {\n                normal: {\n                    label : {show: true}\n                }\n            },\n            data:[320, 302, 341, 374, 390, 450, 420]\n        },\n        {\n            name:'支出',\n            type:'bar',\n            stack: '总量',\n            itemStyle: {normal: {\n                label : {show: true, position: 'left'}\n            }},\n            data:[-120, -132, -101, -134, -190, -230, -210]\n        }\n    ]\n};\n{% endecharts %}\n","updated":"2019-05-27T11:14:39.929Z","path":"about/index.html","layout":"page","_id":"cjw6jley50001p4n7myv03aia","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>2323<br><div id=\"echarts4668\" style=\"width: 85%;height: 400px;margin: 0 auto\"></div>\r\n<script src=\"http://echarts.baidu.com/dist/echarts.common.min.js\"></script>\r\n<script type=\"text/javascript\">\r\n        // 基于准备好的dom，初始化echarts实例\r\n        var myChart = echarts.init(document.getElementById('echarts4668'));\r\n\r\n        // 指定图表的配置项和数据\r\n        var option = {\n    tooltip : {\n        trigger: 'axis',\n        axisPointer : {            // 坐标轴指示器，坐标轴触发有效\n            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'\n        }\n    },\n    legend: {\n        data:['利润', '支出', '收入']\n    },\n    grid: {\n        left: '3%',\n        right: '4%',\n        bottom: '3%',\n        containLabel: true\n    },\n    xAxis : [\n        {\n            type : 'value'\n        }\n    ],\n    yAxis : [\n        {\n            type : 'category',\n            axisTick : {show: false},\n            data : ['周一','周二','周三','周四','周五','周六','周日']\n        }\n    ],\n    series : [\n        {\n            name:'利润',\n            type:'bar',\n            itemStyle : {\n                normal: {\n                    label: {show: true, position: 'inside'}\n                }\n            },\n            data:[200, 170, 240, 244, 200, 220, 210]\n        },\n        {\n            name:'收入',\n            type:'bar',\n            stack: '总量',\n            itemStyle: {\n                normal: {\n                    label : {show: true}\n                }\n            },\n            data:[320, 302, 341, 374, 390, 450, 420]\n        },\n        {\n            name:'支出',\n            type:'bar',\n            stack: '总量',\n            itemStyle: {normal: {\n                label : {show: true, position: 'left'}\n            }},\n            data:[-120, -132, -101, -134, -190, -230, -210]\n        }\n    ]\n};\r\n\r\n        // 使用刚指定的配置项和数据显示图表。\r\n        myChart.setOption(option);\r\n</script></p>\n","site":{"data":{}},"length":1632,"excerpt":"","more":"<p>2323<br><div id=\"echarts4668\" style=\"width: 85%;height: 400px;margin: 0 auto\"></div>\r\n<script src=\"http://echarts.baidu.com/dist/echarts.common.min.js\"></script>\r\n<script type=\"text/javascript\">\r\n        // 基于准备好的dom，初始化echarts实例\r\n        var myChart = echarts.init(document.getElementById('echarts4668'));\r\n\r\n        // 指定图表的配置项和数据\r\n        var option = {\n    tooltip : {\n        trigger: 'axis',\n        axisPointer : {            // 坐标轴指示器，坐标轴触发有效\n            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'\n        }\n    },\n    legend: {\n        data:['利润', '支出', '收入']\n    },\n    grid: {\n        left: '3%',\n        right: '4%',\n        bottom: '3%',\n        containLabel: true\n    },\n    xAxis : [\n        {\n            type : 'value'\n        }\n    ],\n    yAxis : [\n        {\n            type : 'category',\n            axisTick : {show: false},\n            data : ['周一','周二','周三','周四','周五','周六','周日']\n        }\n    ],\n    series : [\n        {\n            name:'利润',\n            type:'bar',\n            itemStyle : {\n                normal: {\n                    label: {show: true, position: 'inside'}\n                }\n            },\n            data:[200, 170, 240, 244, 200, 220, 210]\n        },\n        {\n            name:'收入',\n            type:'bar',\n            stack: '总量',\n            itemStyle: {\n                normal: {\n                    label : {show: true}\n                }\n            },\n            data:[320, 302, 341, 374, 390, 450, 420]\n        },\n        {\n            name:'支出',\n            type:'bar',\n            stack: '总量',\n            itemStyle: {normal: {\n                label : {show: true, position: 'left'}\n            }},\n            data:[-120, -132, -101, -134, -190, -230, -210]\n        }\n    ]\n};\r\n\r\n        // 使用刚指定的配置项和数据显示图表。\r\n        myChart.setOption(option);\r\n</script></p>\n"},{"title":"分类","date":"2019-03-21T12:37:51.000Z","type":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\ndate: 2019-03-21 20:37:51\ntype: \"categories\"\n\ncomments: false\n---","updated":"2019-05-25T06:26:05.293Z","path":"categories/index.html","layout":"page","_id":"cjw6jley90003p4n79y179d93","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script>","site":{"data":{}},"length":0,"excerpt":"","more":""},{"title":"留言互动","date":"2019-05-24T17:18:09.000Z","type":"guestbook","_content":"\n\n<div align=\"center\"> \n<img src=\"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1558956326532&di=82cc9907fc903cfb978a35206986d3f6&imgtype=0&src=http%3A%2F%2Fimg.mp.itc.cn%2Fupload%2F20160809%2F31283a3e2d7f411492d3fb27297180ec_th.jpg\" />\n</div>\n\n[//]: #(aplay音频播放https://github.com/MoePlayer/hexo-tag-aplayer)\n{% meting \"2250011882\" \"netease\" \"playlist\" \"autoplay\" \"mutex:false\" \"order:random\" \"listmaxheight:250px\" \"preload:none\"  \"theme:#f7f7f7\"%}\n","source":"guestbook/index.md","raw":"---\ntitle: 留言互动\ndate: 2019-05-25 01:18:09\ntype: \"guestbook\"\n---\n\n\n<div align=\"center\"> \n<img src=\"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1558956326532&di=82cc9907fc903cfb978a35206986d3f6&imgtype=0&src=http%3A%2F%2Fimg.mp.itc.cn%2Fupload%2F20160809%2F31283a3e2d7f411492d3fb27297180ec_th.jpg\" />\n</div>\n\n[//]: #(aplay音频播放https://github.com/MoePlayer/hexo-tag-aplayer)\n{% meting \"2250011882\" \"netease\" \"playlist\" \"autoplay\" \"mutex:false\" \"order:random\" \"listmaxheight:250px\" \"preload:none\"  \"theme:#f7f7f7\"%}\n","updated":"2019-05-28T02:02:23.512Z","path":"guestbook/index.html","_id":"cjw6jleyf0007p4n7o270uv2b","comments":1,"layout":"page","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><div align=\"center\"><br><img src=\"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1558956326532&di=82cc9907fc903cfb978a35206986d3f6&imgtype=0&src=http%3A%2F%2Fimg.mp.itc.cn%2Fupload%2F20160809%2F31283a3e2d7f411492d3fb27297180ec_th.jpg\"><br></div>\n\n\n    <div id=\"aplayer-cjrvtOGE\" class=\"aplayer aplayer-tag-marker meting-tag-marker\" data-id=\"2250011882\" data-server=\"netease\" data-type=\"playlist\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"false\" data-listmaxheight=\"250px\" data-preload=\"none\" data-theme=\"#f7f7f7\" data-order=\"random\"></div>\n","site":{"data":{}},"length":8,"excerpt":"","more":"<div align=\"center\"><br><img src=\"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1558956326532&di=82cc9907fc903cfb978a35206986d3f6&imgtype=0&src=http%3A%2F%2Fimg.mp.itc.cn%2Fupload%2F20160809%2F31283a3e2d7f411492d3fb27297180ec_th.jpg\"><br></div>\n\n\n    <div id=\"aplayer-cjrvtOGE\" class=\"aplayer aplayer-tag-marker meting-tag-marker\" data-id=\"2250011882\" data-server=\"netease\" data-type=\"playlist\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"false\" data-listmaxheight=\"250px\" data-preload=\"none\" data-theme=\"#f7f7f7\" data-order=\"random\"></div>\n"},{"title":"标签","date":"2019-03-21T12:38:32.000Z","type":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\ndate: 2019-03-21 20:38:32\ntype: \"tags\"\n\ncomments: false\n---","updated":"2019-05-25T06:25:52.435Z","path":"tags/index.html","layout":"page","_id":"cjw6jleyi0009p4n7zl4gov2e","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script>","site":{"data":{}},"length":0,"excerpt":"","more":""},{"_content":"<!DOCTYPE HTML>\n<html lang=\"zh-CN\">\n\n\n<head><meta name=\"generator\" content=\"Hexo 3.8.0\">\n    <meta charset=\"utf-8\">\n    <meta name=\"keywords\" content=\"关于, 闪烁之狐, Blinkfox\">\n    <meta name=\"description\" content=\"关于 | 闪烁之狐\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, user-scalable=no\">\n    <meta name=\"renderer\" content=\"webkit|ie-stand|ie-comp\">\n    <meta name=\"mobile-web-app-capable\" content=\"yes\">\n    <meta name=\"format-detection\" content=\"telephone=no\">\n    <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n    <meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black-translucent\">\n    <title>关于 | 闪烁之狐</title>\n    <link rel=\"icon\" type=\"image/png\" href=\"/favicon.png\">\n\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/awesome/css/font-awesome.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/materialize/materialize.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/aos/aos.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/animate/animate.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/lightGallery/css/lightgallery.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/css/matery.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/css/my.css\">\n    <style type=\"text/css\">\n        \n        code[class*=\"language-\"], pre[class*=\"language-\"] {\n            white-space: pre !important;\n        }\n        \n    </style>\n\n    <script src=\"/libs/jquery/jquery-2.2.0.min.js\"></script>\n<link rel=\"stylesheet\" href=\"/css/prism-tomorrow.css\" type=\"text/css\"></head>\n\n\n<body>\n\n<header class=\"navbar-fixed\">\n    <nav id=\"headNav\" class=\"bg-color nav-transparent\">\n        <div id=\"navContainer\" class=\"nav-wrapper container\">\n            <div class=\"brand-logo\">\n                <a href=\"/\" class=\"waves-effect waves-light\">\n                    \n                    <img src=\"/medias/logo.png\" class=\"logo-img\" alt=\"LOGO\">\n                    \n                    <span class=\"logo-span\">闪烁之狐</span>\n                </a>\n            </div>\n            \n\n<a href=\"#\" data-target=\"mobile-nav\" class=\"sidenav-trigger button-collapse\"><i class=\"fa fa-navicon\"></i></a>\n<ul class=\"right\">\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-home\"></i>\n            \n            <span>首页</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/tags\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-tags\"></i>\n            \n            <span>标签</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/categories\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-bookmark\"></i>\n            \n            <span>分类</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/archives\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-archive\"></i>\n            \n            <span>归档</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/about\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-user-circle-o\"></i>\n            \n            <span>关于</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/friends\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-address-book\"></i>\n            \n            <span>友情链接</span>\n        </a>\n    </li>\n    \n    <li>\n        <a href=\"#searchModal\" class=\"modal-trigger waves-effect waves-light\">\n            <i id=\"searchIcon\" class=\"fa fa-search\" title=\"搜索\"></i>\n        </a>\n    </li>\n</ul>\n\n<div id=\"mobile-nav\" class=\"side-nav sidenav\">\n\n    <div class=\"mobile-head bg-color\">\n        \n        <img src=\"/medias/logo.png\" class=\"logo-img circle responsive-img\">\n        \n        <div class=\"logo-name\">闪烁之狐</div>\n        <div class=\"logo-desc\">\n            \n            从来没有真正的绝境，只有心灵的迷途\n            \n        </div>\n    </div>\n\n    \n\n    <ul class=\"menu-list mobile-menu-list\">\n        \n        <li>\n            <a href=\"/\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-home\"></i>\n                \n                首页\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/tags\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-tags\"></i>\n                \n                标签\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/categories\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-bookmark\"></i>\n                \n                分类\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/archives\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-archive\"></i>\n                \n                归档\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/about\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-user-circle-o\"></i>\n                \n                关于\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/friends\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-address-book\"></i>\n                \n                友情链接\n            </a>\n        </li>\n        \n        \n        <li><div class=\"divider\"></div></li>\n        <li>\n            <a href=\"https://github.com/blinkfox/hexo-theme-matery\" class=\"waves-effect waves-light\" target=\"_blank\">\n                <i class=\"fa fa-github-square fa-fw\"></i>Fork Me\n            </a>\n        </li>\n        \n    </ul>\n</div>\n\n        </div>\n\n        \n            <style>\n    .nav-transparent .github-corner {\n        display: none !important;\n    }\n\n    .github-corner {\n        position: absolute;\n        z-index: 10;\n        top: 0;\n        right: 0;\n        border: 0;\n        transform: scale(1.1);\n    }\n\n    .github-corner svg {\n        color: #0f9d58;\n        fill: #fff;\n        height: 64px;\n        width: 64px;\n    }\n\n    .github-corner:hover .octo-arm {\n        animation: a 0.56s ease-in-out;\n    }\n\n    .github-corner .octo-arm {\n        animation: none;\n    }\n\n    @keyframes a {\n        0%,\n        to {\n            transform: rotate(0);\n        }\n        20%,\n        60% {\n            transform: rotate(-25deg);\n        }\n        40%,\n        80% {\n            transform: rotate(10deg);\n        }\n    }\n</style>\n\n<a href=\"https://github.com/blinkfox/hexo-theme-matery\" class=\"github-corner tooltipped hide-on-med-and-down\" target=\"_blank\" data-tooltip=\"Fork Me\" data-position=\"left\" data-delay=\"50\">\n    <svg viewbox=\"0 0 250 250\" aria-hidden=\"true\">\n        <path d=\"M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z\"/>\n        <path d=\"M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2\" fill=\"currentColor\" style=\"transform-origin: 130px 106px;\" class=\"octo-arm\"/>\n        <path d=\"M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z\" fill=\"currentColor\" class=\"octo-body\"/>\n    </svg>\n</a>\n        \n    </nav>\n\n</header>\n\n<style type=\"text/css\">\n    /* don't remove. */\n    .about-cover {\n        height: 75vh;\n    }\n</style>\n\n<div class=\"bg-cover pd-header about-cover\">\n    <div class=\"container\">\n    <div class=\"row\">\n    <div class=\"col s10 offset-s1 m8 offset-m2 l8 offset-l2\">\n        <div class=\"brand\">\n            <div class=\"title center-align\">\n                \n                    闪烁之狐\n                \n            </div>\n\n            <div class=\"description center-align\">\n                \n                    从来没有真正的绝境，只有心灵的迷途\n                \n            </div>\n        </div>\n    </div>\n</div>\n<script>\n// 每天切换 banner 图.  Switch banner image every day.\n$('.bg-cover').css('background-image', 'url(/medias/banner/' + new Date().getDay() + '.jpg)');\n</script>\n    </div>\n</div>\n\n<main class=\"content\">\n\n    <div id=\"aboutme\" class=\"container about-container\">\n        <div class=\"card\">\n            <div class=\"card-content\">\n                <div class=\"row\">\n                    <div class=\"post-statis col l4 hide-on-med-and-down\" data-aos=\"zoom-in-right\">\n                        \n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/\" target=\"_blank\">58</a></span>\n    <span class=\"name\">文章</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/categories\" target=\"_blank\">6</a></span>\n    <span class=\"name\">分类</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/tags\" target=\"_blank\">29</a></span>\n    <span class=\"name\">标签</span>\n</div>\n\n                    </div>\n                    <div class=\"col s12 m12 l4\">\n                        <div class=\"profile center-align\">\n                            <div class=\"avatar\">\n                                <img src=\"/medias/avatar.jpg\" alt=\"blinkfox\" class=\"circle responsive-img avatar-img\">\n                            </div>\n                            <div class=\"author\">\n                                <div class=\"post-statis hide-on-large-only\" data-aos=\"zoom-in-right\">\n                                    \n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/\" target=\"_blank\">58</a></span>\n    <span class=\"name\">文章</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/categories\" target=\"_blank\">6</a></span>\n    <span class=\"name\">分类</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/tags\" target=\"_blank\">29</a></span>\n    <span class=\"name\">标签</span>\n</div>\n\n                                </div>\n                                <div class=\"title\">blinkfox</div>\n                                <div class=\"career\">软件工程师</div>\n                                <div class=\"social-link hide-on-large-only\" data-aos=\"zoom-in-left\">\n                                    \n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"col l4 hide-on-med-and-down\" data-aos=\"zoom-in-left\">\n                        <div class=\"social-link\">\n                            \n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"introduction center-align\" data-aos=\"fade-up\">现实的抽象是语言，语言的抽象是程序，程序的抽象是数理逻辑，数理逻辑的抽象是超越认知的真理。</div>\n\n                <style type=\"text/css\">\n    #posts-chart,\n    #categories-chart,\n    #tags-chart {\n        width: 100%;\n        height: 300px;\n        margin: 0.5rem auto;\n        padding: 0.5rem;\n    }\n</style>\n\n<div id=\"postCharts\" class=\"post-charts\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-bar-chart\"></i>&nbsp;&nbsp;文章统计图\n    </div>\n    <div class=\"row\">\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"posts-chart\"></div>\n        </div>\n\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"categories-chart\"></div>\n        </div>\n\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"tags-chart\"></div>\n        </div>\n    </div>\n</div>\n\n<script type=\"text/javascript\" src=\"/libs/echarts/echarts.min.js\"></script>\n<script>\n    let postsChart = echarts.init(document.getElementById('posts-chart'));\n    let categoriesChart = echarts.init(document.getElementById('categories-chart'));\n    let tagsChart = echarts.init(document.getElementById('tags-chart'));\n\n    \n\n    let postsOption = {\n        title: {\n            text: '文章发布统计图',\n            top: -5,\n            x: 'center'\n        },\n        tooltip: {\n            trigger: 'axis'\n        },\n        xAxis: {\n            type: 'category',\n            data: [\"2018-03\",\"2018-04\",\"2018-05\",\"2018-06\",\"2018-07\",\"2018-08\",\"2018-09\",\"2018-10\",\"2018-11\",\"2018-12\",\"2019-01\",\"2019-02\",\"2019-03\"]\n        },\n        yAxis: {\n            type: 'value',\n        },\n        series: [\n            {\n                name: '文章篇数',\n                type: 'line',\n                color: ['#6772e5'],\n                data: [0,0,0,0,0,0,18,21,14,2,1,1,1],\n                markPoint: {\n                    symbolSize: 45,\n                    color: ['#fa755a','#3ecf8e','#82d3f4'],\n                    data: [{\n                        type: 'max',\n                        itemStyle: {color: ['#3ecf8e']},\n                        name: '最大值'\n                    }, {\n                        type: 'min',\n                        itemStyle: {color: ['#fa755a']},\n                        name: '最小值'\n                    }]\n                },\n                markLine: {\n                    itemStyle: {color: ['#ab47bc']},\n                    data: [\n                        {type: 'average', name: '平均值'}\n                    ]\n                }\n            }\n        ]\n    };\n\n    \n\n    let categoriesOption = {\n        title: {\n            text: '文章分类统计图',\n            top: -4,\n            x: 'center'\n        },\n        tooltip: {\n            trigger: 'item',\n            formatter: \"{a} <br/>{b} : {c} ({d}%)\"\n        },\n        series: [\n            {\n                name: '分类',\n                type: 'pie',\n                radius: '50%',\n                color: ['#6772e5', '#ff9e0f', '#fa755a', '#3ecf8e', '#82d3f4', '#ab47bc', '#525f7f', '#f51c47', '#26A69A'],\n                data: [{\"name\":\"前端\",\"value\":6},{\"name\":\"编程之道\",\"value\":3},{\"name\":\"软件设计\",\"value\":16},{\"name\":\"数据库\",\"value\":1},{\"name\":\"软件工具\",\"value\":8},{\"name\":\"后端\",\"value\":24}],\n                itemStyle: {\n                    emphasis: {\n                        shadowBlur: 10,\n                        shadowOffsetX: 0,\n                        shadowColor: 'rgba(0, 0, 0, 0.5)'\n                    }\n                }\n            }\n        ]\n    };\n\n    \n\n    let tagsOption = {\n        title: {\n            text: 'TOP10 标签统计图',\n            top: -5,\n            x: 'center'\n        },\n        tooltip: {},\n        xAxis: [\n            {\n                type: 'category',\n                data: [\"Java\",\"设计模式\",\"JavaScript\",\"Linux\",\"Apache\",\"面向对象编程\",\"Hexo\",\"UML\",\"MVEL\",\"单元测试\"]\n            }\n        ],\n        yAxis: [\n            {\n                type: 'value'\n            }\n        ],\n        series: [\n            {\n                type: 'bar',\n                color: ['#82d3f4'],\n                barWidth : 18,\n                data: [42,14,4,4,4,3,2,2,2,2],\n                markPoint: {\n                    symbolSize: 45,\n                    data: [{\n                        type: 'max',\n                        itemStyle: {color: ['#3ecf8e']},\n                        name: '最大值'\n                    }, {\n                        type: 'min',\n                        itemStyle: {color: ['#fa755a']},\n                        name: '最小值'\n                    }],\n                },\n                markLine: {\n                    itemStyle: {color: ['#ab47bc']},\n                    data: [\n                        {type: 'average', name: '平均值'}\n                    ]\n                }\n            }\n        ]\n    };\n\n    // render the charts\n    postsChart.setOption(postsOption);\n    categoriesChart.setOption(categoriesOption);\n    tagsChart.setOption(tagsOption);\n</script>\n\n                \n                \n<div class=\"my-projects\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-gift\"></i>&nbsp;&nbsp;我的项目\n    </div>\n    <div class=\"row\">\n        \n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"http://github.com/blinkfox/hexo-theme-matery\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #66BB6A 0%, #81C784 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-meetup\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"http://github.com/blinkfox/hexo-theme-matery\" target=\"_blank\">hexo-theme-matery</a>\n                </div>\n                <div class=\"info-desc\">一个采用 Material Design 和响应式设计的 Hexo 博客主题。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/zealot\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #F06292 0%, #EF5350 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-database\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/zealot\" target=\"_blank\">zealt</a>\n                </div>\n                <div class=\"info-desc\">一个轻量级的 SQL 和参数动态生成工具库</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/typora-vue-theme\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #29B6F6 0%, #1E88E5 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-file-text-o\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/typora-vue-theme\" target=\"_blank\">typora-vue-theme</a>\n                </div>\n                <div class=\"info-desc\">这是 Typora Markdown 编辑器的类似 Vue 文档风格的主题。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/adept\" class=\"icon\" style=\"background: linear-gradient(135deg, #ffeb3b 0%, #ff9900 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-compress\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/adept\" target=\"_blank\">adept</a>\n                </div>\n                <div class=\"info-desc\">这是一个用于简化 JDBC 操作的轻量级 DAO 工具库。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/stalker\" class=\"icon\" style=\"background: linear-gradient(135deg, #e079fc 0%, #7c44ff 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-snowflake-o\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/stalker\" target=\"_blank\">stalker</a>\n                </div>\n                <div class=\"info-desc\">这是一个简单的用来对 Java 代码做性能评估的工具库。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/mini-table\" class=\"icon\" style=\"background: linear-gradient(135deg, #309286 0%, #32dbc6 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-table\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/mini-table\" target=\"_blank\">mini-table</a>\n                </div>\n                <div class=\"info-desc\">这是一个轻量级、零依赖、可定制化修改的 Java ASCII 表格生成库。</div>\n            </div>\n        </div>\n        \n        \n    </div>\n</div>\n                \n\n                \n                \n<div class=\"my-skills\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-wrench\"></i>&nbsp;&nbsp;我的技能\n    </div>\n    <div class=\"row\">\n        \n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #FF0066 0%, #FF00CC 100%); width: 90%\">\n                    <span>Java</span>\n                </div>\n                <div class=\"skill-bar-percent\">90%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #9900FF 0%, #CC66FF 100%); width: 80%\">\n                    <span>JavaScript</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #2196F3 0%, #42A5F5 100%); width: 80%\">\n                    <span>HTML5</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #00BCD4 0%, #80DEEA 100%); width: 70%\">\n                    <span>CSS</span>\n                </div>\n                <div class=\"skill-bar-percent\">70%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #4CAF50 0%, #81C784 100%); width: 90%\">\n                    <span>SQL</span>\n                </div>\n                <div class=\"skill-bar-percent\">90%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #FFEB3B 0%, #FFF176 100%); width: 80%\">\n                    <span>程序设计</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n    </div>\n\n    \n\n    \n    <div class=\"other-skills chip-container\" data-aos=\"zoom-in-up\">\n        <div class=\"sub-title center-align\"><i class=\"fa fa-book\"></i>&nbsp;&nbsp;其他技能</div>\n        <div class=\"tag-chips center-align\">\n            \n            \n            <a href=\"/tags/Hexo/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Hexo</span>\n            </a>\n            \n            \n            \n            \n            \n            \n            \n            <a href=\"/tags/面向对象编程/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">面向对象编程</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/UML/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">UML</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/PostgreSQL/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">PostgreSQL</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/数据库/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">数据库</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/CPU缓存/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">CPU缓存</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/hexo-theme-matery/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">hexo-theme-matery</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/整洁代码/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">整洁代码</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/重构/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">重构</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/性能测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">性能测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/MVEL/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">MVEL</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Linux/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Linux</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Typora/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Typora</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Markdown/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Markdown</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Vue/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Vue</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/设计模式/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">设计模式</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Google/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Google</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/设计原则/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">设计原则</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/单元测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">单元测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Spring/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Spring</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/SpringBoot/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">SpringBoot</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Git/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Git</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Apache/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Apache</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/GitLab-CI/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">GitLab CI</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/DevOps/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">DevOps</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Jenkins/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Jenkins</span>\n            </a>\n            \n            \n        </div>\n    </div>\n    \n\n</div>\n                \n\n                \n                \n<div id=\"myGallery\" class=\"my-gallery\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-photo\"></i>&nbsp;&nbsp;相册\n    </div>\n    <div class=\"row\">\n        \n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/0.jpg\">\n                <img src=\"/medias/featureimages/0.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/1.jpg\">\n                <img src=\"/medias/featureimages/1.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/2.jpg\">\n                <img src=\"/medias/featureimages/2.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        \n    </div>\n</div>\n\n<script>\n    $(function () {\n        let animateClass = 'animated pulse';\n        $('#myGallery .photo').hover(function () {\n            $(this).addClass(animateClass);\n        }, function () {\n            $(this).removeClass(animateClass);\n        });\n    });\n</script>\n                \n\n            </div>\n        </div>\n    </div>\n</main>\n<footer class=\"page-footer bg-color\">\n    <div class=\"container row center-align\">\n        <div class=\"col s12 m8 l8 copy-right\">\n            本站由&copy;<a href=\"https://blinkfox.github.io/\" target=\"_blank\">Blinkfox</a>基于\n            <a href=\"https://hexo.io/\" target=\"_blank\">Hexo</a> 的\n            <a href=\"https://github.com/blinkfox/hexo-theme-matery\" target=\"_blank\">hexo-theme-matery</a>主题搭建.\n\n            \n                &nbsp;<i class=\"fa fa-area-chart\"></i>&nbsp;站点总字数:&nbsp;\n                <span class=\"white-color\">192.6k</span>\n            \n\n            \n\t\t\t\n                <br>\n                \n                <span id=\"busuanzi_container_site_pv\">\n                    <i class=\"fa fa-heart-o\"></i>\n                    本站总访问量 <span id=\"busuanzi_value_site_pv\" class=\"white-color\"></span>\n                </span>\n                \n                \n                <span id=\"busuanzi_container_site_uv\">\n                    <i class=\"fa fa-users\"></i>\n                    次,&nbsp;访客数 <span id=\"busuanzi_value_site_uv\" class=\"white-color\"></span> 人.\n                </span>\n                \n            \n        </div>\n        <div class=\"col s12 m4 l4 social-link social-statis\">\n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n</div>\n    </div>\n</footer>\n\n<div class=\"progress-bar\"></div>\n\n\n<!-- 搜索遮罩框 -->\n<div id=\"searchModal\" class=\"modal\">\n    <div class=\"modal-content\">\n        <div class=\"search-header\">\n            <span class=\"title\"><i class=\"fa fa-search\"></i>&nbsp;&nbsp;搜索</span>\n            <input type=\"search\" id=\"searchInput\" name=\"s\" placeholder=\"请输入搜索的关键字\" class=\"search-input\">\n        </div>\n        <div id=\"searchResult\"></div>\n    </div>\n</div>\n\n<script src=\"/js/search.js\"></script>\n<script type=\"text/javascript\">\n$(function () {\n    searchFunc(\"/\" + \"search.xml\", 'searchInput', 'searchResult');\n});\n</script>\n<!-- 回到顶部按钮 -->\n<div id=\"backTop\" class=\"top-scroll\">\n    <a class=\"btn-floating btn-large waves-effect waves-light\" href=\"#!\">\n        <i class=\"fa fa-angle-up\"></i>\n    </a>\n</div>\n\n\n<script src=\"/libs/materialize/materialize.min.js\"></script>\n<script src=\"/libs/masonry/masonry.pkgd.min.js\"></script>\n<script src=\"/libs/aos/aos.js\"></script>\n<script src=\"/libs/scrollprogress/scrollProgress.min.js\"></script>\n<script src=\"/libs/lightGallery/js/lightgallery-all.min.js\"></script>\n<script src=\"/js/matery.js\"></script>\n\n<!-- Global site tag (gtag.js) - Google Analytics -->\n\n\n\n    <script src=\"/libs/others/clicklove.js\"></script>\n\n\n    <script async src=\"/libs/others/busuanzi.pure.mini.js\"></script>\n\n\n</body>\n</html>","source":"about/index.html","raw":"<!DOCTYPE HTML>\n<html lang=\"zh-CN\">\n\n\n<head><meta name=\"generator\" content=\"Hexo 3.8.0\">\n    <meta charset=\"utf-8\">\n    <meta name=\"keywords\" content=\"关于, 闪烁之狐, Blinkfox\">\n    <meta name=\"description\" content=\"关于 | 闪烁之狐\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, user-scalable=no\">\n    <meta name=\"renderer\" content=\"webkit|ie-stand|ie-comp\">\n    <meta name=\"mobile-web-app-capable\" content=\"yes\">\n    <meta name=\"format-detection\" content=\"telephone=no\">\n    <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n    <meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black-translucent\">\n    <title>关于 | 闪烁之狐</title>\n    <link rel=\"icon\" type=\"image/png\" href=\"/favicon.png\">\n\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/awesome/css/font-awesome.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/materialize/materialize.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/aos/aos.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/animate/animate.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/lightGallery/css/lightgallery.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/css/matery.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/css/my.css\">\n    <style type=\"text/css\">\n        \n        code[class*=\"language-\"], pre[class*=\"language-\"] {\n            white-space: pre !important;\n        }\n        \n    </style>\n\n    <script src=\"/libs/jquery/jquery-2.2.0.min.js\"></script>\n<link rel=\"stylesheet\" href=\"/css/prism-tomorrow.css\" type=\"text/css\"></head>\n\n\n<body>\n\n<header class=\"navbar-fixed\">\n    <nav id=\"headNav\" class=\"bg-color nav-transparent\">\n        <div id=\"navContainer\" class=\"nav-wrapper container\">\n            <div class=\"brand-logo\">\n                <a href=\"/\" class=\"waves-effect waves-light\">\n                    \n                    <img src=\"/medias/logo.png\" class=\"logo-img\" alt=\"LOGO\">\n                    \n                    <span class=\"logo-span\">闪烁之狐</span>\n                </a>\n            </div>\n            \n\n<a href=\"#\" data-target=\"mobile-nav\" class=\"sidenav-trigger button-collapse\"><i class=\"fa fa-navicon\"></i></a>\n<ul class=\"right\">\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-home\"></i>\n            \n            <span>首页</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/tags\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-tags\"></i>\n            \n            <span>标签</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/categories\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-bookmark\"></i>\n            \n            <span>分类</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/archives\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-archive\"></i>\n            \n            <span>归档</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/about\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-user-circle-o\"></i>\n            \n            <span>关于</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/friends\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-address-book\"></i>\n            \n            <span>友情链接</span>\n        </a>\n    </li>\n    \n    <li>\n        <a href=\"#searchModal\" class=\"modal-trigger waves-effect waves-light\">\n            <i id=\"searchIcon\" class=\"fa fa-search\" title=\"搜索\"></i>\n        </a>\n    </li>\n</ul>\n\n<div id=\"mobile-nav\" class=\"side-nav sidenav\">\n\n    <div class=\"mobile-head bg-color\">\n        \n        <img src=\"/medias/logo.png\" class=\"logo-img circle responsive-img\">\n        \n        <div class=\"logo-name\">闪烁之狐</div>\n        <div class=\"logo-desc\">\n            \n            从来没有真正的绝境，只有心灵的迷途\n            \n        </div>\n    </div>\n\n    \n\n    <ul class=\"menu-list mobile-menu-list\">\n        \n        <li>\n            <a href=\"/\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-home\"></i>\n                \n                首页\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/tags\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-tags\"></i>\n                \n                标签\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/categories\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-bookmark\"></i>\n                \n                分类\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/archives\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-archive\"></i>\n                \n                归档\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/about\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-user-circle-o\"></i>\n                \n                关于\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/friends\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-address-book\"></i>\n                \n                友情链接\n            </a>\n        </li>\n        \n        \n        <li><div class=\"divider\"></div></li>\n        <li>\n            <a href=\"https://github.com/blinkfox/hexo-theme-matery\" class=\"waves-effect waves-light\" target=\"_blank\">\n                <i class=\"fa fa-github-square fa-fw\"></i>Fork Me\n            </a>\n        </li>\n        \n    </ul>\n</div>\n\n        </div>\n\n        \n            <style>\n    .nav-transparent .github-corner {\n        display: none !important;\n    }\n\n    .github-corner {\n        position: absolute;\n        z-index: 10;\n        top: 0;\n        right: 0;\n        border: 0;\n        transform: scale(1.1);\n    }\n\n    .github-corner svg {\n        color: #0f9d58;\n        fill: #fff;\n        height: 64px;\n        width: 64px;\n    }\n\n    .github-corner:hover .octo-arm {\n        animation: a 0.56s ease-in-out;\n    }\n\n    .github-corner .octo-arm {\n        animation: none;\n    }\n\n    @keyframes a {\n        0%,\n        to {\n            transform: rotate(0);\n        }\n        20%,\n        60% {\n            transform: rotate(-25deg);\n        }\n        40%,\n        80% {\n            transform: rotate(10deg);\n        }\n    }\n</style>\n\n<a href=\"https://github.com/blinkfox/hexo-theme-matery\" class=\"github-corner tooltipped hide-on-med-and-down\" target=\"_blank\" data-tooltip=\"Fork Me\" data-position=\"left\" data-delay=\"50\">\n    <svg viewbox=\"0 0 250 250\" aria-hidden=\"true\">\n        <path d=\"M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z\"/>\n        <path d=\"M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2\" fill=\"currentColor\" style=\"transform-origin: 130px 106px;\" class=\"octo-arm\"/>\n        <path d=\"M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z\" fill=\"currentColor\" class=\"octo-body\"/>\n    </svg>\n</a>\n        \n    </nav>\n\n</header>\n\n<style type=\"text/css\">\n    /* don't remove. */\n    .about-cover {\n        height: 75vh;\n    }\n</style>\n\n<div class=\"bg-cover pd-header about-cover\">\n    <div class=\"container\">\n    <div class=\"row\">\n    <div class=\"col s10 offset-s1 m8 offset-m2 l8 offset-l2\">\n        <div class=\"brand\">\n            <div class=\"title center-align\">\n                \n                    闪烁之狐\n                \n            </div>\n\n            <div class=\"description center-align\">\n                \n                    从来没有真正的绝境，只有心灵的迷途\n                \n            </div>\n        </div>\n    </div>\n</div>\n<script>\n// 每天切换 banner 图.  Switch banner image every day.\n$('.bg-cover').css('background-image', 'url(/medias/banner/' + new Date().getDay() + '.jpg)');\n</script>\n    </div>\n</div>\n\n<main class=\"content\">\n\n    <div id=\"aboutme\" class=\"container about-container\">\n        <div class=\"card\">\n            <div class=\"card-content\">\n                <div class=\"row\">\n                    <div class=\"post-statis col l4 hide-on-med-and-down\" data-aos=\"zoom-in-right\">\n                        \n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/\" target=\"_blank\">58</a></span>\n    <span class=\"name\">文章</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/categories\" target=\"_blank\">6</a></span>\n    <span class=\"name\">分类</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/tags\" target=\"_blank\">29</a></span>\n    <span class=\"name\">标签</span>\n</div>\n\n                    </div>\n                    <div class=\"col s12 m12 l4\">\n                        <div class=\"profile center-align\">\n                            <div class=\"avatar\">\n                                <img src=\"/medias/avatar.jpg\" alt=\"blinkfox\" class=\"circle responsive-img avatar-img\">\n                            </div>\n                            <div class=\"author\">\n                                <div class=\"post-statis hide-on-large-only\" data-aos=\"zoom-in-right\">\n                                    \n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/\" target=\"_blank\">58</a></span>\n    <span class=\"name\">文章</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/categories\" target=\"_blank\">6</a></span>\n    <span class=\"name\">分类</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/tags\" target=\"_blank\">29</a></span>\n    <span class=\"name\">标签</span>\n</div>\n\n                                </div>\n                                <div class=\"title\">blinkfox</div>\n                                <div class=\"career\">软件工程师</div>\n                                <div class=\"social-link hide-on-large-only\" data-aos=\"zoom-in-left\">\n                                    \n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"col l4 hide-on-med-and-down\" data-aos=\"zoom-in-left\">\n                        <div class=\"social-link\">\n                            \n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"introduction center-align\" data-aos=\"fade-up\">现实的抽象是语言，语言的抽象是程序，程序的抽象是数理逻辑，数理逻辑的抽象是超越认知的真理。</div>\n\n                <style type=\"text/css\">\n    #posts-chart,\n    #categories-chart,\n    #tags-chart {\n        width: 100%;\n        height: 300px;\n        margin: 0.5rem auto;\n        padding: 0.5rem;\n    }\n</style>\n\n<div id=\"postCharts\" class=\"post-charts\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-bar-chart\"></i>&nbsp;&nbsp;文章统计图\n    </div>\n    <div class=\"row\">\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"posts-chart\"></div>\n        </div>\n\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"categories-chart\"></div>\n        </div>\n\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"tags-chart\"></div>\n        </div>\n    </div>\n</div>\n\n<script type=\"text/javascript\" src=\"/libs/echarts/echarts.min.js\"></script>\n<script>\n    let postsChart = echarts.init(document.getElementById('posts-chart'));\n    let categoriesChart = echarts.init(document.getElementById('categories-chart'));\n    let tagsChart = echarts.init(document.getElementById('tags-chart'));\n\n    \n\n    let postsOption = {\n        title: {\n            text: '文章发布统计图',\n            top: -5,\n            x: 'center'\n        },\n        tooltip: {\n            trigger: 'axis'\n        },\n        xAxis: {\n            type: 'category',\n            data: [\"2018-03\",\"2018-04\",\"2018-05\",\"2018-06\",\"2018-07\",\"2018-08\",\"2018-09\",\"2018-10\",\"2018-11\",\"2018-12\",\"2019-01\",\"2019-02\",\"2019-03\"]\n        },\n        yAxis: {\n            type: 'value',\n        },\n        series: [\n            {\n                name: '文章篇数',\n                type: 'line',\n                color: ['#6772e5'],\n                data: [0,0,0,0,0,0,18,21,14,2,1,1,1],\n                markPoint: {\n                    symbolSize: 45,\n                    color: ['#fa755a','#3ecf8e','#82d3f4'],\n                    data: [{\n                        type: 'max',\n                        itemStyle: {color: ['#3ecf8e']},\n                        name: '最大值'\n                    }, {\n                        type: 'min',\n                        itemStyle: {color: ['#fa755a']},\n                        name: '最小值'\n                    }]\n                },\n                markLine: {\n                    itemStyle: {color: ['#ab47bc']},\n                    data: [\n                        {type: 'average', name: '平均值'}\n                    ]\n                }\n            }\n        ]\n    };\n\n    \n\n    let categoriesOption = {\n        title: {\n            text: '文章分类统计图',\n            top: -4,\n            x: 'center'\n        },\n        tooltip: {\n            trigger: 'item',\n            formatter: \"{a} <br/>{b} : {c} ({d}%)\"\n        },\n        series: [\n            {\n                name: '分类',\n                type: 'pie',\n                radius: '50%',\n                color: ['#6772e5', '#ff9e0f', '#fa755a', '#3ecf8e', '#82d3f4', '#ab47bc', '#525f7f', '#f51c47', '#26A69A'],\n                data: [{\"name\":\"前端\",\"value\":6},{\"name\":\"编程之道\",\"value\":3},{\"name\":\"软件设计\",\"value\":16},{\"name\":\"数据库\",\"value\":1},{\"name\":\"软件工具\",\"value\":8},{\"name\":\"后端\",\"value\":24}],\n                itemStyle: {\n                    emphasis: {\n                        shadowBlur: 10,\n                        shadowOffsetX: 0,\n                        shadowColor: 'rgba(0, 0, 0, 0.5)'\n                    }\n                }\n            }\n        ]\n    };\n\n    \n\n    let tagsOption = {\n        title: {\n            text: 'TOP10 标签统计图',\n            top: -5,\n            x: 'center'\n        },\n        tooltip: {},\n        xAxis: [\n            {\n                type: 'category',\n                data: [\"Java\",\"设计模式\",\"JavaScript\",\"Linux\",\"Apache\",\"面向对象编程\",\"Hexo\",\"UML\",\"MVEL\",\"单元测试\"]\n            }\n        ],\n        yAxis: [\n            {\n                type: 'value'\n            }\n        ],\n        series: [\n            {\n                type: 'bar',\n                color: ['#82d3f4'],\n                barWidth : 18,\n                data: [42,14,4,4,4,3,2,2,2,2],\n                markPoint: {\n                    symbolSize: 45,\n                    data: [{\n                        type: 'max',\n                        itemStyle: {color: ['#3ecf8e']},\n                        name: '最大值'\n                    }, {\n                        type: 'min',\n                        itemStyle: {color: ['#fa755a']},\n                        name: '最小值'\n                    }],\n                },\n                markLine: {\n                    itemStyle: {color: ['#ab47bc']},\n                    data: [\n                        {type: 'average', name: '平均值'}\n                    ]\n                }\n            }\n        ]\n    };\n\n    // render the charts\n    postsChart.setOption(postsOption);\n    categoriesChart.setOption(categoriesOption);\n    tagsChart.setOption(tagsOption);\n</script>\n\n                \n                \n<div class=\"my-projects\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-gift\"></i>&nbsp;&nbsp;我的项目\n    </div>\n    <div class=\"row\">\n        \n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"http://github.com/blinkfox/hexo-theme-matery\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #66BB6A 0%, #81C784 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-meetup\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"http://github.com/blinkfox/hexo-theme-matery\" target=\"_blank\">hexo-theme-matery</a>\n                </div>\n                <div class=\"info-desc\">一个采用 Material Design 和响应式设计的 Hexo 博客主题。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/zealot\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #F06292 0%, #EF5350 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-database\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/zealot\" target=\"_blank\">zealt</a>\n                </div>\n                <div class=\"info-desc\">一个轻量级的 SQL 和参数动态生成工具库</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/typora-vue-theme\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #29B6F6 0%, #1E88E5 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-file-text-o\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/typora-vue-theme\" target=\"_blank\">typora-vue-theme</a>\n                </div>\n                <div class=\"info-desc\">这是 Typora Markdown 编辑器的类似 Vue 文档风格的主题。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/adept\" class=\"icon\" style=\"background: linear-gradient(135deg, #ffeb3b 0%, #ff9900 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-compress\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/adept\" target=\"_blank\">adept</a>\n                </div>\n                <div class=\"info-desc\">这是一个用于简化 JDBC 操作的轻量级 DAO 工具库。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/stalker\" class=\"icon\" style=\"background: linear-gradient(135deg, #e079fc 0%, #7c44ff 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-snowflake-o\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/stalker\" target=\"_blank\">stalker</a>\n                </div>\n                <div class=\"info-desc\">这是一个简单的用来对 Java 代码做性能评估的工具库。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/mini-table\" class=\"icon\" style=\"background: linear-gradient(135deg, #309286 0%, #32dbc6 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-table\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/mini-table\" target=\"_blank\">mini-table</a>\n                </div>\n                <div class=\"info-desc\">这是一个轻量级、零依赖、可定制化修改的 Java ASCII 表格生成库。</div>\n            </div>\n        </div>\n        \n        \n    </div>\n</div>\n                \n\n                \n                \n<div class=\"my-skills\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-wrench\"></i>&nbsp;&nbsp;我的技能\n    </div>\n    <div class=\"row\">\n        \n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #FF0066 0%, #FF00CC 100%); width: 90%\">\n                    <span>Java</span>\n                </div>\n                <div class=\"skill-bar-percent\">90%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #9900FF 0%, #CC66FF 100%); width: 80%\">\n                    <span>JavaScript</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #2196F3 0%, #42A5F5 100%); width: 80%\">\n                    <span>HTML5</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #00BCD4 0%, #80DEEA 100%); width: 70%\">\n                    <span>CSS</span>\n                </div>\n                <div class=\"skill-bar-percent\">70%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #4CAF50 0%, #81C784 100%); width: 90%\">\n                    <span>SQL</span>\n                </div>\n                <div class=\"skill-bar-percent\">90%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #FFEB3B 0%, #FFF176 100%); width: 80%\">\n                    <span>程序设计</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n    </div>\n\n    \n\n    \n    <div class=\"other-skills chip-container\" data-aos=\"zoom-in-up\">\n        <div class=\"sub-title center-align\"><i class=\"fa fa-book\"></i>&nbsp;&nbsp;其他技能</div>\n        <div class=\"tag-chips center-align\">\n            \n            \n            <a href=\"/tags/Hexo/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Hexo</span>\n            </a>\n            \n            \n            \n            \n            \n            \n            \n            <a href=\"/tags/面向对象编程/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">面向对象编程</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/UML/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">UML</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/PostgreSQL/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">PostgreSQL</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/数据库/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">数据库</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/CPU缓存/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">CPU缓存</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/hexo-theme-matery/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">hexo-theme-matery</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/整洁代码/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">整洁代码</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/重构/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">重构</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/性能测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">性能测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/MVEL/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">MVEL</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Linux/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Linux</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Typora/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Typora</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Markdown/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Markdown</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Vue/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Vue</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/设计模式/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">设计模式</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Google/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Google</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/设计原则/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">设计原则</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/单元测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">单元测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Spring/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Spring</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/SpringBoot/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">SpringBoot</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Git/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Git</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Apache/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Apache</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/GitLab-CI/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">GitLab CI</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/DevOps/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">DevOps</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Jenkins/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Jenkins</span>\n            </a>\n            \n            \n        </div>\n    </div>\n    \n\n</div>\n                \n\n                \n                \n<div id=\"myGallery\" class=\"my-gallery\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-photo\"></i>&nbsp;&nbsp;相册\n    </div>\n    <div class=\"row\">\n        \n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/0.jpg\">\n                <img src=\"/medias/featureimages/0.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/1.jpg\">\n                <img src=\"/medias/featureimages/1.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/2.jpg\">\n                <img src=\"/medias/featureimages/2.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        \n    </div>\n</div>\n\n<script>\n    $(function () {\n        let animateClass = 'animated pulse';\n        $('#myGallery .photo').hover(function () {\n            $(this).addClass(animateClass);\n        }, function () {\n            $(this).removeClass(animateClass);\n        });\n    });\n</script>\n                \n\n            </div>\n        </div>\n    </div>\n</main>\n<footer class=\"page-footer bg-color\">\n    <div class=\"container row center-align\">\n        <div class=\"col s12 m8 l8 copy-right\">\n            本站由&copy;<a href=\"https://blinkfox.github.io/\" target=\"_blank\">Blinkfox</a>基于\n            <a href=\"https://hexo.io/\" target=\"_blank\">Hexo</a> 的\n            <a href=\"https://github.com/blinkfox/hexo-theme-matery\" target=\"_blank\">hexo-theme-matery</a>主题搭建.\n\n            \n                &nbsp;<i class=\"fa fa-area-chart\"></i>&nbsp;站点总字数:&nbsp;\n                <span class=\"white-color\">192.6k</span>\n            \n\n            \n\t\t\t\n                <br>\n                \n                <span id=\"busuanzi_container_site_pv\">\n                    <i class=\"fa fa-heart-o\"></i>\n                    本站总访问量 <span id=\"busuanzi_value_site_pv\" class=\"white-color\"></span>\n                </span>\n                \n                \n                <span id=\"busuanzi_container_site_uv\">\n                    <i class=\"fa fa-users\"></i>\n                    次,&nbsp;访客数 <span id=\"busuanzi_value_site_uv\" class=\"white-color\"></span> 人.\n                </span>\n                \n            \n        </div>\n        <div class=\"col s12 m4 l4 social-link social-statis\">\n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n</div>\n    </div>\n</footer>\n\n<div class=\"progress-bar\"></div>\n\n\n<!-- 搜索遮罩框 -->\n<div id=\"searchModal\" class=\"modal\">\n    <div class=\"modal-content\">\n        <div class=\"search-header\">\n            <span class=\"title\"><i class=\"fa fa-search\"></i>&nbsp;&nbsp;搜索</span>\n            <input type=\"search\" id=\"searchInput\" name=\"s\" placeholder=\"请输入搜索的关键字\" class=\"search-input\">\n        </div>\n        <div id=\"searchResult\"></div>\n    </div>\n</div>\n\n<script src=\"/js/search.js\"></script>\n<script type=\"text/javascript\">\n$(function () {\n    searchFunc(\"/\" + \"search.xml\", 'searchInput', 'searchResult');\n});\n</script>\n<!-- 回到顶部按钮 -->\n<div id=\"backTop\" class=\"top-scroll\">\n    <a class=\"btn-floating btn-large waves-effect waves-light\" href=\"#!\">\n        <i class=\"fa fa-angle-up\"></i>\n    </a>\n</div>\n\n\n<script src=\"/libs/materialize/materialize.min.js\"></script>\n<script src=\"/libs/masonry/masonry.pkgd.min.js\"></script>\n<script src=\"/libs/aos/aos.js\"></script>\n<script src=\"/libs/scrollprogress/scrollProgress.min.js\"></script>\n<script src=\"/libs/lightGallery/js/lightgallery-all.min.js\"></script>\n<script src=\"/js/matery.js\"></script>\n\n<!-- Global site tag (gtag.js) - Google Analytics -->\n\n\n\n    <script src=\"/libs/others/clicklove.js\"></script>\n\n\n    <script async src=\"/libs/others/busuanzi.pure.mini.js\"></script>\n\n\n</body>\n</html>","date":"2019-05-28T02:02:23.511Z","updated":"2019-05-28T02:02:23.511Z","path":"about/index.html","_id":"cjw6jlf53003jp4n7o3mua8at","title":"","comments":1,"layout":"page","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><!DOCTYPE HTML>\n<html lang=\"zh-CN\">\n\n\n<head><meta name=\"generator\" content=\"Hexo 3.8.0\">\n    <meta charset=\"utf-8\">\n    <meta name=\"keywords\" content=\"关于, 闪烁之狐, Blinkfox\">\n    <meta name=\"description\" content=\"关于 | 闪烁之狐\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, user-scalable=no\">\n    <meta name=\"renderer\" content=\"webkit|ie-stand|ie-comp\">\n    <meta name=\"mobile-web-app-capable\" content=\"yes\">\n    <meta name=\"format-detection\" content=\"telephone=no\">\n    <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n    <meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black-translucent\">\n    <title>关于 | 闪烁之狐</title>\n    <link rel=\"icon\" type=\"image/png\" href=\"/favicon.png\">\n\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/awesome/css/font-awesome.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/materialize/materialize.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/aos/aos.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/animate/animate.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/lightGallery/css/lightgallery.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/css/matery.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/css/my.css\">\n    <style type=\"text/css\">\n        \n        code[class*=\"language-\"], pre[class*=\"language-\"] {\n            white-space: pre !important;\n        }\n        \n    </style>\n\n    <script src=\"/libs/jquery/jquery-2.2.0.min.js\"></script>\n<link rel=\"stylesheet\" href=\"/css/prism-tomorrow.css\" type=\"text/css\"></head>\n\n\n<body>\n\n<header class=\"navbar-fixed\">\n    <nav id=\"headNav\" class=\"bg-color nav-transparent\">\n        <div id=\"navContainer\" class=\"nav-wrapper container\">\n            <div class=\"brand-logo\">\n                <a href=\"/\" class=\"waves-effect waves-light\">\n                    \n                    <img src=\"/medias/logo.png\" class=\"logo-img\" alt=\"LOGO\">\n                    \n                    <span class=\"logo-span\">闪烁之狐</span>\n                </a>\n            </div>\n            \n\n<a href=\"#\" data-target=\"mobile-nav\" class=\"sidenav-trigger button-collapse\"><i class=\"fa fa-navicon\"></i></a>\n<ul class=\"right\">\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-home\"></i>\n            \n            <span>首页</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/tags\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-tags\"></i>\n            \n            <span>标签</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/categories\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-bookmark\"></i>\n            \n            <span>分类</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/archives\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-archive\"></i>\n            \n            <span>归档</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/about\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-user-circle-o\"></i>\n            \n            <span>关于</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/friends\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-address-book\"></i>\n            \n            <span>友情链接</span>\n        </a>\n    </li>\n    \n    <li>\n        <a href=\"#searchModal\" class=\"modal-trigger waves-effect waves-light\">\n            <i id=\"searchIcon\" class=\"fa fa-search\" title=\"搜索\"></i>\n        </a>\n    </li>\n</ul>\n\n<div id=\"mobile-nav\" class=\"side-nav sidenav\">\n\n    <div class=\"mobile-head bg-color\">\n        \n        <img src=\"/medias/logo.png\" class=\"logo-img circle responsive-img\">\n        \n        <div class=\"logo-name\">闪烁之狐</div>\n        <div class=\"logo-desc\">\n            \n            从来没有真正的绝境，只有心灵的迷途\n            \n        </div>\n    </div>\n\n    \n\n    <ul class=\"menu-list mobile-menu-list\">\n        \n        <li>\n            <a href=\"/\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-home\"></i>\n                \n                首页\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/tags\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-tags\"></i>\n                \n                标签\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/categories\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-bookmark\"></i>\n                \n                分类\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/archives\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-archive\"></i>\n                \n                归档\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/about\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-user-circle-o\"></i>\n                \n                关于\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/friends\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-address-book\"></i>\n                \n                友情链接\n            </a>\n        </li>\n        \n        \n        <li><div class=\"divider\"></div></li>\n        <li>\n            <a href=\"https://github.com/blinkfox/hexo-theme-matery\" class=\"waves-effect waves-light\" target=\"_blank\">\n                <i class=\"fa fa-github-square fa-fw\"></i>Fork Me\n            </a>\n        </li>\n        \n    </ul>\n</div>\n\n        </div>\n\n        \n            <style>\n    .nav-transparent .github-corner {\n        display: none !important;\n    }\n\n    .github-corner {\n        position: absolute;\n        z-index: 10;\n        top: 0;\n        right: 0;\n        border: 0;\n        transform: scale(1.1);\n    }\n\n    .github-corner svg {\n        color: #0f9d58;\n        fill: #fff;\n        height: 64px;\n        width: 64px;\n    }\n\n    .github-corner:hover .octo-arm {\n        animation: a 0.56s ease-in-out;\n    }\n\n    .github-corner .octo-arm {\n        animation: none;\n    }\n\n    @keyframes a {\n        0%,\n        to {\n            transform: rotate(0);\n        }\n        20%,\n        60% {\n            transform: rotate(-25deg);\n        }\n        40%,\n        80% {\n            transform: rotate(10deg);\n        }\n    }\n</style>\n\n<a href=\"https://github.com/blinkfox/hexo-theme-matery\" class=\"github-corner tooltipped hide-on-med-and-down\" target=\"_blank\" data-tooltip=\"Fork Me\" data-position=\"left\" data-delay=\"50\">\n    <svg viewbox=\"0 0 250 250\" aria-hidden=\"true\">\n        <path d=\"M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z\"/>\n        <path d=\"M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2\" fill=\"currentColor\" style=\"transform-origin: 130px 106px;\" class=\"octo-arm\"/>\n        <path d=\"M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z\" fill=\"currentColor\" class=\"octo-body\"/>\n    </svg>\n</a>\n        \n    </nav>\n\n</header>\n\n<style type=\"text/css\">\n    /* don't remove. */\n    .about-cover {\n        height: 75vh;\n    }\n</style>\n\n<div class=\"bg-cover pd-header about-cover\">\n    <div class=\"container\">\n    <div class=\"row\">\n    <div class=\"col s10 offset-s1 m8 offset-m2 l8 offset-l2\">\n        <div class=\"brand\">\n            <div class=\"title center-align\">\n                \n                    闪烁之狐\n                \n            </div>\n\n            <div class=\"description center-align\">\n                \n                    从来没有真正的绝境，只有心灵的迷途\n                \n            </div>\n        </div>\n    </div>\n</div>\n<script>\n// 每天切换 banner 图.  Switch banner image every day.\n$('.bg-cover').css('background-image', 'url(/medias/banner/' + new Date().getDay() + '.jpg)');\n</script>\n    </div>\n</div>\n\n<main class=\"content\">\n\n    <div id=\"aboutme\" class=\"container about-container\">\n        <div class=\"card\">\n            <div class=\"card-content\">\n                <div class=\"row\">\n                    <div class=\"post-statis col l4 hide-on-med-and-down\" data-aos=\"zoom-in-right\">\n                        \n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/\" target=\"_blank\">58</a></span>\n    <span class=\"name\">文章</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/categories\" target=\"_blank\">6</a></span>\n    <span class=\"name\">分类</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/tags\" target=\"_blank\">29</a></span>\n    <span class=\"name\">标签</span>\n</div>\n\n                    </div>\n                    <div class=\"col s12 m12 l4\">\n                        <div class=\"profile center-align\">\n                            <div class=\"avatar\">\n                                <img src=\"/medias/avatar.jpg\" alt=\"blinkfox\" class=\"circle responsive-img avatar-img\">\n                            </div>\n                            <div class=\"author\">\n                                <div class=\"post-statis hide-on-large-only\" data-aos=\"zoom-in-right\">\n                                    \n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/\" target=\"_blank\">58</a></span>\n    <span class=\"name\">文章</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/categories\" target=\"_blank\">6</a></span>\n    <span class=\"name\">分类</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/tags\" target=\"_blank\">29</a></span>\n    <span class=\"name\">标签</span>\n</div>\n\n                                </div>\n                                <div class=\"title\">blinkfox</div>\n                                <div class=\"career\">软件工程师</div>\n                                <div class=\"social-link hide-on-large-only\" data-aos=\"zoom-in-left\">\n                                    \n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\" target=\"_blank\" rel=\"noopener\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"col l4 hide-on-med-and-down\" data-aos=\"zoom-in-left\">\n                        <div class=\"social-link\">\n                            \n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\" target=\"_blank\" rel=\"noopener\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"introduction center-align\" data-aos=\"fade-up\">现实的抽象是语言，语言的抽象是程序，程序的抽象是数理逻辑，数理逻辑的抽象是超越认知的真理。</div>\n\n                <style type=\"text/css\">\n    #posts-chart,\n    #categories-chart,\n    #tags-chart {\n        width: 100%;\n        height: 300px;\n        margin: 0.5rem auto;\n        padding: 0.5rem;\n    }\n</style>\n\n<div id=\"postCharts\" class=\"post-charts\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-bar-chart\"></i>&nbsp;&nbsp;文章统计图\n    </div>\n    <div class=\"row\">\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"posts-chart\"></div>\n        </div>\n\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"categories-chart\"></div>\n        </div>\n\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"tags-chart\"></div>\n        </div>\n    </div>\n</div>\n\n<script type=\"text/javascript\" src=\"/libs/echarts/echarts.min.js\"></script>\n<script>\n    let postsChart = echarts.init(document.getElementById('posts-chart'));\n    let categoriesChart = echarts.init(document.getElementById('categories-chart'));\n    let tagsChart = echarts.init(document.getElementById('tags-chart'));\n\n    \n\n    let postsOption = {\n        title: {\n            text: '文章发布统计图',\n            top: -5,\n            x: 'center'\n        },\n        tooltip: {\n            trigger: 'axis'\n        },\n        xAxis: {\n            type: 'category',\n            data: [\"2018-03\",\"2018-04\",\"2018-05\",\"2018-06\",\"2018-07\",\"2018-08\",\"2018-09\",\"2018-10\",\"2018-11\",\"2018-12\",\"2019-01\",\"2019-02\",\"2019-03\"]\n        },\n        yAxis: {\n            type: 'value',\n        },\n        series: [\n            {\n                name: '文章篇数',\n                type: 'line',\n                color: ['#6772e5'],\n                data: [0,0,0,0,0,0,18,21,14,2,1,1,1],\n                markPoint: {\n                    symbolSize: 45,\n                    color: ['#fa755a','#3ecf8e','#82d3f4'],\n                    data: [{\n                        type: 'max',\n                        itemStyle: {color: ['#3ecf8e']},\n                        name: '最大值'\n                    }, {\n                        type: 'min',\n                        itemStyle: {color: ['#fa755a']},\n                        name: '最小值'\n                    }]\n                },\n                markLine: {\n                    itemStyle: {color: ['#ab47bc']},\n                    data: [\n                        {type: 'average', name: '平均值'}\n                    ]\n                }\n            }\n        ]\n    };\n\n    \n\n    let categoriesOption = {\n        title: {\n            text: '文章分类统计图',\n            top: -4,\n            x: 'center'\n        },\n        tooltip: {\n            trigger: 'item',\n            formatter: \"{a} <br/>{b} : {c} ({d}%)\"\n        },\n        series: [\n            {\n                name: '分类',\n                type: 'pie',\n                radius: '50%',\n                color: ['#6772e5', '#ff9e0f', '#fa755a', '#3ecf8e', '#82d3f4', '#ab47bc', '#525f7f', '#f51c47', '#26A69A'],\n                data: [{\"name\":\"前端\",\"value\":6},{\"name\":\"编程之道\",\"value\":3},{\"name\":\"软件设计\",\"value\":16},{\"name\":\"数据库\",\"value\":1},{\"name\":\"软件工具\",\"value\":8},{\"name\":\"后端\",\"value\":24}],\n                itemStyle: {\n                    emphasis: {\n                        shadowBlur: 10,\n                        shadowOffsetX: 0,\n                        shadowColor: 'rgba(0, 0, 0, 0.5)'\n                    }\n                }\n            }\n        ]\n    };\n\n    \n\n    let tagsOption = {\n        title: {\n            text: 'TOP10 标签统计图',\n            top: -5,\n            x: 'center'\n        },\n        tooltip: {},\n        xAxis: [\n            {\n                type: 'category',\n                data: [\"Java\",\"设计模式\",\"JavaScript\",\"Linux\",\"Apache\",\"面向对象编程\",\"Hexo\",\"UML\",\"MVEL\",\"单元测试\"]\n            }\n        ],\n        yAxis: [\n            {\n                type: 'value'\n            }\n        ],\n        series: [\n            {\n                type: 'bar',\n                color: ['#82d3f4'],\n                barWidth : 18,\n                data: [42,14,4,4,4,3,2,2,2,2],\n                markPoint: {\n                    symbolSize: 45,\n                    data: [{\n                        type: 'max',\n                        itemStyle: {color: ['#3ecf8e']},\n                        name: '最大值'\n                    }, {\n                        type: 'min',\n                        itemStyle: {color: ['#fa755a']},\n                        name: '最小值'\n                    }],\n                },\n                markLine: {\n                    itemStyle: {color: ['#ab47bc']},\n                    data: [\n                        {type: 'average', name: '平均值'}\n                    ]\n                }\n            }\n        ]\n    };\n\n    // render the charts\n    postsChart.setOption(postsOption);\n    categoriesChart.setOption(categoriesOption);\n    tagsChart.setOption(tagsOption);\n</script>\n\n                \n                \n<div class=\"my-projects\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-gift\"></i>&nbsp;&nbsp;我的项目\n    </div>\n    <div class=\"row\">\n        \n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"http://github.com/blinkfox/hexo-theme-matery\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #66BB6A 0%, #81C784 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-meetup\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"http://github.com/blinkfox/hexo-theme-matery\" target=\"_blank\">hexo-theme-matery</a>\n                </div>\n                <div class=\"info-desc\">一个采用 Material Design 和响应式设计的 Hexo 博客主题。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/zealot\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #F06292 0%, #EF5350 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-database\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/zealot\" target=\"_blank\">zealt</a>\n                </div>\n                <div class=\"info-desc\">一个轻量级的 SQL 和参数动态生成工具库</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/typora-vue-theme\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #29B6F6 0%, #1E88E5 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-file-text-o\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/typora-vue-theme\" target=\"_blank\">typora-vue-theme</a>\n                </div>\n                <div class=\"info-desc\">这是 Typora Markdown 编辑器的类似 Vue 文档风格的主题。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/adept\" class=\"icon\" style=\"background: linear-gradient(135deg, #ffeb3b 0%, #ff9900 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-compress\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/adept\" target=\"_blank\">adept</a>\n                </div>\n                <div class=\"info-desc\">这是一个用于简化 JDBC 操作的轻量级 DAO 工具库。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/stalker\" class=\"icon\" style=\"background: linear-gradient(135deg, #e079fc 0%, #7c44ff 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-snowflake-o\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/stalker\" target=\"_blank\">stalker</a>\n                </div>\n                <div class=\"info-desc\">这是一个简单的用来对 Java 代码做性能评估的工具库。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/mini-table\" class=\"icon\" style=\"background: linear-gradient(135deg, #309286 0%, #32dbc6 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-table\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/mini-table\" target=\"_blank\">mini-table</a>\n                </div>\n                <div class=\"info-desc\">这是一个轻量级、零依赖、可定制化修改的 Java ASCII 表格生成库。</div>\n            </div>\n        </div>\n        \n        \n    </div>\n</div>\n                \n\n                \n                \n<div class=\"my-skills\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-wrench\"></i>&nbsp;&nbsp;我的技能\n    </div>\n    <div class=\"row\">\n        \n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #FF0066 0%, #FF00CC 100%); width: 90%\">\n                    <span>Java</span>\n                </div>\n                <div class=\"skill-bar-percent\">90%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #9900FF 0%, #CC66FF 100%); width: 80%\">\n                    <span>JavaScript</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #2196F3 0%, #42A5F5 100%); width: 80%\">\n                    <span>HTML5</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #00BCD4 0%, #80DEEA 100%); width: 70%\">\n                    <span>CSS</span>\n                </div>\n                <div class=\"skill-bar-percent\">70%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #4CAF50 0%, #81C784 100%); width: 90%\">\n                    <span>SQL</span>\n                </div>\n                <div class=\"skill-bar-percent\">90%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #FFEB3B 0%, #FFF176 100%); width: 80%\">\n                    <span>程序设计</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n    </div>\n\n    \n\n    \n    <div class=\"other-skills chip-container\" data-aos=\"zoom-in-up\">\n        <div class=\"sub-title center-align\"><i class=\"fa fa-book\"></i>&nbsp;&nbsp;其他技能</div>\n        <div class=\"tag-chips center-align\">\n            \n            \n            <a href=\"/tags/Hexo/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Hexo</span>\n            </a>\n            \n            \n            \n            \n            \n            \n            \n            <a href=\"/tags/面向对象编程/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">面向对象编程</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/UML/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">UML</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/PostgreSQL/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">PostgreSQL</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/数据库/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">数据库</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/CPU缓存/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">CPU缓存</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/hexo-theme-matery/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">hexo-theme-matery</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/整洁代码/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">整洁代码</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/重构/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">重构</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/性能测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">性能测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/MVEL/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">MVEL</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Linux/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Linux</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Typora/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Typora</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Markdown/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Markdown</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Vue/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Vue</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/设计模式/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">设计模式</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Google/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Google</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/设计原则/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">设计原则</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/单元测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">单元测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Spring/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Spring</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/SpringBoot/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">SpringBoot</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Git/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Git</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Apache/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Apache</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/GitLab-CI/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">GitLab CI</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/DevOps/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">DevOps</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Jenkins/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Jenkins</span>\n            </a>\n            \n            \n        </div>\n    </div>\n    \n\n</div>\n                \n\n                \n                \n<div id=\"myGallery\" class=\"my-gallery\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-photo\"></i>&nbsp;&nbsp;相册\n    </div>\n    <div class=\"row\">\n        \n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/0.jpg\">\n                <img src=\"/medias/featureimages/0.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/1.jpg\">\n                <img src=\"/medias/featureimages/1.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/2.jpg\">\n                <img src=\"/medias/featureimages/2.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        \n    </div>\n</div>\n\n<script>\n    $(function () {\n        let animateClass = 'animated pulse';\n        $('#myGallery .photo').hover(function () {\n            $(this).addClass(animateClass);\n        }, function () {\n            $(this).removeClass(animateClass);\n        });\n    });\n</script>\n                \n\n            </div>\n        </div>\n    </div>\n</main>\n<footer class=\"page-footer bg-color\">\n    <div class=\"container row center-align\">\n        <div class=\"col s12 m8 l8 copy-right\">\n            本站由&copy;<a href=\"https://blinkfox.github.io/\" target=\"_blank\">Blinkfox</a>基于\n            <a href=\"https://hexo.io/\" target=\"_blank\">Hexo</a> 的\n            <a href=\"https://github.com/blinkfox/hexo-theme-matery\" target=\"_blank\">hexo-theme-matery</a>主题搭建.\n\n            \n                &nbsp;<i class=\"fa fa-area-chart\"></i>&nbsp;站点总字数:&nbsp;\n                <span class=\"white-color\">192.6k</span>\n            \n\n            \n\t\t\t\n                <br>\n                \n                <span id=\"busuanzi_container_site_pv\">\n                    <i class=\"fa fa-heart-o\"></i>\n                    本站总访问量 <span id=\"busuanzi_value_site_pv\" class=\"white-color\"></span>\n                </span>\n                \n                \n                <span id=\"busuanzi_container_site_uv\">\n                    <i class=\"fa fa-users\"></i>\n                    次,&nbsp;访客数 <span id=\"busuanzi_value_site_uv\" class=\"white-color\"></span> 人.\n                </span>\n                \n            \n        </div>\n        <div class=\"col s12 m4 l4 social-link social-statis\">\n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\" target=\"_blank\" rel=\"noopener\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n</div>\n    </div>\n</footer>\n\n<div class=\"progress-bar\"></div>\n\n\n<!-- 搜索遮罩框 -->\n<div id=\"searchModal\" class=\"modal\">\n    <div class=\"modal-content\">\n        <div class=\"search-header\">\n            <span class=\"title\"><i class=\"fa fa-search\"></i>&nbsp;&nbsp;搜索</span>\n            <input type=\"search\" id=\"searchInput\" name=\"s\" placeholder=\"请输入搜索的关键字\" class=\"search-input\">\n        </div>\n        <div id=\"searchResult\"></div>\n    </div>\n</div>\n\n<script src=\"/js/search.js\"></script>\n<script type=\"text/javascript\">\n$(function () {\n    searchFunc(\"/\" + \"search.xml\", 'searchInput', 'searchResult');\n});\n</script>\n<!-- 回到顶部按钮 -->\n<div id=\"backTop\" class=\"top-scroll\">\n    <a class=\"btn-floating btn-large waves-effect waves-light\" href=\"#!\">\n        <i class=\"fa fa-angle-up\"></i>\n    </a>\n</div>\n\n\n<script src=\"/libs/materialize/materialize.min.js\"></script>\n<script src=\"/libs/masonry/masonry.pkgd.min.js\"></script>\n<script src=\"/libs/aos/aos.js\"></script>\n<script src=\"/libs/scrollprogress/scrollProgress.min.js\"></script>\n<script src=\"/libs/lightGallery/js/lightgallery-all.min.js\"></script>\n<script src=\"/js/matery.js\"></script>\n\n<!-- Global site tag (gtag.js) - Google Analytics -->\n\n\n\n    <script src=\"/libs/others/clicklove.js\"></script>\n\n\n    <script async src=\"/libs/others/busuanzi.pure.mini.js\"></script>\n\n\n<script src=\"/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05\"></script><script>L2Dwidget.init({\"pluginRootPath\":\"live2dw/\",\"pluginJsPath\":\"lib/\",\"pluginModelPath\":\"assets/\",\"tagMode\":false,\"debug\":false,\"model\":{\"jsonPath\":\"/live2dw/assets/koharu.model.json\"},\"display\":{\"position\":\"left\",\"width\":250,\"height\":500},\"mobile\":{\"show\":false},\"react\":{\"opacity\":0.7},\"log\":false});</script></body>\n</html>","site":{"data":{}},"length":15354,"excerpt":"","more":"<!DOCTYPE HTML>\n<html lang=\"zh-CN\">\n\n\n<head><meta name=\"generator\" content=\"Hexo 3.8.0\">\n    <meta charset=\"utf-8\">\n    <meta name=\"keywords\" content=\"关于, 闪烁之狐, Blinkfox\">\n    <meta name=\"description\" content=\"关于 | 闪烁之狐\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, user-scalable=no\">\n    <meta name=\"renderer\" content=\"webkit|ie-stand|ie-comp\">\n    <meta name=\"mobile-web-app-capable\" content=\"yes\">\n    <meta name=\"format-detection\" content=\"telephone=no\">\n    <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n    <meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black-translucent\">\n    <title>关于 | 闪烁之狐</title>\n    <link rel=\"icon\" type=\"image/png\" href=\"/favicon.png\">\n\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/awesome/css/font-awesome.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/materialize/materialize.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/aos/aos.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/animate/animate.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/libs/lightGallery/css/lightgallery.min.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/css/matery.css\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/css/my.css\">\n    <style type=\"text/css\">\n        \n        code[class*=\"language-\"], pre[class*=\"language-\"] {\n            white-space: pre !important;\n        }\n        \n    </style>\n\n    <script src=\"/libs/jquery/jquery-2.2.0.min.js\"></script>\n<link rel=\"stylesheet\" href=\"/css/prism-tomorrow.css\" type=\"text/css\"></head>\n\n\n<body>\n\n<header class=\"navbar-fixed\">\n    <nav id=\"headNav\" class=\"bg-color nav-transparent\">\n        <div id=\"navContainer\" class=\"nav-wrapper container\">\n            <div class=\"brand-logo\">\n                <a href=\"/\" class=\"waves-effect waves-light\">\n                    \n                    <img src=\"/medias/logo.png\" class=\"logo-img\" alt=\"LOGO\">\n                    \n                    <span class=\"logo-span\">闪烁之狐</span>\n                </a>\n            </div>\n            \n\n<a href=\"#\" data-target=\"mobile-nav\" class=\"sidenav-trigger button-collapse\"><i class=\"fa fa-navicon\"></i></a>\n<ul class=\"right\">\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-home\"></i>\n            \n            <span>首页</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/tags\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-tags\"></i>\n            \n            <span>标签</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/categories\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-bookmark\"></i>\n            \n            <span>分类</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/archives\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-archive\"></i>\n            \n            <span>归档</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/about\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-user-circle-o\"></i>\n            \n            <span>关于</span>\n        </a>\n    </li>\n    \n    <li class=\"hide-on-med-and-down\">\n        <a href=\"/friends\" class=\"waves-effect waves-light\">\n            \n            <i class=\"fa fa-address-book\"></i>\n            \n            <span>友情链接</span>\n        </a>\n    </li>\n    \n    <li>\n        <a href=\"#searchModal\" class=\"modal-trigger waves-effect waves-light\">\n            <i id=\"searchIcon\" class=\"fa fa-search\" title=\"搜索\"></i>\n        </a>\n    </li>\n</ul>\n\n<div id=\"mobile-nav\" class=\"side-nav sidenav\">\n\n    <div class=\"mobile-head bg-color\">\n        \n        <img src=\"/medias/logo.png\" class=\"logo-img circle responsive-img\">\n        \n        <div class=\"logo-name\">闪烁之狐</div>\n        <div class=\"logo-desc\">\n            \n            从来没有真正的绝境，只有心灵的迷途\n            \n        </div>\n    </div>\n\n    \n\n    <ul class=\"menu-list mobile-menu-list\">\n        \n        <li>\n            <a href=\"/\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-home\"></i>\n                \n                首页\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/tags\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-tags\"></i>\n                \n                标签\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/categories\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-bookmark\"></i>\n                \n                分类\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/archives\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-archive\"></i>\n                \n                归档\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/about\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-user-circle-o\"></i>\n                \n                关于\n            </a>\n        </li>\n        \n        <li>\n            <a href=\"/friends\" class=\"waves-effect waves-light\">\n                \n                <i class=\"fa fa-fw fa-address-book\"></i>\n                \n                友情链接\n            </a>\n        </li>\n        \n        \n        <li><div class=\"divider\"></div></li>\n        <li>\n            <a href=\"https://github.com/blinkfox/hexo-theme-matery\" class=\"waves-effect waves-light\" target=\"_blank\">\n                <i class=\"fa fa-github-square fa-fw\"></i>Fork Me\n            </a>\n        </li>\n        \n    </ul>\n</div>\n\n        </div>\n\n        \n            <style>\n    .nav-transparent .github-corner {\n        display: none !important;\n    }\n\n    .github-corner {\n        position: absolute;\n        z-index: 10;\n        top: 0;\n        right: 0;\n        border: 0;\n        transform: scale(1.1);\n    }\n\n    .github-corner svg {\n        color: #0f9d58;\n        fill: #fff;\n        height: 64px;\n        width: 64px;\n    }\n\n    .github-corner:hover .octo-arm {\n        animation: a 0.56s ease-in-out;\n    }\n\n    .github-corner .octo-arm {\n        animation: none;\n    }\n\n    @keyframes a {\n        0%,\n        to {\n            transform: rotate(0);\n        }\n        20%,\n        60% {\n            transform: rotate(-25deg);\n        }\n        40%,\n        80% {\n            transform: rotate(10deg);\n        }\n    }\n</style>\n\n<a href=\"https://github.com/blinkfox/hexo-theme-matery\" class=\"github-corner tooltipped hide-on-med-and-down\" target=\"_blank\" data-tooltip=\"Fork Me\" data-position=\"left\" data-delay=\"50\">\n    <svg viewbox=\"0 0 250 250\" aria-hidden=\"true\">\n        <path d=\"M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z\"/>\n        <path d=\"M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2\" fill=\"currentColor\" style=\"transform-origin: 130px 106px;\" class=\"octo-arm\"/>\n        <path d=\"M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z\" fill=\"currentColor\" class=\"octo-body\"/>\n    </svg>\n</a>\n        \n    </nav>\n\n</header>\n\n<style type=\"text/css\">\n    /* don't remove. */\n    .about-cover {\n        height: 75vh;\n    }\n</style>\n\n<div class=\"bg-cover pd-header about-cover\">\n    <div class=\"container\">\n    <div class=\"row\">\n    <div class=\"col s10 offset-s1 m8 offset-m2 l8 offset-l2\">\n        <div class=\"brand\">\n            <div class=\"title center-align\">\n                \n                    闪烁之狐\n                \n            </div>\n\n            <div class=\"description center-align\">\n                \n                    从来没有真正的绝境，只有心灵的迷途\n                \n            </div>\n        </div>\n    </div>\n</div>\n<script>\n// 每天切换 banner 图.  Switch banner image every day.\n$('.bg-cover').css('background-image', 'url(/medias/banner/' + new Date().getDay() + '.jpg)');\n</script>\n    </div>\n</div>\n\n<main class=\"content\">\n\n    <div id=\"aboutme\" class=\"container about-container\">\n        <div class=\"card\">\n            <div class=\"card-content\">\n                <div class=\"row\">\n                    <div class=\"post-statis col l4 hide-on-med-and-down\" data-aos=\"zoom-in-right\">\n                        \n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/\" target=\"_blank\">58</a></span>\n    <span class=\"name\">文章</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/categories\" target=\"_blank\">6</a></span>\n    <span class=\"name\">分类</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/tags\" target=\"_blank\">29</a></span>\n    <span class=\"name\">标签</span>\n</div>\n\n                    </div>\n                    <div class=\"col s12 m12 l4\">\n                        <div class=\"profile center-align\">\n                            <div class=\"avatar\">\n                                <img src=\"/medias/avatar.jpg\" alt=\"blinkfox\" class=\"circle responsive-img avatar-img\">\n                            </div>\n                            <div class=\"author\">\n                                <div class=\"post-statis hide-on-large-only\" data-aos=\"zoom-in-right\">\n                                    \n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/\" target=\"_blank\">58</a></span>\n    <span class=\"name\">文章</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/categories\" target=\"_blank\">6</a></span>\n    <span class=\"name\">分类</span>\n</div>\n\n\n\n<div class=\"statis\">\n    <span class=\"count\"><a href=\"/tags\" target=\"_blank\">29</a></span>\n    <span class=\"name\">标签</span>\n</div>\n\n                                </div>\n                                <div class=\"title\">blinkfox</div>\n                                <div class=\"career\">软件工程师</div>\n                                <div class=\"social-link hide-on-large-only\" data-aos=\"zoom-in-left\">\n                                    \n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\" target=\"_blank\" rel=\"noopener\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"col l4 hide-on-med-and-down\" data-aos=\"zoom-in-left\">\n                        <div class=\"social-link\">\n                            \n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\" target=\"_blank\" rel=\"noopener\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"introduction center-align\" data-aos=\"fade-up\">现实的抽象是语言，语言的抽象是程序，程序的抽象是数理逻辑，数理逻辑的抽象是超越认知的真理。</div>\n\n                <style type=\"text/css\">\n    #posts-chart,\n    #categories-chart,\n    #tags-chart {\n        width: 100%;\n        height: 300px;\n        margin: 0.5rem auto;\n        padding: 0.5rem;\n    }\n</style>\n\n<div id=\"postCharts\" class=\"post-charts\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-bar-chart\"></i>&nbsp;&nbsp;文章统计图\n    </div>\n    <div class=\"row\">\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"posts-chart\"></div>\n        </div>\n\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"categories-chart\"></div>\n        </div>\n\n        <div class=\"chart col s12 m6 l4\" data-aos=\"zoom-in-up\">\n            <div id=\"tags-chart\"></div>\n        </div>\n    </div>\n</div>\n\n<script type=\"text/javascript\" src=\"/libs/echarts/echarts.min.js\"></script>\n<script>\n    let postsChart = echarts.init(document.getElementById('posts-chart'));\n    let categoriesChart = echarts.init(document.getElementById('categories-chart'));\n    let tagsChart = echarts.init(document.getElementById('tags-chart'));\n\n    \n\n    let postsOption = {\n        title: {\n            text: '文章发布统计图',\n            top: -5,\n            x: 'center'\n        },\n        tooltip: {\n            trigger: 'axis'\n        },\n        xAxis: {\n            type: 'category',\n            data: [\"2018-03\",\"2018-04\",\"2018-05\",\"2018-06\",\"2018-07\",\"2018-08\",\"2018-09\",\"2018-10\",\"2018-11\",\"2018-12\",\"2019-01\",\"2019-02\",\"2019-03\"]\n        },\n        yAxis: {\n            type: 'value',\n        },\n        series: [\n            {\n                name: '文章篇数',\n                type: 'line',\n                color: ['#6772e5'],\n                data: [0,0,0,0,0,0,18,21,14,2,1,1,1],\n                markPoint: {\n                    symbolSize: 45,\n                    color: ['#fa755a','#3ecf8e','#82d3f4'],\n                    data: [{\n                        type: 'max',\n                        itemStyle: {color: ['#3ecf8e']},\n                        name: '最大值'\n                    }, {\n                        type: 'min',\n                        itemStyle: {color: ['#fa755a']},\n                        name: '最小值'\n                    }]\n                },\n                markLine: {\n                    itemStyle: {color: ['#ab47bc']},\n                    data: [\n                        {type: 'average', name: '平均值'}\n                    ]\n                }\n            }\n        ]\n    };\n\n    \n\n    let categoriesOption = {\n        title: {\n            text: '文章分类统计图',\n            top: -4,\n            x: 'center'\n        },\n        tooltip: {\n            trigger: 'item',\n            formatter: \"{a} <br/>{b} : {c} ({d}%)\"\n        },\n        series: [\n            {\n                name: '分类',\n                type: 'pie',\n                radius: '50%',\n                color: ['#6772e5', '#ff9e0f', '#fa755a', '#3ecf8e', '#82d3f4', '#ab47bc', '#525f7f', '#f51c47', '#26A69A'],\n                data: [{\"name\":\"前端\",\"value\":6},{\"name\":\"编程之道\",\"value\":3},{\"name\":\"软件设计\",\"value\":16},{\"name\":\"数据库\",\"value\":1},{\"name\":\"软件工具\",\"value\":8},{\"name\":\"后端\",\"value\":24}],\n                itemStyle: {\n                    emphasis: {\n                        shadowBlur: 10,\n                        shadowOffsetX: 0,\n                        shadowColor: 'rgba(0, 0, 0, 0.5)'\n                    }\n                }\n            }\n        ]\n    };\n\n    \n\n    let tagsOption = {\n        title: {\n            text: 'TOP10 标签统计图',\n            top: -5,\n            x: 'center'\n        },\n        tooltip: {},\n        xAxis: [\n            {\n                type: 'category',\n                data: [\"Java\",\"设计模式\",\"JavaScript\",\"Linux\",\"Apache\",\"面向对象编程\",\"Hexo\",\"UML\",\"MVEL\",\"单元测试\"]\n            }\n        ],\n        yAxis: [\n            {\n                type: 'value'\n            }\n        ],\n        series: [\n            {\n                type: 'bar',\n                color: ['#82d3f4'],\n                barWidth : 18,\n                data: [42,14,4,4,4,3,2,2,2,2],\n                markPoint: {\n                    symbolSize: 45,\n                    data: [{\n                        type: 'max',\n                        itemStyle: {color: ['#3ecf8e']},\n                        name: '最大值'\n                    }, {\n                        type: 'min',\n                        itemStyle: {color: ['#fa755a']},\n                        name: '最小值'\n                    }],\n                },\n                markLine: {\n                    itemStyle: {color: ['#ab47bc']},\n                    data: [\n                        {type: 'average', name: '平均值'}\n                    ]\n                }\n            }\n        ]\n    };\n\n    // render the charts\n    postsChart.setOption(postsOption);\n    categoriesChart.setOption(categoriesOption);\n    tagsChart.setOption(tagsOption);\n</script>\n\n                \n                \n<div class=\"my-projects\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-gift\"></i>&nbsp;&nbsp;我的项目\n    </div>\n    <div class=\"row\">\n        \n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"http://github.com/blinkfox/hexo-theme-matery\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #66BB6A 0%, #81C784 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-meetup\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"http://github.com/blinkfox/hexo-theme-matery\" target=\"_blank\">hexo-theme-matery</a>\n                </div>\n                <div class=\"info-desc\">一个采用 Material Design 和响应式设计的 Hexo 博客主题。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/zealot\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #F06292 0%, #EF5350 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-database\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/zealot\" target=\"_blank\">zealt</a>\n                </div>\n                <div class=\"info-desc\">一个轻量级的 SQL 和参数动态生成工具库</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/typora-vue-theme\" class=\"icon\" style=\"background: linear-gradient(to bottom right, #29B6F6 0%, #1E88E5 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-file-text-o\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/typora-vue-theme\" target=\"_blank\">typora-vue-theme</a>\n                </div>\n                <div class=\"info-desc\">这是 Typora Markdown 编辑器的类似 Vue 文档风格的主题。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/adept\" class=\"icon\" style=\"background: linear-gradient(135deg, #ffeb3b 0%, #ff9900 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-compress\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/adept\" target=\"_blank\">adept</a>\n                </div>\n                <div class=\"info-desc\">这是一个用于简化 JDBC 操作的轻量级 DAO 工具库。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/stalker\" class=\"icon\" style=\"background: linear-gradient(135deg, #e079fc 0%, #7c44ff 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-snowflake-o\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/stalker\" target=\"_blank\">stalker</a>\n                </div>\n                <div class=\"info-desc\">这是一个简单的用来对 Java 代码做性能评估的工具库。</div>\n            </div>\n        </div>\n        \n        <div class=\"col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"info center-align\">\n                <a href=\"https://github.com/blinkfox/mini-table\" class=\"icon\" style=\"background: linear-gradient(135deg, #309286 0%, #32dbc6 100%)\" target=\"_blank\">\n                    <i class=\"fa fa-table\"></i>\n                </a>\n                <div class=\"info-title\">\n                    <a href=\"https://github.com/blinkfox/mini-table\" target=\"_blank\">mini-table</a>\n                </div>\n                <div class=\"info-desc\">这是一个轻量级、零依赖、可定制化修改的 Java ASCII 表格生成库。</div>\n            </div>\n        </div>\n        \n        \n    </div>\n</div>\n                \n\n                \n                \n<div class=\"my-skills\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-wrench\"></i>&nbsp;&nbsp;我的技能\n    </div>\n    <div class=\"row\">\n        \n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #FF0066 0%, #FF00CC 100%); width: 90%\">\n                    <span>Java</span>\n                </div>\n                <div class=\"skill-bar-percent\">90%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #9900FF 0%, #CC66FF 100%); width: 80%\">\n                    <span>JavaScript</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #2196F3 0%, #42A5F5 100%); width: 80%\">\n                    <span>HTML5</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #00BCD4 0%, #80DEEA 100%); width: 70%\">\n                    <span>CSS</span>\n                </div>\n                <div class=\"skill-bar-percent\">70%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #4CAF50 0%, #81C784 100%); width: 90%\">\n                    <span>SQL</span>\n                </div>\n                <div class=\"skill-bar-percent\">90%</div>\n            </div>\n        </div>\n        \n        \n        <div class=\"col s12 m6 l6\" data-aos=\"fade-up\">\n            <div class=\"skillbar\">\n                <div class=\"skillbar-title\" style=\"background: linear-gradient(to right, #FFEB3B 0%, #FFF176 100%); width: 80%\">\n                    <span>程序设计</span>\n                </div>\n                <div class=\"skill-bar-percent\">80%</div>\n            </div>\n        </div>\n        \n        \n    </div>\n\n    \n\n    \n    <div class=\"other-skills chip-container\" data-aos=\"zoom-in-up\">\n        <div class=\"sub-title center-align\"><i class=\"fa fa-book\"></i>&nbsp;&nbsp;其他技能</div>\n        <div class=\"tag-chips center-align\">\n            \n            \n            <a href=\"/tags/Hexo/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Hexo</span>\n            </a>\n            \n            \n            \n            \n            \n            \n            \n            <a href=\"/tags/面向对象编程/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">面向对象编程</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/UML/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">UML</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/PostgreSQL/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">PostgreSQL</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/数据库/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">数据库</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/CPU缓存/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">CPU缓存</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/hexo-theme-matery/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">hexo-theme-matery</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/整洁代码/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">整洁代码</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/重构/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">重构</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/性能测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">性能测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/MVEL/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">MVEL</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Linux/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Linux</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Typora/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Typora</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Markdown/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Markdown</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Vue/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Vue</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/设计模式/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">设计模式</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Google/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Google</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/设计原则/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">设计原则</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/单元测试/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">单元测试</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Spring/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Spring</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/SpringBoot/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">SpringBoot</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Git/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Git</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Apache/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Apache</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/GitLab-CI/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">GitLab CI</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/DevOps/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">DevOps</span>\n            </a>\n            \n            \n            \n            <a href=\"/tags/Jenkins/\" target=\"_blank\">\n                <span class=\"chip center-align waves-effect waves-light chip-default\">Jenkins</span>\n            </a>\n            \n            \n        </div>\n    </div>\n    \n\n</div>\n                \n\n                \n                \n<div id=\"myGallery\" class=\"my-gallery\">\n    <div class=\"title center-align\" data-aos=\"zoom-in-up\">\n        <i class=\"fa fa-photo\"></i>&nbsp;&nbsp;相册\n    </div>\n    <div class=\"row\">\n        \n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/0.jpg\">\n                <img src=\"/medias/featureimages/0.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/1.jpg\">\n                <img src=\"/medias/featureimages/1.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        <div class=\"photo col s12 m6 l4\" data-aos=\"fade-up\">\n            <div class=\"img-item\" data-src=\"/medias/featureimages/2.jpg\">\n                <img src=\"/medias/featureimages/2.jpg\" class=\"responsive-img\">\n            </div>\n        </div>\n        \n        \n    </div>\n</div>\n\n<script>\n    $(function () {\n        let animateClass = 'animated pulse';\n        $('#myGallery .photo').hover(function () {\n            $(this).addClass(animateClass);\n        }, function () {\n            $(this).removeClass(animateClass);\n        });\n    });\n</script>\n                \n\n            </div>\n        </div>\n    </div>\n</main>\n<footer class=\"page-footer bg-color\">\n    <div class=\"container row center-align\">\n        <div class=\"col s12 m8 l8 copy-right\">\n            本站由&copy;<a href=\"https://blinkfox.github.io/\" target=\"_blank\">Blinkfox</a>基于\n            <a href=\"https://hexo.io/\" target=\"_blank\">Hexo</a> 的\n            <a href=\"https://github.com/blinkfox/hexo-theme-matery\" target=\"_blank\">hexo-theme-matery</a>主题搭建.\n\n            \n                &nbsp;<i class=\"fa fa-area-chart\"></i>&nbsp;站点总字数:&nbsp;\n                <span class=\"white-color\">192.6k</span>\n            \n\n            \n\t\t\t\n                <br>\n                \n                <span id=\"busuanzi_container_site_pv\">\n                    <i class=\"fa fa-heart-o\"></i>\n                    本站总访问量 <span id=\"busuanzi_value_site_pv\" class=\"white-color\"></span>\n                </span>\n                \n                \n                <span id=\"busuanzi_container_site_uv\">\n                    <i class=\"fa fa-users\"></i>\n                    次,&nbsp;访客数 <span id=\"busuanzi_value_site_uv\" class=\"white-color\"></span> 人.\n                </span>\n                \n            \n        </div>\n        <div class=\"col s12 m4 l4 social-link social-statis\">\n    <a href=\"https://github.com/blinkfox/\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"访问我的GitHub\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-github\"></i>\n    </a>\n\n\n\n    <a href=\"mailto:chenjiayin1990@163.com\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"邮件联系我\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-envelope-open\"></i>\n    </a>\n\n\n\n    <a href=\"tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873\" class=\"tooltipped\" data-tooltip=\"QQ联系我: 1181062873\" data-position=\"top\" data-delay=\"50\" target=\"_blank\" rel=\"noopener\">\n        <i class=\"fa fa-qq\"></i>\n    </a>\n\n\n\n    <a href=\"/atom.xml\" class=\"tooltipped\" target=\"_blank\" data-tooltip=\"RSS 订阅\" data-position=\"top\" data-delay=\"50\">\n        <i class=\"fa fa-rss\"></i>\n    </a>\n</div>\n    </div>\n</footer>\n\n<div class=\"progress-bar\"></div>\n\n\n<!-- 搜索遮罩框 -->\n<div id=\"searchModal\" class=\"modal\">\n    <div class=\"modal-content\">\n        <div class=\"search-header\">\n            <span class=\"title\"><i class=\"fa fa-search\"></i>&nbsp;&nbsp;搜索</span>\n            <input type=\"search\" id=\"searchInput\" name=\"s\" placeholder=\"请输入搜索的关键字\" class=\"search-input\">\n        </div>\n        <div id=\"searchResult\"></div>\n    </div>\n</div>\n\n<script src=\"/js/search.js\"></script>\n<script type=\"text/javascript\">\n$(function () {\n    searchFunc(\"/\" + \"search.xml\", 'searchInput', 'searchResult');\n});\n</script>\n<!-- 回到顶部按钮 -->\n<div id=\"backTop\" class=\"top-scroll\">\n    <a class=\"btn-floating btn-large waves-effect waves-light\" href=\"#!\">\n        <i class=\"fa fa-angle-up\"></i>\n    </a>\n</div>\n\n\n<script src=\"/libs/materialize/materialize.min.js\"></script>\n<script src=\"/libs/masonry/masonry.pkgd.min.js\"></script>\n<script src=\"/libs/aos/aos.js\"></script>\n<script src=\"/libs/scrollprogress/scrollProgress.min.js\"></script>\n<script src=\"/libs/lightGallery/js/lightgallery-all.min.js\"></script>\n<script src=\"/js/matery.js\"></script>\n\n<!-- Global site tag (gtag.js) - Google Analytics -->\n\n\n\n    <script src=\"/libs/others/clicklove.js\"></script>\n\n\n    <script async src=\"/libs/others/busuanzi.pure.mini.js\"></script>\n\n\n<script src=\"/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05\"></script><script>L2Dwidget.init({\"pluginRootPath\":\"live2dw/\",\"pluginJsPath\":\"lib/\",\"pluginModelPath\":\"assets/\",\"tagMode\":false,\"debug\":false,\"model\":{\"jsonPath\":\"/live2dw/assets/koharu.model.json\"},\"display\":{\"position\":\"left\",\"width\":250,\"height\":500},\"mobile\":{\"show\":false},\"react\":{\"opacity\":0.7},\"log\":false});</script></body>\n</html>"}],"Post":[{"layout":"post","title":"阿里云ECS用465端口发邮件","author":"Pyker","img":"/images/bar/aliyun.jpg","top":false,"cover":false,"date":"2018-03-25T14:32:00.000Z","_content":"### 原由\n大家可能都知道在阿里云购买的ECS云主机是不能直接通过25号端口发邮件的，因为阿里云底层对25号端口做了屏蔽。所以例如我们需要做监控、报告等邮件通知行为时，只能修改默认的25号端口。\n下面我们就开始如何用465端口来发送邮件。\n\n### 请求数字证书\n* 创建目录，用来存放证书\n\n\t  [root@PLAY ~]# mkdir -p /root/.certs/\n\t  [root@PLAY ~]# echo -n | openssl s_client -connect smtp.126.com:465 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > ~/.certs/126.crt\n\t  depth=2 C = US, O = DigiCert Inc, OU = www.digicert.com, CN = DigiCert Global Root CA\n\t  verify return:1\n\t  depth=1 C = US, O = DigiCert Inc, OU = www.digicert.com, CN = GeoTrust RSA CA 2018\n\t  verify return:1\n\t  depth=0 C = CN, L = Hangzhou, O = \"NetEase (Hangzhou) Network Co., Ltd\", OU = Mail Dept., CN = *.126.com\n\t  verify return:1\n\t  DONE\n> `smtp.126.com:465` 为发件者的邮件服务器，我这用的是网易`126.com` 邮箱。生成`126.crt` 的证书。\n\n* 添加一个证书到证书数据库中\n\n\t  [root@PLAY ~]# certutil -A -n \"GeoTrust SSL CA\" -t \"C,,\" -d ~/.certs -i ~/.certs/126.crt\n\t  [root@PLAY ~]# certutil -A -n \"GeoTrust Global CA\" -t \"C,,\" -d ~/.certs -i ~/.certs/126.crt\n\t \n* 列出目录下证书\n\n\t  [root@PLAY ~]# certutil -L -d /root/.certs\n\t  Certificate Nickname Trust Attributes\n\t  SSL,S/MIME,JAR/XPI\n\t  GeoTrust SSL CA C,,\n### 获取126邮箱的授权码\n前往邮箱的登陆网站登陆自己的邮箱，在邮箱设置里找到`POP3/SMTP/IMAP` 设置，并且完成客户端授权密码。如下图：\n![邮箱授权码](/images/pic/shouquanma.png)\n\n### 配置/etc/mail.rc文件\n在/etc/mail.rc文件末尾追加如下参数\n```\nset bsdcompat\nset from=test_wly@126.com\nset smtp=\"smtps://smtp.126.com:465\"\nset smtp-auth-user=test_wly@126.com\nset smtp-auth-password=73jdi9dw7j3gc8gf1xvak01fss\nset smtp-auth=login\nset ssl-verify=ignore\nset nss-config-dir=/root/.certs\n```\n\n### 测试邮件发送是否正常\n```\n[root@PLAY ~]# echo \"test mail\" | mail -s \"nagios report\" test_wly@126.com\n```\n>如果配置正确，此时test_wly@126.com就能收到刚刚发送的测试邮件了。\n\n看起来已经成功了，但是发送完邮件还有报错：证书不被信任，且命令行就此卡住，需要按键才能出现命令提示符\n`Error in certificate: Peer's certificate issuer is not recognized.` \n可以按如下操作即可解决问题：\n```\n[root@PLAY ~]# cd /root/.certs/\n[root@PLAY .certs]# certutil -A -n \"GeoTrust SSL CA - G3\" -t \"Pu,Pu,Pu\" -d ./ -i 126.crt \nNotice: Trust flag u is set automatically if the private key is present.\n```","source":"_posts/aliyun-ecs-mail.md","raw":"layout: post\ntitle: 阿里云ECS用465端口发邮件\nauthor: Pyker\ncategories: Linux\nimg: /images/bar/aliyun.jpg\ntags:\n  - aliyun\ntop: false\ncover: false\ndate: 2018-03-25 22:32:00\n---\n### 原由\n大家可能都知道在阿里云购买的ECS云主机是不能直接通过25号端口发邮件的，因为阿里云底层对25号端口做了屏蔽。所以例如我们需要做监控、报告等邮件通知行为时，只能修改默认的25号端口。\n下面我们就开始如何用465端口来发送邮件。\n\n### 请求数字证书\n* 创建目录，用来存放证书\n\n\t  [root@PLAY ~]# mkdir -p /root/.certs/\n\t  [root@PLAY ~]# echo -n | openssl s_client -connect smtp.126.com:465 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > ~/.certs/126.crt\n\t  depth=2 C = US, O = DigiCert Inc, OU = www.digicert.com, CN = DigiCert Global Root CA\n\t  verify return:1\n\t  depth=1 C = US, O = DigiCert Inc, OU = www.digicert.com, CN = GeoTrust RSA CA 2018\n\t  verify return:1\n\t  depth=0 C = CN, L = Hangzhou, O = \"NetEase (Hangzhou) Network Co., Ltd\", OU = Mail Dept., CN = *.126.com\n\t  verify return:1\n\t  DONE\n> `smtp.126.com:465` 为发件者的邮件服务器，我这用的是网易`126.com` 邮箱。生成`126.crt` 的证书。\n\n* 添加一个证书到证书数据库中\n\n\t  [root@PLAY ~]# certutil -A -n \"GeoTrust SSL CA\" -t \"C,,\" -d ~/.certs -i ~/.certs/126.crt\n\t  [root@PLAY ~]# certutil -A -n \"GeoTrust Global CA\" -t \"C,,\" -d ~/.certs -i ~/.certs/126.crt\n\t \n* 列出目录下证书\n\n\t  [root@PLAY ~]# certutil -L -d /root/.certs\n\t  Certificate Nickname Trust Attributes\n\t  SSL,S/MIME,JAR/XPI\n\t  GeoTrust SSL CA C,,\n### 获取126邮箱的授权码\n前往邮箱的登陆网站登陆自己的邮箱，在邮箱设置里找到`POP3/SMTP/IMAP` 设置，并且完成客户端授权密码。如下图：\n![邮箱授权码](/images/pic/shouquanma.png)\n\n### 配置/etc/mail.rc文件\n在/etc/mail.rc文件末尾追加如下参数\n```\nset bsdcompat\nset from=test_wly@126.com\nset smtp=\"smtps://smtp.126.com:465\"\nset smtp-auth-user=test_wly@126.com\nset smtp-auth-password=73jdi9dw7j3gc8gf1xvak01fss\nset smtp-auth=login\nset ssl-verify=ignore\nset nss-config-dir=/root/.certs\n```\n\n### 测试邮件发送是否正常\n```\n[root@PLAY ~]# echo \"test mail\" | mail -s \"nagios report\" test_wly@126.com\n```\n>如果配置正确，此时test_wly@126.com就能收到刚刚发送的测试邮件了。\n\n看起来已经成功了，但是发送完邮件还有报错：证书不被信任，且命令行就此卡住，需要按键才能出现命令提示符\n`Error in certificate: Peer's certificate issuer is not recognized.` \n可以按如下操作即可解决问题：\n```\n[root@PLAY ~]# cd /root/.certs/\n[root@PLAY .certs]# certutil -A -n \"GeoTrust SSL CA - G3\" -t \"Pu,Pu,Pu\" -d ./ -i 126.crt \nNotice: Trust flag u is set automatically if the private key is present.\n```","slug":"aliyun-ecs-mail","published":1,"updated":"2019-05-28T02:02:23.500Z","_id":"cjw6jley00000p4n7rtkrzy0g","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h3 id=\"原由\"><a href=\"#原由\" class=\"headerlink\" title=\"原由\"></a>原由</h3><p>大家可能都知道在阿里云购买的ECS云主机是不能直接通过25号端口发邮件的，因为阿里云底层对25号端口做了屏蔽。所以例如我们需要做监控、报告等邮件通知行为时，只能修改默认的25号端口。<br>下面我们就开始如何用465端口来发送邮件。</p>\n<h3 id=\"请求数字证书\"><a href=\"#请求数字证书\" class=\"headerlink\" title=\"请求数字证书\"></a>请求数字证书</h3><ul>\n<li><p>创建目录，用来存放证书</p>\n<pre><code>[root@PLAY ~]# mkdir -p /root/.certs/\n[root@PLAY ~]# echo -n | openssl s_client -connect smtp.126.com:465 | sed -ne &apos;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&apos; &gt; ~/.certs/126.crt\ndepth=2 C = US, O = DigiCert Inc, OU = www.digicert.com, CN = DigiCert Global Root CA\nverify return:1\ndepth=1 C = US, O = DigiCert Inc, OU = www.digicert.com, CN = GeoTrust RSA CA 2018\nverify return:1\ndepth=0 C = CN, L = Hangzhou, O = &quot;NetEase (Hangzhou) Network Co., Ltd&quot;, OU = Mail Dept., CN = *.126.com\nverify return:1\nDONE\n</code></pre><blockquote>\n<p><code>smtp.126.com:465</code> 为发件者的邮件服务器，我这用的是网易<code>126.com</code> 邮箱。生成<code>126.crt</code> 的证书。</p>\n</blockquote>\n</li>\n<li><p>添加一个证书到证书数据库中</p>\n<pre><code>[root@PLAY ~]# certutil -A -n &quot;GeoTrust SSL CA&quot; -t &quot;C,,&quot; -d ~/.certs -i ~/.certs/126.crt\n[root@PLAY ~]# certutil -A -n &quot;GeoTrust Global CA&quot; -t &quot;C,,&quot; -d ~/.certs -i ~/.certs/126.crt\n</code></pre></li>\n<li><p>列出目录下证书</p>\n<pre><code>[root@PLAY ~]# certutil -L -d /root/.certs\nCertificate Nickname Trust Attributes\nSSL,S/MIME,JAR/XPI\nGeoTrust SSL CA C,,\n</code></pre><h3 id=\"获取126邮箱的授权码\"><a href=\"#获取126邮箱的授权码\" class=\"headerlink\" title=\"获取126邮箱的授权码\"></a>获取126邮箱的授权码</h3><p>前往邮箱的登陆网站登陆自己的邮箱，在邮箱设置里找到<code>POP3/SMTP/IMAP</code> 设置，并且完成客户端授权密码。如下图：<br><img src=\"/images/pic/shouquanma.png\" alt=\"邮箱授权码\"></p>\n</li>\n</ul>\n<h3 id=\"配置-etc-mail-rc文件\"><a href=\"#配置-etc-mail-rc文件\" class=\"headerlink\" title=\"配置/etc/mail.rc文件\"></a>配置/etc/mail.rc文件</h3><p>在/etc/mail.rc文件末尾追加如下参数<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"builtin-name\">set</span> bsdcompat</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">from</span>=test_wly@126.com</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">smtp</span>=<span class=\"string\">\"smtps://smtp.126.com:465\"</span></span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">smtp-auth-user</span>=test_wly@126.com</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">smtp-auth-password</span>=73jdi9dw7j3gc8gf1xvak01fss</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">smtp-auth</span>=login</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">ssl-verify</span>=ignore</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">nss-config-dir</span>=/root/.certs</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"测试邮件发送是否正常\"><a href=\"#测试邮件发送是否正常\" class=\"headerlink\" title=\"测试邮件发送是否正常\"></a>测试邮件发送是否正常</h3><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@PLAY</span> ~]<span class=\"meta\"># echo <span class=\"string\">\"test mail\"</span> | mail -s <span class=\"string\">\"nagios report\"</span> test_wly@126.com</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>如果配置正确，此时<a href=\"mailto:test_wly@126.com\" target=\"_blank\" rel=\"noopener\">test_wly@126.com</a>就能收到刚刚发送的测试邮件了。</p>\n</blockquote>\n<p>看起来已经成功了，但是发送完邮件还有报错：证书不被信任，且命令行就此卡住，需要按键才能出现命令提示符<br><code>Error in certificate: Peer&#39;s certificate issuer is not recognized.</code><br>可以按如下操作即可解决问题：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">root@PLAY ~</span>]<span class=\"meta\"># cd /root/.certs/</span></span><br><span class=\"line\">[<span class=\"meta\">root@PLAY .certs</span>]<span class=\"meta\"># certutil -A -n \"GeoTrust SSL CA - G3\" -t \"Pu,Pu,Pu\" -d ./ -i 126.crt </span></span><br><span class=\"line\">Notice: Trust flag u <span class=\"keyword\">is</span> <span class=\"keyword\">set</span> automatically <span class=\"keyword\">if</span> the <span class=\"keyword\">private</span> key <span class=\"keyword\">is</span> present.</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"length":1888,"excerpt":"","more":"<h3 id=\"原由\"><a href=\"#原由\" class=\"headerlink\" title=\"原由\"></a>原由</h3><p>大家可能都知道在阿里云购买的ECS云主机是不能直接通过25号端口发邮件的，因为阿里云底层对25号端口做了屏蔽。所以例如我们需要做监控、报告等邮件通知行为时，只能修改默认的25号端口。<br>下面我们就开始如何用465端口来发送邮件。</p>\n<h3 id=\"请求数字证书\"><a href=\"#请求数字证书\" class=\"headerlink\" title=\"请求数字证书\"></a>请求数字证书</h3><ul>\n<li><p>创建目录，用来存放证书</p>\n<pre><code>[root@PLAY ~]# mkdir -p /root/.certs/\n[root@PLAY ~]# echo -n | openssl s_client -connect smtp.126.com:465 | sed -ne &apos;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&apos; &gt; ~/.certs/126.crt\ndepth=2 C = US, O = DigiCert Inc, OU = www.digicert.com, CN = DigiCert Global Root CA\nverify return:1\ndepth=1 C = US, O = DigiCert Inc, OU = www.digicert.com, CN = GeoTrust RSA CA 2018\nverify return:1\ndepth=0 C = CN, L = Hangzhou, O = &quot;NetEase (Hangzhou) Network Co., Ltd&quot;, OU = Mail Dept., CN = *.126.com\nverify return:1\nDONE\n</code></pre><blockquote>\n<p><code>smtp.126.com:465</code> 为发件者的邮件服务器，我这用的是网易<code>126.com</code> 邮箱。生成<code>126.crt</code> 的证书。</p>\n</blockquote>\n</li>\n<li><p>添加一个证书到证书数据库中</p>\n<pre><code>[root@PLAY ~]# certutil -A -n &quot;GeoTrust SSL CA&quot; -t &quot;C,,&quot; -d ~/.certs -i ~/.certs/126.crt\n[root@PLAY ~]# certutil -A -n &quot;GeoTrust Global CA&quot; -t &quot;C,,&quot; -d ~/.certs -i ~/.certs/126.crt\n</code></pre></li>\n<li><p>列出目录下证书</p>\n<pre><code>[root@PLAY ~]# certutil -L -d /root/.certs\nCertificate Nickname Trust Attributes\nSSL,S/MIME,JAR/XPI\nGeoTrust SSL CA C,,\n</code></pre><h3 id=\"获取126邮箱的授权码\"><a href=\"#获取126邮箱的授权码\" class=\"headerlink\" title=\"获取126邮箱的授权码\"></a>获取126邮箱的授权码</h3><p>前往邮箱的登陆网站登陆自己的邮箱，在邮箱设置里找到<code>POP3/SMTP/IMAP</code> 设置，并且完成客户端授权密码。如下图：<br><img src=\"/images/pic/shouquanma.png\" alt=\"邮箱授权码\"></p>\n</li>\n</ul>\n<h3 id=\"配置-etc-mail-rc文件\"><a href=\"#配置-etc-mail-rc文件\" class=\"headerlink\" title=\"配置/etc/mail.rc文件\"></a>配置/etc/mail.rc文件</h3><p>在/etc/mail.rc文件末尾追加如下参数<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"builtin-name\">set</span> bsdcompat</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">from</span>=test_wly@126.com</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">smtp</span>=<span class=\"string\">\"smtps://smtp.126.com:465\"</span></span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">smtp-auth-user</span>=test_wly@126.com</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">smtp-auth-password</span>=73jdi9dw7j3gc8gf1xvak01fss</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">smtp-auth</span>=login</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">ssl-verify</span>=ignore</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">nss-config-dir</span>=/root/.certs</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"测试邮件发送是否正常\"><a href=\"#测试邮件发送是否正常\" class=\"headerlink\" title=\"测试邮件发送是否正常\"></a>测试邮件发送是否正常</h3><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@PLAY</span> ~]<span class=\"meta\"># echo <span class=\"string\">\"test mail\"</span> | mail -s <span class=\"string\">\"nagios report\"</span> test_wly@126.com</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>如果配置正确，此时<a href=\"mailto:test_wly@126.com\" target=\"_blank\" rel=\"noopener\">test_wly@126.com</a>就能收到刚刚发送的测试邮件了。</p>\n</blockquote>\n<p>看起来已经成功了，但是发送完邮件还有报错：证书不被信任，且命令行就此卡住，需要按键才能出现命令提示符<br><code>Error in certificate: Peer&#39;s certificate issuer is not recognized.</code><br>可以按如下操作即可解决问题：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">root@PLAY ~</span>]<span class=\"meta\"># cd /root/.certs/</span></span><br><span class=\"line\">[<span class=\"meta\">root@PLAY .certs</span>]<span class=\"meta\"># certutil -A -n \"GeoTrust SSL CA - G3\" -t \"Pu,Pu,Pu\" -d ./ -i 126.crt </span></span><br><span class=\"line\">Notice: Trust flag u <span class=\"keyword\">is</span> <span class=\"keyword\">set</span> automatically <span class=\"keyword\">if</span> the <span class=\"keyword\">private</span> key <span class=\"keyword\">is</span> present.</span><br></pre></td></tr></table></figure></p>\n"},{"layout":"post","title":"CentOS7 内核参数详解","author":"Pyker","img":"/images/bar/kernel.jpg","top":false,"cover":false,"date":"2017-11-21T15:47:00.000Z","_content":"### sysctl.conf 配置参数详解\n所谓Linux服务器内核参数优化，主要是指在Linux系统中针对业务服务应用而进行的系统内核参数调整，优化并无一定的标准。下面以生产环境下Linux常见的内核优化为例进行讲解，仅供参考。\n```\n$ cat /etc/sysctl.conf\n\n#打开的文件句柄的数量\nfs.file-max = 265535\n\n#关闭ipv6\nnet.ipv6.conf.all.disable_ipv6 = 1\nnet.ipv6.conf.default.disable_ipv6 = 1\n\n# 避免放大攻击\nnet.ipv4.icmp_echo_ignore_broadcasts = 1\n\n# 开启恶意icmp错误消息保护\nnet.ipv4.icmp_ignore_bogus_error_responses = 1\n\n#关闭路由转发\nnet.ipv4.ip_forward = 0\nnet.ipv4.conf.all.send_redirects = 0\nnet.ipv4.conf.default.send_redirects = 0\n\n#开启反向路径过滤\nnet.ipv4.conf.all.rp_filter = 1\nnet.ipv4.conf.default.rp_filter = 1\n\n#处理无源路由的包\nnet.ipv4.conf.all.accept_source_route = 0\nnet.ipv4.conf.default.accept_source_route = 0\n\n#关闭sysrq功能\nkernel.sysrq = 0\n\n#core文件名中添加pid作为扩展名\nkernel.core_uses_pid = 1\n\n# 开启SYN洪水攻击保护\nnet.ipv4.tcp_syncookies = 1\n\n#修改消息队列长度\nkernel.msgmnb = 65536\nkernel.msgmax = 65536\n\n#设置最大内存共享段大小bytes\nkernel.shmmax = 68719476736\nkernel.shmall = 4294967296\n\n#timewait的数量，默认180000\nnet.ipv4.tcp_max_tw_buckets = 6000\nnet.ipv4.tcp_sack = 1\nnet.ipv4.tcp_window_scaling = 1\nnet.ipv4.tcp_rmem = 4096        87380   4194304\nnet.ipv4.tcp_wmem = 4096        16384   4194304\nnet.core.wmem_default = 8388608\nnet.core.rmem_default = 8388608\nnet.core.rmem_max = 16777216\nnet.core.wmem_max = 16777216\n\n#每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目\nnet.core.netdev_max_backlog = 262144\n\n#限制仅仅是为了防止简单的DoS 攻击\nnet.ipv4.tcp_max_orphans = 3276800\n\n#未收到客户端确认信息的连接请求的最大值\nnet.ipv4.tcp_max_syn_backlog = 262144\nnet.ipv4.tcp_timestamps = 0\n\n#内核放弃建立连接之前发送SYNACK 包的数量\nnet.ipv4.tcp_synack_retries = 1\n\n#内核放弃建立连接之前发送SYN 包的数量\nnet.ipv4.tcp_syn_retries = 1\n\n#启用timewait 快速回收\nnet.ipv4.tcp_tw_recycle = 1\n\n#开启重用。允许将TIME-WAIT sockets 重新用于新的TCP 连接\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.tcp_mem = 94500000 915000000 927000000\nnet.ipv4.tcp_fin_timeout = 1\n\n#当keepalive 起用的时候，TCP 发送keepalive 消息的频度。缺省是2 小时\nnet.ipv4.tcp_keepalive_time = 30\n\n#允许系统打开的端口范围\nnet.ipv4.ip_local_port_range = 1024    65000\n\n#修改防火墙表大小，默认65536\nnet.netfilter.nf_conntrack_max=655350\nnet.netfilter.nf_conntrack_tcp_timeout_established=1200\n\n# 确保无人能修改路由表\nnet.ipv4.conf.all.accept_redirects = 0\nnet.ipv4.conf.default.accept_redirects = 0\nnet.ipv4.conf.all.secure_redirects = 0\nnet.ipv4.conf.default.secure_redirects = 0\n```\n>`net.ipv4.tcp_tw_recycle = 1` 启用TIME-WAIT状态sockets的快速回收，这个选项不推荐启用。在NAT(Network Address Translation)网络下，会导致大量的TCP连接建立错误。\n>\n>我们在一些高并发的 WebServer上，为了端口能够快速回收，常常会打开了 tcp_tw_reccycle 。在关闭 tcp_tw_reccycle 的时候，kernel 是不会检查对端机器的包的时间戳的；而打开了 tcp_tw_reccycle 了，就会检查时间戳，很不幸网络发来的包的时间戳是乱跳的，所以我方的就把带了“倒退”的时间戳的包当作是“recycle的tw连接的重传数据，不是新的请求”，于是丢掉不回包，造成大量丢包。\n\n\n>当运行`sysctl -p`命令时报error: 'net.ipv4.ip_conntrack_max' is an unknown key 错时,\n通过以下命令修正：\n$ modprobe ip_conntrack\n$ echo \"modprobe ip_conntrack\" >> /etc/rc.local\n\n\n### 一套生产环境使用过的内核参数\n* sysctl.conf文件\n\n```\nfs.file-max=65535\nnet.ipv4.ip_forward = 0\nnet.ipv4.conf.default.rp_filter = 1\nnet.ipv4.conf.default.accept_source_route = 0\n\nnet.ipv4.tcp_max_tw_buckets = 6000\nnet.ipv4.ip_local_port_range = 1024 65000\nnet.ipv4.tcp_timestamps = 1\nnet.ipv4.tcp_tw_recycle = 0\n\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.tcp_syncookies = 1\n\nkernel.msgmnb = 65536\nkernel.msgmax = 65536\nkernel.shmmax = 68719476736\nkernel.shmall = 4294967296\n\nnet.ipv4.tcp_max_syn_backlog = 262144\nnet.core.netdev_max_backlog = 262144\nnet.core.somaxconn = 262144\nnet.ipv4.tcp_max_orphans = 262144\n\nnet.ipv4.tcp_synack_retries = 1\nnet.ipv4.tcp_syn_retries = 1\nnet.ipv4.tcp_fin_timeout = 1\nnet.ipv4.tcp_keepalive_time = 30\n\nnet.ipv4.tcp_sack = 1\nnet.ipv4.tcp_window_scaling = 1\nnet.ipv4.tcp_rmem = 4096 87380 4194304\nnet.ipv4.tcp_wmem = 4096 16384 4194304\nnet.core.wmem_default = 8388608\nnet.core.rmem_default = 8388608\nnet.core.rmem_max = 16777216\nnet.core.wmem_max = 16777216\nnet.ipv4.tcp_mem = 94500000 915000000 927000000\nnet.nf_conntrack_max = 6553500\n#redis\nvm.dirty_ratio=10\nvm.dirty_background_ratio=5\n```\n\n* 禁用SELINUX\n\n```\n$ vi /etc/sysconfig/selinux  \n设置为disabled\n```\n* 同步时间\n\n```\n$ crontal -l\n*/20 * * * * /usr/sbin/ntpdate pool.ntp.org > /dev/null 2>&1\n```\n\n* 文件描述符数量修改`/etc/security/limits.conf`文件，在文件末尾添加\n\n```\nroot soft nofile 65535\nroot hard nofile 65535\n* soft nofile 65535\n* hard nofile 65535\n```\n还需要修改`/etc/security/limits.d`下面的conf文件(会覆盖前面的配置信息)，我的是20-nproc.conf\n```\n* soft nproc 65535\n* hard nproc 65535\n```\n\n* 禁用自带的Firewalld防火墙\n\n```\nsystemctl stop firewalld.service 停止firewall\nsystemctl display firewalld.service 禁止firewall开机自启动\n```","source":"_posts/centos-kernel-analysis.md","raw":"layout: post\ntitle: CentOS7 内核参数详解\nauthor: Pyker\ncategories: Linux\nimg: /images/bar/kernel.jpg\ntags:\n  - Linux\ntop: false\ncover: false\ndate: 2017-11-21 23:47:00\n---\n### sysctl.conf 配置参数详解\n所谓Linux服务器内核参数优化，主要是指在Linux系统中针对业务服务应用而进行的系统内核参数调整，优化并无一定的标准。下面以生产环境下Linux常见的内核优化为例进行讲解，仅供参考。\n```\n$ cat /etc/sysctl.conf\n\n#打开的文件句柄的数量\nfs.file-max = 265535\n\n#关闭ipv6\nnet.ipv6.conf.all.disable_ipv6 = 1\nnet.ipv6.conf.default.disable_ipv6 = 1\n\n# 避免放大攻击\nnet.ipv4.icmp_echo_ignore_broadcasts = 1\n\n# 开启恶意icmp错误消息保护\nnet.ipv4.icmp_ignore_bogus_error_responses = 1\n\n#关闭路由转发\nnet.ipv4.ip_forward = 0\nnet.ipv4.conf.all.send_redirects = 0\nnet.ipv4.conf.default.send_redirects = 0\n\n#开启反向路径过滤\nnet.ipv4.conf.all.rp_filter = 1\nnet.ipv4.conf.default.rp_filter = 1\n\n#处理无源路由的包\nnet.ipv4.conf.all.accept_source_route = 0\nnet.ipv4.conf.default.accept_source_route = 0\n\n#关闭sysrq功能\nkernel.sysrq = 0\n\n#core文件名中添加pid作为扩展名\nkernel.core_uses_pid = 1\n\n# 开启SYN洪水攻击保护\nnet.ipv4.tcp_syncookies = 1\n\n#修改消息队列长度\nkernel.msgmnb = 65536\nkernel.msgmax = 65536\n\n#设置最大内存共享段大小bytes\nkernel.shmmax = 68719476736\nkernel.shmall = 4294967296\n\n#timewait的数量，默认180000\nnet.ipv4.tcp_max_tw_buckets = 6000\nnet.ipv4.tcp_sack = 1\nnet.ipv4.tcp_window_scaling = 1\nnet.ipv4.tcp_rmem = 4096        87380   4194304\nnet.ipv4.tcp_wmem = 4096        16384   4194304\nnet.core.wmem_default = 8388608\nnet.core.rmem_default = 8388608\nnet.core.rmem_max = 16777216\nnet.core.wmem_max = 16777216\n\n#每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目\nnet.core.netdev_max_backlog = 262144\n\n#限制仅仅是为了防止简单的DoS 攻击\nnet.ipv4.tcp_max_orphans = 3276800\n\n#未收到客户端确认信息的连接请求的最大值\nnet.ipv4.tcp_max_syn_backlog = 262144\nnet.ipv4.tcp_timestamps = 0\n\n#内核放弃建立连接之前发送SYNACK 包的数量\nnet.ipv4.tcp_synack_retries = 1\n\n#内核放弃建立连接之前发送SYN 包的数量\nnet.ipv4.tcp_syn_retries = 1\n\n#启用timewait 快速回收\nnet.ipv4.tcp_tw_recycle = 1\n\n#开启重用。允许将TIME-WAIT sockets 重新用于新的TCP 连接\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.tcp_mem = 94500000 915000000 927000000\nnet.ipv4.tcp_fin_timeout = 1\n\n#当keepalive 起用的时候，TCP 发送keepalive 消息的频度。缺省是2 小时\nnet.ipv4.tcp_keepalive_time = 30\n\n#允许系统打开的端口范围\nnet.ipv4.ip_local_port_range = 1024    65000\n\n#修改防火墙表大小，默认65536\nnet.netfilter.nf_conntrack_max=655350\nnet.netfilter.nf_conntrack_tcp_timeout_established=1200\n\n# 确保无人能修改路由表\nnet.ipv4.conf.all.accept_redirects = 0\nnet.ipv4.conf.default.accept_redirects = 0\nnet.ipv4.conf.all.secure_redirects = 0\nnet.ipv4.conf.default.secure_redirects = 0\n```\n>`net.ipv4.tcp_tw_recycle = 1` 启用TIME-WAIT状态sockets的快速回收，这个选项不推荐启用。在NAT(Network Address Translation)网络下，会导致大量的TCP连接建立错误。\n>\n>我们在一些高并发的 WebServer上，为了端口能够快速回收，常常会打开了 tcp_tw_reccycle 。在关闭 tcp_tw_reccycle 的时候，kernel 是不会检查对端机器的包的时间戳的；而打开了 tcp_tw_reccycle 了，就会检查时间戳，很不幸网络发来的包的时间戳是乱跳的，所以我方的就把带了“倒退”的时间戳的包当作是“recycle的tw连接的重传数据，不是新的请求”，于是丢掉不回包，造成大量丢包。\n\n\n>当运行`sysctl -p`命令时报error: 'net.ipv4.ip_conntrack_max' is an unknown key 错时,\n通过以下命令修正：\n$ modprobe ip_conntrack\n$ echo \"modprobe ip_conntrack\" >> /etc/rc.local\n\n\n### 一套生产环境使用过的内核参数\n* sysctl.conf文件\n\n```\nfs.file-max=65535\nnet.ipv4.ip_forward = 0\nnet.ipv4.conf.default.rp_filter = 1\nnet.ipv4.conf.default.accept_source_route = 0\n\nnet.ipv4.tcp_max_tw_buckets = 6000\nnet.ipv4.ip_local_port_range = 1024 65000\nnet.ipv4.tcp_timestamps = 1\nnet.ipv4.tcp_tw_recycle = 0\n\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.tcp_syncookies = 1\n\nkernel.msgmnb = 65536\nkernel.msgmax = 65536\nkernel.shmmax = 68719476736\nkernel.shmall = 4294967296\n\nnet.ipv4.tcp_max_syn_backlog = 262144\nnet.core.netdev_max_backlog = 262144\nnet.core.somaxconn = 262144\nnet.ipv4.tcp_max_orphans = 262144\n\nnet.ipv4.tcp_synack_retries = 1\nnet.ipv4.tcp_syn_retries = 1\nnet.ipv4.tcp_fin_timeout = 1\nnet.ipv4.tcp_keepalive_time = 30\n\nnet.ipv4.tcp_sack = 1\nnet.ipv4.tcp_window_scaling = 1\nnet.ipv4.tcp_rmem = 4096 87380 4194304\nnet.ipv4.tcp_wmem = 4096 16384 4194304\nnet.core.wmem_default = 8388608\nnet.core.rmem_default = 8388608\nnet.core.rmem_max = 16777216\nnet.core.wmem_max = 16777216\nnet.ipv4.tcp_mem = 94500000 915000000 927000000\nnet.nf_conntrack_max = 6553500\n#redis\nvm.dirty_ratio=10\nvm.dirty_background_ratio=5\n```\n\n* 禁用SELINUX\n\n```\n$ vi /etc/sysconfig/selinux  \n设置为disabled\n```\n* 同步时间\n\n```\n$ crontal -l\n*/20 * * * * /usr/sbin/ntpdate pool.ntp.org > /dev/null 2>&1\n```\n\n* 文件描述符数量修改`/etc/security/limits.conf`文件，在文件末尾添加\n\n```\nroot soft nofile 65535\nroot hard nofile 65535\n* soft nofile 65535\n* hard nofile 65535\n```\n还需要修改`/etc/security/limits.d`下面的conf文件(会覆盖前面的配置信息)，我的是20-nproc.conf\n```\n* soft nproc 65535\n* hard nproc 65535\n```\n\n* 禁用自带的Firewalld防火墙\n\n```\nsystemctl stop firewalld.service 停止firewall\nsystemctl display firewalld.service 禁止firewall开机自启动\n```","slug":"centos-kernel-analysis","published":1,"updated":"2019-05-28T02:02:23.502Z","_id":"cjw6jley60002p4n7xpj2w6m8","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h3 id=\"sysctl-conf-配置参数详解\"><a href=\"#sysctl-conf-配置参数详解\" class=\"headerlink\" title=\"sysctl.conf 配置参数详解\"></a>sysctl.conf 配置参数详解</h3><p>所谓Linux服务器内核参数优化，主要是指在Linux系统中针对业务服务应用而进行的系统内核参数调整，优化并无一定的标准。下面以生产环境下Linux常见的内核优化为例进行讲解，仅供参考。<br><figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/sysctl.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#打开的文件句柄的数量</span></span><br><span class=\"line\">fs.<span class=\"attr\">file-max</span> = <span class=\"number\">265535</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#关闭ipv6</span></span><br><span class=\"line\">net.ipv6.conf.all.<span class=\"attr\">disable_ipv6</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net.ipv6.conf.default.<span class=\"attr\">disable_ipv6</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 避免放大攻击</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">icmp_echo_ignore_broadcasts</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开启恶意icmp错误消息保护</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">icmp_ignore_bogus_error_responses</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#关闭路由转发</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">ip_forward</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.all.<span class=\"attr\">send_redirects</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.default.<span class=\"attr\">send_redirects</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#开启反向路径过滤</span></span><br><span class=\"line\">net.ipv4.conf.all.<span class=\"attr\">rp_filter</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net.ipv4.conf.default.<span class=\"attr\">rp_filter</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#处理无源路由的包</span></span><br><span class=\"line\">net.ipv4.conf.all.<span class=\"attr\">accept_source_route</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.default.<span class=\"attr\">accept_source_route</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#关闭sysrq功能</span></span><br><span class=\"line\">kernel.<span class=\"attr\">sysrq</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#core文件名中添加pid作为扩展名</span></span><br><span class=\"line\">kernel.<span class=\"attr\">core_uses_pid</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开启SYN洪水攻击保护</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_syncookies</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改消息队列长度</span></span><br><span class=\"line\">kernel.<span class=\"attr\">msgmnb</span> = <span class=\"number\">65536</span></span><br><span class=\"line\">kernel.<span class=\"attr\">msgmax</span> = <span class=\"number\">65536</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#设置最大内存共享段大小bytes</span></span><br><span class=\"line\">kernel.<span class=\"attr\">shmmax</span> = <span class=\"number\">68719476736</span></span><br><span class=\"line\">kernel.<span class=\"attr\">shmall</span> = <span class=\"number\">4294967296</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#timewait的数量，默认180000</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_max_tw_buckets</span> = <span class=\"number\">6000</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_sack</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_window_scaling</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_rmem</span> = <span class=\"number\">4096</span>        <span class=\"number\">87380</span>   <span class=\"number\">4194304</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_wmem</span> = <span class=\"number\">4096</span>        <span class=\"number\">16384</span>   <span class=\"number\">4194304</span></span><br><span class=\"line\">net.core.<span class=\"attr\">wmem_default</span> = <span class=\"number\">8388608</span></span><br><span class=\"line\">net.core.<span class=\"attr\">rmem_default</span> = <span class=\"number\">8388608</span></span><br><span class=\"line\">net.core.<span class=\"attr\">rmem_max</span> = <span class=\"number\">16777216</span></span><br><span class=\"line\">net.core.<span class=\"attr\">wmem_max</span> = <span class=\"number\">16777216</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目</span></span><br><span class=\"line\">net.core.<span class=\"attr\">netdev_max_backlog</span> = <span class=\"number\">262144</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#限制仅仅是为了防止简单的DoS 攻击</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_max_orphans</span> = <span class=\"number\">3276800</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#未收到客户端确认信息的连接请求的最大值</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_max_syn_backlog</span> = <span class=\"number\">262144</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_timestamps</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#内核放弃建立连接之前发送SYNACK 包的数量</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_synack_retries</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#内核放弃建立连接之前发送SYN 包的数量</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_syn_retries</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启用timewait 快速回收</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_tw_recycle</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#开启重用。允许将TIME-WAIT sockets 重新用于新的TCP 连接</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_tw_reuse</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_mem</span> = <span class=\"number\">94500000</span> <span class=\"number\">915000000</span> <span class=\"number\">927000000</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_fin_timeout</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#当keepalive 起用的时候，TCP 发送keepalive 消息的频度。缺省是2 小时</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_keepalive_time</span> = <span class=\"number\">30</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#允许系统打开的端口范围</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">ip_local_port_range</span> = <span class=\"number\">1024</span>    <span class=\"number\">65000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改防火墙表大小，默认65536</span></span><br><span class=\"line\">net.netfilter.<span class=\"attr\">nf_conntrack_max=655350</span></span><br><span class=\"line\">net.netfilter.<span class=\"attr\">nf_conntrack_tcp_timeout_established=1200</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 确保无人能修改路由表</span></span><br><span class=\"line\">net.ipv4.conf.all.<span class=\"attr\">accept_redirects</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.default.<span class=\"attr\">accept_redirects</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.all.<span class=\"attr\">secure_redirects</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.default.<span class=\"attr\">secure_redirects</span> = <span class=\"number\">0</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p><code>net.ipv4.tcp_tw_recycle = 1</code> 启用TIME-WAIT状态sockets的快速回收，这个选项不推荐启用。在NAT(Network Address Translation)网络下，会导致大量的TCP连接建立错误。</p>\n<p>我们在一些高并发的 WebServer上，为了端口能够快速回收，常常会打开了 tcp_tw_reccycle 。在关闭 tcp_tw_reccycle 的时候，kernel 是不会检查对端机器的包的时间戳的；而打开了 tcp_tw_reccycle 了，就会检查时间戳，很不幸网络发来的包的时间戳是乱跳的，所以我方的就把带了“倒退”的时间戳的包当作是“recycle的tw连接的重传数据，不是新的请求”，于是丢掉不回包，造成大量丢包。</p>\n</blockquote>\n<blockquote>\n<p>当运行<code>sysctl -p</code>命令时报error: ‘net.ipv4.ip_conntrack_max’ is an unknown key 错时,<br>通过以下命令修正：<br>$ modprobe ip_conntrack<br>$ echo “modprobe ip_conntrack” &gt;&gt; /etc/rc.local</p>\n</blockquote>\n<h3 id=\"一套生产环境使用过的内核参数\"><a href=\"#一套生产环境使用过的内核参数\" class=\"headerlink\" title=\"一套生产环境使用过的内核参数\"></a>一套生产环境使用过的内核参数</h3><ul>\n<li>sysctl.conf文件</li>\n</ul>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fs.file-max=<span class=\"number\">65535</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.ip_forward</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.default</span><span class=\"selector-class\">.rp_filter</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.default</span><span class=\"selector-class\">.accept_source_route</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_max_tw_buckets</span> = <span class=\"number\">6000</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.ip_local_port_range</span> = <span class=\"number\">1024</span> <span class=\"number\">65000</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_timestamps</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_tw_recycle</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_tw_reuse</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_syncookies</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">kernel<span class=\"selector-class\">.msgmnb</span> = <span class=\"number\">65536</span></span><br><span class=\"line\">kernel<span class=\"selector-class\">.msgmax</span> = <span class=\"number\">65536</span></span><br><span class=\"line\">kernel<span class=\"selector-class\">.shmmax</span> = <span class=\"number\">68719476736</span></span><br><span class=\"line\">kernel<span class=\"selector-class\">.shmall</span> = <span class=\"number\">4294967296</span></span><br><span class=\"line\"></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_max_syn_backlog</span> = <span class=\"number\">262144</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.netdev_max_backlog</span> = <span class=\"number\">262144</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.somaxconn</span> = <span class=\"number\">262144</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_max_orphans</span> = <span class=\"number\">262144</span></span><br><span class=\"line\"></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_synack_retries</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_syn_retries</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_fin_timeout</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_keepalive_time</span> = <span class=\"number\">30</span></span><br><span class=\"line\"></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_sack</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_window_scaling</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_rmem</span> = <span class=\"number\">4096</span> <span class=\"number\">87380</span> <span class=\"number\">4194304</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_wmem</span> = <span class=\"number\">4096</span> <span class=\"number\">16384</span> <span class=\"number\">4194304</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.wmem_default</span> = <span class=\"number\">8388608</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.rmem_default</span> = <span class=\"number\">8388608</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.rmem_max</span> = <span class=\"number\">16777216</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.wmem_max</span> = <span class=\"number\">16777216</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_mem</span> = <span class=\"number\">94500000</span> <span class=\"number\">915000000</span> <span class=\"number\">927000000</span></span><br><span class=\"line\">net<span class=\"selector-class\">.nf_conntrack_max</span> = <span class=\"number\">6553500</span></span><br><span class=\"line\">#redis</span><br><span class=\"line\">vm.dirty_ratio=<span class=\"number\">10</span></span><br><span class=\"line\">vm.dirty_background_ratio=<span class=\"number\">5</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>禁用SELINUX</li>\n</ul>\n<figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vi /etc/sysconfig/<span class=\"keyword\">selinux </span> </span><br><span class=\"line\">设置为disabled</span><br></pre></td></tr></table></figure>\n<ul>\n<li>同步时间</li>\n</ul>\n<figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ </span>crontal -l</span><br><span class=\"line\">*<span class=\"regexp\">/20 * * * * /usr</span><span class=\"regexp\">/sbin/ntpdate</span> pool.ntp.org &gt; <span class=\"regexp\">/dev/null</span> <span class=\"number\">2</span>&gt;&amp;<span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>文件描述符数量修改<code>/etc/security/limits.conf</code>文件，在文件末尾添加</li>\n</ul>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root soft nofile <span class=\"number\">65535</span></span><br><span class=\"line\">root hard nofile <span class=\"number\">65535</span></span><br><span class=\"line\">* soft nofile <span class=\"number\">65535</span></span><br><span class=\"line\">* hard nofile <span class=\"number\">65535</span></span><br></pre></td></tr></table></figure>\n<p>还需要修改<code>/etc/security/limits.d</code>下面的conf文件(会覆盖前面的配置信息)，我的是20-nproc.conf<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">* </span>soft nproc 65535</span><br><span class=\"line\"><span class=\"bullet\">* </span>hard nproc 65535</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>禁用自带的Firewalld防火墙</li>\n</ul>\n<figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"built_in\">stop</span> firewalld.service 停止firewall</span><br><span class=\"line\">systemctl <span class=\"built_in\">display</span> firewalld.service 禁止firewall开机自启动</span><br></pre></td></tr></table></figure>","site":{"data":{}},"length":4137,"excerpt":"","more":"<h3 id=\"sysctl-conf-配置参数详解\"><a href=\"#sysctl-conf-配置参数详解\" class=\"headerlink\" title=\"sysctl.conf 配置参数详解\"></a>sysctl.conf 配置参数详解</h3><p>所谓Linux服务器内核参数优化，主要是指在Linux系统中针对业务服务应用而进行的系统内核参数调整，优化并无一定的标准。下面以生产环境下Linux常见的内核优化为例进行讲解，仅供参考。<br><figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/sysctl.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#打开的文件句柄的数量</span></span><br><span class=\"line\">fs.<span class=\"attr\">file-max</span> = <span class=\"number\">265535</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#关闭ipv6</span></span><br><span class=\"line\">net.ipv6.conf.all.<span class=\"attr\">disable_ipv6</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net.ipv6.conf.default.<span class=\"attr\">disable_ipv6</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 避免放大攻击</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">icmp_echo_ignore_broadcasts</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开启恶意icmp错误消息保护</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">icmp_ignore_bogus_error_responses</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#关闭路由转发</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">ip_forward</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.all.<span class=\"attr\">send_redirects</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.default.<span class=\"attr\">send_redirects</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#开启反向路径过滤</span></span><br><span class=\"line\">net.ipv4.conf.all.<span class=\"attr\">rp_filter</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net.ipv4.conf.default.<span class=\"attr\">rp_filter</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#处理无源路由的包</span></span><br><span class=\"line\">net.ipv4.conf.all.<span class=\"attr\">accept_source_route</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.default.<span class=\"attr\">accept_source_route</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#关闭sysrq功能</span></span><br><span class=\"line\">kernel.<span class=\"attr\">sysrq</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#core文件名中添加pid作为扩展名</span></span><br><span class=\"line\">kernel.<span class=\"attr\">core_uses_pid</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开启SYN洪水攻击保护</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_syncookies</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改消息队列长度</span></span><br><span class=\"line\">kernel.<span class=\"attr\">msgmnb</span> = <span class=\"number\">65536</span></span><br><span class=\"line\">kernel.<span class=\"attr\">msgmax</span> = <span class=\"number\">65536</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#设置最大内存共享段大小bytes</span></span><br><span class=\"line\">kernel.<span class=\"attr\">shmmax</span> = <span class=\"number\">68719476736</span></span><br><span class=\"line\">kernel.<span class=\"attr\">shmall</span> = <span class=\"number\">4294967296</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#timewait的数量，默认180000</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_max_tw_buckets</span> = <span class=\"number\">6000</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_sack</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_window_scaling</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_rmem</span> = <span class=\"number\">4096</span>        <span class=\"number\">87380</span>   <span class=\"number\">4194304</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_wmem</span> = <span class=\"number\">4096</span>        <span class=\"number\">16384</span>   <span class=\"number\">4194304</span></span><br><span class=\"line\">net.core.<span class=\"attr\">wmem_default</span> = <span class=\"number\">8388608</span></span><br><span class=\"line\">net.core.<span class=\"attr\">rmem_default</span> = <span class=\"number\">8388608</span></span><br><span class=\"line\">net.core.<span class=\"attr\">rmem_max</span> = <span class=\"number\">16777216</span></span><br><span class=\"line\">net.core.<span class=\"attr\">wmem_max</span> = <span class=\"number\">16777216</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目</span></span><br><span class=\"line\">net.core.<span class=\"attr\">netdev_max_backlog</span> = <span class=\"number\">262144</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#限制仅仅是为了防止简单的DoS 攻击</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_max_orphans</span> = <span class=\"number\">3276800</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#未收到客户端确认信息的连接请求的最大值</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_max_syn_backlog</span> = <span class=\"number\">262144</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_timestamps</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#内核放弃建立连接之前发送SYNACK 包的数量</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_synack_retries</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#内核放弃建立连接之前发送SYN 包的数量</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_syn_retries</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启用timewait 快速回收</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_tw_recycle</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#开启重用。允许将TIME-WAIT sockets 重新用于新的TCP 连接</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_tw_reuse</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_mem</span> = <span class=\"number\">94500000</span> <span class=\"number\">915000000</span> <span class=\"number\">927000000</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_fin_timeout</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#当keepalive 起用的时候，TCP 发送keepalive 消息的频度。缺省是2 小时</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">tcp_keepalive_time</span> = <span class=\"number\">30</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#允许系统打开的端口范围</span></span><br><span class=\"line\">net.ipv4.<span class=\"attr\">ip_local_port_range</span> = <span class=\"number\">1024</span>    <span class=\"number\">65000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改防火墙表大小，默认65536</span></span><br><span class=\"line\">net.netfilter.<span class=\"attr\">nf_conntrack_max=655350</span></span><br><span class=\"line\">net.netfilter.<span class=\"attr\">nf_conntrack_tcp_timeout_established=1200</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 确保无人能修改路由表</span></span><br><span class=\"line\">net.ipv4.conf.all.<span class=\"attr\">accept_redirects</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.default.<span class=\"attr\">accept_redirects</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.all.<span class=\"attr\">secure_redirects</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net.ipv4.conf.default.<span class=\"attr\">secure_redirects</span> = <span class=\"number\">0</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p><code>net.ipv4.tcp_tw_recycle = 1</code> 启用TIME-WAIT状态sockets的快速回收，这个选项不推荐启用。在NAT(Network Address Translation)网络下，会导致大量的TCP连接建立错误。</p>\n<p>我们在一些高并发的 WebServer上，为了端口能够快速回收，常常会打开了 tcp_tw_reccycle 。在关闭 tcp_tw_reccycle 的时候，kernel 是不会检查对端机器的包的时间戳的；而打开了 tcp_tw_reccycle 了，就会检查时间戳，很不幸网络发来的包的时间戳是乱跳的，所以我方的就把带了“倒退”的时间戳的包当作是“recycle的tw连接的重传数据，不是新的请求”，于是丢掉不回包，造成大量丢包。</p>\n</blockquote>\n<blockquote>\n<p>当运行<code>sysctl -p</code>命令时报error: ‘net.ipv4.ip_conntrack_max’ is an unknown key 错时,<br>通过以下命令修正：<br>$ modprobe ip_conntrack<br>$ echo “modprobe ip_conntrack” &gt;&gt; /etc/rc.local</p>\n</blockquote>\n<h3 id=\"一套生产环境使用过的内核参数\"><a href=\"#一套生产环境使用过的内核参数\" class=\"headerlink\" title=\"一套生产环境使用过的内核参数\"></a>一套生产环境使用过的内核参数</h3><ul>\n<li>sysctl.conf文件</li>\n</ul>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fs.file-max=<span class=\"number\">65535</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.ip_forward</span> = <span class=\"number\">0</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.default</span><span class=\"selector-class\">.rp_filter</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.default</span><span class=\"selector-class\">.accept_source_route</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_max_tw_buckets</span> = <span class=\"number\">6000</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.ip_local_port_range</span> = <span class=\"number\">1024</span> <span class=\"number\">65000</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_timestamps</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_tw_recycle</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_tw_reuse</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_syncookies</span> = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">kernel<span class=\"selector-class\">.msgmnb</span> = <span class=\"number\">65536</span></span><br><span class=\"line\">kernel<span class=\"selector-class\">.msgmax</span> = <span class=\"number\">65536</span></span><br><span class=\"line\">kernel<span class=\"selector-class\">.shmmax</span> = <span class=\"number\">68719476736</span></span><br><span class=\"line\">kernel<span class=\"selector-class\">.shmall</span> = <span class=\"number\">4294967296</span></span><br><span class=\"line\"></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_max_syn_backlog</span> = <span class=\"number\">262144</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.netdev_max_backlog</span> = <span class=\"number\">262144</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.somaxconn</span> = <span class=\"number\">262144</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_max_orphans</span> = <span class=\"number\">262144</span></span><br><span class=\"line\"></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_synack_retries</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_syn_retries</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_fin_timeout</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_keepalive_time</span> = <span class=\"number\">30</span></span><br><span class=\"line\"></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_sack</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_window_scaling</span> = <span class=\"number\">1</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_rmem</span> = <span class=\"number\">4096</span> <span class=\"number\">87380</span> <span class=\"number\">4194304</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_wmem</span> = <span class=\"number\">4096</span> <span class=\"number\">16384</span> <span class=\"number\">4194304</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.wmem_default</span> = <span class=\"number\">8388608</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.rmem_default</span> = <span class=\"number\">8388608</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.rmem_max</span> = <span class=\"number\">16777216</span></span><br><span class=\"line\">net<span class=\"selector-class\">.core</span><span class=\"selector-class\">.wmem_max</span> = <span class=\"number\">16777216</span></span><br><span class=\"line\">net<span class=\"selector-class\">.ipv4</span><span class=\"selector-class\">.tcp_mem</span> = <span class=\"number\">94500000</span> <span class=\"number\">915000000</span> <span class=\"number\">927000000</span></span><br><span class=\"line\">net<span class=\"selector-class\">.nf_conntrack_max</span> = <span class=\"number\">6553500</span></span><br><span class=\"line\">#redis</span><br><span class=\"line\">vm.dirty_ratio=<span class=\"number\">10</span></span><br><span class=\"line\">vm.dirty_background_ratio=<span class=\"number\">5</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>禁用SELINUX</li>\n</ul>\n<figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vi /etc/sysconfig/<span class=\"keyword\">selinux </span> </span><br><span class=\"line\">设置为disabled</span><br></pre></td></tr></table></figure>\n<ul>\n<li>同步时间</li>\n</ul>\n<figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ </span>crontal -l</span><br><span class=\"line\">*<span class=\"regexp\">/20 * * * * /usr</span><span class=\"regexp\">/sbin/ntpdate</span> pool.ntp.org &gt; <span class=\"regexp\">/dev/null</span> <span class=\"number\">2</span>&gt;&amp;<span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>文件描述符数量修改<code>/etc/security/limits.conf</code>文件，在文件末尾添加</li>\n</ul>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root soft nofile <span class=\"number\">65535</span></span><br><span class=\"line\">root hard nofile <span class=\"number\">65535</span></span><br><span class=\"line\">* soft nofile <span class=\"number\">65535</span></span><br><span class=\"line\">* hard nofile <span class=\"number\">65535</span></span><br></pre></td></tr></table></figure>\n<p>还需要修改<code>/etc/security/limits.d</code>下面的conf文件(会覆盖前面的配置信息)，我的是20-nproc.conf<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">* </span>soft nproc 65535</span><br><span class=\"line\"><span class=\"bullet\">* </span>hard nproc 65535</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>禁用自带的Firewalld防火墙</li>\n</ul>\n<figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"built_in\">stop</span> firewalld.service 停止firewall</span><br><span class=\"line\">systemctl <span class=\"built_in\">display</span> firewalld.service 禁止firewall开机自启动</span><br></pre></td></tr></table></figure>"},{"title":"Hexo博客Next7.X版本主题配置","author":"Pyker","date":"2019-05-01T05:30:00.000Z","_content":"## 前言\n>Hexo安装过后，默认的主题是landscape，如果不喜欢，我们也可以进行更换。本文主要讲解NexT主题的使用。\n\n## Hexo主题相关网址\n[hexo官网](https://hexo.io/)\n[nexT7.x](https://github.com/theme-next/hexo-theme-next)\n\n## 目录\n我们主要对next主题进行了如下配置操作，该配置后的next主题获取地址：https://github.com/ipyker/ipyker.github.io/tree/hexo\n{% note danger %}\n* 设置中文语言\n* 设置博主文字描述\n* 设置博客文章连接为year/month/day/title.html格式\n* Menu增加关于、标签、分类、互动、搜索菜单\n* 禁用关于、标签、分类菜单评论功能\n* 添加添加RSS\n* 设置背景图片。默认禁用，可以在themes/nexT/source/css/_custom/custon.styl文件中启用\n* 设置Canvas_nest动态背景\n* 图片快速加载设置\n* 微信支付宝打赏功能\n* 点击出现桃心效果\n* 主页文章添加阴影效果\n* 设置代码高亮\n* 顶栏背景色\n* 底栏背景色\n* 在右上角实现红色的fork me on github。默认禁用，可以在themes/nexT/_config.yml文件github_banner键中启用\n* 添加添加RSS\n* 修改文章内链接文本样式\n* 修改文章底部标签样式\n* 在文章末尾添加“文章结束”标记\n* 设置头像\n* 网站底部加上访问量\n* 网站底部字数统计\n* 网站底部添加网站运行时间\n* 网站底部添加动态桃心\n* 网站底部添加备案信息\n* 底部隐藏由Hexo强力驱动、主题--NexT.Mist\n* 设置网站的图标Favicon\n* 实现文章文字统计功能和阅读时长\n* 添加来必力云跟帖功能。（需要自己注册获取ID）\n* 去掉底部重复字数统计\n* 修改字体大小\n* 添加DaoVoice在线联系。（需要自己注册获取ID）\n* 侧边栏社交小图标设置\n* 添加侧栏推荐阅读\n* 修改侧边栏背景图片\n* 修改侧边栏文字颜色\n* 在文章底部增加版权信息\n* Hexo博客添加站内搜索\n* 修改选中字符的颜色\n* 添加aplay音乐播放\n* 添加博客右下角卡通动漫{% endnote %}","source":"_posts/hexo-next.md","raw":"title: Hexo博客Next7.X版本主题配置\nauthor: Pyker\ncategories: hexo\ntags:\n  - hexo\ndate: 2019-05-01 13:30:00\n---\n## 前言\n>Hexo安装过后，默认的主题是landscape，如果不喜欢，我们也可以进行更换。本文主要讲解NexT主题的使用。\n\n## Hexo主题相关网址\n[hexo官网](https://hexo.io/)\n[nexT7.x](https://github.com/theme-next/hexo-theme-next)\n\n## 目录\n我们主要对next主题进行了如下配置操作，该配置后的next主题获取地址：https://github.com/ipyker/ipyker.github.io/tree/hexo\n{% note danger %}\n* 设置中文语言\n* 设置博主文字描述\n* 设置博客文章连接为year/month/day/title.html格式\n* Menu增加关于、标签、分类、互动、搜索菜单\n* 禁用关于、标签、分类菜单评论功能\n* 添加添加RSS\n* 设置背景图片。默认禁用，可以在themes/nexT/source/css/_custom/custon.styl文件中启用\n* 设置Canvas_nest动态背景\n* 图片快速加载设置\n* 微信支付宝打赏功能\n* 点击出现桃心效果\n* 主页文章添加阴影效果\n* 设置代码高亮\n* 顶栏背景色\n* 底栏背景色\n* 在右上角实现红色的fork me on github。默认禁用，可以在themes/nexT/_config.yml文件github_banner键中启用\n* 添加添加RSS\n* 修改文章内链接文本样式\n* 修改文章底部标签样式\n* 在文章末尾添加“文章结束”标记\n* 设置头像\n* 网站底部加上访问量\n* 网站底部字数统计\n* 网站底部添加网站运行时间\n* 网站底部添加动态桃心\n* 网站底部添加备案信息\n* 底部隐藏由Hexo强力驱动、主题--NexT.Mist\n* 设置网站的图标Favicon\n* 实现文章文字统计功能和阅读时长\n* 添加来必力云跟帖功能。（需要自己注册获取ID）\n* 去掉底部重复字数统计\n* 修改字体大小\n* 添加DaoVoice在线联系。（需要自己注册获取ID）\n* 侧边栏社交小图标设置\n* 添加侧栏推荐阅读\n* 修改侧边栏背景图片\n* 修改侧边栏文字颜色\n* 在文章底部增加版权信息\n* Hexo博客添加站内搜索\n* 修改选中字符的颜色\n* 添加aplay音乐播放\n* 添加博客右下角卡通动漫{% endnote %}","slug":"hexo-next","published":1,"updated":"2019-05-26T07:30:30.604Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw6jleye0006p4n7qla5itt2","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><blockquote>\n<p>Hexo安装过后，默认的主题是landscape，如果不喜欢，我们也可以进行更换。本文主要讲解NexT主题的使用。</p>\n</blockquote>\n<h2 id=\"Hexo主题相关网址\"><a href=\"#Hexo主题相关网址\" class=\"headerlink\" title=\"Hexo主题相关网址\"></a>Hexo主题相关网址</h2><p><a href=\"https://hexo.io/\" target=\"_blank\" rel=\"noopener\">hexo官网</a><br><a href=\"https://github.com/theme-next/hexo-theme-next\" target=\"_blank\" rel=\"noopener\">nexT7.x</a></p>\n<h2 id=\"目录\"><a href=\"#目录\" class=\"headerlink\" title=\"目录\"></a>目录</h2><p>我们主要对next主题进行了如下配置操作，该配置后的next主题获取地址：<a href=\"https://github.com/ipyker/ipyker.github.io/tree/hexo\" target=\"_blank\" rel=\"noopener\">https://github.com/ipyker/ipyker.github.io/tree/hexo</a><br><div class=\"note danger\">\n            <ul><li>设置中文语言</li><li>设置博主文字描述</li><li>设置博客文章连接为year/month/day/title.html格式</li><li>Menu增加关于、标签、分类、互动、搜索菜单</li><li>禁用关于、标签、分类菜单评论功能</li><li>添加添加RSS</li><li>设置背景图片。默认禁用，可以在themes/nexT/source/css/_custom/custon.styl文件中启用</li><li>设置Canvas_nest动态背景</li><li>图片快速加载设置</li><li>微信支付宝打赏功能</li><li>点击出现桃心效果</li><li>主页文章添加阴影效果</li><li>设置代码高亮</li><li>顶栏背景色</li><li>底栏背景色</li><li>在右上角实现红色的fork me on github。默认禁用，可以在themes/nexT/_config.yml文件github_banner键中启用</li><li>添加添加RSS</li><li>修改文章内链接文本样式</li><li>修改文章底部标签样式</li><li>在文章末尾添加“文章结束”标记</li><li>设置头像</li><li>网站底部加上访问量</li><li>网站底部字数统计</li><li>网站底部添加网站运行时间</li><li>网站底部添加动态桃心</li><li>网站底部添加备案信息</li><li>底部隐藏由Hexo强力驱动、主题–NexT.Mist</li><li>设置网站的图标Favicon</li><li>实现文章文字统计功能和阅读时长</li><li>添加来必力云跟帖功能。（需要自己注册获取ID）</li><li>去掉底部重复字数统计</li><li>修改字体大小</li><li>添加DaoVoice在线联系。（需要自己注册获取ID）</li><li>侧边栏社交小图标设置</li><li>添加侧栏推荐阅读</li><li>修改侧边栏背景图片</li><li>修改侧边栏文字颜色</li><li>在文章底部增加版权信息</li><li>Hexo博客添加站内搜索</li><li>修改选中字符的颜色</li><li>添加aplay音乐播放</li><li>添加博客右下角卡通动漫</li></ul>\n          </div></p>\n","site":{"data":{}},"length":811,"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><blockquote>\n<p>Hexo安装过后，默认的主题是landscape，如果不喜欢，我们也可以进行更换。本文主要讲解NexT主题的使用。</p>\n</blockquote>\n<h2 id=\"Hexo主题相关网址\"><a href=\"#Hexo主题相关网址\" class=\"headerlink\" title=\"Hexo主题相关网址\"></a>Hexo主题相关网址</h2><p><a href=\"https://hexo.io/\" target=\"_blank\" rel=\"noopener\">hexo官网</a><br><a href=\"https://github.com/theme-next/hexo-theme-next\" target=\"_blank\" rel=\"noopener\">nexT7.x</a></p>\n<h2 id=\"目录\"><a href=\"#目录\" class=\"headerlink\" title=\"目录\"></a>目录</h2><p>我们主要对next主题进行了如下配置操作，该配置后的next主题获取地址：<a href=\"https://github.com/ipyker/ipyker.github.io/tree/hexo\" target=\"_blank\" rel=\"noopener\">https://github.com/ipyker/ipyker.github.io/tree/hexo</a><br><div class=\"note danger\">\n            <ul><li>设置中文语言</li><li>设置博主文字描述</li><li>设置博客文章连接为year/month/day/title.html格式</li><li>Menu增加关于、标签、分类、互动、搜索菜单</li><li>禁用关于、标签、分类菜单评论功能</li><li>添加添加RSS</li><li>设置背景图片。默认禁用，可以在themes/nexT/source/css/_custom/custon.styl文件中启用</li><li>设置Canvas_nest动态背景</li><li>图片快速加载设置</li><li>微信支付宝打赏功能</li><li>点击出现桃心效果</li><li>主页文章添加阴影效果</li><li>设置代码高亮</li><li>顶栏背景色</li><li>底栏背景色</li><li>在右上角实现红色的fork me on github。默认禁用，可以在themes/nexT/_config.yml文件github_banner键中启用</li><li>添加添加RSS</li><li>修改文章内链接文本样式</li><li>修改文章底部标签样式</li><li>在文章末尾添加“文章结束”标记</li><li>设置头像</li><li>网站底部加上访问量</li><li>网站底部字数统计</li><li>网站底部添加网站运行时间</li><li>网站底部添加动态桃心</li><li>网站底部添加备案信息</li><li>底部隐藏由Hexo强力驱动、主题–NexT.Mist</li><li>设置网站的图标Favicon</li><li>实现文章文字统计功能和阅读时长</li><li>添加来必力云跟帖功能。（需要自己注册获取ID）</li><li>去掉底部重复字数统计</li><li>修改字体大小</li><li>添加DaoVoice在线联系。（需要自己注册获取ID）</li><li>侧边栏社交小图标设置</li><li>添加侧栏推荐阅读</li><li>修改侧边栏背景图片</li><li>修改侧边栏文字颜色</li><li>在文章底部增加版权信息</li><li>Hexo博客添加站内搜索</li><li>修改选中字符的颜色</li><li>添加aplay音乐播放</li><li>添加博客右下角卡通动漫</li></ul>\n          </div></p>\n"},{"layout":"post","title":"https证书加密解密原理解析","author":"Pyker","img":"/images/bar/https.jpg","top":true,"cover":false,"date":"2017-10-26T06:15:00.000Z","_content":"我们都知道HTTPS能够加密信息，以免敏感信息被第三方获取。所以很多银行网站或电子邮箱等等安全级别较高的服务都会采用HTTPS协议。而HTTPS可以看作是安全的HTTP，你可能听说过关于HTTPS的一些问题，比如什么握手，什么证书，加密之类的等等。\nHTTPS为何能保障web的安全，其运行原理是怎样的，当我们深入了解下去，其设计的思路对我们其他安全方面的设计也有一定的启发作用。\n\n### 与http的区别\nHTTPS其实是有两部分组成：`HTTP + SSL / TLS` ，也就是在HTTP上又加了一层处理加密信息的模块。服务端和客户端的信息传输都会通过TLS进行加密，所以传输的数据都是加密后的数据。如下图。\n```\n\t HTTP\t\t HTTPS\n\t\n   |-------|     |-------|\n   |  HTTP |     | HTTPS |\n   |-------|     |-------|\n   |  TCP  |     |ssl TLS|\n   |-------|     |-------|\n   |  IP   |     |  TCP  |\n   |-------|     |-------|\n                 |  IP   |\n\t\t\t     |-------|\n```\n### HTTPS加密解密证书流程图\n\n![](/images/pic/tls.jpg)\nHTTPS流程包含握手和后续的数据传输，握手的目的是为了客户端与服务端协商加密算法等参数。\nSSL/TLS基本过程是这样的：\n* 客户端向服务器端所要并验证证书\n* 双方协定加密算法以及“对话密钥”\n* 双方采用协商后的“对话密钥”进行加密通信\n\n**整个流程步骤如下：**\n1. 客户端发起HTTPS请求\n>这个没什么好说的，就是用户在浏览器里输入一个https网址，然后连接到server的443端口。\n2. 服务端的配置\n>采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面(startssl就是个不错的选择，有1年的免费服务)。这套证书其实就是一对公钥和私钥。如果对公钥和私钥不太理解，可以想象成一把钥匙和一个锁头，只是全世界只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。\n3. 传送证书\n>这个证书其实就是公钥，只是包含了很多信息，如证书的颁发机构，过期时间等等。\n4. 客户端解析证书\n>这部分工作是有客户端的TLS来完成的，首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。如果证书没有问题，那么就生成一个随即值。然后用证书对该随机值进行加密。就好像上面说的，把随机值用锁头锁起来，这样除非有钥匙，不然看不到被锁住的内容。\n5. 传送加密信息\n>这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了。\n6. 服务段解密信息\n>服务端用私钥解密后，得到了客户端传过来的随机值(私钥)，然后把内容通过该值进行对称加密。所谓对称加密就是，将信息和私钥通过某种算法混合在一起，这样除非知道私钥，不然无法获取内容，而正好客户端和服务端都知道这个私钥，所以只要加密算法够彪悍，私钥够复杂，数据就够安全。\n7. 传输加密后的信息\n>这部分信息是服务段用私钥加密后的信息，可以在客户端被还原\n8. 客户端解密信息\n>客户端用之前生成的私钥解密服务段传过来的信息，于是获取了解密后的内容。整个过程第三方即使监听到了数据，也束手无策。\n\n### HTTPS加密解密证书流程图解释\nHTTPS在传输数据之前需要客户端（浏览器）与服务端（网站）之间进行一次握手，在握手过程中将确立双方加密传输数据的密码信息。TLS/SSL协议不仅仅是一套加密传输的协议，更是一件经过艺术家精心设计的艺术品，TLS/SSL中使用了非对称加密，对称加密以及HASH算法。握手过程的具体描述如下：\n```\n1.浏览器将自己支持的一套加密规则发送给网站。 \n```\n```\n2.网站从中选出一组加密算法与HASH算法，并将自己的身份信息以证书的形式发回给浏览器。证书里面包含了网站地址，加密公钥，以及证书的颁发机构等信息。 \n```\n```\n3.浏览器获得网站证书之后浏览器要做以下工作： \na) 验证证书的合法性（颁发证书的机构是否合法，证书中包含的网站地址是否与正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示一个小锁头，否则会给出证书不受信的提示。 \nb) 如果证书受信任，或者是用户接受了不受信的证书，浏览器会生成一串随机数的密码，并用证书中提供的公钥加密。 \nc) 使用约定好的HASH算法计算握手消息，并使用生成的随机数对消息进行加密，最后将之前生成的所有信息发送给网站。 \n```\n```\n4.网站接收浏览器发来的数据之后要做以下的操作： \na) 使用自己的私钥将信息解密取出密码，使用密码解密浏览器发来的握手消息，并验证HASH是否与浏览器发来的一致。 \nb) 使用密码加密一段握手消息，发送给浏览器。 \n```\n```\n5.浏览器解密并计算握手消息的HASH，如果与服务端发来的HASH一致，此时握手过程结束，之后所有的通信数据将由之前浏览器生成的随机密码并利用对称加密算法进行加密。\n```\n\n这里浏览器与网站互相发送加密的握手消息并验证，目的是为了保证双方都获得了一致的密码，并且可以正常的加密解密数据，为后续真正数据的传输做一次测试。另外，HTTPS一般使用的加密与HASH算法如下：\n```\n非对称加密算法：RSA，DSA/DSS \n对称加密算法：AES，RC4，3DES \nHASH算法：MD5，SHA1，SHA256\n```","source":"_posts/https-tls.md","raw":"layout: post\ntitle: https证书加密解密原理解析\nauthor: Pyker\ncategories: web\nimg: /images/bar/https.jpg\ntags:\n  - https\ntop: true\ncover: false\ndate: 2017-10-26 14:15:00\n---\n我们都知道HTTPS能够加密信息，以免敏感信息被第三方获取。所以很多银行网站或电子邮箱等等安全级别较高的服务都会采用HTTPS协议。而HTTPS可以看作是安全的HTTP，你可能听说过关于HTTPS的一些问题，比如什么握手，什么证书，加密之类的等等。\nHTTPS为何能保障web的安全，其运行原理是怎样的，当我们深入了解下去，其设计的思路对我们其他安全方面的设计也有一定的启发作用。\n\n### 与http的区别\nHTTPS其实是有两部分组成：`HTTP + SSL / TLS` ，也就是在HTTP上又加了一层处理加密信息的模块。服务端和客户端的信息传输都会通过TLS进行加密，所以传输的数据都是加密后的数据。如下图。\n```\n\t HTTP\t\t HTTPS\n\t\n   |-------|     |-------|\n   |  HTTP |     | HTTPS |\n   |-------|     |-------|\n   |  TCP  |     |ssl TLS|\n   |-------|     |-------|\n   |  IP   |     |  TCP  |\n   |-------|     |-------|\n                 |  IP   |\n\t\t\t     |-------|\n```\n### HTTPS加密解密证书流程图\n\n![](/images/pic/tls.jpg)\nHTTPS流程包含握手和后续的数据传输，握手的目的是为了客户端与服务端协商加密算法等参数。\nSSL/TLS基本过程是这样的：\n* 客户端向服务器端所要并验证证书\n* 双方协定加密算法以及“对话密钥”\n* 双方采用协商后的“对话密钥”进行加密通信\n\n**整个流程步骤如下：**\n1. 客户端发起HTTPS请求\n>这个没什么好说的，就是用户在浏览器里输入一个https网址，然后连接到server的443端口。\n2. 服务端的配置\n>采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面(startssl就是个不错的选择，有1年的免费服务)。这套证书其实就是一对公钥和私钥。如果对公钥和私钥不太理解，可以想象成一把钥匙和一个锁头，只是全世界只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。\n3. 传送证书\n>这个证书其实就是公钥，只是包含了很多信息，如证书的颁发机构，过期时间等等。\n4. 客户端解析证书\n>这部分工作是有客户端的TLS来完成的，首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。如果证书没有问题，那么就生成一个随即值。然后用证书对该随机值进行加密。就好像上面说的，把随机值用锁头锁起来，这样除非有钥匙，不然看不到被锁住的内容。\n5. 传送加密信息\n>这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了。\n6. 服务段解密信息\n>服务端用私钥解密后，得到了客户端传过来的随机值(私钥)，然后把内容通过该值进行对称加密。所谓对称加密就是，将信息和私钥通过某种算法混合在一起，这样除非知道私钥，不然无法获取内容，而正好客户端和服务端都知道这个私钥，所以只要加密算法够彪悍，私钥够复杂，数据就够安全。\n7. 传输加密后的信息\n>这部分信息是服务段用私钥加密后的信息，可以在客户端被还原\n8. 客户端解密信息\n>客户端用之前生成的私钥解密服务段传过来的信息，于是获取了解密后的内容。整个过程第三方即使监听到了数据，也束手无策。\n\n### HTTPS加密解密证书流程图解释\nHTTPS在传输数据之前需要客户端（浏览器）与服务端（网站）之间进行一次握手，在握手过程中将确立双方加密传输数据的密码信息。TLS/SSL协议不仅仅是一套加密传输的协议，更是一件经过艺术家精心设计的艺术品，TLS/SSL中使用了非对称加密，对称加密以及HASH算法。握手过程的具体描述如下：\n```\n1.浏览器将自己支持的一套加密规则发送给网站。 \n```\n```\n2.网站从中选出一组加密算法与HASH算法，并将自己的身份信息以证书的形式发回给浏览器。证书里面包含了网站地址，加密公钥，以及证书的颁发机构等信息。 \n```\n```\n3.浏览器获得网站证书之后浏览器要做以下工作： \na) 验证证书的合法性（颁发证书的机构是否合法，证书中包含的网站地址是否与正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示一个小锁头，否则会给出证书不受信的提示。 \nb) 如果证书受信任，或者是用户接受了不受信的证书，浏览器会生成一串随机数的密码，并用证书中提供的公钥加密。 \nc) 使用约定好的HASH算法计算握手消息，并使用生成的随机数对消息进行加密，最后将之前生成的所有信息发送给网站。 \n```\n```\n4.网站接收浏览器发来的数据之后要做以下的操作： \na) 使用自己的私钥将信息解密取出密码，使用密码解密浏览器发来的握手消息，并验证HASH是否与浏览器发来的一致。 \nb) 使用密码加密一段握手消息，发送给浏览器。 \n```\n```\n5.浏览器解密并计算握手消息的HASH，如果与服务端发来的HASH一致，此时握手过程结束，之后所有的通信数据将由之前浏览器生成的随机密码并利用对称加密算法进行加密。\n```\n\n这里浏览器与网站互相发送加密的握手消息并验证，目的是为了保证双方都获得了一致的密码，并且可以正常的加密解密数据，为后续真正数据的传输做一次测试。另外，HTTPS一般使用的加密与HASH算法如下：\n```\n非对称加密算法：RSA，DSA/DSS \n对称加密算法：AES，RC4，3DES \nHASH算法：MD5，SHA1，SHA256\n```","slug":"https-tls","published":1,"updated":"2019-05-28T02:02:23.504Z","_id":"cjw6jleyh0008p4n7w4j459wm","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>我们都知道HTTPS能够加密信息，以免敏感信息被第三方获取。所以很多银行网站或电子邮箱等等安全级别较高的服务都会采用HTTPS协议。而HTTPS可以看作是安全的HTTP，你可能听说过关于HTTPS的一些问题，比如什么握手，什么证书，加密之类的等等。<br>HTTPS为何能保障web的安全，其运行原理是怎样的，当我们深入了解下去，其设计的思路对我们其他安全方面的设计也有一定的启发作用。</p>\n<h3 id=\"与http的区别\"><a href=\"#与http的区别\" class=\"headerlink\" title=\"与http的区别\"></a>与http的区别</h3><p>HTTPS其实是有两部分组成：<code>HTTP + SSL / TLS</code> ，也就是在HTTP上又加了一层处理加密信息的模块。服务端和客户端的信息传输都会通过TLS进行加密，所以传输的数据都是加密后的数据。如下图。<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP\t\t HTTPS</span><br><span class=\"line\">\t</span><br><span class=\"line\"> |<span class=\"string\">-------</span>|<span class=\"string\">     </span>|<span class=\"string\">-------</span>|</span><br><span class=\"line\"> |<span class=\"string\">  HTTP </span>|<span class=\"string\">     </span>|<span class=\"string\"> HTTPS </span>|</span><br><span class=\"line\"> |<span class=\"string\">-------</span>|<span class=\"string\">     </span>|<span class=\"string\">-------</span>|</span><br><span class=\"line\"> |<span class=\"string\">  TCP  </span>|<span class=\"string\">     </span>|<span class=\"string\">ssl TLS</span>|</span><br><span class=\"line\"> |<span class=\"string\">-------</span>|<span class=\"string\">     </span>|<span class=\"string\">-------</span>|</span><br><span class=\"line\"> |<span class=\"string\">  IP   </span>|<span class=\"string\">     </span>|<span class=\"string\">  TCP  </span>|</span><br><span class=\"line\"> |<span class=\"string\">-------</span>|<span class=\"string\">     </span>|<span class=\"string\">-------</span>|</span><br><span class=\"line\">               |<span class=\"string\">  IP   </span>|</span><br><span class=\"line\">\t     |<span class=\"string\">-------</span>|</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"HTTPS加密解密证书流程图\"><a href=\"#HTTPS加密解密证书流程图\" class=\"headerlink\" title=\"HTTPS加密解密证书流程图\"></a>HTTPS加密解密证书流程图</h3><p><img src=\"/images/pic/tls.jpg\" alt><br>HTTPS流程包含握手和后续的数据传输，握手的目的是为了客户端与服务端协商加密算法等参数。<br>SSL/TLS基本过程是这样的：</p>\n<ul>\n<li>客户端向服务器端所要并验证证书</li>\n<li>双方协定加密算法以及“对话密钥”</li>\n<li>双方采用协商后的“对话密钥”进行加密通信</li>\n</ul>\n<p><strong>整个流程步骤如下：</strong></p>\n<ol>\n<li>客户端发起HTTPS请求<blockquote>\n<p>这个没什么好说的，就是用户在浏览器里输入一个https网址，然后连接到server的443端口。</p>\n</blockquote>\n</li>\n<li>服务端的配置<blockquote>\n<p>采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面(startssl就是个不错的选择，有1年的免费服务)。这套证书其实就是一对公钥和私钥。如果对公钥和私钥不太理解，可以想象成一把钥匙和一个锁头，只是全世界只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。</p>\n</blockquote>\n</li>\n<li>传送证书<blockquote>\n<p>这个证书其实就是公钥，只是包含了很多信息，如证书的颁发机构，过期时间等等。</p>\n</blockquote>\n</li>\n<li>客户端解析证书<blockquote>\n<p>这部分工作是有客户端的TLS来完成的，首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。如果证书没有问题，那么就生成一个随即值。然后用证书对该随机值进行加密。就好像上面说的，把随机值用锁头锁起来，这样除非有钥匙，不然看不到被锁住的内容。</p>\n</blockquote>\n</li>\n<li>传送加密信息<blockquote>\n<p>这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了。</p>\n</blockquote>\n</li>\n<li>服务段解密信息<blockquote>\n<p>服务端用私钥解密后，得到了客户端传过来的随机值(私钥)，然后把内容通过该值进行对称加密。所谓对称加密就是，将信息和私钥通过某种算法混合在一起，这样除非知道私钥，不然无法获取内容，而正好客户端和服务端都知道这个私钥，所以只要加密算法够彪悍，私钥够复杂，数据就够安全。</p>\n</blockquote>\n</li>\n<li>传输加密后的信息<blockquote>\n<p>这部分信息是服务段用私钥加密后的信息，可以在客户端被还原</p>\n</blockquote>\n</li>\n<li>客户端解密信息<blockquote>\n<p>客户端用之前生成的私钥解密服务段传过来的信息，于是获取了解密后的内容。整个过程第三方即使监听到了数据，也束手无策。</p>\n</blockquote>\n</li>\n</ol>\n<h3 id=\"HTTPS加密解密证书流程图解释\"><a href=\"#HTTPS加密解密证书流程图解释\" class=\"headerlink\" title=\"HTTPS加密解密证书流程图解释\"></a>HTTPS加密解密证书流程图解释</h3><p>HTTPS在传输数据之前需要客户端（浏览器）与服务端（网站）之间进行一次握手，在握手过程中将确立双方加密传输数据的密码信息。TLS/SSL协议不仅仅是一套加密传输的协议，更是一件经过艺术家精心设计的艺术品，TLS/SSL中使用了非对称加密，对称加密以及HASH算法。握手过程的具体描述如下：<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1.</span>浏览器将自己支持的一套加密规则发送给网站。</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2.</span>网站从中选出一组加密算法与HASH算法，并将自己的身份信息以证书的形式发回给浏览器。证书里面包含了网站地址，加密公钥，以及证书的颁发机构等信息。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">3</span>.浏览器获得网站证书之后浏览器要做以下工作： </span><br><span class=\"line\">a) 验证证书的合法性（颁发证书的机构是否合法，证书中包含的网站地址是否与正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示一个小锁头，否则会给出证书不受信的提示。 </span><br><span class=\"line\"><span class=\"keyword\">b) </span>如果证书受信任，或者是用户接受了不受信的证书，浏览器会生成一串随机数的密码，并用证书中提供的公钥加密。 </span><br><span class=\"line\">c) 使用约定好的HASH算法计算握手消息，并使用生成的随机数对消息进行加密，最后将之前生成的所有信息发送给网站。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">4</span>.网站接收浏览器发来的数据之后要做以下的操作： </span><br><span class=\"line\">a) 使用自己的私钥将信息解密取出密码，使用密码解密浏览器发来的握手消息，并验证HASH是否与浏览器发来的一致。 </span><br><span class=\"line\"><span class=\"keyword\">b) </span>使用密码加密一段握手消息，发送给浏览器。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">5.</span>浏览器解密并计算握手消息的HASH，如果与服务端发来的HASH一致，此时握手过程结束，之后所有的通信数据将由之前浏览器生成的随机密码并利用对称加密算法进行加密。</span><br></pre></td></tr></table></figure>\n<p>这里浏览器与网站互相发送加密的握手消息并验证，目的是为了保证双方都获得了一致的密码，并且可以正常的加密解密数据，为后续真正数据的传输做一次测试。另外，HTTPS一般使用的加密与HASH算法如下：<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">非对称加密算法：RSA，DSA/DSS </span><br><span class=\"line\">对称加密算法：AES，RC4，<span class=\"number\">3</span>DES </span><br><span class=\"line\">HASH算法：MD5，SHA1，SHA256</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"length":2348,"excerpt":"","more":"<p>我们都知道HTTPS能够加密信息，以免敏感信息被第三方获取。所以很多银行网站或电子邮箱等等安全级别较高的服务都会采用HTTPS协议。而HTTPS可以看作是安全的HTTP，你可能听说过关于HTTPS的一些问题，比如什么握手，什么证书，加密之类的等等。<br>HTTPS为何能保障web的安全，其运行原理是怎样的，当我们深入了解下去，其设计的思路对我们其他安全方面的设计也有一定的启发作用。</p>\n<h3 id=\"与http的区别\"><a href=\"#与http的区别\" class=\"headerlink\" title=\"与http的区别\"></a>与http的区别</h3><p>HTTPS其实是有两部分组成：<code>HTTP + SSL / TLS</code> ，也就是在HTTP上又加了一层处理加密信息的模块。服务端和客户端的信息传输都会通过TLS进行加密，所以传输的数据都是加密后的数据。如下图。<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP\t\t HTTPS</span><br><span class=\"line\">\t</span><br><span class=\"line\"> |<span class=\"string\">-------</span>|<span class=\"string\">     </span>|<span class=\"string\">-------</span>|</span><br><span class=\"line\"> |<span class=\"string\">  HTTP </span>|<span class=\"string\">     </span>|<span class=\"string\"> HTTPS </span>|</span><br><span class=\"line\"> |<span class=\"string\">-------</span>|<span class=\"string\">     </span>|<span class=\"string\">-------</span>|</span><br><span class=\"line\"> |<span class=\"string\">  TCP  </span>|<span class=\"string\">     </span>|<span class=\"string\">ssl TLS</span>|</span><br><span class=\"line\"> |<span class=\"string\">-------</span>|<span class=\"string\">     </span>|<span class=\"string\">-------</span>|</span><br><span class=\"line\"> |<span class=\"string\">  IP   </span>|<span class=\"string\">     </span>|<span class=\"string\">  TCP  </span>|</span><br><span class=\"line\"> |<span class=\"string\">-------</span>|<span class=\"string\">     </span>|<span class=\"string\">-------</span>|</span><br><span class=\"line\">               |<span class=\"string\">  IP   </span>|</span><br><span class=\"line\">\t     |<span class=\"string\">-------</span>|</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"HTTPS加密解密证书流程图\"><a href=\"#HTTPS加密解密证书流程图\" class=\"headerlink\" title=\"HTTPS加密解密证书流程图\"></a>HTTPS加密解密证书流程图</h3><p><img src=\"/images/pic/tls.jpg\" alt><br>HTTPS流程包含握手和后续的数据传输，握手的目的是为了客户端与服务端协商加密算法等参数。<br>SSL/TLS基本过程是这样的：</p>\n<ul>\n<li>客户端向服务器端所要并验证证书</li>\n<li>双方协定加密算法以及“对话密钥”</li>\n<li>双方采用协商后的“对话密钥”进行加密通信</li>\n</ul>\n<p><strong>整个流程步骤如下：</strong></p>\n<ol>\n<li>客户端发起HTTPS请求<blockquote>\n<p>这个没什么好说的，就是用户在浏览器里输入一个https网址，然后连接到server的443端口。</p>\n</blockquote>\n</li>\n<li>服务端的配置<blockquote>\n<p>采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面(startssl就是个不错的选择，有1年的免费服务)。这套证书其实就是一对公钥和私钥。如果对公钥和私钥不太理解，可以想象成一把钥匙和一个锁头，只是全世界只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。</p>\n</blockquote>\n</li>\n<li>传送证书<blockquote>\n<p>这个证书其实就是公钥，只是包含了很多信息，如证书的颁发机构，过期时间等等。</p>\n</blockquote>\n</li>\n<li>客户端解析证书<blockquote>\n<p>这部分工作是有客户端的TLS来完成的，首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。如果证书没有问题，那么就生成一个随即值。然后用证书对该随机值进行加密。就好像上面说的，把随机值用锁头锁起来，这样除非有钥匙，不然看不到被锁住的内容。</p>\n</blockquote>\n</li>\n<li>传送加密信息<blockquote>\n<p>这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了。</p>\n</blockquote>\n</li>\n<li>服务段解密信息<blockquote>\n<p>服务端用私钥解密后，得到了客户端传过来的随机值(私钥)，然后把内容通过该值进行对称加密。所谓对称加密就是，将信息和私钥通过某种算法混合在一起，这样除非知道私钥，不然无法获取内容，而正好客户端和服务端都知道这个私钥，所以只要加密算法够彪悍，私钥够复杂，数据就够安全。</p>\n</blockquote>\n</li>\n<li>传输加密后的信息<blockquote>\n<p>这部分信息是服务段用私钥加密后的信息，可以在客户端被还原</p>\n</blockquote>\n</li>\n<li>客户端解密信息<blockquote>\n<p>客户端用之前生成的私钥解密服务段传过来的信息，于是获取了解密后的内容。整个过程第三方即使监听到了数据，也束手无策。</p>\n</blockquote>\n</li>\n</ol>\n<h3 id=\"HTTPS加密解密证书流程图解释\"><a href=\"#HTTPS加密解密证书流程图解释\" class=\"headerlink\" title=\"HTTPS加密解密证书流程图解释\"></a>HTTPS加密解密证书流程图解释</h3><p>HTTPS在传输数据之前需要客户端（浏览器）与服务端（网站）之间进行一次握手，在握手过程中将确立双方加密传输数据的密码信息。TLS/SSL协议不仅仅是一套加密传输的协议，更是一件经过艺术家精心设计的艺术品，TLS/SSL中使用了非对称加密，对称加密以及HASH算法。握手过程的具体描述如下：<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1.</span>浏览器将自己支持的一套加密规则发送给网站。</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2.</span>网站从中选出一组加密算法与HASH算法，并将自己的身份信息以证书的形式发回给浏览器。证书里面包含了网站地址，加密公钥，以及证书的颁发机构等信息。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">3</span>.浏览器获得网站证书之后浏览器要做以下工作： </span><br><span class=\"line\">a) 验证证书的合法性（颁发证书的机构是否合法，证书中包含的网站地址是否与正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示一个小锁头，否则会给出证书不受信的提示。 </span><br><span class=\"line\"><span class=\"keyword\">b) </span>如果证书受信任，或者是用户接受了不受信的证书，浏览器会生成一串随机数的密码，并用证书中提供的公钥加密。 </span><br><span class=\"line\">c) 使用约定好的HASH算法计算握手消息，并使用生成的随机数对消息进行加密，最后将之前生成的所有信息发送给网站。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">4</span>.网站接收浏览器发来的数据之后要做以下的操作： </span><br><span class=\"line\">a) 使用自己的私钥将信息解密取出密码，使用密码解密浏览器发来的握手消息，并验证HASH是否与浏览器发来的一致。 </span><br><span class=\"line\"><span class=\"keyword\">b) </span>使用密码加密一段握手消息，发送给浏览器。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">5.</span>浏览器解密并计算握手消息的HASH，如果与服务端发来的HASH一致，此时握手过程结束，之后所有的通信数据将由之前浏览器生成的随机密码并利用对称加密算法进行加密。</span><br></pre></td></tr></table></figure>\n<p>这里浏览器与网站互相发送加密的握手消息并验证，目的是为了保证双方都获得了一致的密码，并且可以正常的加密解密数据，为后续真正数据的传输做一次测试。另外，HTTPS一般使用的加密与HASH算法如下：<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">非对称加密算法：RSA，DSA/DSS </span><br><span class=\"line\">对称加密算法：AES，RC4，<span class=\"number\">3</span>DES </span><br><span class=\"line\">HASH算法：MD5，SHA1，SHA256</span><br></pre></td></tr></table></figure></p>\n"},{"layout":"post","title":"CentOS7 安装Docker-CE","author":"Pyker","top":false,"cover":false,"date":"2019-03-21T14:02:00.000Z","_content":"### CentOS7 安装Docker-CE\n\n从2017年3月开始 docker 在原来的基础上分为两个分支版本: {% label primary@Docker-CE %} 和 {% label success@Docker-EE %}。`Docker-CE` 即社区免费版，`Docker-EE` 即企业版，强调安全，但需付费使用。本文介绍 Docker-ce的安装使用。\n\n#### 移除旧的版本\n```bash\n\t$ sudo yum remove docker \\\n                  docker-client \\\n                  docker-client-latest \\\n                  docker-common \\\n                  docker-latest \\\n                  docker-latest-logrotate \\\n                  docker-logrotate \\\n                  docker-selinux \\\n                  docker-engine-selinux \\\n                  docker-engine\n```\n#### 安装一些必要的系统工具\n```bash\n\t$ sudo yum install -y yum-utils device-mapper-persistent-data lvm2\n```\n#### 添加软件源信息\t\t\t\t\t\n```bash\n\t$ sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n```\n#### 更新 yum 缓存\n```bash\n\t$ sudo yum makecache fast\n```\n#### 查看可用版本的 Docker-CE\n```bash\n\t$ yum list docker-ce --showduplicates | sort -r\n```\n<div class=\"note primary\">注意：如果需要只显示table版本，可以关闭测试版本的list</p></div>\n\n```bash\n$ sudo yum-config-manager --enable docker-ce-edge\n$ sudo yum-config-manager --enable docker-ce-test\n```\n#### 更新yum包索引\n```bash\n\t$ yum makecache fast\n```\n#### 安装指定版本的docker-CE\n```bash\n\t$ sudo yum install -y docker-ce-17.03.2.ce-1.el7.centos \n```\n<div class=\"note warning\"><p>报错：如果在安装指定版本的docker时显示需要安装指定版本的docker-ce-selinux依赖包，请安装：</p></div>\n\n```bash\n$ yum install -y https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-selinux-17.03.2.ce-1.el7.centos.noarch.rpm \n```","source":"_posts/install-docker-ce.md","raw":"layout: post\ntitle: CentOS7 安装Docker-CE\nauthor: Pyker\ncategories: docker\ntags:\n  - docker\n  - kubernetes\ntop: false\ncover: false\ndate: 2019-03-21 22:02:00\n---\n### CentOS7 安装Docker-CE\n\n从2017年3月开始 docker 在原来的基础上分为两个分支版本: {% label primary@Docker-CE %} 和 {% label success@Docker-EE %}。`Docker-CE` 即社区免费版，`Docker-EE` 即企业版，强调安全，但需付费使用。本文介绍 Docker-ce的安装使用。\n\n#### 移除旧的版本\n```bash\n\t$ sudo yum remove docker \\\n                  docker-client \\\n                  docker-client-latest \\\n                  docker-common \\\n                  docker-latest \\\n                  docker-latest-logrotate \\\n                  docker-logrotate \\\n                  docker-selinux \\\n                  docker-engine-selinux \\\n                  docker-engine\n```\n#### 安装一些必要的系统工具\n```bash\n\t$ sudo yum install -y yum-utils device-mapper-persistent-data lvm2\n```\n#### 添加软件源信息\t\t\t\t\t\n```bash\n\t$ sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n```\n#### 更新 yum 缓存\n```bash\n\t$ sudo yum makecache fast\n```\n#### 查看可用版本的 Docker-CE\n```bash\n\t$ yum list docker-ce --showduplicates | sort -r\n```\n<div class=\"note primary\">注意：如果需要只显示table版本，可以关闭测试版本的list</p></div>\n\n```bash\n$ sudo yum-config-manager --enable docker-ce-edge\n$ sudo yum-config-manager --enable docker-ce-test\n```\n#### 更新yum包索引\n```bash\n\t$ yum makecache fast\n```\n#### 安装指定版本的docker-CE\n```bash\n\t$ sudo yum install -y docker-ce-17.03.2.ce-1.el7.centos \n```\n<div class=\"note warning\"><p>报错：如果在安装指定版本的docker时显示需要安装指定版本的docker-ce-selinux依赖包，请安装：</p></div>\n\n```bash\n$ yum install -y https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-selinux-17.03.2.ce-1.el7.centos.noarch.rpm \n```","slug":"install-docker-ce","published":1,"updated":"2019-05-28T02:02:23.505Z","_id":"cjw6jleyk000ap4n74ccnzwe3","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h3 id=\"CentOS7-安装Docker-CE\"><a href=\"#CentOS7-安装Docker-CE\" class=\"headerlink\" title=\"CentOS7 安装Docker-CE\"></a>CentOS7 安装Docker-CE</h3><p>从2017年3月开始 docker 在原来的基础上分为两个分支版本: <span class=\"label primary\">Docker-CE</span> 和 <span class=\"label success\">Docker-EE</span>。<code>Docker-CE</code> 即社区免费版，<code>Docker-EE</code> 即企业版，强调安全，但需付费使用。本文介绍 Docker-ce的安装使用。</p>\n<h4 id=\"移除旧的版本\"><a href=\"#移除旧的版本\" class=\"headerlink\" title=\"移除旧的版本\"></a>移除旧的版本</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum remove docker \\</span><br><span class=\"line\">                 docker-client \\</span><br><span class=\"line\">                 docker-client-latest \\</span><br><span class=\"line\">                 docker-common \\</span><br><span class=\"line\">                 docker-latest \\</span><br><span class=\"line\">                 docker-latest-logrotate \\</span><br><span class=\"line\">                 docker-logrotate \\</span><br><span class=\"line\">                 docker-selinux \\</span><br><span class=\"line\">                 docker-engine-selinux \\</span><br><span class=\"line\">                 docker-engine</span><br></pre></td></tr></table></figure>\n<h4 id=\"安装一些必要的系统工具\"><a href=\"#安装一些必要的系统工具\" class=\"headerlink\" title=\"安装一些必要的系统工具\"></a>安装一些必要的系统工具</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>\n<h4 id=\"添加软件源信息\"><a href=\"#添加软件源信息\" class=\"headerlink\" title=\"添加软件源信息\"></a>添加软件源信息</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>\n<h4 id=\"更新-yum-缓存\"><a href=\"#更新-yum-缓存\" class=\"headerlink\" title=\"更新 yum 缓存\"></a>更新 yum 缓存</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum makecache fast</span><br></pre></td></tr></table></figure>\n<h4 id=\"查看可用版本的-Docker-CE\"><a href=\"#查看可用版本的-Docker-CE\" class=\"headerlink\" title=\"查看可用版本的 Docker-CE\"></a>查看可用版本的 Docker-CE</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum list docker-ce --showduplicates | sort -r</span><br></pre></td></tr></table></figure>\n<div class=\"note primary\">注意：如果需要只显示table版本，可以关闭测试版本的list<p></p></div>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum-config-manager --<span class=\"built_in\">enable</span> docker-ce-edge</span><br><span class=\"line\">$ sudo yum-config-manager --<span class=\"built_in\">enable</span> docker-ce-test</span><br></pre></td></tr></table></figure>\n<h4 id=\"更新yum包索引\"><a href=\"#更新yum包索引\" class=\"headerlink\" title=\"更新yum包索引\"></a>更新yum包索引</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum makecache fast</span><br></pre></td></tr></table></figure>\n<h4 id=\"安装指定版本的docker-CE\"><a href=\"#安装指定版本的docker-CE\" class=\"headerlink\" title=\"安装指定版本的docker-CE\"></a>安装指定版本的docker-CE</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum install -y docker-ce-17.03.2.ce-1.el7.centos</span><br></pre></td></tr></table></figure>\n<div class=\"note warning\"><p>报错：如果在安装指定版本的docker时显示需要安装指定版本的docker-ce-selinux依赖包，请安装：</p></div>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum install -y https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-selinux-17.03.2.ce-1.el7.centos.noarch.rpm</span><br></pre></td></tr></table></figure>","site":{"data":{}},"length":1201,"excerpt":"","more":"<h3 id=\"CentOS7-安装Docker-CE\"><a href=\"#CentOS7-安装Docker-CE\" class=\"headerlink\" title=\"CentOS7 安装Docker-CE\"></a>CentOS7 安装Docker-CE</h3><p>从2017年3月开始 docker 在原来的基础上分为两个分支版本: <span class=\"label primary\">Docker-CE</span> 和 <span class=\"label success\">Docker-EE</span>。<code>Docker-CE</code> 即社区免费版，<code>Docker-EE</code> 即企业版，强调安全，但需付费使用。本文介绍 Docker-ce的安装使用。</p>\n<h4 id=\"移除旧的版本\"><a href=\"#移除旧的版本\" class=\"headerlink\" title=\"移除旧的版本\"></a>移除旧的版本</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum remove docker \\</span><br><span class=\"line\">                 docker-client \\</span><br><span class=\"line\">                 docker-client-latest \\</span><br><span class=\"line\">                 docker-common \\</span><br><span class=\"line\">                 docker-latest \\</span><br><span class=\"line\">                 docker-latest-logrotate \\</span><br><span class=\"line\">                 docker-logrotate \\</span><br><span class=\"line\">                 docker-selinux \\</span><br><span class=\"line\">                 docker-engine-selinux \\</span><br><span class=\"line\">                 docker-engine</span><br></pre></td></tr></table></figure>\n<h4 id=\"安装一些必要的系统工具\"><a href=\"#安装一些必要的系统工具\" class=\"headerlink\" title=\"安装一些必要的系统工具\"></a>安装一些必要的系统工具</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>\n<h4 id=\"添加软件源信息\"><a href=\"#添加软件源信息\" class=\"headerlink\" title=\"添加软件源信息\"></a>添加软件源信息</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>\n<h4 id=\"更新-yum-缓存\"><a href=\"#更新-yum-缓存\" class=\"headerlink\" title=\"更新 yum 缓存\"></a>更新 yum 缓存</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum makecache fast</span><br></pre></td></tr></table></figure>\n<h4 id=\"查看可用版本的-Docker-CE\"><a href=\"#查看可用版本的-Docker-CE\" class=\"headerlink\" title=\"查看可用版本的 Docker-CE\"></a>查看可用版本的 Docker-CE</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum list docker-ce --showduplicates | sort -r</span><br></pre></td></tr></table></figure>\n<div class=\"note primary\">注意：如果需要只显示table版本，可以关闭测试版本的list<p></p></div>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum-config-manager --<span class=\"built_in\">enable</span> docker-ce-edge</span><br><span class=\"line\">$ sudo yum-config-manager --<span class=\"built_in\">enable</span> docker-ce-test</span><br></pre></td></tr></table></figure>\n<h4 id=\"更新yum包索引\"><a href=\"#更新yum包索引\" class=\"headerlink\" title=\"更新yum包索引\"></a>更新yum包索引</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum makecache fast</span><br></pre></td></tr></table></figure>\n<h4 id=\"安装指定版本的docker-CE\"><a href=\"#安装指定版本的docker-CE\" class=\"headerlink\" title=\"安装指定版本的docker-CE\"></a>安装指定版本的docker-CE</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum install -y docker-ce-17.03.2.ce-1.el7.centos</span><br></pre></td></tr></table></figure>\n<div class=\"note warning\"><p>报错：如果在安装指定版本的docker时显示需要安装指定版本的docker-ce-selinux依赖包，请安装：</p></div>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum install -y https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-selinux-17.03.2.ce-1.el7.centos.noarch.rpm</span><br></pre></td></tr></table></figure>"},{"layout":"post","title":"Gitlab-CE社区版安装","author":"Pyker","img":"/images/bar/gitlab.jpg","top":false,"cover":false,"date":"2018-11-29T09:30:00.000Z","_content":"常见的git环境有git web版和gitolite版本，gitolite权限控制强大，但功能不完善，而git web(gitlab)虽然权限没有像gitolite分的那么细，但是功能异常强大，不仅支持SSH KEY、web密码方式还有CI/CD，PIPELINE功能。所以下文将介绍如何在公司内网搭建私有的gitlab环境。\n\n>GitLab官网强烈建议安装Omnibus软件包，因为它安装更快，更易于升级，并且包含增强其他方法所没有的可靠性的功能。我们还强烈建议`至少4GB`的可用内存` 来运行GitLab。\n\n## GitLab的安装\n\n### Omnibus方式安装\n\n##### 安装并配置必要的依赖项\n在CentOS 7（和RedHat / Oracle / Scientific Linux 7）上，执行以下命令。\n```bash\nsudo yum install -y curl policycoreutils-python openssh-server\n```\n##### 更新GitLab国内yum源\n```bash\n$ cat > /etc/yum.repos.d/gitlab-ce.repo << EOF\n[gitlab-ce]\nname=Gitlab CE Repository\nbaseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/\ngpgcheck=0\nenabled=1 \nEOF\n```\n##### 安装GitLab-CE包\n```bash\n$ yum makecache\n$ yum install gitlab-ce -y\n```\n##### 配置GitLab-CE域名和邮件通知\n配置文件为`/etc/gitlab/gitlab.rb` \n```bash\n#修改external_url 为你gitlab的访问域名\n$ vim /etc/gitlab/gitlab.rb\nexternal_url 'http://git.ipyker.com'\n\n#添加gitlab邮件通知配置（大约在/etc/gitlab/gitlab.rb文件的517行）\ngitlab_rails['smtp_enable'] = true \ngitlab_rails['smtp_address'] = \"smtp.ipyker.com\"\ngitlab_rails['smtp_port'] = 465\ngitlab_rails['smtp_user_name'] = \"gitlab@ipyker.com\"\ngitlab_rails['smtp_password'] = \"mypasswd\"\ngitlab_rails['smtp_authentication'] = \"login\"\ngitlab_rails['smtp_enable_starttls_auto'] = true \ngitlab_rails['smtp_tls'] = true \ngitlab_rails['gitlab_email_from'] = 'gitlab@ipyker.com'\ngitlab_rails['smtp_domain'] = \"ipyker.com\"\n```\n\n> **GitLab安装完后，工作目录默认为：/var/opt/gitlab、/opt/gitlab，配置文件目录为：/etc/gitlab**\n\n#### GitLab管理\n##### 重载配置信息\n```\n$ gitlab-ctl reconfigure\n```\n##### 启动\n```\n$ gitlab-ctl start\n```\n##### 停止\n```\n$ gitlab-ctl stop\n```\n##### 重启 \n```\n$ gitlab-ctl restart\n```\n\n#### 登陆\n第一次用域名登录gitlab，需要为root用户修改密码，root用户也是gitlab的超级管理员，gitlab也支持修改中文界面，如下图所示\n![](/images/pic/welcome-gitlab.png)\n\n![](/images/pic/language.png)\n\n**更多关于gitlab配置信息参数，请参考官网[GitLab配置文件](https://docs.gitlab.com/omnibus/settings/README.html)**\n\n---\n### Docker方式安装\n#### GitLab docker 镜像\ngitlab-ce镜像存放在[docker官方仓库](https://hub.docker.com/r/gitlab/gitlab-ce/)中。\n\nGitLab Docker镜像是GitLab的单个镜像，在单个容器上运行所有必要的服务。\n在以下示例中，我们使用GitLab CE的镜像。如果要使用最新的RC映像，请使用`gitlab/gitlab-ce:rc` 用于GitLab CE\nGitLab Docker镜像可以多种方式运行：\n* [在Docker Engine中运行映像](https://docs.gitlab.com/omnibus/docker/#run-the-image)\n* [将GitLab安装到群集中](https://docs.gitlab.com/omnibus/docker/#install-gitlab-into-a-cluster)\n* [使用docker-compose安装GitLab](https://docs.gitlab.com/omnibus/docker/#install-gitlab-using-docker-compose)\n\n**本文档以第一种方式在docker中运行，如你需要高可用可以用第二种，甚至是通过kubenetes deplyment部署pod方式安装。**\n\n#### 先决条件\n需要先安装docker，请参考[docker-ce安装](https://www.ipyker.com/2019/03/21/centos7-install-docker-ce/)\n\n#### 运行gitlab-ce容器\n```bash\n$ docker run -d \\\n  --hostname gitlab.example.com \\\n  --publish 443:443 --publish 80:80 --publish 22:22 \\\n  --name gitlab \\\n  --restart always \\\n  --volume /srv/gitlab/config:/etc/gitlab \\\n  --volume /srv/gitlab/logs:/var/log/gitlab \\\n  --volume /srv/gitlab/data:/var/opt/gitlab \\\n  gitlab/gitlab-ce:latest\n```\n>`docker run` 命令将直接拉取镜像和运行容器，相当于运行docker pull和docker start两条命令。gitlab-ce容器将制定域名，开放的端口，以及容器挂载本地的文件系统，所有GitLab数据都将存储为子目录 /srv/gitlab/。restart系统重启后，容器将自动运行。\n\n宿主目录 | docker目录 | 用途\n--- | --- | ---\n/srv/gitlab/data | /var/opt/gitlab | 用于存储应用数据\n/srv/gitlab/logs | /var/log/gitlab | 用于存储日志\n/srv/gitlab/config | /etc/gitlab | 用于存储GitLab配置文件\n\n#### 配置girlab-ce\n此容器使用官方的Omnibus GitLab软件包，因此所有配置都在docker唯一的配置文件中完成/etc/gitlab/gitlab.rb，也可以通过修改挂载卷文件来完成。\n\n要访问GitLab的配置文件，您可以在正在运行的容器的上下文中启动shell会话。这将允许您浏览所有目录并使用您喜欢的文本编辑器：\n```bash\n$ docker exec -it gitlab /bin/bash\n```\n打开后，请`/etc/gitlab/gitlab.rb` 确保将指针设置`external_url` 为有效的URL。\n\n此外您可以通过将环境变量添加`GITLAB_OMNIBUS_CONFIG` 到docker run命令来预配置GitLab Docker映像。此变量可以包含任何gitlab.rb设置，并在加载容器gitlab.rb文件之前进行评估。这样，您可以轻松配置GitLab的外部URL，从[Omnibus GitLab](https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template)模板进行任何数据库配置或任何其他选项 。\n注意：包含的设置`GITLAB_OMNIBUS_CONFIG` 不会写入gitlab.rb配置文件，而是在加载时进行评估。\n这是一个设置外部URL并在启动容器时启用LFS的示例：\n```bash\n$ docker run -d \\\n  --hostname gitlab.example.com \\\n  --env GITLAB_OMNIBUS_CONFIG=\"external_url 'http://my.domain.com/'; gitlab_rails['lfs_enabled'] = true;\" \\\n  --publish 443:443 --publish 80:80 --publish 22:22 \\\n  --name gitlab \\\n  --restart always \\\n  --volume /srv/gitlab/config:/etc/gitlab \\\n  --volume /srv/gitlab/logs:/var/log/gitlab \\\n  --volume /srv/gitlab/data:/var/opt/gitlab \\\n  gitlab/gitlab-ce:latest\n```\n\n\n**要从GitLab接收电子邮件，您必须配置 SMTP设置，因为GitLab Docker映像没有安装SMTP服务器。默认也为HTTP，还可以启动https访问。**\n\n#### 重启gitlab-ce\n完成所需的所有更改后，需要重新启动容器才能重新配置GitLab：\n```bash\n$ docker restart gitlab\n```\n\n#### 手动配置HTTPS\n默认情况下，omnibus-gitlab不使用HTTPS。如果要为gitlab.example.com启用HTTPS，请将以下语句添加到`/etc/gitlab/gitlab.rb` ：\n```\nexternal_url \"https://gitlab.example.com\"\n```\n因为在我们的例子中，主机名是“gitlab.example.com”，所以创建`/etc/gitlab/ssl` 目录并在那里复制密钥和证书。\n```bash\n$ sudo mkdir -p /etc/gitlab/ssl\n$ sudo chmod 700 /etc/gitlab/ssl\n$ sudo cp gitlab.example.com.key gitlab.example.com.crt /etc/gitlab/ssl/\n```\n\n重新加载配置，当重新配置完成时，您的GitLab实例应该可以访问https://gitlab.example.com。\n```bash\n$ gitlab-ctl reconfigure\n```\n>如果certificate.key文件有设置密码，Nginx在`sudo gitlab-ctl reconfigure` 执行时不会要求输入密码。在这种情况下，Omnibus GitLab将无声地失败，没有错误消息。要从密钥中删除密码，请使用以下命令： `openssl rsa -in certificate_before.key -out certificate_after.key` 。","source":"_posts/install-gitlab-ce.md","raw":"layout: post\ntitle: Gitlab-CE社区版安装\nauthor: Pyker\ncategories: CI/CD\nimg: /images/bar/gitlab.jpg\ntags:\n  - git\ntop: false\ncover: false\ndate: 2018-11-29 17:30:00\n---\n常见的git环境有git web版和gitolite版本，gitolite权限控制强大，但功能不完善，而git web(gitlab)虽然权限没有像gitolite分的那么细，但是功能异常强大，不仅支持SSH KEY、web密码方式还有CI/CD，PIPELINE功能。所以下文将介绍如何在公司内网搭建私有的gitlab环境。\n\n>GitLab官网强烈建议安装Omnibus软件包，因为它安装更快，更易于升级，并且包含增强其他方法所没有的可靠性的功能。我们还强烈建议`至少4GB`的可用内存` 来运行GitLab。\n\n## GitLab的安装\n\n### Omnibus方式安装\n\n##### 安装并配置必要的依赖项\n在CentOS 7（和RedHat / Oracle / Scientific Linux 7）上，执行以下命令。\n```bash\nsudo yum install -y curl policycoreutils-python openssh-server\n```\n##### 更新GitLab国内yum源\n```bash\n$ cat > /etc/yum.repos.d/gitlab-ce.repo << EOF\n[gitlab-ce]\nname=Gitlab CE Repository\nbaseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/\ngpgcheck=0\nenabled=1 \nEOF\n```\n##### 安装GitLab-CE包\n```bash\n$ yum makecache\n$ yum install gitlab-ce -y\n```\n##### 配置GitLab-CE域名和邮件通知\n配置文件为`/etc/gitlab/gitlab.rb` \n```bash\n#修改external_url 为你gitlab的访问域名\n$ vim /etc/gitlab/gitlab.rb\nexternal_url 'http://git.ipyker.com'\n\n#添加gitlab邮件通知配置（大约在/etc/gitlab/gitlab.rb文件的517行）\ngitlab_rails['smtp_enable'] = true \ngitlab_rails['smtp_address'] = \"smtp.ipyker.com\"\ngitlab_rails['smtp_port'] = 465\ngitlab_rails['smtp_user_name'] = \"gitlab@ipyker.com\"\ngitlab_rails['smtp_password'] = \"mypasswd\"\ngitlab_rails['smtp_authentication'] = \"login\"\ngitlab_rails['smtp_enable_starttls_auto'] = true \ngitlab_rails['smtp_tls'] = true \ngitlab_rails['gitlab_email_from'] = 'gitlab@ipyker.com'\ngitlab_rails['smtp_domain'] = \"ipyker.com\"\n```\n\n> **GitLab安装完后，工作目录默认为：/var/opt/gitlab、/opt/gitlab，配置文件目录为：/etc/gitlab**\n\n#### GitLab管理\n##### 重载配置信息\n```\n$ gitlab-ctl reconfigure\n```\n##### 启动\n```\n$ gitlab-ctl start\n```\n##### 停止\n```\n$ gitlab-ctl stop\n```\n##### 重启 \n```\n$ gitlab-ctl restart\n```\n\n#### 登陆\n第一次用域名登录gitlab，需要为root用户修改密码，root用户也是gitlab的超级管理员，gitlab也支持修改中文界面，如下图所示\n![](/images/pic/welcome-gitlab.png)\n\n![](/images/pic/language.png)\n\n**更多关于gitlab配置信息参数，请参考官网[GitLab配置文件](https://docs.gitlab.com/omnibus/settings/README.html)**\n\n---\n### Docker方式安装\n#### GitLab docker 镜像\ngitlab-ce镜像存放在[docker官方仓库](https://hub.docker.com/r/gitlab/gitlab-ce/)中。\n\nGitLab Docker镜像是GitLab的单个镜像，在单个容器上运行所有必要的服务。\n在以下示例中，我们使用GitLab CE的镜像。如果要使用最新的RC映像，请使用`gitlab/gitlab-ce:rc` 用于GitLab CE\nGitLab Docker镜像可以多种方式运行：\n* [在Docker Engine中运行映像](https://docs.gitlab.com/omnibus/docker/#run-the-image)\n* [将GitLab安装到群集中](https://docs.gitlab.com/omnibus/docker/#install-gitlab-into-a-cluster)\n* [使用docker-compose安装GitLab](https://docs.gitlab.com/omnibus/docker/#install-gitlab-using-docker-compose)\n\n**本文档以第一种方式在docker中运行，如你需要高可用可以用第二种，甚至是通过kubenetes deplyment部署pod方式安装。**\n\n#### 先决条件\n需要先安装docker，请参考[docker-ce安装](https://www.ipyker.com/2019/03/21/centos7-install-docker-ce/)\n\n#### 运行gitlab-ce容器\n```bash\n$ docker run -d \\\n  --hostname gitlab.example.com \\\n  --publish 443:443 --publish 80:80 --publish 22:22 \\\n  --name gitlab \\\n  --restart always \\\n  --volume /srv/gitlab/config:/etc/gitlab \\\n  --volume /srv/gitlab/logs:/var/log/gitlab \\\n  --volume /srv/gitlab/data:/var/opt/gitlab \\\n  gitlab/gitlab-ce:latest\n```\n>`docker run` 命令将直接拉取镜像和运行容器，相当于运行docker pull和docker start两条命令。gitlab-ce容器将制定域名，开放的端口，以及容器挂载本地的文件系统，所有GitLab数据都将存储为子目录 /srv/gitlab/。restart系统重启后，容器将自动运行。\n\n宿主目录 | docker目录 | 用途\n--- | --- | ---\n/srv/gitlab/data | /var/opt/gitlab | 用于存储应用数据\n/srv/gitlab/logs | /var/log/gitlab | 用于存储日志\n/srv/gitlab/config | /etc/gitlab | 用于存储GitLab配置文件\n\n#### 配置girlab-ce\n此容器使用官方的Omnibus GitLab软件包，因此所有配置都在docker唯一的配置文件中完成/etc/gitlab/gitlab.rb，也可以通过修改挂载卷文件来完成。\n\n要访问GitLab的配置文件，您可以在正在运行的容器的上下文中启动shell会话。这将允许您浏览所有目录并使用您喜欢的文本编辑器：\n```bash\n$ docker exec -it gitlab /bin/bash\n```\n打开后，请`/etc/gitlab/gitlab.rb` 确保将指针设置`external_url` 为有效的URL。\n\n此外您可以通过将环境变量添加`GITLAB_OMNIBUS_CONFIG` 到docker run命令来预配置GitLab Docker映像。此变量可以包含任何gitlab.rb设置，并在加载容器gitlab.rb文件之前进行评估。这样，您可以轻松配置GitLab的外部URL，从[Omnibus GitLab](https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template)模板进行任何数据库配置或任何其他选项 。\n注意：包含的设置`GITLAB_OMNIBUS_CONFIG` 不会写入gitlab.rb配置文件，而是在加载时进行评估。\n这是一个设置外部URL并在启动容器时启用LFS的示例：\n```bash\n$ docker run -d \\\n  --hostname gitlab.example.com \\\n  --env GITLAB_OMNIBUS_CONFIG=\"external_url 'http://my.domain.com/'; gitlab_rails['lfs_enabled'] = true;\" \\\n  --publish 443:443 --publish 80:80 --publish 22:22 \\\n  --name gitlab \\\n  --restart always \\\n  --volume /srv/gitlab/config:/etc/gitlab \\\n  --volume /srv/gitlab/logs:/var/log/gitlab \\\n  --volume /srv/gitlab/data:/var/opt/gitlab \\\n  gitlab/gitlab-ce:latest\n```\n\n\n**要从GitLab接收电子邮件，您必须配置 SMTP设置，因为GitLab Docker映像没有安装SMTP服务器。默认也为HTTP，还可以启动https访问。**\n\n#### 重启gitlab-ce\n完成所需的所有更改后，需要重新启动容器才能重新配置GitLab：\n```bash\n$ docker restart gitlab\n```\n\n#### 手动配置HTTPS\n默认情况下，omnibus-gitlab不使用HTTPS。如果要为gitlab.example.com启用HTTPS，请将以下语句添加到`/etc/gitlab/gitlab.rb` ：\n```\nexternal_url \"https://gitlab.example.com\"\n```\n因为在我们的例子中，主机名是“gitlab.example.com”，所以创建`/etc/gitlab/ssl` 目录并在那里复制密钥和证书。\n```bash\n$ sudo mkdir -p /etc/gitlab/ssl\n$ sudo chmod 700 /etc/gitlab/ssl\n$ sudo cp gitlab.example.com.key gitlab.example.com.crt /etc/gitlab/ssl/\n```\n\n重新加载配置，当重新配置完成时，您的GitLab实例应该可以访问https://gitlab.example.com。\n```bash\n$ gitlab-ctl reconfigure\n```\n>如果certificate.key文件有设置密码，Nginx在`sudo gitlab-ctl reconfigure` 执行时不会要求输入密码。在这种情况下，Omnibus GitLab将无声地失败，没有错误消息。要从密钥中删除密码，请使用以下命令： `openssl rsa -in certificate_before.key -out certificate_after.key` 。","slug":"install-gitlab-ce","published":1,"updated":"2019-05-28T02:02:23.505Z","_id":"cjw6jleyo000ep4n7yaqnmszi","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>常见的git环境有git web版和gitolite版本，gitolite权限控制强大，但功能不完善，而git web(gitlab)虽然权限没有像gitolite分的那么细，但是功能异常强大，不仅支持SSH KEY、web密码方式还有CI/CD，PIPELINE功能。所以下文将介绍如何在公司内网搭建私有的gitlab环境。</p>\n<blockquote>\n<p>GitLab官网强烈建议安装Omnibus软件包，因为它安装更快，更易于升级，并且包含增强其他方法所没有的可靠性的功能。我们还强烈建议<code>至少4GB</code>的可用内存` 来运行GitLab。</p>\n</blockquote>\n<h2 id=\"GitLab的安装\"><a href=\"#GitLab的安装\" class=\"headerlink\" title=\"GitLab的安装\"></a>GitLab的安装</h2><h3 id=\"Omnibus方式安装\"><a href=\"#Omnibus方式安装\" class=\"headerlink\" title=\"Omnibus方式安装\"></a>Omnibus方式安装</h3><h5 id=\"安装并配置必要的依赖项\"><a href=\"#安装并配置必要的依赖项\" class=\"headerlink\" title=\"安装并配置必要的依赖项\"></a>安装并配置必要的依赖项</h5><p>在CentOS 7（和RedHat / Oracle / Scientific Linux 7）上，执行以下命令。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum install -y curl policycoreutils-python openssh-server</span><br></pre></td></tr></table></figure></p>\n<h5 id=\"更新GitLab国内yum源\"><a href=\"#更新GitLab国内yum源\" class=\"headerlink\" title=\"更新GitLab国内yum源\"></a>更新GitLab国内yum源</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat &gt; /etc/yum.repos.d/gitlab-ce.repo &lt;&lt; EOF</span><br><span class=\"line\">[gitlab-ce]</span><br><span class=\"line\">name=Gitlab CE Repository</span><br><span class=\"line\">baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el<span class=\"variable\">$releasever</span>/</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">enabled=1 </span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h5 id=\"安装GitLab-CE包\"><a href=\"#安装GitLab-CE包\" class=\"headerlink\" title=\"安装GitLab-CE包\"></a>安装GitLab-CE包</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum makecache</span><br><span class=\"line\">$ yum install gitlab-ce -y</span><br></pre></td></tr></table></figure>\n<h5 id=\"配置GitLab-CE域名和邮件通知\"><a href=\"#配置GitLab-CE域名和邮件通知\" class=\"headerlink\" title=\"配置GitLab-CE域名和邮件通知\"></a>配置GitLab-CE域名和邮件通知</h5><p>配置文件为<code>/etc/gitlab/gitlab.rb</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#修改external_url 为你gitlab的访问域名</span></span><br><span class=\"line\">$ vim /etc/gitlab/gitlab.rb</span><br><span class=\"line\">external_url <span class=\"string\">'http://git.ipyker.com'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加gitlab邮件通知配置（大约在/etc/gitlab/gitlab.rb文件的517行）</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_enable'</span>] = <span class=\"literal\">true</span> </span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_address'</span>] = <span class=\"string\">\"smtp.ipyker.com\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_port'</span>] = 465</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_user_name'</span>] = <span class=\"string\">\"gitlab@ipyker.com\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_password'</span>] = <span class=\"string\">\"mypasswd\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_authentication'</span>] = <span class=\"string\">\"login\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_enable_starttls_auto'</span>] = <span class=\"literal\">true</span> </span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_tls'</span>] = <span class=\"literal\">true</span> </span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_from'</span>] = <span class=\"string\">'gitlab@ipyker.com'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_domain'</span>] = <span class=\"string\">\"ipyker.com\"</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p><strong>GitLab安装完后，工作目录默认为：/var/opt/gitlab、/opt/gitlab，配置文件目录为：/etc/gitlab</strong></p>\n</blockquote>\n<h4 id=\"GitLab管理\"><a href=\"#GitLab管理\" class=\"headerlink\" title=\"GitLab管理\"></a>GitLab管理</h4><h5 id=\"重载配置信息\"><a href=\"#重载配置信息\" class=\"headerlink\" title=\"重载配置信息\"></a>重载配置信息</h5><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ </span>gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>\n<h5 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h5><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ gitlab-ctl <span class=\"literal\">start</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"停止\"><a href=\"#停止\" class=\"headerlink\" title=\"停止\"></a>停止</h5><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ gitlab-ctl <span class=\"built_in\">stop</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"重启\"><a href=\"#重启\" class=\"headerlink\" title=\"重启\"></a>重启</h5><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ </span>gitlab-ctl restart</span><br></pre></td></tr></table></figure>\n<h4 id=\"登陆\"><a href=\"#登陆\" class=\"headerlink\" title=\"登陆\"></a>登陆</h4><p>第一次用域名登录gitlab，需要为root用户修改密码，root用户也是gitlab的超级管理员，gitlab也支持修改中文界面，如下图所示<br><img src=\"/images/pic/welcome-gitlab.png\" alt></p>\n<p><img src=\"/images/pic/language.png\" alt></p>\n<p><strong>更多关于gitlab配置信息参数，请参考官网<a href=\"https://docs.gitlab.com/omnibus/settings/README.html\" target=\"_blank\" rel=\"noopener\">GitLab配置文件</a></strong></p>\n<hr>\n<h3 id=\"Docker方式安装\"><a href=\"#Docker方式安装\" class=\"headerlink\" title=\"Docker方式安装\"></a>Docker方式安装</h3><h4 id=\"GitLab-docker-镜像\"><a href=\"#GitLab-docker-镜像\" class=\"headerlink\" title=\"GitLab docker 镜像\"></a>GitLab docker 镜像</h4><p>gitlab-ce镜像存放在<a href=\"https://hub.docker.com/r/gitlab/gitlab-ce/\" target=\"_blank\" rel=\"noopener\">docker官方仓库</a>中。</p>\n<p>GitLab Docker镜像是GitLab的单个镜像，在单个容器上运行所有必要的服务。<br>在以下示例中，我们使用GitLab CE的镜像。如果要使用最新的RC映像，请使用<code>gitlab/gitlab-ce:rc</code> 用于GitLab CE<br>GitLab Docker镜像可以多种方式运行：</p>\n<ul>\n<li><a href=\"https://docs.gitlab.com/omnibus/docker/#run-the-image\" target=\"_blank\" rel=\"noopener\">在Docker Engine中运行映像</a></li>\n<li><a href=\"https://docs.gitlab.com/omnibus/docker/#install-gitlab-into-a-cluster\" target=\"_blank\" rel=\"noopener\">将GitLab安装到群集中</a></li>\n<li><a href=\"https://docs.gitlab.com/omnibus/docker/#install-gitlab-using-docker-compose\" target=\"_blank\" rel=\"noopener\">使用docker-compose安装GitLab</a></li>\n</ul>\n<p><strong>本文档以第一种方式在docker中运行，如你需要高可用可以用第二种，甚至是通过kubenetes deplyment部署pod方式安装。</strong></p>\n<h4 id=\"先决条件\"><a href=\"#先决条件\" class=\"headerlink\" title=\"先决条件\"></a>先决条件</h4><p>需要先安装docker，请参考<a href=\"https://www.ipyker.com/2019/03/21/centos7-install-docker-ce/\">docker-ce安装</a></p>\n<h4 id=\"运行gitlab-ce容器\"><a href=\"#运行gitlab-ce容器\" class=\"headerlink\" title=\"运行gitlab-ce容器\"></a>运行gitlab-ce容器</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run -d \\</span><br><span class=\"line\">  --hostname gitlab.example.com \\</span><br><span class=\"line\">  --publish 443:443 --publish 80:80 --publish 22:22 \\</span><br><span class=\"line\">  --name gitlab \\</span><br><span class=\"line\">  --restart always \\</span><br><span class=\"line\">  --volume /srv/gitlab/config:/etc/gitlab \\</span><br><span class=\"line\">  --volume /srv/gitlab/logs:/var/<span class=\"built_in\">log</span>/gitlab \\</span><br><span class=\"line\">  --volume /srv/gitlab/data:/var/opt/gitlab \\</span><br><span class=\"line\">  gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>docker run</code> 命令将直接拉取镜像和运行容器，相当于运行docker pull和docker start两条命令。gitlab-ce容器将制定域名，开放的端口，以及容器挂载本地的文件系统，所有GitLab数据都将存储为子目录 /srv/gitlab/。restart系统重启后，容器将自动运行。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>宿主目录</th>\n<th>docker目录</th>\n<th>用途</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>/srv/gitlab/data</td>\n<td>/var/opt/gitlab</td>\n<td>用于存储应用数据</td>\n</tr>\n<tr>\n<td>/srv/gitlab/logs</td>\n<td>/var/log/gitlab</td>\n<td>用于存储日志</td>\n</tr>\n<tr>\n<td>/srv/gitlab/config</td>\n<td>/etc/gitlab</td>\n<td>用于存储GitLab配置文件</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"配置girlab-ce\"><a href=\"#配置girlab-ce\" class=\"headerlink\" title=\"配置girlab-ce\"></a>配置girlab-ce</h4><p>此容器使用官方的Omnibus GitLab软件包，因此所有配置都在docker唯一的配置文件中完成/etc/gitlab/gitlab.rb，也可以通过修改挂载卷文件来完成。</p>\n<p>要访问GitLab的配置文件，您可以在正在运行的容器的上下文中启动shell会话。这将允许您浏览所有目录并使用您喜欢的文本编辑器：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker <span class=\"built_in\">exec</span> -it gitlab /bin/bash</span><br></pre></td></tr></table></figure></p>\n<p>打开后，请<code>/etc/gitlab/gitlab.rb</code> 确保将指针设置<code>external_url</code> 为有效的URL。</p>\n<p>此外您可以通过将环境变量添加<code>GITLAB_OMNIBUS_CONFIG</code> 到docker run命令来预配置GitLab Docker映像。此变量可以包含任何gitlab.rb设置，并在加载容器gitlab.rb文件之前进行评估。这样，您可以轻松配置GitLab的外部URL，从<a href=\"https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template\" target=\"_blank\" rel=\"noopener\">Omnibus GitLab</a>模板进行任何数据库配置或任何其他选项 。<br>注意：包含的设置<code>GITLAB_OMNIBUS_CONFIG</code> 不会写入gitlab.rb配置文件，而是在加载时进行评估。<br>这是一个设置外部URL并在启动容器时启用LFS的示例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run -d \\</span><br><span class=\"line\">  --hostname gitlab.example.com \\</span><br><span class=\"line\">  --env GITLAB_OMNIBUS_CONFIG=<span class=\"string\">\"external_url 'http://my.domain.com/'; gitlab_rails['lfs_enabled'] = true;\"</span> \\</span><br><span class=\"line\">  --publish 443:443 --publish 80:80 --publish 22:22 \\</span><br><span class=\"line\">  --name gitlab \\</span><br><span class=\"line\">  --restart always \\</span><br><span class=\"line\">  --volume /srv/gitlab/config:/etc/gitlab \\</span><br><span class=\"line\">  --volume /srv/gitlab/logs:/var/<span class=\"built_in\">log</span>/gitlab \\</span><br><span class=\"line\">  --volume /srv/gitlab/data:/var/opt/gitlab \\</span><br><span class=\"line\">  gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure></p>\n<p><strong>要从GitLab接收电子邮件，您必须配置 SMTP设置，因为GitLab Docker映像没有安装SMTP服务器。默认也为HTTP，还可以启动https访问。</strong></p>\n<h4 id=\"重启gitlab-ce\"><a href=\"#重启gitlab-ce\" class=\"headerlink\" title=\"重启gitlab-ce\"></a>重启gitlab-ce</h4><p>完成所需的所有更改后，需要重新启动容器才能重新配置GitLab：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker restart gitlab</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"手动配置HTTPS\"><a href=\"#手动配置HTTPS\" class=\"headerlink\" title=\"手动配置HTTPS\"></a>手动配置HTTPS</h4><p>默认情况下，omnibus-gitlab不使用HTTPS。如果要为gitlab.example.com启用HTTPS，请将以下语句添加到<code>/etc/gitlab/gitlab.rb</code> ：<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">external_url </span><span class=\"string\">\"https://gitlab.example.com\"</span></span><br></pre></td></tr></table></figure></p>\n<p>因为在我们的例子中，主机名是“gitlab.example.com”，所以创建<code>/etc/gitlab/ssl</code> 目录并在那里复制密钥和证书。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo mkdir -p /etc/gitlab/ssl</span><br><span class=\"line\">$ sudo chmod 700 /etc/gitlab/ssl</span><br><span class=\"line\">$ sudo cp gitlab.example.com.key gitlab.example.com.crt /etc/gitlab/ssl/</span><br></pre></td></tr></table></figure></p>\n<p>重新加载配置，当重新配置完成时，您的GitLab实例应该可以访问<a href=\"https://gitlab.example.com。\" target=\"_blank\" rel=\"noopener\">https://gitlab.example.com。</a><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>如果certificate.key文件有设置密码，Nginx在<code>sudo gitlab-ctl reconfigure</code> 执行时不会要求输入密码。在这种情况下，Omnibus GitLab将无声地失败，没有错误消息。要从密钥中删除密码，请使用以下命令： <code>openssl rsa -in certificate_before.key -out certificate_after.key</code> 。</p>\n</blockquote>\n","site":{"data":{}},"length":4231,"excerpt":"","more":"<p>常见的git环境有git web版和gitolite版本，gitolite权限控制强大，但功能不完善，而git web(gitlab)虽然权限没有像gitolite分的那么细，但是功能异常强大，不仅支持SSH KEY、web密码方式还有CI/CD，PIPELINE功能。所以下文将介绍如何在公司内网搭建私有的gitlab环境。</p>\n<blockquote>\n<p>GitLab官网强烈建议安装Omnibus软件包，因为它安装更快，更易于升级，并且包含增强其他方法所没有的可靠性的功能。我们还强烈建议<code>至少4GB</code>的可用内存` 来运行GitLab。</p>\n</blockquote>\n<h2 id=\"GitLab的安装\"><a href=\"#GitLab的安装\" class=\"headerlink\" title=\"GitLab的安装\"></a>GitLab的安装</h2><h3 id=\"Omnibus方式安装\"><a href=\"#Omnibus方式安装\" class=\"headerlink\" title=\"Omnibus方式安装\"></a>Omnibus方式安装</h3><h5 id=\"安装并配置必要的依赖项\"><a href=\"#安装并配置必要的依赖项\" class=\"headerlink\" title=\"安装并配置必要的依赖项\"></a>安装并配置必要的依赖项</h5><p>在CentOS 7（和RedHat / Oracle / Scientific Linux 7）上，执行以下命令。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum install -y curl policycoreutils-python openssh-server</span><br></pre></td></tr></table></figure></p>\n<h5 id=\"更新GitLab国内yum源\"><a href=\"#更新GitLab国内yum源\" class=\"headerlink\" title=\"更新GitLab国内yum源\"></a>更新GitLab国内yum源</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat &gt; /etc/yum.repos.d/gitlab-ce.repo &lt;&lt; EOF</span><br><span class=\"line\">[gitlab-ce]</span><br><span class=\"line\">name=Gitlab CE Repository</span><br><span class=\"line\">baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el<span class=\"variable\">$releasever</span>/</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">enabled=1 </span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h5 id=\"安装GitLab-CE包\"><a href=\"#安装GitLab-CE包\" class=\"headerlink\" title=\"安装GitLab-CE包\"></a>安装GitLab-CE包</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum makecache</span><br><span class=\"line\">$ yum install gitlab-ce -y</span><br></pre></td></tr></table></figure>\n<h5 id=\"配置GitLab-CE域名和邮件通知\"><a href=\"#配置GitLab-CE域名和邮件通知\" class=\"headerlink\" title=\"配置GitLab-CE域名和邮件通知\"></a>配置GitLab-CE域名和邮件通知</h5><p>配置文件为<code>/etc/gitlab/gitlab.rb</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#修改external_url 为你gitlab的访问域名</span></span><br><span class=\"line\">$ vim /etc/gitlab/gitlab.rb</span><br><span class=\"line\">external_url <span class=\"string\">'http://git.ipyker.com'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加gitlab邮件通知配置（大约在/etc/gitlab/gitlab.rb文件的517行）</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_enable'</span>] = <span class=\"literal\">true</span> </span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_address'</span>] = <span class=\"string\">\"smtp.ipyker.com\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_port'</span>] = 465</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_user_name'</span>] = <span class=\"string\">\"gitlab@ipyker.com\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_password'</span>] = <span class=\"string\">\"mypasswd\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_authentication'</span>] = <span class=\"string\">\"login\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_enable_starttls_auto'</span>] = <span class=\"literal\">true</span> </span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_tls'</span>] = <span class=\"literal\">true</span> </span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_from'</span>] = <span class=\"string\">'gitlab@ipyker.com'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_domain'</span>] = <span class=\"string\">\"ipyker.com\"</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p><strong>GitLab安装完后，工作目录默认为：/var/opt/gitlab、/opt/gitlab，配置文件目录为：/etc/gitlab</strong></p>\n</blockquote>\n<h4 id=\"GitLab管理\"><a href=\"#GitLab管理\" class=\"headerlink\" title=\"GitLab管理\"></a>GitLab管理</h4><h5 id=\"重载配置信息\"><a href=\"#重载配置信息\" class=\"headerlink\" title=\"重载配置信息\"></a>重载配置信息</h5><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ </span>gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>\n<h5 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h5><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ gitlab-ctl <span class=\"literal\">start</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"停止\"><a href=\"#停止\" class=\"headerlink\" title=\"停止\"></a>停止</h5><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ gitlab-ctl <span class=\"built_in\">stop</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"重启\"><a href=\"#重启\" class=\"headerlink\" title=\"重启\"></a>重启</h5><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ </span>gitlab-ctl restart</span><br></pre></td></tr></table></figure>\n<h4 id=\"登陆\"><a href=\"#登陆\" class=\"headerlink\" title=\"登陆\"></a>登陆</h4><p>第一次用域名登录gitlab，需要为root用户修改密码，root用户也是gitlab的超级管理员，gitlab也支持修改中文界面，如下图所示<br><img src=\"/images/pic/welcome-gitlab.png\" alt></p>\n<p><img src=\"/images/pic/language.png\" alt></p>\n<p><strong>更多关于gitlab配置信息参数，请参考官网<a href=\"https://docs.gitlab.com/omnibus/settings/README.html\" target=\"_blank\" rel=\"noopener\">GitLab配置文件</a></strong></p>\n<hr>\n<h3 id=\"Docker方式安装\"><a href=\"#Docker方式安装\" class=\"headerlink\" title=\"Docker方式安装\"></a>Docker方式安装</h3><h4 id=\"GitLab-docker-镜像\"><a href=\"#GitLab-docker-镜像\" class=\"headerlink\" title=\"GitLab docker 镜像\"></a>GitLab docker 镜像</h4><p>gitlab-ce镜像存放在<a href=\"https://hub.docker.com/r/gitlab/gitlab-ce/\" target=\"_blank\" rel=\"noopener\">docker官方仓库</a>中。</p>\n<p>GitLab Docker镜像是GitLab的单个镜像，在单个容器上运行所有必要的服务。<br>在以下示例中，我们使用GitLab CE的镜像。如果要使用最新的RC映像，请使用<code>gitlab/gitlab-ce:rc</code> 用于GitLab CE<br>GitLab Docker镜像可以多种方式运行：</p>\n<ul>\n<li><a href=\"https://docs.gitlab.com/omnibus/docker/#run-the-image\" target=\"_blank\" rel=\"noopener\">在Docker Engine中运行映像</a></li>\n<li><a href=\"https://docs.gitlab.com/omnibus/docker/#install-gitlab-into-a-cluster\" target=\"_blank\" rel=\"noopener\">将GitLab安装到群集中</a></li>\n<li><a href=\"https://docs.gitlab.com/omnibus/docker/#install-gitlab-using-docker-compose\" target=\"_blank\" rel=\"noopener\">使用docker-compose安装GitLab</a></li>\n</ul>\n<p><strong>本文档以第一种方式在docker中运行，如你需要高可用可以用第二种，甚至是通过kubenetes deplyment部署pod方式安装。</strong></p>\n<h4 id=\"先决条件\"><a href=\"#先决条件\" class=\"headerlink\" title=\"先决条件\"></a>先决条件</h4><p>需要先安装docker，请参考<a href=\"https://www.ipyker.com/2019/03/21/centos7-install-docker-ce/\">docker-ce安装</a></p>\n<h4 id=\"运行gitlab-ce容器\"><a href=\"#运行gitlab-ce容器\" class=\"headerlink\" title=\"运行gitlab-ce容器\"></a>运行gitlab-ce容器</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run -d \\</span><br><span class=\"line\">  --hostname gitlab.example.com \\</span><br><span class=\"line\">  --publish 443:443 --publish 80:80 --publish 22:22 \\</span><br><span class=\"line\">  --name gitlab \\</span><br><span class=\"line\">  --restart always \\</span><br><span class=\"line\">  --volume /srv/gitlab/config:/etc/gitlab \\</span><br><span class=\"line\">  --volume /srv/gitlab/logs:/var/<span class=\"built_in\">log</span>/gitlab \\</span><br><span class=\"line\">  --volume /srv/gitlab/data:/var/opt/gitlab \\</span><br><span class=\"line\">  gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>docker run</code> 命令将直接拉取镜像和运行容器，相当于运行docker pull和docker start两条命令。gitlab-ce容器将制定域名，开放的端口，以及容器挂载本地的文件系统，所有GitLab数据都将存储为子目录 /srv/gitlab/。restart系统重启后，容器将自动运行。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>宿主目录</th>\n<th>docker目录</th>\n<th>用途</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>/srv/gitlab/data</td>\n<td>/var/opt/gitlab</td>\n<td>用于存储应用数据</td>\n</tr>\n<tr>\n<td>/srv/gitlab/logs</td>\n<td>/var/log/gitlab</td>\n<td>用于存储日志</td>\n</tr>\n<tr>\n<td>/srv/gitlab/config</td>\n<td>/etc/gitlab</td>\n<td>用于存储GitLab配置文件</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"配置girlab-ce\"><a href=\"#配置girlab-ce\" class=\"headerlink\" title=\"配置girlab-ce\"></a>配置girlab-ce</h4><p>此容器使用官方的Omnibus GitLab软件包，因此所有配置都在docker唯一的配置文件中完成/etc/gitlab/gitlab.rb，也可以通过修改挂载卷文件来完成。</p>\n<p>要访问GitLab的配置文件，您可以在正在运行的容器的上下文中启动shell会话。这将允许您浏览所有目录并使用您喜欢的文本编辑器：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker <span class=\"built_in\">exec</span> -it gitlab /bin/bash</span><br></pre></td></tr></table></figure></p>\n<p>打开后，请<code>/etc/gitlab/gitlab.rb</code> 确保将指针设置<code>external_url</code> 为有效的URL。</p>\n<p>此外您可以通过将环境变量添加<code>GITLAB_OMNIBUS_CONFIG</code> 到docker run命令来预配置GitLab Docker映像。此变量可以包含任何gitlab.rb设置，并在加载容器gitlab.rb文件之前进行评估。这样，您可以轻松配置GitLab的外部URL，从<a href=\"https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template\" target=\"_blank\" rel=\"noopener\">Omnibus GitLab</a>模板进行任何数据库配置或任何其他选项 。<br>注意：包含的设置<code>GITLAB_OMNIBUS_CONFIG</code> 不会写入gitlab.rb配置文件，而是在加载时进行评估。<br>这是一个设置外部URL并在启动容器时启用LFS的示例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run -d \\</span><br><span class=\"line\">  --hostname gitlab.example.com \\</span><br><span class=\"line\">  --env GITLAB_OMNIBUS_CONFIG=<span class=\"string\">\"external_url 'http://my.domain.com/'; gitlab_rails['lfs_enabled'] = true;\"</span> \\</span><br><span class=\"line\">  --publish 443:443 --publish 80:80 --publish 22:22 \\</span><br><span class=\"line\">  --name gitlab \\</span><br><span class=\"line\">  --restart always \\</span><br><span class=\"line\">  --volume /srv/gitlab/config:/etc/gitlab \\</span><br><span class=\"line\">  --volume /srv/gitlab/logs:/var/<span class=\"built_in\">log</span>/gitlab \\</span><br><span class=\"line\">  --volume /srv/gitlab/data:/var/opt/gitlab \\</span><br><span class=\"line\">  gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure></p>\n<p><strong>要从GitLab接收电子邮件，您必须配置 SMTP设置，因为GitLab Docker映像没有安装SMTP服务器。默认也为HTTP，还可以启动https访问。</strong></p>\n<h4 id=\"重启gitlab-ce\"><a href=\"#重启gitlab-ce\" class=\"headerlink\" title=\"重启gitlab-ce\"></a>重启gitlab-ce</h4><p>完成所需的所有更改后，需要重新启动容器才能重新配置GitLab：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker restart gitlab</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"手动配置HTTPS\"><a href=\"#手动配置HTTPS\" class=\"headerlink\" title=\"手动配置HTTPS\"></a>手动配置HTTPS</h4><p>默认情况下，omnibus-gitlab不使用HTTPS。如果要为gitlab.example.com启用HTTPS，请将以下语句添加到<code>/etc/gitlab/gitlab.rb</code> ：<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">external_url </span><span class=\"string\">\"https://gitlab.example.com\"</span></span><br></pre></td></tr></table></figure></p>\n<p>因为在我们的例子中，主机名是“gitlab.example.com”，所以创建<code>/etc/gitlab/ssl</code> 目录并在那里复制密钥和证书。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo mkdir -p /etc/gitlab/ssl</span><br><span class=\"line\">$ sudo chmod 700 /etc/gitlab/ssl</span><br><span class=\"line\">$ sudo cp gitlab.example.com.key gitlab.example.com.crt /etc/gitlab/ssl/</span><br></pre></td></tr></table></figure></p>\n<p>重新加载配置，当重新配置完成时，您的GitLab实例应该可以访问<a href=\"https://gitlab.example.com。\" target=\"_blank\" rel=\"noopener\">https://gitlab.example.com。</a><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>如果certificate.key文件有设置密码，Nginx在<code>sudo gitlab-ctl reconfigure</code> 执行时不会要求输入密码。在这种情况下，Omnibus GitLab将无声地失败，没有错误消息。要从密钥中删除密码，请使用以下命令： <code>openssl rsa -in certificate_before.key -out certificate_after.key</code> 。</p>\n</blockquote>\n"},{"layout":"post","title":"Nginx内置变量","author":"Pyker","img":"/images/bar/nginx-variable.jpg","top":false,"cover":false,"date":"2018-01-23T13:18:00.000Z","_content":"## Nginx 内置变量解释\n为了方便配置和使用nginx，nginx核心模块ngx_http_core_module自带有许多内置的人性化变量，这极大的方便了系统管理员对nginx维护和管理。下面我们详解注解内置变量的含义（当然，如果你懂点HTTP知识的话，就更好理解了）：\n```\n$args                    #请求中的参数值\n$query_string            #同 $args\n$arg_NAME                #GET请求中NAME的值\n$is_args                 #如果请求中有参数，值为\"?\"，否则为空字符串\n$uri                     #请求中的当前URI(不带请求参数，参数位于$args)，可以不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改，$uri不包含主机名，如\"/foo/bar.html\"。\n$document_uri            #同 $uri\n$document_root           #当前请求的文档根目录或别名\n$host                    #优先级：HTTP请求行的主机名>\"HOST\"请求头字段>符合请求的服务器名\n$hostname                #主机名\n$https                   #如果开启了SSL安全模式，值为\"on\"，否则为空字符串。\n$binary_remote_addr      #客户端地址的二进制形式，固定长度为4个字节\n$body_bytes_sent         #传输给客户端的字节数，响应头不计算在内；这个变量和Apache的mod_log_config模块中的\"%B\"参数保持兼容\n$bytes_sent              #传输给客户端的字节数\n$connection              #TCP连接的序列号\n$connection_requests     #TCP连接当前的请求数量\n$content_length          #\"Content-Length\" 请求头字段\n$content_type            #\"Content-Type\" 请求头字段\n$cookie_name             #cookie名称\n$limit_rate              #用于设置响应的速度限制\n$msec                    #当前的Unix时间戳\n$nginx_version           #nginx版本\n$pid                     #工作进程的PID\n$pipe                    #如果请求来自管道通信，值为\"p\"，否则为\".\"\n$proxy_protocol_addr     #获取代理访问服务器的客户端地址，如果是直接访问，该值为空字符串\n$realpath_root           #当前请求的文档根目录或别名的真实路径，会将所有符号连接转换为真实路径\n$remote_addr             #客户端地址\n$remote_port             #客户端端口\n$remote_user             #用于HTTP基础认证服务的用户名\n$request                 #代表客户端的请求地址\n$request_body            #客户端的请求主体：此变量可在location中使用，将请求主体通过proxy_pass，fastcgi_pass，uwsgi_pass和scgi_pass传递给下一级的代理服务器\n$request_body_file       #将客户端请求主体保存在临时文件中。文件处理结束后，此文件需删除。如果需要之一开启此功能，需要设置client_body_in_file_only。如果将次文件传递给后端的代理服务器，需要禁用request body，即设置proxy_pass_request_body off，fastcgi_pass_request_body off，uwsgi_pass_request_body off，or scgi_pass_request_body off\n$request_completion      #如果请求成功，值为\"OK\"，如果请求未完成或者请求不是一个范围请求的最后一部分，则为空\n$request_filename        #当前连接请求的文件路径，由root或alias指令与URI请求生成\n$request_length          #请求的长度 (包括请求的地址，http请求头和请求主体)\n$request_method          #HTTP请求方法，通常为\"GET\"或\"POST\"\n$request_time            #处理客户端请求使用的时间; 从读取客户端的第一个字节开始计时\n$request_uri             #这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI，不包含主机名，例如：\"/cnphp/test.php?arg=freemouse\"\n$scheme                  #请求使用的Web协议，\"http\" 或 \"https\"\n$server_addr             #服务器端地址，需要注意的是：为了避免访问linux系统内核，应将ip地址提前设置在配置文件中\n$server_name             #服务器名\n$server_port             #服务器端口\n$server_protocol         #服务器的HTTP版本，通常为 \"HTTP/1.0\" 或 \"HTTP/1.1\"\n$status                  #HTTP响应代码\n$time_iso8601            #服务器时间的ISO 8610格式\n$time_local              #服务器时间（LOG Format 格式）\n$cookie_NAME             #客户端请求Header头中的cookie变量，前缀\"$cookie_\"加上cookie名称的变量，该变量的值即为cookie名称的值\n$http_NAME               #匹配任意请求头字段；变量名中的后半部分NAME可以替换成任意请求头字段，如在配置文件中需要获取http请求头：\"Accept-Language\"，$http_accept_language即可\n$http_cookie\n$http_post\n$http_referer\t\t\t#url跳转来源 （https://www.baidu.com/）\n$http_user_agent\t\t#用户终端浏览器等信息 （\"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; SV1; GTB7.0; .NET4.0C;）\n$http_x_forwarded_for\t#获取到最原始用户IP，或者代理IP地址。\n$sent_http_NAME\t\t\t#可以设置任意http响应头字段；变量名中的后半部分NAME可以替换成任意响应头字段，如需要设置响应头Content-length，$sent_http_content_length即可\n$upstream_response_time\t#请求过程中，upstream响应时间（0.002）\n$upstream_addr\t\t\t#后台upstream的地址，即真正提供服务的主机地址 （10.10.10.100:80）\n$upstream_status\t\t#upstream状态 （200）\n$sent_http_cache_control\n$sent_http_connection\n$sent_http_content_type\n$sent_http_keep_alive\n$sent_http_last_modified\n$sent_http_location\n$sent_http_transfer_encoding\n```\n这些变量可以在配置文件中使用，方便你做各种nginx页面代理，转换，重写，重定向等操作；而且还可以对nginx日志做自定义的日志配置，方便你对nginx日志的收集和分析。如常用的nginx日志格式：\n```\nlog_format  main  '$remote_addr $remote_user [$time_local] \"$request\" '\n                  '$status $body_bytes_sent \"$http_referer\" '\n                  '$http_user_agent $http_x_forwarded_for $request_time $upstream_response_time $upstream_addr $upstream_status';\n\n```\n日志截取如下（可以从日志中看到代理到后端哪台机器上的哪个端口上，负载访问的状态值等都能看到）：\n```\n[root@nginx1 logs]# tail -f /data/wwwlogs/access.log\n...\n110.156.114.121 - [11/Aug/2017:09:57:19 +0800] \"GET /rest/mywork/latest/status/notification/count?_\n=1502416641768 HTTP/1.1\" 200 67 \"http://wiki.wang-inc.com/pages/viewpage.action?pageId=11174759\" \nMozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.78 Safari/537.36 - \n0.006 0.006 12.129.120.121:8090 200\n```","source":"_posts/nginx-variable.md","raw":"layout: post\ntitle: Nginx内置变量\nauthor: Pyker\ncategories: web\nimg: /images/bar/nginx-variable.jpg\ntags:\n  - nginx\ntop: false\ncover: false\ndate: 2018-01-23 21:18:00\n---\n## Nginx 内置变量解释\n为了方便配置和使用nginx，nginx核心模块ngx_http_core_module自带有许多内置的人性化变量，这极大的方便了系统管理员对nginx维护和管理。下面我们详解注解内置变量的含义（当然，如果你懂点HTTP知识的话，就更好理解了）：\n```\n$args                    #请求中的参数值\n$query_string            #同 $args\n$arg_NAME                #GET请求中NAME的值\n$is_args                 #如果请求中有参数，值为\"?\"，否则为空字符串\n$uri                     #请求中的当前URI(不带请求参数，参数位于$args)，可以不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改，$uri不包含主机名，如\"/foo/bar.html\"。\n$document_uri            #同 $uri\n$document_root           #当前请求的文档根目录或别名\n$host                    #优先级：HTTP请求行的主机名>\"HOST\"请求头字段>符合请求的服务器名\n$hostname                #主机名\n$https                   #如果开启了SSL安全模式，值为\"on\"，否则为空字符串。\n$binary_remote_addr      #客户端地址的二进制形式，固定长度为4个字节\n$body_bytes_sent         #传输给客户端的字节数，响应头不计算在内；这个变量和Apache的mod_log_config模块中的\"%B\"参数保持兼容\n$bytes_sent              #传输给客户端的字节数\n$connection              #TCP连接的序列号\n$connection_requests     #TCP连接当前的请求数量\n$content_length          #\"Content-Length\" 请求头字段\n$content_type            #\"Content-Type\" 请求头字段\n$cookie_name             #cookie名称\n$limit_rate              #用于设置响应的速度限制\n$msec                    #当前的Unix时间戳\n$nginx_version           #nginx版本\n$pid                     #工作进程的PID\n$pipe                    #如果请求来自管道通信，值为\"p\"，否则为\".\"\n$proxy_protocol_addr     #获取代理访问服务器的客户端地址，如果是直接访问，该值为空字符串\n$realpath_root           #当前请求的文档根目录或别名的真实路径，会将所有符号连接转换为真实路径\n$remote_addr             #客户端地址\n$remote_port             #客户端端口\n$remote_user             #用于HTTP基础认证服务的用户名\n$request                 #代表客户端的请求地址\n$request_body            #客户端的请求主体：此变量可在location中使用，将请求主体通过proxy_pass，fastcgi_pass，uwsgi_pass和scgi_pass传递给下一级的代理服务器\n$request_body_file       #将客户端请求主体保存在临时文件中。文件处理结束后，此文件需删除。如果需要之一开启此功能，需要设置client_body_in_file_only。如果将次文件传递给后端的代理服务器，需要禁用request body，即设置proxy_pass_request_body off，fastcgi_pass_request_body off，uwsgi_pass_request_body off，or scgi_pass_request_body off\n$request_completion      #如果请求成功，值为\"OK\"，如果请求未完成或者请求不是一个范围请求的最后一部分，则为空\n$request_filename        #当前连接请求的文件路径，由root或alias指令与URI请求生成\n$request_length          #请求的长度 (包括请求的地址，http请求头和请求主体)\n$request_method          #HTTP请求方法，通常为\"GET\"或\"POST\"\n$request_time            #处理客户端请求使用的时间; 从读取客户端的第一个字节开始计时\n$request_uri             #这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI，不包含主机名，例如：\"/cnphp/test.php?arg=freemouse\"\n$scheme                  #请求使用的Web协议，\"http\" 或 \"https\"\n$server_addr             #服务器端地址，需要注意的是：为了避免访问linux系统内核，应将ip地址提前设置在配置文件中\n$server_name             #服务器名\n$server_port             #服务器端口\n$server_protocol         #服务器的HTTP版本，通常为 \"HTTP/1.0\" 或 \"HTTP/1.1\"\n$status                  #HTTP响应代码\n$time_iso8601            #服务器时间的ISO 8610格式\n$time_local              #服务器时间（LOG Format 格式）\n$cookie_NAME             #客户端请求Header头中的cookie变量，前缀\"$cookie_\"加上cookie名称的变量，该变量的值即为cookie名称的值\n$http_NAME               #匹配任意请求头字段；变量名中的后半部分NAME可以替换成任意请求头字段，如在配置文件中需要获取http请求头：\"Accept-Language\"，$http_accept_language即可\n$http_cookie\n$http_post\n$http_referer\t\t\t#url跳转来源 （https://www.baidu.com/）\n$http_user_agent\t\t#用户终端浏览器等信息 （\"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; SV1; GTB7.0; .NET4.0C;）\n$http_x_forwarded_for\t#获取到最原始用户IP，或者代理IP地址。\n$sent_http_NAME\t\t\t#可以设置任意http响应头字段；变量名中的后半部分NAME可以替换成任意响应头字段，如需要设置响应头Content-length，$sent_http_content_length即可\n$upstream_response_time\t#请求过程中，upstream响应时间（0.002）\n$upstream_addr\t\t\t#后台upstream的地址，即真正提供服务的主机地址 （10.10.10.100:80）\n$upstream_status\t\t#upstream状态 （200）\n$sent_http_cache_control\n$sent_http_connection\n$sent_http_content_type\n$sent_http_keep_alive\n$sent_http_last_modified\n$sent_http_location\n$sent_http_transfer_encoding\n```\n这些变量可以在配置文件中使用，方便你做各种nginx页面代理，转换，重写，重定向等操作；而且还可以对nginx日志做自定义的日志配置，方便你对nginx日志的收集和分析。如常用的nginx日志格式：\n```\nlog_format  main  '$remote_addr $remote_user [$time_local] \"$request\" '\n                  '$status $body_bytes_sent \"$http_referer\" '\n                  '$http_user_agent $http_x_forwarded_for $request_time $upstream_response_time $upstream_addr $upstream_status';\n\n```\n日志截取如下（可以从日志中看到代理到后端哪台机器上的哪个端口上，负载访问的状态值等都能看到）：\n```\n[root@nginx1 logs]# tail -f /data/wwwlogs/access.log\n...\n110.156.114.121 - [11/Aug/2017:09:57:19 +0800] \"GET /rest/mywork/latest/status/notification/count?_\n=1502416641768 HTTP/1.1\" 200 67 \"http://wiki.wang-inc.com/pages/viewpage.action?pageId=11174759\" \nMozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.78 Safari/537.36 - \n0.006 0.006 12.129.120.121:8090 200\n```","slug":"nginx-variable","published":1,"updated":"2019-05-28T02:02:23.507Z","_id":"cjw6jleyp000fp4n70fhjbu6m","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"Nginx-内置变量解释\"><a href=\"#Nginx-内置变量解释\" class=\"headerlink\" title=\"Nginx 内置变量解释\"></a>Nginx 内置变量解释</h2><p>为了方便配置和使用nginx，nginx核心模块ngx_http_core_module自带有许多内置的人性化变量，这极大的方便了系统管理员对nginx维护和管理。下面我们详解注解内置变量的含义（当然，如果你懂点HTTP知识的话，就更好理解了）：<br><figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$args</span>                    #请求中的参数值</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$query</span>_string            #同 $args</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$arg</span>_NAME                #GET请求中NAME的值</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$is</span>_args                 #如果请求中有参数，值为\"?\"，否则为空字符串</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$uri</span>                     #请求中的当前URI(不带请求参数，参数位于$args)，可以不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改，$uri不包含主机名，如\"/foo/bar.html\"。</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$document</span>_uri            #同 $uri</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$document</span>_root           #当前请求的文档根目录或别名</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$host</span>                    #优先级：HTTP请求行的主机名&gt;\"HOST\"请求头字段&gt;符合请求的服务器名</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$hostname</span>                #主机名</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$https</span>                   #如果开启了SSL安全模式，值为\"on\"，否则为空字符串。</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$binary</span>_remote_addr      #客户端地址的二进制形式，固定长度为4个字节</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$body</span>_bytes_sent         #传输给客户端的字节数，响应头不计算在内；这个变量和Apache的mod_log_config模块中的\"%B\"参数保持兼容</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$bytes</span>_sent              #传输给客户端的字节数</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$connection</span>              #TCP连接的序列号</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$connection</span>_requests     #TCP连接当前的请求数量</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$content</span>_length          #\"Content-Length\" 请求头字段</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$content</span>_type            #\"Content-Type\" 请求头字段</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$cookie</span>_name             #cookie名称</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$limit</span>_rate              #用于设置响应的速度限制</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$msec</span>                    #当前的Unix时间戳</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$nginx</span>_version           #nginx版本</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$pid</span>                     #工作进程的PID</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$pipe</span>                    #如果请求来自管道通信，值为\"p\"，否则为\".\"</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$proxy</span>_protocol_addr     #获取代理访问服务器的客户端地址，如果是直接访问，该值为空字符串</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$realpath</span>_root           #当前请求的文档根目录或别名的真实路径，会将所有符号连接转换为真实路径</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$remote</span>_addr             #客户端地址</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$remote</span>_port             #客户端端口</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$remote</span>_user             #用于HTTP基础认证服务的用户名</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>                 #代表客户端的请求地址</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_body            #客户端的请求主体：此变量可在location中使用，将请求主体通过proxy_pass，fastcgi_pass，uwsgi_pass和scgi_pass传递给下一级的代理服务器</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_body_file       #将客户端请求主体保存在临时文件中。文件处理结束后，此文件需删除。如果需要之一开启此功能，需要设置client_body_in_file_only。如果将次文件传递给后端的代理服务器，需要禁用request body，即设置proxy_pass_request_body off，fastcgi_pass_request_body off，uwsgi_pass_request_body off，or scgi_pass_request_body off</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_completion      #如果请求成功，值为\"OK\"，如果请求未完成或者请求不是一个范围请求的最后一部分，则为空</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_filename        #当前连接请求的文件路径，由root或alias指令与URI请求生成</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_length          #请求的长度 (包括请求的地址，http请求头和请求主体)</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_method          #HTTP请求方法，通常为\"GET\"或\"POST\"</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_time            #处理客户端请求使用的时间; 从读取客户端的第一个字节开始计时</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_uri             #这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI，不包含主机名，例如：\"/cnphp/test.php?arg=freemouse\"</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$scheme</span>                  #请求使用的Web协议，\"http\" 或 \"https\"</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$server</span>_addr             #服务器端地址，需要注意的是：为了避免访问linux系统内核，应将ip地址提前设置在配置文件中</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$server</span>_name             #服务器名</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$server</span>_port             #服务器端口</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$server</span>_protocol         #服务器的HTTP版本，通常为 \"HTTP/1.0\" 或 \"HTTP/1.1\"</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$status</span>                  #HTTP响应代码</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$time</span>_iso8601            #服务器时间的ISO 8610格式</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$time</span>_local              #服务器时间（LOG Format 格式）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$cookie</span>_NAME             #客户端请求Header头中的cookie变量，前缀\"$cookie_\"加上cookie名称的变量，该变量的值即为cookie名称的值</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_NAME               #匹配任意请求头字段；变量名中的后半部分NAME可以替换成任意请求头字段，如在配置文件中需要获取http请求头：\"Accept-Language\"，$http_accept_language即可</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_cookie</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_post</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_referer\t\t\t#url跳转来源 （https://www.baidu.com/）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_user_agent\t\t#用户终端浏览器等信息 （\"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; SV1; GTB7.0; .NET4.0C;）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_x_forwarded_for\t#获取到最原始用户IP，或者代理IP地址。</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_NAME\t\t\t#可以设置任意http响应头字段；变量名中的后半部分NAME可以替换成任意响应头字段，如需要设置响应头Content-length，$sent_http_content_length即可</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$upstream</span>_response_time\t#请求过程中，upstream响应时间（0.002）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$upstream</span>_addr\t\t\t#后台upstream的地址，即真正提供服务的主机地址 （10.10.10.100:80）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$upstream</span>_status\t\t#upstream状态 （200）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_cache_control</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_connection</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_content_type</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_keep_alive</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_last_modified</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_location</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_transfer_encoding</span></span><br></pre></td></tr></table></figure></p>\n<p>这些变量可以在配置文件中使用，方便你做各种nginx页面代理，转换，重写，重定向等操作；而且还可以对nginx日志做自定义的日志配置，方便你对nginx日志的收集和分析。如常用的nginx日志格式：<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">log_format</span>  main  <span class=\"string\">'<span class=\"variable\">$remote_addr</span> <span class=\"variable\">$remote_user</span> [<span class=\"variable\">$time_local</span>] \"<span class=\"variable\">$request</span>\" '</span></span><br><span class=\"line\">                  <span class=\"string\">'<span class=\"variable\">$status</span> <span class=\"variable\">$body_bytes_sent</span> \"<span class=\"variable\">$http_referer</span>\" '</span></span><br><span class=\"line\">                  <span class=\"string\">'<span class=\"variable\">$http_user_agent</span> <span class=\"variable\">$http_x_forwarded_for</span> <span class=\"variable\">$request_time</span> <span class=\"variable\">$upstream_response_time</span> <span class=\"variable\">$upstream_addr</span> <span class=\"variable\">$upstream_status</span>'</span>;</span><br></pre></td></tr></table></figure></p>\n<p>日志截取如下（可以从日志中看到代理到后端哪台机器上的哪个端口上，负载访问的状态值等都能看到）：<br><figure class=\"highlight dns\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nginx1 logs]# tail -f /data/wwwlogs/access.log</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"number\">110.156.114.121</span> - [<span class=\"number\">11</span>/Aug/<span class=\"number\">2017:09:57</span>:<span class=\"number\">19</span> +<span class=\"number\">0800</span>] \"GET /rest/mywork/latest/status/notification/count?_</span><br><span class=\"line\">=<span class=\"number\">1502416641768</span> HTTP/<span class=\"number\">1</span>.<span class=\"number\">1</span>\" <span class=\"number\">200</span> <span class=\"number\">67</span> \"http://wiki.wang-inc.com/pages/viewpage.action?pageId=<span class=\"number\">11174759</span>\" </span><br><span class=\"line\">Mozilla/<span class=\"number\">5</span>.<span class=\"number\">0</span> (Windows NT <span class=\"number\">10</span>.<span class=\"number\">0</span><span class=\"comment\">; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.78 Safari/537.36 - </span></span><br><span class=\"line\"><span class=\"number\">0.006 0</span>.<span class=\"number\">006 12.129</span>.<span class=\"number\">120.121:8090</span> <span class=\"number\">200</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"length":4274,"excerpt":"","more":"<h2 id=\"Nginx-内置变量解释\"><a href=\"#Nginx-内置变量解释\" class=\"headerlink\" title=\"Nginx 内置变量解释\"></a>Nginx 内置变量解释</h2><p>为了方便配置和使用nginx，nginx核心模块ngx_http_core_module自带有许多内置的人性化变量，这极大的方便了系统管理员对nginx维护和管理。下面我们详解注解内置变量的含义（当然，如果你懂点HTTP知识的话，就更好理解了）：<br><figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$args</span>                    #请求中的参数值</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$query</span>_string            #同 $args</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$arg</span>_NAME                #GET请求中NAME的值</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$is</span>_args                 #如果请求中有参数，值为\"?\"，否则为空字符串</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$uri</span>                     #请求中的当前URI(不带请求参数，参数位于$args)，可以不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改，$uri不包含主机名，如\"/foo/bar.html\"。</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$document</span>_uri            #同 $uri</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$document</span>_root           #当前请求的文档根目录或别名</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$host</span>                    #优先级：HTTP请求行的主机名&gt;\"HOST\"请求头字段&gt;符合请求的服务器名</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$hostname</span>                #主机名</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$https</span>                   #如果开启了SSL安全模式，值为\"on\"，否则为空字符串。</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$binary</span>_remote_addr      #客户端地址的二进制形式，固定长度为4个字节</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$body</span>_bytes_sent         #传输给客户端的字节数，响应头不计算在内；这个变量和Apache的mod_log_config模块中的\"%B\"参数保持兼容</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$bytes</span>_sent              #传输给客户端的字节数</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$connection</span>              #TCP连接的序列号</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$connection</span>_requests     #TCP连接当前的请求数量</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$content</span>_length          #\"Content-Length\" 请求头字段</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$content</span>_type            #\"Content-Type\" 请求头字段</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$cookie</span>_name             #cookie名称</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$limit</span>_rate              #用于设置响应的速度限制</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$msec</span>                    #当前的Unix时间戳</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$nginx</span>_version           #nginx版本</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$pid</span>                     #工作进程的PID</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$pipe</span>                    #如果请求来自管道通信，值为\"p\"，否则为\".\"</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$proxy</span>_protocol_addr     #获取代理访问服务器的客户端地址，如果是直接访问，该值为空字符串</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$realpath</span>_root           #当前请求的文档根目录或别名的真实路径，会将所有符号连接转换为真实路径</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$remote</span>_addr             #客户端地址</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$remote</span>_port             #客户端端口</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$remote</span>_user             #用于HTTP基础认证服务的用户名</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>                 #代表客户端的请求地址</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_body            #客户端的请求主体：此变量可在location中使用，将请求主体通过proxy_pass，fastcgi_pass，uwsgi_pass和scgi_pass传递给下一级的代理服务器</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_body_file       #将客户端请求主体保存在临时文件中。文件处理结束后，此文件需删除。如果需要之一开启此功能，需要设置client_body_in_file_only。如果将次文件传递给后端的代理服务器，需要禁用request body，即设置proxy_pass_request_body off，fastcgi_pass_request_body off，uwsgi_pass_request_body off，or scgi_pass_request_body off</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_completion      #如果请求成功，值为\"OK\"，如果请求未完成或者请求不是一个范围请求的最后一部分，则为空</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_filename        #当前连接请求的文件路径，由root或alias指令与URI请求生成</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_length          #请求的长度 (包括请求的地址，http请求头和请求主体)</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_method          #HTTP请求方法，通常为\"GET\"或\"POST\"</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_time            #处理客户端请求使用的时间; 从读取客户端的第一个字节开始计时</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$request</span>_uri             #这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI，不包含主机名，例如：\"/cnphp/test.php?arg=freemouse\"</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$scheme</span>                  #请求使用的Web协议，\"http\" 或 \"https\"</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$server</span>_addr             #服务器端地址，需要注意的是：为了避免访问linux系统内核，应将ip地址提前设置在配置文件中</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$server</span>_name             #服务器名</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$server</span>_port             #服务器端口</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$server</span>_protocol         #服务器的HTTP版本，通常为 \"HTTP/1.0\" 或 \"HTTP/1.1\"</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$status</span>                  #HTTP响应代码</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$time</span>_iso8601            #服务器时间的ISO 8610格式</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$time</span>_local              #服务器时间（LOG Format 格式）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$cookie</span>_NAME             #客户端请求Header头中的cookie变量，前缀\"$cookie_\"加上cookie名称的变量，该变量的值即为cookie名称的值</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_NAME               #匹配任意请求头字段；变量名中的后半部分NAME可以替换成任意请求头字段，如在配置文件中需要获取http请求头：\"Accept-Language\"，$http_accept_language即可</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_cookie</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_post</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_referer\t\t\t#url跳转来源 （https://www.baidu.com/）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_user_agent\t\t#用户终端浏览器等信息 （\"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; SV1; GTB7.0; .NET4.0C;）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$http</span>_x_forwarded_for\t#获取到最原始用户IP，或者代理IP地址。</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_NAME\t\t\t#可以设置任意http响应头字段；变量名中的后半部分NAME可以替换成任意响应头字段，如需要设置响应头Content-length，$sent_http_content_length即可</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$upstream</span>_response_time\t#请求过程中，upstream响应时间（0.002）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$upstream</span>_addr\t\t\t#后台upstream的地址，即真正提供服务的主机地址 （10.10.10.100:80）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$upstream</span>_status\t\t#upstream状态 （200）</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_cache_control</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_connection</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_content_type</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_keep_alive</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_last_modified</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_location</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta-keyword\">$sent</span>_http_transfer_encoding</span></span><br></pre></td></tr></table></figure></p>\n<p>这些变量可以在配置文件中使用，方便你做各种nginx页面代理，转换，重写，重定向等操作；而且还可以对nginx日志做自定义的日志配置，方便你对nginx日志的收集和分析。如常用的nginx日志格式：<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">log_format</span>  main  <span class=\"string\">'<span class=\"variable\">$remote_addr</span> <span class=\"variable\">$remote_user</span> [<span class=\"variable\">$time_local</span>] \"<span class=\"variable\">$request</span>\" '</span></span><br><span class=\"line\">                  <span class=\"string\">'<span class=\"variable\">$status</span> <span class=\"variable\">$body_bytes_sent</span> \"<span class=\"variable\">$http_referer</span>\" '</span></span><br><span class=\"line\">                  <span class=\"string\">'<span class=\"variable\">$http_user_agent</span> <span class=\"variable\">$http_x_forwarded_for</span> <span class=\"variable\">$request_time</span> <span class=\"variable\">$upstream_response_time</span> <span class=\"variable\">$upstream_addr</span> <span class=\"variable\">$upstream_status</span>'</span>;</span><br></pre></td></tr></table></figure></p>\n<p>日志截取如下（可以从日志中看到代理到后端哪台机器上的哪个端口上，负载访问的状态值等都能看到）：<br><figure class=\"highlight dns\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nginx1 logs]# tail -f /data/wwwlogs/access.log</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"number\">110.156.114.121</span> - [<span class=\"number\">11</span>/Aug/<span class=\"number\">2017:09:57</span>:<span class=\"number\">19</span> +<span class=\"number\">0800</span>] \"GET /rest/mywork/latest/status/notification/count?_</span><br><span class=\"line\">=<span class=\"number\">1502416641768</span> HTTP/<span class=\"number\">1</span>.<span class=\"number\">1</span>\" <span class=\"number\">200</span> <span class=\"number\">67</span> \"http://wiki.wang-inc.com/pages/viewpage.action?pageId=<span class=\"number\">11174759</span>\" </span><br><span class=\"line\">Mozilla/<span class=\"number\">5</span>.<span class=\"number\">0</span> (Windows NT <span class=\"number\">10</span>.<span class=\"number\">0</span><span class=\"comment\">; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.78 Safari/537.36 - </span></span><br><span class=\"line\"><span class=\"number\">0.006 0</span>.<span class=\"number\">006 12.129</span>.<span class=\"number\">120.121:8090</span> <span class=\"number\">200</span></span><br></pre></td></tr></table></figure></p>\n"},{"layout":"post","title":"systemctl unit服务格式","author":"Pyker","img":"/images/bar/systemctl.jpg","top":false,"cover":false,"date":"2017-11-16T09:10:00.000Z","_content":"systemctl是RHEL 7 的服务管理工具中主要的工具，它融合之前service和chkconfig的功能于一体。可以使用它永久性或只在当前会话中启用/禁用服务。\n## 服务权限\nsystemd有系统和用户区分；系统`/user/lib/systemd/system/`, 用户`/etc/lib/systemd/user/`一般系统管理员手工创建的单元文件建议存放在`/etc/systemd/system/`目录下面。或者`/usr/lib/systemd/system/`下面 ，然后可以通过`systemctl enable xxx.service`方式将该服务添加到`/etc/systemd/system/multi-user.target.wants/`目录下面设置为开机自启动。\n## 格式介绍\nsystemctl的服务文件主要包含`[Unit]`、`[Service]`、`[Install]`三类。下面我们对这三类进行说明。\n### [Unit]\n该部分主要对服务进行说明。\n  * `Description` : 服务的简单描述。\n  * `Documentation` ： 服务文档地址说明。\n  * `Before=xxx.service`：代表本服务在xxx.service启动之前启动。\n  * `After=xxx.service`：代表本服务在xxx.service启动之后启动。\n  * `Requires`： 本服务启动后，它需要的服务也会启动；而本服务需要的服务被停止了，本服务也停止了。\n  * `Wants`： 推荐使用。本服务启动了，它需要的服务也会被启动；而本服务需要的服务被停止了，对本单元没有影响。\n---\n### [Service]\n该部分的配置服务的启动、重启、停止命令全部要求使用绝对路径，使用相对路径则会报错。\n  * `WorkingDirectory`：指定服务运行的工作目录。\n\n  * `EnvironmentFile`：指定服务需要的配置文件，下文可以用`${}`方式引用文件中的值。\n\n  * `Type=simple（默认值）`：systemd认为该服务将立即启动。服务进程不会fork。如果该服务要启动其他服务，不要使用此类型启动，除非该服务是socket激活型。\n\n  * `Type=forking`：systemd认为当该服务进程fork，且父进程退出后服务启动成功。对于常规的守护进程（daemon），除非你确定此启动方式无法满足需求，使用此类型启动即可。**使用此启动类型应同时指定 PIDFile=**，以便systemd能够跟踪服务的主进程。\n\n  * `Type=oneshot`：这一选项适用于只执行一项任务、随后立即退出的服务。可能需要**同时设置 RemainAfterExit=yes** 使得 systemd 在服务进程退出之后仍然认为服务处于激活状态。\n\n  * `Type=notify`：与 Type=simple 相同，但约定服务会在就绪后向 systemd 发送一个信号。这一通知的实现由 libsystemd-daemon.so 提供。\n\n  * `Type=dbus`：若以此方式启动，当指定的 BusName 出现在DBus系统总线上时，systemd认为服务就绪。\n\n  * `Type=idle`: systemd会等待所有任务(Jobs)处理完成后，才开始执行idle类型的单元。除此之外，其他行为和Type=simple 类似。\n\n  * `PIDFile`：指定pid文件路径\n\n  * `ExecStart`：指定启动单元的命令或者脚本\n\n  * `ExecStartPre和ExecStartPost`：指定在执行ExecStart之前或者之后执行用户自定义的脚本，**Type=oneshot**允许用户执行多个按顺序定义的脚本。\n\n  * `ExecReload`：指定单元重载时执行的命令或者脚本。\n\n  * `ExecStop`：指定单元停止时执行的命令或者脚本。\n\n  * `PrivateTmp`：True表示给服务分配独立的临时空间\n\n  * `LimitNOFILE`：设置文件描述符相关参数个数，或者设置为无穷 infinity\n\n  * `LimitNPROC`：设置文件描述符相关参数个数，或者设置为无穷 infinity\n\n  * `LimitCORE`：设置文件描述符相关参数个数，或者设置为无穷 infinity\n\n  * `Restart`：这个选项如果被允许，服务重启的时候进程会退出，会通过systemctl命令执行清除并重启的操作。通常设置为**on-failure**。\n\n  * `RemainAfterExit`：如果设置这个选择为真，服务会被认为是在激活状态，即使所以的进程已经退出，默认的值为假，这个选项只有在Type=oneshot时需要被配置。\n---\n### [Install]\n定义如何安装这个配置文件，即怎样做到开机启动。\n  * `Alias`：为单元提供一个空间分离的附加名字。\n  * `RequiredBy`：单元被允许运行需要的一系列依赖单元，RequiredBy列表从Require获得依赖信息。\n  * `WantBy`：单元被允许运行需要的弱依赖性单元，Wantby从Want列表获得依赖信息。\n  * `Also`：指出和单元一起安装或者被协助的单元。\n  * `DefaultInstance`：实例单元的限制，这个选项指定如果单元被允许运行默认的实例。\n---\n## mysql.service样例\n```bash\n[Unit]\nDescription=MySQL Server\nDocumentation=man:mysqld(8)\nDocumentation=http://dev.mysql.com/doc/refman/en/using-systemd.html\nAfter=network.target\nAfter=syslog.target\n\n[Service]\nUser=mysql\nGroup=mysql\nType=forking\nPIDFile=/var/run/mysqld/mysqld.pid\nTimeoutSec=0\nPermissionsStartOnly=true\nExecStartPre=/usr/bin/mysqld_pre_systemd\nExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid $MYSQLD_OPTS\nEnvironmentFile=-/etc/sysconfig/mysql\nLimitNOFILE = 5000\nRestart=on-failure\nRestartPreventExitStatus=1\nPrivateTmp=false\n\n[Install]\nWantedBy=multi-user.target\n```\n## etcd.service样例\n```bash\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=notify\nWorkingDirectory=/var/lib/etcd/\nEnvironmentFile=-/etc/etcd/etcd.conf          #etcd配置文件路径\nExecStart=/bin/bash -c \"GOMAXPROCS=$(nproc) /usr/bin/etcd --name=\\\"${ETCD_NAME}\\\" --data-dir=\\\"${ETCD_DATA_DIR}\\\" --listen-client-urls=\\\"${ETCD_LISTEN_CLIENT_URLS}\\\"\"\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target    # 说明：其中WorkingDirectory为etcd数据库目录，需要在etcd**安装前创建**\n```\n","source":"_posts/systemctl-unit.md","raw":"layout: post\ntitle: systemctl unit服务格式\nauthor: Pyker\ncategories: Linux\nimg: /images/bar/systemctl.jpg\ntags:\n  - Linux\ntop: false\ncover: false\ndate: 2017-11-16 17:10:00\n---\nsystemctl是RHEL 7 的服务管理工具中主要的工具，它融合之前service和chkconfig的功能于一体。可以使用它永久性或只在当前会话中启用/禁用服务。\n## 服务权限\nsystemd有系统和用户区分；系统`/user/lib/systemd/system/`, 用户`/etc/lib/systemd/user/`一般系统管理员手工创建的单元文件建议存放在`/etc/systemd/system/`目录下面。或者`/usr/lib/systemd/system/`下面 ，然后可以通过`systemctl enable xxx.service`方式将该服务添加到`/etc/systemd/system/multi-user.target.wants/`目录下面设置为开机自启动。\n## 格式介绍\nsystemctl的服务文件主要包含`[Unit]`、`[Service]`、`[Install]`三类。下面我们对这三类进行说明。\n### [Unit]\n该部分主要对服务进行说明。\n  * `Description` : 服务的简单描述。\n  * `Documentation` ： 服务文档地址说明。\n  * `Before=xxx.service`：代表本服务在xxx.service启动之前启动。\n  * `After=xxx.service`：代表本服务在xxx.service启动之后启动。\n  * `Requires`： 本服务启动后，它需要的服务也会启动；而本服务需要的服务被停止了，本服务也停止了。\n  * `Wants`： 推荐使用。本服务启动了，它需要的服务也会被启动；而本服务需要的服务被停止了，对本单元没有影响。\n---\n### [Service]\n该部分的配置服务的启动、重启、停止命令全部要求使用绝对路径，使用相对路径则会报错。\n  * `WorkingDirectory`：指定服务运行的工作目录。\n\n  * `EnvironmentFile`：指定服务需要的配置文件，下文可以用`${}`方式引用文件中的值。\n\n  * `Type=simple（默认值）`：systemd认为该服务将立即启动。服务进程不会fork。如果该服务要启动其他服务，不要使用此类型启动，除非该服务是socket激活型。\n\n  * `Type=forking`：systemd认为当该服务进程fork，且父进程退出后服务启动成功。对于常规的守护进程（daemon），除非你确定此启动方式无法满足需求，使用此类型启动即可。**使用此启动类型应同时指定 PIDFile=**，以便systemd能够跟踪服务的主进程。\n\n  * `Type=oneshot`：这一选项适用于只执行一项任务、随后立即退出的服务。可能需要**同时设置 RemainAfterExit=yes** 使得 systemd 在服务进程退出之后仍然认为服务处于激活状态。\n\n  * `Type=notify`：与 Type=simple 相同，但约定服务会在就绪后向 systemd 发送一个信号。这一通知的实现由 libsystemd-daemon.so 提供。\n\n  * `Type=dbus`：若以此方式启动，当指定的 BusName 出现在DBus系统总线上时，systemd认为服务就绪。\n\n  * `Type=idle`: systemd会等待所有任务(Jobs)处理完成后，才开始执行idle类型的单元。除此之外，其他行为和Type=simple 类似。\n\n  * `PIDFile`：指定pid文件路径\n\n  * `ExecStart`：指定启动单元的命令或者脚本\n\n  * `ExecStartPre和ExecStartPost`：指定在执行ExecStart之前或者之后执行用户自定义的脚本，**Type=oneshot**允许用户执行多个按顺序定义的脚本。\n\n  * `ExecReload`：指定单元重载时执行的命令或者脚本。\n\n  * `ExecStop`：指定单元停止时执行的命令或者脚本。\n\n  * `PrivateTmp`：True表示给服务分配独立的临时空间\n\n  * `LimitNOFILE`：设置文件描述符相关参数个数，或者设置为无穷 infinity\n\n  * `LimitNPROC`：设置文件描述符相关参数个数，或者设置为无穷 infinity\n\n  * `LimitCORE`：设置文件描述符相关参数个数，或者设置为无穷 infinity\n\n  * `Restart`：这个选项如果被允许，服务重启的时候进程会退出，会通过systemctl命令执行清除并重启的操作。通常设置为**on-failure**。\n\n  * `RemainAfterExit`：如果设置这个选择为真，服务会被认为是在激活状态，即使所以的进程已经退出，默认的值为假，这个选项只有在Type=oneshot时需要被配置。\n---\n### [Install]\n定义如何安装这个配置文件，即怎样做到开机启动。\n  * `Alias`：为单元提供一个空间分离的附加名字。\n  * `RequiredBy`：单元被允许运行需要的一系列依赖单元，RequiredBy列表从Require获得依赖信息。\n  * `WantBy`：单元被允许运行需要的弱依赖性单元，Wantby从Want列表获得依赖信息。\n  * `Also`：指出和单元一起安装或者被协助的单元。\n  * `DefaultInstance`：实例单元的限制，这个选项指定如果单元被允许运行默认的实例。\n---\n## mysql.service样例\n```bash\n[Unit]\nDescription=MySQL Server\nDocumentation=man:mysqld(8)\nDocumentation=http://dev.mysql.com/doc/refman/en/using-systemd.html\nAfter=network.target\nAfter=syslog.target\n\n[Service]\nUser=mysql\nGroup=mysql\nType=forking\nPIDFile=/var/run/mysqld/mysqld.pid\nTimeoutSec=0\nPermissionsStartOnly=true\nExecStartPre=/usr/bin/mysqld_pre_systemd\nExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid $MYSQLD_OPTS\nEnvironmentFile=-/etc/sysconfig/mysql\nLimitNOFILE = 5000\nRestart=on-failure\nRestartPreventExitStatus=1\nPrivateTmp=false\n\n[Install]\nWantedBy=multi-user.target\n```\n## etcd.service样例\n```bash\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=notify\nWorkingDirectory=/var/lib/etcd/\nEnvironmentFile=-/etc/etcd/etcd.conf          #etcd配置文件路径\nExecStart=/bin/bash -c \"GOMAXPROCS=$(nproc) /usr/bin/etcd --name=\\\"${ETCD_NAME}\\\" --data-dir=\\\"${ETCD_DATA_DIR}\\\" --listen-client-urls=\\\"${ETCD_LISTEN_CLIENT_URLS}\\\"\"\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target    # 说明：其中WorkingDirectory为etcd数据库目录，需要在etcd**安装前创建**\n```\n","slug":"systemctl-unit","published":1,"updated":"2019-05-28T02:02:23.508Z","_id":"cjw6jleyr000jp4n722c6b6pr","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>systemctl是RHEL 7 的服务管理工具中主要的工具，它融合之前service和chkconfig的功能于一体。可以使用它永久性或只在当前会话中启用/禁用服务。</p>\n<h2 id=\"服务权限\"><a href=\"#服务权限\" class=\"headerlink\" title=\"服务权限\"></a>服务权限</h2><p>systemd有系统和用户区分；系统<code>/user/lib/systemd/system/</code>, 用户<code>/etc/lib/systemd/user/</code>一般系统管理员手工创建的单元文件建议存放在<code>/etc/systemd/system/</code>目录下面。或者<code>/usr/lib/systemd/system/</code>下面 ，然后可以通过<code>systemctl enable xxx.service</code>方式将该服务添加到<code>/etc/systemd/system/multi-user.target.wants/</code>目录下面设置为开机自启动。</p>\n<h2 id=\"格式介绍\"><a href=\"#格式介绍\" class=\"headerlink\" title=\"格式介绍\"></a>格式介绍</h2><p>systemctl的服务文件主要包含<code>[Unit]</code>、<code>[Service]</code>、<code>[Install]</code>三类。下面我们对这三类进行说明。</p>\n<h3 id=\"Unit\"><a href=\"#Unit\" class=\"headerlink\" title=\"[Unit]\"></a>[Unit]</h3><p>该部分主要对服务进行说明。</p>\n<ul>\n<li><code>Description</code> : 服务的简单描述。</li>\n<li><code>Documentation</code> ： 服务文档地址说明。</li>\n<li><code>Before=xxx.service</code>：代表本服务在xxx.service启动之前启动。</li>\n<li><code>After=xxx.service</code>：代表本服务在xxx.service启动之后启动。</li>\n<li><code>Requires</code>： 本服务启动后，它需要的服务也会启动；而本服务需要的服务被停止了，本服务也停止了。</li>\n<li><code>Wants</code>： 推荐使用。本服务启动了，它需要的服务也会被启动；而本服务需要的服务被停止了，对本单元没有影响。</li>\n</ul>\n<hr>\n<h3 id=\"Service\"><a href=\"#Service\" class=\"headerlink\" title=\"[Service]\"></a>[Service]</h3><p>该部分的配置服务的启动、重启、停止命令全部要求使用绝对路径，使用相对路径则会报错。</p>\n<ul>\n<li><p><code>WorkingDirectory</code>：指定服务运行的工作目录。</p>\n</li>\n<li><p><code>EnvironmentFile</code>：指定服务需要的配置文件，下文可以用<code>${}</code>方式引用文件中的值。</p>\n</li>\n<li><p><code>Type=simple（默认值）</code>：systemd认为该服务将立即启动。服务进程不会fork。如果该服务要启动其他服务，不要使用此类型启动，除非该服务是socket激活型。</p>\n</li>\n<li><p><code>Type=forking</code>：systemd认为当该服务进程fork，且父进程退出后服务启动成功。对于常规的守护进程（daemon），除非你确定此启动方式无法满足需求，使用此类型启动即可。<strong>使用此启动类型应同时指定 PIDFile=</strong>，以便systemd能够跟踪服务的主进程。</p>\n</li>\n<li><p><code>Type=oneshot</code>：这一选项适用于只执行一项任务、随后立即退出的服务。可能需要<strong>同时设置 RemainAfterExit=yes</strong> 使得 systemd 在服务进程退出之后仍然认为服务处于激活状态。</p>\n</li>\n<li><p><code>Type=notify</code>：与 Type=simple 相同，但约定服务会在就绪后向 systemd 发送一个信号。这一通知的实现由 libsystemd-daemon.so 提供。</p>\n</li>\n<li><p><code>Type=dbus</code>：若以此方式启动，当指定的 BusName 出现在DBus系统总线上时，systemd认为服务就绪。</p>\n</li>\n<li><p><code>Type=idle</code>: systemd会等待所有任务(Jobs)处理完成后，才开始执行idle类型的单元。除此之外，其他行为和Type=simple 类似。</p>\n</li>\n<li><p><code>PIDFile</code>：指定pid文件路径</p>\n</li>\n<li><p><code>ExecStart</code>：指定启动单元的命令或者脚本</p>\n</li>\n<li><p><code>ExecStartPre和ExecStartPost</code>：指定在执行ExecStart之前或者之后执行用户自定义的脚本，<strong>Type=oneshot</strong>允许用户执行多个按顺序定义的脚本。</p>\n</li>\n<li><p><code>ExecReload</code>：指定单元重载时执行的命令或者脚本。</p>\n</li>\n<li><p><code>ExecStop</code>：指定单元停止时执行的命令或者脚本。</p>\n</li>\n<li><p><code>PrivateTmp</code>：True表示给服务分配独立的临时空间</p>\n</li>\n<li><p><code>LimitNOFILE</code>：设置文件描述符相关参数个数，或者设置为无穷 infinity</p>\n</li>\n<li><p><code>LimitNPROC</code>：设置文件描述符相关参数个数，或者设置为无穷 infinity</p>\n</li>\n<li><p><code>LimitCORE</code>：设置文件描述符相关参数个数，或者设置为无穷 infinity</p>\n</li>\n<li><p><code>Restart</code>：这个选项如果被允许，服务重启的时候进程会退出，会通过systemctl命令执行清除并重启的操作。通常设置为<strong>on-failure</strong>。</p>\n</li>\n<li><p><code>RemainAfterExit</code>：如果设置这个选择为真，服务会被认为是在激活状态，即使所以的进程已经退出，默认的值为假，这个选项只有在Type=oneshot时需要被配置。</p>\n</li>\n</ul>\n<hr>\n<h3 id=\"Install\"><a href=\"#Install\" class=\"headerlink\" title=\"[Install]\"></a>[Install]</h3><p>定义如何安装这个配置文件，即怎样做到开机启动。</p>\n<ul>\n<li><code>Alias</code>：为单元提供一个空间分离的附加名字。</li>\n<li><code>RequiredBy</code>：单元被允许运行需要的一系列依赖单元，RequiredBy列表从Require获得依赖信息。</li>\n<li><code>WantBy</code>：单元被允许运行需要的弱依赖性单元，Wantby从Want列表获得依赖信息。</li>\n<li><code>Also</code>：指出和单元一起安装或者被协助的单元。</li>\n<li><code>DefaultInstance</code>：实例单元的限制，这个选项指定如果单元被允许运行默认的实例。</li>\n</ul>\n<hr>\n<h2 id=\"mysql-service样例\"><a href=\"#mysql-service样例\" class=\"headerlink\" title=\"mysql.service样例\"></a>mysql.service样例</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=MySQL Server</span><br><span class=\"line\">Documentation=man:mysqld(8)</span><br><span class=\"line\">Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\">After=syslog.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">User=mysql</span><br><span class=\"line\">Group=mysql</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">PIDFile=/var/run/mysqld/mysqld.pid</span><br><span class=\"line\">TimeoutSec=0</span><br><span class=\"line\">PermissionsStartOnly=<span class=\"literal\">true</span></span><br><span class=\"line\">ExecStartPre=/usr/bin/mysqld_pre_systemd</span><br><span class=\"line\">ExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid <span class=\"variable\">$MYSQLD_OPTS</span></span><br><span class=\"line\">EnvironmentFile=-/etc/sysconfig/mysql</span><br><span class=\"line\">LimitNOFILE = 5000</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartPreventExitStatus=1</span><br><span class=\"line\">PrivateTmp=<span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h2 id=\"etcd-service样例\"><a href=\"#etcd-service样例\" class=\"headerlink\" title=\"etcd.service样例\"></a>etcd.service样例</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Etcd Server</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=notify</span><br><span class=\"line\">WorkingDirectory=/var/lib/etcd/</span><br><span class=\"line\">EnvironmentFile=-/etc/etcd/etcd.conf          <span class=\"comment\">#etcd配置文件路径</span></span><br><span class=\"line\">ExecStart=/bin/bash -c <span class=\"string\">\"GOMAXPROCS=<span class=\"variable\">$(nproc)</span> /usr/bin/etcd --name=\\\"<span class=\"variable\">$&#123;ETCD_NAME&#125;</span>\\\" --data-dir=\\\"<span class=\"variable\">$&#123;ETCD_DATA_DIR&#125;</span>\\\" --listen-client-urls=\\\"<span class=\"variable\">$&#123;ETCD_LISTEN_CLIENT_URLS&#125;</span>\\\"\"</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">LimitNOFILE=65536</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target    <span class=\"comment\"># 说明：其中WorkingDirectory为etcd数据库目录，需要在etcd**安装前创建**</span></span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"length":3215,"excerpt":"","more":"<p>systemctl是RHEL 7 的服务管理工具中主要的工具，它融合之前service和chkconfig的功能于一体。可以使用它永久性或只在当前会话中启用/禁用服务。</p>\n<h2 id=\"服务权限\"><a href=\"#服务权限\" class=\"headerlink\" title=\"服务权限\"></a>服务权限</h2><p>systemd有系统和用户区分；系统<code>/user/lib/systemd/system/</code>, 用户<code>/etc/lib/systemd/user/</code>一般系统管理员手工创建的单元文件建议存放在<code>/etc/systemd/system/</code>目录下面。或者<code>/usr/lib/systemd/system/</code>下面 ，然后可以通过<code>systemctl enable xxx.service</code>方式将该服务添加到<code>/etc/systemd/system/multi-user.target.wants/</code>目录下面设置为开机自启动。</p>\n<h2 id=\"格式介绍\"><a href=\"#格式介绍\" class=\"headerlink\" title=\"格式介绍\"></a>格式介绍</h2><p>systemctl的服务文件主要包含<code>[Unit]</code>、<code>[Service]</code>、<code>[Install]</code>三类。下面我们对这三类进行说明。</p>\n<h3 id=\"Unit\"><a href=\"#Unit\" class=\"headerlink\" title=\"[Unit]\"></a>[Unit]</h3><p>该部分主要对服务进行说明。</p>\n<ul>\n<li><code>Description</code> : 服务的简单描述。</li>\n<li><code>Documentation</code> ： 服务文档地址说明。</li>\n<li><code>Before=xxx.service</code>：代表本服务在xxx.service启动之前启动。</li>\n<li><code>After=xxx.service</code>：代表本服务在xxx.service启动之后启动。</li>\n<li><code>Requires</code>： 本服务启动后，它需要的服务也会启动；而本服务需要的服务被停止了，本服务也停止了。</li>\n<li><code>Wants</code>： 推荐使用。本服务启动了，它需要的服务也会被启动；而本服务需要的服务被停止了，对本单元没有影响。</li>\n</ul>\n<hr>\n<h3 id=\"Service\"><a href=\"#Service\" class=\"headerlink\" title=\"[Service]\"></a>[Service]</h3><p>该部分的配置服务的启动、重启、停止命令全部要求使用绝对路径，使用相对路径则会报错。</p>\n<ul>\n<li><p><code>WorkingDirectory</code>：指定服务运行的工作目录。</p>\n</li>\n<li><p><code>EnvironmentFile</code>：指定服务需要的配置文件，下文可以用<code>${}</code>方式引用文件中的值。</p>\n</li>\n<li><p><code>Type=simple（默认值）</code>：systemd认为该服务将立即启动。服务进程不会fork。如果该服务要启动其他服务，不要使用此类型启动，除非该服务是socket激活型。</p>\n</li>\n<li><p><code>Type=forking</code>：systemd认为当该服务进程fork，且父进程退出后服务启动成功。对于常规的守护进程（daemon），除非你确定此启动方式无法满足需求，使用此类型启动即可。<strong>使用此启动类型应同时指定 PIDFile=</strong>，以便systemd能够跟踪服务的主进程。</p>\n</li>\n<li><p><code>Type=oneshot</code>：这一选项适用于只执行一项任务、随后立即退出的服务。可能需要<strong>同时设置 RemainAfterExit=yes</strong> 使得 systemd 在服务进程退出之后仍然认为服务处于激活状态。</p>\n</li>\n<li><p><code>Type=notify</code>：与 Type=simple 相同，但约定服务会在就绪后向 systemd 发送一个信号。这一通知的实现由 libsystemd-daemon.so 提供。</p>\n</li>\n<li><p><code>Type=dbus</code>：若以此方式启动，当指定的 BusName 出现在DBus系统总线上时，systemd认为服务就绪。</p>\n</li>\n<li><p><code>Type=idle</code>: systemd会等待所有任务(Jobs)处理完成后，才开始执行idle类型的单元。除此之外，其他行为和Type=simple 类似。</p>\n</li>\n<li><p><code>PIDFile</code>：指定pid文件路径</p>\n</li>\n<li><p><code>ExecStart</code>：指定启动单元的命令或者脚本</p>\n</li>\n<li><p><code>ExecStartPre和ExecStartPost</code>：指定在执行ExecStart之前或者之后执行用户自定义的脚本，<strong>Type=oneshot</strong>允许用户执行多个按顺序定义的脚本。</p>\n</li>\n<li><p><code>ExecReload</code>：指定单元重载时执行的命令或者脚本。</p>\n</li>\n<li><p><code>ExecStop</code>：指定单元停止时执行的命令或者脚本。</p>\n</li>\n<li><p><code>PrivateTmp</code>：True表示给服务分配独立的临时空间</p>\n</li>\n<li><p><code>LimitNOFILE</code>：设置文件描述符相关参数个数，或者设置为无穷 infinity</p>\n</li>\n<li><p><code>LimitNPROC</code>：设置文件描述符相关参数个数，或者设置为无穷 infinity</p>\n</li>\n<li><p><code>LimitCORE</code>：设置文件描述符相关参数个数，或者设置为无穷 infinity</p>\n</li>\n<li><p><code>Restart</code>：这个选项如果被允许，服务重启的时候进程会退出，会通过systemctl命令执行清除并重启的操作。通常设置为<strong>on-failure</strong>。</p>\n</li>\n<li><p><code>RemainAfterExit</code>：如果设置这个选择为真，服务会被认为是在激活状态，即使所以的进程已经退出，默认的值为假，这个选项只有在Type=oneshot时需要被配置。</p>\n</li>\n</ul>\n<hr>\n<h3 id=\"Install\"><a href=\"#Install\" class=\"headerlink\" title=\"[Install]\"></a>[Install]</h3><p>定义如何安装这个配置文件，即怎样做到开机启动。</p>\n<ul>\n<li><code>Alias</code>：为单元提供一个空间分离的附加名字。</li>\n<li><code>RequiredBy</code>：单元被允许运行需要的一系列依赖单元，RequiredBy列表从Require获得依赖信息。</li>\n<li><code>WantBy</code>：单元被允许运行需要的弱依赖性单元，Wantby从Want列表获得依赖信息。</li>\n<li><code>Also</code>：指出和单元一起安装或者被协助的单元。</li>\n<li><code>DefaultInstance</code>：实例单元的限制，这个选项指定如果单元被允许运行默认的实例。</li>\n</ul>\n<hr>\n<h2 id=\"mysql-service样例\"><a href=\"#mysql-service样例\" class=\"headerlink\" title=\"mysql.service样例\"></a>mysql.service样例</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=MySQL Server</span><br><span class=\"line\">Documentation=man:mysqld(8)</span><br><span class=\"line\">Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\">After=syslog.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">User=mysql</span><br><span class=\"line\">Group=mysql</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">PIDFile=/var/run/mysqld/mysqld.pid</span><br><span class=\"line\">TimeoutSec=0</span><br><span class=\"line\">PermissionsStartOnly=<span class=\"literal\">true</span></span><br><span class=\"line\">ExecStartPre=/usr/bin/mysqld_pre_systemd</span><br><span class=\"line\">ExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid <span class=\"variable\">$MYSQLD_OPTS</span></span><br><span class=\"line\">EnvironmentFile=-/etc/sysconfig/mysql</span><br><span class=\"line\">LimitNOFILE = 5000</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartPreventExitStatus=1</span><br><span class=\"line\">PrivateTmp=<span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h2 id=\"etcd-service样例\"><a href=\"#etcd-service样例\" class=\"headerlink\" title=\"etcd.service样例\"></a>etcd.service样例</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Etcd Server</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=notify</span><br><span class=\"line\">WorkingDirectory=/var/lib/etcd/</span><br><span class=\"line\">EnvironmentFile=-/etc/etcd/etcd.conf          <span class=\"comment\">#etcd配置文件路径</span></span><br><span class=\"line\">ExecStart=/bin/bash -c <span class=\"string\">\"GOMAXPROCS=<span class=\"variable\">$(nproc)</span> /usr/bin/etcd --name=\\\"<span class=\"variable\">$&#123;ETCD_NAME&#125;</span>\\\" --data-dir=\\\"<span class=\"variable\">$&#123;ETCD_DATA_DIR&#125;</span>\\\" --listen-client-urls=\\\"<span class=\"variable\">$&#123;ETCD_LISTEN_CLIENT_URLS&#125;</span>\\\"\"</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">LimitNOFILE=65536</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target    <span class=\"comment\"># 说明：其中WorkingDirectory为etcd数据库目录，需要在etcd**安装前创建**</span></span><br></pre></td></tr></table></figure>\n"},{"layout":"post","title":"Tomcat8配置APR模式","author":"Pyker","img":"/images/bar/tomcat.jpg","top":false,"cover":false,"date":"2018-12-14T10:47:00.000Z","_content":"### tomcat三种模式\nTomcat Connector运行有三种模式：\n* __bio__\n默认的模式,同步阻塞，性能非常低下,没有经过任何优化处理和支持.\n\n* __nio__ \n同步非阻塞，利用java的异步io护理技术,noblocking IO技术,想运行在该模式下，直接修改server.xml里的Connector节点,修改protocol为```protocol=\"org.apache.coyote.http11.Http11NioProtocol\" ``` 启动后,就可以生效。\n\n* __apr__\n安装起来最困难,但是从操作系统级别来解决异步的IO问题,大幅度的提高性能. Tomcat apr也是在Tomcat上运行高并发应用的首选模式。必须要安装apr、apr-util和native，nio修改模式，修改protocol为 `org.apache.coyote.http11.Http11AprProtocol` ，直接启动就支持apr。\n\n### 安装配置APR模式\n\n**本文所有步骤的前提是已经可以正常运行tomcat程序，JDK已安装的环境。**\n\nTomcat配置apr模式依赖以下包,（ `版本根据自己需求选择` ）\n```\napr-1.6.2\napr-util-1.6.0\nopenssl-1.0.2l\n```\n#### 下载依赖包\n```bash\n$ wget http://mirror.bit.edu.cn/apache//apr/apr-1.6.2.tar.gz\n$ wget http://mirror.bit.edu.cn/apache//apr/apr-util-1.6.0.tar.gz\n$ wget https://www.openssl.org/source/openssl-1.0.2l.tar.gz\n```\n#### 安装各个依赖包\n```bash\n#安装apr\n$ tar zxvf apr-1.6.2.tar.gz\n$ cd apr-1.6.2\n$ ./configure --prefix=/usr/local/apr && make && make install\n#安装apr-util\n$ tar zxvf apr-util-1.6.0.tar.gz\n$ cd apr-util-1.6.0\n$ ./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr && make && make install\n#安装openss-1.0.2l\n$ tar zxvf openssl-1.0.2l.tar.gz\n$ cd openssl-1.0.2l\n$ ./config --prefix=/usr/local/openssl shared zlib && make && make install\n```\n\n*1、安装apr-util前请确认是否安装了 `expat-devel` 包，如没安装请安装，不然会报错。`yum install expat-devel` *\n\n*2、检查openssl是否安装成功 `/usr/local/openssl/bin/openssl version -a`  显示1.0.2l版本为成功*\n\n#### 安装tomcat-native\n```bash\n$ tar zxvf /usr/local/tomcat8/bin/tomcat-native.tar.gz\n$ cd /usr/local/tomcat8/bin/tomcat-native-1.2.12-src/native\n$ ./configure --with-apr=/usr/local/apr --with-java-home=/usr/local/java8/ --with-ssl=/usr/local/openssl/ && make && make install\n```\n#### 配置tomcat支持apr配置apr库文件\n```bash\n#方式1：配置坏境变量：\n$ echo \"export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/apr/lib\" >> /etc/profile\n$ echo \"export LD_RUN_PATH=$LD_RUN_PATH:/usr/local/apr/lib\" >> /etc/profile && source /etc/profile\n#\n#方式2：catalina.sh脚本文件：在注释行# Register custom URL handlers下添加一行 \n$ JAVA_OPTS=\"$JAVA_OPTS -Djava.library.path=/usr/local/apr/lib\"\n```\n#### 修改tomcat server.xml文件\n\n\t <Connector port=\"8080\" protocol=\"org.apache.coyote.http11.Http11AprProtocol\"\n\t connectionTimeout=\"20000\"\n\t redirectPort=\"8443\" />\n\n#### 启动Tomcat\n```bash\n$ cd /usr/local/tomcat8/bin\n$ ./startup.sh\n```\n#### 查看Tomcat模式运行\n```bash\n$ cat /usr/local/tomcat8/logs/catalina.out\n```\n>如果有显示`[http-apr-8080]` 说明配置APR模式成功。\n\n### java.net.ConnectException异常处理\n有时候在安装完tomcat后，停止tomcat会的会有如下异常，该异常可能和JDK有关系。\n![](/images/pic/tomcat1.png)\n\n解决办法：进入JDK目录，编辑java.security文件,(`注释掉原来的securerandom.source行，新增此行，保存即可` )\n```bash\n$ vi /usr/local/java8/jre/lib/security/java.security\nsecurerandom.source=file:/dev/./urandom\n```","source":"_posts/tomcat-apr.md","raw":"layout: post\ntitle: Tomcat8配置APR模式\nauthor: Pyker\ncategories: web\nimg: /images/bar/tomcat.jpg\ntags:\n  - tomcat\ntop: false\ncover: false\ndate: 2018-12-14 18:47:00\n---\n### tomcat三种模式\nTomcat Connector运行有三种模式：\n* __bio__\n默认的模式,同步阻塞，性能非常低下,没有经过任何优化处理和支持.\n\n* __nio__ \n同步非阻塞，利用java的异步io护理技术,noblocking IO技术,想运行在该模式下，直接修改server.xml里的Connector节点,修改protocol为```protocol=\"org.apache.coyote.http11.Http11NioProtocol\" ``` 启动后,就可以生效。\n\n* __apr__\n安装起来最困难,但是从操作系统级别来解决异步的IO问题,大幅度的提高性能. Tomcat apr也是在Tomcat上运行高并发应用的首选模式。必须要安装apr、apr-util和native，nio修改模式，修改protocol为 `org.apache.coyote.http11.Http11AprProtocol` ，直接启动就支持apr。\n\n### 安装配置APR模式\n\n**本文所有步骤的前提是已经可以正常运行tomcat程序，JDK已安装的环境。**\n\nTomcat配置apr模式依赖以下包,（ `版本根据自己需求选择` ）\n```\napr-1.6.2\napr-util-1.6.0\nopenssl-1.0.2l\n```\n#### 下载依赖包\n```bash\n$ wget http://mirror.bit.edu.cn/apache//apr/apr-1.6.2.tar.gz\n$ wget http://mirror.bit.edu.cn/apache//apr/apr-util-1.6.0.tar.gz\n$ wget https://www.openssl.org/source/openssl-1.0.2l.tar.gz\n```\n#### 安装各个依赖包\n```bash\n#安装apr\n$ tar zxvf apr-1.6.2.tar.gz\n$ cd apr-1.6.2\n$ ./configure --prefix=/usr/local/apr && make && make install\n#安装apr-util\n$ tar zxvf apr-util-1.6.0.tar.gz\n$ cd apr-util-1.6.0\n$ ./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr && make && make install\n#安装openss-1.0.2l\n$ tar zxvf openssl-1.0.2l.tar.gz\n$ cd openssl-1.0.2l\n$ ./config --prefix=/usr/local/openssl shared zlib && make && make install\n```\n\n*1、安装apr-util前请确认是否安装了 `expat-devel` 包，如没安装请安装，不然会报错。`yum install expat-devel` *\n\n*2、检查openssl是否安装成功 `/usr/local/openssl/bin/openssl version -a`  显示1.0.2l版本为成功*\n\n#### 安装tomcat-native\n```bash\n$ tar zxvf /usr/local/tomcat8/bin/tomcat-native.tar.gz\n$ cd /usr/local/tomcat8/bin/tomcat-native-1.2.12-src/native\n$ ./configure --with-apr=/usr/local/apr --with-java-home=/usr/local/java8/ --with-ssl=/usr/local/openssl/ && make && make install\n```\n#### 配置tomcat支持apr配置apr库文件\n```bash\n#方式1：配置坏境变量：\n$ echo \"export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/apr/lib\" >> /etc/profile\n$ echo \"export LD_RUN_PATH=$LD_RUN_PATH:/usr/local/apr/lib\" >> /etc/profile && source /etc/profile\n#\n#方式2：catalina.sh脚本文件：在注释行# Register custom URL handlers下添加一行 \n$ JAVA_OPTS=\"$JAVA_OPTS -Djava.library.path=/usr/local/apr/lib\"\n```\n#### 修改tomcat server.xml文件\n\n\t <Connector port=\"8080\" protocol=\"org.apache.coyote.http11.Http11AprProtocol\"\n\t connectionTimeout=\"20000\"\n\t redirectPort=\"8443\" />\n\n#### 启动Tomcat\n```bash\n$ cd /usr/local/tomcat8/bin\n$ ./startup.sh\n```\n#### 查看Tomcat模式运行\n```bash\n$ cat /usr/local/tomcat8/logs/catalina.out\n```\n>如果有显示`[http-apr-8080]` 说明配置APR模式成功。\n\n### java.net.ConnectException异常处理\n有时候在安装完tomcat后，停止tomcat会的会有如下异常，该异常可能和JDK有关系。\n![](/images/pic/tomcat1.png)\n\n解决办法：进入JDK目录，编辑java.security文件,(`注释掉原来的securerandom.source行，新增此行，保存即可` )\n```bash\n$ vi /usr/local/java8/jre/lib/security/java.security\nsecurerandom.source=file:/dev/./urandom\n```","slug":"tomcat-apr","published":1,"updated":"2019-05-28T02:02:23.508Z","_id":"cjw6jleyt000lp4n7lluv22oa","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h3 id=\"tomcat三种模式\"><a href=\"#tomcat三种模式\" class=\"headerlink\" title=\"tomcat三种模式\"></a>tomcat三种模式</h3><p>Tomcat Connector运行有三种模式：</p>\n<ul>\n<li><p><strong>bio</strong><br>默认的模式,同步阻塞，性能非常低下,没有经过任何优化处理和支持.</p>\n</li>\n<li><p><strong>nio</strong><br>同步非阻塞，利用java的异步io护理技术,noblocking IO技术,想运行在该模式下，直接修改server.xml里的Connector节点,修改protocol为<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">* __apr__</span><br><span class=\"line\">安装起来最困难,但是从操作系统级别来解决异步的IO问题,大幅度的提高性能. Tomcat apr也是在Tomcat上运行高并发应用的首选模式。必须要安装apr、apr-util和native，nio修改模式，修改protocol为 `org.apache.coyote.http11.Http11AprProtocol` ，直接启动就支持apr。</span><br><span class=\"line\"></span><br><span class=\"line\">### 安装配置APR模式</span><br><span class=\"line\"></span><br><span class=\"line\">**本文所有步骤的前提是已经可以正常运行tomcat程序，JDK已安装的环境。**</span><br><span class=\"line\"></span><br><span class=\"line\">Tomcat配置apr模式依赖以下包,（ `版本根据自己需求选择` ）</span><br></pre></td></tr></table></figure></p>\n</li>\n</ul>\n<p>apr-1.6.2<br>apr-util-1.6.0<br>openssl-1.0.2l<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#### 下载依赖包</span></span><br><span class=\"line\">```bash</span><br><span class=\"line\">$ wget http:<span class=\"regexp\">//mi</span>rror.bit.edu.cn<span class=\"regexp\">/apache/</span><span class=\"regexp\">/apr/</span>apr-<span class=\"number\">1.6</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\">$ wget http:<span class=\"regexp\">//mi</span>rror.bit.edu.cn<span class=\"regexp\">/apache/</span><span class=\"regexp\">/apr/</span>apr-util-<span class=\"number\">1.6</span>.<span class=\"number\">0</span>.tar.gz</span><br><span class=\"line\">$ wget https:<span class=\"regexp\">//</span>www.openssl.org<span class=\"regexp\">/source/</span>openssl-<span class=\"number\">1.0</span>.<span class=\"number\">2</span>l.tar.gz</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"安装各个依赖包\"><a href=\"#安装各个依赖包\" class=\"headerlink\" title=\"安装各个依赖包\"></a>安装各个依赖包</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#安装apr</span></span><br><span class=\"line\">$ tar zxvf apr-1.6.2.tar.gz</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> apr-1.6.2</span><br><span class=\"line\">$ ./configure --prefix=/usr/<span class=\"built_in\">local</span>/apr &amp;&amp; make &amp;&amp; make install</span><br><span class=\"line\"><span class=\"comment\">#安装apr-util</span></span><br><span class=\"line\">$ tar zxvf apr-util-1.6.0.tar.gz</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> apr-util-1.6.0</span><br><span class=\"line\">$ ./configure --prefix=/usr/<span class=\"built_in\">local</span>/apr-util --with-apr=/usr/<span class=\"built_in\">local</span>/apr &amp;&amp; make &amp;&amp; make install</span><br><span class=\"line\"><span class=\"comment\">#安装openss-1.0.2l</span></span><br><span class=\"line\">$ tar zxvf openssl-1.0.2l.tar.gz</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> openssl-1.0.2l</span><br><span class=\"line\">$ ./config --prefix=/usr/<span class=\"built_in\">local</span>/openssl shared zlib &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n<p><em>1、安装apr-util前请确认是否安装了 <code>expat-devel</code> 包，如没安装请安装，不然会报错。<code>yum install expat-devel</code> </em></p>\n<p><em>2、检查openssl是否安装成功 <code>/usr/local/openssl/bin/openssl version -a</code>  显示1.0.2l版本为成功</em></p>\n<h4 id=\"安装tomcat-native\"><a href=\"#安装tomcat-native\" class=\"headerlink\" title=\"安装tomcat-native\"></a>安装tomcat-native</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tar zxvf /usr/<span class=\"built_in\">local</span>/tomcat8/bin/tomcat-native.tar.gz</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/tomcat8/bin/tomcat-native-1.2.12-src/native</span><br><span class=\"line\">$ ./configure --with-apr=/usr/<span class=\"built_in\">local</span>/apr --with-java-home=/usr/<span class=\"built_in\">local</span>/java8/ --with-ssl=/usr/<span class=\"built_in\">local</span>/openssl/ &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n<h4 id=\"配置tomcat支持apr配置apr库文件\"><a href=\"#配置tomcat支持apr配置apr库文件\" class=\"headerlink\" title=\"配置tomcat支持apr配置apr库文件\"></a>配置tomcat支持apr配置apr库文件</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#方式1：配置坏境变量：</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"export LD_LIBRARY_PATH=<span class=\"variable\">$LD_LIBRARY_PATH</span>:/usr/local/apr/lib\"</span> &gt;&gt; /etc/profile</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"export LD_RUN_PATH=<span class=\"variable\">$LD_RUN_PATH</span>:/usr/local/apr/lib\"</span> &gt;&gt; /etc/profile &amp;&amp; <span class=\"built_in\">source</span> /etc/profile</span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#方式2：catalina.sh脚本文件：在注释行# Register custom URL handlers下添加一行 </span></span><br><span class=\"line\">$ JAVA_OPTS=<span class=\"string\">\"<span class=\"variable\">$JAVA_OPTS</span> -Djava.library.path=/usr/local/apr/lib\"</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"修改tomcat-server-xml文件\"><a href=\"#修改tomcat-server-xml文件\" class=\"headerlink\" title=\"修改tomcat server.xml文件\"></a>修改tomcat server.xml文件</h4><pre><code>&lt;Connector port=&quot;8080&quot; protocol=&quot;org.apache.coyote.http11.Http11AprProtocol&quot;\nconnectionTimeout=&quot;20000&quot;\nredirectPort=&quot;8443&quot; /&gt;\n</code></pre><h4 id=\"启动Tomcat\"><a href=\"#启动Tomcat\" class=\"headerlink\" title=\"启动Tomcat\"></a>启动Tomcat</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/tomcat8/bin</span><br><span class=\"line\">$ ./startup.sh</span><br></pre></td></tr></table></figure>\n<h4 id=\"查看Tomcat模式运行\"><a href=\"#查看Tomcat模式运行\" class=\"headerlink\" title=\"查看Tomcat模式运行\"></a>查看Tomcat模式运行</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /usr/<span class=\"built_in\">local</span>/tomcat8/logs/catalina.out</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>如果有显示<code>[http-apr-8080]</code> 说明配置APR模式成功。</p>\n</blockquote>\n<h3 id=\"java-net-ConnectException异常处理\"><a href=\"#java-net-ConnectException异常处理\" class=\"headerlink\" title=\"java.net.ConnectException异常处理\"></a>java.net.ConnectException异常处理</h3><p>有时候在安装完tomcat后，停止tomcat会的会有如下异常，该异常可能和JDK有关系。<br><img src=\"/images/pic/tomcat1.png\" alt></p>\n<p>解决办法：进入JDK目录，编辑java.security文件,(<code>注释掉原来的securerandom.source行，新增此行，保存即可</code> )<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vi /usr/<span class=\"built_in\">local</span>/java8/jre/lib/security/java.security</span><br><span class=\"line\">securerandom.source=file:/dev/./urandom</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"length":2489,"excerpt":"","more":"<h3 id=\"tomcat三种模式\"><a href=\"#tomcat三种模式\" class=\"headerlink\" title=\"tomcat三种模式\"></a>tomcat三种模式</h3><p>Tomcat Connector运行有三种模式：</p>\n<ul>\n<li><p><strong>bio</strong><br>默认的模式,同步阻塞，性能非常低下,没有经过任何优化处理和支持.</p>\n</li>\n<li><p><strong>nio</strong><br>同步非阻塞，利用java的异步io护理技术,noblocking IO技术,想运行在该模式下，直接修改server.xml里的Connector节点,修改protocol为<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">* __apr__</span><br><span class=\"line\">安装起来最困难,但是从操作系统级别来解决异步的IO问题,大幅度的提高性能. Tomcat apr也是在Tomcat上运行高并发应用的首选模式。必须要安装apr、apr-util和native，nio修改模式，修改protocol为 `org.apache.coyote.http11.Http11AprProtocol` ，直接启动就支持apr。</span><br><span class=\"line\"></span><br><span class=\"line\">### 安装配置APR模式</span><br><span class=\"line\"></span><br><span class=\"line\">**本文所有步骤的前提是已经可以正常运行tomcat程序，JDK已安装的环境。**</span><br><span class=\"line\"></span><br><span class=\"line\">Tomcat配置apr模式依赖以下包,（ `版本根据自己需求选择` ）</span><br></pre></td></tr></table></figure></p>\n</li>\n</ul>\n<p>apr-1.6.2<br>apr-util-1.6.0<br>openssl-1.0.2l<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#### 下载依赖包</span></span><br><span class=\"line\">```bash</span><br><span class=\"line\">$ wget http:<span class=\"regexp\">//mi</span>rror.bit.edu.cn<span class=\"regexp\">/apache/</span><span class=\"regexp\">/apr/</span>apr-<span class=\"number\">1.6</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\">$ wget http:<span class=\"regexp\">//mi</span>rror.bit.edu.cn<span class=\"regexp\">/apache/</span><span class=\"regexp\">/apr/</span>apr-util-<span class=\"number\">1.6</span>.<span class=\"number\">0</span>.tar.gz</span><br><span class=\"line\">$ wget https:<span class=\"regexp\">//</span>www.openssl.org<span class=\"regexp\">/source/</span>openssl-<span class=\"number\">1.0</span>.<span class=\"number\">2</span>l.tar.gz</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"安装各个依赖包\"><a href=\"#安装各个依赖包\" class=\"headerlink\" title=\"安装各个依赖包\"></a>安装各个依赖包</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#安装apr</span></span><br><span class=\"line\">$ tar zxvf apr-1.6.2.tar.gz</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> apr-1.6.2</span><br><span class=\"line\">$ ./configure --prefix=/usr/<span class=\"built_in\">local</span>/apr &amp;&amp; make &amp;&amp; make install</span><br><span class=\"line\"><span class=\"comment\">#安装apr-util</span></span><br><span class=\"line\">$ tar zxvf apr-util-1.6.0.tar.gz</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> apr-util-1.6.0</span><br><span class=\"line\">$ ./configure --prefix=/usr/<span class=\"built_in\">local</span>/apr-util --with-apr=/usr/<span class=\"built_in\">local</span>/apr &amp;&amp; make &amp;&amp; make install</span><br><span class=\"line\"><span class=\"comment\">#安装openss-1.0.2l</span></span><br><span class=\"line\">$ tar zxvf openssl-1.0.2l.tar.gz</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> openssl-1.0.2l</span><br><span class=\"line\">$ ./config --prefix=/usr/<span class=\"built_in\">local</span>/openssl shared zlib &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n<p><em>1、安装apr-util前请确认是否安装了 <code>expat-devel</code> 包，如没安装请安装，不然会报错。<code>yum install expat-devel</code> </em></p>\n<p><em>2、检查openssl是否安装成功 <code>/usr/local/openssl/bin/openssl version -a</code>  显示1.0.2l版本为成功</em></p>\n<h4 id=\"安装tomcat-native\"><a href=\"#安装tomcat-native\" class=\"headerlink\" title=\"安装tomcat-native\"></a>安装tomcat-native</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tar zxvf /usr/<span class=\"built_in\">local</span>/tomcat8/bin/tomcat-native.tar.gz</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/tomcat8/bin/tomcat-native-1.2.12-src/native</span><br><span class=\"line\">$ ./configure --with-apr=/usr/<span class=\"built_in\">local</span>/apr --with-java-home=/usr/<span class=\"built_in\">local</span>/java8/ --with-ssl=/usr/<span class=\"built_in\">local</span>/openssl/ &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n<h4 id=\"配置tomcat支持apr配置apr库文件\"><a href=\"#配置tomcat支持apr配置apr库文件\" class=\"headerlink\" title=\"配置tomcat支持apr配置apr库文件\"></a>配置tomcat支持apr配置apr库文件</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#方式1：配置坏境变量：</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"export LD_LIBRARY_PATH=<span class=\"variable\">$LD_LIBRARY_PATH</span>:/usr/local/apr/lib\"</span> &gt;&gt; /etc/profile</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"export LD_RUN_PATH=<span class=\"variable\">$LD_RUN_PATH</span>:/usr/local/apr/lib\"</span> &gt;&gt; /etc/profile &amp;&amp; <span class=\"built_in\">source</span> /etc/profile</span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#方式2：catalina.sh脚本文件：在注释行# Register custom URL handlers下添加一行 </span></span><br><span class=\"line\">$ JAVA_OPTS=<span class=\"string\">\"<span class=\"variable\">$JAVA_OPTS</span> -Djava.library.path=/usr/local/apr/lib\"</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"修改tomcat-server-xml文件\"><a href=\"#修改tomcat-server-xml文件\" class=\"headerlink\" title=\"修改tomcat server.xml文件\"></a>修改tomcat server.xml文件</h4><pre><code>&lt;Connector port=&quot;8080&quot; protocol=&quot;org.apache.coyote.http11.Http11AprProtocol&quot;\nconnectionTimeout=&quot;20000&quot;\nredirectPort=&quot;8443&quot; /&gt;\n</code></pre><h4 id=\"启动Tomcat\"><a href=\"#启动Tomcat\" class=\"headerlink\" title=\"启动Tomcat\"></a>启动Tomcat</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/tomcat8/bin</span><br><span class=\"line\">$ ./startup.sh</span><br></pre></td></tr></table></figure>\n<h4 id=\"查看Tomcat模式运行\"><a href=\"#查看Tomcat模式运行\" class=\"headerlink\" title=\"查看Tomcat模式运行\"></a>查看Tomcat模式运行</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /usr/<span class=\"built_in\">local</span>/tomcat8/logs/catalina.out</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>如果有显示<code>[http-apr-8080]</code> 说明配置APR模式成功。</p>\n</blockquote>\n<h3 id=\"java-net-ConnectException异常处理\"><a href=\"#java-net-ConnectException异常处理\" class=\"headerlink\" title=\"java.net.ConnectException异常处理\"></a>java.net.ConnectException异常处理</h3><p>有时候在安装完tomcat后，停止tomcat会的会有如下异常，该异常可能和JDK有关系。<br><img src=\"/images/pic/tomcat1.png\" alt></p>\n<p>解决办法：进入JDK目录，编辑java.security文件,(<code>注释掉原来的securerandom.source行，新增此行，保存即可</code> )<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vi /usr/<span class=\"built_in\">local</span>/java8/jre/lib/security/java.security</span><br><span class=\"line\">securerandom.source=file:/dev/./urandom</span><br></pre></td></tr></table></figure></p>\n"},{"layout":"post","title":"Zabbix服务器监控之《安装Zabbix Agent》（三）","author":"Pyker","img":"/images/bar/zabbix-03.jpg","top":false,"cover":false,"date":"2018-09-11T06:51:30.000Z","_content":"[上一篇](https://www.ipyker.com/2018/09/11/zabbix-server/) 我们已经进行了对zabbix的server端安装，本篇我们将进行对Zabbix agent端安装配置！\n\n通过[第一篇](https://www.ipyker.com/2018/09/11/zabbix-summarize/) 我们已经知道`server-agent` 都是部署到被监控主机上，由agent采集数据，报告给zabbix-server端进行监控的。\n## 安装Zabbix代理端\n>由于zabbix-server用的是4.2版，那么我们agent也用4.2版。\n\n### yum安装zabbix-agent\n```bash\n#yum安装zabbix源\n$ rpm -Uvh https://repo.zabbix.com/zabbix/4.2/rhel/7/x86_64/zabbix-release-4.2-1.el7.noarch.rpm\n\n# 安装zabbix-agent代理端\n# zabbix_sender` 为测试是否能够向server端发送数据的工具\n$ yum install -y zabbix-agent zabbix-sender\n```\n### zabbix代理端配置\n```bash\n# 修改/etc/zabbix/zabbix_agentd.conf配置文件\n# 设置被动模式下zabbix-server的IP地址\nServer=192.168.20.210\n\n# 设置主动模式下zabbix-server的IP地址\nServerActive=192.168.20.210\n\n# 设置本机zabbix-agent主机名称\nHostname=web server1\n```\n### 启动zabbix代理端\n```bash\n# 启动zabbix-agent\n$ systemctl start zabbix-agent\n\n# 开机自启动zabbix-agent`\n$ systemctl enable zabbix-agent\n```\n>默认情况下，zabbix-agent不能使用root用户运行的，如果非要以root用户运行，可以在`/etc/zabbix/zabbix_agentd.conf` 配置文件中设置`AllowRoot=1` \n\n**此时查看zabbix-agent进程和端口是否正常：**\n```bash\n# 查看端口是否正常\n$ netstat -ptln\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      11734/zabbix_agentd \n\n# 查看进程是否正常\n$ ps -ef | grep zabbix_agent\nzabbix    11734      1  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd -c /etc/zabbix/zabbix_agentd.conf\nzabbix    11735  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: collector [idle 1 sec]\nzabbix    11736  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener #1 [waiting for connection]\nzabbix    11737  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener #2 [waiting for connection]\nzabbix    11738  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener #3 [waiting for connection]\nzabbix    11739  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: active checks #1 [idle 1 sec]\nroot      12105  11549  0 00:23 pts/0    00:00:00 grep --color=auto zabbix_agent\n```\n\n至此`zabbix-agent` 代理端安装完毕。\n## 监控zabbix-agent代理端\nzabbix-server监控zabbix-agent有两种方式：\n* 手动添加对应的zabbix-agent客户端\n* 自动发现和自动注册\n\n>手动添加zabbix-agent适用于少量的被监控主机，而自动发现主要是通过发现网络中的主机，并自动把主机添加到监控中，并关联特定的模板，实现自动监控，适合有大量被监控主机，减少频繁手动添加主机的麻烦操作。\n\n### 手动添加zabbix-agent客户端\n浏览器输入`http://192.168.20.210/zabbix` ，访问zabbix服务，点击`配置-主机-创建主机` \n![](/images/pic/zabbix/zabbix-config010.png)\n点击`模版` ，选择主机属于哪个模版 （模版里面包含需要监控的条目）\n![](/images/pic/zabbix/zabbix-config011.png)\n点击`添加`\n![](/images/pic/zabbix/zabbix-config012.png)\n* `应用集`：  表示模版中监控业务的一类型。（如：CPU应用集属于Template OS Linx模版）\n* `监控项`：  表示某一应用集中监控的某一项。（如：CPU负载、CPU使用率都属于CPU应用集中的监控项）\n* `触发器`：  表示某一监控项达到某自定义的阀值时，该出现的状态。（如：当CPU使用率达到70%设置他的状态为警告，80%为严重，这就属于触发器）\n* `图 形`：   表示哪些监控项进行了图形显示。（如：将CPU使用率用图形显示一段时间里的曲线变化）\n* `自动发现`：表示哪些监控项是可以通过自动发现进行监控。（如：自动发现主机网络接口流量）\n* `web监测`:  表示zabbix把web某页面也监控起来，第一时间得知web崩溃信息并做相应处理。（如：监控http某一页面，如果状态码不是200，通过触发器返回严重告警）\n\n至此手动添加zabbix-agent客户端步骤完成，可以在`监控-图形`中查看对监控项设置了图形的状态了。\n![](/images/pic/zabbix/zabbix-config013.png)\n\n### 自动发现\n当监控主机不断增多，有的时候需要添加一批机器，特别是刚用zabbix的运维人员需要将公司的所有服务器添加到zabbix，如果使用传统办法去单个添加设备、分组、项目、图像…..结果可想而知。鉴于这个问题我们可以好好利用下Zabbix的一个发现(Discovery)模块，进而来实现自动刚发现主机、自动将主机添加到主机组、自动加载模板、自动创建项目（item）、自动创建图像，下面我们来看看这个模块如何使用。\n>自动发现由服务端主动发起，Zabbix Server开启发现进程，定时扫描局域网中IP服务器、设备。\n\n**自动发现过程需要分为两个步骤：**\n* 通过网络扫描制定的服务，如：Zabbix Agent是否可以访问system.uname指标\n* 发现主机之后需要执行添加的动作，这个过程由动作（Action）完成\n\n点击`配置-自动发现-创建发现规则`填入名称、需发现服务器、设备的IP范围、更新间隔、检查项（ssh和zabbix客户端）、设备唯一性准则，最后勾选已启用、点击添加。进行自动发现规则的创建\n![](/images/pic/zabbix/zabbix-config014.png)\n\n在点击`配置-动作-事件源-自动发现-创建动作` 进行主机自动加入主机组并关联模板\n![](/images/pic/zabbix/zabbix-config015.png)\n点击`操作` 对该动作关联到模版的操作\n![](/images/pic/zabbix/zabbix-config016.png)\n`添加到主机`：将发现到的主机添加到主机\n`添加到主机群组`：选择要添加到的主机组 \n`链接到模版`：链接到模板、选择相应的模板 \n\n点击`添加`完成动作规则的创建，至此发现主机、添加主机并将主机添加到主机组、链接模板全部完毕。\n\n此时可以在`监测-自动发现`中看到已经被自动发现规则监测到的内网服务器！也可以在`配置-主机群组-Discovered hosts`中看到已经被自动发现的主机。也可以在`监测-图形`中查看自动发现的主机监控项的图形。\n![](/images/pic/zabbix/zabbix-config017.png)\n### 自动注册\n当主机分布在不同的城市，比如不同的云环境中时，使用主动发现就不好处理了，使用自动注册的方式非常适合在云环境中的部署。\n>由客户端主动发起，客户端必须安装并启动Agentd，否则无法被自动注册添加至主机列表。\n\n点击`配置-动作-事件源-自动注册-创建动作` 进行主机自动加入主机组并关联模板\n![](/images/pic/zabbix/zabbix-config018.png)\n点击`操作`选择具体的操作类型：添加主机、添加到主机群组、与模板关联的操作，最后点击添加。\n\n![](/images/pic/zabbix/zabbix-config019.png)\n\n在`配置-主机`中查看注册的设备信息\n![](/images/pic/zabbix/zabbix-config020.png)","source":"_posts/zabbix-agent.md","raw":"layout: post\ntitle: Zabbix服务器监控之《安装Zabbix Agent》（三）\nauthor: Pyker\ncategories: Zabbix\nimg: /images/bar/zabbix-03.jpg\ntags:\n  - zabbix\ntop: false\ncover: false\ndate: 2018-09-11 14:51:30\n---\n[上一篇](https://www.ipyker.com/2018/09/11/zabbix-server/) 我们已经进行了对zabbix的server端安装，本篇我们将进行对Zabbix agent端安装配置！\n\n通过[第一篇](https://www.ipyker.com/2018/09/11/zabbix-summarize/) 我们已经知道`server-agent` 都是部署到被监控主机上，由agent采集数据，报告给zabbix-server端进行监控的。\n## 安装Zabbix代理端\n>由于zabbix-server用的是4.2版，那么我们agent也用4.2版。\n\n### yum安装zabbix-agent\n```bash\n#yum安装zabbix源\n$ rpm -Uvh https://repo.zabbix.com/zabbix/4.2/rhel/7/x86_64/zabbix-release-4.2-1.el7.noarch.rpm\n\n# 安装zabbix-agent代理端\n# zabbix_sender` 为测试是否能够向server端发送数据的工具\n$ yum install -y zabbix-agent zabbix-sender\n```\n### zabbix代理端配置\n```bash\n# 修改/etc/zabbix/zabbix_agentd.conf配置文件\n# 设置被动模式下zabbix-server的IP地址\nServer=192.168.20.210\n\n# 设置主动模式下zabbix-server的IP地址\nServerActive=192.168.20.210\n\n# 设置本机zabbix-agent主机名称\nHostname=web server1\n```\n### 启动zabbix代理端\n```bash\n# 启动zabbix-agent\n$ systemctl start zabbix-agent\n\n# 开机自启动zabbix-agent`\n$ systemctl enable zabbix-agent\n```\n>默认情况下，zabbix-agent不能使用root用户运行的，如果非要以root用户运行，可以在`/etc/zabbix/zabbix_agentd.conf` 配置文件中设置`AllowRoot=1` \n\n**此时查看zabbix-agent进程和端口是否正常：**\n```bash\n# 查看端口是否正常\n$ netstat -ptln\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      11734/zabbix_agentd \n\n# 查看进程是否正常\n$ ps -ef | grep zabbix_agent\nzabbix    11734      1  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd -c /etc/zabbix/zabbix_agentd.conf\nzabbix    11735  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: collector [idle 1 sec]\nzabbix    11736  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener #1 [waiting for connection]\nzabbix    11737  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener #2 [waiting for connection]\nzabbix    11738  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener #3 [waiting for connection]\nzabbix    11739  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: active checks #1 [idle 1 sec]\nroot      12105  11549  0 00:23 pts/0    00:00:00 grep --color=auto zabbix_agent\n```\n\n至此`zabbix-agent` 代理端安装完毕。\n## 监控zabbix-agent代理端\nzabbix-server监控zabbix-agent有两种方式：\n* 手动添加对应的zabbix-agent客户端\n* 自动发现和自动注册\n\n>手动添加zabbix-agent适用于少量的被监控主机，而自动发现主要是通过发现网络中的主机，并自动把主机添加到监控中，并关联特定的模板，实现自动监控，适合有大量被监控主机，减少频繁手动添加主机的麻烦操作。\n\n### 手动添加zabbix-agent客户端\n浏览器输入`http://192.168.20.210/zabbix` ，访问zabbix服务，点击`配置-主机-创建主机` \n![](/images/pic/zabbix/zabbix-config010.png)\n点击`模版` ，选择主机属于哪个模版 （模版里面包含需要监控的条目）\n![](/images/pic/zabbix/zabbix-config011.png)\n点击`添加`\n![](/images/pic/zabbix/zabbix-config012.png)\n* `应用集`：  表示模版中监控业务的一类型。（如：CPU应用集属于Template OS Linx模版）\n* `监控项`：  表示某一应用集中监控的某一项。（如：CPU负载、CPU使用率都属于CPU应用集中的监控项）\n* `触发器`：  表示某一监控项达到某自定义的阀值时，该出现的状态。（如：当CPU使用率达到70%设置他的状态为警告，80%为严重，这就属于触发器）\n* `图 形`：   表示哪些监控项进行了图形显示。（如：将CPU使用率用图形显示一段时间里的曲线变化）\n* `自动发现`：表示哪些监控项是可以通过自动发现进行监控。（如：自动发现主机网络接口流量）\n* `web监测`:  表示zabbix把web某页面也监控起来，第一时间得知web崩溃信息并做相应处理。（如：监控http某一页面，如果状态码不是200，通过触发器返回严重告警）\n\n至此手动添加zabbix-agent客户端步骤完成，可以在`监控-图形`中查看对监控项设置了图形的状态了。\n![](/images/pic/zabbix/zabbix-config013.png)\n\n### 自动发现\n当监控主机不断增多，有的时候需要添加一批机器，特别是刚用zabbix的运维人员需要将公司的所有服务器添加到zabbix，如果使用传统办法去单个添加设备、分组、项目、图像…..结果可想而知。鉴于这个问题我们可以好好利用下Zabbix的一个发现(Discovery)模块，进而来实现自动刚发现主机、自动将主机添加到主机组、自动加载模板、自动创建项目（item）、自动创建图像，下面我们来看看这个模块如何使用。\n>自动发现由服务端主动发起，Zabbix Server开启发现进程，定时扫描局域网中IP服务器、设备。\n\n**自动发现过程需要分为两个步骤：**\n* 通过网络扫描制定的服务，如：Zabbix Agent是否可以访问system.uname指标\n* 发现主机之后需要执行添加的动作，这个过程由动作（Action）完成\n\n点击`配置-自动发现-创建发现规则`填入名称、需发现服务器、设备的IP范围、更新间隔、检查项（ssh和zabbix客户端）、设备唯一性准则，最后勾选已启用、点击添加。进行自动发现规则的创建\n![](/images/pic/zabbix/zabbix-config014.png)\n\n在点击`配置-动作-事件源-自动发现-创建动作` 进行主机自动加入主机组并关联模板\n![](/images/pic/zabbix/zabbix-config015.png)\n点击`操作` 对该动作关联到模版的操作\n![](/images/pic/zabbix/zabbix-config016.png)\n`添加到主机`：将发现到的主机添加到主机\n`添加到主机群组`：选择要添加到的主机组 \n`链接到模版`：链接到模板、选择相应的模板 \n\n点击`添加`完成动作规则的创建，至此发现主机、添加主机并将主机添加到主机组、链接模板全部完毕。\n\n此时可以在`监测-自动发现`中看到已经被自动发现规则监测到的内网服务器！也可以在`配置-主机群组-Discovered hosts`中看到已经被自动发现的主机。也可以在`监测-图形`中查看自动发现的主机监控项的图形。\n![](/images/pic/zabbix/zabbix-config017.png)\n### 自动注册\n当主机分布在不同的城市，比如不同的云环境中时，使用主动发现就不好处理了，使用自动注册的方式非常适合在云环境中的部署。\n>由客户端主动发起，客户端必须安装并启动Agentd，否则无法被自动注册添加至主机列表。\n\n点击`配置-动作-事件源-自动注册-创建动作` 进行主机自动加入主机组并关联模板\n![](/images/pic/zabbix/zabbix-config018.png)\n点击`操作`选择具体的操作类型：添加主机、添加到主机群组、与模板关联的操作，最后点击添加。\n\n![](/images/pic/zabbix/zabbix-config019.png)\n\n在`配置-主机`中查看注册的设备信息\n![](/images/pic/zabbix/zabbix-config020.png)","slug":"zabbix-agent","published":1,"updated":"2019-05-28T02:02:23.508Z","_id":"cjw6jleyv000qp4n781v9gg52","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p><a href=\"https://www.ipyker.com/2018/09/11/zabbix-server/\">上一篇</a> 我们已经进行了对zabbix的server端安装，本篇我们将进行对Zabbix agent端安装配置！</p>\n<p>通过<a href=\"https://www.ipyker.com/2018/09/11/zabbix-summarize/\">第一篇</a> 我们已经知道<code>server-agent</code> 都是部署到被监控主机上，由agent采集数据，报告给zabbix-server端进行监控的。</p>\n<h2 id=\"安装Zabbix代理端\"><a href=\"#安装Zabbix代理端\" class=\"headerlink\" title=\"安装Zabbix代理端\"></a>安装Zabbix代理端</h2><blockquote>\n<p>由于zabbix-server用的是4.2版，那么我们agent也用4.2版。</p>\n</blockquote>\n<h3 id=\"yum安装zabbix-agent\"><a href=\"#yum安装zabbix-agent\" class=\"headerlink\" title=\"yum安装zabbix-agent\"></a>yum安装zabbix-agent</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#yum安装zabbix源</span></span><br><span class=\"line\">$ rpm -Uvh https://repo.zabbix.com/zabbix/4.2/rhel/7/x86_64/zabbix-release-4.2-1.el7.noarch.rpm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装zabbix-agent代理端</span></span><br><span class=\"line\"><span class=\"comment\"># zabbix_sender` 为测试是否能够向server端发送数据的工具</span></span><br><span class=\"line\">$ yum install -y zabbix-agent zabbix-sender</span><br></pre></td></tr></table></figure>\n<h3 id=\"zabbix代理端配置\"><a href=\"#zabbix代理端配置\" class=\"headerlink\" title=\"zabbix代理端配置\"></a>zabbix代理端配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 修改/etc/zabbix/zabbix_agentd.conf配置文件</span></span><br><span class=\"line\"><span class=\"comment\"># 设置被动模式下zabbix-server的IP地址</span></span><br><span class=\"line\">Server=192.168.20.210</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置主动模式下zabbix-server的IP地址</span></span><br><span class=\"line\">ServerActive=192.168.20.210</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置本机zabbix-agent主机名称</span></span><br><span class=\"line\">Hostname=web server1</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动zabbix代理端\"><a href=\"#启动zabbix代理端\" class=\"headerlink\" title=\"启动zabbix代理端\"></a>启动zabbix代理端</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启动zabbix-agent</span></span><br><span class=\"line\">$ systemctl start zabbix-agent</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开机自启动zabbix-agent`</span></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> zabbix-agent</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>默认情况下，zabbix-agent不能使用root用户运行的，如果非要以root用户运行，可以在<code>/etc/zabbix/zabbix_agentd.conf</code> 配置文件中设置<code>AllowRoot=1</code> </p>\n</blockquote>\n<p><strong>此时查看zabbix-agent进程和端口是否正常：</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看端口是否正常</span></span><br><span class=\"line\">$ netstat -ptln</span><br><span class=\"line\">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class=\"line\">tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      11734/zabbix_agentd </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看进程是否正常</span></span><br><span class=\"line\">$ ps -ef | grep zabbix_agent</span><br><span class=\"line\">zabbix    11734      1  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd -c /etc/zabbix/zabbix_agentd.conf</span><br><span class=\"line\">zabbix    11735  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: collector [idle 1 sec]</span><br><span class=\"line\">zabbix    11736  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener <span class=\"comment\">#1 [waiting for connection]</span></span><br><span class=\"line\">zabbix    11737  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener <span class=\"comment\">#2 [waiting for connection]</span></span><br><span class=\"line\">zabbix    11738  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener <span class=\"comment\">#3 [waiting for connection]</span></span><br><span class=\"line\">zabbix    11739  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: active checks <span class=\"comment\">#1 [idle 1 sec]</span></span><br><span class=\"line\">root      12105  11549  0 00:23 pts/0    00:00:00 grep --color=auto zabbix_agent</span><br></pre></td></tr></table></figure></p>\n<p>至此<code>zabbix-agent</code> 代理端安装完毕。</p>\n<h2 id=\"监控zabbix-agent代理端\"><a href=\"#监控zabbix-agent代理端\" class=\"headerlink\" title=\"监控zabbix-agent代理端\"></a>监控zabbix-agent代理端</h2><p>zabbix-server监控zabbix-agent有两种方式：</p>\n<ul>\n<li>手动添加对应的zabbix-agent客户端</li>\n<li>自动发现和自动注册</li>\n</ul>\n<blockquote>\n<p>手动添加zabbix-agent适用于少量的被监控主机，而自动发现主要是通过发现网络中的主机，并自动把主机添加到监控中，并关联特定的模板，实现自动监控，适合有大量被监控主机，减少频繁手动添加主机的麻烦操作。</p>\n</blockquote>\n<h3 id=\"手动添加zabbix-agent客户端\"><a href=\"#手动添加zabbix-agent客户端\" class=\"headerlink\" title=\"手动添加zabbix-agent客户端\"></a>手动添加zabbix-agent客户端</h3><p>浏览器输入<code>http://192.168.20.210/zabbix</code> ，访问zabbix服务，点击<code>配置-主机-创建主机</code><br><img src=\"/images/pic/zabbix/zabbix-config010.png\" alt><br>点击<code>模版</code> ，选择主机属于哪个模版 （模版里面包含需要监控的条目）<br><img src=\"/images/pic/zabbix/zabbix-config011.png\" alt><br>点击<code>添加</code><br><img src=\"/images/pic/zabbix/zabbix-config012.png\" alt></p>\n<ul>\n<li><code>应用集</code>：  表示模版中监控业务的一类型。（如：CPU应用集属于Template OS Linx模版）</li>\n<li><code>监控项</code>：  表示某一应用集中监控的某一项。（如：CPU负载、CPU使用率都属于CPU应用集中的监控项）</li>\n<li><code>触发器</code>：  表示某一监控项达到某自定义的阀值时，该出现的状态。（如：当CPU使用率达到70%设置他的状态为警告，80%为严重，这就属于触发器）</li>\n<li><code>图 形</code>：   表示哪些监控项进行了图形显示。（如：将CPU使用率用图形显示一段时间里的曲线变化）</li>\n<li><code>自动发现</code>：表示哪些监控项是可以通过自动发现进行监控。（如：自动发现主机网络接口流量）</li>\n<li><code>web监测</code>:  表示zabbix把web某页面也监控起来，第一时间得知web崩溃信息并做相应处理。（如：监控http某一页面，如果状态码不是200，通过触发器返回严重告警）</li>\n</ul>\n<p>至此手动添加zabbix-agent客户端步骤完成，可以在<code>监控-图形</code>中查看对监控项设置了图形的状态了。<br><img src=\"/images/pic/zabbix/zabbix-config013.png\" alt></p>\n<h3 id=\"自动发现\"><a href=\"#自动发现\" class=\"headerlink\" title=\"自动发现\"></a>自动发现</h3><p>当监控主机不断增多，有的时候需要添加一批机器，特别是刚用zabbix的运维人员需要将公司的所有服务器添加到zabbix，如果使用传统办法去单个添加设备、分组、项目、图像…..结果可想而知。鉴于这个问题我们可以好好利用下Zabbix的一个发现(Discovery)模块，进而来实现自动刚发现主机、自动将主机添加到主机组、自动加载模板、自动创建项目（item）、自动创建图像，下面我们来看看这个模块如何使用。</p>\n<blockquote>\n<p>自动发现由服务端主动发起，Zabbix Server开启发现进程，定时扫描局域网中IP服务器、设备。</p>\n</blockquote>\n<p><strong>自动发现过程需要分为两个步骤：</strong></p>\n<ul>\n<li>通过网络扫描制定的服务，如：Zabbix Agent是否可以访问system.uname指标</li>\n<li>发现主机之后需要执行添加的动作，这个过程由动作（Action）完成</li>\n</ul>\n<p>点击<code>配置-自动发现-创建发现规则</code>填入名称、需发现服务器、设备的IP范围、更新间隔、检查项（ssh和zabbix客户端）、设备唯一性准则，最后勾选已启用、点击添加。进行自动发现规则的创建<br><img src=\"/images/pic/zabbix/zabbix-config014.png\" alt></p>\n<p>在点击<code>配置-动作-事件源-自动发现-创建动作</code> 进行主机自动加入主机组并关联模板<br><img src=\"/images/pic/zabbix/zabbix-config015.png\" alt><br>点击<code>操作</code> 对该动作关联到模版的操作<br><img src=\"/images/pic/zabbix/zabbix-config016.png\" alt><br><code>添加到主机</code>：将发现到的主机添加到主机<br><code>添加到主机群组</code>：选择要添加到的主机组<br><code>链接到模版</code>：链接到模板、选择相应的模板 </p>\n<p>点击<code>添加</code>完成动作规则的创建，至此发现主机、添加主机并将主机添加到主机组、链接模板全部完毕。</p>\n<p>此时可以在<code>监测-自动发现</code>中看到已经被自动发现规则监测到的内网服务器！也可以在<code>配置-主机群组-Discovered hosts</code>中看到已经被自动发现的主机。也可以在<code>监测-图形</code>中查看自动发现的主机监控项的图形。<br><img src=\"/images/pic/zabbix/zabbix-config017.png\" alt></p>\n<h3 id=\"自动注册\"><a href=\"#自动注册\" class=\"headerlink\" title=\"自动注册\"></a>自动注册</h3><p>当主机分布在不同的城市，比如不同的云环境中时，使用主动发现就不好处理了，使用自动注册的方式非常适合在云环境中的部署。</p>\n<blockquote>\n<p>由客户端主动发起，客户端必须安装并启动Agentd，否则无法被自动注册添加至主机列表。</p>\n</blockquote>\n<p>点击<code>配置-动作-事件源-自动注册-创建动作</code> 进行主机自动加入主机组并关联模板<br><img src=\"/images/pic/zabbix/zabbix-config018.png\" alt><br>点击<code>操作</code>选择具体的操作类型：添加主机、添加到主机群组、与模板关联的操作，最后点击添加。</p>\n<p><img src=\"/images/pic/zabbix/zabbix-config019.png\" alt></p>\n<p>在<code>配置-主机</code>中查看注册的设备信息<br><img src=\"/images/pic/zabbix/zabbix-config020.png\" alt></p>\n","site":{"data":{}},"length":3473,"excerpt":"","more":"<p><a href=\"https://www.ipyker.com/2018/09/11/zabbix-server/\">上一篇</a> 我们已经进行了对zabbix的server端安装，本篇我们将进行对Zabbix agent端安装配置！</p>\n<p>通过<a href=\"https://www.ipyker.com/2018/09/11/zabbix-summarize/\">第一篇</a> 我们已经知道<code>server-agent</code> 都是部署到被监控主机上，由agent采集数据，报告给zabbix-server端进行监控的。</p>\n<h2 id=\"安装Zabbix代理端\"><a href=\"#安装Zabbix代理端\" class=\"headerlink\" title=\"安装Zabbix代理端\"></a>安装Zabbix代理端</h2><blockquote>\n<p>由于zabbix-server用的是4.2版，那么我们agent也用4.2版。</p>\n</blockquote>\n<h3 id=\"yum安装zabbix-agent\"><a href=\"#yum安装zabbix-agent\" class=\"headerlink\" title=\"yum安装zabbix-agent\"></a>yum安装zabbix-agent</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#yum安装zabbix源</span></span><br><span class=\"line\">$ rpm -Uvh https://repo.zabbix.com/zabbix/4.2/rhel/7/x86_64/zabbix-release-4.2-1.el7.noarch.rpm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装zabbix-agent代理端</span></span><br><span class=\"line\"><span class=\"comment\"># zabbix_sender` 为测试是否能够向server端发送数据的工具</span></span><br><span class=\"line\">$ yum install -y zabbix-agent zabbix-sender</span><br></pre></td></tr></table></figure>\n<h3 id=\"zabbix代理端配置\"><a href=\"#zabbix代理端配置\" class=\"headerlink\" title=\"zabbix代理端配置\"></a>zabbix代理端配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 修改/etc/zabbix/zabbix_agentd.conf配置文件</span></span><br><span class=\"line\"><span class=\"comment\"># 设置被动模式下zabbix-server的IP地址</span></span><br><span class=\"line\">Server=192.168.20.210</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置主动模式下zabbix-server的IP地址</span></span><br><span class=\"line\">ServerActive=192.168.20.210</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置本机zabbix-agent主机名称</span></span><br><span class=\"line\">Hostname=web server1</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动zabbix代理端\"><a href=\"#启动zabbix代理端\" class=\"headerlink\" title=\"启动zabbix代理端\"></a>启动zabbix代理端</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启动zabbix-agent</span></span><br><span class=\"line\">$ systemctl start zabbix-agent</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开机自启动zabbix-agent`</span></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> zabbix-agent</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>默认情况下，zabbix-agent不能使用root用户运行的，如果非要以root用户运行，可以在<code>/etc/zabbix/zabbix_agentd.conf</code> 配置文件中设置<code>AllowRoot=1</code> </p>\n</blockquote>\n<p><strong>此时查看zabbix-agent进程和端口是否正常：</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看端口是否正常</span></span><br><span class=\"line\">$ netstat -ptln</span><br><span class=\"line\">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class=\"line\">tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      11734/zabbix_agentd </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看进程是否正常</span></span><br><span class=\"line\">$ ps -ef | grep zabbix_agent</span><br><span class=\"line\">zabbix    11734      1  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd -c /etc/zabbix/zabbix_agentd.conf</span><br><span class=\"line\">zabbix    11735  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: collector [idle 1 sec]</span><br><span class=\"line\">zabbix    11736  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener <span class=\"comment\">#1 [waiting for connection]</span></span><br><span class=\"line\">zabbix    11737  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener <span class=\"comment\">#2 [waiting for connection]</span></span><br><span class=\"line\">zabbix    11738  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: listener <span class=\"comment\">#3 [waiting for connection]</span></span><br><span class=\"line\">zabbix    11739  11734  0 4月13 ?       00:00:00 /usr/sbin/zabbix_agentd: active checks <span class=\"comment\">#1 [idle 1 sec]</span></span><br><span class=\"line\">root      12105  11549  0 00:23 pts/0    00:00:00 grep --color=auto zabbix_agent</span><br></pre></td></tr></table></figure></p>\n<p>至此<code>zabbix-agent</code> 代理端安装完毕。</p>\n<h2 id=\"监控zabbix-agent代理端\"><a href=\"#监控zabbix-agent代理端\" class=\"headerlink\" title=\"监控zabbix-agent代理端\"></a>监控zabbix-agent代理端</h2><p>zabbix-server监控zabbix-agent有两种方式：</p>\n<ul>\n<li>手动添加对应的zabbix-agent客户端</li>\n<li>自动发现和自动注册</li>\n</ul>\n<blockquote>\n<p>手动添加zabbix-agent适用于少量的被监控主机，而自动发现主要是通过发现网络中的主机，并自动把主机添加到监控中，并关联特定的模板，实现自动监控，适合有大量被监控主机，减少频繁手动添加主机的麻烦操作。</p>\n</blockquote>\n<h3 id=\"手动添加zabbix-agent客户端\"><a href=\"#手动添加zabbix-agent客户端\" class=\"headerlink\" title=\"手动添加zabbix-agent客户端\"></a>手动添加zabbix-agent客户端</h3><p>浏览器输入<code>http://192.168.20.210/zabbix</code> ，访问zabbix服务，点击<code>配置-主机-创建主机</code><br><img src=\"/images/pic/zabbix/zabbix-config010.png\" alt><br>点击<code>模版</code> ，选择主机属于哪个模版 （模版里面包含需要监控的条目）<br><img src=\"/images/pic/zabbix/zabbix-config011.png\" alt><br>点击<code>添加</code><br><img src=\"/images/pic/zabbix/zabbix-config012.png\" alt></p>\n<ul>\n<li><code>应用集</code>：  表示模版中监控业务的一类型。（如：CPU应用集属于Template OS Linx模版）</li>\n<li><code>监控项</code>：  表示某一应用集中监控的某一项。（如：CPU负载、CPU使用率都属于CPU应用集中的监控项）</li>\n<li><code>触发器</code>：  表示某一监控项达到某自定义的阀值时，该出现的状态。（如：当CPU使用率达到70%设置他的状态为警告，80%为严重，这就属于触发器）</li>\n<li><code>图 形</code>：   表示哪些监控项进行了图形显示。（如：将CPU使用率用图形显示一段时间里的曲线变化）</li>\n<li><code>自动发现</code>：表示哪些监控项是可以通过自动发现进行监控。（如：自动发现主机网络接口流量）</li>\n<li><code>web监测</code>:  表示zabbix把web某页面也监控起来，第一时间得知web崩溃信息并做相应处理。（如：监控http某一页面，如果状态码不是200，通过触发器返回严重告警）</li>\n</ul>\n<p>至此手动添加zabbix-agent客户端步骤完成，可以在<code>监控-图形</code>中查看对监控项设置了图形的状态了。<br><img src=\"/images/pic/zabbix/zabbix-config013.png\" alt></p>\n<h3 id=\"自动发现\"><a href=\"#自动发现\" class=\"headerlink\" title=\"自动发现\"></a>自动发现</h3><p>当监控主机不断增多，有的时候需要添加一批机器，特别是刚用zabbix的运维人员需要将公司的所有服务器添加到zabbix，如果使用传统办法去单个添加设备、分组、项目、图像…..结果可想而知。鉴于这个问题我们可以好好利用下Zabbix的一个发现(Discovery)模块，进而来实现自动刚发现主机、自动将主机添加到主机组、自动加载模板、自动创建项目（item）、自动创建图像，下面我们来看看这个模块如何使用。</p>\n<blockquote>\n<p>自动发现由服务端主动发起，Zabbix Server开启发现进程，定时扫描局域网中IP服务器、设备。</p>\n</blockquote>\n<p><strong>自动发现过程需要分为两个步骤：</strong></p>\n<ul>\n<li>通过网络扫描制定的服务，如：Zabbix Agent是否可以访问system.uname指标</li>\n<li>发现主机之后需要执行添加的动作，这个过程由动作（Action）完成</li>\n</ul>\n<p>点击<code>配置-自动发现-创建发现规则</code>填入名称、需发现服务器、设备的IP范围、更新间隔、检查项（ssh和zabbix客户端）、设备唯一性准则，最后勾选已启用、点击添加。进行自动发现规则的创建<br><img src=\"/images/pic/zabbix/zabbix-config014.png\" alt></p>\n<p>在点击<code>配置-动作-事件源-自动发现-创建动作</code> 进行主机自动加入主机组并关联模板<br><img src=\"/images/pic/zabbix/zabbix-config015.png\" alt><br>点击<code>操作</code> 对该动作关联到模版的操作<br><img src=\"/images/pic/zabbix/zabbix-config016.png\" alt><br><code>添加到主机</code>：将发现到的主机添加到主机<br><code>添加到主机群组</code>：选择要添加到的主机组<br><code>链接到模版</code>：链接到模板、选择相应的模板 </p>\n<p>点击<code>添加</code>完成动作规则的创建，至此发现主机、添加主机并将主机添加到主机组、链接模板全部完毕。</p>\n<p>此时可以在<code>监测-自动发现</code>中看到已经被自动发现规则监测到的内网服务器！也可以在<code>配置-主机群组-Discovered hosts</code>中看到已经被自动发现的主机。也可以在<code>监测-图形</code>中查看自动发现的主机监控项的图形。<br><img src=\"/images/pic/zabbix/zabbix-config017.png\" alt></p>\n<h3 id=\"自动注册\"><a href=\"#自动注册\" class=\"headerlink\" title=\"自动注册\"></a>自动注册</h3><p>当主机分布在不同的城市，比如不同的云环境中时，使用主动发现就不好处理了，使用自动注册的方式非常适合在云环境中的部署。</p>\n<blockquote>\n<p>由客户端主动发起，客户端必须安装并启动Agentd，否则无法被自动注册添加至主机列表。</p>\n</blockquote>\n<p>点击<code>配置-动作-事件源-自动注册-创建动作</code> 进行主机自动加入主机组并关联模板<br><img src=\"/images/pic/zabbix/zabbix-config018.png\" alt><br>点击<code>操作</code>选择具体的操作类型：添加主机、添加到主机群组、与模板关联的操作，最后点击添加。</p>\n<p><img src=\"/images/pic/zabbix/zabbix-config019.png\" alt></p>\n<p>在<code>配置-主机</code>中查看注册的设备信息<br><img src=\"/images/pic/zabbix/zabbix-config020.png\" alt></p>\n"},{"layout":"post","title":"Zabbix服务器监控之《配置Zabbix监控项》（四）","author":"Pyker","img":"/images/bar/zabbix-04.jpg","top":false,"cover":false,"date":"2018-09-12T12:10:00.000Z","_content":"通过[上一篇](https://www.ipyker.com/2018/09/11/zabbix-agent/) 我们已经进行了对zabbix的agent端安装，以及通过手动、自动发现、自动注册的方式将agent端监控到server端，也知道`应用集`、`监控项`、`触发器`是什么概念。那么本篇我们将实际配置zabbix的监控项。\n\n## 监控项说明\n在Zabbix中，我们要监控的某一个指标，被称为“监控项(item)”，比如监控磁盘的使用率，这就属于一个监控项，如果要获取到\"监控项\"的相关信息，我们则要执行一个命令，但是我们不能直接调用命令，而是通过一个\"别名\"去调用命令，这个\"命令别名\"在zabbix中被称为\"键\"(key)，所以，在zabbix中，如果我们想要获取到一个\"监控项\"的值，则需要有对应的\"键\"，通过\"键\"能够调用相应的命令，获取到对应的监控信息，而监控项的key、键值又可以为`带参数`和`不带参数`两种，下面我们将分别对其进行说明配置。 \n* **不参数键值**\n监控项键值中只有键名的键称为不带参数的键值，如`system.cpu.switches` \n* **带参数的键值**\n监控项键值中有键名和参数的键值，如`vfs.fs.size[fs,<mode>]`，对于`vfs.fs.size[fs,<mode>]`这个键来说，`vfs.fs.size`就是键名，`[fs,<mode>]`就是这个键需要的参数。而`[fs,<mode>]`这两个参数中，`fs`是不可省参数，`mode`是可省参数。\n\n## 配置监控项\n监控项可以单独配置在主机中，使该监控项专属于该主机。也可以配置在相应模版中，然后主机对该模版进行链接，从而使该主机也具有该模版的所有监控项。 \n\n<font color=#FF0000>在通常配置zabbix监控时，我们通常将监控项配置在模版中，这样方便调度和管理。(以下配置也采用监控项配置在模版里)</font>\n>系统默认自带一些模版，这些模版有监控CPU的、内存的、http的等等，如果没有自己需要的也可以自定义模版，应用集、监控项、触发器等。\n\n### 配置不带参数的监控项\n点击`配置-模版-Template OS Linux` 找到Template OS Linux模版\n![](/images/pic/zabbix/zabbix-config021.png)\n\n点击Template OS Linux模版中的`监控项-创建监控项`，完成下图设置后`添加`\n现在我们想要在Template OS Linux模版中创建CPU的上下文切换的监控项，那么我们可以在此界面进行如下配置。 \n![](/images/pic/zabbix/zabbix-config022.png)\n现在我们可以看到在Template OS Linux模版中已经有我们刚刚创建的名为Context switches per second监控项\n![](/images/pic/zabbix/zabbix-config023.png)\n此时我们让主机和该模版关联，使主机能使用该模版的监控项， 点击`配置-主机-模版`，把Template OS Linux模版链接到主机中\n![](/images/pic/zabbix/zabbix-config024.png)\n完成以上操作后，我们对主机进行cpu上下文监控也就配置完成，可以等待2分钟让zabbix进行数据采集后，在`监测-最新数据`通过过滤器过滤出CPU上下文切换的监控项最新数据\n![](/images/pic/zabbix/zabbix-config025.png)\n也可以点击旁边的图形，查看图形信息\n![](/images/pic/zabbix/zabbix-config026.png)\n\n### 配置带参数的监控项\n点击Template OS Linux模版中的`监控项-创建监控项`，由于配置项已在上面说明，我们只阐述不同的地方\n![](/images/pic/zabbix/zabbix-config027.png)\n由于Template OS Linux模版在上面已经加入到nginx1主机了，所以我们这里就不做主机和模版关联了\n![](/images/pic/zabbix/zabbix-config024.png)\n最后等待几分钟在`监测-最新数据`通过过滤器过滤出磁盘使用率的监控项最新数据\n![](/images/pic/zabbix/zabbix-config028.png)\n\n>关于这个键到底怎么使用呢，类似和fs和mode这两个参数分别代表了什么呢，我们可以通过[官网帮助手册](https://www.zabbix.com/documentation/4.0/zh/manual/config/items/itemtypes/zabbix_agent)，查看这些\"键\"的含义与使用方法。","source":"_posts/zabbix-item.md","raw":"layout: post\ntitle: Zabbix服务器监控之《配置Zabbix监控项》（四）\nauthor: Pyker\ncategories: Zabbix\nimg: /images/bar/zabbix-04.jpg\ntags:\n  - zabbix\ntop: false\ncover: false\ndate: 2018-09-12 20:10:00\n---\n通过[上一篇](https://www.ipyker.com/2018/09/11/zabbix-agent/) 我们已经进行了对zabbix的agent端安装，以及通过手动、自动发现、自动注册的方式将agent端监控到server端，也知道`应用集`、`监控项`、`触发器`是什么概念。那么本篇我们将实际配置zabbix的监控项。\n\n## 监控项说明\n在Zabbix中，我们要监控的某一个指标，被称为“监控项(item)”，比如监控磁盘的使用率，这就属于一个监控项，如果要获取到\"监控项\"的相关信息，我们则要执行一个命令，但是我们不能直接调用命令，而是通过一个\"别名\"去调用命令，这个\"命令别名\"在zabbix中被称为\"键\"(key)，所以，在zabbix中，如果我们想要获取到一个\"监控项\"的值，则需要有对应的\"键\"，通过\"键\"能够调用相应的命令，获取到对应的监控信息，而监控项的key、键值又可以为`带参数`和`不带参数`两种，下面我们将分别对其进行说明配置。 \n* **不参数键值**\n监控项键值中只有键名的键称为不带参数的键值，如`system.cpu.switches` \n* **带参数的键值**\n监控项键值中有键名和参数的键值，如`vfs.fs.size[fs,<mode>]`，对于`vfs.fs.size[fs,<mode>]`这个键来说，`vfs.fs.size`就是键名，`[fs,<mode>]`就是这个键需要的参数。而`[fs,<mode>]`这两个参数中，`fs`是不可省参数，`mode`是可省参数。\n\n## 配置监控项\n监控项可以单独配置在主机中，使该监控项专属于该主机。也可以配置在相应模版中，然后主机对该模版进行链接，从而使该主机也具有该模版的所有监控项。 \n\n<font color=#FF0000>在通常配置zabbix监控时，我们通常将监控项配置在模版中，这样方便调度和管理。(以下配置也采用监控项配置在模版里)</font>\n>系统默认自带一些模版，这些模版有监控CPU的、内存的、http的等等，如果没有自己需要的也可以自定义模版，应用集、监控项、触发器等。\n\n### 配置不带参数的监控项\n点击`配置-模版-Template OS Linux` 找到Template OS Linux模版\n![](/images/pic/zabbix/zabbix-config021.png)\n\n点击Template OS Linux模版中的`监控项-创建监控项`，完成下图设置后`添加`\n现在我们想要在Template OS Linux模版中创建CPU的上下文切换的监控项，那么我们可以在此界面进行如下配置。 \n![](/images/pic/zabbix/zabbix-config022.png)\n现在我们可以看到在Template OS Linux模版中已经有我们刚刚创建的名为Context switches per second监控项\n![](/images/pic/zabbix/zabbix-config023.png)\n此时我们让主机和该模版关联，使主机能使用该模版的监控项， 点击`配置-主机-模版`，把Template OS Linux模版链接到主机中\n![](/images/pic/zabbix/zabbix-config024.png)\n完成以上操作后，我们对主机进行cpu上下文监控也就配置完成，可以等待2分钟让zabbix进行数据采集后，在`监测-最新数据`通过过滤器过滤出CPU上下文切换的监控项最新数据\n![](/images/pic/zabbix/zabbix-config025.png)\n也可以点击旁边的图形，查看图形信息\n![](/images/pic/zabbix/zabbix-config026.png)\n\n### 配置带参数的监控项\n点击Template OS Linux模版中的`监控项-创建监控项`，由于配置项已在上面说明，我们只阐述不同的地方\n![](/images/pic/zabbix/zabbix-config027.png)\n由于Template OS Linux模版在上面已经加入到nginx1主机了，所以我们这里就不做主机和模版关联了\n![](/images/pic/zabbix/zabbix-config024.png)\n最后等待几分钟在`监测-最新数据`通过过滤器过滤出磁盘使用率的监控项最新数据\n![](/images/pic/zabbix/zabbix-config028.png)\n\n>关于这个键到底怎么使用呢，类似和fs和mode这两个参数分别代表了什么呢，我们可以通过[官网帮助手册](https://www.zabbix.com/documentation/4.0/zh/manual/config/items/itemtypes/zabbix_agent)，查看这些\"键\"的含义与使用方法。","slug":"zabbix-item","published":1,"updated":"2019-05-28T02:02:23.509Z","_id":"cjw6jleyx000sp4n74h3vtq2v","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>通过<a href=\"https://www.ipyker.com/2018/09/11/zabbix-agent/\">上一篇</a> 我们已经进行了对zabbix的agent端安装，以及通过手动、自动发现、自动注册的方式将agent端监控到server端，也知道<code>应用集</code>、<code>监控项</code>、<code>触发器</code>是什么概念。那么本篇我们将实际配置zabbix的监控项。</p>\n<h2 id=\"监控项说明\"><a href=\"#监控项说明\" class=\"headerlink\" title=\"监控项说明\"></a>监控项说明</h2><p>在Zabbix中，我们要监控的某一个指标，被称为“监控项(item)”，比如监控磁盘的使用率，这就属于一个监控项，如果要获取到”监控项”的相关信息，我们则要执行一个命令，但是我们不能直接调用命令，而是通过一个”别名”去调用命令，这个”命令别名”在zabbix中被称为”键”(key)，所以，在zabbix中，如果我们想要获取到一个”监控项”的值，则需要有对应的”键”，通过”键”能够调用相应的命令，获取到对应的监控信息，而监控项的key、键值又可以为<code>带参数</code>和<code>不带参数</code>两种，下面我们将分别对其进行说明配置。 </p>\n<ul>\n<li><strong>不参数键值</strong><br>监控项键值中只有键名的键称为不带参数的键值，如<code>system.cpu.switches</code> </li>\n<li><strong>带参数的键值</strong><br>监控项键值中有键名和参数的键值，如<code>vfs.fs.size[fs,&lt;mode&gt;]</code>，对于<code>vfs.fs.size[fs,&lt;mode&gt;]</code>这个键来说，<code>vfs.fs.size</code>就是键名，<code>[fs,&lt;mode&gt;]</code>就是这个键需要的参数。而<code>[fs,&lt;mode&gt;]</code>这两个参数中，<code>fs</code>是不可省参数，<code>mode</code>是可省参数。</li>\n</ul>\n<h2 id=\"配置监控项\"><a href=\"#配置监控项\" class=\"headerlink\" title=\"配置监控项\"></a>配置监控项</h2><p>监控项可以单独配置在主机中，使该监控项专属于该主机。也可以配置在相应模版中，然后主机对该模版进行链接，从而使该主机也具有该模版的所有监控项。 </p>\n<p><font color=\"#FF0000\">在通常配置zabbix监控时，我们通常将监控项配置在模版中，这样方便调度和管理。(以下配置也采用监控项配置在模版里)</font></p>\n<blockquote>\n<p>系统默认自带一些模版，这些模版有监控CPU的、内存的、http的等等，如果没有自己需要的也可以自定义模版，应用集、监控项、触发器等。</p>\n</blockquote>\n<h3 id=\"配置不带参数的监控项\"><a href=\"#配置不带参数的监控项\" class=\"headerlink\" title=\"配置不带参数的监控项\"></a>配置不带参数的监控项</h3><p>点击<code>配置-模版-Template OS Linux</code> 找到Template OS Linux模版<br><img src=\"/images/pic/zabbix/zabbix-config021.png\" alt></p>\n<p>点击Template OS Linux模版中的<code>监控项-创建监控项</code>，完成下图设置后<code>添加</code><br>现在我们想要在Template OS Linux模版中创建CPU的上下文切换的监控项，那么我们可以在此界面进行如下配置。<br><img src=\"/images/pic/zabbix/zabbix-config022.png\" alt><br>现在我们可以看到在Template OS Linux模版中已经有我们刚刚创建的名为Context switches per second监控项<br><img src=\"/images/pic/zabbix/zabbix-config023.png\" alt><br>此时我们让主机和该模版关联，使主机能使用该模版的监控项， 点击<code>配置-主机-模版</code>，把Template OS Linux模版链接到主机中<br><img src=\"/images/pic/zabbix/zabbix-config024.png\" alt><br>完成以上操作后，我们对主机进行cpu上下文监控也就配置完成，可以等待2分钟让zabbix进行数据采集后，在<code>监测-最新数据</code>通过过滤器过滤出CPU上下文切换的监控项最新数据<br><img src=\"/images/pic/zabbix/zabbix-config025.png\" alt><br>也可以点击旁边的图形，查看图形信息<br><img src=\"/images/pic/zabbix/zabbix-config026.png\" alt></p>\n<h3 id=\"配置带参数的监控项\"><a href=\"#配置带参数的监控项\" class=\"headerlink\" title=\"配置带参数的监控项\"></a>配置带参数的监控项</h3><p>点击Template OS Linux模版中的<code>监控项-创建监控项</code>，由于配置项已在上面说明，我们只阐述不同的地方<br><img src=\"/images/pic/zabbix/zabbix-config027.png\" alt><br>由于Template OS Linux模版在上面已经加入到nginx1主机了，所以我们这里就不做主机和模版关联了<br><img src=\"/images/pic/zabbix/zabbix-config024.png\" alt><br>最后等待几分钟在<code>监测-最新数据</code>通过过滤器过滤出磁盘使用率的监控项最新数据<br><img src=\"/images/pic/zabbix/zabbix-config028.png\" alt></p>\n<blockquote>\n<p>关于这个键到底怎么使用呢，类似和fs和mode这两个参数分别代表了什么呢，我们可以通过<a href=\"https://www.zabbix.com/documentation/4.0/zh/manual/config/items/itemtypes/zabbix_agent\" target=\"_blank\" rel=\"noopener\">官网帮助手册</a>，查看这些”键”的含义与使用方法。</p>\n</blockquote>\n","site":{"data":{}},"length":1427,"excerpt":"","more":"<p>通过<a href=\"https://www.ipyker.com/2018/09/11/zabbix-agent/\">上一篇</a> 我们已经进行了对zabbix的agent端安装，以及通过手动、自动发现、自动注册的方式将agent端监控到server端，也知道<code>应用集</code>、<code>监控项</code>、<code>触发器</code>是什么概念。那么本篇我们将实际配置zabbix的监控项。</p>\n<h2 id=\"监控项说明\"><a href=\"#监控项说明\" class=\"headerlink\" title=\"监控项说明\"></a>监控项说明</h2><p>在Zabbix中，我们要监控的某一个指标，被称为“监控项(item)”，比如监控磁盘的使用率，这就属于一个监控项，如果要获取到”监控项”的相关信息，我们则要执行一个命令，但是我们不能直接调用命令，而是通过一个”别名”去调用命令，这个”命令别名”在zabbix中被称为”键”(key)，所以，在zabbix中，如果我们想要获取到一个”监控项”的值，则需要有对应的”键”，通过”键”能够调用相应的命令，获取到对应的监控信息，而监控项的key、键值又可以为<code>带参数</code>和<code>不带参数</code>两种，下面我们将分别对其进行说明配置。 </p>\n<ul>\n<li><strong>不参数键值</strong><br>监控项键值中只有键名的键称为不带参数的键值，如<code>system.cpu.switches</code> </li>\n<li><strong>带参数的键值</strong><br>监控项键值中有键名和参数的键值，如<code>vfs.fs.size[fs,&lt;mode&gt;]</code>，对于<code>vfs.fs.size[fs,&lt;mode&gt;]</code>这个键来说，<code>vfs.fs.size</code>就是键名，<code>[fs,&lt;mode&gt;]</code>就是这个键需要的参数。而<code>[fs,&lt;mode&gt;]</code>这两个参数中，<code>fs</code>是不可省参数，<code>mode</code>是可省参数。</li>\n</ul>\n<h2 id=\"配置监控项\"><a href=\"#配置监控项\" class=\"headerlink\" title=\"配置监控项\"></a>配置监控项</h2><p>监控项可以单独配置在主机中，使该监控项专属于该主机。也可以配置在相应模版中，然后主机对该模版进行链接，从而使该主机也具有该模版的所有监控项。 </p>\n<p><font color=\"#FF0000\">在通常配置zabbix监控时，我们通常将监控项配置在模版中，这样方便调度和管理。(以下配置也采用监控项配置在模版里)</font></p>\n<blockquote>\n<p>系统默认自带一些模版，这些模版有监控CPU的、内存的、http的等等，如果没有自己需要的也可以自定义模版，应用集、监控项、触发器等。</p>\n</blockquote>\n<h3 id=\"配置不带参数的监控项\"><a href=\"#配置不带参数的监控项\" class=\"headerlink\" title=\"配置不带参数的监控项\"></a>配置不带参数的监控项</h3><p>点击<code>配置-模版-Template OS Linux</code> 找到Template OS Linux模版<br><img src=\"/images/pic/zabbix/zabbix-config021.png\" alt></p>\n<p>点击Template OS Linux模版中的<code>监控项-创建监控项</code>，完成下图设置后<code>添加</code><br>现在我们想要在Template OS Linux模版中创建CPU的上下文切换的监控项，那么我们可以在此界面进行如下配置。<br><img src=\"/images/pic/zabbix/zabbix-config022.png\" alt><br>现在我们可以看到在Template OS Linux模版中已经有我们刚刚创建的名为Context switches per second监控项<br><img src=\"/images/pic/zabbix/zabbix-config023.png\" alt><br>此时我们让主机和该模版关联，使主机能使用该模版的监控项， 点击<code>配置-主机-模版</code>，把Template OS Linux模版链接到主机中<br><img src=\"/images/pic/zabbix/zabbix-config024.png\" alt><br>完成以上操作后，我们对主机进行cpu上下文监控也就配置完成，可以等待2分钟让zabbix进行数据采集后，在<code>监测-最新数据</code>通过过滤器过滤出CPU上下文切换的监控项最新数据<br><img src=\"/images/pic/zabbix/zabbix-config025.png\" alt><br>也可以点击旁边的图形，查看图形信息<br><img src=\"/images/pic/zabbix/zabbix-config026.png\" alt></p>\n<h3 id=\"配置带参数的监控项\"><a href=\"#配置带参数的监控项\" class=\"headerlink\" title=\"配置带参数的监控项\"></a>配置带参数的监控项</h3><p>点击Template OS Linux模版中的<code>监控项-创建监控项</code>，由于配置项已在上面说明，我们只阐述不同的地方<br><img src=\"/images/pic/zabbix/zabbix-config027.png\" alt><br>由于Template OS Linux模版在上面已经加入到nginx1主机了，所以我们这里就不做主机和模版关联了<br><img src=\"/images/pic/zabbix/zabbix-config024.png\" alt><br>最后等待几分钟在<code>监测-最新数据</code>通过过滤器过滤出磁盘使用率的监控项最新数据<br><img src=\"/images/pic/zabbix/zabbix-config028.png\" alt></p>\n<blockquote>\n<p>关于这个键到底怎么使用呢，类似和fs和mode这两个参数分别代表了什么呢，我们可以通过<a href=\"https://www.zabbix.com/documentation/4.0/zh/manual/config/items/itemtypes/zabbix_agent\" target=\"_blank\" rel=\"noopener\">官网帮助手册</a>，查看这些”键”的含义与使用方法。</p>\n</blockquote>\n"},{"layout":"post","title":"Zabbix服务器监控之《安装Zabbix Server》（二）","author":"Pyker","img":"/images/bar/zabbix-02.jpg","top":false,"cover":false,"date":"2018-09-11T05:47:00.000Z","_content":"[上一篇](https://www.ipyker.com/2018/09/11/zabbix-summarize/) 我们已经讲了zabbix的常用组件和工作模式，本篇我们将进行对Zabbix Server端安装配置！\n## 搭建环境 \n### 系统信息 \n系统 | 版本 | IP | 关系\n---- | ---- | -- | ----\ncentos | 7.5 | 192.168.20.210 | 服务端\ncentos | 7.5 | 192.168.20.211 |  代理端\n\n### 环境配置 \n* 设置主机名，重启生效\n\n```bash\n# server端\n$ echo \"zabbix-server\" > /etc/hostname\n \n# agent端\n$ echo \"zabbix-agent\" > /etc/hostname\n```\n* 关闭SELinux和防火墙检查\n\n```bash\n$ sed -i \"s/SELINUX=enforcing/SELINUX=disabled/g\" /etc/selinux/config\n$ systemctl stop firewalld.service\n$ systemctl disable firewalld.service\n```\n## 安装Zabbix服务端 \n>我们这里安装的zabbix版本为4.2版本\n\n### yum安装zabbix-server\n```bash\n#yum安装zabbix源\n$ rpm -Uvh https://repo.zabbix.com/zabbix/4.2/rhel/7/x86_64/zabbix-release-4.2-1.el7.noarch.rpm\n\n#安装zabbix服务端\n#zabbix-get为测试是否能够从agent端拉取数据的工具\n$ yum -y install zabbix-server-mysql zabbix-web-mysql zabbix-agent zabbix-get\n```\n### 安装mysql数据库\n>如果有现有的数据库环境，请跳过安装数据库环节，直接从`创建zabbix数据库` 开始。\n\n```bash\n# 在线yum安装mysql5.7\n$ wget -c https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm\n$ rpm -ivh mysql80-community-release-el7-1.noarch.rpm\n$ yum -y install yum-utils\n$ yum-config-manager --disable mysql80-community\n$ yum-config-manager --enable mysql57-community\n$ yum install mysql-community-server -y\n\n# 启动mysql\n$ systemctl start mysqld\n\n# 开机启动\n$ systemctl enable mysqld\n```\n修改root密码\n```bash\n# 查看mysql临时密码\n$ grep 'temporary password' /var/log/mysqld.log\n\n# 使用mysql临时登录，修改root密码\nmysql> ALTER USER 'root'@'localhost' IDENTIFIED BY 'Ala@2018';\n```\n### 创建zabbix数据库\n创建zabbix用户和库\n```bash\nmysql> create database zabbix character set utf8 collate utf8_bin;\nmysql> grant all privileges on zabbix.* to zabbix@localhost identified by \"Ala@2018\";\n```\n### 导入zabbix数据库\n在shell命令行执行导入zabbix数据\n```bash\n$ zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p'Ala@2018' zabbix\n```\n### zabbix服务端配置\n```bash\n# 配置zabbix连接的数据库地址、数据库名以及数据库用户\nDBHost=localhost\nDBName=zabbix\nDBUser=zabbix\n\n# 修改`/etc/zabbix/zabbix_server.conf` 文件，修改mysql连接密码\nDBPassword=Ala@2018\n\n# 添加上海区\n$ sed -i.ori '19a php_value date.timezone  Asia/Shanghai' /etc/httpd/conf.d/zabbix.conf\n\n# 解决图形列表下中文乱码\n$ yum -y install wqy-microhei-fonts\n$ mv /usr/share/fonts/dejavu/DejaVuSans.ttf /usr/share/fonts/dejavu/DejaVuSans.ttf.bak\n$ cp -f /usr/share/fonts/wqy-microhei/wqy-microhei.ttc /usr/share/fonts/dejavu/DejaVuSans.ttf\n```\n### 启动zabbix服务端并配置\n```bash\n# 启动 zabbix-server和httpd服务\n$ systemctl start zabbix-server httpd\n\n# 开机启动\n$ systemctl enable zabbix-server httpd\n```\n浏览器输入`http://192.168.20.210/zabbix` ，访问zabbix，如下图\n![](/images/pic/zabbix/zabbix-config001.png)\n接下来点击 Next setup\n![](/images/pic/zabbix/zabbix-config002.png)\n从上图可以看到zabbix相关组件配置，继续点击 Next setup\n![](/images/pic/zabbix/zabbix-config003.png)\n上图中配置好之后，继续点击 Next setup\n![](/images/pic/zabbix/zabbix-config004.png)\n上图中，name尽量取有意义的名字，继续点击 Next setup\n![](/images/pic/zabbix/zabbix-config005.png)\n到这一步可以看到全部配置，确认无误后点击 Next setup\n![](/images/pic/zabbix/zabbix-config006.png)\n登录zabbix\n![](/images/pic/zabbix/zabbix-config007.png)\n登录之后点击 `管理-用户-点击Admin` ，可以设置超级管理基本属性，例如语言和主题，点击`配置-主机` ，可以看到如下图，接下来安装zabbix客户端\n![](/images/pic/zabbix/zabbix-config008.png)\n## 安装zabbix agent客户端\n>这里的客户端作用是监控服务端本机\n\n配置客户端，配置文件/etc/zabbix/zabbix_agentd.conf\n```bash\n# 主要配置如下，默认即可\nServer=127.0.0.1\nServerActive=127.0.0.1\nHostname=Zabbix server\n# 启动zabbix客户端\nsystemctl start zabbix-agent\n# 开机启动\nsystemctl enable zabbix-agent\n```\n现在可以看到`可用性ZBX` 为绿色，表示的是zabbix-agent服务连接正常\n![](/images/pic/zabbix/zabbix-config009.png)","source":"_posts/zabbix-server.md","raw":"layout: post\ntitle: Zabbix服务器监控之《安装Zabbix Server》（二）\nauthor: Pyker\ncategories: Zabbix\nimg: /images/bar/zabbix-02.jpg\ntags:\n  - zabbix\ntop: false\ncover: false\ndate: 2018-09-11 13:47:00\n---\n[上一篇](https://www.ipyker.com/2018/09/11/zabbix-summarize/) 我们已经讲了zabbix的常用组件和工作模式，本篇我们将进行对Zabbix Server端安装配置！\n## 搭建环境 \n### 系统信息 \n系统 | 版本 | IP | 关系\n---- | ---- | -- | ----\ncentos | 7.5 | 192.168.20.210 | 服务端\ncentos | 7.5 | 192.168.20.211 |  代理端\n\n### 环境配置 \n* 设置主机名，重启生效\n\n```bash\n# server端\n$ echo \"zabbix-server\" > /etc/hostname\n \n# agent端\n$ echo \"zabbix-agent\" > /etc/hostname\n```\n* 关闭SELinux和防火墙检查\n\n```bash\n$ sed -i \"s/SELINUX=enforcing/SELINUX=disabled/g\" /etc/selinux/config\n$ systemctl stop firewalld.service\n$ systemctl disable firewalld.service\n```\n## 安装Zabbix服务端 \n>我们这里安装的zabbix版本为4.2版本\n\n### yum安装zabbix-server\n```bash\n#yum安装zabbix源\n$ rpm -Uvh https://repo.zabbix.com/zabbix/4.2/rhel/7/x86_64/zabbix-release-4.2-1.el7.noarch.rpm\n\n#安装zabbix服务端\n#zabbix-get为测试是否能够从agent端拉取数据的工具\n$ yum -y install zabbix-server-mysql zabbix-web-mysql zabbix-agent zabbix-get\n```\n### 安装mysql数据库\n>如果有现有的数据库环境，请跳过安装数据库环节，直接从`创建zabbix数据库` 开始。\n\n```bash\n# 在线yum安装mysql5.7\n$ wget -c https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm\n$ rpm -ivh mysql80-community-release-el7-1.noarch.rpm\n$ yum -y install yum-utils\n$ yum-config-manager --disable mysql80-community\n$ yum-config-manager --enable mysql57-community\n$ yum install mysql-community-server -y\n\n# 启动mysql\n$ systemctl start mysqld\n\n# 开机启动\n$ systemctl enable mysqld\n```\n修改root密码\n```bash\n# 查看mysql临时密码\n$ grep 'temporary password' /var/log/mysqld.log\n\n# 使用mysql临时登录，修改root密码\nmysql> ALTER USER 'root'@'localhost' IDENTIFIED BY 'Ala@2018';\n```\n### 创建zabbix数据库\n创建zabbix用户和库\n```bash\nmysql> create database zabbix character set utf8 collate utf8_bin;\nmysql> grant all privileges on zabbix.* to zabbix@localhost identified by \"Ala@2018\";\n```\n### 导入zabbix数据库\n在shell命令行执行导入zabbix数据\n```bash\n$ zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p'Ala@2018' zabbix\n```\n### zabbix服务端配置\n```bash\n# 配置zabbix连接的数据库地址、数据库名以及数据库用户\nDBHost=localhost\nDBName=zabbix\nDBUser=zabbix\n\n# 修改`/etc/zabbix/zabbix_server.conf` 文件，修改mysql连接密码\nDBPassword=Ala@2018\n\n# 添加上海区\n$ sed -i.ori '19a php_value date.timezone  Asia/Shanghai' /etc/httpd/conf.d/zabbix.conf\n\n# 解决图形列表下中文乱码\n$ yum -y install wqy-microhei-fonts\n$ mv /usr/share/fonts/dejavu/DejaVuSans.ttf /usr/share/fonts/dejavu/DejaVuSans.ttf.bak\n$ cp -f /usr/share/fonts/wqy-microhei/wqy-microhei.ttc /usr/share/fonts/dejavu/DejaVuSans.ttf\n```\n### 启动zabbix服务端并配置\n```bash\n# 启动 zabbix-server和httpd服务\n$ systemctl start zabbix-server httpd\n\n# 开机启动\n$ systemctl enable zabbix-server httpd\n```\n浏览器输入`http://192.168.20.210/zabbix` ，访问zabbix，如下图\n![](/images/pic/zabbix/zabbix-config001.png)\n接下来点击 Next setup\n![](/images/pic/zabbix/zabbix-config002.png)\n从上图可以看到zabbix相关组件配置，继续点击 Next setup\n![](/images/pic/zabbix/zabbix-config003.png)\n上图中配置好之后，继续点击 Next setup\n![](/images/pic/zabbix/zabbix-config004.png)\n上图中，name尽量取有意义的名字，继续点击 Next setup\n![](/images/pic/zabbix/zabbix-config005.png)\n到这一步可以看到全部配置，确认无误后点击 Next setup\n![](/images/pic/zabbix/zabbix-config006.png)\n登录zabbix\n![](/images/pic/zabbix/zabbix-config007.png)\n登录之后点击 `管理-用户-点击Admin` ，可以设置超级管理基本属性，例如语言和主题，点击`配置-主机` ，可以看到如下图，接下来安装zabbix客户端\n![](/images/pic/zabbix/zabbix-config008.png)\n## 安装zabbix agent客户端\n>这里的客户端作用是监控服务端本机\n\n配置客户端，配置文件/etc/zabbix/zabbix_agentd.conf\n```bash\n# 主要配置如下，默认即可\nServer=127.0.0.1\nServerActive=127.0.0.1\nHostname=Zabbix server\n# 启动zabbix客户端\nsystemctl start zabbix-agent\n# 开机启动\nsystemctl enable zabbix-agent\n```\n现在可以看到`可用性ZBX` 为绿色，表示的是zabbix-agent服务连接正常\n![](/images/pic/zabbix/zabbix-config009.png)","slug":"zabbix-server","published":1,"updated":"2019-05-28T02:02:23.509Z","_id":"cjw6jleyz000wp4n7owjt9azi","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p><a href=\"https://www.ipyker.com/2018/09/11/zabbix-summarize/\">上一篇</a> 我们已经讲了zabbix的常用组件和工作模式，本篇我们将进行对Zabbix Server端安装配置！</p>\n<h2 id=\"搭建环境\"><a href=\"#搭建环境\" class=\"headerlink\" title=\"搭建环境\"></a>搭建环境</h2><h3 id=\"系统信息\"><a href=\"#系统信息\" class=\"headerlink\" title=\"系统信息\"></a>系统信息</h3><table>\n<thead>\n<tr>\n<th>系统</th>\n<th>版本</th>\n<th>IP</th>\n<th>关系</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>centos</td>\n<td>7.5</td>\n<td>192.168.20.210</td>\n<td>服务端</td>\n</tr>\n<tr>\n<td>centos</td>\n<td>7.5</td>\n<td>192.168.20.211</td>\n<td>代理端</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"环境配置\"><a href=\"#环境配置\" class=\"headerlink\" title=\"环境配置\"></a>环境配置</h3><ul>\n<li>设置主机名，重启生效</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># server端</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"zabbix-server\"</span> &gt; /etc/hostname</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\"># agent端</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"zabbix-agent\"</span> &gt; /etc/hostname</span><br></pre></td></tr></table></figure>\n<ul>\n<li>关闭SELinux和防火墙检查</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sed -i <span class=\"string\">\"s/SELINUX=enforcing/SELINUX=disabled/g\"</span> /etc/selinux/config</span><br><span class=\"line\">$ systemctl stop firewalld.service</span><br><span class=\"line\">$ systemctl <span class=\"built_in\">disable</span> firewalld.service</span><br></pre></td></tr></table></figure>\n<h2 id=\"安装Zabbix服务端\"><a href=\"#安装Zabbix服务端\" class=\"headerlink\" title=\"安装Zabbix服务端\"></a>安装Zabbix服务端</h2><blockquote>\n<p>我们这里安装的zabbix版本为4.2版本</p>\n</blockquote>\n<h3 id=\"yum安装zabbix-server\"><a href=\"#yum安装zabbix-server\" class=\"headerlink\" title=\"yum安装zabbix-server\"></a>yum安装zabbix-server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#yum安装zabbix源</span></span><br><span class=\"line\">$ rpm -Uvh https://repo.zabbix.com/zabbix/4.2/rhel/7/x86_64/zabbix-release-4.2-1.el7.noarch.rpm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装zabbix服务端</span></span><br><span class=\"line\"><span class=\"comment\">#zabbix-get为测试是否能够从agent端拉取数据的工具</span></span><br><span class=\"line\">$ yum -y install zabbix-server-mysql zabbix-web-mysql zabbix-agent zabbix-get</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装mysql数据库\"><a href=\"#安装mysql数据库\" class=\"headerlink\" title=\"安装mysql数据库\"></a>安装mysql数据库</h3><blockquote>\n<p>如果有现有的数据库环境，请跳过安装数据库环节，直接从<code>创建zabbix数据库</code> 开始。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在线yum安装mysql5.7</span></span><br><span class=\"line\">$ wget -c https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm</span><br><span class=\"line\">$ rpm -ivh mysql80-community-release-el7-1.noarch.rpm</span><br><span class=\"line\">$ yum -y install yum-utils</span><br><span class=\"line\">$ yum-config-manager --<span class=\"built_in\">disable</span> mysql80-community</span><br><span class=\"line\">$ yum-config-manager --<span class=\"built_in\">enable</span> mysql57-community</span><br><span class=\"line\">$ yum install mysql-community-server -y</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动mysql</span></span><br><span class=\"line\">$ systemctl start mysqld</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开机启动</span></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> mysqld</span><br></pre></td></tr></table></figure>\n<p>修改root密码<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看mysql临时密码</span></span><br><span class=\"line\">$ grep <span class=\"string\">'temporary password'</span> /var/<span class=\"built_in\">log</span>/mysqld.log</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用mysql临时登录，修改root密码</span></span><br><span class=\"line\">mysql&gt; ALTER USER <span class=\"string\">'root'</span>@<span class=\"string\">'localhost'</span> IDENTIFIED BY <span class=\"string\">'Ala@2018'</span>;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"创建zabbix数据库\"><a href=\"#创建zabbix数据库\" class=\"headerlink\" title=\"创建zabbix数据库\"></a>创建zabbix数据库</h3><p>创建zabbix用户和库<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; create database zabbix character <span class=\"built_in\">set</span> utf8 collate utf8_bin;</span><br><span class=\"line\">mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by <span class=\"string\">\"Ala@2018\"</span>;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"导入zabbix数据库\"><a href=\"#导入zabbix数据库\" class=\"headerlink\" title=\"导入zabbix数据库\"></a>导入zabbix数据库</h3><p>在shell命令行执行导入zabbix数据<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p<span class=\"string\">'Ala@2018'</span> zabbix</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"zabbix服务端配置\"><a href=\"#zabbix服务端配置\" class=\"headerlink\" title=\"zabbix服务端配置\"></a>zabbix服务端配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置zabbix连接的数据库地址、数据库名以及数据库用户</span></span><br><span class=\"line\">DBHost=localhost</span><br><span class=\"line\">DBName=zabbix</span><br><span class=\"line\">DBUser=zabbix</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改`/etc/zabbix/zabbix_server.conf` 文件，修改mysql连接密码</span></span><br><span class=\"line\">DBPassword=Ala@2018</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加上海区</span></span><br><span class=\"line\">$ sed -i.ori <span class=\"string\">'19a php_value date.timezone  Asia/Shanghai'</span> /etc/httpd/conf.d/zabbix.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解决图形列表下中文乱码</span></span><br><span class=\"line\">$ yum -y install wqy-microhei-fonts</span><br><span class=\"line\">$ mv /usr/share/fonts/dejavu/DejaVuSans.ttf /usr/share/fonts/dejavu/DejaVuSans.ttf.bak</span><br><span class=\"line\">$ cp -f /usr/share/fonts/wqy-microhei/wqy-microhei.ttc /usr/share/fonts/dejavu/DejaVuSans.ttf</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动zabbix服务端并配置\"><a href=\"#启动zabbix服务端并配置\" class=\"headerlink\" title=\"启动zabbix服务端并配置\"></a>启动zabbix服务端并配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启动 zabbix-server和httpd服务</span></span><br><span class=\"line\">$ systemctl start zabbix-server httpd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开机启动</span></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> zabbix-server httpd</span><br></pre></td></tr></table></figure>\n<p>浏览器输入<code>http://192.168.20.210/zabbix</code> ，访问zabbix，如下图<br><img src=\"/images/pic/zabbix/zabbix-config001.png\" alt><br>接下来点击 Next setup<br><img src=\"/images/pic/zabbix/zabbix-config002.png\" alt><br>从上图可以看到zabbix相关组件配置，继续点击 Next setup<br><img src=\"/images/pic/zabbix/zabbix-config003.png\" alt><br>上图中配置好之后，继续点击 Next setup<br><img src=\"/images/pic/zabbix/zabbix-config004.png\" alt><br>上图中，name尽量取有意义的名字，继续点击 Next setup<br><img src=\"/images/pic/zabbix/zabbix-config005.png\" alt><br>到这一步可以看到全部配置，确认无误后点击 Next setup<br><img src=\"/images/pic/zabbix/zabbix-config006.png\" alt><br>登录zabbix<br><img src=\"/images/pic/zabbix/zabbix-config007.png\" alt><br>登录之后点击 <code>管理-用户-点击Admin</code> ，可以设置超级管理基本属性，例如语言和主题，点击<code>配置-主机</code> ，可以看到如下图，接下来安装zabbix客户端<br><img src=\"/images/pic/zabbix/zabbix-config008.png\" alt></p>\n<h2 id=\"安装zabbix-agent客户端\"><a href=\"#安装zabbix-agent客户端\" class=\"headerlink\" title=\"安装zabbix agent客户端\"></a>安装zabbix agent客户端</h2><blockquote>\n<p>这里的客户端作用是监控服务端本机</p>\n</blockquote>\n<p>配置客户端，配置文件/etc/zabbix/zabbix_agentd.conf<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 主要配置如下，默认即可</span></span><br><span class=\"line\">Server=127.0.0.1</span><br><span class=\"line\">ServerActive=127.0.0.1</span><br><span class=\"line\">Hostname=Zabbix server</span><br><span class=\"line\"><span class=\"comment\"># 启动zabbix客户端</span></span><br><span class=\"line\">systemctl start zabbix-agent</span><br><span class=\"line\"><span class=\"comment\"># 开机启动</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> zabbix-agent</span><br></pre></td></tr></table></figure></p>\n<p>现在可以看到<code>可用性ZBX</code> 为绿色，表示的是zabbix-agent服务连接正常<br><img src=\"/images/pic/zabbix/zabbix-config009.png\" alt></p>\n","site":{"data":{}},"length":2728,"excerpt":"","more":"<p><a href=\"https://www.ipyker.com/2018/09/11/zabbix-summarize/\">上一篇</a> 我们已经讲了zabbix的常用组件和工作模式，本篇我们将进行对Zabbix Server端安装配置！</p>\n<h2 id=\"搭建环境\"><a href=\"#搭建环境\" class=\"headerlink\" title=\"搭建环境\"></a>搭建环境</h2><h3 id=\"系统信息\"><a href=\"#系统信息\" class=\"headerlink\" title=\"系统信息\"></a>系统信息</h3><table>\n<thead>\n<tr>\n<th>系统</th>\n<th>版本</th>\n<th>IP</th>\n<th>关系</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>centos</td>\n<td>7.5</td>\n<td>192.168.20.210</td>\n<td>服务端</td>\n</tr>\n<tr>\n<td>centos</td>\n<td>7.5</td>\n<td>192.168.20.211</td>\n<td>代理端</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"环境配置\"><a href=\"#环境配置\" class=\"headerlink\" title=\"环境配置\"></a>环境配置</h3><ul>\n<li>设置主机名，重启生效</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># server端</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"zabbix-server\"</span> &gt; /etc/hostname</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\"># agent端</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"zabbix-agent\"</span> &gt; /etc/hostname</span><br></pre></td></tr></table></figure>\n<ul>\n<li>关闭SELinux和防火墙检查</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sed -i <span class=\"string\">\"s/SELINUX=enforcing/SELINUX=disabled/g\"</span> /etc/selinux/config</span><br><span class=\"line\">$ systemctl stop firewalld.service</span><br><span class=\"line\">$ systemctl <span class=\"built_in\">disable</span> firewalld.service</span><br></pre></td></tr></table></figure>\n<h2 id=\"安装Zabbix服务端\"><a href=\"#安装Zabbix服务端\" class=\"headerlink\" title=\"安装Zabbix服务端\"></a>安装Zabbix服务端</h2><blockquote>\n<p>我们这里安装的zabbix版本为4.2版本</p>\n</blockquote>\n<h3 id=\"yum安装zabbix-server\"><a href=\"#yum安装zabbix-server\" class=\"headerlink\" title=\"yum安装zabbix-server\"></a>yum安装zabbix-server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#yum安装zabbix源</span></span><br><span class=\"line\">$ rpm -Uvh https://repo.zabbix.com/zabbix/4.2/rhel/7/x86_64/zabbix-release-4.2-1.el7.noarch.rpm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装zabbix服务端</span></span><br><span class=\"line\"><span class=\"comment\">#zabbix-get为测试是否能够从agent端拉取数据的工具</span></span><br><span class=\"line\">$ yum -y install zabbix-server-mysql zabbix-web-mysql zabbix-agent zabbix-get</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装mysql数据库\"><a href=\"#安装mysql数据库\" class=\"headerlink\" title=\"安装mysql数据库\"></a>安装mysql数据库</h3><blockquote>\n<p>如果有现有的数据库环境，请跳过安装数据库环节，直接从<code>创建zabbix数据库</code> 开始。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在线yum安装mysql5.7</span></span><br><span class=\"line\">$ wget -c https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm</span><br><span class=\"line\">$ rpm -ivh mysql80-community-release-el7-1.noarch.rpm</span><br><span class=\"line\">$ yum -y install yum-utils</span><br><span class=\"line\">$ yum-config-manager --<span class=\"built_in\">disable</span> mysql80-community</span><br><span class=\"line\">$ yum-config-manager --<span class=\"built_in\">enable</span> mysql57-community</span><br><span class=\"line\">$ yum install mysql-community-server -y</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动mysql</span></span><br><span class=\"line\">$ systemctl start mysqld</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开机启动</span></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> mysqld</span><br></pre></td></tr></table></figure>\n<p>修改root密码<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看mysql临时密码</span></span><br><span class=\"line\">$ grep <span class=\"string\">'temporary password'</span> /var/<span class=\"built_in\">log</span>/mysqld.log</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用mysql临时登录，修改root密码</span></span><br><span class=\"line\">mysql&gt; ALTER USER <span class=\"string\">'root'</span>@<span class=\"string\">'localhost'</span> IDENTIFIED BY <span class=\"string\">'Ala@2018'</span>;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"创建zabbix数据库\"><a href=\"#创建zabbix数据库\" class=\"headerlink\" title=\"创建zabbix数据库\"></a>创建zabbix数据库</h3><p>创建zabbix用户和库<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; create database zabbix character <span class=\"built_in\">set</span> utf8 collate utf8_bin;</span><br><span class=\"line\">mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by <span class=\"string\">\"Ala@2018\"</span>;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"导入zabbix数据库\"><a href=\"#导入zabbix数据库\" class=\"headerlink\" title=\"导入zabbix数据库\"></a>导入zabbix数据库</h3><p>在shell命令行执行导入zabbix数据<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p<span class=\"string\">'Ala@2018'</span> zabbix</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"zabbix服务端配置\"><a href=\"#zabbix服务端配置\" class=\"headerlink\" title=\"zabbix服务端配置\"></a>zabbix服务端配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置zabbix连接的数据库地址、数据库名以及数据库用户</span></span><br><span class=\"line\">DBHost=localhost</span><br><span class=\"line\">DBName=zabbix</span><br><span class=\"line\">DBUser=zabbix</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改`/etc/zabbix/zabbix_server.conf` 文件，修改mysql连接密码</span></span><br><span class=\"line\">DBPassword=Ala@2018</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加上海区</span></span><br><span class=\"line\">$ sed -i.ori <span class=\"string\">'19a php_value date.timezone  Asia/Shanghai'</span> /etc/httpd/conf.d/zabbix.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解决图形列表下中文乱码</span></span><br><span class=\"line\">$ yum -y install wqy-microhei-fonts</span><br><span class=\"line\">$ mv /usr/share/fonts/dejavu/DejaVuSans.ttf /usr/share/fonts/dejavu/DejaVuSans.ttf.bak</span><br><span class=\"line\">$ cp -f /usr/share/fonts/wqy-microhei/wqy-microhei.ttc /usr/share/fonts/dejavu/DejaVuSans.ttf</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动zabbix服务端并配置\"><a href=\"#启动zabbix服务端并配置\" class=\"headerlink\" title=\"启动zabbix服务端并配置\"></a>启动zabbix服务端并配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启动 zabbix-server和httpd服务</span></span><br><span class=\"line\">$ systemctl start zabbix-server httpd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开机启动</span></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> zabbix-server httpd</span><br></pre></td></tr></table></figure>\n<p>浏览器输入<code>http://192.168.20.210/zabbix</code> ，访问zabbix，如下图<br><img src=\"/images/pic/zabbix/zabbix-config001.png\" alt><br>接下来点击 Next setup<br><img src=\"/images/pic/zabbix/zabbix-config002.png\" alt><br>从上图可以看到zabbix相关组件配置，继续点击 Next setup<br><img src=\"/images/pic/zabbix/zabbix-config003.png\" alt><br>上图中配置好之后，继续点击 Next setup<br><img src=\"/images/pic/zabbix/zabbix-config004.png\" alt><br>上图中，name尽量取有意义的名字，继续点击 Next setup<br><img src=\"/images/pic/zabbix/zabbix-config005.png\" alt><br>到这一步可以看到全部配置，确认无误后点击 Next setup<br><img src=\"/images/pic/zabbix/zabbix-config006.png\" alt><br>登录zabbix<br><img src=\"/images/pic/zabbix/zabbix-config007.png\" alt><br>登录之后点击 <code>管理-用户-点击Admin</code> ，可以设置超级管理基本属性，例如语言和主题，点击<code>配置-主机</code> ，可以看到如下图，接下来安装zabbix客户端<br><img src=\"/images/pic/zabbix/zabbix-config008.png\" alt></p>\n<h2 id=\"安装zabbix-agent客户端\"><a href=\"#安装zabbix-agent客户端\" class=\"headerlink\" title=\"安装zabbix agent客户端\"></a>安装zabbix agent客户端</h2><blockquote>\n<p>这里的客户端作用是监控服务端本机</p>\n</blockquote>\n<p>配置客户端，配置文件/etc/zabbix/zabbix_agentd.conf<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 主要配置如下，默认即可</span></span><br><span class=\"line\">Server=127.0.0.1</span><br><span class=\"line\">ServerActive=127.0.0.1</span><br><span class=\"line\">Hostname=Zabbix server</span><br><span class=\"line\"><span class=\"comment\"># 启动zabbix客户端</span></span><br><span class=\"line\">systemctl start zabbix-agent</span><br><span class=\"line\"><span class=\"comment\"># 开机启动</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> zabbix-agent</span><br></pre></td></tr></table></figure></p>\n<p>现在可以看到<code>可用性ZBX</code> 为绿色，表示的是zabbix-agent服务连接正常<br><img src=\"/images/pic/zabbix/zabbix-config009.png\" alt></p>\n"},{"layout":"post","title":"Zabbix服务器监控之《初识zabbix概念》（一）","author":"Pyker","img":"/images/bar/zabbix-01.jpg","top":false,"cover":false,"date":"2018-09-11T04:27:00.000Z","_content":"## 为什么要用Zabbix\n对于运维人员来说，监控是非常重要的，因为如果想要保证线上业务整体能够稳定运行，那么我们则需要实时关注与其相关的各项指标是否正常，而一个业务系统的背后，往往存在着很多的服务器、网络设备等硬件资源，如果我们想要能够更加方便的、集中的监控他们，我们则需要依靠一些外部的工具，而zabbix就是一个被广泛使用的，可以实现集中监控管理的应用程序。\n\n## Zabbix支持那些通讯方式\n* `agent` ：通过专用的代理程序进行监控，与常见的master/agent模型类似,如果被监控对象支持对应的agent，推荐首选这种方式。\n* `ssh/telnet` ：通过远程控制协议进行通讯，比如ssh或者telnet。\n* `SNMP` ：通过SNMP协议与被监控对象进行通讯，SNMP协议的全称为Simple Network Management Protocol ,被译为 \"简单网络管理协议\"，通常来说，我们无法在路由器、交换机这种硬件上安装agent，但是这些硬件往往都支持SNMP协议，SNMP是一种比较久远的、通行的协议，大部分网络设备都支持这种协议，其实SNMP协议的工作方式也可以理解为master/agent的工作方式，只不过是在这些设备中内置了SNMP的agent而已，所以，大部分网络设备都支持这种协议。\n* `IPMI` ：通过IPMI接口进行监控，我们可以通过标准的IPMI硬件接口，监控被监控对象的物理特征，比如电压，温度，风扇状态，电源状态等。\n* `JMX` ：通过JMX进行监控，JMX（Java Management Extensions，即Java管理扩展），监控JVM虚拟机时，使用这种方法也是非常不错的选择。\n\n## Zabbix监控流程\n一般情况下，我们将zabbix agent部署到被监控主机上，由agent采集数据，报告给负责监控的中心主机，中心主机也就是master/agent模型中的master，负责监控的中心主机被称为zabbix server，zabbix server将从agent端接收到的信息存储于zabbix的数据库中，我们把zabbix的数据库端称为zabbix database， 如果管理员需要查看各种监控信息，则需要zabbix的GUI，zabbix的GUI是一种Web GUI，我们称之为zabbix web，zabbix web是使用php编写的，所以，如果想要使用zabbix web展示相关监控信息，需要依赖LAMP环境，不管是zabbix server ，或是zabbix web，他们都需要连接到zabbix database获取相关数据，这样说可能不容易理解，对比下图理解上述概念，就容易许多。\n![](/images/pic/zabbix/zabbix1.png)\n\n当监控规模变得庞大时，我们可能有成千上万台设备需要监控，这时我们是否需要部署多套zabbix系统进行监控呢？如果部署多套zabbix监控系统，那么监控压力将会被分摊，但是，这些监控的对象将会被尽量平均的分配到不同的监控系统中，这个时候，我们就无法通过统一的监控入口，去监控这些对象了，虽然分摊了监控压力，但是也增加了监控工作的复杂度，那么，我们到底该不该建立多套zabbix监控系统从而分摊巨大的监控压力呢？其实，zabbix天生就有处理这种问题的能力，因为zabbix支持分布式监控，我们可以把成千上万台的被监控对象分成不同的区域，每个区域中设置一台代理主机，区域内的每个被监控对象的信息被agent采集，提交给代理主机，在这个区域内，代理主机的作用就好比zabbix server，我们称这些代理主机为zabbix proxy，zabbix proxy再将收集到的信息统一提交给真正的zabbix server处理，这样，zabbix proxy分摊了zabbix server的压力，同时，我们还能够通过统一的监控入口，监控所有的对象，当监控规模庞大到需要使用zabbix proxy时，zabbix的架构如下图，我们可以对比下图，理解上述描述。\n![](/images/pic/zabbix/zabbix2.png)\n\n## 总结\n### zabbix核心组件\n* `zabbix agent` ：部署在被监控主机上，负责被监控主机的数据，并将数据发送给zabbix server。\n* `zabbix server` ：负责接收agent发送的报告信息，并且负责组织配置信息、统计信息、操作数据等。\n* `zabbix database` ：用于存储所有zabbix的配置信息、监控数据的数据库。\n* `zabbix proxy` ：可选组件，用于分布式监控环境中，zabbix proxy代表server端，完成局部区域内的信息收集，最终统一发往server端。\n\n### zabbix工作模式\n我们知道，agent端会将采集完的数据主动发送给server端，这种模式我们称之为主动模式，即对于agent端来说是主动的。\n其实，agent端也可以不主动发送数据，而是等待server过来拉取数据，这种模式我们称之为被动模式。\n但是，不管是主动模式还是被动模式，都是对于agent端来说的，而且，主动模式与被动模式可以同时存在，并不冲突。\n管理员可以在agent端使用一个名为`zabbix_sender` 的工具，测试是否能够向server端发送数据。\n管理员也可以在server端使用一个名为`zabbix_get` 的工具，测试是否能够从agent端拉取数据。","source":"_posts/zabbix-summarize.md","raw":"layout: post\ntitle: Zabbix服务器监控之《初识zabbix概念》（一）\nauthor: Pyker\ncategories: Zabbix\nimg: /images/bar/zabbix-01.jpg\ntags:\n  - zabbix\ntop: false\ncover: false\ndate: 2018-09-11 12:27:00\n---\n## 为什么要用Zabbix\n对于运维人员来说，监控是非常重要的，因为如果想要保证线上业务整体能够稳定运行，那么我们则需要实时关注与其相关的各项指标是否正常，而一个业务系统的背后，往往存在着很多的服务器、网络设备等硬件资源，如果我们想要能够更加方便的、集中的监控他们，我们则需要依靠一些外部的工具，而zabbix就是一个被广泛使用的，可以实现集中监控管理的应用程序。\n\n## Zabbix支持那些通讯方式\n* `agent` ：通过专用的代理程序进行监控，与常见的master/agent模型类似,如果被监控对象支持对应的agent，推荐首选这种方式。\n* `ssh/telnet` ：通过远程控制协议进行通讯，比如ssh或者telnet。\n* `SNMP` ：通过SNMP协议与被监控对象进行通讯，SNMP协议的全称为Simple Network Management Protocol ,被译为 \"简单网络管理协议\"，通常来说，我们无法在路由器、交换机这种硬件上安装agent，但是这些硬件往往都支持SNMP协议，SNMP是一种比较久远的、通行的协议，大部分网络设备都支持这种协议，其实SNMP协议的工作方式也可以理解为master/agent的工作方式，只不过是在这些设备中内置了SNMP的agent而已，所以，大部分网络设备都支持这种协议。\n* `IPMI` ：通过IPMI接口进行监控，我们可以通过标准的IPMI硬件接口，监控被监控对象的物理特征，比如电压，温度，风扇状态，电源状态等。\n* `JMX` ：通过JMX进行监控，JMX（Java Management Extensions，即Java管理扩展），监控JVM虚拟机时，使用这种方法也是非常不错的选择。\n\n## Zabbix监控流程\n一般情况下，我们将zabbix agent部署到被监控主机上，由agent采集数据，报告给负责监控的中心主机，中心主机也就是master/agent模型中的master，负责监控的中心主机被称为zabbix server，zabbix server将从agent端接收到的信息存储于zabbix的数据库中，我们把zabbix的数据库端称为zabbix database， 如果管理员需要查看各种监控信息，则需要zabbix的GUI，zabbix的GUI是一种Web GUI，我们称之为zabbix web，zabbix web是使用php编写的，所以，如果想要使用zabbix web展示相关监控信息，需要依赖LAMP环境，不管是zabbix server ，或是zabbix web，他们都需要连接到zabbix database获取相关数据，这样说可能不容易理解，对比下图理解上述概念，就容易许多。\n![](/images/pic/zabbix/zabbix1.png)\n\n当监控规模变得庞大时，我们可能有成千上万台设备需要监控，这时我们是否需要部署多套zabbix系统进行监控呢？如果部署多套zabbix监控系统，那么监控压力将会被分摊，但是，这些监控的对象将会被尽量平均的分配到不同的监控系统中，这个时候，我们就无法通过统一的监控入口，去监控这些对象了，虽然分摊了监控压力，但是也增加了监控工作的复杂度，那么，我们到底该不该建立多套zabbix监控系统从而分摊巨大的监控压力呢？其实，zabbix天生就有处理这种问题的能力，因为zabbix支持分布式监控，我们可以把成千上万台的被监控对象分成不同的区域，每个区域中设置一台代理主机，区域内的每个被监控对象的信息被agent采集，提交给代理主机，在这个区域内，代理主机的作用就好比zabbix server，我们称这些代理主机为zabbix proxy，zabbix proxy再将收集到的信息统一提交给真正的zabbix server处理，这样，zabbix proxy分摊了zabbix server的压力，同时，我们还能够通过统一的监控入口，监控所有的对象，当监控规模庞大到需要使用zabbix proxy时，zabbix的架构如下图，我们可以对比下图，理解上述描述。\n![](/images/pic/zabbix/zabbix2.png)\n\n## 总结\n### zabbix核心组件\n* `zabbix agent` ：部署在被监控主机上，负责被监控主机的数据，并将数据发送给zabbix server。\n* `zabbix server` ：负责接收agent发送的报告信息，并且负责组织配置信息、统计信息、操作数据等。\n* `zabbix database` ：用于存储所有zabbix的配置信息、监控数据的数据库。\n* `zabbix proxy` ：可选组件，用于分布式监控环境中，zabbix proxy代表server端，完成局部区域内的信息收集，最终统一发往server端。\n\n### zabbix工作模式\n我们知道，agent端会将采集完的数据主动发送给server端，这种模式我们称之为主动模式，即对于agent端来说是主动的。\n其实，agent端也可以不主动发送数据，而是等待server过来拉取数据，这种模式我们称之为被动模式。\n但是，不管是主动模式还是被动模式，都是对于agent端来说的，而且，主动模式与被动模式可以同时存在，并不冲突。\n管理员可以在agent端使用一个名为`zabbix_sender` 的工具，测试是否能够向server端发送数据。\n管理员也可以在server端使用一个名为`zabbix_get` 的工具，测试是否能够从agent端拉取数据。","slug":"zabbix-summarize","published":1,"updated":"2019-05-28T02:02:23.510Z","_id":"cjw6jlez0000zp4n79apd6t0b","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"为什么要用Zabbix\"><a href=\"#为什么要用Zabbix\" class=\"headerlink\" title=\"为什么要用Zabbix\"></a>为什么要用Zabbix</h2><p>对于运维人员来说，监控是非常重要的，因为如果想要保证线上业务整体能够稳定运行，那么我们则需要实时关注与其相关的各项指标是否正常，而一个业务系统的背后，往往存在着很多的服务器、网络设备等硬件资源，如果我们想要能够更加方便的、集中的监控他们，我们则需要依靠一些外部的工具，而zabbix就是一个被广泛使用的，可以实现集中监控管理的应用程序。</p>\n<h2 id=\"Zabbix支持那些通讯方式\"><a href=\"#Zabbix支持那些通讯方式\" class=\"headerlink\" title=\"Zabbix支持那些通讯方式\"></a>Zabbix支持那些通讯方式</h2><ul>\n<li><code>agent</code> ：通过专用的代理程序进行监控，与常见的master/agent模型类似,如果被监控对象支持对应的agent，推荐首选这种方式。</li>\n<li><code>ssh/telnet</code> ：通过远程控制协议进行通讯，比如ssh或者telnet。</li>\n<li><code>SNMP</code> ：通过SNMP协议与被监控对象进行通讯，SNMP协议的全称为Simple Network Management Protocol ,被译为 “简单网络管理协议”，通常来说，我们无法在路由器、交换机这种硬件上安装agent，但是这些硬件往往都支持SNMP协议，SNMP是一种比较久远的、通行的协议，大部分网络设备都支持这种协议，其实SNMP协议的工作方式也可以理解为master/agent的工作方式，只不过是在这些设备中内置了SNMP的agent而已，所以，大部分网络设备都支持这种协议。</li>\n<li><code>IPMI</code> ：通过IPMI接口进行监控，我们可以通过标准的IPMI硬件接口，监控被监控对象的物理特征，比如电压，温度，风扇状态，电源状态等。</li>\n<li><code>JMX</code> ：通过JMX进行监控，JMX（Java Management Extensions，即Java管理扩展），监控JVM虚拟机时，使用这种方法也是非常不错的选择。</li>\n</ul>\n<h2 id=\"Zabbix监控流程\"><a href=\"#Zabbix监控流程\" class=\"headerlink\" title=\"Zabbix监控流程\"></a>Zabbix监控流程</h2><p>一般情况下，我们将zabbix agent部署到被监控主机上，由agent采集数据，报告给负责监控的中心主机，中心主机也就是master/agent模型中的master，负责监控的中心主机被称为zabbix server，zabbix server将从agent端接收到的信息存储于zabbix的数据库中，我们把zabbix的数据库端称为zabbix database， 如果管理员需要查看各种监控信息，则需要zabbix的GUI，zabbix的GUI是一种Web GUI，我们称之为zabbix web，zabbix web是使用php编写的，所以，如果想要使用zabbix web展示相关监控信息，需要依赖LAMP环境，不管是zabbix server ，或是zabbix web，他们都需要连接到zabbix database获取相关数据，这样说可能不容易理解，对比下图理解上述概念，就容易许多。<br><img src=\"/images/pic/zabbix/zabbix1.png\" alt></p>\n<p>当监控规模变得庞大时，我们可能有成千上万台设备需要监控，这时我们是否需要部署多套zabbix系统进行监控呢？如果部署多套zabbix监控系统，那么监控压力将会被分摊，但是，这些监控的对象将会被尽量平均的分配到不同的监控系统中，这个时候，我们就无法通过统一的监控入口，去监控这些对象了，虽然分摊了监控压力，但是也增加了监控工作的复杂度，那么，我们到底该不该建立多套zabbix监控系统从而分摊巨大的监控压力呢？其实，zabbix天生就有处理这种问题的能力，因为zabbix支持分布式监控，我们可以把成千上万台的被监控对象分成不同的区域，每个区域中设置一台代理主机，区域内的每个被监控对象的信息被agent采集，提交给代理主机，在这个区域内，代理主机的作用就好比zabbix server，我们称这些代理主机为zabbix proxy，zabbix proxy再将收集到的信息统一提交给真正的zabbix server处理，这样，zabbix proxy分摊了zabbix server的压力，同时，我们还能够通过统一的监控入口，监控所有的对象，当监控规模庞大到需要使用zabbix proxy时，zabbix的架构如下图，我们可以对比下图，理解上述描述。<br><img src=\"/images/pic/zabbix/zabbix2.png\" alt></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><h3 id=\"zabbix核心组件\"><a href=\"#zabbix核心组件\" class=\"headerlink\" title=\"zabbix核心组件\"></a>zabbix核心组件</h3><ul>\n<li><code>zabbix agent</code> ：部署在被监控主机上，负责被监控主机的数据，并将数据发送给zabbix server。</li>\n<li><code>zabbix server</code> ：负责接收agent发送的报告信息，并且负责组织配置信息、统计信息、操作数据等。</li>\n<li><code>zabbix database</code> ：用于存储所有zabbix的配置信息、监控数据的数据库。</li>\n<li><code>zabbix proxy</code> ：可选组件，用于分布式监控环境中，zabbix proxy代表server端，完成局部区域内的信息收集，最终统一发往server端。</li>\n</ul>\n<h3 id=\"zabbix工作模式\"><a href=\"#zabbix工作模式\" class=\"headerlink\" title=\"zabbix工作模式\"></a>zabbix工作模式</h3><p>我们知道，agent端会将采集完的数据主动发送给server端，这种模式我们称之为主动模式，即对于agent端来说是主动的。<br>其实，agent端也可以不主动发送数据，而是等待server过来拉取数据，这种模式我们称之为被动模式。<br>但是，不管是主动模式还是被动模式，都是对于agent端来说的，而且，主动模式与被动模式可以同时存在，并不冲突。<br>管理员可以在agent端使用一个名为<code>zabbix_sender</code> 的工具，测试是否能够向server端发送数据。<br>管理员也可以在server端使用一个名为<code>zabbix_get</code> 的工具，测试是否能够从agent端拉取数据。</p>\n","site":{"data":{}},"length":2187,"excerpt":"","more":"<h2 id=\"为什么要用Zabbix\"><a href=\"#为什么要用Zabbix\" class=\"headerlink\" title=\"为什么要用Zabbix\"></a>为什么要用Zabbix</h2><p>对于运维人员来说，监控是非常重要的，因为如果想要保证线上业务整体能够稳定运行，那么我们则需要实时关注与其相关的各项指标是否正常，而一个业务系统的背后，往往存在着很多的服务器、网络设备等硬件资源，如果我们想要能够更加方便的、集中的监控他们，我们则需要依靠一些外部的工具，而zabbix就是一个被广泛使用的，可以实现集中监控管理的应用程序。</p>\n<h2 id=\"Zabbix支持那些通讯方式\"><a href=\"#Zabbix支持那些通讯方式\" class=\"headerlink\" title=\"Zabbix支持那些通讯方式\"></a>Zabbix支持那些通讯方式</h2><ul>\n<li><code>agent</code> ：通过专用的代理程序进行监控，与常见的master/agent模型类似,如果被监控对象支持对应的agent，推荐首选这种方式。</li>\n<li><code>ssh/telnet</code> ：通过远程控制协议进行通讯，比如ssh或者telnet。</li>\n<li><code>SNMP</code> ：通过SNMP协议与被监控对象进行通讯，SNMP协议的全称为Simple Network Management Protocol ,被译为 “简单网络管理协议”，通常来说，我们无法在路由器、交换机这种硬件上安装agent，但是这些硬件往往都支持SNMP协议，SNMP是一种比较久远的、通行的协议，大部分网络设备都支持这种协议，其实SNMP协议的工作方式也可以理解为master/agent的工作方式，只不过是在这些设备中内置了SNMP的agent而已，所以，大部分网络设备都支持这种协议。</li>\n<li><code>IPMI</code> ：通过IPMI接口进行监控，我们可以通过标准的IPMI硬件接口，监控被监控对象的物理特征，比如电压，温度，风扇状态，电源状态等。</li>\n<li><code>JMX</code> ：通过JMX进行监控，JMX（Java Management Extensions，即Java管理扩展），监控JVM虚拟机时，使用这种方法也是非常不错的选择。</li>\n</ul>\n<h2 id=\"Zabbix监控流程\"><a href=\"#Zabbix监控流程\" class=\"headerlink\" title=\"Zabbix监控流程\"></a>Zabbix监控流程</h2><p>一般情况下，我们将zabbix agent部署到被监控主机上，由agent采集数据，报告给负责监控的中心主机，中心主机也就是master/agent模型中的master，负责监控的中心主机被称为zabbix server，zabbix server将从agent端接收到的信息存储于zabbix的数据库中，我们把zabbix的数据库端称为zabbix database， 如果管理员需要查看各种监控信息，则需要zabbix的GUI，zabbix的GUI是一种Web GUI，我们称之为zabbix web，zabbix web是使用php编写的，所以，如果想要使用zabbix web展示相关监控信息，需要依赖LAMP环境，不管是zabbix server ，或是zabbix web，他们都需要连接到zabbix database获取相关数据，这样说可能不容易理解，对比下图理解上述概念，就容易许多。<br><img src=\"/images/pic/zabbix/zabbix1.png\" alt></p>\n<p>当监控规模变得庞大时，我们可能有成千上万台设备需要监控，这时我们是否需要部署多套zabbix系统进行监控呢？如果部署多套zabbix监控系统，那么监控压力将会被分摊，但是，这些监控的对象将会被尽量平均的分配到不同的监控系统中，这个时候，我们就无法通过统一的监控入口，去监控这些对象了，虽然分摊了监控压力，但是也增加了监控工作的复杂度，那么，我们到底该不该建立多套zabbix监控系统从而分摊巨大的监控压力呢？其实，zabbix天生就有处理这种问题的能力，因为zabbix支持分布式监控，我们可以把成千上万台的被监控对象分成不同的区域，每个区域中设置一台代理主机，区域内的每个被监控对象的信息被agent采集，提交给代理主机，在这个区域内，代理主机的作用就好比zabbix server，我们称这些代理主机为zabbix proxy，zabbix proxy再将收集到的信息统一提交给真正的zabbix server处理，这样，zabbix proxy分摊了zabbix server的压力，同时，我们还能够通过统一的监控入口，监控所有的对象，当监控规模庞大到需要使用zabbix proxy时，zabbix的架构如下图，我们可以对比下图，理解上述描述。<br><img src=\"/images/pic/zabbix/zabbix2.png\" alt></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><h3 id=\"zabbix核心组件\"><a href=\"#zabbix核心组件\" class=\"headerlink\" title=\"zabbix核心组件\"></a>zabbix核心组件</h3><ul>\n<li><code>zabbix agent</code> ：部署在被监控主机上，负责被监控主机的数据，并将数据发送给zabbix server。</li>\n<li><code>zabbix server</code> ：负责接收agent发送的报告信息，并且负责组织配置信息、统计信息、操作数据等。</li>\n<li><code>zabbix database</code> ：用于存储所有zabbix的配置信息、监控数据的数据库。</li>\n<li><code>zabbix proxy</code> ：可选组件，用于分布式监控环境中，zabbix proxy代表server端，完成局部区域内的信息收集，最终统一发往server端。</li>\n</ul>\n<h3 id=\"zabbix工作模式\"><a href=\"#zabbix工作模式\" class=\"headerlink\" title=\"zabbix工作模式\"></a>zabbix工作模式</h3><p>我们知道，agent端会将采集完的数据主动发送给server端，这种模式我们称之为主动模式，即对于agent端来说是主动的。<br>其实，agent端也可以不主动发送数据，而是等待server过来拉取数据，这种模式我们称之为被动模式。<br>但是，不管是主动模式还是被动模式，都是对于agent端来说的，而且，主动模式与被动模式可以同时存在，并不冲突。<br>管理员可以在agent端使用一个名为<code>zabbix_sender</code> 的工具，测试是否能够向server端发送数据。<br>管理员也可以在server端使用一个名为<code>zabbix_get</code> 的工具，测试是否能够从agent端拉取数据。</p>\n"},{"layout":"post","title":"Zabbix服务器监控之《配置Zabbix触发器》（五）","author":"Pyker","img":"/images/bar/zabbix-05.jpg","top":false,"cover":false,"date":"2018-09-13T03:30:00.000Z","_content":"[上一篇](https://www.ipyker.com/2018/09/12/zabbix-item/) 我们已经配置过zabbix的监控项了，本篇我们将再进行对监控项的触发器配置。而在配置zabbix触发器前，我们再来理解一下`触发器`，`事件`，`动作`。\n\n`触发器（Triggers）`：我们可以把zabbix的触发器理解成一个条件表达式，我们往往通过触发器定义被监控项的阈值，当触发器对应的表达式被满足时，则代表被监控项达到了我们设定的阈值，也就意味着发生了我们不想要遇到的问题，换句话说，当监控项的值处于合理范围时，触发器不会被触发，当监控项的值超出合理范围（即达到阈值），触发器则会被触发，当触发器被触发时，往往代表着出现了问题，触发器未被触发时，其的状态为\"OK\",当触发器被触发时，触发器的状态为\"Problem\"，当被监控项的值达到阈值时，触发器的状态从\"OK\"变为\"Problem\",当监控项的值再次回归到合理范围时，触发器的状态会从\"Problem\"转换回\"OK\"。\n\n`事件（Events）`：当触发器的状态发生改变时，则会产生对应的\"事件\"，当然，由触发器的状态改变而产生的事件被称为\"触发器事件\"，zabbix中，事件分为几种类型，除了\"触发器事件\"，还有一些别的事件，此处为了方便描述，暂且不提及他们，我们可以把\"事件\"大概理解成一个重要的事情。\n\n`动作（Actions）`：当某个事件产生时，需要对应的处理措施，这种处理措施被称为动作。\n\n## 配置触发器\n>*我们还是以上节监控nginx1主机根目录的监控项为例进行创建触发器*\n\n点击`配置-主机`进入对应主机上的`触发器`后，点击右上角的`创建触发器`\n![](/images/pic/zabbix/zabbix-config029.png)\n根据下图配置触发器信息，触发器也可以在模版的监控项中创建，也可以在主机中创建。\n![](/images/pic/zabbix/zabbix-config030.png)\n点击`添加`后，我们可以在对应主机中查看根目录使用率的触发器\n![](/images/pic/zabbix/zabbix-config031.png)\n最后，我们在`监测-最新数据`中过滤显示根目录使用率监控项，点击图形，可以看到该监控项已经有触发器了。\n![](/images/pic/zabbix/zabbix-config032.png) \n至此，一个关于磁盘根目录使用率超过5%后的触发器就配置完成。然而当这个监控项的值达到我们指定的阈值5%时，就会产生某个\"事件\"，以便我们采取后续的措施，而这个后续操作可以是命令，也可以是报警通知。\n\n## 触发器表达式说明\n如下图，触发器的表达式生成方式\n![](/images/pic/zabbix/zabbix-config033.png)\n>其实，上面的5个部分我们可以通过如下语法表示，如下语法描述了一个触发器的条件表达式的基本结构，`{<server>:<key>.<function>(<parameter>)}<operator><constant>`\n\n下面我们对触发器的表达式语法进行说明，如：`{web server1:vfs.fs.size[/,pused].last()}>5`，那么，我们把该表达式分解成5个部分，从而方便我们去理解。\n* `web server1 `：表示主机名称。\n* `vfs.fs.size[/,pused]`：表示对应主机上某个监控项对应的key。\n* `last()`：对应上述语法中的<function>(<parameter>)，last()被我们称之为函数。\n* `\\>`：对应了上述语法中的<operator>，其实就是常用的比较操作符或者运算操作符。\n* `5`：表示用于设定监控项对应的阈值。\n\n`function`除了last()常用的有 avg、count、change、sum、max、min、date等，看这些函数的名字你也能猜出其大概的作用，无非就是获取监控项的值的最大值，最小值，值的总和，或者平均值等，如果你想要了解它们，可以登录zabbix的官网查看[触发器表达式函数在线手册](https://www.zabbix.com/documentation/4.0/zh/manual/appendix/triggers/functions)\n\n而函数的参数格式变化则比较少，如果参数值前面带有\"#\"作为前缀,则表示次数，比如avg(#10),则表示最近10次监控项的值的平均值，如果参数值前面没有\"#\"作为前缀，则表示时间，比如sum(300),表示300秒内监控项的值的总和，max(#20)则表示最近20次监控项的值的最大值，min(600)则表示最近10分钟内监控项的值的最小值，但是需要注意，last(0)的含义与last(#1)的含义相同，都表示最近一次。有的函数还支持使用第二个参数，比如avg(1h,1d) ，表示一天前的一小时内的监控项的值的平均值，假设现在的时间是5点，avg(1h)可以理解为4点到5点之间的监控项的值的平均值，而avg(1h,1d) 中的1d表示时间偏移量，那么avg(1h,1d)可以理解为昨天4点到5点的监控项的值的平均值。\n\n`operator`，其实就是常用的比较操作符或者运算操作符，由于zabbix版本的不同，操作符可能有所变化，zabbix4.0支持的操作符可以[操作符参考在线手册](https://www.zabbix.com/documentation/4.0/zh/manual/config/triggers/expression)。","source":"_posts/zabbix-trigger.md","raw":"layout: post\ntitle: Zabbix服务器监控之《配置Zabbix触发器》（五）\nauthor: Pyker\ncategories: Zabbix\nimg: /images/bar/zabbix-05.jpg\ntags:\n  - zabbix\ntop: false\ncover: false\ndate: 2018-09-13 11:30:00\n---\n[上一篇](https://www.ipyker.com/2018/09/12/zabbix-item/) 我们已经配置过zabbix的监控项了，本篇我们将再进行对监控项的触发器配置。而在配置zabbix触发器前，我们再来理解一下`触发器`，`事件`，`动作`。\n\n`触发器（Triggers）`：我们可以把zabbix的触发器理解成一个条件表达式，我们往往通过触发器定义被监控项的阈值，当触发器对应的表达式被满足时，则代表被监控项达到了我们设定的阈值，也就意味着发生了我们不想要遇到的问题，换句话说，当监控项的值处于合理范围时，触发器不会被触发，当监控项的值超出合理范围（即达到阈值），触发器则会被触发，当触发器被触发时，往往代表着出现了问题，触发器未被触发时，其的状态为\"OK\",当触发器被触发时，触发器的状态为\"Problem\"，当被监控项的值达到阈值时，触发器的状态从\"OK\"变为\"Problem\",当监控项的值再次回归到合理范围时，触发器的状态会从\"Problem\"转换回\"OK\"。\n\n`事件（Events）`：当触发器的状态发生改变时，则会产生对应的\"事件\"，当然，由触发器的状态改变而产生的事件被称为\"触发器事件\"，zabbix中，事件分为几种类型，除了\"触发器事件\"，还有一些别的事件，此处为了方便描述，暂且不提及他们，我们可以把\"事件\"大概理解成一个重要的事情。\n\n`动作（Actions）`：当某个事件产生时，需要对应的处理措施，这种处理措施被称为动作。\n\n## 配置触发器\n>*我们还是以上节监控nginx1主机根目录的监控项为例进行创建触发器*\n\n点击`配置-主机`进入对应主机上的`触发器`后，点击右上角的`创建触发器`\n![](/images/pic/zabbix/zabbix-config029.png)\n根据下图配置触发器信息，触发器也可以在模版的监控项中创建，也可以在主机中创建。\n![](/images/pic/zabbix/zabbix-config030.png)\n点击`添加`后，我们可以在对应主机中查看根目录使用率的触发器\n![](/images/pic/zabbix/zabbix-config031.png)\n最后，我们在`监测-最新数据`中过滤显示根目录使用率监控项，点击图形，可以看到该监控项已经有触发器了。\n![](/images/pic/zabbix/zabbix-config032.png) \n至此，一个关于磁盘根目录使用率超过5%后的触发器就配置完成。然而当这个监控项的值达到我们指定的阈值5%时，就会产生某个\"事件\"，以便我们采取后续的措施，而这个后续操作可以是命令，也可以是报警通知。\n\n## 触发器表达式说明\n如下图，触发器的表达式生成方式\n![](/images/pic/zabbix/zabbix-config033.png)\n>其实，上面的5个部分我们可以通过如下语法表示，如下语法描述了一个触发器的条件表达式的基本结构，`{<server>:<key>.<function>(<parameter>)}<operator><constant>`\n\n下面我们对触发器的表达式语法进行说明，如：`{web server1:vfs.fs.size[/,pused].last()}>5`，那么，我们把该表达式分解成5个部分，从而方便我们去理解。\n* `web server1 `：表示主机名称。\n* `vfs.fs.size[/,pused]`：表示对应主机上某个监控项对应的key。\n* `last()`：对应上述语法中的<function>(<parameter>)，last()被我们称之为函数。\n* `\\>`：对应了上述语法中的<operator>，其实就是常用的比较操作符或者运算操作符。\n* `5`：表示用于设定监控项对应的阈值。\n\n`function`除了last()常用的有 avg、count、change、sum、max、min、date等，看这些函数的名字你也能猜出其大概的作用，无非就是获取监控项的值的最大值，最小值，值的总和，或者平均值等，如果你想要了解它们，可以登录zabbix的官网查看[触发器表达式函数在线手册](https://www.zabbix.com/documentation/4.0/zh/manual/appendix/triggers/functions)\n\n而函数的参数格式变化则比较少，如果参数值前面带有\"#\"作为前缀,则表示次数，比如avg(#10),则表示最近10次监控项的值的平均值，如果参数值前面没有\"#\"作为前缀，则表示时间，比如sum(300),表示300秒内监控项的值的总和，max(#20)则表示最近20次监控项的值的最大值，min(600)则表示最近10分钟内监控项的值的最小值，但是需要注意，last(0)的含义与last(#1)的含义相同，都表示最近一次。有的函数还支持使用第二个参数，比如avg(1h,1d) ，表示一天前的一小时内的监控项的值的平均值，假设现在的时间是5点，avg(1h)可以理解为4点到5点之间的监控项的值的平均值，而avg(1h,1d) 中的1d表示时间偏移量，那么avg(1h,1d)可以理解为昨天4点到5点的监控项的值的平均值。\n\n`operator`，其实就是常用的比较操作符或者运算操作符，由于zabbix版本的不同，操作符可能有所变化，zabbix4.0支持的操作符可以[操作符参考在线手册](https://www.zabbix.com/documentation/4.0/zh/manual/config/triggers/expression)。","slug":"zabbix-trigger","published":1,"updated":"2019-05-28T02:02:23.510Z","_id":"cjw6jlez20012p4n7xaq1nk9y","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p><a href=\"https://www.ipyker.com/2018/09/12/zabbix-item/\">上一篇</a> 我们已经配置过zabbix的监控项了，本篇我们将再进行对监控项的触发器配置。而在配置zabbix触发器前，我们再来理解一下<code>触发器</code>，<code>事件</code>，<code>动作</code>。</p>\n<p><code>触发器（Triggers）</code>：我们可以把zabbix的触发器理解成一个条件表达式，我们往往通过触发器定义被监控项的阈值，当触发器对应的表达式被满足时，则代表被监控项达到了我们设定的阈值，也就意味着发生了我们不想要遇到的问题，换句话说，当监控项的值处于合理范围时，触发器不会被触发，当监控项的值超出合理范围（即达到阈值），触发器则会被触发，当触发器被触发时，往往代表着出现了问题，触发器未被触发时，其的状态为”OK”,当触发器被触发时，触发器的状态为”Problem”，当被监控项的值达到阈值时，触发器的状态从”OK”变为”Problem”,当监控项的值再次回归到合理范围时，触发器的状态会从”Problem”转换回”OK”。</p>\n<p><code>事件（Events）</code>：当触发器的状态发生改变时，则会产生对应的”事件”，当然，由触发器的状态改变而产生的事件被称为”触发器事件”，zabbix中，事件分为几种类型，除了”触发器事件”，还有一些别的事件，此处为了方便描述，暂且不提及他们，我们可以把”事件”大概理解成一个重要的事情。</p>\n<p><code>动作（Actions）</code>：当某个事件产生时，需要对应的处理措施，这种处理措施被称为动作。</p>\n<h2 id=\"配置触发器\"><a href=\"#配置触发器\" class=\"headerlink\" title=\"配置触发器\"></a>配置触发器</h2><blockquote>\n<p><em>我们还是以上节监控nginx1主机根目录的监控项为例进行创建触发器</em></p>\n</blockquote>\n<p>点击<code>配置-主机</code>进入对应主机上的<code>触发器</code>后，点击右上角的<code>创建触发器</code><br><img src=\"/images/pic/zabbix/zabbix-config029.png\" alt><br>根据下图配置触发器信息，触发器也可以在模版的监控项中创建，也可以在主机中创建。<br><img src=\"/images/pic/zabbix/zabbix-config030.png\" alt><br>点击<code>添加</code>后，我们可以在对应主机中查看根目录使用率的触发器<br><img src=\"/images/pic/zabbix/zabbix-config031.png\" alt><br>最后，我们在<code>监测-最新数据</code>中过滤显示根目录使用率监控项，点击图形，可以看到该监控项已经有触发器了。<br><img src=\"/images/pic/zabbix/zabbix-config032.png\" alt><br>至此，一个关于磁盘根目录使用率超过5%后的触发器就配置完成。然而当这个监控项的值达到我们指定的阈值5%时，就会产生某个”事件”，以便我们采取后续的措施，而这个后续操作可以是命令，也可以是报警通知。</p>\n<h2 id=\"触发器表达式说明\"><a href=\"#触发器表达式说明\" class=\"headerlink\" title=\"触发器表达式说明\"></a>触发器表达式说明</h2><p>如下图，触发器的表达式生成方式<br><img src=\"/images/pic/zabbix/zabbix-config033.png\" alt></p>\n<blockquote>\n<p>其实，上面的5个部分我们可以通过如下语法表示，如下语法描述了一个触发器的条件表达式的基本结构，<code>{&lt;server&gt;:&lt;key&gt;.&lt;function&gt;(&lt;parameter&gt;)}&lt;operator&gt;&lt;constant&gt;</code></p>\n</blockquote>\n<p>下面我们对触发器的表达式语法进行说明，如：<code>{web server1:vfs.fs.size[/,pused].last()}&gt;5</code>，那么，我们把该表达式分解成5个部分，从而方便我们去理解。</p>\n<ul>\n<li><code>web server1</code>：表示主机名称。</li>\n<li><code>vfs.fs.size[/,pused]</code>：表示对应主机上某个监控项对应的key。</li>\n<li><code>last()</code>：对应上述语法中的<function>(<parameter>)，last()被我们称之为函数。</parameter></function></li>\n<li><code>\\&gt;</code>：对应了上述语法中的<operator>，其实就是常用的比较操作符或者运算操作符。</operator></li>\n<li><code>5</code>：表示用于设定监控项对应的阈值。</li>\n</ul>\n<p><code>function</code>除了last()常用的有 avg、count、change、sum、max、min、date等，看这些函数的名字你也能猜出其大概的作用，无非就是获取监控项的值的最大值，最小值，值的总和，或者平均值等，如果你想要了解它们，可以登录zabbix的官网查看<a href=\"https://www.zabbix.com/documentation/4.0/zh/manual/appendix/triggers/functions\" target=\"_blank\" rel=\"noopener\">触发器表达式函数在线手册</a></p>\n<p>而函数的参数格式变化则比较少，如果参数值前面带有”#”作为前缀,则表示次数，比如avg(#10),则表示最近10次监控项的值的平均值，如果参数值前面没有”#”作为前缀，则表示时间，比如sum(300),表示300秒内监控项的值的总和，max(#20)则表示最近20次监控项的值的最大值，min(600)则表示最近10分钟内监控项的值的最小值，但是需要注意，last(0)的含义与last(#1)的含义相同，都表示最近一次。有的函数还支持使用第二个参数，比如avg(1h,1d) ，表示一天前的一小时内的监控项的值的平均值，假设现在的时间是5点，avg(1h)可以理解为4点到5点之间的监控项的值的平均值，而avg(1h,1d) 中的1d表示时间偏移量，那么avg(1h,1d)可以理解为昨天4点到5点的监控项的值的平均值。</p>\n<p><code>operator</code>，其实就是常用的比较操作符或者运算操作符，由于zabbix版本的不同，操作符可能有所变化，zabbix4.0支持的操作符可以<a href=\"https://www.zabbix.com/documentation/4.0/zh/manual/config/triggers/expression\" target=\"_blank\" rel=\"noopener\">操作符参考在线手册</a>。</p>\n","site":{"data":{}},"length":1868,"excerpt":"","more":"<p><a href=\"https://www.ipyker.com/2018/09/12/zabbix-item/\">上一篇</a> 我们已经配置过zabbix的监控项了，本篇我们将再进行对监控项的触发器配置。而在配置zabbix触发器前，我们再来理解一下<code>触发器</code>，<code>事件</code>，<code>动作</code>。</p>\n<p><code>触发器（Triggers）</code>：我们可以把zabbix的触发器理解成一个条件表达式，我们往往通过触发器定义被监控项的阈值，当触发器对应的表达式被满足时，则代表被监控项达到了我们设定的阈值，也就意味着发生了我们不想要遇到的问题，换句话说，当监控项的值处于合理范围时，触发器不会被触发，当监控项的值超出合理范围（即达到阈值），触发器则会被触发，当触发器被触发时，往往代表着出现了问题，触发器未被触发时，其的状态为”OK”,当触发器被触发时，触发器的状态为”Problem”，当被监控项的值达到阈值时，触发器的状态从”OK”变为”Problem”,当监控项的值再次回归到合理范围时，触发器的状态会从”Problem”转换回”OK”。</p>\n<p><code>事件（Events）</code>：当触发器的状态发生改变时，则会产生对应的”事件”，当然，由触发器的状态改变而产生的事件被称为”触发器事件”，zabbix中，事件分为几种类型，除了”触发器事件”，还有一些别的事件，此处为了方便描述，暂且不提及他们，我们可以把”事件”大概理解成一个重要的事情。</p>\n<p><code>动作（Actions）</code>：当某个事件产生时，需要对应的处理措施，这种处理措施被称为动作。</p>\n<h2 id=\"配置触发器\"><a href=\"#配置触发器\" class=\"headerlink\" title=\"配置触发器\"></a>配置触发器</h2><blockquote>\n<p><em>我们还是以上节监控nginx1主机根目录的监控项为例进行创建触发器</em></p>\n</blockquote>\n<p>点击<code>配置-主机</code>进入对应主机上的<code>触发器</code>后，点击右上角的<code>创建触发器</code><br><img src=\"/images/pic/zabbix/zabbix-config029.png\" alt><br>根据下图配置触发器信息，触发器也可以在模版的监控项中创建，也可以在主机中创建。<br><img src=\"/images/pic/zabbix/zabbix-config030.png\" alt><br>点击<code>添加</code>后，我们可以在对应主机中查看根目录使用率的触发器<br><img src=\"/images/pic/zabbix/zabbix-config031.png\" alt><br>最后，我们在<code>监测-最新数据</code>中过滤显示根目录使用率监控项，点击图形，可以看到该监控项已经有触发器了。<br><img src=\"/images/pic/zabbix/zabbix-config032.png\" alt><br>至此，一个关于磁盘根目录使用率超过5%后的触发器就配置完成。然而当这个监控项的值达到我们指定的阈值5%时，就会产生某个”事件”，以便我们采取后续的措施，而这个后续操作可以是命令，也可以是报警通知。</p>\n<h2 id=\"触发器表达式说明\"><a href=\"#触发器表达式说明\" class=\"headerlink\" title=\"触发器表达式说明\"></a>触发器表达式说明</h2><p>如下图，触发器的表达式生成方式<br><img src=\"/images/pic/zabbix/zabbix-config033.png\" alt></p>\n<blockquote>\n<p>其实，上面的5个部分我们可以通过如下语法表示，如下语法描述了一个触发器的条件表达式的基本结构，<code>{&lt;server&gt;:&lt;key&gt;.&lt;function&gt;(&lt;parameter&gt;)}&lt;operator&gt;&lt;constant&gt;</code></p>\n</blockquote>\n<p>下面我们对触发器的表达式语法进行说明，如：<code>{web server1:vfs.fs.size[/,pused].last()}&gt;5</code>，那么，我们把该表达式分解成5个部分，从而方便我们去理解。</p>\n<ul>\n<li><code>web server1</code>：表示主机名称。</li>\n<li><code>vfs.fs.size[/,pused]</code>：表示对应主机上某个监控项对应的key。</li>\n<li><code>last()</code>：对应上述语法中的<function>(<parameter>)，last()被我们称之为函数。</parameter></function></li>\n<li><code>\\&gt;</code>：对应了上述语法中的<operator>，其实就是常用的比较操作符或者运算操作符。</operator></li>\n<li><code>5</code>：表示用于设定监控项对应的阈值。</li>\n</ul>\n<p><code>function</code>除了last()常用的有 avg、count、change、sum、max、min、date等，看这些函数的名字你也能猜出其大概的作用，无非就是获取监控项的值的最大值，最小值，值的总和，或者平均值等，如果你想要了解它们，可以登录zabbix的官网查看<a href=\"https://www.zabbix.com/documentation/4.0/zh/manual/appendix/triggers/functions\" target=\"_blank\" rel=\"noopener\">触发器表达式函数在线手册</a></p>\n<p>而函数的参数格式变化则比较少，如果参数值前面带有”#”作为前缀,则表示次数，比如avg(#10),则表示最近10次监控项的值的平均值，如果参数值前面没有”#”作为前缀，则表示时间，比如sum(300),表示300秒内监控项的值的总和，max(#20)则表示最近20次监控项的值的最大值，min(600)则表示最近10分钟内监控项的值的最小值，但是需要注意，last(0)的含义与last(#1)的含义相同，都表示最近一次。有的函数还支持使用第二个参数，比如avg(1h,1d) ，表示一天前的一小时内的监控项的值的平均值，假设现在的时间是5点，avg(1h)可以理解为4点到5点之间的监控项的值的平均值，而avg(1h,1d) 中的1d表示时间偏移量，那么avg(1h,1d)可以理解为昨天4点到5点的监控项的值的平均值。</p>\n<p><code>operator</code>，其实就是常用的比较操作符或者运算操作符，由于zabbix版本的不同，操作符可能有所变化，zabbix4.0支持的操作符可以<a href=\"https://www.zabbix.com/documentation/4.0/zh/manual/config/triggers/expression\" target=\"_blank\" rel=\"noopener\">操作符参考在线手册</a>。</p>\n"},{"layout":"post","title":"Zabbix服务器监控之《配置Zabbix报警》（六）","author":"Pyker","img":"/images/bar/zabbix-06.jpg","top":false,"cover":false,"date":"2018-09-13T08:30:00.000Z","_content":"[上一篇](https://www.ipyker.com/2018/09/13/zabbix-trigger/) 我们已经配置过zabbix的触发器了，也知道当触发器阀值达到时，应该有一个动作，而这个动作可以是执行脚本，也可以是发邮件报警通知用户。那么本篇我们将再进行对zabbix的报警进行配置。\n\n## 报警媒介类型\n当zabbix中的某些被监控指标出现异常时，zabbix会通过哪种方式通知运维人员呢？是通过邮件呢，还是通过短信呢，或者是通过其他方式呢？今天我们就来聊聊zabbix的报警方式，无论是通过邮件报警还是通过短信报警，无非都是通过某种\"媒介\"将报警信息传递给收信人，所以在zabbix中，报警方式被称为\"报警媒介\"，那么，zabbix都支持哪些报警媒介呢，我们一起来看看。\nzabbix支持的报警媒介如下：\n\n* `Email`：邮件，这是最常用也是最传统的一种报警媒介，邮件报警，zabbix通过配置好的SMTP邮件服务器向用户发送对应的报警信息。\n* `Script`：脚本，当zabbix中的某些监控项出现异常时，也可以调用自定义的脚本进行报警，脚本的使用就比较灵活，具体怎样报警全看你的脚本怎么写。\n* `SMS`：短信，如果想要使用短信报警，则需要依赖短信网关（貌似需要北美的运行商）。\n* `Jabber`：即时通讯服务。\n* `Ez Texting`：商业的，收费的短信服务（北美运营商提供服务）。\n* `第三方的onealert`\n\n## 定义报警媒介\n>*下面我们通过配置邮件报警媒介来进行配置说明*\n\n点击`管理-报警媒介类型-创建媒介类型`，输入完信息后，点击`添加`  \n![](/images/pic/zabbix/zabbix-config034.png) \n之后，我们可以在报警媒介类型中看到已经添加的报警类型，点击右边的`测试`，可以测试当前邮件配置是否正常，如果配置正常你将收到测试的邮件。\n![](/images/pic/zabbix/zabbix-config035.png) \n到此处，我们已经成功的定义了一个\"报警媒介\"，从此，我们可以通过这个媒介，向用户发送报警信息了。\n\n## 配置用户接受报警通知媒介\n但是，如果想要某个zabbix用户能够接收到从\"email报警媒介\"发送过来的报警，还需要进一步配置，比如，当\"Admin\"用户想要通过\"email\"报警媒介接收警报时，则必须能够\"适配\"这种媒介，如果\"Admin\"用户没有使用\"email媒介\"的能力，那么\"Admin\"用户将无法接收到由\"email媒介\"发出的报警信息。我们应该怎样让用户能够对应的报警媒介呢，配置步骤如下。\n\n点击`管理-用户-Admin-报警媒介`\n![](/images/pic/zabbix/zabbix-config036.png) \n到此处，我们已经成功的定义了一个用户能接受对应\"报警媒介\"的邮件通知了。\n\n## 配置告警动作\n>在zabbix中创建一个动作，前文中我们已经创建了用于监控磁盘根目录使用率的监控项,以及对应的触发器，现在，我们需要创建一个动作，与监控项和触发器结合起来一起使用。 \n\n打开zabbix控制台，点击`配置-动作-事件源-触发器-创建动作`\n![](/images/pic/zabbix/zabbix-config037.png)\n点击`操作`\n![](/images/pic/zabbix/zabbix-config038.png)\n点击`恢复操作`\n![](/images/pic/zabbix/zabbix-config039.png)\n完成以上配置，点击`添加`即可添加一个对该触发器的动作。 \n\n**上图报警的宏如下，更多的宏参考[官方宏使用](https://www.zabbix.com/documentation/4.0/zh/manual/appendix/macros/supported_by_location) **\n```bash\n# 故障时\n默认标题：故障{TRIGGER.STATUS},服务器:{HOSTNAME}发生: {TRIGGER.NAME}故障!\n消息内容：\n告警主机:{HOSTNAME}\n告警时间:{EVENT.DATE} {EVENT.TIME}\n告警等级:{TRIGGER.SEVERITY}\n告警信息: {TRIGGER.NAME}\n告警项目:{TRIGGER.KEY}\n问题详情:{ITEM.NAME}:{ITEM.VALUE}\n当前状态:{TRIGGER.STATUS}:{ITEM.VALUE}\n事件ID:{EVENT.ID}\n\n恢复时\n默认标题：恢复{TRIGGER.STATUS}, 服务器:{HOSTNAME}: {TRIGGER.NAME}已恢复!\n消息内容：\n告警主机:{HOSTNAME}\n告警时间:{EVENT.DATE} {EVENT.TIME}\n告警等级:{TRIGGER.SEVERITY}\n告警信息: {TRIGGER.NAME}\n告警项目:{TRIGGER.KEY}\n问题详情:{ITEM.NAME}:{ITEM.VALUE}\n当前状态:{TRIGGER.STATUS}:{ITEM.VALUE}\n事件ID:{EVENT.ID}\n```\n\n## 模拟告警\n在此之前我们已经总结了主机、监控项、触发器、事件、动作等相关知识点，但是到目前为止，还没有真正的收到过任何一个zabbix中的警告，那么这次，我们就在之前的基础上，刻意的让磁盘根目录使用率这个监控项达到指定的阈值，看看能否正常的收到报警信息。 \n![](/images/pic/zabbix/zabbix-config040.png) \n在模拟前，我们先看看之前磁盘根目录使用率是多少，使用率0.39% 阀值5%。好了，现在我们进入到被监控主机的根分区，在根分区中创建一个大文件，提高磁盘使用率。\n```bash\n[root@k8s nginx]# dd if=/dev/zero of=/testfile count=20 bs=1G\n记录了20+0 的读入\n记录了20+0 的写出\n21474836480字节(21 GB)已复制，44.8811 秒，478 MB/秒\n[root@k8s nginx]# df -h\n文件系统        容量  已用  可用 已用% 挂载点\n/dev/sda5       296G   22G  275G    8% /\ndevtmpfs        3.9G     0  3.9G    0% /dev\ntmpfs           3.9G     0  3.9G    0% /dev/shm\ntmpfs           3.9G   18M  3.9G    1% /run\ntmpfs           3.9G     0  3.9G    0% /sys/fs/cgroup\n/dev/sda2       200G   33M  200G    1% /home\n/dev/sda1       297M  107M  191M   36% /boot\ntmpfs           797M     0  797M    0% /run/user/0\n```\n此时我们的根分区使用率已经达到了8%，超过了触发器设置的阀值5%，我们看看下图，（这里显示的是7.16%和df -h命令8%差一点点是由于linux只显示整数，小数点增1位）\n![](/images/pic/zabbix/zabbix-config041.png) \n我们配置的是1分钟检测一次，因此我们能很快收到`故障邮件通知`报警。如下\n![](/images/pic/zabbix/zabbix-config042.png) \n此时我们删掉`dd命令`生成的testfile文件进行恢复测试。\n```bash\n[root@k8s /]# rm -rf testfile \n[root@k8s /]# df -h\n文件系统        容量  已用  可用 已用% 挂载点\n/dev/sda5       296G  1.2G  295G    1% /\ndevtmpfs        3.9G     0  3.9G    0% /dev\ntmpfs           3.9G     0  3.9G    0% /dev/shm\ntmpfs           3.9G   18M  3.9G    1% /run\ntmpfs           3.9G     0  3.9G    0% /sys/fs/cgroup\n/dev/sda2       200G   33M  200G    1% /home\n/dev/sda1       297M  107M  191M   36% /boot\ntmpfs           797M     0  797M    0% /run/user/0\n```\n那么很快我们将收到监控项`恢复的邮件通知`\n![](/images/pic/zabbix/zabbix-config043.png)\n至此，我们已经完成了初步的zabbix使用了。也可以用户监控环境去监控服务了，当然监控项、触发器等还需要根据实际情况去配置。","source":"_posts/zabbox-alert.md","raw":"layout: post\ntitle: Zabbix服务器监控之《配置Zabbix报警》（六）\nauthor: Pyker\ncategories: Zabbix\nimg: /images/bar/zabbix-06.jpg\ntags:\n  - zabbix\ntop: false\ncover: false\ndate: 2018-09-13 16:30:00\n---\n[上一篇](https://www.ipyker.com/2018/09/13/zabbix-trigger/) 我们已经配置过zabbix的触发器了，也知道当触发器阀值达到时，应该有一个动作，而这个动作可以是执行脚本，也可以是发邮件报警通知用户。那么本篇我们将再进行对zabbix的报警进行配置。\n\n## 报警媒介类型\n当zabbix中的某些被监控指标出现异常时，zabbix会通过哪种方式通知运维人员呢？是通过邮件呢，还是通过短信呢，或者是通过其他方式呢？今天我们就来聊聊zabbix的报警方式，无论是通过邮件报警还是通过短信报警，无非都是通过某种\"媒介\"将报警信息传递给收信人，所以在zabbix中，报警方式被称为\"报警媒介\"，那么，zabbix都支持哪些报警媒介呢，我们一起来看看。\nzabbix支持的报警媒介如下：\n\n* `Email`：邮件，这是最常用也是最传统的一种报警媒介，邮件报警，zabbix通过配置好的SMTP邮件服务器向用户发送对应的报警信息。\n* `Script`：脚本，当zabbix中的某些监控项出现异常时，也可以调用自定义的脚本进行报警，脚本的使用就比较灵活，具体怎样报警全看你的脚本怎么写。\n* `SMS`：短信，如果想要使用短信报警，则需要依赖短信网关（貌似需要北美的运行商）。\n* `Jabber`：即时通讯服务。\n* `Ez Texting`：商业的，收费的短信服务（北美运营商提供服务）。\n* `第三方的onealert`\n\n## 定义报警媒介\n>*下面我们通过配置邮件报警媒介来进行配置说明*\n\n点击`管理-报警媒介类型-创建媒介类型`，输入完信息后，点击`添加`  \n![](/images/pic/zabbix/zabbix-config034.png) \n之后，我们可以在报警媒介类型中看到已经添加的报警类型，点击右边的`测试`，可以测试当前邮件配置是否正常，如果配置正常你将收到测试的邮件。\n![](/images/pic/zabbix/zabbix-config035.png) \n到此处，我们已经成功的定义了一个\"报警媒介\"，从此，我们可以通过这个媒介，向用户发送报警信息了。\n\n## 配置用户接受报警通知媒介\n但是，如果想要某个zabbix用户能够接收到从\"email报警媒介\"发送过来的报警，还需要进一步配置，比如，当\"Admin\"用户想要通过\"email\"报警媒介接收警报时，则必须能够\"适配\"这种媒介，如果\"Admin\"用户没有使用\"email媒介\"的能力，那么\"Admin\"用户将无法接收到由\"email媒介\"发出的报警信息。我们应该怎样让用户能够对应的报警媒介呢，配置步骤如下。\n\n点击`管理-用户-Admin-报警媒介`\n![](/images/pic/zabbix/zabbix-config036.png) \n到此处，我们已经成功的定义了一个用户能接受对应\"报警媒介\"的邮件通知了。\n\n## 配置告警动作\n>在zabbix中创建一个动作，前文中我们已经创建了用于监控磁盘根目录使用率的监控项,以及对应的触发器，现在，我们需要创建一个动作，与监控项和触发器结合起来一起使用。 \n\n打开zabbix控制台，点击`配置-动作-事件源-触发器-创建动作`\n![](/images/pic/zabbix/zabbix-config037.png)\n点击`操作`\n![](/images/pic/zabbix/zabbix-config038.png)\n点击`恢复操作`\n![](/images/pic/zabbix/zabbix-config039.png)\n完成以上配置，点击`添加`即可添加一个对该触发器的动作。 \n\n**上图报警的宏如下，更多的宏参考[官方宏使用](https://www.zabbix.com/documentation/4.0/zh/manual/appendix/macros/supported_by_location) **\n```bash\n# 故障时\n默认标题：故障{TRIGGER.STATUS},服务器:{HOSTNAME}发生: {TRIGGER.NAME}故障!\n消息内容：\n告警主机:{HOSTNAME}\n告警时间:{EVENT.DATE} {EVENT.TIME}\n告警等级:{TRIGGER.SEVERITY}\n告警信息: {TRIGGER.NAME}\n告警项目:{TRIGGER.KEY}\n问题详情:{ITEM.NAME}:{ITEM.VALUE}\n当前状态:{TRIGGER.STATUS}:{ITEM.VALUE}\n事件ID:{EVENT.ID}\n\n恢复时\n默认标题：恢复{TRIGGER.STATUS}, 服务器:{HOSTNAME}: {TRIGGER.NAME}已恢复!\n消息内容：\n告警主机:{HOSTNAME}\n告警时间:{EVENT.DATE} {EVENT.TIME}\n告警等级:{TRIGGER.SEVERITY}\n告警信息: {TRIGGER.NAME}\n告警项目:{TRIGGER.KEY}\n问题详情:{ITEM.NAME}:{ITEM.VALUE}\n当前状态:{TRIGGER.STATUS}:{ITEM.VALUE}\n事件ID:{EVENT.ID}\n```\n\n## 模拟告警\n在此之前我们已经总结了主机、监控项、触发器、事件、动作等相关知识点，但是到目前为止，还没有真正的收到过任何一个zabbix中的警告，那么这次，我们就在之前的基础上，刻意的让磁盘根目录使用率这个监控项达到指定的阈值，看看能否正常的收到报警信息。 \n![](/images/pic/zabbix/zabbix-config040.png) \n在模拟前，我们先看看之前磁盘根目录使用率是多少，使用率0.39% 阀值5%。好了，现在我们进入到被监控主机的根分区，在根分区中创建一个大文件，提高磁盘使用率。\n```bash\n[root@k8s nginx]# dd if=/dev/zero of=/testfile count=20 bs=1G\n记录了20+0 的读入\n记录了20+0 的写出\n21474836480字节(21 GB)已复制，44.8811 秒，478 MB/秒\n[root@k8s nginx]# df -h\n文件系统        容量  已用  可用 已用% 挂载点\n/dev/sda5       296G   22G  275G    8% /\ndevtmpfs        3.9G     0  3.9G    0% /dev\ntmpfs           3.9G     0  3.9G    0% /dev/shm\ntmpfs           3.9G   18M  3.9G    1% /run\ntmpfs           3.9G     0  3.9G    0% /sys/fs/cgroup\n/dev/sda2       200G   33M  200G    1% /home\n/dev/sda1       297M  107M  191M   36% /boot\ntmpfs           797M     0  797M    0% /run/user/0\n```\n此时我们的根分区使用率已经达到了8%，超过了触发器设置的阀值5%，我们看看下图，（这里显示的是7.16%和df -h命令8%差一点点是由于linux只显示整数，小数点增1位）\n![](/images/pic/zabbix/zabbix-config041.png) \n我们配置的是1分钟检测一次，因此我们能很快收到`故障邮件通知`报警。如下\n![](/images/pic/zabbix/zabbix-config042.png) \n此时我们删掉`dd命令`生成的testfile文件进行恢复测试。\n```bash\n[root@k8s /]# rm -rf testfile \n[root@k8s /]# df -h\n文件系统        容量  已用  可用 已用% 挂载点\n/dev/sda5       296G  1.2G  295G    1% /\ndevtmpfs        3.9G     0  3.9G    0% /dev\ntmpfs           3.9G     0  3.9G    0% /dev/shm\ntmpfs           3.9G   18M  3.9G    1% /run\ntmpfs           3.9G     0  3.9G    0% /sys/fs/cgroup\n/dev/sda2       200G   33M  200G    1% /home\n/dev/sda1       297M  107M  191M   36% /boot\ntmpfs           797M     0  797M    0% /run/user/0\n```\n那么很快我们将收到监控项`恢复的邮件通知`\n![](/images/pic/zabbix/zabbix-config043.png)\n至此，我们已经完成了初步的zabbix使用了。也可以用户监控环境去监控服务了，当然监控项、触发器等还需要根据实际情况去配置。","slug":"zabbox-alert","published":1,"updated":"2019-05-28T02:02:23.510Z","_id":"cjw6jlez30014p4n7ypdhtw9j","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p><a href=\"https://www.ipyker.com/2018/09/13/zabbix-trigger/\">上一篇</a> 我们已经配置过zabbix的触发器了，也知道当触发器阀值达到时，应该有一个动作，而这个动作可以是执行脚本，也可以是发邮件报警通知用户。那么本篇我们将再进行对zabbix的报警进行配置。</p>\n<h2 id=\"报警媒介类型\"><a href=\"#报警媒介类型\" class=\"headerlink\" title=\"报警媒介类型\"></a>报警媒介类型</h2><p>当zabbix中的某些被监控指标出现异常时，zabbix会通过哪种方式通知运维人员呢？是通过邮件呢，还是通过短信呢，或者是通过其他方式呢？今天我们就来聊聊zabbix的报警方式，无论是通过邮件报警还是通过短信报警，无非都是通过某种”媒介”将报警信息传递给收信人，所以在zabbix中，报警方式被称为”报警媒介”，那么，zabbix都支持哪些报警媒介呢，我们一起来看看。<br>zabbix支持的报警媒介如下：</p>\n<ul>\n<li><code>Email</code>：邮件，这是最常用也是最传统的一种报警媒介，邮件报警，zabbix通过配置好的SMTP邮件服务器向用户发送对应的报警信息。</li>\n<li><code>Script</code>：脚本，当zabbix中的某些监控项出现异常时，也可以调用自定义的脚本进行报警，脚本的使用就比较灵活，具体怎样报警全看你的脚本怎么写。</li>\n<li><code>SMS</code>：短信，如果想要使用短信报警，则需要依赖短信网关（貌似需要北美的运行商）。</li>\n<li><code>Jabber</code>：即时通讯服务。</li>\n<li><code>Ez Texting</code>：商业的，收费的短信服务（北美运营商提供服务）。</li>\n<li><code>第三方的onealert</code></li>\n</ul>\n<h2 id=\"定义报警媒介\"><a href=\"#定义报警媒介\" class=\"headerlink\" title=\"定义报警媒介\"></a>定义报警媒介</h2><blockquote>\n<p><em>下面我们通过配置邮件报警媒介来进行配置说明</em></p>\n</blockquote>\n<p>点击<code>管理-报警媒介类型-创建媒介类型</code>，输入完信息后，点击<code>添加</code><br><img src=\"/images/pic/zabbix/zabbix-config034.png\" alt><br>之后，我们可以在报警媒介类型中看到已经添加的报警类型，点击右边的<code>测试</code>，可以测试当前邮件配置是否正常，如果配置正常你将收到测试的邮件。<br><img src=\"/images/pic/zabbix/zabbix-config035.png\" alt><br>到此处，我们已经成功的定义了一个”报警媒介”，从此，我们可以通过这个媒介，向用户发送报警信息了。</p>\n<h2 id=\"配置用户接受报警通知媒介\"><a href=\"#配置用户接受报警通知媒介\" class=\"headerlink\" title=\"配置用户接受报警通知媒介\"></a>配置用户接受报警通知媒介</h2><p>但是，如果想要某个zabbix用户能够接收到从”email报警媒介”发送过来的报警，还需要进一步配置，比如，当”Admin”用户想要通过”email”报警媒介接收警报时，则必须能够”适配”这种媒介，如果”Admin”用户没有使用”email媒介”的能力，那么”Admin”用户将无法接收到由”email媒介”发出的报警信息。我们应该怎样让用户能够对应的报警媒介呢，配置步骤如下。</p>\n<p>点击<code>管理-用户-Admin-报警媒介</code><br><img src=\"/images/pic/zabbix/zabbix-config036.png\" alt><br>到此处，我们已经成功的定义了一个用户能接受对应”报警媒介”的邮件通知了。</p>\n<h2 id=\"配置告警动作\"><a href=\"#配置告警动作\" class=\"headerlink\" title=\"配置告警动作\"></a>配置告警动作</h2><blockquote>\n<p>在zabbix中创建一个动作，前文中我们已经创建了用于监控磁盘根目录使用率的监控项,以及对应的触发器，现在，我们需要创建一个动作，与监控项和触发器结合起来一起使用。 </p>\n</blockquote>\n<p>打开zabbix控制台，点击<code>配置-动作-事件源-触发器-创建动作</code><br><img src=\"/images/pic/zabbix/zabbix-config037.png\" alt><br>点击<code>操作</code><br><img src=\"/images/pic/zabbix/zabbix-config038.png\" alt><br>点击<code>恢复操作</code><br><img src=\"/images/pic/zabbix/zabbix-config039.png\" alt><br>完成以上配置，点击<code>添加</code>即可添加一个对该触发器的动作。 </p>\n<p><strong>上图报警的宏如下，更多的宏参考<a href=\"https://www.zabbix.com/documentation/4.0/zh/manual/appendix/macros/supported_by_location\" target=\"_blank\" rel=\"noopener\">官方宏使用</a> </strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 故障时</span></span><br><span class=\"line\">默认标题：故障&#123;TRIGGER.STATUS&#125;,服务器:&#123;HOSTNAME&#125;发生: &#123;TRIGGER.NAME&#125;故障!</span><br><span class=\"line\">消息内容：</span><br><span class=\"line\">告警主机:&#123;HOSTNAME&#125;</span><br><span class=\"line\">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class=\"line\">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class=\"line\">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class=\"line\">告警项目:&#123;TRIGGER.KEY&#125;</span><br><span class=\"line\">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class=\"line\">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE&#125;</span><br><span class=\"line\">事件ID:&#123;EVENT.ID&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">恢复时</span><br><span class=\"line\">默认标题：恢复&#123;TRIGGER.STATUS&#125;, 服务器:&#123;HOSTNAME&#125;: &#123;TRIGGER.NAME&#125;已恢复!</span><br><span class=\"line\">消息内容：</span><br><span class=\"line\">告警主机:&#123;HOSTNAME&#125;</span><br><span class=\"line\">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class=\"line\">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class=\"line\">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class=\"line\">告警项目:&#123;TRIGGER.KEY&#125;</span><br><span class=\"line\">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class=\"line\">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE&#125;</span><br><span class=\"line\">事件ID:&#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"模拟告警\"><a href=\"#模拟告警\" class=\"headerlink\" title=\"模拟告警\"></a>模拟告警</h2><p>在此之前我们已经总结了主机、监控项、触发器、事件、动作等相关知识点，但是到目前为止，还没有真正的收到过任何一个zabbix中的警告，那么这次，我们就在之前的基础上，刻意的让磁盘根目录使用率这个监控项达到指定的阈值，看看能否正常的收到报警信息。<br><img src=\"/images/pic/zabbix/zabbix-config040.png\" alt><br>在模拟前，我们先看看之前磁盘根目录使用率是多少，使用率0.39% 阀值5%。好了，现在我们进入到被监控主机的根分区，在根分区中创建一个大文件，提高磁盘使用率。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@k8s nginx]<span class=\"comment\"># dd if=/dev/zero of=/testfile count=20 bs=1G</span></span><br><span class=\"line\">记录了20+0 的读入</span><br><span class=\"line\">记录了20+0 的写出</span><br><span class=\"line\">21474836480字节(21 GB)已复制，44.8811 秒，478 MB/秒</span><br><span class=\"line\">[root@k8s nginx]<span class=\"comment\"># df -h</span></span><br><span class=\"line\">文件系统        容量  已用  可用 已用% 挂载点</span><br><span class=\"line\">/dev/sda5       296G   22G  275G    8% /</span><br><span class=\"line\">devtmpfs        3.9G     0  3.9G    0% /dev</span><br><span class=\"line\">tmpfs           3.9G     0  3.9G    0% /dev/shm</span><br><span class=\"line\">tmpfs           3.9G   18M  3.9G    1% /run</span><br><span class=\"line\">tmpfs           3.9G     0  3.9G    0% /sys/fs/cgroup</span><br><span class=\"line\">/dev/sda2       200G   33M  200G    1% /home</span><br><span class=\"line\">/dev/sda1       297M  107M  191M   36% /boot</span><br><span class=\"line\">tmpfs           797M     0  797M    0% /run/user/0</span><br></pre></td></tr></table></figure></p>\n<p>此时我们的根分区使用率已经达到了8%，超过了触发器设置的阀值5%，我们看看下图，（这里显示的是7.16%和df -h命令8%差一点点是由于linux只显示整数，小数点增1位）<br><img src=\"/images/pic/zabbix/zabbix-config041.png\" alt><br>我们配置的是1分钟检测一次，因此我们能很快收到<code>故障邮件通知</code>报警。如下<br><img src=\"/images/pic/zabbix/zabbix-config042.png\" alt><br>此时我们删掉<code>dd命令</code>生成的testfile文件进行恢复测试。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@k8s /]<span class=\"comment\"># rm -rf testfile </span></span><br><span class=\"line\">[root@k8s /]<span class=\"comment\"># df -h</span></span><br><span class=\"line\">文件系统        容量  已用  可用 已用% 挂载点</span><br><span class=\"line\">/dev/sda5       296G  1.2G  295G    1% /</span><br><span class=\"line\">devtmpfs        3.9G     0  3.9G    0% /dev</span><br><span class=\"line\">tmpfs           3.9G     0  3.9G    0% /dev/shm</span><br><span class=\"line\">tmpfs           3.9G   18M  3.9G    1% /run</span><br><span class=\"line\">tmpfs           3.9G     0  3.9G    0% /sys/fs/cgroup</span><br><span class=\"line\">/dev/sda2       200G   33M  200G    1% /home</span><br><span class=\"line\">/dev/sda1       297M  107M  191M   36% /boot</span><br><span class=\"line\">tmpfs           797M     0  797M    0% /run/user/0</span><br></pre></td></tr></table></figure></p>\n<p>那么很快我们将收到监控项<code>恢复的邮件通知</code><br><img src=\"/images/pic/zabbix/zabbix-config043.png\" alt><br>至此，我们已经完成了初步的zabbix使用了。也可以用户监控环境去监控服务了，当然监控项、触发器等还需要根据实际情况去配置。</p>\n","site":{"data":{}},"length":3375,"excerpt":"","more":"<p><a href=\"https://www.ipyker.com/2018/09/13/zabbix-trigger/\">上一篇</a> 我们已经配置过zabbix的触发器了，也知道当触发器阀值达到时，应该有一个动作，而这个动作可以是执行脚本，也可以是发邮件报警通知用户。那么本篇我们将再进行对zabbix的报警进行配置。</p>\n<h2 id=\"报警媒介类型\"><a href=\"#报警媒介类型\" class=\"headerlink\" title=\"报警媒介类型\"></a>报警媒介类型</h2><p>当zabbix中的某些被监控指标出现异常时，zabbix会通过哪种方式通知运维人员呢？是通过邮件呢，还是通过短信呢，或者是通过其他方式呢？今天我们就来聊聊zabbix的报警方式，无论是通过邮件报警还是通过短信报警，无非都是通过某种”媒介”将报警信息传递给收信人，所以在zabbix中，报警方式被称为”报警媒介”，那么，zabbix都支持哪些报警媒介呢，我们一起来看看。<br>zabbix支持的报警媒介如下：</p>\n<ul>\n<li><code>Email</code>：邮件，这是最常用也是最传统的一种报警媒介，邮件报警，zabbix通过配置好的SMTP邮件服务器向用户发送对应的报警信息。</li>\n<li><code>Script</code>：脚本，当zabbix中的某些监控项出现异常时，也可以调用自定义的脚本进行报警，脚本的使用就比较灵活，具体怎样报警全看你的脚本怎么写。</li>\n<li><code>SMS</code>：短信，如果想要使用短信报警，则需要依赖短信网关（貌似需要北美的运行商）。</li>\n<li><code>Jabber</code>：即时通讯服务。</li>\n<li><code>Ez Texting</code>：商业的，收费的短信服务（北美运营商提供服务）。</li>\n<li><code>第三方的onealert</code></li>\n</ul>\n<h2 id=\"定义报警媒介\"><a href=\"#定义报警媒介\" class=\"headerlink\" title=\"定义报警媒介\"></a>定义报警媒介</h2><blockquote>\n<p><em>下面我们通过配置邮件报警媒介来进行配置说明</em></p>\n</blockquote>\n<p>点击<code>管理-报警媒介类型-创建媒介类型</code>，输入完信息后，点击<code>添加</code><br><img src=\"/images/pic/zabbix/zabbix-config034.png\" alt><br>之后，我们可以在报警媒介类型中看到已经添加的报警类型，点击右边的<code>测试</code>，可以测试当前邮件配置是否正常，如果配置正常你将收到测试的邮件。<br><img src=\"/images/pic/zabbix/zabbix-config035.png\" alt><br>到此处，我们已经成功的定义了一个”报警媒介”，从此，我们可以通过这个媒介，向用户发送报警信息了。</p>\n<h2 id=\"配置用户接受报警通知媒介\"><a href=\"#配置用户接受报警通知媒介\" class=\"headerlink\" title=\"配置用户接受报警通知媒介\"></a>配置用户接受报警通知媒介</h2><p>但是，如果想要某个zabbix用户能够接收到从”email报警媒介”发送过来的报警，还需要进一步配置，比如，当”Admin”用户想要通过”email”报警媒介接收警报时，则必须能够”适配”这种媒介，如果”Admin”用户没有使用”email媒介”的能力，那么”Admin”用户将无法接收到由”email媒介”发出的报警信息。我们应该怎样让用户能够对应的报警媒介呢，配置步骤如下。</p>\n<p>点击<code>管理-用户-Admin-报警媒介</code><br><img src=\"/images/pic/zabbix/zabbix-config036.png\" alt><br>到此处，我们已经成功的定义了一个用户能接受对应”报警媒介”的邮件通知了。</p>\n<h2 id=\"配置告警动作\"><a href=\"#配置告警动作\" class=\"headerlink\" title=\"配置告警动作\"></a>配置告警动作</h2><blockquote>\n<p>在zabbix中创建一个动作，前文中我们已经创建了用于监控磁盘根目录使用率的监控项,以及对应的触发器，现在，我们需要创建一个动作，与监控项和触发器结合起来一起使用。 </p>\n</blockquote>\n<p>打开zabbix控制台，点击<code>配置-动作-事件源-触发器-创建动作</code><br><img src=\"/images/pic/zabbix/zabbix-config037.png\" alt><br>点击<code>操作</code><br><img src=\"/images/pic/zabbix/zabbix-config038.png\" alt><br>点击<code>恢复操作</code><br><img src=\"/images/pic/zabbix/zabbix-config039.png\" alt><br>完成以上配置，点击<code>添加</code>即可添加一个对该触发器的动作。 </p>\n<p><strong>上图报警的宏如下，更多的宏参考<a href=\"https://www.zabbix.com/documentation/4.0/zh/manual/appendix/macros/supported_by_location\" target=\"_blank\" rel=\"noopener\">官方宏使用</a> </strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 故障时</span></span><br><span class=\"line\">默认标题：故障&#123;TRIGGER.STATUS&#125;,服务器:&#123;HOSTNAME&#125;发生: &#123;TRIGGER.NAME&#125;故障!</span><br><span class=\"line\">消息内容：</span><br><span class=\"line\">告警主机:&#123;HOSTNAME&#125;</span><br><span class=\"line\">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class=\"line\">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class=\"line\">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class=\"line\">告警项目:&#123;TRIGGER.KEY&#125;</span><br><span class=\"line\">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class=\"line\">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE&#125;</span><br><span class=\"line\">事件ID:&#123;EVENT.ID&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">恢复时</span><br><span class=\"line\">默认标题：恢复&#123;TRIGGER.STATUS&#125;, 服务器:&#123;HOSTNAME&#125;: &#123;TRIGGER.NAME&#125;已恢复!</span><br><span class=\"line\">消息内容：</span><br><span class=\"line\">告警主机:&#123;HOSTNAME&#125;</span><br><span class=\"line\">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class=\"line\">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class=\"line\">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class=\"line\">告警项目:&#123;TRIGGER.KEY&#125;</span><br><span class=\"line\">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class=\"line\">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE&#125;</span><br><span class=\"line\">事件ID:&#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"模拟告警\"><a href=\"#模拟告警\" class=\"headerlink\" title=\"模拟告警\"></a>模拟告警</h2><p>在此之前我们已经总结了主机、监控项、触发器、事件、动作等相关知识点，但是到目前为止，还没有真正的收到过任何一个zabbix中的警告，那么这次，我们就在之前的基础上，刻意的让磁盘根目录使用率这个监控项达到指定的阈值，看看能否正常的收到报警信息。<br><img src=\"/images/pic/zabbix/zabbix-config040.png\" alt><br>在模拟前，我们先看看之前磁盘根目录使用率是多少，使用率0.39% 阀值5%。好了，现在我们进入到被监控主机的根分区，在根分区中创建一个大文件，提高磁盘使用率。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@k8s nginx]<span class=\"comment\"># dd if=/dev/zero of=/testfile count=20 bs=1G</span></span><br><span class=\"line\">记录了20+0 的读入</span><br><span class=\"line\">记录了20+0 的写出</span><br><span class=\"line\">21474836480字节(21 GB)已复制，44.8811 秒，478 MB/秒</span><br><span class=\"line\">[root@k8s nginx]<span class=\"comment\"># df -h</span></span><br><span class=\"line\">文件系统        容量  已用  可用 已用% 挂载点</span><br><span class=\"line\">/dev/sda5       296G   22G  275G    8% /</span><br><span class=\"line\">devtmpfs        3.9G     0  3.9G    0% /dev</span><br><span class=\"line\">tmpfs           3.9G     0  3.9G    0% /dev/shm</span><br><span class=\"line\">tmpfs           3.9G   18M  3.9G    1% /run</span><br><span class=\"line\">tmpfs           3.9G     0  3.9G    0% /sys/fs/cgroup</span><br><span class=\"line\">/dev/sda2       200G   33M  200G    1% /home</span><br><span class=\"line\">/dev/sda1       297M  107M  191M   36% /boot</span><br><span class=\"line\">tmpfs           797M     0  797M    0% /run/user/0</span><br></pre></td></tr></table></figure></p>\n<p>此时我们的根分区使用率已经达到了8%，超过了触发器设置的阀值5%，我们看看下图，（这里显示的是7.16%和df -h命令8%差一点点是由于linux只显示整数，小数点增1位）<br><img src=\"/images/pic/zabbix/zabbix-config041.png\" alt><br>我们配置的是1分钟检测一次，因此我们能很快收到<code>故障邮件通知</code>报警。如下<br><img src=\"/images/pic/zabbix/zabbix-config042.png\" alt><br>此时我们删掉<code>dd命令</code>生成的testfile文件进行恢复测试。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@k8s /]<span class=\"comment\"># rm -rf testfile </span></span><br><span class=\"line\">[root@k8s /]<span class=\"comment\"># df -h</span></span><br><span class=\"line\">文件系统        容量  已用  可用 已用% 挂载点</span><br><span class=\"line\">/dev/sda5       296G  1.2G  295G    1% /</span><br><span class=\"line\">devtmpfs        3.9G     0  3.9G    0% /dev</span><br><span class=\"line\">tmpfs           3.9G     0  3.9G    0% /dev/shm</span><br><span class=\"line\">tmpfs           3.9G   18M  3.9G    1% /run</span><br><span class=\"line\">tmpfs           3.9G     0  3.9G    0% /sys/fs/cgroup</span><br><span class=\"line\">/dev/sda2       200G   33M  200G    1% /home</span><br><span class=\"line\">/dev/sda1       297M  107M  191M   36% /boot</span><br><span class=\"line\">tmpfs           797M     0  797M    0% /run/user/0</span><br></pre></td></tr></table></figure></p>\n<p>那么很快我们将收到监控项<code>恢复的邮件通知</code><br><img src=\"/images/pic/zabbix/zabbix-config043.png\" alt><br>至此，我们已经完成了初步的zabbix使用了。也可以用户监控环境去监控服务了，当然监控项、触发器等还需要根据实际情况去配置。</p>\n"},{"layout":"post","title":"Ansible 常用模块指令","author":"Pyker","img":"/images/bar/ansible.jpg","top":false,"cover":false,"date":"2018-03-22T06:47:00.000Z","_content":">**本文主要讲解ansible的常用命令和简单安装步骤，具体配置文件详解以及playbook暂未涉及！后续更新。。。。**\n\n### 安装Ansible\n```bash\n$ yum install epel-release ansible -y\n```\n### 配置文件配置\n* 常用ansible.cfg配置文件\n```bash\n$ cat /etc/ansible/ansible.cfg \n  [defaults]\n  inventory      = /etc/ansible/hosts           #主机清单\n  library        = /usr/share/my_modules/       # 使用的模块\n  forks          = 5                            #处理并发的进程数，建议设置控制机的数量\n  sudo_user      = root                         #默认执行远程命令的用户\n  remote_port    = 22                           #SSH连接被控制机的端口\n  gathering = smart                             #'smart'收集facts的信息，如已收集，则采用缓存。可选参数'implicit'、'explicit'，分别表示每次都收集和默认不收集facts信息\n  fact_caching_timeout = 86400                  #'gathering为smart'可用，设置收集超时时间\n  fact_caching = jsonfile                       #'gathering为smart'可用，设置以什么存储facts信息。还可在本地安装redis、memcache来作为facts的存储。\n  fact_caching_connection = /etc/ansible/ansible_facts_cache  #'gathering为smart'可用，设置缓存路径。\n  roles_path    = /etc/ansible/roles            #设置ansible其他roles的路径\n  host_key_checking = false                     #忽略检查主机密钥\n  log_path = /var/log/ansible.log               #ansible日志路径\n  module_name = command                         #ansible默认的模块\n  deprecation_warnings = False                  #禁用ansible“不建议使用”的警告\n\n  [ssh_connection]\n  ssh_args = -C -o ControlMaster=auto -o ControlPersist=1d        #开启ssh长连接，保存时间为1天\n  control_path_dir = /etc/ansible/ssh-socket                      #ssh长连接存放的路径\n  control_path = %(directory)s/%%h-%%p-%%r                        #ssh长连接的格式名称\n  pipelining = True                                               #减少执行远程模块SSH操作次数，开启这个设置,将显著提高性能，但被控制机需要将/etc/sudoers下\"Defaults requiretty\"注释掉\n\n  [accelerate]\n  accelerate_port = 5099                        #使用python程序在被控制机上运行一个守护进程，ansible通过这个守护进程监听的端口进行通信。所有机器都要安装python-keyczar包\n  accelerate_timeout = 30                       #设置用来控制从客户机获取数据的超时时间，如果在这段时间内没有数据传输,套接字连接会被关闭。\n  accelerate_connect_timeout = 5.0              #设置空着套接字调用的超时时间.这个应该设置相对比较短.这个和`accelerate_port`连接在回滚到ssh或者paramiko连接方式之前会尝试三次开始远程加速daemon守护进程.默认设置为1.0秒:\n```\n* hosts 文件\n （机器清单，进行分组管理）\n ```bash\n  [tomcat]\n  192.168.16.192\n  192.168.16.193\n  [nginx]\n  app1 ansible_ssh_host=192.168.16.190 ansible_ssh_pass=\"2039\"\n  app2 ansible_ssh_host=192.168.16.191 sudo_user=”ald” ansible_ssh_pass=\"2039\"\n```\n>*sudo_user和ansible_ssh_pass为帐号密码方式验证，建议用密钥。*\n### Ansible指令参数\n* __ansible 常用命令参数__\n-m指定模块\n-a 指定模块的命令。默认是command模块，可以省略\n-B 指定ansible后台运行超时时间\n-C 测试运行效果，而不是正在运行\n-f 指定使用的并行进程的数量\n-i 指定inventory/hosts文件，默认/etc/ansiable/hosts文件\n--limit=xxx.xxx.xxx.xxx 限制对某个ip或者网段或者组执行\n--list-hosts 显示将要执行命令的主机\n\n* __ansible-doc 常用命令参数__\n-M --module-path=/xxx/xxx  查询模块 默认是/usr/share/ansible/\n-l  --list          显示已存在的所有模块\n-s  command     显示playbook制定模块的用法，类似 man 命令\n\n* __ansible-galaxy__ \n>下载第三方模块指令，类似yum、pip、easy_install这样的命令\n\n   ansible-galaxy install <module_name>\n   \n* __ansible-playbook__ 常用命令参数\n--syntax-check  [yaml文件]         语法检测\n-t TAGS    只允许指定的tags标签任务，多个以 , 分开\n--skip-tags=SKIP_TAGS   跳过指定的标签\n--start-at-task=START_AT   从哪个任务后执行\n\n### 常用指令模块\n1、 copy——拷贝模块   (用于将本地或远程机器上的文件拷贝到远程主机上)\n```bash\n$ ansible all –m copy -a “src=/xxx/xxx dest=/yyy/yyy owner=root group=root mode=644 force=yes/no backup=yes/no”\n解释：将src 文件/目录复制到远程dest上，所有者/组为root 权限为644，force为是否强制替换，backup为替换前是否需要备份远程远文件\n```\n\n2、 raw——命令模块 （和command、shell类似）\n```bash\n$ ansible all –m raw -a \"ifconfig\"\n解释：在所有主机上执行ifocnfig命令。\n```\n\n3、 yum——安装模块 （安装程序）\n```bash\n$ ansible all –m yum –a “name=httpd state=present”\n解释：安装httpd程序，state可以是present、latest、installed表示安装程序，absent、removed表示卸载程序\n```\n\n4、 file——文件模块 （文件属性修改）\n```bash\n$ ansible all –m file –a “src=/xxx/xxx/1 dest=/yyy/1 state=link owner=alad group=alad mode=777”\n$ ansible develop -m file -a \"path=/xxx/dir recurse=yes owner=root group=alad mode=644\"\n解释：1、将src的文件软连接到dest目录下，并修改所有者/组和权限\n      2、将path路径的目录递归形式设置所有者和权限\n*、state还可以是directory：如果目录不存在，创建目录\n    file：即使文件不存在，也不会被创建\n\thard：创建硬链接\n    touch：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间\n    absent：删除目录、文件或者取消链接文件\n```\n\n5、 cron——计划任务模块 （计划任务crontab）\n```bash\n$ ansible develop -m cron -a \"name='show time' minute=*/1 hour=* day=* month=* weekday=* job='/bin/date'\"\n$ ansible develop -m cron -a \"name='show time' state=absent\"\n解释：1、创建一个每分钟显示时间的计划任务\n      2、删除名为show time这个计划任务\n```\n\n6、 group——组模块（用户组）\n```bash\n$ ansible all-m group -a \"name=develop\"\n解释：在所有主机上创建一个develop的组 ，state=absent表示删除该组\n```\n\n7、 user——用户模块（用户）\n```bash\n$ ansible develop -m user -a \"name=harlan groups=root password=-1vFO89dP6qyK\"\n$ ansible develop -m user -a \"name=harlan state=absent remove=yes\"\n解释：1、在所有主机上创建harlan用户，并将其添加到root组，密码是经过hash加密后的，明文密码会被哈希，所以先填入hash后的密码即可\n可用此命令hash密码  openssl passwd -salt -1 \"123456\"\n      2、删除harlan用户。Remove表示是否删除用户的同时删除家目录\n```\n\n8、 service——服务模块（服务状态）\n```bash\n$ ansible develop -m service -a \"name=nginx state=running\"\n$ ansible develop -m service -a \"name=nginx state=restarted enabled=yes\"\n解释：1、无论服务处在什么状态，最后都是将服务状态设置为启动，当服务正在运行的时候，显示为changed为false，state显示为状态，表示为正在运行；当服务停止的时候，显示为changed为true，表示这个时候将服务进行了启动，状态为启动\n      2、表示重启nginx并且将nginx设置为开机自启动，state还有staeted、reloaded、stoped值\n```\n\n9、 script——脚本模块（运行脚本）\n```bash\n$ ansible develop -m script -a \"/root/a.sh\"\n解释：在develop主机上运行当前服务器上的a.sh脚本\n```\n\n10、get_url——下载url上指定文件（类似wget）\n```bash\n$ ansible develop -m get_url -a \"url=http://file.alavening.com/alading_file/head_img/1526900421976.jpg dest=/home/ owner=alad group=alad mode=644\"\n解释：将url上的图片下载到dest目的目录上,并且设置相应的所有者/组和权限。\n```\n \n11、synchronize——同步目录（默认推送，mode=pull为拉取）\n```bash\n$ ansible develop -m synchronize -a \"src=/home/test/ dest=/home/test compress=yes delete=yes\"\n$ ansible develop -m synchronize -a \"src=/home/test/ dest=/home/test compress=yes mode=pull\"\n解释：1、将src下的文件同步到dest上，delete=yes表示以src 目录为准镜像同步。\n      2、拉取远程src上的目录文件到本地dest上\n```\n \n12、template——文档内变量的替换的模块\n```bash\n$ ansible develop –m template –a ‘src=/mytemplates/foo.j2 dest=/etc/file.conf mode=\"u=rw,g=r,o=r\"’\n解释：将src上foo.j2的变量模版复制到dest上。Template适合用playbook编写 ，通过变量然后拷贝到远程主机。\n```\n>可以参考：<https://www.cnblogs.com/jsonhc/p/7895399.html>\n\n13、fetch——从远程主机下载文件（不能拉取目录）\n```bash\n$ ansible develop -m fetch -a \"src=/home/test/xxx dest=/home/ flat=yes\"\n解释：将远程xxx文件拉取到本地home目录下，目录结构会是dest路径+远程主机名+src，假如远程主机名为develop，拉取的xxx文件在本地的/home/develop/home/test目录。如果需要指定拉取到某目录下 加个flat=yes的参数即可。\n```\n \n14、unarchive——解压文件\n```bash\n$ ansible develop -m unarchive -a \"src=/root/apache-tomcat-7.0.85.tar.gz dest=/home/test owner=alad group=alad mode=755\"\n$ ansible develop -m unarchive -a \"src=/home/alad/ansible/elk/logstash-6.2.4.tar.gz dest=/home/test remote_src=yes\"\n$ ansible develop -m unarchive -a \"src=http://mirrors.linuxeye.com/oneinstack-full.tar.gz dest=/home/test remote_src=yes\"\n解释：将本地的tomcat压缩包解压到远程主机dest目录下，并修改其权限和所有者/组，remote_src=yes 表示解压远程主机已有的压缩包，src为url表示下载此包到远程主机dest目录进行解压缩后，并删除压缩包源文件\n```\n \n15、command和shell——linux命令模块\n```\nshell和command的区别：shell模块可以特殊字符，而command是不支持\n简单说：command运行的命令中无法使用变量，管道。如果需要使用管道、变量，请使用raw模块,或者shell模块。\n```\n \n16、setup——获取主机信息\n```bash\n$ ansible develop -m setup\n$ ansible develop -m setup -a 'filter=ansible_*_mb'\n解释：1、显示系统所有信息\n      2、通常配合filter进行过滤来获取主机信息，（例子是显示内存信息）\n```\n\n17、assemble——配置文件组装发送到远程主机\n```bash\n$ ansible test -m assemble -a \"src=/root/test dest=/root/ansible/fileone mode=777 remote_src=False delimiter='========'\"\n解释：将src test目录下所有文件（不含test子目录内容）的内容发送到dest fileone文件中，remote_src默认为Ture表示src为远程主机上的路径，False为ansible控制端的路径，delimiter为文件之间内容分隔符。\n```\n\n### Playbook语法和结构\nPlaybook需要7个文件夹，如ansible安装nginx，则需要在/etc/ansible/roles目录下建立以下文件夹。\nmkdir -pv nginx/{default,tasks,vars,meta,handlers,templates,files}\n对于Ansible，几乎每个YAML文件都以一个列表开始。列表中的每个项目都是键/值对列表，通常称为“散列”或“字典”。所以，我们需要知道如何在YAML中编写列表和字典。\nYAML还有一个小小的怪癖。所有YAML文件（无论它们是否与Ansible相关联）都可以选择开始---和结束---.。这是YAML格式的一部分，并指示文档的开始和结束。\n列表中的所有成员都是以相同的缩进级别开头的行（短划线和空格）：\"- \"\n\n例如：\n```yaml\n\t---\n\t- hosts: test\n\t  remote_user: root\n\t  vars:\n\t    - bsh: b.sh\n\t\t- httprpm: httpd\n\t  task:\n\t    - name: install httpd\n\t\t  yum: name={{ httprpm }} state=present”\n\t\t  tags: install_httpd\n\t\t- name: copy b.sh\n\t\t  copy: src=/root/{{ bsh }} dest=/root/ owner=ala group=ala mode=0644\n\t\t  notify:\n\t\t    - reload httpd\n\t\t- name: start httpd\n\t\t  service: name=httpd state=started enabled=yes\n\t  handlers:\n\t    - name: reload httpd\n\t\t  service: name=httpd state=reloaded\n```\n第一次的话都会运行，后边如果copy的文件内容发生改变就会触发 notify ，然后会直接执行 handlers 的内容（ 这里notify后边的事件就都不会执行了 ）。\n\n### template模块jinja2语法\n\n* __template:使用了Jinjia2格式作为文件模版，进行文档内变量的替换的模块。相当于copy，将jinja2的文件模板理解并执行，转化为各个主机间的对应值。__\n如：template: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf\n\n>http.conf.j2必须是完整的文件内容，因为这是覆盖操作，而非只选择性远程主机替换变量，dest要指定文件名，如果是目录就相当于copy了http.conf.j2到远程目录下，不是我们要的结果。\n\n* __when语句：在tasks中使用，Jinja2的语法格式__\n\n```yaml\n- name: start nginx service\n shell: systemctl start nginx.service\n when: ansible_distribution == \"CentOS\" and ansible_distribution_major_version == \"7\"\n```\n当系统为 centos 7的时候执行sysctemctl命令，否则不执行\n\n* __循环：迭代，需要重复执行的任务__\n\n>变量名为item，而with_item为要迭代的元素。如果某个任务出错，后面不执行\n \n```yaml\n- name: install packages\n yum: name={{ item }} state=latest\n with_items:\n    - httpd\n    - php\n```\n\n  >这是基于字符串列表给出元素示例 \n  \n```yaml\n- name: create users\n    user: name={{ item.name }} group={{ item.group }} state=present\n    with_items:\n    - {name: 'userx1', group: 'groupx1'}\n    - {name: 'userx2', group: 'groupx2'}\n```\n这是基于字典列表给元素示例：item.name  . 后边的表示键。","source":"_posts/ansible-module.md","raw":"layout: post\ntitle: Ansible 常用模块指令\nauthor: Pyker\ncategories: CI/CD\nimg: /images/bar/ansible.jpg\ntags:\n  - ansible\ntop: false\ncover: false\ndate: 2018-03-22 14:47:00\n---\n>**本文主要讲解ansible的常用命令和简单安装步骤，具体配置文件详解以及playbook暂未涉及！后续更新。。。。**\n\n### 安装Ansible\n```bash\n$ yum install epel-release ansible -y\n```\n### 配置文件配置\n* 常用ansible.cfg配置文件\n```bash\n$ cat /etc/ansible/ansible.cfg \n  [defaults]\n  inventory      = /etc/ansible/hosts           #主机清单\n  library        = /usr/share/my_modules/       # 使用的模块\n  forks          = 5                            #处理并发的进程数，建议设置控制机的数量\n  sudo_user      = root                         #默认执行远程命令的用户\n  remote_port    = 22                           #SSH连接被控制机的端口\n  gathering = smart                             #'smart'收集facts的信息，如已收集，则采用缓存。可选参数'implicit'、'explicit'，分别表示每次都收集和默认不收集facts信息\n  fact_caching_timeout = 86400                  #'gathering为smart'可用，设置收集超时时间\n  fact_caching = jsonfile                       #'gathering为smart'可用，设置以什么存储facts信息。还可在本地安装redis、memcache来作为facts的存储。\n  fact_caching_connection = /etc/ansible/ansible_facts_cache  #'gathering为smart'可用，设置缓存路径。\n  roles_path    = /etc/ansible/roles            #设置ansible其他roles的路径\n  host_key_checking = false                     #忽略检查主机密钥\n  log_path = /var/log/ansible.log               #ansible日志路径\n  module_name = command                         #ansible默认的模块\n  deprecation_warnings = False                  #禁用ansible“不建议使用”的警告\n\n  [ssh_connection]\n  ssh_args = -C -o ControlMaster=auto -o ControlPersist=1d        #开启ssh长连接，保存时间为1天\n  control_path_dir = /etc/ansible/ssh-socket                      #ssh长连接存放的路径\n  control_path = %(directory)s/%%h-%%p-%%r                        #ssh长连接的格式名称\n  pipelining = True                                               #减少执行远程模块SSH操作次数，开启这个设置,将显著提高性能，但被控制机需要将/etc/sudoers下\"Defaults requiretty\"注释掉\n\n  [accelerate]\n  accelerate_port = 5099                        #使用python程序在被控制机上运行一个守护进程，ansible通过这个守护进程监听的端口进行通信。所有机器都要安装python-keyczar包\n  accelerate_timeout = 30                       #设置用来控制从客户机获取数据的超时时间，如果在这段时间内没有数据传输,套接字连接会被关闭。\n  accelerate_connect_timeout = 5.0              #设置空着套接字调用的超时时间.这个应该设置相对比较短.这个和`accelerate_port`连接在回滚到ssh或者paramiko连接方式之前会尝试三次开始远程加速daemon守护进程.默认设置为1.0秒:\n```\n* hosts 文件\n （机器清单，进行分组管理）\n ```bash\n  [tomcat]\n  192.168.16.192\n  192.168.16.193\n  [nginx]\n  app1 ansible_ssh_host=192.168.16.190 ansible_ssh_pass=\"2039\"\n  app2 ansible_ssh_host=192.168.16.191 sudo_user=”ald” ansible_ssh_pass=\"2039\"\n```\n>*sudo_user和ansible_ssh_pass为帐号密码方式验证，建议用密钥。*\n### Ansible指令参数\n* __ansible 常用命令参数__\n-m指定模块\n-a 指定模块的命令。默认是command模块，可以省略\n-B 指定ansible后台运行超时时间\n-C 测试运行效果，而不是正在运行\n-f 指定使用的并行进程的数量\n-i 指定inventory/hosts文件，默认/etc/ansiable/hosts文件\n--limit=xxx.xxx.xxx.xxx 限制对某个ip或者网段或者组执行\n--list-hosts 显示将要执行命令的主机\n\n* __ansible-doc 常用命令参数__\n-M --module-path=/xxx/xxx  查询模块 默认是/usr/share/ansible/\n-l  --list          显示已存在的所有模块\n-s  command     显示playbook制定模块的用法，类似 man 命令\n\n* __ansible-galaxy__ \n>下载第三方模块指令，类似yum、pip、easy_install这样的命令\n\n   ansible-galaxy install <module_name>\n   \n* __ansible-playbook__ 常用命令参数\n--syntax-check  [yaml文件]         语法检测\n-t TAGS    只允许指定的tags标签任务，多个以 , 分开\n--skip-tags=SKIP_TAGS   跳过指定的标签\n--start-at-task=START_AT   从哪个任务后执行\n\n### 常用指令模块\n1、 copy——拷贝模块   (用于将本地或远程机器上的文件拷贝到远程主机上)\n```bash\n$ ansible all –m copy -a “src=/xxx/xxx dest=/yyy/yyy owner=root group=root mode=644 force=yes/no backup=yes/no”\n解释：将src 文件/目录复制到远程dest上，所有者/组为root 权限为644，force为是否强制替换，backup为替换前是否需要备份远程远文件\n```\n\n2、 raw——命令模块 （和command、shell类似）\n```bash\n$ ansible all –m raw -a \"ifconfig\"\n解释：在所有主机上执行ifocnfig命令。\n```\n\n3、 yum——安装模块 （安装程序）\n```bash\n$ ansible all –m yum –a “name=httpd state=present”\n解释：安装httpd程序，state可以是present、latest、installed表示安装程序，absent、removed表示卸载程序\n```\n\n4、 file——文件模块 （文件属性修改）\n```bash\n$ ansible all –m file –a “src=/xxx/xxx/1 dest=/yyy/1 state=link owner=alad group=alad mode=777”\n$ ansible develop -m file -a \"path=/xxx/dir recurse=yes owner=root group=alad mode=644\"\n解释：1、将src的文件软连接到dest目录下，并修改所有者/组和权限\n      2、将path路径的目录递归形式设置所有者和权限\n*、state还可以是directory：如果目录不存在，创建目录\n    file：即使文件不存在，也不会被创建\n\thard：创建硬链接\n    touch：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间\n    absent：删除目录、文件或者取消链接文件\n```\n\n5、 cron——计划任务模块 （计划任务crontab）\n```bash\n$ ansible develop -m cron -a \"name='show time' minute=*/1 hour=* day=* month=* weekday=* job='/bin/date'\"\n$ ansible develop -m cron -a \"name='show time' state=absent\"\n解释：1、创建一个每分钟显示时间的计划任务\n      2、删除名为show time这个计划任务\n```\n\n6、 group——组模块（用户组）\n```bash\n$ ansible all-m group -a \"name=develop\"\n解释：在所有主机上创建一个develop的组 ，state=absent表示删除该组\n```\n\n7、 user——用户模块（用户）\n```bash\n$ ansible develop -m user -a \"name=harlan groups=root password=-1vFO89dP6qyK\"\n$ ansible develop -m user -a \"name=harlan state=absent remove=yes\"\n解释：1、在所有主机上创建harlan用户，并将其添加到root组，密码是经过hash加密后的，明文密码会被哈希，所以先填入hash后的密码即可\n可用此命令hash密码  openssl passwd -salt -1 \"123456\"\n      2、删除harlan用户。Remove表示是否删除用户的同时删除家目录\n```\n\n8、 service——服务模块（服务状态）\n```bash\n$ ansible develop -m service -a \"name=nginx state=running\"\n$ ansible develop -m service -a \"name=nginx state=restarted enabled=yes\"\n解释：1、无论服务处在什么状态，最后都是将服务状态设置为启动，当服务正在运行的时候，显示为changed为false，state显示为状态，表示为正在运行；当服务停止的时候，显示为changed为true，表示这个时候将服务进行了启动，状态为启动\n      2、表示重启nginx并且将nginx设置为开机自启动，state还有staeted、reloaded、stoped值\n```\n\n9、 script——脚本模块（运行脚本）\n```bash\n$ ansible develop -m script -a \"/root/a.sh\"\n解释：在develop主机上运行当前服务器上的a.sh脚本\n```\n\n10、get_url——下载url上指定文件（类似wget）\n```bash\n$ ansible develop -m get_url -a \"url=http://file.alavening.com/alading_file/head_img/1526900421976.jpg dest=/home/ owner=alad group=alad mode=644\"\n解释：将url上的图片下载到dest目的目录上,并且设置相应的所有者/组和权限。\n```\n \n11、synchronize——同步目录（默认推送，mode=pull为拉取）\n```bash\n$ ansible develop -m synchronize -a \"src=/home/test/ dest=/home/test compress=yes delete=yes\"\n$ ansible develop -m synchronize -a \"src=/home/test/ dest=/home/test compress=yes mode=pull\"\n解释：1、将src下的文件同步到dest上，delete=yes表示以src 目录为准镜像同步。\n      2、拉取远程src上的目录文件到本地dest上\n```\n \n12、template——文档内变量的替换的模块\n```bash\n$ ansible develop –m template –a ‘src=/mytemplates/foo.j2 dest=/etc/file.conf mode=\"u=rw,g=r,o=r\"’\n解释：将src上foo.j2的变量模版复制到dest上。Template适合用playbook编写 ，通过变量然后拷贝到远程主机。\n```\n>可以参考：<https://www.cnblogs.com/jsonhc/p/7895399.html>\n\n13、fetch——从远程主机下载文件（不能拉取目录）\n```bash\n$ ansible develop -m fetch -a \"src=/home/test/xxx dest=/home/ flat=yes\"\n解释：将远程xxx文件拉取到本地home目录下，目录结构会是dest路径+远程主机名+src，假如远程主机名为develop，拉取的xxx文件在本地的/home/develop/home/test目录。如果需要指定拉取到某目录下 加个flat=yes的参数即可。\n```\n \n14、unarchive——解压文件\n```bash\n$ ansible develop -m unarchive -a \"src=/root/apache-tomcat-7.0.85.tar.gz dest=/home/test owner=alad group=alad mode=755\"\n$ ansible develop -m unarchive -a \"src=/home/alad/ansible/elk/logstash-6.2.4.tar.gz dest=/home/test remote_src=yes\"\n$ ansible develop -m unarchive -a \"src=http://mirrors.linuxeye.com/oneinstack-full.tar.gz dest=/home/test remote_src=yes\"\n解释：将本地的tomcat压缩包解压到远程主机dest目录下，并修改其权限和所有者/组，remote_src=yes 表示解压远程主机已有的压缩包，src为url表示下载此包到远程主机dest目录进行解压缩后，并删除压缩包源文件\n```\n \n15、command和shell——linux命令模块\n```\nshell和command的区别：shell模块可以特殊字符，而command是不支持\n简单说：command运行的命令中无法使用变量，管道。如果需要使用管道、变量，请使用raw模块,或者shell模块。\n```\n \n16、setup——获取主机信息\n```bash\n$ ansible develop -m setup\n$ ansible develop -m setup -a 'filter=ansible_*_mb'\n解释：1、显示系统所有信息\n      2、通常配合filter进行过滤来获取主机信息，（例子是显示内存信息）\n```\n\n17、assemble——配置文件组装发送到远程主机\n```bash\n$ ansible test -m assemble -a \"src=/root/test dest=/root/ansible/fileone mode=777 remote_src=False delimiter='========'\"\n解释：将src test目录下所有文件（不含test子目录内容）的内容发送到dest fileone文件中，remote_src默认为Ture表示src为远程主机上的路径，False为ansible控制端的路径，delimiter为文件之间内容分隔符。\n```\n\n### Playbook语法和结构\nPlaybook需要7个文件夹，如ansible安装nginx，则需要在/etc/ansible/roles目录下建立以下文件夹。\nmkdir -pv nginx/{default,tasks,vars,meta,handlers,templates,files}\n对于Ansible，几乎每个YAML文件都以一个列表开始。列表中的每个项目都是键/值对列表，通常称为“散列”或“字典”。所以，我们需要知道如何在YAML中编写列表和字典。\nYAML还有一个小小的怪癖。所有YAML文件（无论它们是否与Ansible相关联）都可以选择开始---和结束---.。这是YAML格式的一部分，并指示文档的开始和结束。\n列表中的所有成员都是以相同的缩进级别开头的行（短划线和空格）：\"- \"\n\n例如：\n```yaml\n\t---\n\t- hosts: test\n\t  remote_user: root\n\t  vars:\n\t    - bsh: b.sh\n\t\t- httprpm: httpd\n\t  task:\n\t    - name: install httpd\n\t\t  yum: name={{ httprpm }} state=present”\n\t\t  tags: install_httpd\n\t\t- name: copy b.sh\n\t\t  copy: src=/root/{{ bsh }} dest=/root/ owner=ala group=ala mode=0644\n\t\t  notify:\n\t\t    - reload httpd\n\t\t- name: start httpd\n\t\t  service: name=httpd state=started enabled=yes\n\t  handlers:\n\t    - name: reload httpd\n\t\t  service: name=httpd state=reloaded\n```\n第一次的话都会运行，后边如果copy的文件内容发生改变就会触发 notify ，然后会直接执行 handlers 的内容（ 这里notify后边的事件就都不会执行了 ）。\n\n### template模块jinja2语法\n\n* __template:使用了Jinjia2格式作为文件模版，进行文档内变量的替换的模块。相当于copy，将jinja2的文件模板理解并执行，转化为各个主机间的对应值。__\n如：template: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf\n\n>http.conf.j2必须是完整的文件内容，因为这是覆盖操作，而非只选择性远程主机替换变量，dest要指定文件名，如果是目录就相当于copy了http.conf.j2到远程目录下，不是我们要的结果。\n\n* __when语句：在tasks中使用，Jinja2的语法格式__\n\n```yaml\n- name: start nginx service\n shell: systemctl start nginx.service\n when: ansible_distribution == \"CentOS\" and ansible_distribution_major_version == \"7\"\n```\n当系统为 centos 7的时候执行sysctemctl命令，否则不执行\n\n* __循环：迭代，需要重复执行的任务__\n\n>变量名为item，而with_item为要迭代的元素。如果某个任务出错，后面不执行\n \n```yaml\n- name: install packages\n yum: name={{ item }} state=latest\n with_items:\n    - httpd\n    - php\n```\n\n  >这是基于字符串列表给出元素示例 \n  \n```yaml\n- name: create users\n    user: name={{ item.name }} group={{ item.group }} state=present\n    with_items:\n    - {name: 'userx1', group: 'groupx1'}\n    - {name: 'userx2', group: 'groupx2'}\n```\n这是基于字典列表给元素示例：item.name  . 后边的表示键。","slug":"ansible-module","published":1,"updated":"2019-05-28T02:02:23.501Z","_id":"cjw6jlf0j0027p4n77u7evesf","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><blockquote>\n<p><strong>本文主要讲解ansible的常用命令和简单安装步骤，具体配置文件详解以及playbook暂未涉及！后续更新。。。。</strong></p>\n</blockquote>\n<h3 id=\"安装Ansible\"><a href=\"#安装Ansible\" class=\"headerlink\" title=\"安装Ansible\"></a>安装Ansible</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum install epel-release ansible -y</span><br></pre></td></tr></table></figure>\n<h3 id=\"配置文件配置\"><a href=\"#配置文件配置\" class=\"headerlink\" title=\"配置文件配置\"></a>配置文件配置</h3><ul>\n<li><p>常用ansible.cfg配置文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/ansible.cfg </span><br><span class=\"line\">  [defaults]</span><br><span class=\"line\">  inventory      = /etc/ansible/hosts           <span class=\"comment\">#主机清单</span></span><br><span class=\"line\">  library        = /usr/share/my_modules/       <span class=\"comment\"># 使用的模块</span></span><br><span class=\"line\">  forks          = 5                            <span class=\"comment\">#处理并发的进程数，建议设置控制机的数量</span></span><br><span class=\"line\">  sudo_user      = root                         <span class=\"comment\">#默认执行远程命令的用户</span></span><br><span class=\"line\">  remote_port    = 22                           <span class=\"comment\">#SSH连接被控制机的端口</span></span><br><span class=\"line\">  gathering = smart                             <span class=\"comment\">#'smart'收集facts的信息，如已收集，则采用缓存。可选参数'implicit'、'explicit'，分别表示每次都收集和默认不收集facts信息</span></span><br><span class=\"line\">  fact_caching_timeout = 86400                  <span class=\"comment\">#'gathering为smart'可用，设置收集超时时间</span></span><br><span class=\"line\">  fact_caching = jsonfile                       <span class=\"comment\">#'gathering为smart'可用，设置以什么存储facts信息。还可在本地安装redis、memcache来作为facts的存储。</span></span><br><span class=\"line\">  fact_caching_connection = /etc/ansible/ansible_facts_cache  <span class=\"comment\">#'gathering为smart'可用，设置缓存路径。</span></span><br><span class=\"line\">  roles_path    = /etc/ansible/roles            <span class=\"comment\">#设置ansible其他roles的路径</span></span><br><span class=\"line\">  host_key_checking = <span class=\"literal\">false</span>                     <span class=\"comment\">#忽略检查主机密钥</span></span><br><span class=\"line\">  log_path = /var/<span class=\"built_in\">log</span>/ansible.log               <span class=\"comment\">#ansible日志路径</span></span><br><span class=\"line\">  module_name = <span class=\"built_in\">command</span>                         <span class=\"comment\">#ansible默认的模块</span></span><br><span class=\"line\">  deprecation_warnings = False                  <span class=\"comment\">#禁用ansible“不建议使用”的警告</span></span><br><span class=\"line\"></span><br><span class=\"line\">  [ssh_connection]</span><br><span class=\"line\">  ssh_args = -C -o ControlMaster=auto -o ControlPersist=1d        <span class=\"comment\">#开启ssh长连接，保存时间为1天</span></span><br><span class=\"line\">  control_path_dir = /etc/ansible/ssh-socket                      <span class=\"comment\">#ssh长连接存放的路径</span></span><br><span class=\"line\">  control_path = %(directory)s/%%h-%%p-%%r                        <span class=\"comment\">#ssh长连接的格式名称</span></span><br><span class=\"line\">  pipelining = True                                               <span class=\"comment\">#减少执行远程模块SSH操作次数，开启这个设置,将显著提高性能，但被控制机需要将/etc/sudoers下\"Defaults requiretty\"注释掉</span></span><br><span class=\"line\"></span><br><span class=\"line\">  [accelerate]</span><br><span class=\"line\">  accelerate_port = 5099                        <span class=\"comment\">#使用python程序在被控制机上运行一个守护进程，ansible通过这个守护进程监听的端口进行通信。所有机器都要安装python-keyczar包</span></span><br><span class=\"line\">  accelerate_timeout = 30                       <span class=\"comment\">#设置用来控制从客户机获取数据的超时时间，如果在这段时间内没有数据传输,套接字连接会被关闭。</span></span><br><span class=\"line\">  accelerate_connect_timeout = 5.0              <span class=\"comment\">#设置空着套接字调用的超时时间.这个应该设置相对比较短.这个和`accelerate_port`连接在回滚到ssh或者paramiko连接方式之前会尝试三次开始远程加速daemon守护进程.默认设置为1.0秒:</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>hosts 文件<br>（机器清单，进行分组管理）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[tomcat]</span><br><span class=\"line\">192.168.16.192</span><br><span class=\"line\">192.168.16.193</span><br><span class=\"line\">[nginx]</span><br><span class=\"line\">app1 ansible_ssh_host=192.168.16.190 ansible_ssh_pass=<span class=\"string\">\"2039\"</span></span><br><span class=\"line\">app2 ansible_ssh_host=192.168.16.191 sudo_user=”ald” ansible_ssh_pass=<span class=\"string\">\"2039\"</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p><em>sudo_user和ansible_ssh_pass为帐号密码方式验证，建议用密钥。</em></p>\n</blockquote>\n<h3 id=\"Ansible指令参数\"><a href=\"#Ansible指令参数\" class=\"headerlink\" title=\"Ansible指令参数\"></a>Ansible指令参数</h3><ul>\n<li><p><strong>ansible 常用命令参数</strong><br>-m指定模块<br>-a 指定模块的命令。默认是command模块，可以省略<br>-B 指定ansible后台运行超时时间<br>-C 测试运行效果，而不是正在运行<br>-f 指定使用的并行进程的数量<br>-i 指定inventory/hosts文件，默认/etc/ansiable/hosts文件<br>–limit=xxx.xxx.xxx.xxx 限制对某个ip或者网段或者组执行<br>–list-hosts 显示将要执行命令的主机</p>\n</li>\n<li><p><strong>ansible-doc 常用命令参数</strong><br>-M –module-path=/xxx/xxx  查询模块 默认是/usr/share/ansible/<br>-l  –list          显示已存在的所有模块<br>-s  command     显示playbook制定模块的用法，类似 man 命令</p>\n</li>\n<li><p><strong>ansible-galaxy</strong> </p>\n<blockquote>\n<p>下载第三方模块指令，类似yum、pip、easy_install这样的命令</p>\n</blockquote>\n<p> ansible-galaxy install &lt;module_name&gt;</p>\n</li>\n<li><p><strong>ansible-playbook</strong> 常用命令参数<br>–syntax-check  [yaml文件]         语法检测<br>-t TAGS    只允许指定的tags标签任务，多个以 , 分开<br>–skip-tags=SKIP_TAGS   跳过指定的标签<br>–start-at-task=START_AT   从哪个任务后执行</p>\n</li>\n</ul>\n<h3 id=\"常用指令模块\"><a href=\"#常用指令模块\" class=\"headerlink\" title=\"常用指令模块\"></a>常用指令模块</h3><p>1、 copy——拷贝模块   (用于将本地或远程机器上的文件拷贝到远程主机上)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible all –m copy -a “src=/xxx/xxx dest=/yyy/yyy owner=root group=root mode=644 force=yes/no backup=yes/no”</span><br><span class=\"line\">解释：将src 文件/目录复制到远程dest上，所有者/组为root 权限为644，force为是否强制替换，backup为替换前是否需要备份远程远文件</span><br></pre></td></tr></table></figure></p>\n<p>2、 raw——命令模块 （和command、shell类似）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible all –m raw -a <span class=\"string\">\"ifconfig\"</span></span><br><span class=\"line\">解释：在所有主机上执行ifocnfig命令。</span><br></pre></td></tr></table></figure></p>\n<p>3、 yum——安装模块 （安装程序）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible all –m yum –a “name=httpd state=present”</span><br><span class=\"line\">解释：安装httpd程序，state可以是present、latest、installed表示安装程序，absent、removed表示卸载程序</span><br></pre></td></tr></table></figure></p>\n<p>4、 file——文件模块 （文件属性修改）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible all –m file –a “src=/xxx/xxx/1 dest=/yyy/1 state=link owner=alad group=alad mode=777”</span><br><span class=\"line\">$ ansible develop -m file -a <span class=\"string\">\"path=/xxx/dir recurse=yes owner=root group=alad mode=644\"</span></span><br><span class=\"line\">解释：1、将src的文件软连接到dest目录下，并修改所有者/组和权限</span><br><span class=\"line\">      2、将path路径的目录递归形式设置所有者和权限</span><br><span class=\"line\">*、state还可以是directory：如果目录不存在，创建目录</span><br><span class=\"line\">    file：即使文件不存在，也不会被创建</span><br><span class=\"line\">\thard：创建硬链接</span><br><span class=\"line\">    touch：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间</span><br><span class=\"line\">    absent：删除目录、文件或者取消链接文件</span><br></pre></td></tr></table></figure></p>\n<p>5、 cron——计划任务模块 （计划任务crontab）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m cron -a <span class=\"string\">\"name='show time' minute=*/1 hour=* day=* month=* weekday=* job='/bin/date'\"</span></span><br><span class=\"line\">$ ansible develop -m cron -a <span class=\"string\">\"name='show time' state=absent\"</span></span><br><span class=\"line\">解释：1、创建一个每分钟显示时间的计划任务</span><br><span class=\"line\">      2、删除名为show time这个计划任务</span><br></pre></td></tr></table></figure></p>\n<p>6、 group——组模块（用户组）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible all-m group -a <span class=\"string\">\"name=develop\"</span></span><br><span class=\"line\">解释：在所有主机上创建一个develop的组 ，state=absent表示删除该组</span><br></pre></td></tr></table></figure></p>\n<p>7、 user——用户模块（用户）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m user -a <span class=\"string\">\"name=harlan groups=root password=-1vFO89dP6qyK\"</span></span><br><span class=\"line\">$ ansible develop -m user -a <span class=\"string\">\"name=harlan state=absent remove=yes\"</span></span><br><span class=\"line\">解释：1、在所有主机上创建harlan用户，并将其添加到root组，密码是经过<span class=\"built_in\">hash</span>加密后的，明文密码会被哈希，所以先填入<span class=\"built_in\">hash</span>后的密码即可</span><br><span class=\"line\">可用此命令<span class=\"built_in\">hash</span>密码  openssl passwd -salt -1 <span class=\"string\">\"123456\"</span></span><br><span class=\"line\">      2、删除harlan用户。Remove表示是否删除用户的同时删除家目录</span><br></pre></td></tr></table></figure></p>\n<p>8、 service——服务模块（服务状态）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m service -a <span class=\"string\">\"name=nginx state=running\"</span></span><br><span class=\"line\">$ ansible develop -m service -a <span class=\"string\">\"name=nginx state=restarted enabled=yes\"</span></span><br><span class=\"line\">解释：1、无论服务处在什么状态，最后都是将服务状态设置为启动，当服务正在运行的时候，显示为changed为<span class=\"literal\">false</span>，state显示为状态，表示为正在运行；当服务停止的时候，显示为changed为<span class=\"literal\">true</span>，表示这个时候将服务进行了启动，状态为启动</span><br><span class=\"line\">      2、表示重启nginx并且将nginx设置为开机自启动，state还有staeted、reloaded、stoped值</span><br></pre></td></tr></table></figure></p>\n<p>9、 script——脚本模块（运行脚本）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m script -a <span class=\"string\">\"/root/a.sh\"</span></span><br><span class=\"line\">解释：在develop主机上运行当前服务器上的a.sh脚本</span><br></pre></td></tr></table></figure></p>\n<p>10、get_url——下载url上指定文件（类似wget）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m get_url -a <span class=\"string\">\"url=http://file.alavening.com/alading_file/head_img/1526900421976.jpg dest=/home/ owner=alad group=alad mode=644\"</span></span><br><span class=\"line\">解释：将url上的图片下载到dest目的目录上,并且设置相应的所有者/组和权限。</span><br></pre></td></tr></table></figure></p>\n<p>11、synchronize——同步目录（默认推送，mode=pull为拉取）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m synchronize -a <span class=\"string\">\"src=/home/test/ dest=/home/test compress=yes delete=yes\"</span></span><br><span class=\"line\">$ ansible develop -m synchronize -a <span class=\"string\">\"src=/home/test/ dest=/home/test compress=yes mode=pull\"</span></span><br><span class=\"line\">解释：1、将src下的文件同步到dest上，delete=yes表示以src 目录为准镜像同步。</span><br><span class=\"line\">      2、拉取远程src上的目录文件到本地dest上</span><br></pre></td></tr></table></figure></p>\n<p>12、template——文档内变量的替换的模块<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop –m template –a ‘src=/mytemplates/foo.j2 dest=/etc/file.conf mode=<span class=\"string\">\"u=rw,g=r,o=r\"</span>’</span><br><span class=\"line\">解释：将src上foo.j2的变量模版复制到dest上。Template适合用playbook编写 ，通过变量然后拷贝到远程主机。</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>可以参考：<a href=\"https://www.cnblogs.com/jsonhc/p/7895399.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/jsonhc/p/7895399.html</a></p>\n</blockquote>\n<p>13、fetch——从远程主机下载文件（不能拉取目录）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m fetch -a <span class=\"string\">\"src=/home/test/xxx dest=/home/ flat=yes\"</span></span><br><span class=\"line\">解释：将远程xxx文件拉取到本地home目录下，目录结构会是dest路径+远程主机名+src，假如远程主机名为develop，拉取的xxx文件在本地的/home/develop/home/<span class=\"built_in\">test</span>目录。如果需要指定拉取到某目录下 加个flat=yes的参数即可。</span><br></pre></td></tr></table></figure></p>\n<p>14、unarchive——解压文件<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m unarchive -a <span class=\"string\">\"src=/root/apache-tomcat-7.0.85.tar.gz dest=/home/test owner=alad group=alad mode=755\"</span></span><br><span class=\"line\">$ ansible develop -m unarchive -a <span class=\"string\">\"src=/home/alad/ansible/elk/logstash-6.2.4.tar.gz dest=/home/test remote_src=yes\"</span></span><br><span class=\"line\">$ ansible develop -m unarchive -a <span class=\"string\">\"src=http://mirrors.linuxeye.com/oneinstack-full.tar.gz dest=/home/test remote_src=yes\"</span></span><br><span class=\"line\">解释：将本地的tomcat压缩包解压到远程主机dest目录下，并修改其权限和所有者/组，remote_src=yes 表示解压远程主机已有的压缩包，src为url表示下载此包到远程主机dest目录进行解压缩后，并删除压缩包源文件</span><br></pre></td></tr></table></figure></p>\n<p>15、command和shell——linux命令模块<br><figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">shell</span><span class=\"bash\">和<span class=\"built_in\">command</span>的区别：shell模块可以特殊字符，而<span class=\"built_in\">command</span>是不支持</span></span><br><span class=\"line\">简单说：command运行的命令中无法使用变量，管道。如果需要使用管道、变量，请使用raw模块,或者<span class=\"keyword\">shell</span><span class=\"bash\">模块。</span></span><br></pre></td></tr></table></figure></p>\n<p>16、setup——获取主机信息<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m setup</span><br><span class=\"line\">$ ansible develop -m setup -a <span class=\"string\">'filter=ansible_*_mb'</span></span><br><span class=\"line\">解释：1、显示系统所有信息</span><br><span class=\"line\">      2、通常配合filter进行过滤来获取主机信息，（例子是显示内存信息）</span><br></pre></td></tr></table></figure></p>\n<p>17、assemble——配置文件组装发送到远程主机<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible <span class=\"built_in\">test</span> -m assemble -a <span class=\"string\">\"src=/root/test dest=/root/ansible/fileone mode=777 remote_src=False delimiter='========'\"</span></span><br><span class=\"line\">解释：将src <span class=\"built_in\">test</span>目录下所有文件（不含<span class=\"built_in\">test</span>子目录内容）的内容发送到dest fileone文件中，remote_src默认为Ture表示src为远程主机上的路径，False为ansible控制端的路径，delimiter为文件之间内容分隔符。</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Playbook语法和结构\"><a href=\"#Playbook语法和结构\" class=\"headerlink\" title=\"Playbook语法和结构\"></a>Playbook语法和结构</h3><p>Playbook需要7个文件夹，如ansible安装nginx，则需要在/etc/ansible/roles目录下建立以下文件夹。<br>mkdir -pv nginx/{default,tasks,vars,meta,handlers,templates,files}<br>对于Ansible，几乎每个YAML文件都以一个列表开始。列表中的每个项目都是键/值对列表，通常称为“散列”或“字典”。所以，我们需要知道如何在YAML中编写列表和字典。<br>YAML还有一个小小的怪癖。所有YAML文件（无论它们是否与Ansible相关联）都可以选择开始—和结束—.。这是YAML格式的一部分，并指示文档的开始和结束。<br>列表中的所有成员都是以相同的缩进级别开头的行（短划线和空格）：”- “</p>\n<p>例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    - bsh:</span> <span class=\"string\">b.sh</span></span><br><span class=\"line\">\t<span class=\"bullet\">-</span> <span class=\"attr\">httprpm:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"attr\">  task:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">install</span> <span class=\"string\">httpd</span></span><br><span class=\"line\">\t  <span class=\"attr\">yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">httprpm</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=present”</span></span><br><span class=\"line\">\t  <span class=\"attr\">tags:</span> <span class=\"string\">install_httpd</span></span><br><span class=\"line\">\t<span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">copy</span> <span class=\"string\">b.sh</span></span><br><span class=\"line\">\t  <span class=\"attr\">copy:</span> <span class=\"string\">src=/root/&#123;&#123;</span> <span class=\"string\">bsh</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">dest=/root/</span> <span class=\"string\">owner=ala</span> <span class=\"string\">group=ala</span> <span class=\"string\">mode=0644</span></span><br><span class=\"line\">\t  <span class=\"attr\">notify:</span></span><br><span class=\"line\">\t    <span class=\"bullet\">-</span> <span class=\"string\">reload</span> <span class=\"string\">httpd</span></span><br><span class=\"line\">\t<span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">start</span> <span class=\"string\">httpd</span></span><br><span class=\"line\">\t  <span class=\"attr\">service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=started</span> <span class=\"string\">enabled=yes</span></span><br><span class=\"line\"><span class=\"attr\">  handlers:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">reload</span> <span class=\"string\">httpd</span></span><br><span class=\"line\">\t  <span class=\"attr\">service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=reloaded</span></span><br></pre></td></tr></table></figure></p>\n<p>第一次的话都会运行，后边如果copy的文件内容发生改变就会触发 notify ，然后会直接执行 handlers 的内容（ 这里notify后边的事件就都不会执行了 ）。</p>\n<h3 id=\"template模块jinja2语法\"><a href=\"#template模块jinja2语法\" class=\"headerlink\" title=\"template模块jinja2语法\"></a>template模块jinja2语法</h3><ul>\n<li><strong>template:使用了Jinjia2格式作为文件模版，进行文档内变量的替换的模块。相当于copy，将jinja2的文件模板理解并执行，转化为各个主机间的对应值。</strong><br>如：template: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf</li>\n</ul>\n<blockquote>\n<p>http.conf.j2必须是完整的文件内容，因为这是覆盖操作，而非只选择性远程主机替换变量，dest要指定文件名，如果是目录就相当于copy了http.conf.j2到远程目录下，不是我们要的结果。</p>\n</blockquote>\n<ul>\n<li><strong>when语句：在tasks中使用，Jinja2的语法格式</strong></li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">start</span> <span class=\"string\">nginx</span> <span class=\"string\">service</span></span><br><span class=\"line\"><span class=\"attr\"> shell:</span> <span class=\"string\">systemctl</span> <span class=\"string\">start</span> <span class=\"string\">nginx.service</span></span><br><span class=\"line\"><span class=\"attr\"> when:</span> <span class=\"string\">ansible_distribution</span> <span class=\"string\">==</span> <span class=\"string\">\"CentOS\"</span> <span class=\"string\">and</span> <span class=\"string\">ansible_distribution_major_version</span> <span class=\"string\">==</span> <span class=\"string\">\"7\"</span></span><br></pre></td></tr></table></figure>\n<p>当系统为 centos 7的时候执行sysctemctl命令，否则不执行</p>\n<ul>\n<li><strong>循环：迭代，需要重复执行的任务</strong></li>\n</ul>\n<blockquote>\n<p>变量名为item，而with_item为要迭代的元素。如果某个任务出错，后面不执行</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">install</span> <span class=\"string\">packages</span></span><br><span class=\"line\"><span class=\"attr\"> yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">item</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=latest</span></span><br><span class=\"line\"><span class=\"attr\"> with_items:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">php</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>这是基于字符串列表给出元素示例 </p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">create</span> <span class=\"string\">users</span></span><br><span class=\"line\"><span class=\"attr\">    user:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">item.name</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">group=&#123;&#123;</span> <span class=\"string\">item.group</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=present</span></span><br><span class=\"line\"><span class=\"attr\">    with_items:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">&#123;name:</span> <span class=\"string\">'userx1'</span><span class=\"string\">,</span> <span class=\"attr\">group:</span> <span class=\"string\">'groupx1'</span><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">&#123;name:</span> <span class=\"string\">'userx2'</span><span class=\"string\">,</span> <span class=\"attr\">group:</span> <span class=\"string\">'groupx2'</span><span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>这是基于字典列表给元素示例：item.name  . 后边的表示键。</p>\n","site":{"data":{}},"length":8716,"excerpt":"","more":"<blockquote>\n<p><strong>本文主要讲解ansible的常用命令和简单安装步骤，具体配置文件详解以及playbook暂未涉及！后续更新。。。。</strong></p>\n</blockquote>\n<h3 id=\"安装Ansible\"><a href=\"#安装Ansible\" class=\"headerlink\" title=\"安装Ansible\"></a>安装Ansible</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum install epel-release ansible -y</span><br></pre></td></tr></table></figure>\n<h3 id=\"配置文件配置\"><a href=\"#配置文件配置\" class=\"headerlink\" title=\"配置文件配置\"></a>配置文件配置</h3><ul>\n<li><p>常用ansible.cfg配置文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/ansible.cfg </span><br><span class=\"line\">  [defaults]</span><br><span class=\"line\">  inventory      = /etc/ansible/hosts           <span class=\"comment\">#主机清单</span></span><br><span class=\"line\">  library        = /usr/share/my_modules/       <span class=\"comment\"># 使用的模块</span></span><br><span class=\"line\">  forks          = 5                            <span class=\"comment\">#处理并发的进程数，建议设置控制机的数量</span></span><br><span class=\"line\">  sudo_user      = root                         <span class=\"comment\">#默认执行远程命令的用户</span></span><br><span class=\"line\">  remote_port    = 22                           <span class=\"comment\">#SSH连接被控制机的端口</span></span><br><span class=\"line\">  gathering = smart                             <span class=\"comment\">#'smart'收集facts的信息，如已收集，则采用缓存。可选参数'implicit'、'explicit'，分别表示每次都收集和默认不收集facts信息</span></span><br><span class=\"line\">  fact_caching_timeout = 86400                  <span class=\"comment\">#'gathering为smart'可用，设置收集超时时间</span></span><br><span class=\"line\">  fact_caching = jsonfile                       <span class=\"comment\">#'gathering为smart'可用，设置以什么存储facts信息。还可在本地安装redis、memcache来作为facts的存储。</span></span><br><span class=\"line\">  fact_caching_connection = /etc/ansible/ansible_facts_cache  <span class=\"comment\">#'gathering为smart'可用，设置缓存路径。</span></span><br><span class=\"line\">  roles_path    = /etc/ansible/roles            <span class=\"comment\">#设置ansible其他roles的路径</span></span><br><span class=\"line\">  host_key_checking = <span class=\"literal\">false</span>                     <span class=\"comment\">#忽略检查主机密钥</span></span><br><span class=\"line\">  log_path = /var/<span class=\"built_in\">log</span>/ansible.log               <span class=\"comment\">#ansible日志路径</span></span><br><span class=\"line\">  module_name = <span class=\"built_in\">command</span>                         <span class=\"comment\">#ansible默认的模块</span></span><br><span class=\"line\">  deprecation_warnings = False                  <span class=\"comment\">#禁用ansible“不建议使用”的警告</span></span><br><span class=\"line\"></span><br><span class=\"line\">  [ssh_connection]</span><br><span class=\"line\">  ssh_args = -C -o ControlMaster=auto -o ControlPersist=1d        <span class=\"comment\">#开启ssh长连接，保存时间为1天</span></span><br><span class=\"line\">  control_path_dir = /etc/ansible/ssh-socket                      <span class=\"comment\">#ssh长连接存放的路径</span></span><br><span class=\"line\">  control_path = %(directory)s/%%h-%%p-%%r                        <span class=\"comment\">#ssh长连接的格式名称</span></span><br><span class=\"line\">  pipelining = True                                               <span class=\"comment\">#减少执行远程模块SSH操作次数，开启这个设置,将显著提高性能，但被控制机需要将/etc/sudoers下\"Defaults requiretty\"注释掉</span></span><br><span class=\"line\"></span><br><span class=\"line\">  [accelerate]</span><br><span class=\"line\">  accelerate_port = 5099                        <span class=\"comment\">#使用python程序在被控制机上运行一个守护进程，ansible通过这个守护进程监听的端口进行通信。所有机器都要安装python-keyczar包</span></span><br><span class=\"line\">  accelerate_timeout = 30                       <span class=\"comment\">#设置用来控制从客户机获取数据的超时时间，如果在这段时间内没有数据传输,套接字连接会被关闭。</span></span><br><span class=\"line\">  accelerate_connect_timeout = 5.0              <span class=\"comment\">#设置空着套接字调用的超时时间.这个应该设置相对比较短.这个和`accelerate_port`连接在回滚到ssh或者paramiko连接方式之前会尝试三次开始远程加速daemon守护进程.默认设置为1.0秒:</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>hosts 文件<br>（机器清单，进行分组管理）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[tomcat]</span><br><span class=\"line\">192.168.16.192</span><br><span class=\"line\">192.168.16.193</span><br><span class=\"line\">[nginx]</span><br><span class=\"line\">app1 ansible_ssh_host=192.168.16.190 ansible_ssh_pass=<span class=\"string\">\"2039\"</span></span><br><span class=\"line\">app2 ansible_ssh_host=192.168.16.191 sudo_user=”ald” ansible_ssh_pass=<span class=\"string\">\"2039\"</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p><em>sudo_user和ansible_ssh_pass为帐号密码方式验证，建议用密钥。</em></p>\n</blockquote>\n<h3 id=\"Ansible指令参数\"><a href=\"#Ansible指令参数\" class=\"headerlink\" title=\"Ansible指令参数\"></a>Ansible指令参数</h3><ul>\n<li><p><strong>ansible 常用命令参数</strong><br>-m指定模块<br>-a 指定模块的命令。默认是command模块，可以省略<br>-B 指定ansible后台运行超时时间<br>-C 测试运行效果，而不是正在运行<br>-f 指定使用的并行进程的数量<br>-i 指定inventory/hosts文件，默认/etc/ansiable/hosts文件<br>–limit=xxx.xxx.xxx.xxx 限制对某个ip或者网段或者组执行<br>–list-hosts 显示将要执行命令的主机</p>\n</li>\n<li><p><strong>ansible-doc 常用命令参数</strong><br>-M –module-path=/xxx/xxx  查询模块 默认是/usr/share/ansible/<br>-l  –list          显示已存在的所有模块<br>-s  command     显示playbook制定模块的用法，类似 man 命令</p>\n</li>\n<li><p><strong>ansible-galaxy</strong> </p>\n<blockquote>\n<p>下载第三方模块指令，类似yum、pip、easy_install这样的命令</p>\n</blockquote>\n<p> ansible-galaxy install &lt;module_name&gt;</p>\n</li>\n<li><p><strong>ansible-playbook</strong> 常用命令参数<br>–syntax-check  [yaml文件]         语法检测<br>-t TAGS    只允许指定的tags标签任务，多个以 , 分开<br>–skip-tags=SKIP_TAGS   跳过指定的标签<br>–start-at-task=START_AT   从哪个任务后执行</p>\n</li>\n</ul>\n<h3 id=\"常用指令模块\"><a href=\"#常用指令模块\" class=\"headerlink\" title=\"常用指令模块\"></a>常用指令模块</h3><p>1、 copy——拷贝模块   (用于将本地或远程机器上的文件拷贝到远程主机上)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible all –m copy -a “src=/xxx/xxx dest=/yyy/yyy owner=root group=root mode=644 force=yes/no backup=yes/no”</span><br><span class=\"line\">解释：将src 文件/目录复制到远程dest上，所有者/组为root 权限为644，force为是否强制替换，backup为替换前是否需要备份远程远文件</span><br></pre></td></tr></table></figure></p>\n<p>2、 raw——命令模块 （和command、shell类似）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible all –m raw -a <span class=\"string\">\"ifconfig\"</span></span><br><span class=\"line\">解释：在所有主机上执行ifocnfig命令。</span><br></pre></td></tr></table></figure></p>\n<p>3、 yum——安装模块 （安装程序）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible all –m yum –a “name=httpd state=present”</span><br><span class=\"line\">解释：安装httpd程序，state可以是present、latest、installed表示安装程序，absent、removed表示卸载程序</span><br></pre></td></tr></table></figure></p>\n<p>4、 file——文件模块 （文件属性修改）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible all –m file –a “src=/xxx/xxx/1 dest=/yyy/1 state=link owner=alad group=alad mode=777”</span><br><span class=\"line\">$ ansible develop -m file -a <span class=\"string\">\"path=/xxx/dir recurse=yes owner=root group=alad mode=644\"</span></span><br><span class=\"line\">解释：1、将src的文件软连接到dest目录下，并修改所有者/组和权限</span><br><span class=\"line\">      2、将path路径的目录递归形式设置所有者和权限</span><br><span class=\"line\">*、state还可以是directory：如果目录不存在，创建目录</span><br><span class=\"line\">    file：即使文件不存在，也不会被创建</span><br><span class=\"line\">\thard：创建硬链接</span><br><span class=\"line\">    touch：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间</span><br><span class=\"line\">    absent：删除目录、文件或者取消链接文件</span><br></pre></td></tr></table></figure></p>\n<p>5、 cron——计划任务模块 （计划任务crontab）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m cron -a <span class=\"string\">\"name='show time' minute=*/1 hour=* day=* month=* weekday=* job='/bin/date'\"</span></span><br><span class=\"line\">$ ansible develop -m cron -a <span class=\"string\">\"name='show time' state=absent\"</span></span><br><span class=\"line\">解释：1、创建一个每分钟显示时间的计划任务</span><br><span class=\"line\">      2、删除名为show time这个计划任务</span><br></pre></td></tr></table></figure></p>\n<p>6、 group——组模块（用户组）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible all-m group -a <span class=\"string\">\"name=develop\"</span></span><br><span class=\"line\">解释：在所有主机上创建一个develop的组 ，state=absent表示删除该组</span><br></pre></td></tr></table></figure></p>\n<p>7、 user——用户模块（用户）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m user -a <span class=\"string\">\"name=harlan groups=root password=-1vFO89dP6qyK\"</span></span><br><span class=\"line\">$ ansible develop -m user -a <span class=\"string\">\"name=harlan state=absent remove=yes\"</span></span><br><span class=\"line\">解释：1、在所有主机上创建harlan用户，并将其添加到root组，密码是经过<span class=\"built_in\">hash</span>加密后的，明文密码会被哈希，所以先填入<span class=\"built_in\">hash</span>后的密码即可</span><br><span class=\"line\">可用此命令<span class=\"built_in\">hash</span>密码  openssl passwd -salt -1 <span class=\"string\">\"123456\"</span></span><br><span class=\"line\">      2、删除harlan用户。Remove表示是否删除用户的同时删除家目录</span><br></pre></td></tr></table></figure></p>\n<p>8、 service——服务模块（服务状态）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m service -a <span class=\"string\">\"name=nginx state=running\"</span></span><br><span class=\"line\">$ ansible develop -m service -a <span class=\"string\">\"name=nginx state=restarted enabled=yes\"</span></span><br><span class=\"line\">解释：1、无论服务处在什么状态，最后都是将服务状态设置为启动，当服务正在运行的时候，显示为changed为<span class=\"literal\">false</span>，state显示为状态，表示为正在运行；当服务停止的时候，显示为changed为<span class=\"literal\">true</span>，表示这个时候将服务进行了启动，状态为启动</span><br><span class=\"line\">      2、表示重启nginx并且将nginx设置为开机自启动，state还有staeted、reloaded、stoped值</span><br></pre></td></tr></table></figure></p>\n<p>9、 script——脚本模块（运行脚本）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m script -a <span class=\"string\">\"/root/a.sh\"</span></span><br><span class=\"line\">解释：在develop主机上运行当前服务器上的a.sh脚本</span><br></pre></td></tr></table></figure></p>\n<p>10、get_url——下载url上指定文件（类似wget）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m get_url -a <span class=\"string\">\"url=http://file.alavening.com/alading_file/head_img/1526900421976.jpg dest=/home/ owner=alad group=alad mode=644\"</span></span><br><span class=\"line\">解释：将url上的图片下载到dest目的目录上,并且设置相应的所有者/组和权限。</span><br></pre></td></tr></table></figure></p>\n<p>11、synchronize——同步目录（默认推送，mode=pull为拉取）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m synchronize -a <span class=\"string\">\"src=/home/test/ dest=/home/test compress=yes delete=yes\"</span></span><br><span class=\"line\">$ ansible develop -m synchronize -a <span class=\"string\">\"src=/home/test/ dest=/home/test compress=yes mode=pull\"</span></span><br><span class=\"line\">解释：1、将src下的文件同步到dest上，delete=yes表示以src 目录为准镜像同步。</span><br><span class=\"line\">      2、拉取远程src上的目录文件到本地dest上</span><br></pre></td></tr></table></figure></p>\n<p>12、template——文档内变量的替换的模块<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop –m template –a ‘src=/mytemplates/foo.j2 dest=/etc/file.conf mode=<span class=\"string\">\"u=rw,g=r,o=r\"</span>’</span><br><span class=\"line\">解释：将src上foo.j2的变量模版复制到dest上。Template适合用playbook编写 ，通过变量然后拷贝到远程主机。</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>可以参考：<a href=\"https://www.cnblogs.com/jsonhc/p/7895399.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/jsonhc/p/7895399.html</a></p>\n</blockquote>\n<p>13、fetch——从远程主机下载文件（不能拉取目录）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m fetch -a <span class=\"string\">\"src=/home/test/xxx dest=/home/ flat=yes\"</span></span><br><span class=\"line\">解释：将远程xxx文件拉取到本地home目录下，目录结构会是dest路径+远程主机名+src，假如远程主机名为develop，拉取的xxx文件在本地的/home/develop/home/<span class=\"built_in\">test</span>目录。如果需要指定拉取到某目录下 加个flat=yes的参数即可。</span><br></pre></td></tr></table></figure></p>\n<p>14、unarchive——解压文件<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m unarchive -a <span class=\"string\">\"src=/root/apache-tomcat-7.0.85.tar.gz dest=/home/test owner=alad group=alad mode=755\"</span></span><br><span class=\"line\">$ ansible develop -m unarchive -a <span class=\"string\">\"src=/home/alad/ansible/elk/logstash-6.2.4.tar.gz dest=/home/test remote_src=yes\"</span></span><br><span class=\"line\">$ ansible develop -m unarchive -a <span class=\"string\">\"src=http://mirrors.linuxeye.com/oneinstack-full.tar.gz dest=/home/test remote_src=yes\"</span></span><br><span class=\"line\">解释：将本地的tomcat压缩包解压到远程主机dest目录下，并修改其权限和所有者/组，remote_src=yes 表示解压远程主机已有的压缩包，src为url表示下载此包到远程主机dest目录进行解压缩后，并删除压缩包源文件</span><br></pre></td></tr></table></figure></p>\n<p>15、command和shell——linux命令模块<br><figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">shell</span><span class=\"bash\">和<span class=\"built_in\">command</span>的区别：shell模块可以特殊字符，而<span class=\"built_in\">command</span>是不支持</span></span><br><span class=\"line\">简单说：command运行的命令中无法使用变量，管道。如果需要使用管道、变量，请使用raw模块,或者<span class=\"keyword\">shell</span><span class=\"bash\">模块。</span></span><br></pre></td></tr></table></figure></p>\n<p>16、setup——获取主机信息<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible develop -m setup</span><br><span class=\"line\">$ ansible develop -m setup -a <span class=\"string\">'filter=ansible_*_mb'</span></span><br><span class=\"line\">解释：1、显示系统所有信息</span><br><span class=\"line\">      2、通常配合filter进行过滤来获取主机信息，（例子是显示内存信息）</span><br></pre></td></tr></table></figure></p>\n<p>17、assemble——配置文件组装发送到远程主机<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible <span class=\"built_in\">test</span> -m assemble -a <span class=\"string\">\"src=/root/test dest=/root/ansible/fileone mode=777 remote_src=False delimiter='========'\"</span></span><br><span class=\"line\">解释：将src <span class=\"built_in\">test</span>目录下所有文件（不含<span class=\"built_in\">test</span>子目录内容）的内容发送到dest fileone文件中，remote_src默认为Ture表示src为远程主机上的路径，False为ansible控制端的路径，delimiter为文件之间内容分隔符。</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Playbook语法和结构\"><a href=\"#Playbook语法和结构\" class=\"headerlink\" title=\"Playbook语法和结构\"></a>Playbook语法和结构</h3><p>Playbook需要7个文件夹，如ansible安装nginx，则需要在/etc/ansible/roles目录下建立以下文件夹。<br>mkdir -pv nginx/{default,tasks,vars,meta,handlers,templates,files}<br>对于Ansible，几乎每个YAML文件都以一个列表开始。列表中的每个项目都是键/值对列表，通常称为“散列”或“字典”。所以，我们需要知道如何在YAML中编写列表和字典。<br>YAML还有一个小小的怪癖。所有YAML文件（无论它们是否与Ansible相关联）都可以选择开始—和结束—.。这是YAML格式的一部分，并指示文档的开始和结束。<br>列表中的所有成员都是以相同的缩进级别开头的行（短划线和空格）：”- “</p>\n<p>例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    - bsh:</span> <span class=\"string\">b.sh</span></span><br><span class=\"line\">\t<span class=\"bullet\">-</span> <span class=\"attr\">httprpm:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"attr\">  task:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">install</span> <span class=\"string\">httpd</span></span><br><span class=\"line\">\t  <span class=\"attr\">yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">httprpm</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=present”</span></span><br><span class=\"line\">\t  <span class=\"attr\">tags:</span> <span class=\"string\">install_httpd</span></span><br><span class=\"line\">\t<span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">copy</span> <span class=\"string\">b.sh</span></span><br><span class=\"line\">\t  <span class=\"attr\">copy:</span> <span class=\"string\">src=/root/&#123;&#123;</span> <span class=\"string\">bsh</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">dest=/root/</span> <span class=\"string\">owner=ala</span> <span class=\"string\">group=ala</span> <span class=\"string\">mode=0644</span></span><br><span class=\"line\">\t  <span class=\"attr\">notify:</span></span><br><span class=\"line\">\t    <span class=\"bullet\">-</span> <span class=\"string\">reload</span> <span class=\"string\">httpd</span></span><br><span class=\"line\">\t<span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">start</span> <span class=\"string\">httpd</span></span><br><span class=\"line\">\t  <span class=\"attr\">service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=started</span> <span class=\"string\">enabled=yes</span></span><br><span class=\"line\"><span class=\"attr\">  handlers:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">reload</span> <span class=\"string\">httpd</span></span><br><span class=\"line\">\t  <span class=\"attr\">service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=reloaded</span></span><br></pre></td></tr></table></figure></p>\n<p>第一次的话都会运行，后边如果copy的文件内容发生改变就会触发 notify ，然后会直接执行 handlers 的内容（ 这里notify后边的事件就都不会执行了 ）。</p>\n<h3 id=\"template模块jinja2语法\"><a href=\"#template模块jinja2语法\" class=\"headerlink\" title=\"template模块jinja2语法\"></a>template模块jinja2语法</h3><ul>\n<li><strong>template:使用了Jinjia2格式作为文件模版，进行文档内变量的替换的模块。相当于copy，将jinja2的文件模板理解并执行，转化为各个主机间的对应值。</strong><br>如：template: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf</li>\n</ul>\n<blockquote>\n<p>http.conf.j2必须是完整的文件内容，因为这是覆盖操作，而非只选择性远程主机替换变量，dest要指定文件名，如果是目录就相当于copy了http.conf.j2到远程目录下，不是我们要的结果。</p>\n</blockquote>\n<ul>\n<li><strong>when语句：在tasks中使用，Jinja2的语法格式</strong></li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">start</span> <span class=\"string\">nginx</span> <span class=\"string\">service</span></span><br><span class=\"line\"><span class=\"attr\"> shell:</span> <span class=\"string\">systemctl</span> <span class=\"string\">start</span> <span class=\"string\">nginx.service</span></span><br><span class=\"line\"><span class=\"attr\"> when:</span> <span class=\"string\">ansible_distribution</span> <span class=\"string\">==</span> <span class=\"string\">\"CentOS\"</span> <span class=\"string\">and</span> <span class=\"string\">ansible_distribution_major_version</span> <span class=\"string\">==</span> <span class=\"string\">\"7\"</span></span><br></pre></td></tr></table></figure>\n<p>当系统为 centos 7的时候执行sysctemctl命令，否则不执行</p>\n<ul>\n<li><strong>循环：迭代，需要重复执行的任务</strong></li>\n</ul>\n<blockquote>\n<p>变量名为item，而with_item为要迭代的元素。如果某个任务出错，后面不执行</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">install</span> <span class=\"string\">packages</span></span><br><span class=\"line\"><span class=\"attr\"> yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">item</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=latest</span></span><br><span class=\"line\"><span class=\"attr\"> with_items:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">php</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>这是基于字符串列表给出元素示例 </p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">create</span> <span class=\"string\">users</span></span><br><span class=\"line\"><span class=\"attr\">    user:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">item.name</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">group=&#123;&#123;</span> <span class=\"string\">item.group</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=present</span></span><br><span class=\"line\"><span class=\"attr\">    with_items:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">&#123;name:</span> <span class=\"string\">'userx1'</span><span class=\"string\">,</span> <span class=\"attr\">group:</span> <span class=\"string\">'groupx1'</span><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">&#123;name:</span> <span class=\"string\">'userx2'</span><span class=\"string\">,</span> <span class=\"attr\">group:</span> <span class=\"string\">'groupx2'</span><span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>这是基于字典列表给元素示例：item.name  . 后边的表示键。</p>\n"},{"layout":"post","title":"HTTP请求头响应头字段详解","author":"Pyker","img":"/images/bar/http.jpg","top":false,"cover":false,"date":"2017-12-26T05:15:00.000Z","_content":"HTTP消息头是指，在超文本传输协议（ Hypertext Transfer Protocol ，HTTP）的请求和响应消息中，协议头部分的那些组件。HTTP消息头用来准确描述正在获取的资源、服务器或者客户端的行为，定义了HTTP事务中的具体操作参数。\n### 关于HTTP消息头\nHTTP消息头是在`客户端请求（Request）` 或`服务器响应（Response）` 时传递的，为请求或响应的第一行，HTTP消息体（请求或响应的内容）是其后传输。HTTP消息头，以明文的字符串格式传送，是以冒号分隔的键/值对，如：Accept-Charset: utf-8，每一个消息头最后以回车符(CR)和换行符(LF)结尾。HTTP消息头结束后，会用一个空白的字段来标识，这样就会出现两个连续的CR-LF。\nHTTP消息头支持自定义， 自定义的专用消息头一般会添加'X-'前缀。\n### 常用标准请求头字段\n**Accept 设置接受的内容类型**\n\n\tAccept: text/plain\n\n**Accept-Charset 设置接受的字符编码**\n\n\tAccept-Charset: utf-8\n\n**Accept-Encoding 设置接受的编码格式**\n\n\tAccept-Encoding: gzip, deflate\n\n**Accept-Datetime 设置接受的版本时间**\n\n\tAccept-Datetime: Thu, 31 May 2007 20:35:00 GMT\n\n**Accept-Language 设置接受的语言**\n\n\tAccept-Language: en-US\n\n**Authorization 设置HTTP身份验证的凭证**\n\n\tAuthorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==\n\n**Cache-Control 设置请求响应链上所有的缓存机制必须遵守的指令**\n\n\tCache-Control: no-cache\n\n**Connection 设置当前连接和hop-by-hop协议请求字段列表的控制选项**\n\n\tConnection: keep-alive\n\tConnection: Upgrade\n\n**Content-Length 设置请求体的字节长度**\n\n\tContent-Length: 348\n\n**Content-MD5 设置基于MD5算法对请求体内容进行Base64二进制编码**\n\n\tContent-MD5: Q2hlY2sgSW50ZWdyaXR5IQ==\n\n**Content-Type 设置请求体的MIME类型（适用POST和PUT请求）**\n\n\tContent-Type: application/x-www-form-urlencoded\n\n**Cookie 设置服务器使用Set-Cookie发送的http cookie**\n\n\tCookie: $Version=1; Skin=new;\n\n**Date 设置消息发送的日期和时间**\n\n\tDate: Tue, 15 Nov 1994 08:12:31 GMT\n\n**Expect 标识客户端需要的特殊浏览器行为**\n\n\tExpect: 100-continue\n\n**Forwarded 披露客户端通过http代理连接web服务的源信息**\n\n\tForwarded: for=192.0.2.60;proto=http;by=203.0.113.43\n\tForwarded: for=192.0.2.43, for=198.51.100.17\n\n**From 设置发送请求的用户的email地址**\n\n\tFrom: user@example.com\n\n**Host 设置服务器域名和TCP端口号，如果使用的是服务请求标准端口号，端口号可以省略**\n\n\tHost: en.wikipedia.org:8080\n\tHost: en.wikipedia.org\n\n**If-Match 设置客户端的ETag,当时客户端ETag和服务器生成的ETag一致才执行，适用于更新自从上次更新之后没有改变的资源**\n\n\tIf-Match: \"737060cd8c284d8af7ad3082f209582d\n\n**If-Modified-Since 设置更新时间，从更新时间到服务端接受请求这段时间内如果资源没有改变，允许服务端返回304 Not Modified**\n\n\tIf-Modified-Since: Sat, 29 Oct 1994 19:43:31 GMT\n\n**If-None-Match 设置客户端ETag，如果和服务端接受请求生成的ETage相同，允许服务端返回304 Not Modified**\n\n\tIf-None-Match: \"737060cd8c284d8af7ad3082f209582d\"\n\n**If-Range 设置客户端ETag，如果和服务端接受请求生成的ETage相同，返回缺失的实体部分；否则返回整个新的实体**\n\n\tIf-Range: \"737060cd8c284d8af7ad3082f209582d\"\n\n**If-Unmodified-Since 设置更新时间，只有从更新时间到服务端接受请求这段时间内实体没有改变，服务端才会发送响应**\n\n\tIf-Unmodified-Since: Sat, 29 Oct 1994 19:43:31 GMT\n\n**Max-Forwards 限制代理或网关转发消息的次数**\n\n\tMax-Forwards: 10\n\n**Origin 标识跨域资源请求（请求服务端设置Access-Control-Allow-Origin响应字段）**\n\n\tOrigin: http://www.example-social-network.com\n\n**Pragma 设置特殊实现字段，可能会对请求响应链有多种影响**\n\n\tPragma: no-cache\n\n**Proxy-Authorization 为连接代理授权认证信息**\n\n\tProxy-Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==\n\n**Range 请求部分实体，设置请求实体的字节数范围，具体可以参见HTTP/1.1中的Byte serving**\n\n\tRange: bytes=500-999\n\n**Referer 设置前一个页面的地址，并且前一个页面中的连接指向当前请求，意思就是如果当前请求是在A页面中发送的，那么referer就是A页面的url地址（轶 事：这个单词正确的拼法应该是\"referrer\",但是在很多规范中都拼成了\"referer\"，所以这个单词也就成为标准用法）**\n\n\tReferer: http://en.wikipedia.org/wiki/Main_Page\n\n**TE 设置用户代理期望接受的传输编码格式，和响应头中的Transfer-Encoding字段一样**\n\n\tTE: trailers, deflate\n\n**Upgrade 请求服务端升级协议**\n\n\tUpgrade: HTTP/2.0, HTTPS/1.3, IRC/6.9, RTA/x11, websocket\n\n**User-Agent 用户代理的字符串值**\n\n\tUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:12.0) Gecko/20100101 Firefox/21.0\n\n**Via 通知服务器代理请求**\n\n\tVia: 1.0 fred, 1.1 example.com (Apache/1.1)\n\n**Warning 实体可能会发生的问题的通用警告**\n\n\tWarning: 199 Miscellaneous warning\n\t\n### 常用非标准请求头字段\n\n**X-Requested-With 标识Ajax请求，大部分js框架发送请求时都会设置它为XMLHttpRequest**\n\n\tX-Requested-With: XMLHttpRequest\n\n**DNT 请求web应用禁用用户追踪**\n\n\tDNT: 1 (Do Not Track Enabled)\n\tDNT: 0 (Do Not Track Disabled)\n\n**X-Forwarded-For 一个事实标准，用来标识客户端通过HTTP代理或者负载均衡器连接的web服务器的原始IP地址**\n\n\tX-Forwarded-For: client1, proxy1, proxy2\n\tX-Forwarded-For: 129.78.138.66, 129.78.64.103\n\n**X-Forwarded-Host 一个事实标准，用来标识客户端在HTTP请求头中请求的原始host,因为主机名或者反向代理的端口可能与处理请求的原始服务器不同**\n\n\tX-Forwarded-Host: en.wikipedia.org:8080\n\tX-Forwarded-Host: en.wikipedia.org\n\n**X-Forwarded-Proto 一个事实标准，用来标识HTTP原始协议，因为反向代理或者负载均衡器和web服务器可能使用http,但是请求到反向代理使用的是https**\n\n\tX-Forwarded-Proto: https\n\n**Front-End-Https 微软应用程序和负载均衡器使用的非标准header字段 Front-End-Https: on**\n\n**X-Http-Method-Override 请求web应用时，使用header字段中给定的方法（通常是put或者delete）覆盖请求中指定的方法（通常是post）,如果用户代理或者防火墙不支持直接使用put或者delete方法发送请求时，可以使用这个字段**\n\n\tX-HTTP-Method-Override: DELETE\n\n**X-ATT-DeviceId 允许更简单的解析用户代理在AT&T设备上的MakeModel/Firmware**\n\n\tX-Att-Deviceid: GT-P7320/P7320XXLPG\n\n**X-Wap-Profile 设置描述当前连接设备的详细信息的xml文件在网络中的位置**\n\n\tx-wap-profile: http://wap.samsungmobile.com/uaprof/SGH-I777.xml\n\n**Proxy-Connection 早起HTTP版本中的一个误称，现在使用标准的connection字段**\n\n\tProxy-Connection: keep-alive\n\n**X-UIDH 服务端深度包检测插入的一个唯一ID标识Verizon Wireless的客户**\n\n\tX-UIDH: ...\n\n**X-Csrf-Token,X-CSRFToken,X-XSRF-TOKEN 防止跨站请求伪造**\n\n\tX-Csrf-Token: i8XNjC4b8KVok4uw5RftR38Wgp2BFwql\n\n**X-Request-ID,X-Correlation-ID 标识客户端和服务端的HTTP请求**\n\n\tX-Request-ID: f058ebd6-02f7-4d3f-942e-904344e8cde5\n\n### 常用标准响应头字段\n\n**Access-Control-Allow-Origin 指定哪些站点可以参与跨站资源共享**\n\n\tAccess-Control-Allow-Origin: *\n\n**Accept-Patch 指定服务器支持的补丁文档格式，适用于http的patch方法**\n\n\tAccept-Patch: text/example;charset=utf-8\n\n**Accept-Ranges 服务器通过byte serving支持的部分内容范围类型**\n\n\tAccept-Ranges: bytes\n\n**Age 对象在代理缓存中暂存的秒数**\n\n\tAge: 12\n\n**Allow 设置特定资源的有效行为，适用方法不被允许的http 405错误**\n\n\tAllow: GET, HEAD\n\n**Alt-Svc 服务器使用\"Alt-Svc\"（Alternative Servicesde的缩写）头标识资源可以通过不同的网络位置或者不同的网络协议获取**\n\n\tAlt-Svc: h2=\"http2.example.com:443\"; ma=7200\n\n**Cache-Control 告诉服务端到客户端所有的缓存机制是否可以缓存这个对象，单位是秒**\n\n\tCache-Control: max-age=3600\n\n**Connection 设置当前连接和hop-by-hop协议请求字段列表的控制选项**\n\n\tConnection: close\n\n**Content-Disposition 告诉客户端弹出一个文件下载框，并且可以指定下载文件名**\n\n\tContent-Disposition: attachment; filename=\"fname.ext\"\n\n**Content-Encoding 设置数据使用的编码类型**\n\n\tContent-Encoding: gzip\n\n**Content-Language 为封闭内容设置自然语言或者目标用户语言**\n\n\tContent-Language: en\n\n**Content-Length 响应体的字节长度**\n\n\tContent-Length: 348\n\n**Content-Location 设置返回数据的另一个位置**\n\n\tContent-Location: /index.htm\n\n**Content-MD5 设置基于MD5算法对响应体内容进行Base64二进制编码**\n\n\tContent-MD5: Q2hlY2sgSW50ZWdyaXR5IQ==\n\n**Content-Range 标识响应体内容属于完整消息体中的那一部分**\n\n\tContent-Range: bytes 21010-47021/47022\n\n**Content-Type 设置响应体的MIME类型**\n\n\tContent-Type: text/html; charset=utf-8\n\n**Date 设置消息发送的日期和时间**\n\n\tDate: Tue, 15 Nov 1994 08:12:31 GMT\n\n**ETag 特定版本资源的标识符，通常是消息摘要**\n\n\tETag: \"737060cd8c284d8af7ad3082f209582d\"\n\n**Expires 设置响应体的过期时间**\n\n\tExpires: Thu, 01 Dec 1994 16:00:00 GMT\n\n**Last-Modified 设置请求对象最后一次的修改日期**\n\n\tLast-Modified: Tue, 15 Nov 1994 12:45:26 GMT\n\n**Link 设置与其他资源的类型关系**\n\n\tLink: </feed>; rel=\"alternate\"\n\n**Location 在重定向中或者创建新资源时使用**\n\n\tLocation: http://www.w3.org/pub/WWW/People.html\n\n**P3P 以P3P:CP=\"your_compact_policy\"的格式设置支持P3P(Platform for Privacy Preferences Project)策略，大部分浏览器没有完全支持P3P策略，许多站点设置假的策略内容欺骗支持P3P策略的浏览器以获取第三方cookie的授权**\n\n\tP3P: CP=\"This is not a P3P policy! See http://www.google.com/support/accounts/bin/answer.py?hl=en&answer=151657 for more info.\"\n\n**Pragma 设置特殊实现字段，可能会对请求响应链有多种影响**\n\n\tPragma: no-cache\n\n**Proxy-Authenticate 设置访问代理的请求权限**\n\n\tProxy-Authenticate: Basic\n\n**Public-Key-Pins 设置站点的授权TLS证书**\n\n\tPublic-Key-Pins: max-age=2592000; pin-sha256=\"E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g=\";\n\n**Refresh \"重定向或者新资源创建时使用，在页面的头部有个扩展可以实现相似的功能，并且大部分浏览器都支持**\n`meta http-equiv=\"refresh\" content=\"5; url=http://example.com/` \n\n\tRefresh: 5; url=http://www.w3.org/pub/WWW/People.html\n\n**Retry-After 如果实体暂时不可用，可以设置这个值让客户端重试，可以使用时间段（单位是秒）或者HTTP时间**\n\n\tExample 1: Retry-After: 120\n\tExample 2: Retry-After: Fri, 07 Nov 2014 23:59:59 GMT\n\n**Server 服务器WEB名称**\n\n\tServer: Apache/2.4.1 (Unix)\n\n**Set-Cookie 设置HTTP Cookie**\n\n\tSet-Cookie: UserID=JohnDoe; Max-Age=3600; Version=1\n\n**Status 设置HTTP响应状态**\n\n\tStatus: 200 OK\n\n**Strict-Transport-Security 一种HSTS策略通知HTTP客户端缓存HTTPS策略多长时间以及是否应用到子域**\n\n\tStrict-Transport-Security: max-age=16070400; includeSubDomains\n\n**Trailer 标识给定的header字段将展示在后续的chunked编码的消息中**\n\n\tTrailer: Max-Forwards\n\n**Transfer-Encoding 设置传输实体的编码格式，目前支持的格式： chunked, compress, deflate, gzip, identity**\n\n\tTransfer-Encoding: chunked\n\n**TSV Tracking Status Value，在响应中设置给DNT(do-not-track),可能的取值**\n\n\t\"!\" — under construction\n\t\"?\" — dynamic\n\t\"G\" — gateway to multiple parties\n\t\"N\" — not tracking\n\t\"T\" — tracking\n\t\"C\" — tracking with consent\n\t\"P\" — tracking only if consented\n\t\"D\" — disregarding DNT\n\t\"U\" — updated\n\t\n\tTSV: ?\n\n**Upgrade 请求客户端升级协议**\n\n\tUpgrade: HTTP/2.0, HTTPS/1.3, IRC/6.9, RTA/x11, websocket\n\n**Vary 通知下级代理如何匹配未来的请求头已让其决定缓存的响应是否可用而不是重新从源主机请求新的**\n\n\tExample 1: Vary: *\n\tExample 2: Vary: Accept-Language\n\n**Via 通知客户端代理，通过其要发送什么响应**\n\n\tVia: cache46.l2cn1341[84,206-0,H], cache38.l2c0c801[91,0], kunlun6.cn536[172,304-0,H], kunlun7.cn196[174,0]\n\n**x-cache 是否命中缓存，HIT和MISS**\n\t\n\tx-cache: HIT TCP_IMS_HIT dirn:-2:-2\n\t\n**Warning 实体可能会发生的问题的通用警告**\n\n\tWarning: 199 Miscellaneous warning\n\n**WWW-Authenticate 标识访问请求实体的身份验证方案**\n\n\tWWW-Authenticate: Basic\n\n**X-Frame-Options 点击劫持保护：**\n\n\tdeny frame中不渲染\n\tsameorigin 如果源不匹配不渲染\n\tallow-from 允许指定位置访问\n\tallowall 不标准，允许任意位置访问\n\n\tX-Frame-Options: deny\n\n### 常用非标准响应头字段\n**X-XSS-Protection 过滤跨站脚本**\n\n\tX-XSS-Protection: 1; mode=block\n\n**Content-Security-Policy, X-Content-Security-Policy,X-WebKit-CSP 定义内容安全策略**\n\n\tX-WebKit-CSP: default-src 'self'\n\n**X-Content-Type-Options 唯一的取值是\"\",阻止IE在响应中嗅探定义的内容格式以外的其他MIME格式**\n\n\tX-Content-Type-Options: nosniff\n\n**X-Powered-By 指定支持web应用的技术**\n\n\tX-Powered-By: PHP/5.4.0\n\n**X-UA-Compatible 推荐首选的渲染引擎来展示内容，通常向后兼容，也用于激活IE中内嵌chrome框架插件**\n`<meta http-equiv=\"X-UA-Compatible\" content=\"chrome=1\" />` \n\n\tX-UA-Compatible: IE=EmulateIE7\n\tX-UA-Compatible: IE=edge\n\tX-UA-Compatible: Chrome=1\n\n**X-Content-Duration 提供音视频的持续时间，单位是秒，只有Gecko内核浏览器支持**\n\n\tX-Content-Duration: 42.666\n\n**Upgrade-Insecure-Requests 标识服务器是否可以处理HTTPS协议**\n\n\tUpgrade-Insecure-Requests: 1\n\n**X-Request-ID,X-Correlation-ID 标识一个客户端和服务端的请求**\n\n\tX-Request-ID: f058ebd6-02f7-4d3f-942e-904344e8cde5\n\t\n**以下是一次客户端请求某网页的过程**\n\n![](/images/pic/http-cache.png)\n如图通过二次请求对网页状态说明\n>1. 客户端通过浏览器打开某网页，判断本地缓存是否过期。\n>\n>2. 没过期直接从缓存读取并且返回结果。\n>\n>3. 如果过期，服务器算出一个哈希值并通过 ETag 返回给浏览器，浏览器把哈希值和页面同时缓存在本地，当下次再次向服务器请求时，会通过类似 If-None-Match: \"etag值\" 的请求头把ETag发送给服务器，服务器再次计算页面的哈希值并和浏览器返回的值做比较，如果发现发生了变化就把页面返回给浏览器(200)，如果发现没有变化就给浏览器返回一个304未修改。这样通过控制浏览器端的缓存，可以节省服务器的带宽，因为服务器不需要每次都把全量数据返回给客户端。\n当未携带Etag时，客户端访问页面，服务器会将页面最后修改时间通过 Last-Modified 标识由服务器发往客户端，客户端记录修改时间，再次请求本地存在的cache页面时，客户端会通过 If-Modified-Since 头将先前服务器端发过来的Last-Modified时间戳发送回去，服务器端通过这个时间戳判断客户端的页面是否是最新的，如果不是最新的，则返回新的内容，如果是最新的，则 返回 304 告诉客户端其本地 cache 的页面是最新的。\n","source":"_posts/http-header.md","raw":"layout: post\ntitle: HTTP请求头响应头字段详解\nauthor: Pyker\ncategories: web\nimg: /images/bar/http.jpg\ntags:\n  - https\ntop: false\ncover: false\ndate: 2017-12-26 13:15:00\n---\nHTTP消息头是指，在超文本传输协议（ Hypertext Transfer Protocol ，HTTP）的请求和响应消息中，协议头部分的那些组件。HTTP消息头用来准确描述正在获取的资源、服务器或者客户端的行为，定义了HTTP事务中的具体操作参数。\n### 关于HTTP消息头\nHTTP消息头是在`客户端请求（Request）` 或`服务器响应（Response）` 时传递的，为请求或响应的第一行，HTTP消息体（请求或响应的内容）是其后传输。HTTP消息头，以明文的字符串格式传送，是以冒号分隔的键/值对，如：Accept-Charset: utf-8，每一个消息头最后以回车符(CR)和换行符(LF)结尾。HTTP消息头结束后，会用一个空白的字段来标识，这样就会出现两个连续的CR-LF。\nHTTP消息头支持自定义， 自定义的专用消息头一般会添加'X-'前缀。\n### 常用标准请求头字段\n**Accept 设置接受的内容类型**\n\n\tAccept: text/plain\n\n**Accept-Charset 设置接受的字符编码**\n\n\tAccept-Charset: utf-8\n\n**Accept-Encoding 设置接受的编码格式**\n\n\tAccept-Encoding: gzip, deflate\n\n**Accept-Datetime 设置接受的版本时间**\n\n\tAccept-Datetime: Thu, 31 May 2007 20:35:00 GMT\n\n**Accept-Language 设置接受的语言**\n\n\tAccept-Language: en-US\n\n**Authorization 设置HTTP身份验证的凭证**\n\n\tAuthorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==\n\n**Cache-Control 设置请求响应链上所有的缓存机制必须遵守的指令**\n\n\tCache-Control: no-cache\n\n**Connection 设置当前连接和hop-by-hop协议请求字段列表的控制选项**\n\n\tConnection: keep-alive\n\tConnection: Upgrade\n\n**Content-Length 设置请求体的字节长度**\n\n\tContent-Length: 348\n\n**Content-MD5 设置基于MD5算法对请求体内容进行Base64二进制编码**\n\n\tContent-MD5: Q2hlY2sgSW50ZWdyaXR5IQ==\n\n**Content-Type 设置请求体的MIME类型（适用POST和PUT请求）**\n\n\tContent-Type: application/x-www-form-urlencoded\n\n**Cookie 设置服务器使用Set-Cookie发送的http cookie**\n\n\tCookie: $Version=1; Skin=new;\n\n**Date 设置消息发送的日期和时间**\n\n\tDate: Tue, 15 Nov 1994 08:12:31 GMT\n\n**Expect 标识客户端需要的特殊浏览器行为**\n\n\tExpect: 100-continue\n\n**Forwarded 披露客户端通过http代理连接web服务的源信息**\n\n\tForwarded: for=192.0.2.60;proto=http;by=203.0.113.43\n\tForwarded: for=192.0.2.43, for=198.51.100.17\n\n**From 设置发送请求的用户的email地址**\n\n\tFrom: user@example.com\n\n**Host 设置服务器域名和TCP端口号，如果使用的是服务请求标准端口号，端口号可以省略**\n\n\tHost: en.wikipedia.org:8080\n\tHost: en.wikipedia.org\n\n**If-Match 设置客户端的ETag,当时客户端ETag和服务器生成的ETag一致才执行，适用于更新自从上次更新之后没有改变的资源**\n\n\tIf-Match: \"737060cd8c284d8af7ad3082f209582d\n\n**If-Modified-Since 设置更新时间，从更新时间到服务端接受请求这段时间内如果资源没有改变，允许服务端返回304 Not Modified**\n\n\tIf-Modified-Since: Sat, 29 Oct 1994 19:43:31 GMT\n\n**If-None-Match 设置客户端ETag，如果和服务端接受请求生成的ETage相同，允许服务端返回304 Not Modified**\n\n\tIf-None-Match: \"737060cd8c284d8af7ad3082f209582d\"\n\n**If-Range 设置客户端ETag，如果和服务端接受请求生成的ETage相同，返回缺失的实体部分；否则返回整个新的实体**\n\n\tIf-Range: \"737060cd8c284d8af7ad3082f209582d\"\n\n**If-Unmodified-Since 设置更新时间，只有从更新时间到服务端接受请求这段时间内实体没有改变，服务端才会发送响应**\n\n\tIf-Unmodified-Since: Sat, 29 Oct 1994 19:43:31 GMT\n\n**Max-Forwards 限制代理或网关转发消息的次数**\n\n\tMax-Forwards: 10\n\n**Origin 标识跨域资源请求（请求服务端设置Access-Control-Allow-Origin响应字段）**\n\n\tOrigin: http://www.example-social-network.com\n\n**Pragma 设置特殊实现字段，可能会对请求响应链有多种影响**\n\n\tPragma: no-cache\n\n**Proxy-Authorization 为连接代理授权认证信息**\n\n\tProxy-Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==\n\n**Range 请求部分实体，设置请求实体的字节数范围，具体可以参见HTTP/1.1中的Byte serving**\n\n\tRange: bytes=500-999\n\n**Referer 设置前一个页面的地址，并且前一个页面中的连接指向当前请求，意思就是如果当前请求是在A页面中发送的，那么referer就是A页面的url地址（轶 事：这个单词正确的拼法应该是\"referrer\",但是在很多规范中都拼成了\"referer\"，所以这个单词也就成为标准用法）**\n\n\tReferer: http://en.wikipedia.org/wiki/Main_Page\n\n**TE 设置用户代理期望接受的传输编码格式，和响应头中的Transfer-Encoding字段一样**\n\n\tTE: trailers, deflate\n\n**Upgrade 请求服务端升级协议**\n\n\tUpgrade: HTTP/2.0, HTTPS/1.3, IRC/6.9, RTA/x11, websocket\n\n**User-Agent 用户代理的字符串值**\n\n\tUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:12.0) Gecko/20100101 Firefox/21.0\n\n**Via 通知服务器代理请求**\n\n\tVia: 1.0 fred, 1.1 example.com (Apache/1.1)\n\n**Warning 实体可能会发生的问题的通用警告**\n\n\tWarning: 199 Miscellaneous warning\n\t\n### 常用非标准请求头字段\n\n**X-Requested-With 标识Ajax请求，大部分js框架发送请求时都会设置它为XMLHttpRequest**\n\n\tX-Requested-With: XMLHttpRequest\n\n**DNT 请求web应用禁用用户追踪**\n\n\tDNT: 1 (Do Not Track Enabled)\n\tDNT: 0 (Do Not Track Disabled)\n\n**X-Forwarded-For 一个事实标准，用来标识客户端通过HTTP代理或者负载均衡器连接的web服务器的原始IP地址**\n\n\tX-Forwarded-For: client1, proxy1, proxy2\n\tX-Forwarded-For: 129.78.138.66, 129.78.64.103\n\n**X-Forwarded-Host 一个事实标准，用来标识客户端在HTTP请求头中请求的原始host,因为主机名或者反向代理的端口可能与处理请求的原始服务器不同**\n\n\tX-Forwarded-Host: en.wikipedia.org:8080\n\tX-Forwarded-Host: en.wikipedia.org\n\n**X-Forwarded-Proto 一个事实标准，用来标识HTTP原始协议，因为反向代理或者负载均衡器和web服务器可能使用http,但是请求到反向代理使用的是https**\n\n\tX-Forwarded-Proto: https\n\n**Front-End-Https 微软应用程序和负载均衡器使用的非标准header字段 Front-End-Https: on**\n\n**X-Http-Method-Override 请求web应用时，使用header字段中给定的方法（通常是put或者delete）覆盖请求中指定的方法（通常是post）,如果用户代理或者防火墙不支持直接使用put或者delete方法发送请求时，可以使用这个字段**\n\n\tX-HTTP-Method-Override: DELETE\n\n**X-ATT-DeviceId 允许更简单的解析用户代理在AT&T设备上的MakeModel/Firmware**\n\n\tX-Att-Deviceid: GT-P7320/P7320XXLPG\n\n**X-Wap-Profile 设置描述当前连接设备的详细信息的xml文件在网络中的位置**\n\n\tx-wap-profile: http://wap.samsungmobile.com/uaprof/SGH-I777.xml\n\n**Proxy-Connection 早起HTTP版本中的一个误称，现在使用标准的connection字段**\n\n\tProxy-Connection: keep-alive\n\n**X-UIDH 服务端深度包检测插入的一个唯一ID标识Verizon Wireless的客户**\n\n\tX-UIDH: ...\n\n**X-Csrf-Token,X-CSRFToken,X-XSRF-TOKEN 防止跨站请求伪造**\n\n\tX-Csrf-Token: i8XNjC4b8KVok4uw5RftR38Wgp2BFwql\n\n**X-Request-ID,X-Correlation-ID 标识客户端和服务端的HTTP请求**\n\n\tX-Request-ID: f058ebd6-02f7-4d3f-942e-904344e8cde5\n\n### 常用标准响应头字段\n\n**Access-Control-Allow-Origin 指定哪些站点可以参与跨站资源共享**\n\n\tAccess-Control-Allow-Origin: *\n\n**Accept-Patch 指定服务器支持的补丁文档格式，适用于http的patch方法**\n\n\tAccept-Patch: text/example;charset=utf-8\n\n**Accept-Ranges 服务器通过byte serving支持的部分内容范围类型**\n\n\tAccept-Ranges: bytes\n\n**Age 对象在代理缓存中暂存的秒数**\n\n\tAge: 12\n\n**Allow 设置特定资源的有效行为，适用方法不被允许的http 405错误**\n\n\tAllow: GET, HEAD\n\n**Alt-Svc 服务器使用\"Alt-Svc\"（Alternative Servicesde的缩写）头标识资源可以通过不同的网络位置或者不同的网络协议获取**\n\n\tAlt-Svc: h2=\"http2.example.com:443\"; ma=7200\n\n**Cache-Control 告诉服务端到客户端所有的缓存机制是否可以缓存这个对象，单位是秒**\n\n\tCache-Control: max-age=3600\n\n**Connection 设置当前连接和hop-by-hop协议请求字段列表的控制选项**\n\n\tConnection: close\n\n**Content-Disposition 告诉客户端弹出一个文件下载框，并且可以指定下载文件名**\n\n\tContent-Disposition: attachment; filename=\"fname.ext\"\n\n**Content-Encoding 设置数据使用的编码类型**\n\n\tContent-Encoding: gzip\n\n**Content-Language 为封闭内容设置自然语言或者目标用户语言**\n\n\tContent-Language: en\n\n**Content-Length 响应体的字节长度**\n\n\tContent-Length: 348\n\n**Content-Location 设置返回数据的另一个位置**\n\n\tContent-Location: /index.htm\n\n**Content-MD5 设置基于MD5算法对响应体内容进行Base64二进制编码**\n\n\tContent-MD5: Q2hlY2sgSW50ZWdyaXR5IQ==\n\n**Content-Range 标识响应体内容属于完整消息体中的那一部分**\n\n\tContent-Range: bytes 21010-47021/47022\n\n**Content-Type 设置响应体的MIME类型**\n\n\tContent-Type: text/html; charset=utf-8\n\n**Date 设置消息发送的日期和时间**\n\n\tDate: Tue, 15 Nov 1994 08:12:31 GMT\n\n**ETag 特定版本资源的标识符，通常是消息摘要**\n\n\tETag: \"737060cd8c284d8af7ad3082f209582d\"\n\n**Expires 设置响应体的过期时间**\n\n\tExpires: Thu, 01 Dec 1994 16:00:00 GMT\n\n**Last-Modified 设置请求对象最后一次的修改日期**\n\n\tLast-Modified: Tue, 15 Nov 1994 12:45:26 GMT\n\n**Link 设置与其他资源的类型关系**\n\n\tLink: </feed>; rel=\"alternate\"\n\n**Location 在重定向中或者创建新资源时使用**\n\n\tLocation: http://www.w3.org/pub/WWW/People.html\n\n**P3P 以P3P:CP=\"your_compact_policy\"的格式设置支持P3P(Platform for Privacy Preferences Project)策略，大部分浏览器没有完全支持P3P策略，许多站点设置假的策略内容欺骗支持P3P策略的浏览器以获取第三方cookie的授权**\n\n\tP3P: CP=\"This is not a P3P policy! See http://www.google.com/support/accounts/bin/answer.py?hl=en&answer=151657 for more info.\"\n\n**Pragma 设置特殊实现字段，可能会对请求响应链有多种影响**\n\n\tPragma: no-cache\n\n**Proxy-Authenticate 设置访问代理的请求权限**\n\n\tProxy-Authenticate: Basic\n\n**Public-Key-Pins 设置站点的授权TLS证书**\n\n\tPublic-Key-Pins: max-age=2592000; pin-sha256=\"E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g=\";\n\n**Refresh \"重定向或者新资源创建时使用，在页面的头部有个扩展可以实现相似的功能，并且大部分浏览器都支持**\n`meta http-equiv=\"refresh\" content=\"5; url=http://example.com/` \n\n\tRefresh: 5; url=http://www.w3.org/pub/WWW/People.html\n\n**Retry-After 如果实体暂时不可用，可以设置这个值让客户端重试，可以使用时间段（单位是秒）或者HTTP时间**\n\n\tExample 1: Retry-After: 120\n\tExample 2: Retry-After: Fri, 07 Nov 2014 23:59:59 GMT\n\n**Server 服务器WEB名称**\n\n\tServer: Apache/2.4.1 (Unix)\n\n**Set-Cookie 设置HTTP Cookie**\n\n\tSet-Cookie: UserID=JohnDoe; Max-Age=3600; Version=1\n\n**Status 设置HTTP响应状态**\n\n\tStatus: 200 OK\n\n**Strict-Transport-Security 一种HSTS策略通知HTTP客户端缓存HTTPS策略多长时间以及是否应用到子域**\n\n\tStrict-Transport-Security: max-age=16070400; includeSubDomains\n\n**Trailer 标识给定的header字段将展示在后续的chunked编码的消息中**\n\n\tTrailer: Max-Forwards\n\n**Transfer-Encoding 设置传输实体的编码格式，目前支持的格式： chunked, compress, deflate, gzip, identity**\n\n\tTransfer-Encoding: chunked\n\n**TSV Tracking Status Value，在响应中设置给DNT(do-not-track),可能的取值**\n\n\t\"!\" — under construction\n\t\"?\" — dynamic\n\t\"G\" — gateway to multiple parties\n\t\"N\" — not tracking\n\t\"T\" — tracking\n\t\"C\" — tracking with consent\n\t\"P\" — tracking only if consented\n\t\"D\" — disregarding DNT\n\t\"U\" — updated\n\t\n\tTSV: ?\n\n**Upgrade 请求客户端升级协议**\n\n\tUpgrade: HTTP/2.0, HTTPS/1.3, IRC/6.9, RTA/x11, websocket\n\n**Vary 通知下级代理如何匹配未来的请求头已让其决定缓存的响应是否可用而不是重新从源主机请求新的**\n\n\tExample 1: Vary: *\n\tExample 2: Vary: Accept-Language\n\n**Via 通知客户端代理，通过其要发送什么响应**\n\n\tVia: cache46.l2cn1341[84,206-0,H], cache38.l2c0c801[91,0], kunlun6.cn536[172,304-0,H], kunlun7.cn196[174,0]\n\n**x-cache 是否命中缓存，HIT和MISS**\n\t\n\tx-cache: HIT TCP_IMS_HIT dirn:-2:-2\n\t\n**Warning 实体可能会发生的问题的通用警告**\n\n\tWarning: 199 Miscellaneous warning\n\n**WWW-Authenticate 标识访问请求实体的身份验证方案**\n\n\tWWW-Authenticate: Basic\n\n**X-Frame-Options 点击劫持保护：**\n\n\tdeny frame中不渲染\n\tsameorigin 如果源不匹配不渲染\n\tallow-from 允许指定位置访问\n\tallowall 不标准，允许任意位置访问\n\n\tX-Frame-Options: deny\n\n### 常用非标准响应头字段\n**X-XSS-Protection 过滤跨站脚本**\n\n\tX-XSS-Protection: 1; mode=block\n\n**Content-Security-Policy, X-Content-Security-Policy,X-WebKit-CSP 定义内容安全策略**\n\n\tX-WebKit-CSP: default-src 'self'\n\n**X-Content-Type-Options 唯一的取值是\"\",阻止IE在响应中嗅探定义的内容格式以外的其他MIME格式**\n\n\tX-Content-Type-Options: nosniff\n\n**X-Powered-By 指定支持web应用的技术**\n\n\tX-Powered-By: PHP/5.4.0\n\n**X-UA-Compatible 推荐首选的渲染引擎来展示内容，通常向后兼容，也用于激活IE中内嵌chrome框架插件**\n`<meta http-equiv=\"X-UA-Compatible\" content=\"chrome=1\" />` \n\n\tX-UA-Compatible: IE=EmulateIE7\n\tX-UA-Compatible: IE=edge\n\tX-UA-Compatible: Chrome=1\n\n**X-Content-Duration 提供音视频的持续时间，单位是秒，只有Gecko内核浏览器支持**\n\n\tX-Content-Duration: 42.666\n\n**Upgrade-Insecure-Requests 标识服务器是否可以处理HTTPS协议**\n\n\tUpgrade-Insecure-Requests: 1\n\n**X-Request-ID,X-Correlation-ID 标识一个客户端和服务端的请求**\n\n\tX-Request-ID: f058ebd6-02f7-4d3f-942e-904344e8cde5\n\t\n**以下是一次客户端请求某网页的过程**\n\n![](/images/pic/http-cache.png)\n如图通过二次请求对网页状态说明\n>1. 客户端通过浏览器打开某网页，判断本地缓存是否过期。\n>\n>2. 没过期直接从缓存读取并且返回结果。\n>\n>3. 如果过期，服务器算出一个哈希值并通过 ETag 返回给浏览器，浏览器把哈希值和页面同时缓存在本地，当下次再次向服务器请求时，会通过类似 If-None-Match: \"etag值\" 的请求头把ETag发送给服务器，服务器再次计算页面的哈希值并和浏览器返回的值做比较，如果发现发生了变化就把页面返回给浏览器(200)，如果发现没有变化就给浏览器返回一个304未修改。这样通过控制浏览器端的缓存，可以节省服务器的带宽，因为服务器不需要每次都把全量数据返回给客户端。\n当未携带Etag时，客户端访问页面，服务器会将页面最后修改时间通过 Last-Modified 标识由服务器发往客户端，客户端记录修改时间，再次请求本地存在的cache页面时，客户端会通过 If-Modified-Since 头将先前服务器端发过来的Last-Modified时间戳发送回去，服务器端通过这个时间戳判断客户端的页面是否是最新的，如果不是最新的，则返回新的内容，如果是最新的，则 返回 304 告诉客户端其本地 cache 的页面是最新的。\n","slug":"http-header","published":1,"updated":"2019-05-28T02:02:23.504Z","_id":"cjw6jlf0k0028p4n7auqz2ccw","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>HTTP消息头是指，在超文本传输协议（ Hypertext Transfer Protocol ，HTTP）的请求和响应消息中，协议头部分的那些组件。HTTP消息头用来准确描述正在获取的资源、服务器或者客户端的行为，定义了HTTP事务中的具体操作参数。</p>\n<h3 id=\"关于HTTP消息头\"><a href=\"#关于HTTP消息头\" class=\"headerlink\" title=\"关于HTTP消息头\"></a>关于HTTP消息头</h3><p>HTTP消息头是在<code>客户端请求（Request）</code> 或<code>服务器响应（Response）</code> 时传递的，为请求或响应的第一行，HTTP消息体（请求或响应的内容）是其后传输。HTTP消息头，以明文的字符串格式传送，是以冒号分隔的键/值对，如：Accept-Charset: utf-8，每一个消息头最后以回车符(CR)和换行符(LF)结尾。HTTP消息头结束后，会用一个空白的字段来标识，这样就会出现两个连续的CR-LF。<br>HTTP消息头支持自定义， 自定义的专用消息头一般会添加’X-‘前缀。</p>\n<h3 id=\"常用标准请求头字段\"><a href=\"#常用标准请求头字段\" class=\"headerlink\" title=\"常用标准请求头字段\"></a>常用标准请求头字段</h3><p><strong>Accept 设置接受的内容类型</strong></p>\n<pre><code>Accept: text/plain\n</code></pre><p><strong>Accept-Charset 设置接受的字符编码</strong></p>\n<pre><code>Accept-Charset: utf-8\n</code></pre><p><strong>Accept-Encoding 设置接受的编码格式</strong></p>\n<pre><code>Accept-Encoding: gzip, deflate\n</code></pre><p><strong>Accept-Datetime 设置接受的版本时间</strong></p>\n<pre><code>Accept-Datetime: Thu, 31 May 2007 20:35:00 GMT\n</code></pre><p><strong>Accept-Language 设置接受的语言</strong></p>\n<pre><code>Accept-Language: en-US\n</code></pre><p><strong>Authorization 设置HTTP身份验证的凭证</strong></p>\n<pre><code>Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==\n</code></pre><p><strong>Cache-Control 设置请求响应链上所有的缓存机制必须遵守的指令</strong></p>\n<pre><code>Cache-Control: no-cache\n</code></pre><p><strong>Connection 设置当前连接和hop-by-hop协议请求字段列表的控制选项</strong></p>\n<pre><code>Connection: keep-alive\nConnection: Upgrade\n</code></pre><p><strong>Content-Length 设置请求体的字节长度</strong></p>\n<pre><code>Content-Length: 348\n</code></pre><p><strong>Content-MD5 设置基于MD5算法对请求体内容进行Base64二进制编码</strong></p>\n<pre><code>Content-MD5: Q2hlY2sgSW50ZWdyaXR5IQ==\n</code></pre><p><strong>Content-Type 设置请求体的MIME类型（适用POST和PUT请求）</strong></p>\n<pre><code>Content-Type: application/x-www-form-urlencoded\n</code></pre><p><strong>Cookie 设置服务器使用Set-Cookie发送的http cookie</strong></p>\n<pre><code>Cookie: $Version=1; Skin=new;\n</code></pre><p><strong>Date 设置消息发送的日期和时间</strong></p>\n<pre><code>Date: Tue, 15 Nov 1994 08:12:31 GMT\n</code></pre><p><strong>Expect 标识客户端需要的特殊浏览器行为</strong></p>\n<pre><code>Expect: 100-continue\n</code></pre><p><strong>Forwarded 披露客户端通过http代理连接web服务的源信息</strong></p>\n<pre><code>Forwarded: for=192.0.2.60;proto=http;by=203.0.113.43\nForwarded: for=192.0.2.43, for=198.51.100.17\n</code></pre><p><strong>From 设置发送请求的用户的email地址</strong></p>\n<pre><code>From: user@example.com\n</code></pre><p><strong>Host 设置服务器域名和TCP端口号，如果使用的是服务请求标准端口号，端口号可以省略</strong></p>\n<pre><code>Host: en.wikipedia.org:8080\nHost: en.wikipedia.org\n</code></pre><p><strong>If-Match 设置客户端的ETag,当时客户端ETag和服务器生成的ETag一致才执行，适用于更新自从上次更新之后没有改变的资源</strong></p>\n<pre><code>If-Match: &quot;737060cd8c284d8af7ad3082f209582d\n</code></pre><p><strong>If-Modified-Since 设置更新时间，从更新时间到服务端接受请求这段时间内如果资源没有改变，允许服务端返回304 Not Modified</strong></p>\n<pre><code>If-Modified-Since: Sat, 29 Oct 1994 19:43:31 GMT\n</code></pre><p><strong>If-None-Match 设置客户端ETag，如果和服务端接受请求生成的ETage相同，允许服务端返回304 Not Modified</strong></p>\n<pre><code>If-None-Match: &quot;737060cd8c284d8af7ad3082f209582d&quot;\n</code></pre><p><strong>If-Range 设置客户端ETag，如果和服务端接受请求生成的ETage相同，返回缺失的实体部分；否则返回整个新的实体</strong></p>\n<pre><code>If-Range: &quot;737060cd8c284d8af7ad3082f209582d&quot;\n</code></pre><p><strong>If-Unmodified-Since 设置更新时间，只有从更新时间到服务端接受请求这段时间内实体没有改变，服务端才会发送响应</strong></p>\n<pre><code>If-Unmodified-Since: Sat, 29 Oct 1994 19:43:31 GMT\n</code></pre><p><strong>Max-Forwards 限制代理或网关转发消息的次数</strong></p>\n<pre><code>Max-Forwards: 10\n</code></pre><p><strong>Origin 标识跨域资源请求（请求服务端设置Access-Control-Allow-Origin响应字段）</strong></p>\n<pre><code>Origin: http://www.example-social-network.com\n</code></pre><p><strong>Pragma 设置特殊实现字段，可能会对请求响应链有多种影响</strong></p>\n<pre><code>Pragma: no-cache\n</code></pre><p><strong>Proxy-Authorization 为连接代理授权认证信息</strong></p>\n<pre><code>Proxy-Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==\n</code></pre><p><strong>Range 请求部分实体，设置请求实体的字节数范围，具体可以参见HTTP/1.1中的Byte serving</strong></p>\n<pre><code>Range: bytes=500-999\n</code></pre><p><strong>Referer 设置前一个页面的地址，并且前一个页面中的连接指向当前请求，意思就是如果当前请求是在A页面中发送的，那么referer就是A页面的url地址（轶 事：这个单词正确的拼法应该是”referrer”,但是在很多规范中都拼成了”referer”，所以这个单词也就成为标准用法）</strong></p>\n<pre><code>Referer: http://en.wikipedia.org/wiki/Main_Page\n</code></pre><p><strong>TE 设置用户代理期望接受的传输编码格式，和响应头中的Transfer-Encoding字段一样</strong></p>\n<pre><code>TE: trailers, deflate\n</code></pre><p><strong>Upgrade 请求服务端升级协议</strong></p>\n<pre><code>Upgrade: HTTP/2.0, HTTPS/1.3, IRC/6.9, RTA/x11, websocket\n</code></pre><p><strong>User-Agent 用户代理的字符串值</strong></p>\n<pre><code>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:12.0) Gecko/20100101 Firefox/21.0\n</code></pre><p><strong>Via 通知服务器代理请求</strong></p>\n<pre><code>Via: 1.0 fred, 1.1 example.com (Apache/1.1)\n</code></pre><p><strong>Warning 实体可能会发生的问题的通用警告</strong></p>\n<pre><code>Warning: 199 Miscellaneous warning\n</code></pre><h3 id=\"常用非标准请求头字段\"><a href=\"#常用非标准请求头字段\" class=\"headerlink\" title=\"常用非标准请求头字段\"></a>常用非标准请求头字段</h3><p><strong>X-Requested-With 标识Ajax请求，大部分js框架发送请求时都会设置它为XMLHttpRequest</strong></p>\n<pre><code>X-Requested-With: XMLHttpRequest\n</code></pre><p><strong>DNT 请求web应用禁用用户追踪</strong></p>\n<pre><code>DNT: 1 (Do Not Track Enabled)\nDNT: 0 (Do Not Track Disabled)\n</code></pre><p><strong>X-Forwarded-For 一个事实标准，用来标识客户端通过HTTP代理或者负载均衡器连接的web服务器的原始IP地址</strong></p>\n<pre><code>X-Forwarded-For: client1, proxy1, proxy2\nX-Forwarded-For: 129.78.138.66, 129.78.64.103\n</code></pre><p><strong>X-Forwarded-Host 一个事实标准，用来标识客户端在HTTP请求头中请求的原始host,因为主机名或者反向代理的端口可能与处理请求的原始服务器不同</strong></p>\n<pre><code>X-Forwarded-Host: en.wikipedia.org:8080\nX-Forwarded-Host: en.wikipedia.org\n</code></pre><p><strong>X-Forwarded-Proto 一个事实标准，用来标识HTTP原始协议，因为反向代理或者负载均衡器和web服务器可能使用http,但是请求到反向代理使用的是https</strong></p>\n<pre><code>X-Forwarded-Proto: https\n</code></pre><p><strong>Front-End-Https 微软应用程序和负载均衡器使用的非标准header字段 Front-End-Https: on</strong></p>\n<p><strong>X-Http-Method-Override 请求web应用时，使用header字段中给定的方法（通常是put或者delete）覆盖请求中指定的方法（通常是post）,如果用户代理或者防火墙不支持直接使用put或者delete方法发送请求时，可以使用这个字段</strong></p>\n<pre><code>X-HTTP-Method-Override: DELETE\n</code></pre><p><strong>X-ATT-DeviceId 允许更简单的解析用户代理在AT&amp;T设备上的MakeModel/Firmware</strong></p>\n<pre><code>X-Att-Deviceid: GT-P7320/P7320XXLPG\n</code></pre><p><strong>X-Wap-Profile 设置描述当前连接设备的详细信息的xml文件在网络中的位置</strong></p>\n<pre><code>x-wap-profile: http://wap.samsungmobile.com/uaprof/SGH-I777.xml\n</code></pre><p><strong>Proxy-Connection 早起HTTP版本中的一个误称，现在使用标准的connection字段</strong></p>\n<pre><code>Proxy-Connection: keep-alive\n</code></pre><p><strong>X-UIDH 服务端深度包检测插入的一个唯一ID标识Verizon Wireless的客户</strong></p>\n<pre><code>X-UIDH: ...\n</code></pre><p><strong>X-Csrf-Token,X-CSRFToken,X-XSRF-TOKEN 防止跨站请求伪造</strong></p>\n<pre><code>X-Csrf-Token: i8XNjC4b8KVok4uw5RftR38Wgp2BFwql\n</code></pre><p><strong>X-Request-ID,X-Correlation-ID 标识客户端和服务端的HTTP请求</strong></p>\n<pre><code>X-Request-ID: f058ebd6-02f7-4d3f-942e-904344e8cde5\n</code></pre><h3 id=\"常用标准响应头字段\"><a href=\"#常用标准响应头字段\" class=\"headerlink\" title=\"常用标准响应头字段\"></a>常用标准响应头字段</h3><p><strong>Access-Control-Allow-Origin 指定哪些站点可以参与跨站资源共享</strong></p>\n<pre><code>Access-Control-Allow-Origin: *\n</code></pre><p><strong>Accept-Patch 指定服务器支持的补丁文档格式，适用于http的patch方法</strong></p>\n<pre><code>Accept-Patch: text/example;charset=utf-8\n</code></pre><p><strong>Accept-Ranges 服务器通过byte serving支持的部分内容范围类型</strong></p>\n<pre><code>Accept-Ranges: bytes\n</code></pre><p><strong>Age 对象在代理缓存中暂存的秒数</strong></p>\n<pre><code>Age: 12\n</code></pre><p><strong>Allow 设置特定资源的有效行为，适用方法不被允许的http 405错误</strong></p>\n<pre><code>Allow: GET, HEAD\n</code></pre><p><strong>Alt-Svc 服务器使用”Alt-Svc”（Alternative Servicesde的缩写）头标识资源可以通过不同的网络位置或者不同的网络协议获取</strong></p>\n<pre><code>Alt-Svc: h2=&quot;http2.example.com:443&quot;; ma=7200\n</code></pre><p><strong>Cache-Control 告诉服务端到客户端所有的缓存机制是否可以缓存这个对象，单位是秒</strong></p>\n<pre><code>Cache-Control: max-age=3600\n</code></pre><p><strong>Connection 设置当前连接和hop-by-hop协议请求字段列表的控制选项</strong></p>\n<pre><code>Connection: close\n</code></pre><p><strong>Content-Disposition 告诉客户端弹出一个文件下载框，并且可以指定下载文件名</strong></p>\n<pre><code>Content-Disposition: attachment; filename=&quot;fname.ext&quot;\n</code></pre><p><strong>Content-Encoding 设置数据使用的编码类型</strong></p>\n<pre><code>Content-Encoding: gzip\n</code></pre><p><strong>Content-Language 为封闭内容设置自然语言或者目标用户语言</strong></p>\n<pre><code>Content-Language: en\n</code></pre><p><strong>Content-Length 响应体的字节长度</strong></p>\n<pre><code>Content-Length: 348\n</code></pre><p><strong>Content-Location 设置返回数据的另一个位置</strong></p>\n<pre><code>Content-Location: /index.htm\n</code></pre><p><strong>Content-MD5 设置基于MD5算法对响应体内容进行Base64二进制编码</strong></p>\n<pre><code>Content-MD5: Q2hlY2sgSW50ZWdyaXR5IQ==\n</code></pre><p><strong>Content-Range 标识响应体内容属于完整消息体中的那一部分</strong></p>\n<pre><code>Content-Range: bytes 21010-47021/47022\n</code></pre><p><strong>Content-Type 设置响应体的MIME类型</strong></p>\n<pre><code>Content-Type: text/html; charset=utf-8\n</code></pre><p><strong>Date 设置消息发送的日期和时间</strong></p>\n<pre><code>Date: Tue, 15 Nov 1994 08:12:31 GMT\n</code></pre><p><strong>ETag 特定版本资源的标识符，通常是消息摘要</strong></p>\n<pre><code>ETag: &quot;737060cd8c284d8af7ad3082f209582d&quot;\n</code></pre><p><strong>Expires 设置响应体的过期时间</strong></p>\n<pre><code>Expires: Thu, 01 Dec 1994 16:00:00 GMT\n</code></pre><p><strong>Last-Modified 设置请求对象最后一次的修改日期</strong></p>\n<pre><code>Last-Modified: Tue, 15 Nov 1994 12:45:26 GMT\n</code></pre><p><strong>Link 设置与其他资源的类型关系</strong></p>\n<pre><code>Link: &lt;/feed&gt;; rel=&quot;alternate&quot;\n</code></pre><p><strong>Location 在重定向中或者创建新资源时使用</strong></p>\n<pre><code>Location: http://www.w3.org/pub/WWW/People.html\n</code></pre><p><strong>P3P 以P3P:CP=”your_compact_policy”的格式设置支持P3P(Platform for Privacy Preferences Project)策略，大部分浏览器没有完全支持P3P策略，许多站点设置假的策略内容欺骗支持P3P策略的浏览器以获取第三方cookie的授权</strong></p>\n<pre><code>P3P: CP=&quot;This is not a P3P policy! See http://www.google.com/support/accounts/bin/answer.py?hl=en&amp;answer=151657 for more info.&quot;\n</code></pre><p><strong>Pragma 设置特殊实现字段，可能会对请求响应链有多种影响</strong></p>\n<pre><code>Pragma: no-cache\n</code></pre><p><strong>Proxy-Authenticate 设置访问代理的请求权限</strong></p>\n<pre><code>Proxy-Authenticate: Basic\n</code></pre><p><strong>Public-Key-Pins 设置站点的授权TLS证书</strong></p>\n<pre><code>Public-Key-Pins: max-age=2592000; pin-sha256=&quot;E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g=&quot;;\n</code></pre><p><strong>Refresh “重定向或者新资源创建时使用，在页面的头部有个扩展可以实现相似的功能，并且大部分浏览器都支持</strong><br><code>meta http-equiv=&quot;refresh&quot; content=&quot;5; url=http://example.com/</code> </p>\n<pre><code>Refresh: 5; url=http://www.w3.org/pub/WWW/People.html\n</code></pre><p><strong>Retry-After 如果实体暂时不可用，可以设置这个值让客户端重试，可以使用时间段（单位是秒）或者HTTP时间</strong></p>\n<pre><code>Example 1: Retry-After: 120\nExample 2: Retry-After: Fri, 07 Nov 2014 23:59:59 GMT\n</code></pre><p><strong>Server 服务器WEB名称</strong></p>\n<pre><code>Server: Apache/2.4.1 (Unix)\n</code></pre><p><strong>Set-Cookie 设置HTTP Cookie</strong></p>\n<pre><code>Set-Cookie: UserID=JohnDoe; Max-Age=3600; Version=1\n</code></pre><p><strong>Status 设置HTTP响应状态</strong></p>\n<pre><code>Status: 200 OK\n</code></pre><p><strong>Strict-Transport-Security 一种HSTS策略通知HTTP客户端缓存HTTPS策略多长时间以及是否应用到子域</strong></p>\n<pre><code>Strict-Transport-Security: max-age=16070400; includeSubDomains\n</code></pre><p><strong>Trailer 标识给定的header字段将展示在后续的chunked编码的消息中</strong></p>\n<pre><code>Trailer: Max-Forwards\n</code></pre><p><strong>Transfer-Encoding 设置传输实体的编码格式，目前支持的格式： chunked, compress, deflate, gzip, identity</strong></p>\n<pre><code>Transfer-Encoding: chunked\n</code></pre><p><strong>TSV Tracking Status Value，在响应中设置给DNT(do-not-track),可能的取值</strong></p>\n<pre><code>&quot;!&quot; — under construction\n&quot;?&quot; — dynamic\n&quot;G&quot; — gateway to multiple parties\n&quot;N&quot; — not tracking\n&quot;T&quot; — tracking\n&quot;C&quot; — tracking with consent\n&quot;P&quot; — tracking only if consented\n&quot;D&quot; — disregarding DNT\n&quot;U&quot; — updated\n\nTSV: ?\n</code></pre><p><strong>Upgrade 请求客户端升级协议</strong></p>\n<pre><code>Upgrade: HTTP/2.0, HTTPS/1.3, IRC/6.9, RTA/x11, websocket\n</code></pre><p><strong>Vary 通知下级代理如何匹配未来的请求头已让其决定缓存的响应是否可用而不是重新从源主机请求新的</strong></p>\n<pre><code>Example 1: Vary: *\nExample 2: Vary: Accept-Language\n</code></pre><p><strong>Via 通知客户端代理，通过其要发送什么响应</strong></p>\n<pre><code>Via: cache46.l2cn1341[84,206-0,H], cache38.l2c0c801[91,0], kunlun6.cn536[172,304-0,H], kunlun7.cn196[174,0]\n</code></pre><p><strong>x-cache 是否命中缓存，HIT和MISS</strong></p>\n<pre><code>x-cache: HIT TCP_IMS_HIT dirn:-2:-2\n</code></pre><p><strong>Warning 实体可能会发生的问题的通用警告</strong></p>\n<pre><code>Warning: 199 Miscellaneous warning\n</code></pre><p><strong>WWW-Authenticate 标识访问请求实体的身份验证方案</strong></p>\n<pre><code>WWW-Authenticate: Basic\n</code></pre><p><strong>X-Frame-Options 点击劫持保护：</strong></p>\n<pre><code>deny frame中不渲染\nsameorigin 如果源不匹配不渲染\nallow-from 允许指定位置访问\nallowall 不标准，允许任意位置访问\n\nX-Frame-Options: deny\n</code></pre><h3 id=\"常用非标准响应头字段\"><a href=\"#常用非标准响应头字段\" class=\"headerlink\" title=\"常用非标准响应头字段\"></a>常用非标准响应头字段</h3><p><strong>X-XSS-Protection 过滤跨站脚本</strong></p>\n<pre><code>X-XSS-Protection: 1; mode=block\n</code></pre><p><strong>Content-Security-Policy, X-Content-Security-Policy,X-WebKit-CSP 定义内容安全策略</strong></p>\n<pre><code>X-WebKit-CSP: default-src &apos;self&apos;\n</code></pre><p><strong>X-Content-Type-Options 唯一的取值是””,阻止IE在响应中嗅探定义的内容格式以外的其他MIME格式</strong></p>\n<pre><code>X-Content-Type-Options: nosniff\n</code></pre><p><strong>X-Powered-By 指定支持web应用的技术</strong></p>\n<pre><code>X-Powered-By: PHP/5.4.0\n</code></pre><p><strong>X-UA-Compatible 推荐首选的渲染引擎来展示内容，通常向后兼容，也用于激活IE中内嵌chrome框架插件</strong><br><code>&lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;chrome=1&quot; /&gt;</code> </p>\n<pre><code>X-UA-Compatible: IE=EmulateIE7\nX-UA-Compatible: IE=edge\nX-UA-Compatible: Chrome=1\n</code></pre><p><strong>X-Content-Duration 提供音视频的持续时间，单位是秒，只有Gecko内核浏览器支持</strong></p>\n<pre><code>X-Content-Duration: 42.666\n</code></pre><p><strong>Upgrade-Insecure-Requests 标识服务器是否可以处理HTTPS协议</strong></p>\n<pre><code>Upgrade-Insecure-Requests: 1\n</code></pre><p><strong>X-Request-ID,X-Correlation-ID 标识一个客户端和服务端的请求</strong></p>\n<pre><code>X-Request-ID: f058ebd6-02f7-4d3f-942e-904344e8cde5\n</code></pre><p><strong>以下是一次客户端请求某网页的过程</strong></p>\n<p><img src=\"/images/pic/http-cache.png\" alt><br>如图通过二次请求对网页状态说明</p>\n<blockquote>\n<ol>\n<li><p>客户端通过浏览器打开某网页，判断本地缓存是否过期。</p>\n</li>\n<li><p>没过期直接从缓存读取并且返回结果。</p>\n</li>\n<li><p>如果过期，服务器算出一个哈希值并通过 ETag 返回给浏览器，浏览器把哈希值和页面同时缓存在本地，当下次再次向服务器请求时，会通过类似 If-None-Match: “etag值” 的请求头把ETag发送给服务器，服务器再次计算页面的哈希值并和浏览器返回的值做比较，如果发现发生了变化就把页面返回给浏览器(200)，如果发现没有变化就给浏览器返回一个304未修改。这样通过控制浏览器端的缓存，可以节省服务器的带宽，因为服务器不需要每次都把全量数据返回给客户端。<br>当未携带Etag时，客户端访问页面，服务器会将页面最后修改时间通过 Last-Modified 标识由服务器发往客户端，客户端记录修改时间，再次请求本地存在的cache页面时，客户端会通过 If-Modified-Since 头将先前服务器端发过来的Last-Modified时间戳发送回去，服务器端通过这个时间戳判断客户端的页面是否是最新的，如果不是最新的，则返回新的内容，如果是最新的，则 返回 304 告诉客户端其本地 cache 的页面是最新的。</p>\n</li>\n</ol>\n</blockquote>\n","site":{"data":{}},"length":9531,"excerpt":"","more":"<p>HTTP消息头是指，在超文本传输协议（ Hypertext Transfer Protocol ，HTTP）的请求和响应消息中，协议头部分的那些组件。HTTP消息头用来准确描述正在获取的资源、服务器或者客户端的行为，定义了HTTP事务中的具体操作参数。</p>\n<h3 id=\"关于HTTP消息头\"><a href=\"#关于HTTP消息头\" class=\"headerlink\" title=\"关于HTTP消息头\"></a>关于HTTP消息头</h3><p>HTTP消息头是在<code>客户端请求（Request）</code> 或<code>服务器响应（Response）</code> 时传递的，为请求或响应的第一行，HTTP消息体（请求或响应的内容）是其后传输。HTTP消息头，以明文的字符串格式传送，是以冒号分隔的键/值对，如：Accept-Charset: utf-8，每一个消息头最后以回车符(CR)和换行符(LF)结尾。HTTP消息头结束后，会用一个空白的字段来标识，这样就会出现两个连续的CR-LF。<br>HTTP消息头支持自定义， 自定义的专用消息头一般会添加’X-‘前缀。</p>\n<h3 id=\"常用标准请求头字段\"><a href=\"#常用标准请求头字段\" class=\"headerlink\" title=\"常用标准请求头字段\"></a>常用标准请求头字段</h3><p><strong>Accept 设置接受的内容类型</strong></p>\n<pre><code>Accept: text/plain\n</code></pre><p><strong>Accept-Charset 设置接受的字符编码</strong></p>\n<pre><code>Accept-Charset: utf-8\n</code></pre><p><strong>Accept-Encoding 设置接受的编码格式</strong></p>\n<pre><code>Accept-Encoding: gzip, deflate\n</code></pre><p><strong>Accept-Datetime 设置接受的版本时间</strong></p>\n<pre><code>Accept-Datetime: Thu, 31 May 2007 20:35:00 GMT\n</code></pre><p><strong>Accept-Language 设置接受的语言</strong></p>\n<pre><code>Accept-Language: en-US\n</code></pre><p><strong>Authorization 设置HTTP身份验证的凭证</strong></p>\n<pre><code>Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==\n</code></pre><p><strong>Cache-Control 设置请求响应链上所有的缓存机制必须遵守的指令</strong></p>\n<pre><code>Cache-Control: no-cache\n</code></pre><p><strong>Connection 设置当前连接和hop-by-hop协议请求字段列表的控制选项</strong></p>\n<pre><code>Connection: keep-alive\nConnection: Upgrade\n</code></pre><p><strong>Content-Length 设置请求体的字节长度</strong></p>\n<pre><code>Content-Length: 348\n</code></pre><p><strong>Content-MD5 设置基于MD5算法对请求体内容进行Base64二进制编码</strong></p>\n<pre><code>Content-MD5: Q2hlY2sgSW50ZWdyaXR5IQ==\n</code></pre><p><strong>Content-Type 设置请求体的MIME类型（适用POST和PUT请求）</strong></p>\n<pre><code>Content-Type: application/x-www-form-urlencoded\n</code></pre><p><strong>Cookie 设置服务器使用Set-Cookie发送的http cookie</strong></p>\n<pre><code>Cookie: $Version=1; Skin=new;\n</code></pre><p><strong>Date 设置消息发送的日期和时间</strong></p>\n<pre><code>Date: Tue, 15 Nov 1994 08:12:31 GMT\n</code></pre><p><strong>Expect 标识客户端需要的特殊浏览器行为</strong></p>\n<pre><code>Expect: 100-continue\n</code></pre><p><strong>Forwarded 披露客户端通过http代理连接web服务的源信息</strong></p>\n<pre><code>Forwarded: for=192.0.2.60;proto=http;by=203.0.113.43\nForwarded: for=192.0.2.43, for=198.51.100.17\n</code></pre><p><strong>From 设置发送请求的用户的email地址</strong></p>\n<pre><code>From: user@example.com\n</code></pre><p><strong>Host 设置服务器域名和TCP端口号，如果使用的是服务请求标准端口号，端口号可以省略</strong></p>\n<pre><code>Host: en.wikipedia.org:8080\nHost: en.wikipedia.org\n</code></pre><p><strong>If-Match 设置客户端的ETag,当时客户端ETag和服务器生成的ETag一致才执行，适用于更新自从上次更新之后没有改变的资源</strong></p>\n<pre><code>If-Match: &quot;737060cd8c284d8af7ad3082f209582d\n</code></pre><p><strong>If-Modified-Since 设置更新时间，从更新时间到服务端接受请求这段时间内如果资源没有改变，允许服务端返回304 Not Modified</strong></p>\n<pre><code>If-Modified-Since: Sat, 29 Oct 1994 19:43:31 GMT\n</code></pre><p><strong>If-None-Match 设置客户端ETag，如果和服务端接受请求生成的ETage相同，允许服务端返回304 Not Modified</strong></p>\n<pre><code>If-None-Match: &quot;737060cd8c284d8af7ad3082f209582d&quot;\n</code></pre><p><strong>If-Range 设置客户端ETag，如果和服务端接受请求生成的ETage相同，返回缺失的实体部分；否则返回整个新的实体</strong></p>\n<pre><code>If-Range: &quot;737060cd8c284d8af7ad3082f209582d&quot;\n</code></pre><p><strong>If-Unmodified-Since 设置更新时间，只有从更新时间到服务端接受请求这段时间内实体没有改变，服务端才会发送响应</strong></p>\n<pre><code>If-Unmodified-Since: Sat, 29 Oct 1994 19:43:31 GMT\n</code></pre><p><strong>Max-Forwards 限制代理或网关转发消息的次数</strong></p>\n<pre><code>Max-Forwards: 10\n</code></pre><p><strong>Origin 标识跨域资源请求（请求服务端设置Access-Control-Allow-Origin响应字段）</strong></p>\n<pre><code>Origin: http://www.example-social-network.com\n</code></pre><p><strong>Pragma 设置特殊实现字段，可能会对请求响应链有多种影响</strong></p>\n<pre><code>Pragma: no-cache\n</code></pre><p><strong>Proxy-Authorization 为连接代理授权认证信息</strong></p>\n<pre><code>Proxy-Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==\n</code></pre><p><strong>Range 请求部分实体，设置请求实体的字节数范围，具体可以参见HTTP/1.1中的Byte serving</strong></p>\n<pre><code>Range: bytes=500-999\n</code></pre><p><strong>Referer 设置前一个页面的地址，并且前一个页面中的连接指向当前请求，意思就是如果当前请求是在A页面中发送的，那么referer就是A页面的url地址（轶 事：这个单词正确的拼法应该是”referrer”,但是在很多规范中都拼成了”referer”，所以这个单词也就成为标准用法）</strong></p>\n<pre><code>Referer: http://en.wikipedia.org/wiki/Main_Page\n</code></pre><p><strong>TE 设置用户代理期望接受的传输编码格式，和响应头中的Transfer-Encoding字段一样</strong></p>\n<pre><code>TE: trailers, deflate\n</code></pre><p><strong>Upgrade 请求服务端升级协议</strong></p>\n<pre><code>Upgrade: HTTP/2.0, HTTPS/1.3, IRC/6.9, RTA/x11, websocket\n</code></pre><p><strong>User-Agent 用户代理的字符串值</strong></p>\n<pre><code>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:12.0) Gecko/20100101 Firefox/21.0\n</code></pre><p><strong>Via 通知服务器代理请求</strong></p>\n<pre><code>Via: 1.0 fred, 1.1 example.com (Apache/1.1)\n</code></pre><p><strong>Warning 实体可能会发生的问题的通用警告</strong></p>\n<pre><code>Warning: 199 Miscellaneous warning\n</code></pre><h3 id=\"常用非标准请求头字段\"><a href=\"#常用非标准请求头字段\" class=\"headerlink\" title=\"常用非标准请求头字段\"></a>常用非标准请求头字段</h3><p><strong>X-Requested-With 标识Ajax请求，大部分js框架发送请求时都会设置它为XMLHttpRequest</strong></p>\n<pre><code>X-Requested-With: XMLHttpRequest\n</code></pre><p><strong>DNT 请求web应用禁用用户追踪</strong></p>\n<pre><code>DNT: 1 (Do Not Track Enabled)\nDNT: 0 (Do Not Track Disabled)\n</code></pre><p><strong>X-Forwarded-For 一个事实标准，用来标识客户端通过HTTP代理或者负载均衡器连接的web服务器的原始IP地址</strong></p>\n<pre><code>X-Forwarded-For: client1, proxy1, proxy2\nX-Forwarded-For: 129.78.138.66, 129.78.64.103\n</code></pre><p><strong>X-Forwarded-Host 一个事实标准，用来标识客户端在HTTP请求头中请求的原始host,因为主机名或者反向代理的端口可能与处理请求的原始服务器不同</strong></p>\n<pre><code>X-Forwarded-Host: en.wikipedia.org:8080\nX-Forwarded-Host: en.wikipedia.org\n</code></pre><p><strong>X-Forwarded-Proto 一个事实标准，用来标识HTTP原始协议，因为反向代理或者负载均衡器和web服务器可能使用http,但是请求到反向代理使用的是https</strong></p>\n<pre><code>X-Forwarded-Proto: https\n</code></pre><p><strong>Front-End-Https 微软应用程序和负载均衡器使用的非标准header字段 Front-End-Https: on</strong></p>\n<p><strong>X-Http-Method-Override 请求web应用时，使用header字段中给定的方法（通常是put或者delete）覆盖请求中指定的方法（通常是post）,如果用户代理或者防火墙不支持直接使用put或者delete方法发送请求时，可以使用这个字段</strong></p>\n<pre><code>X-HTTP-Method-Override: DELETE\n</code></pre><p><strong>X-ATT-DeviceId 允许更简单的解析用户代理在AT&amp;T设备上的MakeModel/Firmware</strong></p>\n<pre><code>X-Att-Deviceid: GT-P7320/P7320XXLPG\n</code></pre><p><strong>X-Wap-Profile 设置描述当前连接设备的详细信息的xml文件在网络中的位置</strong></p>\n<pre><code>x-wap-profile: http://wap.samsungmobile.com/uaprof/SGH-I777.xml\n</code></pre><p><strong>Proxy-Connection 早起HTTP版本中的一个误称，现在使用标准的connection字段</strong></p>\n<pre><code>Proxy-Connection: keep-alive\n</code></pre><p><strong>X-UIDH 服务端深度包检测插入的一个唯一ID标识Verizon Wireless的客户</strong></p>\n<pre><code>X-UIDH: ...\n</code></pre><p><strong>X-Csrf-Token,X-CSRFToken,X-XSRF-TOKEN 防止跨站请求伪造</strong></p>\n<pre><code>X-Csrf-Token: i8XNjC4b8KVok4uw5RftR38Wgp2BFwql\n</code></pre><p><strong>X-Request-ID,X-Correlation-ID 标识客户端和服务端的HTTP请求</strong></p>\n<pre><code>X-Request-ID: f058ebd6-02f7-4d3f-942e-904344e8cde5\n</code></pre><h3 id=\"常用标准响应头字段\"><a href=\"#常用标准响应头字段\" class=\"headerlink\" title=\"常用标准响应头字段\"></a>常用标准响应头字段</h3><p><strong>Access-Control-Allow-Origin 指定哪些站点可以参与跨站资源共享</strong></p>\n<pre><code>Access-Control-Allow-Origin: *\n</code></pre><p><strong>Accept-Patch 指定服务器支持的补丁文档格式，适用于http的patch方法</strong></p>\n<pre><code>Accept-Patch: text/example;charset=utf-8\n</code></pre><p><strong>Accept-Ranges 服务器通过byte serving支持的部分内容范围类型</strong></p>\n<pre><code>Accept-Ranges: bytes\n</code></pre><p><strong>Age 对象在代理缓存中暂存的秒数</strong></p>\n<pre><code>Age: 12\n</code></pre><p><strong>Allow 设置特定资源的有效行为，适用方法不被允许的http 405错误</strong></p>\n<pre><code>Allow: GET, HEAD\n</code></pre><p><strong>Alt-Svc 服务器使用”Alt-Svc”（Alternative Servicesde的缩写）头标识资源可以通过不同的网络位置或者不同的网络协议获取</strong></p>\n<pre><code>Alt-Svc: h2=&quot;http2.example.com:443&quot;; ma=7200\n</code></pre><p><strong>Cache-Control 告诉服务端到客户端所有的缓存机制是否可以缓存这个对象，单位是秒</strong></p>\n<pre><code>Cache-Control: max-age=3600\n</code></pre><p><strong>Connection 设置当前连接和hop-by-hop协议请求字段列表的控制选项</strong></p>\n<pre><code>Connection: close\n</code></pre><p><strong>Content-Disposition 告诉客户端弹出一个文件下载框，并且可以指定下载文件名</strong></p>\n<pre><code>Content-Disposition: attachment; filename=&quot;fname.ext&quot;\n</code></pre><p><strong>Content-Encoding 设置数据使用的编码类型</strong></p>\n<pre><code>Content-Encoding: gzip\n</code></pre><p><strong>Content-Language 为封闭内容设置自然语言或者目标用户语言</strong></p>\n<pre><code>Content-Language: en\n</code></pre><p><strong>Content-Length 响应体的字节长度</strong></p>\n<pre><code>Content-Length: 348\n</code></pre><p><strong>Content-Location 设置返回数据的另一个位置</strong></p>\n<pre><code>Content-Location: /index.htm\n</code></pre><p><strong>Content-MD5 设置基于MD5算法对响应体内容进行Base64二进制编码</strong></p>\n<pre><code>Content-MD5: Q2hlY2sgSW50ZWdyaXR5IQ==\n</code></pre><p><strong>Content-Range 标识响应体内容属于完整消息体中的那一部分</strong></p>\n<pre><code>Content-Range: bytes 21010-47021/47022\n</code></pre><p><strong>Content-Type 设置响应体的MIME类型</strong></p>\n<pre><code>Content-Type: text/html; charset=utf-8\n</code></pre><p><strong>Date 设置消息发送的日期和时间</strong></p>\n<pre><code>Date: Tue, 15 Nov 1994 08:12:31 GMT\n</code></pre><p><strong>ETag 特定版本资源的标识符，通常是消息摘要</strong></p>\n<pre><code>ETag: &quot;737060cd8c284d8af7ad3082f209582d&quot;\n</code></pre><p><strong>Expires 设置响应体的过期时间</strong></p>\n<pre><code>Expires: Thu, 01 Dec 1994 16:00:00 GMT\n</code></pre><p><strong>Last-Modified 设置请求对象最后一次的修改日期</strong></p>\n<pre><code>Last-Modified: Tue, 15 Nov 1994 12:45:26 GMT\n</code></pre><p><strong>Link 设置与其他资源的类型关系</strong></p>\n<pre><code>Link: &lt;/feed&gt;; rel=&quot;alternate&quot;\n</code></pre><p><strong>Location 在重定向中或者创建新资源时使用</strong></p>\n<pre><code>Location: http://www.w3.org/pub/WWW/People.html\n</code></pre><p><strong>P3P 以P3P:CP=”your_compact_policy”的格式设置支持P3P(Platform for Privacy Preferences Project)策略，大部分浏览器没有完全支持P3P策略，许多站点设置假的策略内容欺骗支持P3P策略的浏览器以获取第三方cookie的授权</strong></p>\n<pre><code>P3P: CP=&quot;This is not a P3P policy! See http://www.google.com/support/accounts/bin/answer.py?hl=en&amp;answer=151657 for more info.&quot;\n</code></pre><p><strong>Pragma 设置特殊实现字段，可能会对请求响应链有多种影响</strong></p>\n<pre><code>Pragma: no-cache\n</code></pre><p><strong>Proxy-Authenticate 设置访问代理的请求权限</strong></p>\n<pre><code>Proxy-Authenticate: Basic\n</code></pre><p><strong>Public-Key-Pins 设置站点的授权TLS证书</strong></p>\n<pre><code>Public-Key-Pins: max-age=2592000; pin-sha256=&quot;E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g=&quot;;\n</code></pre><p><strong>Refresh “重定向或者新资源创建时使用，在页面的头部有个扩展可以实现相似的功能，并且大部分浏览器都支持</strong><br><code>meta http-equiv=&quot;refresh&quot; content=&quot;5; url=http://example.com/</code> </p>\n<pre><code>Refresh: 5; url=http://www.w3.org/pub/WWW/People.html\n</code></pre><p><strong>Retry-After 如果实体暂时不可用，可以设置这个值让客户端重试，可以使用时间段（单位是秒）或者HTTP时间</strong></p>\n<pre><code>Example 1: Retry-After: 120\nExample 2: Retry-After: Fri, 07 Nov 2014 23:59:59 GMT\n</code></pre><p><strong>Server 服务器WEB名称</strong></p>\n<pre><code>Server: Apache/2.4.1 (Unix)\n</code></pre><p><strong>Set-Cookie 设置HTTP Cookie</strong></p>\n<pre><code>Set-Cookie: UserID=JohnDoe; Max-Age=3600; Version=1\n</code></pre><p><strong>Status 设置HTTP响应状态</strong></p>\n<pre><code>Status: 200 OK\n</code></pre><p><strong>Strict-Transport-Security 一种HSTS策略通知HTTP客户端缓存HTTPS策略多长时间以及是否应用到子域</strong></p>\n<pre><code>Strict-Transport-Security: max-age=16070400; includeSubDomains\n</code></pre><p><strong>Trailer 标识给定的header字段将展示在后续的chunked编码的消息中</strong></p>\n<pre><code>Trailer: Max-Forwards\n</code></pre><p><strong>Transfer-Encoding 设置传输实体的编码格式，目前支持的格式： chunked, compress, deflate, gzip, identity</strong></p>\n<pre><code>Transfer-Encoding: chunked\n</code></pre><p><strong>TSV Tracking Status Value，在响应中设置给DNT(do-not-track),可能的取值</strong></p>\n<pre><code>&quot;!&quot; — under construction\n&quot;?&quot; — dynamic\n&quot;G&quot; — gateway to multiple parties\n&quot;N&quot; — not tracking\n&quot;T&quot; — tracking\n&quot;C&quot; — tracking with consent\n&quot;P&quot; — tracking only if consented\n&quot;D&quot; — disregarding DNT\n&quot;U&quot; — updated\n\nTSV: ?\n</code></pre><p><strong>Upgrade 请求客户端升级协议</strong></p>\n<pre><code>Upgrade: HTTP/2.0, HTTPS/1.3, IRC/6.9, RTA/x11, websocket\n</code></pre><p><strong>Vary 通知下级代理如何匹配未来的请求头已让其决定缓存的响应是否可用而不是重新从源主机请求新的</strong></p>\n<pre><code>Example 1: Vary: *\nExample 2: Vary: Accept-Language\n</code></pre><p><strong>Via 通知客户端代理，通过其要发送什么响应</strong></p>\n<pre><code>Via: cache46.l2cn1341[84,206-0,H], cache38.l2c0c801[91,0], kunlun6.cn536[172,304-0,H], kunlun7.cn196[174,0]\n</code></pre><p><strong>x-cache 是否命中缓存，HIT和MISS</strong></p>\n<pre><code>x-cache: HIT TCP_IMS_HIT dirn:-2:-2\n</code></pre><p><strong>Warning 实体可能会发生的问题的通用警告</strong></p>\n<pre><code>Warning: 199 Miscellaneous warning\n</code></pre><p><strong>WWW-Authenticate 标识访问请求实体的身份验证方案</strong></p>\n<pre><code>WWW-Authenticate: Basic\n</code></pre><p><strong>X-Frame-Options 点击劫持保护：</strong></p>\n<pre><code>deny frame中不渲染\nsameorigin 如果源不匹配不渲染\nallow-from 允许指定位置访问\nallowall 不标准，允许任意位置访问\n\nX-Frame-Options: deny\n</code></pre><h3 id=\"常用非标准响应头字段\"><a href=\"#常用非标准响应头字段\" class=\"headerlink\" title=\"常用非标准响应头字段\"></a>常用非标准响应头字段</h3><p><strong>X-XSS-Protection 过滤跨站脚本</strong></p>\n<pre><code>X-XSS-Protection: 1; mode=block\n</code></pre><p><strong>Content-Security-Policy, X-Content-Security-Policy,X-WebKit-CSP 定义内容安全策略</strong></p>\n<pre><code>X-WebKit-CSP: default-src &apos;self&apos;\n</code></pre><p><strong>X-Content-Type-Options 唯一的取值是””,阻止IE在响应中嗅探定义的内容格式以外的其他MIME格式</strong></p>\n<pre><code>X-Content-Type-Options: nosniff\n</code></pre><p><strong>X-Powered-By 指定支持web应用的技术</strong></p>\n<pre><code>X-Powered-By: PHP/5.4.0\n</code></pre><p><strong>X-UA-Compatible 推荐首选的渲染引擎来展示内容，通常向后兼容，也用于激活IE中内嵌chrome框架插件</strong><br><code>&lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;chrome=1&quot; /&gt;</code> </p>\n<pre><code>X-UA-Compatible: IE=EmulateIE7\nX-UA-Compatible: IE=edge\nX-UA-Compatible: Chrome=1\n</code></pre><p><strong>X-Content-Duration 提供音视频的持续时间，单位是秒，只有Gecko内核浏览器支持</strong></p>\n<pre><code>X-Content-Duration: 42.666\n</code></pre><p><strong>Upgrade-Insecure-Requests 标识服务器是否可以处理HTTPS协议</strong></p>\n<pre><code>Upgrade-Insecure-Requests: 1\n</code></pre><p><strong>X-Request-ID,X-Correlation-ID 标识一个客户端和服务端的请求</strong></p>\n<pre><code>X-Request-ID: f058ebd6-02f7-4d3f-942e-904344e8cde5\n</code></pre><p><strong>以下是一次客户端请求某网页的过程</strong></p>\n<p><img src=\"/images/pic/http-cache.png\" alt><br>如图通过二次请求对网页状态说明</p>\n<blockquote>\n<ol>\n<li><p>客户端通过浏览器打开某网页，判断本地缓存是否过期。</p>\n</li>\n<li><p>没过期直接从缓存读取并且返回结果。</p>\n</li>\n<li><p>如果过期，服务器算出一个哈希值并通过 ETag 返回给浏览器，浏览器把哈希值和页面同时缓存在本地，当下次再次向服务器请求时，会通过类似 If-None-Match: “etag值” 的请求头把ETag发送给服务器，服务器再次计算页面的哈希值并和浏览器返回的值做比较，如果发现发生了变化就把页面返回给浏览器(200)，如果发现没有变化就给浏览器返回一个304未修改。这样通过控制浏览器端的缓存，可以节省服务器的带宽，因为服务器不需要每次都把全量数据返回给客户端。<br>当未携带Etag时，客户端访问页面，服务器会将页面最后修改时间通过 Last-Modified 标识由服务器发往客户端，客户端记录修改时间，再次请求本地存在的cache页面时，客户端会通过 If-Modified-Since 头将先前服务器端发过来的Last-Modified时间戳发送回去，服务器端通过这个时间戳判断客户端的页面是否是最新的，如果不是最新的，则返回新的内容，如果是最新的，则 返回 304 告诉客户端其本地 cache 的页面是最新的。</p>\n</li>\n</ol>\n</blockquote>\n"},{"layout":"post","title":"Elastic Stack之X-Pack7.0破解","author":"Pyker","img":"/images/bar/xpack.png","top":false,"cover":false,"date":"2019-03-13T08:30:00.000Z","_content":">**说明： elastic官方在elastic stack 6.4.2版本后就在elasticsearch中内置了X-Pack工具，因此下文破解X-Pack7.0.1的版本也是对应elastic stack7.0.1的版本。而X-Pack内置在elasticsearch包中，以下所有操作都是针对elasticsearch7.0.1包中进行的。**\n\n## X-Pack是什么\nX-pack是elasticsearch的一个扩展包，将安全，警告，监视，图形和报告功能捆绑在一个易于安装的软件包中，虽然x-pack被设计为一个无缝的工作，但是你可以轻松的启用或者关闭一些功能。\n>目前6.2及以下版本只能使用免费版，然而免费版的功能相当少。X-pack 的破解基本思路是先安装正常版本，之后替换破解的jar包来实现，目前只能破解到白金版，但已经够用了。更多版本功能介绍请查看[官方版本订阅文档](https://www.elastic.co/cn/subscriptions)\n\n## 下载elasticsearch\n上面提到X-Pack自6.4.2版本后已经内置到elasticsearch中，因此我们需要下载elasticsearch7.0.1最新版。\n```bash\n# 下载elasticsearch.tar.gz\n$ mkdir /elk && cd /elk\n$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.0.1-linux-x86_64.tar.gz\n\n# 解压elasticsearch.tar.gz\n$ tar zxvf elasticsearch-7.0.1-linux-x86_64.tar.gz\n```\n下载完成并且解压后，我们可以查看自带x-pack的模版。\n```bash\n# 查看x-pack相关的模块\n\n$ cd elasticsearch-7.0.1\n$ ls modules/ | grep x-pack\nx-pack-ccr\nx-pack-core\nx-pack-deprecation\nx-pack-graph\nx-pack-ilm\nx-pack-logstash\nx-pack-ml\nx-pack-monitoring\nx-pack-rollup\nx-pack-security\nx-pack-sql\nx-pack-watcher\n```\n我们需要破解的`x-pack-core.7.0.1.jar`也就位于x-pack-core目录下\n```bash\n$ ls /elk/elasticsearch-7.0.1/modules/x-pack-core | grep x-pack\nx-pack-core-7.0.1.jar \n```\n## 下载反编译工具Luyten\n破解X-Pack-core-7.0.1.jar需要反编译工具Luyten，我们可以前往[下载地址](https://github.com/deathmarine/Luyten/releases)下载Luyten工具。\n我们这里下载Luyten.exe windows版本，下载下来后打开，并将`x-pack-core.7.0.1.jar`文件拖进去，即可展开jar包的源代码了。\n\n## 修改X-Pack源码文件\n在Luyten工具中我们需要把2个文件提取出来进行修改。`org.elasticsearch.license.LicenseVerifier`和`org.elasticsearch.xpack.core.XPackBuild`。\n### 修改LicenseVerifier.java\n`LicenseVerifier`中有两个静态方法，这就是验证授权文件是否有效的方法，我们把它修改为全部返回true.\n```java\n/*如下代码为修改完后的代码,我们这里使用注释将不需要的代码注释掉*/\n\npackage org.elasticsearch.license;\n\nimport java.nio.*;\nimport org.elasticsearch.common.bytes.*;\nimport java.security.*;\nimport java.util.*;\nimport org.elasticsearch.common.xcontent.*;\nimport org.apache.lucene.util.*;\nimport org.elasticsearch.core.internal.io.*;\nimport java.io.*;\n\npublic class LicenseVerifier\n{\n    public static boolean verifyLicense(final License license, final byte[] publicKeyData) {\n /*       \n        byte[] signedContent = null;\n        byte[] publicKeyFingerprint = null;\n        try {\n            final byte[] signatureBytes = Base64.getDecoder().decode(license.signature());\n            final ByteBuffer byteBuffer = ByteBuffer.wrap(signatureBytes);\n            final int version = byteBuffer.getInt();\n            final int magicLen = byteBuffer.getInt();\n            final byte[] magic = new byte[magicLen];\n            byteBuffer.get(magic);\n            final int hashLen = byteBuffer.getInt();\n            publicKeyFingerprint = new byte[hashLen];\n            byteBuffer.get(publicKeyFingerprint);\n            final int signedContentLen = byteBuffer.getInt();\n            signedContent = new byte[signedContentLen];\n            byteBuffer.get(signedContent);\n            final XContentBuilder contentBuilder = XContentFactory.contentBuilder(XContentType.JSON);\n            license.toXContent(contentBuilder, (ToXContent.Params)new ToXContent.MapParams((Map)Collections.singletonMap(\"license_spec_view\", \"true\")));\n            final Signature rsa = Signature.getInstance(\"SHA512withRSA\");\n            rsa.initVerify(CryptUtils.readPublicKey(publicKeyData));\n            final BytesRefIterator iterator = BytesReference.bytes(contentBuilder).iterator();\n            BytesRef ref;\n            while ((ref = iterator.next()) != null) {\n                rsa.update(ref.bytes, ref.offset, ref.length);\n            }\n            return rsa.verify(signedContent);\n        }\n        catch (IOException ex) {}\n        catch (NoSuchAlgorithmException ex2) {}\n        catch (SignatureException ex3) {}\n        catch (InvalidKeyException e) {\n            throw new IllegalStateException(e);\n        }\n        finally {\n            if (signedContent != null) {\n                Arrays.fill(signedContent, (byte)0);\n            }\n        }\n*/\n        return true;\n    }\n    \n    public static boolean verifyLicense(final License license) {\n        /*\n        byte[] publicKeyBytes;\n        try {\n            final InputStream is = LicenseVerifier.class.getResourceAsStream(\"/public.key\");\n            try {\n                final ByteArrayOutputStream out = new ByteArrayOutputStream();\n                Streams.copy(is, (OutputStream)out);\n                publicKeyBytes = out.toByteArray();\n                if (is != null) {\n                    is.close();\n                }\n            }\n            catch (Throwable t) {\n                if (is != null) {\n                    try {\n                        is.close();\n                    }\n                    catch (Throwable t2) {\n                        t.addSuppressed(t2);\n                    }\n                }\n                throw t;\n            }\n        }\n        catch (IOException ex) {\n            throw new IllegalStateException(ex);\n        }\n        //return verifyLicense(license, publicKeyBytes);\n        */\n        return true;\n    }\n}\n\n```\n### 修改XPackBuild.java\n`XPackBuild`中最后一个静态代码块中 try的部分全部删除，这部分会验证jar包是否被修改.\n```java\n/*如下代码为修改完后的代码,我们这里使用注释将不需要的代码注释掉*/\n\npackage org.elasticsearch.xpack.core;\n\nimport org.elasticsearch.common.io.*;\nimport java.net.*;\nimport org.elasticsearch.common.*;\nimport java.nio.file.*;\nimport java.io.*;\nimport java.util.jar.*;\n\npublic class XPackBuild\n{\n    public static final XPackBuild CURRENT;\n    private String shortHash;\n    private String date;\n    \n    @SuppressForbidden(reason = \"looks up path of xpack.jar directly\")\n    static Path getElasticsearchCodebase() {\n        final URL url = XPackBuild.class.getProtectionDomain().getCodeSource().getLocation();\n        try {\n            return PathUtils.get(url.toURI());\n        }\n        catch (URISyntaxException bogus) {\n            throw new RuntimeException(bogus);\n        }\n    }\n    \n    XPackBuild(final String shortHash, final String date) {\n        this.shortHash = shortHash;\n        this.date = date;\n    }\n    \n    public String shortHash() {\n        return this.shortHash;\n    }\n    \n    public String date() {\n        return this.date;\n    }\n    \n    static {\n        final Path path = getElasticsearchCodebase();\n        String shortHash = null;\n        String date = null;\n        Label_0109: {\n/*            if (path.toString().endsWith(\".jar\")) {\n                try {\n                    final JarInputStream jar = new JarInputStream(Files.newInputStream(path, new OpenOption[0]));\n                    try {\n                        final Manifest manifest = jar.getManifest();\n                        shortHash = manifest.getMainAttributes().getValue(\"Change\");\n                        date = manifest.getMainAttributes().getValue(\"Build-Date\");\n                        jar.close();\n                    }\n                    catch (Throwable t) {\n                        try {\n                            jar.close();\n                        }\n                        catch (Throwable t2) {\n                            t.addSuppressed(t2);\n                        }\n                        throw t;\n                    }\n                    break Label_0109;\n                }\n                catch (IOException e) {\n                    throw new RuntimeException(e);\n                }\n            }\n*/\n            shortHash = \"Unknown\";\n            date = \"Unknown\";\n        }\n        CURRENT = new XPackBuild(shortHash, date);\n    }\n}\n\n\n```\n## 生成.class文件\n上述`LicenseVerifier.java`和`XPackBuild.java`两个文件在本地电脑windows修改完成后，我们需要将其复制到elasticsearch服务器上并编译成class文件，然后打包到x-pack-core-7.0.1.jar中。我们这里将这2个文件放到了/root目录下。\n```bash\n# 编译LicenseVerifier.java\n$ javac -cp \"/elk/elasticsearch-7.0.1/lib/elasticsearch-7.0.1.jar:/elk/elasticsearch-7.0.1/lib/lucene-core-8.0.0.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/netty-common-4.1.32.Final.jar:/elk/elasticsearch-7.0.1/lib/elasticsearch-core-7.0.1.jar\" /root/LicenseVerifier.java\n\n# 编译XPackBuild.java\n$ javac -cp \"/elk/elasticsearch-7.0.1/lib/elasticsearch-7.0.1.jar:/elk/elasticsearch-7.0.1/lib/lucene-core-8.0.0.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/netty-common-4.1.32.Final.jar:/elk/elasticsearch-7.0.1/lib/elasticsearch-core-7.0.1.jar\" /root/XPackBuild.java\n\n# 查看编译后的文件\n$ ls /root | grep .class\nLicenseVerifier.class\nXPackBuild.class\n```\n\n## 替换LicenseVerifier.class和XPackBuild.class\n我们把`/elk/elasticsearch-7.0.1/modules/x-pack-core`目录下的`x-pack-core-7.0.1.jar`提取出来，放到一个临时的`/elk/x-pack`目录中。\n```bash\n$ cp /elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar /elk/x-pack\n$ cd /elk/x-pack\n# 解压x-pack-core-7.0.1.jar\n$ jar -xvf x-pack-core-7.0.1.jar\n\n# 替换.class文件\n$ cp /root/XPackBuild.class /elk/x-pack/org/elasticsearch/xpack/core/\n$ cp /root/LicenseVerifier.class /elk/x-pack/org/elasticsearch/license/\n```\n## 打包新x-pack-core-7.0.1.jar文件\n```bash\n$ cd /elk/x-pack\n$ rm -rf x-pack-core-7.0.1.jar   # 删除临时拷贝过来的源文件\n$ jar cvf x-pack-core-7.0.1.jar .\n```\n至此在/elk/x-pack目录下会新生成一个`x-pack-core-7.0.1.jar`文件。也就是破解后的文件。\n\n## 替换x-pack-core-7.0.1.jar文件\n我们将新生成的x-pack-core-7.0.1.jar文件文件替换掉源x-pack-core-7.0.1.jar文件。\n```bash\ncp /elk/x-pack/x-pack-core-7.0.1.jar /elk/elasticsearch-7.0.1/modules/x-pack-core/\nrm -rf /elk/x-pack  # 完成文件替换后该目录既可以删除了\n``` \n## 申请License\n完成以上步骤后，我们还需要去elastic官网申请一个license, [License申请地址](https://license.elastic.co/registration)，申请完成后，下载下来的License格式为json格式。并将该License的`type`、`expiry_date_in_millis`、`max_nodes`分别修改成`platinum`、`2524579200999`、`1000`。如下：\n```json\n{\"license\":\n    {\n        \"uid\":\"537c5c48-c1dd-43ea-ab69-68d209d80c32\",\n        \"type\":\"platinum\",\n        \"issue_date_in_millis\":1558051200000,\n        \"expiry_date_in_millis\":2524579200999,\n        \"max_nodes\":1000,\n        \"issued_to\":\"pyker\",\n        \"issuer\":\"Web Form\",\n        \"signature\":\"AAAAAwAAAA3fIq7NLN3Blk2olVjbAAABmC9ZN0hjZDBGYnVyRXpCOW5Bb3FjZDAxOWpSbTVoMVZwUzRxVk1PSmkxaktJRVl5MUYvUWh3bHZVUTllbXNPbzBUemtnbWpBbmlWRmRZb25KNFlBR2x0TXc2K2p1Y1VtMG1UQU9TRGZVSGRwaEJGUjE3bXd3LzRqZ05iLzRteWFNekdxRGpIYlFwYkJiNUs0U1hTVlJKNVlXekMrSlVUdFIvV0FNeWdOYnlESDc3MWhlY3hSQmdKSjJ2ZTcvYlBFOHhPQlV3ZHdDQ0tHcG5uOElCaDJ4K1hob29xSG85N0kvTWV3THhlQk9NL01VMFRjNDZpZEVXeUtUMXIyMlIveFpJUkk2WUdveEZaME9XWitGUi9WNTZVQW1FMG1DenhZU0ZmeXlZakVEMjZFT2NvOWxpZGlqVmlHNC8rWVVUYzMwRGVySHpIdURzKzFiRDl4TmM1TUp2VTBOUlJZUlAyV0ZVL2kvVk10L0NsbXNFYVZwT3NSU082dFNNa2prQ0ZsclZ4NTltbU1CVE5lR09Bck93V2J1Y3c9PQAAAQCjNd8mwy8B1sm9rGrgTmN2Gjm/lxqfnTEpTc+HOEmAgwQ7Q1Ye/FSGVNIU/enZ5cqSzWS2mY8oZ7FM/7UPKVQ4hkarWn2qye964MW+cux54h7dqxlSB19fG0ZJOJZxxwVxxi8iyJPUSQBa+QN8m7TFkK2kVmP+HnhU7mGUrqXt3zTk5d3pZw3QBQ/Rr3wmSYC5pxV6/o2UHFgu1OPDcX+kEb+UZtMrVNneR+cEwyx7o5Bg3rbKC014T+lMtt69Y080JDI5KfHa7e9Ul0c3rozIL975fP45dU175D4PKZy98cvHJgtsCJF3K8XUZKo2lOcbsWzhK2mZ5kFp0BMXF3Hs\",\n        \"start_date_in_millis\":1558051200000\n    }\n}\n```\n我们将过期时间写到2050年，type改为platinum 白金版，这样我们就会拥有全部的x-pack功能。\n## 配置elasticsearch安全协议\n完成以上所有操作在启动elasticsearch前，我们需要配置elasticsearch的SSL/TLS安全协议,如果不配置的话，需要禁止security才能配置License。当License配置完成后我们需要再开启security，并开启SSL\\TLS。\n```bash\n# 加载License到elasticsearch之前操作\n$ echo \"xpack.security.enabled: false\" >> /elk/elasticsearch-7.0.1/config/elasticsearch.yml\n$ ./bin/elasticsearch -d   # 后台方式启动elasticsearch\n\n# 加载License到elasticsearch之后操作\n$ echo \"xpack.security.transport.ssl.enabled: true\" >> /elk/elasticsearch-7.0.1/config/elasticsearch.yml\n$ sed -i 's/xpack.security.enabled: false/xpack.security.enabled: true/g' /elk/elasticsearch-7.0.1/config/elasticsearch.yml\n$ kill -9 13023 && ./bin/elasticsearch -d   # 重启elasticsearch\n```\n## 加载License到elasticsearch\n```bash\n$ curl -XPUT -u elastic 'http://192.168.20.210:9200/_xpack/license' -H \"Content-Type: application/json\" -d @license.json\nEnter host password for user 'elastic':           # 提示输入elastic用户密码，当前无密码，所以直接回车\n{\"acknowledged\":true,\"license_status\":\"valid\"}    # license写入成功\n```\n## 查看License\n```bash\n$ curl -XGET -u elastic:tWbWZc7NE3wYqS6DvSu4 http://192.168.20.210:9200/_license\n{\n  \"license\" : {\n    \"status\" : \"active\",\n    \"uid\" : \"537c5c48-c1dd-43ea-ab69-68d209d80c32\",\n    \"type\" : \"platinum\",\n    \"issue_date\" : \"2019-05-17T00:00:00.000Z\",\n    \"issue_date_in_millis\" : 1558051200000,\n    \"expiry_date\" : \"2049-12-31T16:00:00.999Z\",\n    \"expiry_date_in_millis\" : 2524579200999,\n    \"max_nodes\" : 1000,\n    \"issued_to\" : \"pyker\",\n    \"issuer\" : \"Web Form\",\n    \"start_date_in_millis\" : 1558051200000\n  }\n}\n```\n由结果可以看出x-pack到期时间为2049-12-31，破解完成。也可以在kibana web页面`管理`中查看破解详情。\n![](/images/pic/x-pack.png)\n\n## 设置密码\n现在我们可以使用`x-pack铂金版`的所有功能了，例如密码安全验证功能。\n```bash\n$ ./bin/elasticsearch-setup-passwords auto\n\nInitiating the setup of passwords for reserved users elastic,apm_system,kibana,logstash_system,beats_system,remote_monitoring_user.\nThe passwords will be randomly generated and printed to the console.\nPlease confirm that you would like to continue [y/N]y\n\nChanged password for user apm_system\nPASSWORD apm_system = 24UtJKbNI1UqHUQkKPZY\n\nChanged password for user kibana\nPASSWORD kibana = 8SSZMisIY0NZFMCS6wv9\n\nChanged password for user logstash_system\nPASSWORD logstash_system = rFhWkYzayIUZVl8VIunJ\n\nChanged password for user beats_system\nPASSWORD beats_system = U1B4O5SKrSEatqDQRsQz\n\nChanged password for user remote_monitoring_user\nPASSWORD remote_monitoring_user = zdpj7HqO02yRXZR9Bwa2\n\nChanged password for user elastic\nPASSWORD elastic = tWbWZc7NE3wYqS6DvSu4\n```","source":"_posts/elastic-x-pack.md","raw":"layout: post\ntitle: Elastic Stack之X-Pack7.0破解\nauthor: Pyker\ncategories: elastic\nimg: /images/bar/xpack.png\ntags:\n  - x-pack\ntop: false\ncover: false\ndate: 2019-03-13 16:30:00\n---\n>**说明： elastic官方在elastic stack 6.4.2版本后就在elasticsearch中内置了X-Pack工具，因此下文破解X-Pack7.0.1的版本也是对应elastic stack7.0.1的版本。而X-Pack内置在elasticsearch包中，以下所有操作都是针对elasticsearch7.0.1包中进行的。**\n\n## X-Pack是什么\nX-pack是elasticsearch的一个扩展包，将安全，警告，监视，图形和报告功能捆绑在一个易于安装的软件包中，虽然x-pack被设计为一个无缝的工作，但是你可以轻松的启用或者关闭一些功能。\n>目前6.2及以下版本只能使用免费版，然而免费版的功能相当少。X-pack 的破解基本思路是先安装正常版本，之后替换破解的jar包来实现，目前只能破解到白金版，但已经够用了。更多版本功能介绍请查看[官方版本订阅文档](https://www.elastic.co/cn/subscriptions)\n\n## 下载elasticsearch\n上面提到X-Pack自6.4.2版本后已经内置到elasticsearch中，因此我们需要下载elasticsearch7.0.1最新版。\n```bash\n# 下载elasticsearch.tar.gz\n$ mkdir /elk && cd /elk\n$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.0.1-linux-x86_64.tar.gz\n\n# 解压elasticsearch.tar.gz\n$ tar zxvf elasticsearch-7.0.1-linux-x86_64.tar.gz\n```\n下载完成并且解压后，我们可以查看自带x-pack的模版。\n```bash\n# 查看x-pack相关的模块\n\n$ cd elasticsearch-7.0.1\n$ ls modules/ | grep x-pack\nx-pack-ccr\nx-pack-core\nx-pack-deprecation\nx-pack-graph\nx-pack-ilm\nx-pack-logstash\nx-pack-ml\nx-pack-monitoring\nx-pack-rollup\nx-pack-security\nx-pack-sql\nx-pack-watcher\n```\n我们需要破解的`x-pack-core.7.0.1.jar`也就位于x-pack-core目录下\n```bash\n$ ls /elk/elasticsearch-7.0.1/modules/x-pack-core | grep x-pack\nx-pack-core-7.0.1.jar \n```\n## 下载反编译工具Luyten\n破解X-Pack-core-7.0.1.jar需要反编译工具Luyten，我们可以前往[下载地址](https://github.com/deathmarine/Luyten/releases)下载Luyten工具。\n我们这里下载Luyten.exe windows版本，下载下来后打开，并将`x-pack-core.7.0.1.jar`文件拖进去，即可展开jar包的源代码了。\n\n## 修改X-Pack源码文件\n在Luyten工具中我们需要把2个文件提取出来进行修改。`org.elasticsearch.license.LicenseVerifier`和`org.elasticsearch.xpack.core.XPackBuild`。\n### 修改LicenseVerifier.java\n`LicenseVerifier`中有两个静态方法，这就是验证授权文件是否有效的方法，我们把它修改为全部返回true.\n```java\n/*如下代码为修改完后的代码,我们这里使用注释将不需要的代码注释掉*/\n\npackage org.elasticsearch.license;\n\nimport java.nio.*;\nimport org.elasticsearch.common.bytes.*;\nimport java.security.*;\nimport java.util.*;\nimport org.elasticsearch.common.xcontent.*;\nimport org.apache.lucene.util.*;\nimport org.elasticsearch.core.internal.io.*;\nimport java.io.*;\n\npublic class LicenseVerifier\n{\n    public static boolean verifyLicense(final License license, final byte[] publicKeyData) {\n /*       \n        byte[] signedContent = null;\n        byte[] publicKeyFingerprint = null;\n        try {\n            final byte[] signatureBytes = Base64.getDecoder().decode(license.signature());\n            final ByteBuffer byteBuffer = ByteBuffer.wrap(signatureBytes);\n            final int version = byteBuffer.getInt();\n            final int magicLen = byteBuffer.getInt();\n            final byte[] magic = new byte[magicLen];\n            byteBuffer.get(magic);\n            final int hashLen = byteBuffer.getInt();\n            publicKeyFingerprint = new byte[hashLen];\n            byteBuffer.get(publicKeyFingerprint);\n            final int signedContentLen = byteBuffer.getInt();\n            signedContent = new byte[signedContentLen];\n            byteBuffer.get(signedContent);\n            final XContentBuilder contentBuilder = XContentFactory.contentBuilder(XContentType.JSON);\n            license.toXContent(contentBuilder, (ToXContent.Params)new ToXContent.MapParams((Map)Collections.singletonMap(\"license_spec_view\", \"true\")));\n            final Signature rsa = Signature.getInstance(\"SHA512withRSA\");\n            rsa.initVerify(CryptUtils.readPublicKey(publicKeyData));\n            final BytesRefIterator iterator = BytesReference.bytes(contentBuilder).iterator();\n            BytesRef ref;\n            while ((ref = iterator.next()) != null) {\n                rsa.update(ref.bytes, ref.offset, ref.length);\n            }\n            return rsa.verify(signedContent);\n        }\n        catch (IOException ex) {}\n        catch (NoSuchAlgorithmException ex2) {}\n        catch (SignatureException ex3) {}\n        catch (InvalidKeyException e) {\n            throw new IllegalStateException(e);\n        }\n        finally {\n            if (signedContent != null) {\n                Arrays.fill(signedContent, (byte)0);\n            }\n        }\n*/\n        return true;\n    }\n    \n    public static boolean verifyLicense(final License license) {\n        /*\n        byte[] publicKeyBytes;\n        try {\n            final InputStream is = LicenseVerifier.class.getResourceAsStream(\"/public.key\");\n            try {\n                final ByteArrayOutputStream out = new ByteArrayOutputStream();\n                Streams.copy(is, (OutputStream)out);\n                publicKeyBytes = out.toByteArray();\n                if (is != null) {\n                    is.close();\n                }\n            }\n            catch (Throwable t) {\n                if (is != null) {\n                    try {\n                        is.close();\n                    }\n                    catch (Throwable t2) {\n                        t.addSuppressed(t2);\n                    }\n                }\n                throw t;\n            }\n        }\n        catch (IOException ex) {\n            throw new IllegalStateException(ex);\n        }\n        //return verifyLicense(license, publicKeyBytes);\n        */\n        return true;\n    }\n}\n\n```\n### 修改XPackBuild.java\n`XPackBuild`中最后一个静态代码块中 try的部分全部删除，这部分会验证jar包是否被修改.\n```java\n/*如下代码为修改完后的代码,我们这里使用注释将不需要的代码注释掉*/\n\npackage org.elasticsearch.xpack.core;\n\nimport org.elasticsearch.common.io.*;\nimport java.net.*;\nimport org.elasticsearch.common.*;\nimport java.nio.file.*;\nimport java.io.*;\nimport java.util.jar.*;\n\npublic class XPackBuild\n{\n    public static final XPackBuild CURRENT;\n    private String shortHash;\n    private String date;\n    \n    @SuppressForbidden(reason = \"looks up path of xpack.jar directly\")\n    static Path getElasticsearchCodebase() {\n        final URL url = XPackBuild.class.getProtectionDomain().getCodeSource().getLocation();\n        try {\n            return PathUtils.get(url.toURI());\n        }\n        catch (URISyntaxException bogus) {\n            throw new RuntimeException(bogus);\n        }\n    }\n    \n    XPackBuild(final String shortHash, final String date) {\n        this.shortHash = shortHash;\n        this.date = date;\n    }\n    \n    public String shortHash() {\n        return this.shortHash;\n    }\n    \n    public String date() {\n        return this.date;\n    }\n    \n    static {\n        final Path path = getElasticsearchCodebase();\n        String shortHash = null;\n        String date = null;\n        Label_0109: {\n/*            if (path.toString().endsWith(\".jar\")) {\n                try {\n                    final JarInputStream jar = new JarInputStream(Files.newInputStream(path, new OpenOption[0]));\n                    try {\n                        final Manifest manifest = jar.getManifest();\n                        shortHash = manifest.getMainAttributes().getValue(\"Change\");\n                        date = manifest.getMainAttributes().getValue(\"Build-Date\");\n                        jar.close();\n                    }\n                    catch (Throwable t) {\n                        try {\n                            jar.close();\n                        }\n                        catch (Throwable t2) {\n                            t.addSuppressed(t2);\n                        }\n                        throw t;\n                    }\n                    break Label_0109;\n                }\n                catch (IOException e) {\n                    throw new RuntimeException(e);\n                }\n            }\n*/\n            shortHash = \"Unknown\";\n            date = \"Unknown\";\n        }\n        CURRENT = new XPackBuild(shortHash, date);\n    }\n}\n\n\n```\n## 生成.class文件\n上述`LicenseVerifier.java`和`XPackBuild.java`两个文件在本地电脑windows修改完成后，我们需要将其复制到elasticsearch服务器上并编译成class文件，然后打包到x-pack-core-7.0.1.jar中。我们这里将这2个文件放到了/root目录下。\n```bash\n# 编译LicenseVerifier.java\n$ javac -cp \"/elk/elasticsearch-7.0.1/lib/elasticsearch-7.0.1.jar:/elk/elasticsearch-7.0.1/lib/lucene-core-8.0.0.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/netty-common-4.1.32.Final.jar:/elk/elasticsearch-7.0.1/lib/elasticsearch-core-7.0.1.jar\" /root/LicenseVerifier.java\n\n# 编译XPackBuild.java\n$ javac -cp \"/elk/elasticsearch-7.0.1/lib/elasticsearch-7.0.1.jar:/elk/elasticsearch-7.0.1/lib/lucene-core-8.0.0.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/netty-common-4.1.32.Final.jar:/elk/elasticsearch-7.0.1/lib/elasticsearch-core-7.0.1.jar\" /root/XPackBuild.java\n\n# 查看编译后的文件\n$ ls /root | grep .class\nLicenseVerifier.class\nXPackBuild.class\n```\n\n## 替换LicenseVerifier.class和XPackBuild.class\n我们把`/elk/elasticsearch-7.0.1/modules/x-pack-core`目录下的`x-pack-core-7.0.1.jar`提取出来，放到一个临时的`/elk/x-pack`目录中。\n```bash\n$ cp /elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar /elk/x-pack\n$ cd /elk/x-pack\n# 解压x-pack-core-7.0.1.jar\n$ jar -xvf x-pack-core-7.0.1.jar\n\n# 替换.class文件\n$ cp /root/XPackBuild.class /elk/x-pack/org/elasticsearch/xpack/core/\n$ cp /root/LicenseVerifier.class /elk/x-pack/org/elasticsearch/license/\n```\n## 打包新x-pack-core-7.0.1.jar文件\n```bash\n$ cd /elk/x-pack\n$ rm -rf x-pack-core-7.0.1.jar   # 删除临时拷贝过来的源文件\n$ jar cvf x-pack-core-7.0.1.jar .\n```\n至此在/elk/x-pack目录下会新生成一个`x-pack-core-7.0.1.jar`文件。也就是破解后的文件。\n\n## 替换x-pack-core-7.0.1.jar文件\n我们将新生成的x-pack-core-7.0.1.jar文件文件替换掉源x-pack-core-7.0.1.jar文件。\n```bash\ncp /elk/x-pack/x-pack-core-7.0.1.jar /elk/elasticsearch-7.0.1/modules/x-pack-core/\nrm -rf /elk/x-pack  # 完成文件替换后该目录既可以删除了\n``` \n## 申请License\n完成以上步骤后，我们还需要去elastic官网申请一个license, [License申请地址](https://license.elastic.co/registration)，申请完成后，下载下来的License格式为json格式。并将该License的`type`、`expiry_date_in_millis`、`max_nodes`分别修改成`platinum`、`2524579200999`、`1000`。如下：\n```json\n{\"license\":\n    {\n        \"uid\":\"537c5c48-c1dd-43ea-ab69-68d209d80c32\",\n        \"type\":\"platinum\",\n        \"issue_date_in_millis\":1558051200000,\n        \"expiry_date_in_millis\":2524579200999,\n        \"max_nodes\":1000,\n        \"issued_to\":\"pyker\",\n        \"issuer\":\"Web Form\",\n        \"signature\":\"AAAAAwAAAA3fIq7NLN3Blk2olVjbAAABmC9ZN0hjZDBGYnVyRXpCOW5Bb3FjZDAxOWpSbTVoMVZwUzRxVk1PSmkxaktJRVl5MUYvUWh3bHZVUTllbXNPbzBUemtnbWpBbmlWRmRZb25KNFlBR2x0TXc2K2p1Y1VtMG1UQU9TRGZVSGRwaEJGUjE3bXd3LzRqZ05iLzRteWFNekdxRGpIYlFwYkJiNUs0U1hTVlJKNVlXekMrSlVUdFIvV0FNeWdOYnlESDc3MWhlY3hSQmdKSjJ2ZTcvYlBFOHhPQlV3ZHdDQ0tHcG5uOElCaDJ4K1hob29xSG85N0kvTWV3THhlQk9NL01VMFRjNDZpZEVXeUtUMXIyMlIveFpJUkk2WUdveEZaME9XWitGUi9WNTZVQW1FMG1DenhZU0ZmeXlZakVEMjZFT2NvOWxpZGlqVmlHNC8rWVVUYzMwRGVySHpIdURzKzFiRDl4TmM1TUp2VTBOUlJZUlAyV0ZVL2kvVk10L0NsbXNFYVZwT3NSU082dFNNa2prQ0ZsclZ4NTltbU1CVE5lR09Bck93V2J1Y3c9PQAAAQCjNd8mwy8B1sm9rGrgTmN2Gjm/lxqfnTEpTc+HOEmAgwQ7Q1Ye/FSGVNIU/enZ5cqSzWS2mY8oZ7FM/7UPKVQ4hkarWn2qye964MW+cux54h7dqxlSB19fG0ZJOJZxxwVxxi8iyJPUSQBa+QN8m7TFkK2kVmP+HnhU7mGUrqXt3zTk5d3pZw3QBQ/Rr3wmSYC5pxV6/o2UHFgu1OPDcX+kEb+UZtMrVNneR+cEwyx7o5Bg3rbKC014T+lMtt69Y080JDI5KfHa7e9Ul0c3rozIL975fP45dU175D4PKZy98cvHJgtsCJF3K8XUZKo2lOcbsWzhK2mZ5kFp0BMXF3Hs\",\n        \"start_date_in_millis\":1558051200000\n    }\n}\n```\n我们将过期时间写到2050年，type改为platinum 白金版，这样我们就会拥有全部的x-pack功能。\n## 配置elasticsearch安全协议\n完成以上所有操作在启动elasticsearch前，我们需要配置elasticsearch的SSL/TLS安全协议,如果不配置的话，需要禁止security才能配置License。当License配置完成后我们需要再开启security，并开启SSL\\TLS。\n```bash\n# 加载License到elasticsearch之前操作\n$ echo \"xpack.security.enabled: false\" >> /elk/elasticsearch-7.0.1/config/elasticsearch.yml\n$ ./bin/elasticsearch -d   # 后台方式启动elasticsearch\n\n# 加载License到elasticsearch之后操作\n$ echo \"xpack.security.transport.ssl.enabled: true\" >> /elk/elasticsearch-7.0.1/config/elasticsearch.yml\n$ sed -i 's/xpack.security.enabled: false/xpack.security.enabled: true/g' /elk/elasticsearch-7.0.1/config/elasticsearch.yml\n$ kill -9 13023 && ./bin/elasticsearch -d   # 重启elasticsearch\n```\n## 加载License到elasticsearch\n```bash\n$ curl -XPUT -u elastic 'http://192.168.20.210:9200/_xpack/license' -H \"Content-Type: application/json\" -d @license.json\nEnter host password for user 'elastic':           # 提示输入elastic用户密码，当前无密码，所以直接回车\n{\"acknowledged\":true,\"license_status\":\"valid\"}    # license写入成功\n```\n## 查看License\n```bash\n$ curl -XGET -u elastic:tWbWZc7NE3wYqS6DvSu4 http://192.168.20.210:9200/_license\n{\n  \"license\" : {\n    \"status\" : \"active\",\n    \"uid\" : \"537c5c48-c1dd-43ea-ab69-68d209d80c32\",\n    \"type\" : \"platinum\",\n    \"issue_date\" : \"2019-05-17T00:00:00.000Z\",\n    \"issue_date_in_millis\" : 1558051200000,\n    \"expiry_date\" : \"2049-12-31T16:00:00.999Z\",\n    \"expiry_date_in_millis\" : 2524579200999,\n    \"max_nodes\" : 1000,\n    \"issued_to\" : \"pyker\",\n    \"issuer\" : \"Web Form\",\n    \"start_date_in_millis\" : 1558051200000\n  }\n}\n```\n由结果可以看出x-pack到期时间为2049-12-31，破解完成。也可以在kibana web页面`管理`中查看破解详情。\n![](/images/pic/x-pack.png)\n\n## 设置密码\n现在我们可以使用`x-pack铂金版`的所有功能了，例如密码安全验证功能。\n```bash\n$ ./bin/elasticsearch-setup-passwords auto\n\nInitiating the setup of passwords for reserved users elastic,apm_system,kibana,logstash_system,beats_system,remote_monitoring_user.\nThe passwords will be randomly generated and printed to the console.\nPlease confirm that you would like to continue [y/N]y\n\nChanged password for user apm_system\nPASSWORD apm_system = 24UtJKbNI1UqHUQkKPZY\n\nChanged password for user kibana\nPASSWORD kibana = 8SSZMisIY0NZFMCS6wv9\n\nChanged password for user logstash_system\nPASSWORD logstash_system = rFhWkYzayIUZVl8VIunJ\n\nChanged password for user beats_system\nPASSWORD beats_system = U1B4O5SKrSEatqDQRsQz\n\nChanged password for user remote_monitoring_user\nPASSWORD remote_monitoring_user = zdpj7HqO02yRXZR9Bwa2\n\nChanged password for user elastic\nPASSWORD elastic = tWbWZc7NE3wYqS6DvSu4\n```","slug":"elastic-x-pack","published":1,"updated":"2019-05-28T02:02:23.502Z","_id":"cjw6jlf0l002ap4n7m0pm300j","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><blockquote>\n<p><strong>说明： elastic官方在elastic stack 6.4.2版本后就在elasticsearch中内置了X-Pack工具，因此下文破解X-Pack7.0.1的版本也是对应elastic stack7.0.1的版本。而X-Pack内置在elasticsearch包中，以下所有操作都是针对elasticsearch7.0.1包中进行的。</strong></p>\n</blockquote>\n<h2 id=\"X-Pack是什么\"><a href=\"#X-Pack是什么\" class=\"headerlink\" title=\"X-Pack是什么\"></a>X-Pack是什么</h2><p>X-pack是elasticsearch的一个扩展包，将安全，警告，监视，图形和报告功能捆绑在一个易于安装的软件包中，虽然x-pack被设计为一个无缝的工作，但是你可以轻松的启用或者关闭一些功能。</p>\n<blockquote>\n<p>目前6.2及以下版本只能使用免费版，然而免费版的功能相当少。X-pack 的破解基本思路是先安装正常版本，之后替换破解的jar包来实现，目前只能破解到白金版，但已经够用了。更多版本功能介绍请查看<a href=\"https://www.elastic.co/cn/subscriptions\" target=\"_blank\" rel=\"noopener\">官方版本订阅文档</a></p>\n</blockquote>\n<h2 id=\"下载elasticsearch\"><a href=\"#下载elasticsearch\" class=\"headerlink\" title=\"下载elasticsearch\"></a>下载elasticsearch</h2><p>上面提到X-Pack自6.4.2版本后已经内置到elasticsearch中，因此我们需要下载elasticsearch7.0.1最新版。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载elasticsearch.tar.gz</span></span><br><span class=\"line\">$ mkdir /elk &amp;&amp; <span class=\"built_in\">cd</span> /elk</span><br><span class=\"line\">$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.0.1-linux-x86_64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解压elasticsearch.tar.gz</span></span><br><span class=\"line\">$ tar zxvf elasticsearch-7.0.1-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure></p>\n<p>下载完成并且解压后，我们可以查看自带x-pack的模版。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看x-pack相关的模块</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> elasticsearch-7.0.1</span><br><span class=\"line\">$ ls modules/ | grep x-pack</span><br><span class=\"line\">x-pack-ccr</span><br><span class=\"line\">x-pack-core</span><br><span class=\"line\">x-pack-deprecation</span><br><span class=\"line\">x-pack-graph</span><br><span class=\"line\">x-pack-ilm</span><br><span class=\"line\">x-pack-logstash</span><br><span class=\"line\">x-pack-ml</span><br><span class=\"line\">x-pack-monitoring</span><br><span class=\"line\">x-pack-rollup</span><br><span class=\"line\">x-pack-security</span><br><span class=\"line\">x-pack-sql</span><br><span class=\"line\">x-pack-watcher</span><br></pre></td></tr></table></figure></p>\n<p>我们需要破解的<code>x-pack-core.7.0.1.jar</code>也就位于x-pack-core目录下<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ls /elk/elasticsearch-7.0.1/modules/x-pack-core | grep x-pack</span><br><span class=\"line\">x-pack-core-7.0.1.jar</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"下载反编译工具Luyten\"><a href=\"#下载反编译工具Luyten\" class=\"headerlink\" title=\"下载反编译工具Luyten\"></a>下载反编译工具Luyten</h2><p>破解X-Pack-core-7.0.1.jar需要反编译工具Luyten，我们可以前往<a href=\"https://github.com/deathmarine/Luyten/releases\" target=\"_blank\" rel=\"noopener\">下载地址</a>下载Luyten工具。<br>我们这里下载Luyten.exe windows版本，下载下来后打开，并将<code>x-pack-core.7.0.1.jar</code>文件拖进去，即可展开jar包的源代码了。</p>\n<h2 id=\"修改X-Pack源码文件\"><a href=\"#修改X-Pack源码文件\" class=\"headerlink\" title=\"修改X-Pack源码文件\"></a>修改X-Pack源码文件</h2><p>在Luyten工具中我们需要把2个文件提取出来进行修改。<code>org.elasticsearch.license.LicenseVerifier</code>和<code>org.elasticsearch.xpack.core.XPackBuild</code>。</p>\n<h3 id=\"修改LicenseVerifier-java\"><a href=\"#修改LicenseVerifier-java\" class=\"headerlink\" title=\"修改LicenseVerifier.java\"></a>修改LicenseVerifier.java</h3><p><code>LicenseVerifier</code>中有两个静态方法，这就是验证授权文件是否有效的方法，我们把它修改为全部返回true.<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*如下代码为修改完后的代码,我们这里使用注释将不需要的代码注释掉*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> org.elasticsearch.license;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.elasticsearch.common.bytes.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.elasticsearch.common.xcontent.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.lucene.util.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.elasticsearch.core.internal.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LicenseVerifier</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> <span class=\"title\">verifyLicense</span><span class=\"params\">(<span class=\"keyword\">final</span> License license, <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] publicKeyData)</span> </span>&#123;</span><br><span class=\"line\"> <span class=\"comment\">/*       </span></span><br><span class=\"line\"><span class=\"comment\">        byte[] signedContent = null;</span></span><br><span class=\"line\"><span class=\"comment\">        byte[] publicKeyFingerprint = null;</span></span><br><span class=\"line\"><span class=\"comment\">        try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">            final byte[] signatureBytes = Base64.getDecoder().decode(license.signature());</span></span><br><span class=\"line\"><span class=\"comment\">            final ByteBuffer byteBuffer = ByteBuffer.wrap(signatureBytes);</span></span><br><span class=\"line\"><span class=\"comment\">            final int version = byteBuffer.getInt();</span></span><br><span class=\"line\"><span class=\"comment\">            final int magicLen = byteBuffer.getInt();</span></span><br><span class=\"line\"><span class=\"comment\">            final byte[] magic = new byte[magicLen];</span></span><br><span class=\"line\"><span class=\"comment\">            byteBuffer.get(magic);</span></span><br><span class=\"line\"><span class=\"comment\">            final int hashLen = byteBuffer.getInt();</span></span><br><span class=\"line\"><span class=\"comment\">            publicKeyFingerprint = new byte[hashLen];</span></span><br><span class=\"line\"><span class=\"comment\">            byteBuffer.get(publicKeyFingerprint);</span></span><br><span class=\"line\"><span class=\"comment\">            final int signedContentLen = byteBuffer.getInt();</span></span><br><span class=\"line\"><span class=\"comment\">            signedContent = new byte[signedContentLen];</span></span><br><span class=\"line\"><span class=\"comment\">            byteBuffer.get(signedContent);</span></span><br><span class=\"line\"><span class=\"comment\">            final XContentBuilder contentBuilder = XContentFactory.contentBuilder(XContentType.JSON);</span></span><br><span class=\"line\"><span class=\"comment\">            license.toXContent(contentBuilder, (ToXContent.Params)new ToXContent.MapParams((Map)Collections.singletonMap(\"license_spec_view\", \"true\")));</span></span><br><span class=\"line\"><span class=\"comment\">            final Signature rsa = Signature.getInstance(\"SHA512withRSA\");</span></span><br><span class=\"line\"><span class=\"comment\">            rsa.initVerify(CryptUtils.readPublicKey(publicKeyData));</span></span><br><span class=\"line\"><span class=\"comment\">            final BytesRefIterator iterator = BytesReference.bytes(contentBuilder).iterator();</span></span><br><span class=\"line\"><span class=\"comment\">            BytesRef ref;</span></span><br><span class=\"line\"><span class=\"comment\">            while ((ref = iterator.next()) != null) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                rsa.update(ref.bytes, ref.offset, ref.length);</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">            return rsa.verify(signedContent);</span></span><br><span class=\"line\"><span class=\"comment\">        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        catch (IOException ex) &#123;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">        catch (NoSuchAlgorithmException ex2) &#123;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">        catch (SignatureException ex3) &#123;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">        catch (InvalidKeyException e) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">            throw new IllegalStateException(e);</span></span><br><span class=\"line\"><span class=\"comment\">        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        finally &#123;</span></span><br><span class=\"line\"><span class=\"comment\">            if (signedContent != null) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                Arrays.fill(signedContent, (byte)0);</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> <span class=\"title\">verifyLicense</span><span class=\"params\">(<span class=\"keyword\">final</span> License license)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        byte[] publicKeyBytes;</span></span><br><span class=\"line\"><span class=\"comment\">        try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">            final InputStream is = LicenseVerifier.class.getResourceAsStream(\"/public.key\");</span></span><br><span class=\"line\"><span class=\"comment\">            try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                final ByteArrayOutputStream out = new ByteArrayOutputStream();</span></span><br><span class=\"line\"><span class=\"comment\">                Streams.copy(is, (OutputStream)out);</span></span><br><span class=\"line\"><span class=\"comment\">                publicKeyBytes = out.toByteArray();</span></span><br><span class=\"line\"><span class=\"comment\">                if (is != null) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                    is.close();</span></span><br><span class=\"line\"><span class=\"comment\">                &#125;</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">            catch (Throwable t) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                if (is != null) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                    try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                        is.close();</span></span><br><span class=\"line\"><span class=\"comment\">                    &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                    catch (Throwable t2) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                        t.addSuppressed(t2);</span></span><br><span class=\"line\"><span class=\"comment\">                    &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                throw t;</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        catch (IOException ex) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">            throw new IllegalStateException(ex);</span></span><br><span class=\"line\"><span class=\"comment\">        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        //return verifyLicense(license, publicKeyBytes);</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"修改XPackBuild-java\"><a href=\"#修改XPackBuild-java\" class=\"headerlink\" title=\"修改XPackBuild.java\"></a>修改XPackBuild.java</h3><p><code>XPackBuild</code>中最后一个静态代码块中 try的部分全部删除，这部分会验证jar包是否被修改.<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*如下代码为修改完后的代码,我们这里使用注释将不需要的代码注释掉*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> org.elasticsearch.xpack.core;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.elasticsearch.common.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.elasticsearch.common.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.jar.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">XPackBuild</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> XPackBuild CURRENT;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String shortHash;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String date;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"meta\">@SuppressForbidden</span>(reason = <span class=\"string\">\"looks up path of xpack.jar directly\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">static</span> Path <span class=\"title\">getElasticsearchCodebase</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> URL url = XPackBuild.class.getProtectionDomain().getCodeSource().getLocation();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> PathUtils.get(url.toURI());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">catch</span> (URISyntaxException bogus) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(bogus);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    XPackBuild(<span class=\"keyword\">final</span> String shortHash, <span class=\"keyword\">final</span> String date) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.shortHash = shortHash;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.date = date;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">shortHash</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.shortHash;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">date</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.date;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Path path = getElasticsearchCodebase();</span><br><span class=\"line\">        String shortHash = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        String date = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Label_0109: &#123;</span><br><span class=\"line\"><span class=\"comment\">/*            if (path.toString().endsWith(\".jar\")) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                    final JarInputStream jar = new JarInputStream(Files.newInputStream(path, new OpenOption[0]));</span></span><br><span class=\"line\"><span class=\"comment\">                    try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                        final Manifest manifest = jar.getManifest();</span></span><br><span class=\"line\"><span class=\"comment\">                        shortHash = manifest.getMainAttributes().getValue(\"Change\");</span></span><br><span class=\"line\"><span class=\"comment\">                        date = manifest.getMainAttributes().getValue(\"Build-Date\");</span></span><br><span class=\"line\"><span class=\"comment\">                        jar.close();</span></span><br><span class=\"line\"><span class=\"comment\">                    &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                    catch (Throwable t) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                        try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                            jar.close();</span></span><br><span class=\"line\"><span class=\"comment\">                        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                        catch (Throwable t2) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                            t.addSuppressed(t2);</span></span><br><span class=\"line\"><span class=\"comment\">                        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                        throw t;</span></span><br><span class=\"line\"><span class=\"comment\">                    &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                    break Label_0109;</span></span><br><span class=\"line\"><span class=\"comment\">                &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                catch (IOException e) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                    throw new RuntimeException(e);</span></span><br><span class=\"line\"><span class=\"comment\">                &#125;</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\">            shortHash = <span class=\"string\">\"Unknown\"</span>;</span><br><span class=\"line\">            date = <span class=\"string\">\"Unknown\"</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        CURRENT = <span class=\"keyword\">new</span> XPackBuild(shortHash, date);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"生成-class文件\"><a href=\"#生成-class文件\" class=\"headerlink\" title=\"生成.class文件\"></a>生成.class文件</h2><p>上述<code>LicenseVerifier.java</code>和<code>XPackBuild.java</code>两个文件在本地电脑windows修改完成后，我们需要将其复制到elasticsearch服务器上并编译成class文件，然后打包到x-pack-core-7.0.1.jar中。我们这里将这2个文件放到了/root目录下。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编译LicenseVerifier.java</span></span><br><span class=\"line\">$ javac -cp <span class=\"string\">\"/elk/elasticsearch-7.0.1/lib/elasticsearch-7.0.1.jar:/elk/elasticsearch-7.0.1/lib/lucene-core-8.0.0.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/netty-common-4.1.32.Final.jar:/elk/elasticsearch-7.0.1/lib/elasticsearch-core-7.0.1.jar\"</span> /root/LicenseVerifier.java</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编译XPackBuild.java</span></span><br><span class=\"line\">$ javac -cp <span class=\"string\">\"/elk/elasticsearch-7.0.1/lib/elasticsearch-7.0.1.jar:/elk/elasticsearch-7.0.1/lib/lucene-core-8.0.0.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/netty-common-4.1.32.Final.jar:/elk/elasticsearch-7.0.1/lib/elasticsearch-core-7.0.1.jar\"</span> /root/XPackBuild.java</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看编译后的文件</span></span><br><span class=\"line\">$ ls /root | grep .class</span><br><span class=\"line\">LicenseVerifier.class</span><br><span class=\"line\">XPackBuild.class</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"替换LicenseVerifier-class和XPackBuild-class\"><a href=\"#替换LicenseVerifier-class和XPackBuild-class\" class=\"headerlink\" title=\"替换LicenseVerifier.class和XPackBuild.class\"></a>替换LicenseVerifier.class和XPackBuild.class</h2><p>我们把<code>/elk/elasticsearch-7.0.1/modules/x-pack-core</code>目录下的<code>x-pack-core-7.0.1.jar</code>提取出来，放到一个临时的<code>/elk/x-pack</code>目录中。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cp /elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar /elk/x-pack</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> /elk/x-pack</span><br><span class=\"line\"><span class=\"comment\"># 解压x-pack-core-7.0.1.jar</span></span><br><span class=\"line\">$ jar -xvf x-pack-core-7.0.1.jar</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 替换.class文件</span></span><br><span class=\"line\">$ cp /root/XPackBuild.class /elk/x-pack/org/elasticsearch/xpack/core/</span><br><span class=\"line\">$ cp /root/LicenseVerifier.class /elk/x-pack/org/elasticsearch/license/</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"打包新x-pack-core-7-0-1-jar文件\"><a href=\"#打包新x-pack-core-7-0-1-jar文件\" class=\"headerlink\" title=\"打包新x-pack-core-7.0.1.jar文件\"></a>打包新x-pack-core-7.0.1.jar文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> /elk/x-pack</span><br><span class=\"line\">$ rm -rf x-pack-core-7.0.1.jar   <span class=\"comment\"># 删除临时拷贝过来的源文件</span></span><br><span class=\"line\">$ jar cvf x-pack-core-7.0.1.jar .</span><br></pre></td></tr></table></figure>\n<p>至此在/elk/x-pack目录下会新生成一个<code>x-pack-core-7.0.1.jar</code>文件。也就是破解后的文件。</p>\n<h2 id=\"替换x-pack-core-7-0-1-jar文件\"><a href=\"#替换x-pack-core-7-0-1-jar文件\" class=\"headerlink\" title=\"替换x-pack-core-7.0.1.jar文件\"></a>替换x-pack-core-7.0.1.jar文件</h2><p>我们将新生成的x-pack-core-7.0.1.jar文件文件替换掉源x-pack-core-7.0.1.jar文件。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp /elk/x-pack/x-pack-core-7.0.1.jar /elk/elasticsearch-7.0.1/modules/x-pack-core/</span><br><span class=\"line\">rm -rf /elk/x-pack  <span class=\"comment\"># 完成文件替换后该目录既可以删除了</span></span><br><span class=\"line\">``` </span><br><span class=\"line\"><span class=\"comment\">## 申请License</span></span><br><span class=\"line\">完成以上步骤后，我们还需要去elastic官网申请一个license, [License申请地址](https://license.elastic.co/registration)，申请完成后，下载下来的License格式为json格式。并将该License的`<span class=\"built_in\">type</span>`、`expiry_date_in_millis`、`max_nodes`分别修改成`platinum`、`2524579200999`、`1000`。如下：</span><br><span class=\"line\">```json</span><br><span class=\"line\">&#123;<span class=\"string\">\"license\"</span>:</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"string\">\"uid\"</span>:<span class=\"string\">\"537c5c48-c1dd-43ea-ab69-68d209d80c32\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"type\"</span>:<span class=\"string\">\"platinum\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"issue_date_in_millis\"</span>:1558051200000,</span><br><span class=\"line\">        <span class=\"string\">\"expiry_date_in_millis\"</span>:2524579200999,</span><br><span class=\"line\">        <span class=\"string\">\"max_nodes\"</span>:1000,</span><br><span class=\"line\">        <span class=\"string\">\"issued_to\"</span>:<span class=\"string\">\"pyker\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"issuer\"</span>:<span class=\"string\">\"Web Form\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"signature\"</span>:<span class=\"string\">\"AAAAAwAAAA3fIq7NLN3Blk2olVjbAAABmC9ZN0hjZDBGYnVyRXpCOW5Bb3FjZDAxOWpSbTVoMVZwUzRxVk1PSmkxaktJRVl5MUYvUWh3bHZVUTllbXNPbzBUemtnbWpBbmlWRmRZb25KNFlBR2x0TXc2K2p1Y1VtMG1UQU9TRGZVSGRwaEJGUjE3bXd3LzRqZ05iLzRteWFNekdxRGpIYlFwYkJiNUs0U1hTVlJKNVlXekMrSlVUdFIvV0FNeWdOYnlESDc3MWhlY3hSQmdKSjJ2ZTcvYlBFOHhPQlV3ZHdDQ0tHcG5uOElCaDJ4K1hob29xSG85N0kvTWV3THhlQk9NL01VMFRjNDZpZEVXeUtUMXIyMlIveFpJUkk2WUdveEZaME9XWitGUi9WNTZVQW1FMG1DenhZU0ZmeXlZakVEMjZFT2NvOWxpZGlqVmlHNC8rWVVUYzMwRGVySHpIdURzKzFiRDl4TmM1TUp2VTBOUlJZUlAyV0ZVL2kvVk10L0NsbXNFYVZwT3NSU082dFNNa2prQ0ZsclZ4NTltbU1CVE5lR09Bck93V2J1Y3c9PQAAAQCjNd8mwy8B1sm9rGrgTmN2Gjm/lxqfnTEpTc+HOEmAgwQ7Q1Ye/FSGVNIU/enZ5cqSzWS2mY8oZ7FM/7UPKVQ4hkarWn2qye964MW+cux54h7dqxlSB19fG0ZJOJZxxwVxxi8iyJPUSQBa+QN8m7TFkK2kVmP+HnhU7mGUrqXt3zTk5d3pZw3QBQ/Rr3wmSYC5pxV6/o2UHFgu1OPDcX+kEb+UZtMrVNneR+cEwyx7o5Bg3rbKC014T+lMtt69Y080JDI5KfHa7e9Ul0c3rozIL975fP45dU175D4PKZy98cvHJgtsCJF3K8XUZKo2lOcbsWzhK2mZ5kFp0BMXF3Hs\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"start_date_in_millis\"</span>:1558051200000</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>我们将过期时间写到2050年，type改为platinum 白金版，这样我们就会拥有全部的x-pack功能。</p>\n<h2 id=\"配置elasticsearch安全协议\"><a href=\"#配置elasticsearch安全协议\" class=\"headerlink\" title=\"配置elasticsearch安全协议\"></a>配置elasticsearch安全协议</h2><p>完成以上所有操作在启动elasticsearch前，我们需要配置elasticsearch的SSL/TLS安全协议,如果不配置的话，需要禁止security才能配置License。当License配置完成后我们需要再开启security，并开启SSL\\TLS。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载License到elasticsearch之前操作</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"xpack.security.enabled: false\"</span> &gt;&gt; /elk/elasticsearch-7.0.1/config/elasticsearch.yml</span><br><span class=\"line\">$ ./bin/elasticsearch -d   <span class=\"comment\"># 后台方式启动elasticsearch</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 加载License到elasticsearch之后操作</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"xpack.security.transport.ssl.enabled: true\"</span> &gt;&gt; /elk/elasticsearch-7.0.1/config/elasticsearch.yml</span><br><span class=\"line\">$ sed -i <span class=\"string\">'s/xpack.security.enabled: false/xpack.security.enabled: true/g'</span> /elk/elasticsearch-7.0.1/config/elasticsearch.yml</span><br><span class=\"line\">$ <span class=\"built_in\">kill</span> -9 13023 &amp;&amp; ./bin/elasticsearch -d   <span class=\"comment\"># 重启elasticsearch</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"加载License到elasticsearch\"><a href=\"#加载License到elasticsearch\" class=\"headerlink\" title=\"加载License到elasticsearch\"></a>加载License到elasticsearch</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl -XPUT -u elastic <span class=\"string\">'http://192.168.20.210:9200/_xpack/license'</span> -H <span class=\"string\">\"Content-Type: application/json\"</span> -d @license.json</span><br><span class=\"line\">Enter host password <span class=\"keyword\">for</span> user <span class=\"string\">'elastic'</span>:           <span class=\"comment\"># 提示输入elastic用户密码，当前无密码，所以直接回车</span></span><br><span class=\"line\">&#123;<span class=\"string\">\"acknowledged\"</span>:<span class=\"literal\">true</span>,<span class=\"string\">\"license_status\"</span>:<span class=\"string\">\"valid\"</span>&#125;    <span class=\"comment\"># license写入成功</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"查看License\"><a href=\"#查看License\" class=\"headerlink\" title=\"查看License\"></a>查看License</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl -XGET -u elastic:tWbWZc7NE3wYqS6DvSu4 http://192.168.20.210:9200/_license</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"license\"</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">\"status\"</span> : <span class=\"string\">\"active\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"uid\"</span> : <span class=\"string\">\"537c5c48-c1dd-43ea-ab69-68d209d80c32\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"type\"</span> : <span class=\"string\">\"platinum\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"issue_date\"</span> : <span class=\"string\">\"2019-05-17T00:00:00.000Z\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"issue_date_in_millis\"</span> : 1558051200000,</span><br><span class=\"line\">    <span class=\"string\">\"expiry_date\"</span> : <span class=\"string\">\"2049-12-31T16:00:00.999Z\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"expiry_date_in_millis\"</span> : 2524579200999,</span><br><span class=\"line\">    <span class=\"string\">\"max_nodes\"</span> : 1000,</span><br><span class=\"line\">    <span class=\"string\">\"issued_to\"</span> : <span class=\"string\">\"pyker\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"issuer\"</span> : <span class=\"string\">\"Web Form\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"start_date_in_millis\"</span> : 1558051200000</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>由结果可以看出x-pack到期时间为2049-12-31，破解完成。也可以在kibana web页面<code>管理</code>中查看破解详情。<br><img src=\"/images/pic/x-pack.png\" alt></p>\n<h2 id=\"设置密码\"><a href=\"#设置密码\" class=\"headerlink\" title=\"设置密码\"></a>设置密码</h2><p>现在我们可以使用<code>x-pack铂金版</code>的所有功能了，例如密码安全验证功能。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ./bin/elasticsearch-setup-passwords auto</span><br><span class=\"line\"></span><br><span class=\"line\">Initiating the setup of passwords <span class=\"keyword\">for</span> reserved users elastic,apm_system,kibana,logstash_system,beats_system,remote_monitoring_user.</span><br><span class=\"line\">The passwords will be randomly generated and printed to the console.</span><br><span class=\"line\">Please confirm that you would like to <span class=\"built_in\">continue</span> [y/N]y</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user apm_system</span><br><span class=\"line\">PASSWORD apm_system = 24UtJKbNI1UqHUQkKPZY</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user kibana</span><br><span class=\"line\">PASSWORD kibana = 8SSZMisIY0NZFMCS6wv9</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user logstash_system</span><br><span class=\"line\">PASSWORD logstash_system = rFhWkYzayIUZVl8VIunJ</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user beats_system</span><br><span class=\"line\">PASSWORD beats_system = U1B4O5SKrSEatqDQRsQz</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user remote_monitoring_user</span><br><span class=\"line\">PASSWORD remote_monitoring_user = zdpj7HqO02yRXZR9Bwa2</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user elastic</span><br><span class=\"line\">PASSWORD elastic = tWbWZc7NE3wYqS6DvSu4</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"length":13097,"excerpt":"","more":"<blockquote>\n<p><strong>说明： elastic官方在elastic stack 6.4.2版本后就在elasticsearch中内置了X-Pack工具，因此下文破解X-Pack7.0.1的版本也是对应elastic stack7.0.1的版本。而X-Pack内置在elasticsearch包中，以下所有操作都是针对elasticsearch7.0.1包中进行的。</strong></p>\n</blockquote>\n<h2 id=\"X-Pack是什么\"><a href=\"#X-Pack是什么\" class=\"headerlink\" title=\"X-Pack是什么\"></a>X-Pack是什么</h2><p>X-pack是elasticsearch的一个扩展包，将安全，警告，监视，图形和报告功能捆绑在一个易于安装的软件包中，虽然x-pack被设计为一个无缝的工作，但是你可以轻松的启用或者关闭一些功能。</p>\n<blockquote>\n<p>目前6.2及以下版本只能使用免费版，然而免费版的功能相当少。X-pack 的破解基本思路是先安装正常版本，之后替换破解的jar包来实现，目前只能破解到白金版，但已经够用了。更多版本功能介绍请查看<a href=\"https://www.elastic.co/cn/subscriptions\" target=\"_blank\" rel=\"noopener\">官方版本订阅文档</a></p>\n</blockquote>\n<h2 id=\"下载elasticsearch\"><a href=\"#下载elasticsearch\" class=\"headerlink\" title=\"下载elasticsearch\"></a>下载elasticsearch</h2><p>上面提到X-Pack自6.4.2版本后已经内置到elasticsearch中，因此我们需要下载elasticsearch7.0.1最新版。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载elasticsearch.tar.gz</span></span><br><span class=\"line\">$ mkdir /elk &amp;&amp; <span class=\"built_in\">cd</span> /elk</span><br><span class=\"line\">$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.0.1-linux-x86_64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解压elasticsearch.tar.gz</span></span><br><span class=\"line\">$ tar zxvf elasticsearch-7.0.1-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure></p>\n<p>下载完成并且解压后，我们可以查看自带x-pack的模版。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看x-pack相关的模块</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> elasticsearch-7.0.1</span><br><span class=\"line\">$ ls modules/ | grep x-pack</span><br><span class=\"line\">x-pack-ccr</span><br><span class=\"line\">x-pack-core</span><br><span class=\"line\">x-pack-deprecation</span><br><span class=\"line\">x-pack-graph</span><br><span class=\"line\">x-pack-ilm</span><br><span class=\"line\">x-pack-logstash</span><br><span class=\"line\">x-pack-ml</span><br><span class=\"line\">x-pack-monitoring</span><br><span class=\"line\">x-pack-rollup</span><br><span class=\"line\">x-pack-security</span><br><span class=\"line\">x-pack-sql</span><br><span class=\"line\">x-pack-watcher</span><br></pre></td></tr></table></figure></p>\n<p>我们需要破解的<code>x-pack-core.7.0.1.jar</code>也就位于x-pack-core目录下<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ls /elk/elasticsearch-7.0.1/modules/x-pack-core | grep x-pack</span><br><span class=\"line\">x-pack-core-7.0.1.jar</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"下载反编译工具Luyten\"><a href=\"#下载反编译工具Luyten\" class=\"headerlink\" title=\"下载反编译工具Luyten\"></a>下载反编译工具Luyten</h2><p>破解X-Pack-core-7.0.1.jar需要反编译工具Luyten，我们可以前往<a href=\"https://github.com/deathmarine/Luyten/releases\" target=\"_blank\" rel=\"noopener\">下载地址</a>下载Luyten工具。<br>我们这里下载Luyten.exe windows版本，下载下来后打开，并将<code>x-pack-core.7.0.1.jar</code>文件拖进去，即可展开jar包的源代码了。</p>\n<h2 id=\"修改X-Pack源码文件\"><a href=\"#修改X-Pack源码文件\" class=\"headerlink\" title=\"修改X-Pack源码文件\"></a>修改X-Pack源码文件</h2><p>在Luyten工具中我们需要把2个文件提取出来进行修改。<code>org.elasticsearch.license.LicenseVerifier</code>和<code>org.elasticsearch.xpack.core.XPackBuild</code>。</p>\n<h3 id=\"修改LicenseVerifier-java\"><a href=\"#修改LicenseVerifier-java\" class=\"headerlink\" title=\"修改LicenseVerifier.java\"></a>修改LicenseVerifier.java</h3><p><code>LicenseVerifier</code>中有两个静态方法，这就是验证授权文件是否有效的方法，我们把它修改为全部返回true.<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*如下代码为修改完后的代码,我们这里使用注释将不需要的代码注释掉*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> org.elasticsearch.license;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.elasticsearch.common.bytes.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.elasticsearch.common.xcontent.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.lucene.util.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.elasticsearch.core.internal.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LicenseVerifier</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> <span class=\"title\">verifyLicense</span><span class=\"params\">(<span class=\"keyword\">final</span> License license, <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] publicKeyData)</span> </span>&#123;</span><br><span class=\"line\"> <span class=\"comment\">/*       </span></span><br><span class=\"line\"><span class=\"comment\">        byte[] signedContent = null;</span></span><br><span class=\"line\"><span class=\"comment\">        byte[] publicKeyFingerprint = null;</span></span><br><span class=\"line\"><span class=\"comment\">        try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">            final byte[] signatureBytes = Base64.getDecoder().decode(license.signature());</span></span><br><span class=\"line\"><span class=\"comment\">            final ByteBuffer byteBuffer = ByteBuffer.wrap(signatureBytes);</span></span><br><span class=\"line\"><span class=\"comment\">            final int version = byteBuffer.getInt();</span></span><br><span class=\"line\"><span class=\"comment\">            final int magicLen = byteBuffer.getInt();</span></span><br><span class=\"line\"><span class=\"comment\">            final byte[] magic = new byte[magicLen];</span></span><br><span class=\"line\"><span class=\"comment\">            byteBuffer.get(magic);</span></span><br><span class=\"line\"><span class=\"comment\">            final int hashLen = byteBuffer.getInt();</span></span><br><span class=\"line\"><span class=\"comment\">            publicKeyFingerprint = new byte[hashLen];</span></span><br><span class=\"line\"><span class=\"comment\">            byteBuffer.get(publicKeyFingerprint);</span></span><br><span class=\"line\"><span class=\"comment\">            final int signedContentLen = byteBuffer.getInt();</span></span><br><span class=\"line\"><span class=\"comment\">            signedContent = new byte[signedContentLen];</span></span><br><span class=\"line\"><span class=\"comment\">            byteBuffer.get(signedContent);</span></span><br><span class=\"line\"><span class=\"comment\">            final XContentBuilder contentBuilder = XContentFactory.contentBuilder(XContentType.JSON);</span></span><br><span class=\"line\"><span class=\"comment\">            license.toXContent(contentBuilder, (ToXContent.Params)new ToXContent.MapParams((Map)Collections.singletonMap(\"license_spec_view\", \"true\")));</span></span><br><span class=\"line\"><span class=\"comment\">            final Signature rsa = Signature.getInstance(\"SHA512withRSA\");</span></span><br><span class=\"line\"><span class=\"comment\">            rsa.initVerify(CryptUtils.readPublicKey(publicKeyData));</span></span><br><span class=\"line\"><span class=\"comment\">            final BytesRefIterator iterator = BytesReference.bytes(contentBuilder).iterator();</span></span><br><span class=\"line\"><span class=\"comment\">            BytesRef ref;</span></span><br><span class=\"line\"><span class=\"comment\">            while ((ref = iterator.next()) != null) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                rsa.update(ref.bytes, ref.offset, ref.length);</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">            return rsa.verify(signedContent);</span></span><br><span class=\"line\"><span class=\"comment\">        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        catch (IOException ex) &#123;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">        catch (NoSuchAlgorithmException ex2) &#123;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">        catch (SignatureException ex3) &#123;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">        catch (InvalidKeyException e) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">            throw new IllegalStateException(e);</span></span><br><span class=\"line\"><span class=\"comment\">        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        finally &#123;</span></span><br><span class=\"line\"><span class=\"comment\">            if (signedContent != null) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                Arrays.fill(signedContent, (byte)0);</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> <span class=\"title\">verifyLicense</span><span class=\"params\">(<span class=\"keyword\">final</span> License license)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        byte[] publicKeyBytes;</span></span><br><span class=\"line\"><span class=\"comment\">        try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">            final InputStream is = LicenseVerifier.class.getResourceAsStream(\"/public.key\");</span></span><br><span class=\"line\"><span class=\"comment\">            try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                final ByteArrayOutputStream out = new ByteArrayOutputStream();</span></span><br><span class=\"line\"><span class=\"comment\">                Streams.copy(is, (OutputStream)out);</span></span><br><span class=\"line\"><span class=\"comment\">                publicKeyBytes = out.toByteArray();</span></span><br><span class=\"line\"><span class=\"comment\">                if (is != null) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                    is.close();</span></span><br><span class=\"line\"><span class=\"comment\">                &#125;</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">            catch (Throwable t) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                if (is != null) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                    try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                        is.close();</span></span><br><span class=\"line\"><span class=\"comment\">                    &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                    catch (Throwable t2) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                        t.addSuppressed(t2);</span></span><br><span class=\"line\"><span class=\"comment\">                    &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                throw t;</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        catch (IOException ex) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">            throw new IllegalStateException(ex);</span></span><br><span class=\"line\"><span class=\"comment\">        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        //return verifyLicense(license, publicKeyBytes);</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"修改XPackBuild-java\"><a href=\"#修改XPackBuild-java\" class=\"headerlink\" title=\"修改XPackBuild.java\"></a>修改XPackBuild.java</h3><p><code>XPackBuild</code>中最后一个静态代码块中 try的部分全部删除，这部分会验证jar包是否被修改.<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*如下代码为修改完后的代码,我们这里使用注释将不需要的代码注释掉*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> org.elasticsearch.xpack.core;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.elasticsearch.common.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.elasticsearch.common.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.jar.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">XPackBuild</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> XPackBuild CURRENT;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String shortHash;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String date;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"meta\">@SuppressForbidden</span>(reason = <span class=\"string\">\"looks up path of xpack.jar directly\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">static</span> Path <span class=\"title\">getElasticsearchCodebase</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> URL url = XPackBuild.class.getProtectionDomain().getCodeSource().getLocation();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> PathUtils.get(url.toURI());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">catch</span> (URISyntaxException bogus) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(bogus);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    XPackBuild(<span class=\"keyword\">final</span> String shortHash, <span class=\"keyword\">final</span> String date) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.shortHash = shortHash;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.date = date;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">shortHash</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.shortHash;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">date</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.date;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Path path = getElasticsearchCodebase();</span><br><span class=\"line\">        String shortHash = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        String date = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Label_0109: &#123;</span><br><span class=\"line\"><span class=\"comment\">/*            if (path.toString().endsWith(\".jar\")) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                    final JarInputStream jar = new JarInputStream(Files.newInputStream(path, new OpenOption[0]));</span></span><br><span class=\"line\"><span class=\"comment\">                    try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                        final Manifest manifest = jar.getManifest();</span></span><br><span class=\"line\"><span class=\"comment\">                        shortHash = manifest.getMainAttributes().getValue(\"Change\");</span></span><br><span class=\"line\"><span class=\"comment\">                        date = manifest.getMainAttributes().getValue(\"Build-Date\");</span></span><br><span class=\"line\"><span class=\"comment\">                        jar.close();</span></span><br><span class=\"line\"><span class=\"comment\">                    &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                    catch (Throwable t) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                        try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                            jar.close();</span></span><br><span class=\"line\"><span class=\"comment\">                        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                        catch (Throwable t2) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                            t.addSuppressed(t2);</span></span><br><span class=\"line\"><span class=\"comment\">                        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                        throw t;</span></span><br><span class=\"line\"><span class=\"comment\">                    &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                    break Label_0109;</span></span><br><span class=\"line\"><span class=\"comment\">                &#125;</span></span><br><span class=\"line\"><span class=\"comment\">                catch (IOException e) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                    throw new RuntimeException(e);</span></span><br><span class=\"line\"><span class=\"comment\">                &#125;</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\">            shortHash = <span class=\"string\">\"Unknown\"</span>;</span><br><span class=\"line\">            date = <span class=\"string\">\"Unknown\"</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        CURRENT = <span class=\"keyword\">new</span> XPackBuild(shortHash, date);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"生成-class文件\"><a href=\"#生成-class文件\" class=\"headerlink\" title=\"生成.class文件\"></a>生成.class文件</h2><p>上述<code>LicenseVerifier.java</code>和<code>XPackBuild.java</code>两个文件在本地电脑windows修改完成后，我们需要将其复制到elasticsearch服务器上并编译成class文件，然后打包到x-pack-core-7.0.1.jar中。我们这里将这2个文件放到了/root目录下。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编译LicenseVerifier.java</span></span><br><span class=\"line\">$ javac -cp <span class=\"string\">\"/elk/elasticsearch-7.0.1/lib/elasticsearch-7.0.1.jar:/elk/elasticsearch-7.0.1/lib/lucene-core-8.0.0.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/netty-common-4.1.32.Final.jar:/elk/elasticsearch-7.0.1/lib/elasticsearch-core-7.0.1.jar\"</span> /root/LicenseVerifier.java</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编译XPackBuild.java</span></span><br><span class=\"line\">$ javac -cp <span class=\"string\">\"/elk/elasticsearch-7.0.1/lib/elasticsearch-7.0.1.jar:/elk/elasticsearch-7.0.1/lib/lucene-core-8.0.0.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar:/elk/elasticsearch-7.0.1/modules/x-pack-core/netty-common-4.1.32.Final.jar:/elk/elasticsearch-7.0.1/lib/elasticsearch-core-7.0.1.jar\"</span> /root/XPackBuild.java</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看编译后的文件</span></span><br><span class=\"line\">$ ls /root | grep .class</span><br><span class=\"line\">LicenseVerifier.class</span><br><span class=\"line\">XPackBuild.class</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"替换LicenseVerifier-class和XPackBuild-class\"><a href=\"#替换LicenseVerifier-class和XPackBuild-class\" class=\"headerlink\" title=\"替换LicenseVerifier.class和XPackBuild.class\"></a>替换LicenseVerifier.class和XPackBuild.class</h2><p>我们把<code>/elk/elasticsearch-7.0.1/modules/x-pack-core</code>目录下的<code>x-pack-core-7.0.1.jar</code>提取出来，放到一个临时的<code>/elk/x-pack</code>目录中。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cp /elk/elasticsearch-7.0.1/modules/x-pack-core/x-pack-core-7.0.1.jar /elk/x-pack</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> /elk/x-pack</span><br><span class=\"line\"><span class=\"comment\"># 解压x-pack-core-7.0.1.jar</span></span><br><span class=\"line\">$ jar -xvf x-pack-core-7.0.1.jar</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 替换.class文件</span></span><br><span class=\"line\">$ cp /root/XPackBuild.class /elk/x-pack/org/elasticsearch/xpack/core/</span><br><span class=\"line\">$ cp /root/LicenseVerifier.class /elk/x-pack/org/elasticsearch/license/</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"打包新x-pack-core-7-0-1-jar文件\"><a href=\"#打包新x-pack-core-7-0-1-jar文件\" class=\"headerlink\" title=\"打包新x-pack-core-7.0.1.jar文件\"></a>打包新x-pack-core-7.0.1.jar文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> /elk/x-pack</span><br><span class=\"line\">$ rm -rf x-pack-core-7.0.1.jar   <span class=\"comment\"># 删除临时拷贝过来的源文件</span></span><br><span class=\"line\">$ jar cvf x-pack-core-7.0.1.jar .</span><br></pre></td></tr></table></figure>\n<p>至此在/elk/x-pack目录下会新生成一个<code>x-pack-core-7.0.1.jar</code>文件。也就是破解后的文件。</p>\n<h2 id=\"替换x-pack-core-7-0-1-jar文件\"><a href=\"#替换x-pack-core-7-0-1-jar文件\" class=\"headerlink\" title=\"替换x-pack-core-7.0.1.jar文件\"></a>替换x-pack-core-7.0.1.jar文件</h2><p>我们将新生成的x-pack-core-7.0.1.jar文件文件替换掉源x-pack-core-7.0.1.jar文件。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp /elk/x-pack/x-pack-core-7.0.1.jar /elk/elasticsearch-7.0.1/modules/x-pack-core/</span><br><span class=\"line\">rm -rf /elk/x-pack  <span class=\"comment\"># 完成文件替换后该目录既可以删除了</span></span><br><span class=\"line\">``` </span><br><span class=\"line\"><span class=\"comment\">## 申请License</span></span><br><span class=\"line\">完成以上步骤后，我们还需要去elastic官网申请一个license, [License申请地址](https://license.elastic.co/registration)，申请完成后，下载下来的License格式为json格式。并将该License的`<span class=\"built_in\">type</span>`、`expiry_date_in_millis`、`max_nodes`分别修改成`platinum`、`2524579200999`、`1000`。如下：</span><br><span class=\"line\">```json</span><br><span class=\"line\">&#123;<span class=\"string\">\"license\"</span>:</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"string\">\"uid\"</span>:<span class=\"string\">\"537c5c48-c1dd-43ea-ab69-68d209d80c32\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"type\"</span>:<span class=\"string\">\"platinum\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"issue_date_in_millis\"</span>:1558051200000,</span><br><span class=\"line\">        <span class=\"string\">\"expiry_date_in_millis\"</span>:2524579200999,</span><br><span class=\"line\">        <span class=\"string\">\"max_nodes\"</span>:1000,</span><br><span class=\"line\">        <span class=\"string\">\"issued_to\"</span>:<span class=\"string\">\"pyker\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"issuer\"</span>:<span class=\"string\">\"Web Form\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"signature\"</span>:<span class=\"string\">\"AAAAAwAAAA3fIq7NLN3Blk2olVjbAAABmC9ZN0hjZDBGYnVyRXpCOW5Bb3FjZDAxOWpSbTVoMVZwUzRxVk1PSmkxaktJRVl5MUYvUWh3bHZVUTllbXNPbzBUemtnbWpBbmlWRmRZb25KNFlBR2x0TXc2K2p1Y1VtMG1UQU9TRGZVSGRwaEJGUjE3bXd3LzRqZ05iLzRteWFNekdxRGpIYlFwYkJiNUs0U1hTVlJKNVlXekMrSlVUdFIvV0FNeWdOYnlESDc3MWhlY3hSQmdKSjJ2ZTcvYlBFOHhPQlV3ZHdDQ0tHcG5uOElCaDJ4K1hob29xSG85N0kvTWV3THhlQk9NL01VMFRjNDZpZEVXeUtUMXIyMlIveFpJUkk2WUdveEZaME9XWitGUi9WNTZVQW1FMG1DenhZU0ZmeXlZakVEMjZFT2NvOWxpZGlqVmlHNC8rWVVUYzMwRGVySHpIdURzKzFiRDl4TmM1TUp2VTBOUlJZUlAyV0ZVL2kvVk10L0NsbXNFYVZwT3NSU082dFNNa2prQ0ZsclZ4NTltbU1CVE5lR09Bck93V2J1Y3c9PQAAAQCjNd8mwy8B1sm9rGrgTmN2Gjm/lxqfnTEpTc+HOEmAgwQ7Q1Ye/FSGVNIU/enZ5cqSzWS2mY8oZ7FM/7UPKVQ4hkarWn2qye964MW+cux54h7dqxlSB19fG0ZJOJZxxwVxxi8iyJPUSQBa+QN8m7TFkK2kVmP+HnhU7mGUrqXt3zTk5d3pZw3QBQ/Rr3wmSYC5pxV6/o2UHFgu1OPDcX+kEb+UZtMrVNneR+cEwyx7o5Bg3rbKC014T+lMtt69Y080JDI5KfHa7e9Ul0c3rozIL975fP45dU175D4PKZy98cvHJgtsCJF3K8XUZKo2lOcbsWzhK2mZ5kFp0BMXF3Hs\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"start_date_in_millis\"</span>:1558051200000</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>我们将过期时间写到2050年，type改为platinum 白金版，这样我们就会拥有全部的x-pack功能。</p>\n<h2 id=\"配置elasticsearch安全协议\"><a href=\"#配置elasticsearch安全协议\" class=\"headerlink\" title=\"配置elasticsearch安全协议\"></a>配置elasticsearch安全协议</h2><p>完成以上所有操作在启动elasticsearch前，我们需要配置elasticsearch的SSL/TLS安全协议,如果不配置的话，需要禁止security才能配置License。当License配置完成后我们需要再开启security，并开启SSL\\TLS。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载License到elasticsearch之前操作</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"xpack.security.enabled: false\"</span> &gt;&gt; /elk/elasticsearch-7.0.1/config/elasticsearch.yml</span><br><span class=\"line\">$ ./bin/elasticsearch -d   <span class=\"comment\"># 后台方式启动elasticsearch</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 加载License到elasticsearch之后操作</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"xpack.security.transport.ssl.enabled: true\"</span> &gt;&gt; /elk/elasticsearch-7.0.1/config/elasticsearch.yml</span><br><span class=\"line\">$ sed -i <span class=\"string\">'s/xpack.security.enabled: false/xpack.security.enabled: true/g'</span> /elk/elasticsearch-7.0.1/config/elasticsearch.yml</span><br><span class=\"line\">$ <span class=\"built_in\">kill</span> -9 13023 &amp;&amp; ./bin/elasticsearch -d   <span class=\"comment\"># 重启elasticsearch</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"加载License到elasticsearch\"><a href=\"#加载License到elasticsearch\" class=\"headerlink\" title=\"加载License到elasticsearch\"></a>加载License到elasticsearch</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl -XPUT -u elastic <span class=\"string\">'http://192.168.20.210:9200/_xpack/license'</span> -H <span class=\"string\">\"Content-Type: application/json\"</span> -d @license.json</span><br><span class=\"line\">Enter host password <span class=\"keyword\">for</span> user <span class=\"string\">'elastic'</span>:           <span class=\"comment\"># 提示输入elastic用户密码，当前无密码，所以直接回车</span></span><br><span class=\"line\">&#123;<span class=\"string\">\"acknowledged\"</span>:<span class=\"literal\">true</span>,<span class=\"string\">\"license_status\"</span>:<span class=\"string\">\"valid\"</span>&#125;    <span class=\"comment\"># license写入成功</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"查看License\"><a href=\"#查看License\" class=\"headerlink\" title=\"查看License\"></a>查看License</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl -XGET -u elastic:tWbWZc7NE3wYqS6DvSu4 http://192.168.20.210:9200/_license</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"license\"</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">\"status\"</span> : <span class=\"string\">\"active\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"uid\"</span> : <span class=\"string\">\"537c5c48-c1dd-43ea-ab69-68d209d80c32\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"type\"</span> : <span class=\"string\">\"platinum\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"issue_date\"</span> : <span class=\"string\">\"2019-05-17T00:00:00.000Z\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"issue_date_in_millis\"</span> : 1558051200000,</span><br><span class=\"line\">    <span class=\"string\">\"expiry_date\"</span> : <span class=\"string\">\"2049-12-31T16:00:00.999Z\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"expiry_date_in_millis\"</span> : 2524579200999,</span><br><span class=\"line\">    <span class=\"string\">\"max_nodes\"</span> : 1000,</span><br><span class=\"line\">    <span class=\"string\">\"issued_to\"</span> : <span class=\"string\">\"pyker\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"issuer\"</span> : <span class=\"string\">\"Web Form\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"start_date_in_millis\"</span> : 1558051200000</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>由结果可以看出x-pack到期时间为2049-12-31，破解完成。也可以在kibana web页面<code>管理</code>中查看破解详情。<br><img src=\"/images/pic/x-pack.png\" alt></p>\n<h2 id=\"设置密码\"><a href=\"#设置密码\" class=\"headerlink\" title=\"设置密码\"></a>设置密码</h2><p>现在我们可以使用<code>x-pack铂金版</code>的所有功能了，例如密码安全验证功能。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ./bin/elasticsearch-setup-passwords auto</span><br><span class=\"line\"></span><br><span class=\"line\">Initiating the setup of passwords <span class=\"keyword\">for</span> reserved users elastic,apm_system,kibana,logstash_system,beats_system,remote_monitoring_user.</span><br><span class=\"line\">The passwords will be randomly generated and printed to the console.</span><br><span class=\"line\">Please confirm that you would like to <span class=\"built_in\">continue</span> [y/N]y</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user apm_system</span><br><span class=\"line\">PASSWORD apm_system = 24UtJKbNI1UqHUQkKPZY</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user kibana</span><br><span class=\"line\">PASSWORD kibana = 8SSZMisIY0NZFMCS6wv9</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user logstash_system</span><br><span class=\"line\">PASSWORD logstash_system = rFhWkYzayIUZVl8VIunJ</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user beats_system</span><br><span class=\"line\">PASSWORD beats_system = U1B4O5SKrSEatqDQRsQz</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user remote_monitoring_user</span><br><span class=\"line\">PASSWORD remote_monitoring_user = zdpj7HqO02yRXZR9Bwa2</span><br><span class=\"line\"></span><br><span class=\"line\">Changed password <span class=\"keyword\">for</span> user elastic</span><br><span class=\"line\">PASSWORD elastic = tWbWZc7NE3wYqS6DvSu4</span><br></pre></td></tr></table></figure></p>\n"},{"layout":"post","title":"Git 常 用 命 令","author":"Pyker","img":"/images/bar/gitcommand.jpg","top":false,"cover":false,"date":"2018-11-30T09:30:00.000Z","_content":"以下总结了日常常用的git指令方便读者学习和测试，如果想了解更多git指令相关的命令和参数，请参考[Git指令指南](https://git-scm.com/docs)\n```bash\ngit init                                                  # 初始化本地git仓库（创建新仓库）\ngit config --global user.name \"xxx\"                       # 配置用户名\ngit config --global user.email \"xxx@xxx.com\"              # 配置邮件\ngit config --global color.ui true                         # git status等命令自动着色\ngit config --global color.status auto\ngit config --global color.diff auto\ngit config --global color.branch auto\ngit config --global color.interactive auto\ngit clone git+ssh://git@192.168.53.168/VT.git             # clone远程仓库\ngit status                                                # 查看当前版本状态（是否修改）\ngit add xyz                                               # 添加xyz文件至暂存区\ngit add .                                                 # 增加当前子目录下所有更改过的文件至暂存区\ngit commit -m 'xxx'                                       # 提交\ngit commit --amend -m 'xxx'                               # 合并上一次提交（用于反复修改）\ngit commit -am 'xxx'                                      # 将add和commit合为一步\ngit rm xxx                                                # 删除暂存区中的文件\ngit rm -r *                                               # 递归删除\ngit log                                                   # 显示提交日志\ngit log -1                                                # 显示最近1次commit的日志 -n为最近n次\ngit log -5 --oneline\t\t\t\t\t\t\t\t\t  # 极简显示最近5次的commit日志\ngit log --stat                                            # 显示提交日志及相关变动文件\ngit log --graph --pretty=oneline --abbrev-commit          # 以图形表示分支合并历史\ngit show dfb02e6e4f2f7b573337763e5c0013802e392818         # 显示某个提交的详细内容\ngit show dfb02                                            # 可只用commitid的前几位\ngit show HEAD                                             # 显示HEAD提交日志\ngit show HEAD^                                            # 显示HEAD的父的提交日志\ngit show HEAD~10                                          # 显示前面第10次的提交日志\ngit show -s --pretty=raw 2be7fcb476\ngit tag                                                   # 显示已存在的tag\ngit tag -a v2.0 -m 'xxx'                                  # 增加v2.0的tag\ngit show v2.0                                             # 显示v2.0的日志及详细内容\ngit log v2.0                                              # 显示v2.0的日志\ngit diff                                                  # 显示所有未添加至暂存区的变更\ngit diff --cached                                         # 显示所有已添加index但还未commit的变更\ngit diff HEAD^                                            # 比较与上一个版本的差异\ngit diff HEAD -- ./lib                                    # 比较与HEAD版本lib目录的差异\ngit diff origin/master..master                            # 比较远程分支master与本地master分支的区别\ngit diff origin/master..master --stat                     # 只显示差异的文件，不显示具体内容\ngit remote add origin git+ssh://git@192.168.53.168/VT.git # 增加远程地址定义（用于push/pull/fetch）\ngit branch                                                # 显示本地分支\ngit branch --contains 50089                               # 显示包含提交50089的分支\ngit branch -a                                             # 显示所有分支\ngit branch -r                                             # 显示所有原创分支，包括本地和远程跟踪分支\ngit branch --merged                                       # 显示所有已合并到当前分支的分支\ngit branch --no-merged                                    # 显示所有未合并到当前分支的分支\ngit branch -m master master_copy                          # 本地分支重命名\ngit checkout -b master_copy                               # 从当前分支创建新分支master_copy并检出\ngit checkout -b dev origin/dev                            # 拉取远程dev分支到本地dev分支\ngit checkout features/performance                         # 检出已存在的features/performance分支\ngit checkout --track hotfix/BJP93                         # 检出远程分支hotfix/BJP93并创建本地跟踪分支\ngit checkout v2.0                                         # 检出版本v2.0\ngit checkout -b devel origin/develop                      # 从远程分支develop创建新本地分支devel并检出\ngit checkout -- README                                    # 将README文件回退到更新前(用于修改错误回退)\ngit merge --no-ff origin/master                           # 合并远程master分支至当前分支\ngit cherry-pick ff44785404a8e                             # 合并提交ff44785404a8e的修改\ngit push origin master                                    # 将当前master分支push到远程master分支\ngit push origin :hotfixes/BJVEP933                        # 删除远程仓库的hotfixes/BJVEP933分支\ngit push --tags                                           # 把所有tag推送到远程仓库\ngit push --set-upstream origin dev                        # 推送本地当前分支到远程dev分支\ngit fetch                                                 # 获取所有远程分支（不更新本地分支，需merge）\ngit fetch --prune                                         # 获取所有原创分支并清除服务器上已删掉的分支\ngit fetch origin dev:tmp                                  # 拉取远程dev分支到本地tmp分支\ngit pull origin master                                    # 获取远程分支master并merge到当前分支\ngit mv README README2                                     # 重命名文件README为README2\ngit reset --hard 2f3c                                     # 将当前版本重置为2f3c（常用于merge回退）\ngit rebase\ngit branch -d hotfix                                      # 删除分支hotfix (该分支已合并到其他分支)\ngit branch -D hotfix/BJP93                                # 强制删除分支hotfix/BJP93\ngit ls-files                                              # 列出git 暂存区包含的文件\ngit show-branch                                           # 图示当前分支历史\ngit show-branch --all                                     # 图示所有分支历史\ngit whatchanged                                           # 显示提交历史对应的文件修改\ngit revert dfb02e6e4                                      # 撤销提交dfb02e6e4\ngit ls-tree HEAD                                          # 内部命令：显示某个git对象\ngit rev-parse v2.0                                        # 内部命令：显示某个ref对于的SHA1 HASH\ngit reflog                                                # 显示历史所有提交，包括孤立节点\ngit show HEAD@{5}\ngit show master@{yesterday}                               # 显示master分支昨天的状态\ngit log --pretty=format:'%h %s' --graph                   # 图示提交日志\ngit stash                                                 # 暂存当前修改，将所有至为HEAD状态\ngit stash list                                            # 查看所有暂存\ngit stash show -p stash@{0}                               # 参考第一次暂存\ngit stash apply stash@{0}                                 # 应用第一次暂存\ngit stash drop                                            # 删除stash记录\ngit stash pop                                             # 等价于 git stash apply和git stash drop\ngit grep \"delete from\"                                    # 文件中搜索文本“delete from”\ngit grep -e '#define' --and -e SORT_DIRENT\ngit gc\ngit fsck\n```\n### git fetch 和git pull 的差别\n* git fetch 相当于是从远程获取最新到本地，不会自动merge，如下指令：\n```bash\ngit fetch                                 # 将远程仓库的当前分支下载到本地当前branch中\ngit diff origin/master                    # 比较本地的master分支和origin/master分支的差别\ngit diff HEAD FETCH_HEAD                  # 和上条命令一样效果\ngit merge origin/master                   # 进行合并\n```\n也可以用以下指令：\n```bash\ngit fetch origin master:tmp        # 从远程仓库master分支获取最新，在本地建立tmp分支\ngit diff tmp                       # 将当前分支和tmp進行對比\ngit merge tmp                      # 合并tmp分支到当前分支\n```\n* git pull：相当于是从远程获取最新版本并merge到本地\n```bash\ngit pull origin master\n```\ngit pull 相当于从远程获取最新版本并merge到本地\n在实际使用中，git fetch更安全一些","source":"_posts/git-command.md","raw":"layout: post\ntitle: Git 常 用 命 令\nauthor: Pyker\ncategories: CI/CD\nimg: /images/bar/gitcommand.jpg\ntags:\n  - git\ntop: false\ncover: false\ndate: 2018-11-30 17:30:00\n---\n以下总结了日常常用的git指令方便读者学习和测试，如果想了解更多git指令相关的命令和参数，请参考[Git指令指南](https://git-scm.com/docs)\n```bash\ngit init                                                  # 初始化本地git仓库（创建新仓库）\ngit config --global user.name \"xxx\"                       # 配置用户名\ngit config --global user.email \"xxx@xxx.com\"              # 配置邮件\ngit config --global color.ui true                         # git status等命令自动着色\ngit config --global color.status auto\ngit config --global color.diff auto\ngit config --global color.branch auto\ngit config --global color.interactive auto\ngit clone git+ssh://git@192.168.53.168/VT.git             # clone远程仓库\ngit status                                                # 查看当前版本状态（是否修改）\ngit add xyz                                               # 添加xyz文件至暂存区\ngit add .                                                 # 增加当前子目录下所有更改过的文件至暂存区\ngit commit -m 'xxx'                                       # 提交\ngit commit --amend -m 'xxx'                               # 合并上一次提交（用于反复修改）\ngit commit -am 'xxx'                                      # 将add和commit合为一步\ngit rm xxx                                                # 删除暂存区中的文件\ngit rm -r *                                               # 递归删除\ngit log                                                   # 显示提交日志\ngit log -1                                                # 显示最近1次commit的日志 -n为最近n次\ngit log -5 --oneline\t\t\t\t\t\t\t\t\t  # 极简显示最近5次的commit日志\ngit log --stat                                            # 显示提交日志及相关变动文件\ngit log --graph --pretty=oneline --abbrev-commit          # 以图形表示分支合并历史\ngit show dfb02e6e4f2f7b573337763e5c0013802e392818         # 显示某个提交的详细内容\ngit show dfb02                                            # 可只用commitid的前几位\ngit show HEAD                                             # 显示HEAD提交日志\ngit show HEAD^                                            # 显示HEAD的父的提交日志\ngit show HEAD~10                                          # 显示前面第10次的提交日志\ngit show -s --pretty=raw 2be7fcb476\ngit tag                                                   # 显示已存在的tag\ngit tag -a v2.0 -m 'xxx'                                  # 增加v2.0的tag\ngit show v2.0                                             # 显示v2.0的日志及详细内容\ngit log v2.0                                              # 显示v2.0的日志\ngit diff                                                  # 显示所有未添加至暂存区的变更\ngit diff --cached                                         # 显示所有已添加index但还未commit的变更\ngit diff HEAD^                                            # 比较与上一个版本的差异\ngit diff HEAD -- ./lib                                    # 比较与HEAD版本lib目录的差异\ngit diff origin/master..master                            # 比较远程分支master与本地master分支的区别\ngit diff origin/master..master --stat                     # 只显示差异的文件，不显示具体内容\ngit remote add origin git+ssh://git@192.168.53.168/VT.git # 增加远程地址定义（用于push/pull/fetch）\ngit branch                                                # 显示本地分支\ngit branch --contains 50089                               # 显示包含提交50089的分支\ngit branch -a                                             # 显示所有分支\ngit branch -r                                             # 显示所有原创分支，包括本地和远程跟踪分支\ngit branch --merged                                       # 显示所有已合并到当前分支的分支\ngit branch --no-merged                                    # 显示所有未合并到当前分支的分支\ngit branch -m master master_copy                          # 本地分支重命名\ngit checkout -b master_copy                               # 从当前分支创建新分支master_copy并检出\ngit checkout -b dev origin/dev                            # 拉取远程dev分支到本地dev分支\ngit checkout features/performance                         # 检出已存在的features/performance分支\ngit checkout --track hotfix/BJP93                         # 检出远程分支hotfix/BJP93并创建本地跟踪分支\ngit checkout v2.0                                         # 检出版本v2.0\ngit checkout -b devel origin/develop                      # 从远程分支develop创建新本地分支devel并检出\ngit checkout -- README                                    # 将README文件回退到更新前(用于修改错误回退)\ngit merge --no-ff origin/master                           # 合并远程master分支至当前分支\ngit cherry-pick ff44785404a8e                             # 合并提交ff44785404a8e的修改\ngit push origin master                                    # 将当前master分支push到远程master分支\ngit push origin :hotfixes/BJVEP933                        # 删除远程仓库的hotfixes/BJVEP933分支\ngit push --tags                                           # 把所有tag推送到远程仓库\ngit push --set-upstream origin dev                        # 推送本地当前分支到远程dev分支\ngit fetch                                                 # 获取所有远程分支（不更新本地分支，需merge）\ngit fetch --prune                                         # 获取所有原创分支并清除服务器上已删掉的分支\ngit fetch origin dev:tmp                                  # 拉取远程dev分支到本地tmp分支\ngit pull origin master                                    # 获取远程分支master并merge到当前分支\ngit mv README README2                                     # 重命名文件README为README2\ngit reset --hard 2f3c                                     # 将当前版本重置为2f3c（常用于merge回退）\ngit rebase\ngit branch -d hotfix                                      # 删除分支hotfix (该分支已合并到其他分支)\ngit branch -D hotfix/BJP93                                # 强制删除分支hotfix/BJP93\ngit ls-files                                              # 列出git 暂存区包含的文件\ngit show-branch                                           # 图示当前分支历史\ngit show-branch --all                                     # 图示所有分支历史\ngit whatchanged                                           # 显示提交历史对应的文件修改\ngit revert dfb02e6e4                                      # 撤销提交dfb02e6e4\ngit ls-tree HEAD                                          # 内部命令：显示某个git对象\ngit rev-parse v2.0                                        # 内部命令：显示某个ref对于的SHA1 HASH\ngit reflog                                                # 显示历史所有提交，包括孤立节点\ngit show HEAD@{5}\ngit show master@{yesterday}                               # 显示master分支昨天的状态\ngit log --pretty=format:'%h %s' --graph                   # 图示提交日志\ngit stash                                                 # 暂存当前修改，将所有至为HEAD状态\ngit stash list                                            # 查看所有暂存\ngit stash show -p stash@{0}                               # 参考第一次暂存\ngit stash apply stash@{0}                                 # 应用第一次暂存\ngit stash drop                                            # 删除stash记录\ngit stash pop                                             # 等价于 git stash apply和git stash drop\ngit grep \"delete from\"                                    # 文件中搜索文本“delete from”\ngit grep -e '#define' --and -e SORT_DIRENT\ngit gc\ngit fsck\n```\n### git fetch 和git pull 的差别\n* git fetch 相当于是从远程获取最新到本地，不会自动merge，如下指令：\n```bash\ngit fetch                                 # 将远程仓库的当前分支下载到本地当前branch中\ngit diff origin/master                    # 比较本地的master分支和origin/master分支的差别\ngit diff HEAD FETCH_HEAD                  # 和上条命令一样效果\ngit merge origin/master                   # 进行合并\n```\n也可以用以下指令：\n```bash\ngit fetch origin master:tmp        # 从远程仓库master分支获取最新，在本地建立tmp分支\ngit diff tmp                       # 将当前分支和tmp進行對比\ngit merge tmp                      # 合并tmp分支到当前分支\n```\n* git pull：相当于是从远程获取最新版本并merge到本地\n```bash\ngit pull origin master\n```\ngit pull 相当于从远程获取最新版本并merge到本地\n在实际使用中，git fetch更安全一些","slug":"git-command","published":1,"updated":"2019-05-28T02:02:23.504Z","_id":"cjw6jlf0m002cp4n7dqhjquuz","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>以下总结了日常常用的git指令方便读者学习和测试，如果想了解更多git指令相关的命令和参数，请参考<a href=\"https://git-scm.com/docs\" target=\"_blank\" rel=\"noopener\">Git指令指南</a><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git init                                                  <span class=\"comment\"># 初始化本地git仓库（创建新仓库）</span></span><br><span class=\"line\">git config --global user.name <span class=\"string\">\"xxx\"</span>                       <span class=\"comment\"># 配置用户名</span></span><br><span class=\"line\">git config --global user.email <span class=\"string\">\"xxx@xxx.com\"</span>              <span class=\"comment\"># 配置邮件</span></span><br><span class=\"line\">git config --global color.ui <span class=\"literal\">true</span>                         <span class=\"comment\"># git status等命令自动着色</span></span><br><span class=\"line\">git config --global color.status auto</span><br><span class=\"line\">git config --global color.diff auto</span><br><span class=\"line\">git config --global color.branch auto</span><br><span class=\"line\">git config --global color.interactive auto</span><br><span class=\"line\">git <span class=\"built_in\">clone</span> git+ssh://git@192.168.53.168/VT.git             <span class=\"comment\"># clone远程仓库</span></span><br><span class=\"line\">git status                                                <span class=\"comment\"># 查看当前版本状态（是否修改）</span></span><br><span class=\"line\">git add xyz                                               <span class=\"comment\"># 添加xyz文件至暂存区</span></span><br><span class=\"line\">git add .                                                 <span class=\"comment\"># 增加当前子目录下所有更改过的文件至暂存区</span></span><br><span class=\"line\">git commit -m <span class=\"string\">'xxx'</span>                                       <span class=\"comment\"># 提交</span></span><br><span class=\"line\">git commit --amend -m <span class=\"string\">'xxx'</span>                               <span class=\"comment\"># 合并上一次提交（用于反复修改）</span></span><br><span class=\"line\">git commit -am <span class=\"string\">'xxx'</span>                                      <span class=\"comment\"># 将add和commit合为一步</span></span><br><span class=\"line\">git rm xxx                                                <span class=\"comment\"># 删除暂存区中的文件</span></span><br><span class=\"line\">git rm -r *                                               <span class=\"comment\"># 递归删除</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span>                                                   <span class=\"comment\"># 显示提交日志</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> -1                                                <span class=\"comment\"># 显示最近1次commit的日志 -n为最近n次</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> -5 --oneline\t\t\t\t\t\t\t\t\t  <span class=\"comment\"># 极简显示最近5次的commit日志</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> --<span class=\"built_in\">stat</span>                                            <span class=\"comment\"># 显示提交日志及相关变动文件</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> --graph --pretty=oneline --abbrev-commit          <span class=\"comment\"># 以图形表示分支合并历史</span></span><br><span class=\"line\">git show dfb02e6e4f2f7b573337763e5c0013802e392818         <span class=\"comment\"># 显示某个提交的详细内容</span></span><br><span class=\"line\">git show dfb02                                            <span class=\"comment\"># 可只用commitid的前几位</span></span><br><span class=\"line\">git show HEAD                                             <span class=\"comment\"># 显示HEAD提交日志</span></span><br><span class=\"line\">git show HEAD^                                            <span class=\"comment\"># 显示HEAD的父的提交日志</span></span><br><span class=\"line\">git show HEAD~10                                          <span class=\"comment\"># 显示前面第10次的提交日志</span></span><br><span class=\"line\">git show -s --pretty=raw 2be7fcb476</span><br><span class=\"line\">git tag                                                   <span class=\"comment\"># 显示已存在的tag</span></span><br><span class=\"line\">git tag -a v2.0 -m <span class=\"string\">'xxx'</span>                                  <span class=\"comment\"># 增加v2.0的tag</span></span><br><span class=\"line\">git show v2.0                                             <span class=\"comment\"># 显示v2.0的日志及详细内容</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> v2.0                                              <span class=\"comment\"># 显示v2.0的日志</span></span><br><span class=\"line\">git diff                                                  <span class=\"comment\"># 显示所有未添加至暂存区的变更</span></span><br><span class=\"line\">git diff --cached                                         <span class=\"comment\"># 显示所有已添加index但还未commit的变更</span></span><br><span class=\"line\">git diff HEAD^                                            <span class=\"comment\"># 比较与上一个版本的差异</span></span><br><span class=\"line\">git diff HEAD -- ./lib                                    <span class=\"comment\"># 比较与HEAD版本lib目录的差异</span></span><br><span class=\"line\">git diff origin/master..master                            <span class=\"comment\"># 比较远程分支master与本地master分支的区别</span></span><br><span class=\"line\">git diff origin/master..master --<span class=\"built_in\">stat</span>                     <span class=\"comment\"># 只显示差异的文件，不显示具体内容</span></span><br><span class=\"line\">git remote add origin git+ssh://git@192.168.53.168/VT.git <span class=\"comment\"># 增加远程地址定义（用于push/pull/fetch）</span></span><br><span class=\"line\">git branch                                                <span class=\"comment\"># 显示本地分支</span></span><br><span class=\"line\">git branch --contains 50089                               <span class=\"comment\"># 显示包含提交50089的分支</span></span><br><span class=\"line\">git branch -a                                             <span class=\"comment\"># 显示所有分支</span></span><br><span class=\"line\">git branch -r                                             <span class=\"comment\"># 显示所有原创分支，包括本地和远程跟踪分支</span></span><br><span class=\"line\">git branch --merged                                       <span class=\"comment\"># 显示所有已合并到当前分支的分支</span></span><br><span class=\"line\">git branch --no-merged                                    <span class=\"comment\"># 显示所有未合并到当前分支的分支</span></span><br><span class=\"line\">git branch -m master master_copy                          <span class=\"comment\"># 本地分支重命名</span></span><br><span class=\"line\">git checkout -b master_copy                               <span class=\"comment\"># 从当前分支创建新分支master_copy并检出</span></span><br><span class=\"line\">git checkout -b dev origin/dev                            <span class=\"comment\"># 拉取远程dev分支到本地dev分支</span></span><br><span class=\"line\">git checkout features/performance                         <span class=\"comment\"># 检出已存在的features/performance分支</span></span><br><span class=\"line\">git checkout --track hotfix/BJP93                         <span class=\"comment\"># 检出远程分支hotfix/BJP93并创建本地跟踪分支</span></span><br><span class=\"line\">git checkout v2.0                                         <span class=\"comment\"># 检出版本v2.0</span></span><br><span class=\"line\">git checkout -b devel origin/develop                      <span class=\"comment\"># 从远程分支develop创建新本地分支devel并检出</span></span><br><span class=\"line\">git checkout -- README                                    <span class=\"comment\"># 将README文件回退到更新前(用于修改错误回退)</span></span><br><span class=\"line\">git merge --no-ff origin/master                           <span class=\"comment\"># 合并远程master分支至当前分支</span></span><br><span class=\"line\">git cherry-pick ff44785404a8e                             <span class=\"comment\"># 合并提交ff44785404a8e的修改</span></span><br><span class=\"line\">git push origin master                                    <span class=\"comment\"># 将当前master分支push到远程master分支</span></span><br><span class=\"line\">git push origin :hotfixes/BJVEP933                        <span class=\"comment\"># 删除远程仓库的hotfixes/BJVEP933分支</span></span><br><span class=\"line\">git push --tags                                           <span class=\"comment\"># 把所有tag推送到远程仓库</span></span><br><span class=\"line\">git push --<span class=\"built_in\">set</span>-upstream origin dev                        <span class=\"comment\"># 推送本地当前分支到远程dev分支</span></span><br><span class=\"line\">git fetch                                                 <span class=\"comment\"># 获取所有远程分支（不更新本地分支，需merge）</span></span><br><span class=\"line\">git fetch --prune                                         <span class=\"comment\"># 获取所有原创分支并清除服务器上已删掉的分支</span></span><br><span class=\"line\">git fetch origin dev:tmp                                  <span class=\"comment\"># 拉取远程dev分支到本地tmp分支</span></span><br><span class=\"line\">git pull origin master                                    <span class=\"comment\"># 获取远程分支master并merge到当前分支</span></span><br><span class=\"line\">git mv README README2                                     <span class=\"comment\"># 重命名文件README为README2</span></span><br><span class=\"line\">git reset --hard 2f3c                                     <span class=\"comment\"># 将当前版本重置为2f3c（常用于merge回退）</span></span><br><span class=\"line\">git rebase</span><br><span class=\"line\">git branch -d hotfix                                      <span class=\"comment\"># 删除分支hotfix (该分支已合并到其他分支)</span></span><br><span class=\"line\">git branch -D hotfix/BJP93                                <span class=\"comment\"># 强制删除分支hotfix/BJP93</span></span><br><span class=\"line\">git ls-files                                              <span class=\"comment\"># 列出git 暂存区包含的文件</span></span><br><span class=\"line\">git show-branch                                           <span class=\"comment\"># 图示当前分支历史</span></span><br><span class=\"line\">git show-branch --all                                     <span class=\"comment\"># 图示所有分支历史</span></span><br><span class=\"line\">git whatchanged                                           <span class=\"comment\"># 显示提交历史对应的文件修改</span></span><br><span class=\"line\">git revert dfb02e6e4                                      <span class=\"comment\"># 撤销提交dfb02e6e4</span></span><br><span class=\"line\">git ls-tree HEAD                                          <span class=\"comment\"># 内部命令：显示某个git对象</span></span><br><span class=\"line\">git rev-parse v2.0                                        <span class=\"comment\"># 内部命令：显示某个ref对于的SHA1 HASH</span></span><br><span class=\"line\">git reflog                                                <span class=\"comment\"># 显示历史所有提交，包括孤立节点</span></span><br><span class=\"line\">git show HEAD@&#123;5&#125;</span><br><span class=\"line\">git show master@&#123;yesterday&#125;                               <span class=\"comment\"># 显示master分支昨天的状态</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> --pretty=format:<span class=\"string\">'%h %s'</span> --graph                   <span class=\"comment\"># 图示提交日志</span></span><br><span class=\"line\">git stash                                                 <span class=\"comment\"># 暂存当前修改，将所有至为HEAD状态</span></span><br><span class=\"line\">git stash list                                            <span class=\"comment\"># 查看所有暂存</span></span><br><span class=\"line\">git stash show -p stash@&#123;0&#125;                               <span class=\"comment\"># 参考第一次暂存</span></span><br><span class=\"line\">git stash apply stash@&#123;0&#125;                                 <span class=\"comment\"># 应用第一次暂存</span></span><br><span class=\"line\">git stash drop                                            <span class=\"comment\"># 删除stash记录</span></span><br><span class=\"line\">git stash pop                                             <span class=\"comment\"># 等价于 git stash apply和git stash drop</span></span><br><span class=\"line\">git grep <span class=\"string\">\"delete from\"</span>                                    <span class=\"comment\"># 文件中搜索文本“delete from”</span></span><br><span class=\"line\">git grep -e <span class=\"string\">'#define'</span> --and -e SORT_DIRENT</span><br><span class=\"line\">git gc</span><br><span class=\"line\">git fsck</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"git-fetch-和git-pull-的差别\"><a href=\"#git-fetch-和git-pull-的差别\" class=\"headerlink\" title=\"git fetch 和git pull 的差别\"></a>git fetch 和git pull 的差别</h3><ul>\n<li>git fetch 相当于是从远程获取最新到本地，不会自动merge，如下指令：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git fetch                                 <span class=\"comment\"># 将远程仓库的当前分支下载到本地当前branch中</span></span><br><span class=\"line\">git diff origin/master                    <span class=\"comment\"># 比较本地的master分支和origin/master分支的差别</span></span><br><span class=\"line\">git diff HEAD FETCH_HEAD                  <span class=\"comment\"># 和上条命令一样效果</span></span><br><span class=\"line\">git merge origin/master                   <span class=\"comment\"># 进行合并</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>也可以用以下指令：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git fetch origin master:tmp        <span class=\"comment\"># 从远程仓库master分支获取最新，在本地建立tmp分支</span></span><br><span class=\"line\">git diff tmp                       <span class=\"comment\"># 将当前分支和tmp進行對比</span></span><br><span class=\"line\">git merge tmp                      <span class=\"comment\"># 合并tmp分支到当前分支</span></span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>git pull：相当于是从远程获取最新版本并merge到本地<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git pull origin master</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>git pull 相当于从远程获取最新版本并merge到本地<br>在实际使用中，git fetch更安全一些</p>\n","site":{"data":{}},"length":6883,"excerpt":"","more":"<p>以下总结了日常常用的git指令方便读者学习和测试，如果想了解更多git指令相关的命令和参数，请参考<a href=\"https://git-scm.com/docs\" target=\"_blank\" rel=\"noopener\">Git指令指南</a><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git init                                                  <span class=\"comment\"># 初始化本地git仓库（创建新仓库）</span></span><br><span class=\"line\">git config --global user.name <span class=\"string\">\"xxx\"</span>                       <span class=\"comment\"># 配置用户名</span></span><br><span class=\"line\">git config --global user.email <span class=\"string\">\"xxx@xxx.com\"</span>              <span class=\"comment\"># 配置邮件</span></span><br><span class=\"line\">git config --global color.ui <span class=\"literal\">true</span>                         <span class=\"comment\"># git status等命令自动着色</span></span><br><span class=\"line\">git config --global color.status auto</span><br><span class=\"line\">git config --global color.diff auto</span><br><span class=\"line\">git config --global color.branch auto</span><br><span class=\"line\">git config --global color.interactive auto</span><br><span class=\"line\">git <span class=\"built_in\">clone</span> git+ssh://git@192.168.53.168/VT.git             <span class=\"comment\"># clone远程仓库</span></span><br><span class=\"line\">git status                                                <span class=\"comment\"># 查看当前版本状态（是否修改）</span></span><br><span class=\"line\">git add xyz                                               <span class=\"comment\"># 添加xyz文件至暂存区</span></span><br><span class=\"line\">git add .                                                 <span class=\"comment\"># 增加当前子目录下所有更改过的文件至暂存区</span></span><br><span class=\"line\">git commit -m <span class=\"string\">'xxx'</span>                                       <span class=\"comment\"># 提交</span></span><br><span class=\"line\">git commit --amend -m <span class=\"string\">'xxx'</span>                               <span class=\"comment\"># 合并上一次提交（用于反复修改）</span></span><br><span class=\"line\">git commit -am <span class=\"string\">'xxx'</span>                                      <span class=\"comment\"># 将add和commit合为一步</span></span><br><span class=\"line\">git rm xxx                                                <span class=\"comment\"># 删除暂存区中的文件</span></span><br><span class=\"line\">git rm -r *                                               <span class=\"comment\"># 递归删除</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span>                                                   <span class=\"comment\"># 显示提交日志</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> -1                                                <span class=\"comment\"># 显示最近1次commit的日志 -n为最近n次</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> -5 --oneline\t\t\t\t\t\t\t\t\t  <span class=\"comment\"># 极简显示最近5次的commit日志</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> --<span class=\"built_in\">stat</span>                                            <span class=\"comment\"># 显示提交日志及相关变动文件</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> --graph --pretty=oneline --abbrev-commit          <span class=\"comment\"># 以图形表示分支合并历史</span></span><br><span class=\"line\">git show dfb02e6e4f2f7b573337763e5c0013802e392818         <span class=\"comment\"># 显示某个提交的详细内容</span></span><br><span class=\"line\">git show dfb02                                            <span class=\"comment\"># 可只用commitid的前几位</span></span><br><span class=\"line\">git show HEAD                                             <span class=\"comment\"># 显示HEAD提交日志</span></span><br><span class=\"line\">git show HEAD^                                            <span class=\"comment\"># 显示HEAD的父的提交日志</span></span><br><span class=\"line\">git show HEAD~10                                          <span class=\"comment\"># 显示前面第10次的提交日志</span></span><br><span class=\"line\">git show -s --pretty=raw 2be7fcb476</span><br><span class=\"line\">git tag                                                   <span class=\"comment\"># 显示已存在的tag</span></span><br><span class=\"line\">git tag -a v2.0 -m <span class=\"string\">'xxx'</span>                                  <span class=\"comment\"># 增加v2.0的tag</span></span><br><span class=\"line\">git show v2.0                                             <span class=\"comment\"># 显示v2.0的日志及详细内容</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> v2.0                                              <span class=\"comment\"># 显示v2.0的日志</span></span><br><span class=\"line\">git diff                                                  <span class=\"comment\"># 显示所有未添加至暂存区的变更</span></span><br><span class=\"line\">git diff --cached                                         <span class=\"comment\"># 显示所有已添加index但还未commit的变更</span></span><br><span class=\"line\">git diff HEAD^                                            <span class=\"comment\"># 比较与上一个版本的差异</span></span><br><span class=\"line\">git diff HEAD -- ./lib                                    <span class=\"comment\"># 比较与HEAD版本lib目录的差异</span></span><br><span class=\"line\">git diff origin/master..master                            <span class=\"comment\"># 比较远程分支master与本地master分支的区别</span></span><br><span class=\"line\">git diff origin/master..master --<span class=\"built_in\">stat</span>                     <span class=\"comment\"># 只显示差异的文件，不显示具体内容</span></span><br><span class=\"line\">git remote add origin git+ssh://git@192.168.53.168/VT.git <span class=\"comment\"># 增加远程地址定义（用于push/pull/fetch）</span></span><br><span class=\"line\">git branch                                                <span class=\"comment\"># 显示本地分支</span></span><br><span class=\"line\">git branch --contains 50089                               <span class=\"comment\"># 显示包含提交50089的分支</span></span><br><span class=\"line\">git branch -a                                             <span class=\"comment\"># 显示所有分支</span></span><br><span class=\"line\">git branch -r                                             <span class=\"comment\"># 显示所有原创分支，包括本地和远程跟踪分支</span></span><br><span class=\"line\">git branch --merged                                       <span class=\"comment\"># 显示所有已合并到当前分支的分支</span></span><br><span class=\"line\">git branch --no-merged                                    <span class=\"comment\"># 显示所有未合并到当前分支的分支</span></span><br><span class=\"line\">git branch -m master master_copy                          <span class=\"comment\"># 本地分支重命名</span></span><br><span class=\"line\">git checkout -b master_copy                               <span class=\"comment\"># 从当前分支创建新分支master_copy并检出</span></span><br><span class=\"line\">git checkout -b dev origin/dev                            <span class=\"comment\"># 拉取远程dev分支到本地dev分支</span></span><br><span class=\"line\">git checkout features/performance                         <span class=\"comment\"># 检出已存在的features/performance分支</span></span><br><span class=\"line\">git checkout --track hotfix/BJP93                         <span class=\"comment\"># 检出远程分支hotfix/BJP93并创建本地跟踪分支</span></span><br><span class=\"line\">git checkout v2.0                                         <span class=\"comment\"># 检出版本v2.0</span></span><br><span class=\"line\">git checkout -b devel origin/develop                      <span class=\"comment\"># 从远程分支develop创建新本地分支devel并检出</span></span><br><span class=\"line\">git checkout -- README                                    <span class=\"comment\"># 将README文件回退到更新前(用于修改错误回退)</span></span><br><span class=\"line\">git merge --no-ff origin/master                           <span class=\"comment\"># 合并远程master分支至当前分支</span></span><br><span class=\"line\">git cherry-pick ff44785404a8e                             <span class=\"comment\"># 合并提交ff44785404a8e的修改</span></span><br><span class=\"line\">git push origin master                                    <span class=\"comment\"># 将当前master分支push到远程master分支</span></span><br><span class=\"line\">git push origin :hotfixes/BJVEP933                        <span class=\"comment\"># 删除远程仓库的hotfixes/BJVEP933分支</span></span><br><span class=\"line\">git push --tags                                           <span class=\"comment\"># 把所有tag推送到远程仓库</span></span><br><span class=\"line\">git push --<span class=\"built_in\">set</span>-upstream origin dev                        <span class=\"comment\"># 推送本地当前分支到远程dev分支</span></span><br><span class=\"line\">git fetch                                                 <span class=\"comment\"># 获取所有远程分支（不更新本地分支，需merge）</span></span><br><span class=\"line\">git fetch --prune                                         <span class=\"comment\"># 获取所有原创分支并清除服务器上已删掉的分支</span></span><br><span class=\"line\">git fetch origin dev:tmp                                  <span class=\"comment\"># 拉取远程dev分支到本地tmp分支</span></span><br><span class=\"line\">git pull origin master                                    <span class=\"comment\"># 获取远程分支master并merge到当前分支</span></span><br><span class=\"line\">git mv README README2                                     <span class=\"comment\"># 重命名文件README为README2</span></span><br><span class=\"line\">git reset --hard 2f3c                                     <span class=\"comment\"># 将当前版本重置为2f3c（常用于merge回退）</span></span><br><span class=\"line\">git rebase</span><br><span class=\"line\">git branch -d hotfix                                      <span class=\"comment\"># 删除分支hotfix (该分支已合并到其他分支)</span></span><br><span class=\"line\">git branch -D hotfix/BJP93                                <span class=\"comment\"># 强制删除分支hotfix/BJP93</span></span><br><span class=\"line\">git ls-files                                              <span class=\"comment\"># 列出git 暂存区包含的文件</span></span><br><span class=\"line\">git show-branch                                           <span class=\"comment\"># 图示当前分支历史</span></span><br><span class=\"line\">git show-branch --all                                     <span class=\"comment\"># 图示所有分支历史</span></span><br><span class=\"line\">git whatchanged                                           <span class=\"comment\"># 显示提交历史对应的文件修改</span></span><br><span class=\"line\">git revert dfb02e6e4                                      <span class=\"comment\"># 撤销提交dfb02e6e4</span></span><br><span class=\"line\">git ls-tree HEAD                                          <span class=\"comment\"># 内部命令：显示某个git对象</span></span><br><span class=\"line\">git rev-parse v2.0                                        <span class=\"comment\"># 内部命令：显示某个ref对于的SHA1 HASH</span></span><br><span class=\"line\">git reflog                                                <span class=\"comment\"># 显示历史所有提交，包括孤立节点</span></span><br><span class=\"line\">git show HEAD@&#123;5&#125;</span><br><span class=\"line\">git show master@&#123;yesterday&#125;                               <span class=\"comment\"># 显示master分支昨天的状态</span></span><br><span class=\"line\">git <span class=\"built_in\">log</span> --pretty=format:<span class=\"string\">'%h %s'</span> --graph                   <span class=\"comment\"># 图示提交日志</span></span><br><span class=\"line\">git stash                                                 <span class=\"comment\"># 暂存当前修改，将所有至为HEAD状态</span></span><br><span class=\"line\">git stash list                                            <span class=\"comment\"># 查看所有暂存</span></span><br><span class=\"line\">git stash show -p stash@&#123;0&#125;                               <span class=\"comment\"># 参考第一次暂存</span></span><br><span class=\"line\">git stash apply stash@&#123;0&#125;                                 <span class=\"comment\"># 应用第一次暂存</span></span><br><span class=\"line\">git stash drop                                            <span class=\"comment\"># 删除stash记录</span></span><br><span class=\"line\">git stash pop                                             <span class=\"comment\"># 等价于 git stash apply和git stash drop</span></span><br><span class=\"line\">git grep <span class=\"string\">\"delete from\"</span>                                    <span class=\"comment\"># 文件中搜索文本“delete from”</span></span><br><span class=\"line\">git grep -e <span class=\"string\">'#define'</span> --and -e SORT_DIRENT</span><br><span class=\"line\">git gc</span><br><span class=\"line\">git fsck</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"git-fetch-和git-pull-的差别\"><a href=\"#git-fetch-和git-pull-的差别\" class=\"headerlink\" title=\"git fetch 和git pull 的差别\"></a>git fetch 和git pull 的差别</h3><ul>\n<li>git fetch 相当于是从远程获取最新到本地，不会自动merge，如下指令：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git fetch                                 <span class=\"comment\"># 将远程仓库的当前分支下载到本地当前branch中</span></span><br><span class=\"line\">git diff origin/master                    <span class=\"comment\"># 比较本地的master分支和origin/master分支的差别</span></span><br><span class=\"line\">git diff HEAD FETCH_HEAD                  <span class=\"comment\"># 和上条命令一样效果</span></span><br><span class=\"line\">git merge origin/master                   <span class=\"comment\"># 进行合并</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>也可以用以下指令：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git fetch origin master:tmp        <span class=\"comment\"># 从远程仓库master分支获取最新，在本地建立tmp分支</span></span><br><span class=\"line\">git diff tmp                       <span class=\"comment\"># 将当前分支和tmp進行對比</span></span><br><span class=\"line\">git merge tmp                      <span class=\"comment\"># 合并tmp分支到当前分支</span></span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>git pull：相当于是从远程获取最新版本并merge到本地<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git pull origin master</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>git pull 相当于从远程获取最新版本并merge到本地<br>在实际使用中，git fetch更安全一些</p>\n"},{"layout":"post","title":"Elastic stack之EFK安装","author":"Pyker","img":"/images/bar/kibana.jpg","top":false,"cover":false,"date":"2019-03-15T06:15:00.000Z","_content":"## 试验环境\n本次试验的`elastic stack`软件都为`7.0.1`版本，现在官网最新的为7.1版本，用户可在官方下载[下载地址](https://www.elastic.co/cn/downloads/)。\n\n主机名 | ip地址 | 服务\n--- | --- | ---\nefk-node1 | 192.168.20.211 | elasticsearch、kibana、jdk8\nefk-node2 | 192.168.20.212 | elasticsearch、cerebro、jdk8\nreal-server | 192.168.20.250 | filebeat\n\n## 环境准备\n### 安装JDK\nelasticsearch需要jdk环境的支持，7.0.1版本默认已经自带JDK了，但是为了日后扩展问题，我们还是手动配置一边JDK环境。以下操作在`efk-node1`和`efk-node2`主机上进行：\n```bash\n# 下面下载链接因授权问题，需用户前往JDK官网下载\n$ wget https://download.oracle.com/otn/java/jdk/8u171-b12/478a62b7d4e34b78b671c754eaaf38ab/jdk-8u171-linux-x64.tar.gz\n\n$ tar zxvf jdk-8u171-linux-x64.tar.gz -C /usr/local/\n\n$ cat >> /etc/profile << EOF\nexport JAVA_HOME=/usr/local/jdk1.8.0_171\nexport CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar\nexport PATH=$JAVA_HOME/bin:$PATH\nEOF\n\n$ source /etc/profile\n\n# 验证JDK, JDK配置完成\n$ java -version\njava version \"1.8.0_171\"\nJava(TM) SE Runtime Environment (build 1.8.0_171-b11)\nJava HotSpot(TM) 64-Bit Server VM (build 25.171-b11, mixed mode)\n```\n### 设置服务器的最大文件数\n```bash\n$ cat >> /etc/security/limits.conf << EOF\n * soft nofile 655350\n * hard nofile 655350\n * soft nproc 655350\n * hard nproc 655350\nEOF\n```\n### 设置服务器打开的最大进程数\n```bash\n$ cat > /etc/security/limits.d/20-nproc.conf << EOF\n*          soft    nproc     4096\nroot       soft    nproc     unlimited\nEOF\n```\n### 设置nmap数量对虚拟内存的支持\n```bash\n$ cat >> /etc/sysctl.conf << EOF\nvm.max_map_count=262144\nEOF\n\n$  sysctl -p\n```\n### 本地host解析\n```bash\ncat >> /etc/hosts << EOF\nefk-node1 192.168.20.211\nefk-node2 192.168.20.212\nreal-server 192.168.20.250\nEOF\n```\n## 安装elasticsearch\n以下操作在`efk-node1`和`efk-node2`主机上进行：\n### 下载和解压\n```bash\n# 创建elastic工作目录\n$ mkdir /elastic && cd /elastic\n\n# 下载elasticsearch tar包\n$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.0.1-linux-x86_64.tar.gz\n\n# 解压到当前/elastic目录\n$ tar zxvf elasticsearch-7.0.1-linux-x86_64.tar.gz\n```\n### 修改配置文件\n下面只列出已配置的参数\n```bash\n$ cat elasticsearch-7.0.1/config/elasticsearch.yml | egrep -v \"^$|^#\"\n  cluster.name: efk-cluster     # 集群名称\n  node.name: efk-node1          # 节点名称，212服务器改成efk-node2\n  path.data: /var/lib/elasticsearch     # elasticsearch数据目录\n  path.logs: /var/log/elasticsearch     # elasticsearch日志目录\n  network.host: 0.0.0.0                 # elasticsearch绑定的地址\n  http.port: 9200                       # elasticsearch绑定的端口\n  discovery.seed_hosts: [\"efk-node1\", \"efk-node2\"]  #集群发现\n  cluster.initial_master_nodes: [\"efk-node1\", \"efk-node2\"]  #第一次访问初始的集群节点\n  xpack.security.enabled: true          # ssl\\tls安全参数\n  xpack.security.transport.ssl.enabled: true    # ssl\\tls安全参数\n```\n### 创建运行elasticsearch用户\n> elasticsearch默认是不运行root用户运行的，因此我们得创建一个新用户来运行elasticsearch。\n\n```bash\n$ useradd elastic\n$ passwd elastic\n```\n### 创建依赖文件\n```bash\n$ mkdir /var/log/elasticsearch      # 创建日志目录\n\n$ mkdir /var/lib/elasticsearch      # 创建数据目录\n\n$ touch /var/run/elasticsearch.pid  # 创建进程文件\n\n$ chown -R elastic.elastic /elastic # 修改elastic工作目录所有者\n$ chown -R elastic.elastic /var/log/elasticsearch && \\\nchown -R elastic.elastic /var/lib/elasticsearch && \\\nchown -R elastic.elastic /var/run/elasticsearch.pid   # 相关目录所有者都修改成运行elasticsearch服务的用户\n```\n### 准备elasticsearch systemctl文件\n```bash\n[Unit]\nDescription=Elasticsearch\nDocumentation=http://www.elastic.co\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nEnvironment=JAVA_HOME=/usr/local/jdk1.8.0_171\nUser=elastic\nGroup=elastic\nExecStart=/elastic/elasticsearch-7.0.1/bin/elasticsearch -p /var/run/elasticsearch.pid\n\nLimitNOFILE=65535\nLimitNPROC=65535\nLimitAS=infinity\nLimitFSIZE=infinity\n\n[Install]\nWantedBy=multi-user.target\n```\n### 启动elasticsearch\n```bash\n$ systemctl daemon-reload           # 加载systemctl配置文件\n\n$ systemctl start elasticsearch     # 启动elasticsearch\n\n$ systemctl enable elasticsearch    # 设置开机启动elasticsearch\n```\n>**Tips**: elasticsearch7.0.1安装完默认自带基础版的X-Pack功能，使用铂金版的需要购买或者参考[破解X-pack](https://www.ipyker.com/2019/03/13/elastic-x-pack/)进行破解。\n\n### 验证集群状态\n通过上面的配置，我们的elasticsearch服务器已经启动，并且默认监听在`9200`和`9300`端口。\n`9200端口`: 为web访问提供服务；`9300端口`：为集群节点提供通信。\n```bash\n# 验证集群节点数，其中master为*的代表该节点为主节点\n$ curl http://192.168.20.211:9200/_cat/nodes?v\nip             heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name\n192.168.20.212           10          39   0    0.00    0.01     0.05 mdi       -      efk-node2\n192.168.20.211           18          37   0    0.00    0.01     0.05 mdi       *      efk-node1\n\n# 验证集群健康状态，status为green表示正常\n$ curl http://192.168.20.211:9200/_cat/health?v\nepoch      timestamp cluster        status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent\n1558517253 09:27:33  efk-cluster green           2         2      6   3    0    0        0             0                  -                100.0%\n```\n{% note success %}由上可知，我们的elasticsearch集群已经正常工作了，并且在2台集群节点下/var/lib/elasticsearch目录下都有相同的数据。更多关于elasticsearch REST API请参考官方说明。\n[cluster apis](https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cluster.html) [_cat apis](https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cat.html) [Search apis](https://www.elastic.co/guide/en/elasticsearch/reference/7.0/search.html) [Document apis](https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docs.html) {% endnote %}\n## 安装 Kibana\n以下操作只在`efk-node1`主机上进行：\n### 下载和解压\n```bash\n# 进入elastic工作目录\n$ cd /elastic\n\n# 下载kibana tar包\n$ wget https://artifacts.elastic.co/downloads/kibana/kibana-7.0.1-linux-x86_64.tar.gz\n\n# 解压到当前/elastic目录\n$ tar zxvf kibana-7.0.1-linux-x86_64.tar.gz\n```\n### 修改配置文件\n下面只列出已配置的参数\n```bash\n$ cat kibana-7.0.1-linux-x86_64/config/kibana.yml | egrep -v \"^$|^#\"\n  server.port: 5601           # kibana服务端口\n  server.host: \"0.0.0.0\"      # kibana服务地址\n  elasticsearch.hosts: [\"http://192.168.20.201:9200\"]  # es访问地址，kibana需要和它通信\n  elasticsearch.username: \"elastic\"            # es帐号，如果是X-pack铂金版可配\n  elasticsearch.password: \"pyker123456\"        # es密码，如果是X-pack铂金版可配\n  elasticsearch.logQueries: true               # 查询日志是否发送到ES，配合logging.json: true\n  pid.file: /var/run/kibana.pid                # kibana的进行id文件\n  logging.dest: /var/log/kibana.log            # kibana日志文件\n  logging.json: true                           # 以json格式输出日志\n  logging.verbose: true                        # 记录所有事件，包括系统使用信息和所以请求\n  i18n.locale: \"zh-CN\"                         # 设置kibana为中文\n```\n### 创建依赖文件\n```bash\n$ touch /var/log/kibana.log      # 创建日志文件\n\n$ touch /var/run/kibana.pid      # 创建进程文件\n\n$ chown -R elastic.elastic /elastic && \\\nchown -R elastic.elastic /var/log/kibana.log && \\\nchown -R elastic.elastic /var/run/kibana.pid     # 修改elastic工作目录及相关工作文件所有者\n```\n>Tips：默认Kibana是支持root运行的，我这里为了统一elasticsearch运行环境所以打算elastic用户运行。\n\n### 准备kibana systemctl文件\n```bash\n[Unit]\nDescription=Kibana\nDocumentation=http://www.elastic.co\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nUser=elastic\nGroup=elastic\nExecStart=/elastic/kibana-7.0.1-linux-x86_64/bin/kibana\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\n```\n### 启动kibana\n```bash\n$ systemctl daemon-reload           # 加载systemctl配置文件\n\n$ systemctl start kibana            # 启动kibana\n\n$ systemctl enable kibana           # 设置开机启动kibana\n```\n> Kibana默认监控在5601端口上，此时可以通过`http://192.168.20.211:5601`访问kibana。\n\n## 安装cerebro可视化集群管理工具\ncerebro是一个使用Scala，Play Framework，AngularJS和Bootstrap构建的开源（MIT许可）elasticsearch web可视化的监控工具，[Github项目](https://github.com/lmenezes/cerebro)\n以下操作只在`efk-node2`主机上进行：\n### 下载和解压\n请前往https://github.com/lmenezes/cerebro/releases 地址下载cerebro工具\n```json\n$ tar zxvf cerebro-0.8.3.tgz\n$ vim cerebro-0.8.3/conf/application.conf  \n# 设置cerebro密码登陆认证\nauth={\n    type: basic\n    settings: {\n        username=\"admin\"\n        password=\"pyker123456\"\n    }\n}\n# 文件最后配置elasticsearch地址\nhosts = [\n  {\n    host = \"http://192.168.20.211:9200\"\n    name = \"efk-cluster\"\n  },\n```\n### 准备cerebro systemctl文件\n```bash\n[Unit]\nDescription=Cerebro\nAfter=network.target\n\n[Service]\nEnvironment=JAVA_HOME=/usr/local/jdk1.8.0_171\nUser=elastic\nGroup=elastic\nLimitNOFILE=65535\nExecStart=/elastic/cerebro-0.8.3/bin/cerebro -Dconfig.file=/elastic/cerebro-0.8.3/conf/application.conf -Dhttp.port=1234\nRestart=on-failure\nWorkingDirectory=/elastic/cerebro-0.8.3\n\n[Install]\nWantedBy=multi-user.target\n```\n### 命令启动cerebro\n```bash\n# 默认9000端口\n$ nohup ./bin/cerebro -Dhttp.port=1234 -Dhttp.address=192.168.20.212 &\n```\n### systemctl方式启动cerebro\n```bash\n$ systemctl daemon-reload           # 加载systemctl配置文件\n\n$ systemctl start cerebro           # 启动cerebro\n\n$ systemctl enable cerebro          # 设置开机启动cerebro\n```\n### 访问cerebro\n通过浏览器访问`http://192.168.20.212:1234`就可以cerebro工具了。该工具详细的显示了es集群状态、节点数、索引数、分片数、文档数以及数据大小等参数。\n![](/images/pic/cerebro.png)\n\n## 安装filebeat\n[此前文档](https://www.ipyker.com/2019/03/14/filebeat/)我们已经说明了关于filebeat的原理，以及一些配置文件参数。现在我们只初略的说明我们已使用的配置参数。以下操作只在`real-server`主机上进行：（也就是我们业务所跑的服务器，我们要抓取的是业务日志，所以当然是安装在业务服务器上咯）\n### 下载和解压\n```bash\n# 进入elastic工作目录\n$ mkdir /elastic &&& cd /elastic\n\n# 下载kibana tar包\n$ wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.0.1-linux-x86_64.tar.gz\n\n# 解压到当前/elastic目录\n$ tar zxvf filebeat-7.0.1-linux-x86_64.tar.gz\n```\n>{% label info@本例我们使用filebeat监控tomcat日志和nginx日志 %}\n### 修改配置文件\n#### 以配置文件方式支持tomcat日志输入\n下面只列出已配置的参数，关于参数说明，请参考[此前文档](https://www.ipyker.com/2019/03/14/filebeat/)\n```yaml\n$ cat filebeat-7.0.1-linux-x86_64/filebeat.yml\nfilebeat.inputs:\n- type: log\n  enabled: true\n  paths:\n    - /usr/local/tomcat/logs/catalina.out   # 监控tomcat控制台catalina.out日志文件\n  fields:\n    log_topic: tomcat_access_logs\n  exclude_lines: ['收到ping的消息']\n  multiline.pattern: '^[[:space:]]+|^Caused by:'\n  multiline.negate: false\n  multiline.match: after\n  ignore_older: 0\n  close_inactive: 2m\n\n- type: log\n  enabled: true\n  paths:\n    - /usr/local/tomcat/logs/localhost_access.*  # 监控tomcat访问localhost_access日志文件\n  fields:\n    log_topic: tomcat_catalina_logs\nfilebeat.config.modules:\n  path: ${path.config}/modules.d/*.yml\n  reload.enabled: true\nsetup.template.settings:\n  index.number_of_shards: 1\nsetup.kibana:\n  host: \"192.168.20.211:5601\"\noutput.elasticsearch:     # 我们这里直接输出到ES，当然也可以输出到logstash、kafka等中间件\n  hosts: [\"192.168.20.211:9200\"]\n  #protocol: \"https\"\n  username: \"elastic\"\n  password: \"pyker123456\"\nprocessors:\n  - add_host_metadata: ~\n  - add_cloud_metadata: ~\n```\n>{% label warning@catalina.out和localhost_access都需要使用一定的格式。方便filebeat处理多行事件日志。 %}\n\n#### 以模版方式支持nginx日志输入\n默认filebeat自带诸多服务日志模版，如：nginx、redis、apache、IIS、kafka等等。默认都在filebeat解压后`module`、`modules.d`目录中。\n```yaml\n$ cat /elastic/filebeat-7.0.1-linux-x86_64/modules.d/nginx.yml.disabled\n- module: nginx\n  access:\n    enabled: true\n    var.paths: [\"/data/wwwlogs/access.log*\"]  # 配置nginx实际的访问日志路径，多个文件逗号分开\n  error:\n    enabled: true\n    var.paths: [\"/data/wwwlogs/error_nginx.log*\"]  # 配置nginx实际的错误日志路径\n```\n\n#### 启动nginx模版\n```bash\n$ cd /elastic/filebeat-7.0.1-linux-x86_64\n$ ./filebeat modules enable nginx \n\n$ ./filebeat modules list     # 列出已启动和未启动的模版\nEnabled:\nnginx\nsystem\n\nDisabled\napache\nauditd\n...\n```\n### 准备filebeat systemctl文件\n```bash\n[Unit]\nDescription=Filebeat sends log files to Logstash or directly to Elasticsearch.\nDocumentation=https://www.elastic.co/products/beats/filebeat\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nExecStart=/elastic/filebeat-7.0.1-linux-x86_64/filebeat -c /elastic/filebeat-7.0.1-linux-x86_64/filebeat.yml\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\n```\n### 启动filebeat\n```bash\n$ systemctl daemon-reload           # 加载systemctl配置文件\n\n$ systemctl start filebeat            # 启动filebeat\n\n$ systemctl enable filebeat           # 设置开机启动filebeat\n```\n至此简单的EFK集群搭建完成。在生成环境中 我们还会在filebeat和elasticsearch中间加入kafka和logstash来提高日志数据的高效传输和更强的日志过滤功能，而kafka又可以配置成集群模式。\n\n**在当前文档中我们并未说明kibana如何使用，请参考[官方使用教程](https://www.elastic.co/guide/cn/kibana/current/introduction.html)**","source":"_posts/install-efk.md","raw":"layout: post\ntitle: Elastic stack之EFK安装\nauthor: Pyker\ncategories: elastic\nimg: /images/bar/kibana.jpg\ntags:\n  - elasticsearch\n  - filebeat\n  - kibana\ntop: false\ncover: false\ndate: 2019-03-15 14:15:00\n---\n## 试验环境\n本次试验的`elastic stack`软件都为`7.0.1`版本，现在官网最新的为7.1版本，用户可在官方下载[下载地址](https://www.elastic.co/cn/downloads/)。\n\n主机名 | ip地址 | 服务\n--- | --- | ---\nefk-node1 | 192.168.20.211 | elasticsearch、kibana、jdk8\nefk-node2 | 192.168.20.212 | elasticsearch、cerebro、jdk8\nreal-server | 192.168.20.250 | filebeat\n\n## 环境准备\n### 安装JDK\nelasticsearch需要jdk环境的支持，7.0.1版本默认已经自带JDK了，但是为了日后扩展问题，我们还是手动配置一边JDK环境。以下操作在`efk-node1`和`efk-node2`主机上进行：\n```bash\n# 下面下载链接因授权问题，需用户前往JDK官网下载\n$ wget https://download.oracle.com/otn/java/jdk/8u171-b12/478a62b7d4e34b78b671c754eaaf38ab/jdk-8u171-linux-x64.tar.gz\n\n$ tar zxvf jdk-8u171-linux-x64.tar.gz -C /usr/local/\n\n$ cat >> /etc/profile << EOF\nexport JAVA_HOME=/usr/local/jdk1.8.0_171\nexport CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar\nexport PATH=$JAVA_HOME/bin:$PATH\nEOF\n\n$ source /etc/profile\n\n# 验证JDK, JDK配置完成\n$ java -version\njava version \"1.8.0_171\"\nJava(TM) SE Runtime Environment (build 1.8.0_171-b11)\nJava HotSpot(TM) 64-Bit Server VM (build 25.171-b11, mixed mode)\n```\n### 设置服务器的最大文件数\n```bash\n$ cat >> /etc/security/limits.conf << EOF\n * soft nofile 655350\n * hard nofile 655350\n * soft nproc 655350\n * hard nproc 655350\nEOF\n```\n### 设置服务器打开的最大进程数\n```bash\n$ cat > /etc/security/limits.d/20-nproc.conf << EOF\n*          soft    nproc     4096\nroot       soft    nproc     unlimited\nEOF\n```\n### 设置nmap数量对虚拟内存的支持\n```bash\n$ cat >> /etc/sysctl.conf << EOF\nvm.max_map_count=262144\nEOF\n\n$  sysctl -p\n```\n### 本地host解析\n```bash\ncat >> /etc/hosts << EOF\nefk-node1 192.168.20.211\nefk-node2 192.168.20.212\nreal-server 192.168.20.250\nEOF\n```\n## 安装elasticsearch\n以下操作在`efk-node1`和`efk-node2`主机上进行：\n### 下载和解压\n```bash\n# 创建elastic工作目录\n$ mkdir /elastic && cd /elastic\n\n# 下载elasticsearch tar包\n$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.0.1-linux-x86_64.tar.gz\n\n# 解压到当前/elastic目录\n$ tar zxvf elasticsearch-7.0.1-linux-x86_64.tar.gz\n```\n### 修改配置文件\n下面只列出已配置的参数\n```bash\n$ cat elasticsearch-7.0.1/config/elasticsearch.yml | egrep -v \"^$|^#\"\n  cluster.name: efk-cluster     # 集群名称\n  node.name: efk-node1          # 节点名称，212服务器改成efk-node2\n  path.data: /var/lib/elasticsearch     # elasticsearch数据目录\n  path.logs: /var/log/elasticsearch     # elasticsearch日志目录\n  network.host: 0.0.0.0                 # elasticsearch绑定的地址\n  http.port: 9200                       # elasticsearch绑定的端口\n  discovery.seed_hosts: [\"efk-node1\", \"efk-node2\"]  #集群发现\n  cluster.initial_master_nodes: [\"efk-node1\", \"efk-node2\"]  #第一次访问初始的集群节点\n  xpack.security.enabled: true          # ssl\\tls安全参数\n  xpack.security.transport.ssl.enabled: true    # ssl\\tls安全参数\n```\n### 创建运行elasticsearch用户\n> elasticsearch默认是不运行root用户运行的，因此我们得创建一个新用户来运行elasticsearch。\n\n```bash\n$ useradd elastic\n$ passwd elastic\n```\n### 创建依赖文件\n```bash\n$ mkdir /var/log/elasticsearch      # 创建日志目录\n\n$ mkdir /var/lib/elasticsearch      # 创建数据目录\n\n$ touch /var/run/elasticsearch.pid  # 创建进程文件\n\n$ chown -R elastic.elastic /elastic # 修改elastic工作目录所有者\n$ chown -R elastic.elastic /var/log/elasticsearch && \\\nchown -R elastic.elastic /var/lib/elasticsearch && \\\nchown -R elastic.elastic /var/run/elasticsearch.pid   # 相关目录所有者都修改成运行elasticsearch服务的用户\n```\n### 准备elasticsearch systemctl文件\n```bash\n[Unit]\nDescription=Elasticsearch\nDocumentation=http://www.elastic.co\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nEnvironment=JAVA_HOME=/usr/local/jdk1.8.0_171\nUser=elastic\nGroup=elastic\nExecStart=/elastic/elasticsearch-7.0.1/bin/elasticsearch -p /var/run/elasticsearch.pid\n\nLimitNOFILE=65535\nLimitNPROC=65535\nLimitAS=infinity\nLimitFSIZE=infinity\n\n[Install]\nWantedBy=multi-user.target\n```\n### 启动elasticsearch\n```bash\n$ systemctl daemon-reload           # 加载systemctl配置文件\n\n$ systemctl start elasticsearch     # 启动elasticsearch\n\n$ systemctl enable elasticsearch    # 设置开机启动elasticsearch\n```\n>**Tips**: elasticsearch7.0.1安装完默认自带基础版的X-Pack功能，使用铂金版的需要购买或者参考[破解X-pack](https://www.ipyker.com/2019/03/13/elastic-x-pack/)进行破解。\n\n### 验证集群状态\n通过上面的配置，我们的elasticsearch服务器已经启动，并且默认监听在`9200`和`9300`端口。\n`9200端口`: 为web访问提供服务；`9300端口`：为集群节点提供通信。\n```bash\n# 验证集群节点数，其中master为*的代表该节点为主节点\n$ curl http://192.168.20.211:9200/_cat/nodes?v\nip             heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name\n192.168.20.212           10          39   0    0.00    0.01     0.05 mdi       -      efk-node2\n192.168.20.211           18          37   0    0.00    0.01     0.05 mdi       *      efk-node1\n\n# 验证集群健康状态，status为green表示正常\n$ curl http://192.168.20.211:9200/_cat/health?v\nepoch      timestamp cluster        status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent\n1558517253 09:27:33  efk-cluster green           2         2      6   3    0    0        0             0                  -                100.0%\n```\n{% note success %}由上可知，我们的elasticsearch集群已经正常工作了，并且在2台集群节点下/var/lib/elasticsearch目录下都有相同的数据。更多关于elasticsearch REST API请参考官方说明。\n[cluster apis](https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cluster.html) [_cat apis](https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cat.html) [Search apis](https://www.elastic.co/guide/en/elasticsearch/reference/7.0/search.html) [Document apis](https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docs.html) {% endnote %}\n## 安装 Kibana\n以下操作只在`efk-node1`主机上进行：\n### 下载和解压\n```bash\n# 进入elastic工作目录\n$ cd /elastic\n\n# 下载kibana tar包\n$ wget https://artifacts.elastic.co/downloads/kibana/kibana-7.0.1-linux-x86_64.tar.gz\n\n# 解压到当前/elastic目录\n$ tar zxvf kibana-7.0.1-linux-x86_64.tar.gz\n```\n### 修改配置文件\n下面只列出已配置的参数\n```bash\n$ cat kibana-7.0.1-linux-x86_64/config/kibana.yml | egrep -v \"^$|^#\"\n  server.port: 5601           # kibana服务端口\n  server.host: \"0.0.0.0\"      # kibana服务地址\n  elasticsearch.hosts: [\"http://192.168.20.201:9200\"]  # es访问地址，kibana需要和它通信\n  elasticsearch.username: \"elastic\"            # es帐号，如果是X-pack铂金版可配\n  elasticsearch.password: \"pyker123456\"        # es密码，如果是X-pack铂金版可配\n  elasticsearch.logQueries: true               # 查询日志是否发送到ES，配合logging.json: true\n  pid.file: /var/run/kibana.pid                # kibana的进行id文件\n  logging.dest: /var/log/kibana.log            # kibana日志文件\n  logging.json: true                           # 以json格式输出日志\n  logging.verbose: true                        # 记录所有事件，包括系统使用信息和所以请求\n  i18n.locale: \"zh-CN\"                         # 设置kibana为中文\n```\n### 创建依赖文件\n```bash\n$ touch /var/log/kibana.log      # 创建日志文件\n\n$ touch /var/run/kibana.pid      # 创建进程文件\n\n$ chown -R elastic.elastic /elastic && \\\nchown -R elastic.elastic /var/log/kibana.log && \\\nchown -R elastic.elastic /var/run/kibana.pid     # 修改elastic工作目录及相关工作文件所有者\n```\n>Tips：默认Kibana是支持root运行的，我这里为了统一elasticsearch运行环境所以打算elastic用户运行。\n\n### 准备kibana systemctl文件\n```bash\n[Unit]\nDescription=Kibana\nDocumentation=http://www.elastic.co\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nUser=elastic\nGroup=elastic\nExecStart=/elastic/kibana-7.0.1-linux-x86_64/bin/kibana\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\n```\n### 启动kibana\n```bash\n$ systemctl daemon-reload           # 加载systemctl配置文件\n\n$ systemctl start kibana            # 启动kibana\n\n$ systemctl enable kibana           # 设置开机启动kibana\n```\n> Kibana默认监控在5601端口上，此时可以通过`http://192.168.20.211:5601`访问kibana。\n\n## 安装cerebro可视化集群管理工具\ncerebro是一个使用Scala，Play Framework，AngularJS和Bootstrap构建的开源（MIT许可）elasticsearch web可视化的监控工具，[Github项目](https://github.com/lmenezes/cerebro)\n以下操作只在`efk-node2`主机上进行：\n### 下载和解压\n请前往https://github.com/lmenezes/cerebro/releases 地址下载cerebro工具\n```json\n$ tar zxvf cerebro-0.8.3.tgz\n$ vim cerebro-0.8.3/conf/application.conf  \n# 设置cerebro密码登陆认证\nauth={\n    type: basic\n    settings: {\n        username=\"admin\"\n        password=\"pyker123456\"\n    }\n}\n# 文件最后配置elasticsearch地址\nhosts = [\n  {\n    host = \"http://192.168.20.211:9200\"\n    name = \"efk-cluster\"\n  },\n```\n### 准备cerebro systemctl文件\n```bash\n[Unit]\nDescription=Cerebro\nAfter=network.target\n\n[Service]\nEnvironment=JAVA_HOME=/usr/local/jdk1.8.0_171\nUser=elastic\nGroup=elastic\nLimitNOFILE=65535\nExecStart=/elastic/cerebro-0.8.3/bin/cerebro -Dconfig.file=/elastic/cerebro-0.8.3/conf/application.conf -Dhttp.port=1234\nRestart=on-failure\nWorkingDirectory=/elastic/cerebro-0.8.3\n\n[Install]\nWantedBy=multi-user.target\n```\n### 命令启动cerebro\n```bash\n# 默认9000端口\n$ nohup ./bin/cerebro -Dhttp.port=1234 -Dhttp.address=192.168.20.212 &\n```\n### systemctl方式启动cerebro\n```bash\n$ systemctl daemon-reload           # 加载systemctl配置文件\n\n$ systemctl start cerebro           # 启动cerebro\n\n$ systemctl enable cerebro          # 设置开机启动cerebro\n```\n### 访问cerebro\n通过浏览器访问`http://192.168.20.212:1234`就可以cerebro工具了。该工具详细的显示了es集群状态、节点数、索引数、分片数、文档数以及数据大小等参数。\n![](/images/pic/cerebro.png)\n\n## 安装filebeat\n[此前文档](https://www.ipyker.com/2019/03/14/filebeat/)我们已经说明了关于filebeat的原理，以及一些配置文件参数。现在我们只初略的说明我们已使用的配置参数。以下操作只在`real-server`主机上进行：（也就是我们业务所跑的服务器，我们要抓取的是业务日志，所以当然是安装在业务服务器上咯）\n### 下载和解压\n```bash\n# 进入elastic工作目录\n$ mkdir /elastic &&& cd /elastic\n\n# 下载kibana tar包\n$ wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.0.1-linux-x86_64.tar.gz\n\n# 解压到当前/elastic目录\n$ tar zxvf filebeat-7.0.1-linux-x86_64.tar.gz\n```\n>{% label info@本例我们使用filebeat监控tomcat日志和nginx日志 %}\n### 修改配置文件\n#### 以配置文件方式支持tomcat日志输入\n下面只列出已配置的参数，关于参数说明，请参考[此前文档](https://www.ipyker.com/2019/03/14/filebeat/)\n```yaml\n$ cat filebeat-7.0.1-linux-x86_64/filebeat.yml\nfilebeat.inputs:\n- type: log\n  enabled: true\n  paths:\n    - /usr/local/tomcat/logs/catalina.out   # 监控tomcat控制台catalina.out日志文件\n  fields:\n    log_topic: tomcat_access_logs\n  exclude_lines: ['收到ping的消息']\n  multiline.pattern: '^[[:space:]]+|^Caused by:'\n  multiline.negate: false\n  multiline.match: after\n  ignore_older: 0\n  close_inactive: 2m\n\n- type: log\n  enabled: true\n  paths:\n    - /usr/local/tomcat/logs/localhost_access.*  # 监控tomcat访问localhost_access日志文件\n  fields:\n    log_topic: tomcat_catalina_logs\nfilebeat.config.modules:\n  path: ${path.config}/modules.d/*.yml\n  reload.enabled: true\nsetup.template.settings:\n  index.number_of_shards: 1\nsetup.kibana:\n  host: \"192.168.20.211:5601\"\noutput.elasticsearch:     # 我们这里直接输出到ES，当然也可以输出到logstash、kafka等中间件\n  hosts: [\"192.168.20.211:9200\"]\n  #protocol: \"https\"\n  username: \"elastic\"\n  password: \"pyker123456\"\nprocessors:\n  - add_host_metadata: ~\n  - add_cloud_metadata: ~\n```\n>{% label warning@catalina.out和localhost_access都需要使用一定的格式。方便filebeat处理多行事件日志。 %}\n\n#### 以模版方式支持nginx日志输入\n默认filebeat自带诸多服务日志模版，如：nginx、redis、apache、IIS、kafka等等。默认都在filebeat解压后`module`、`modules.d`目录中。\n```yaml\n$ cat /elastic/filebeat-7.0.1-linux-x86_64/modules.d/nginx.yml.disabled\n- module: nginx\n  access:\n    enabled: true\n    var.paths: [\"/data/wwwlogs/access.log*\"]  # 配置nginx实际的访问日志路径，多个文件逗号分开\n  error:\n    enabled: true\n    var.paths: [\"/data/wwwlogs/error_nginx.log*\"]  # 配置nginx实际的错误日志路径\n```\n\n#### 启动nginx模版\n```bash\n$ cd /elastic/filebeat-7.0.1-linux-x86_64\n$ ./filebeat modules enable nginx \n\n$ ./filebeat modules list     # 列出已启动和未启动的模版\nEnabled:\nnginx\nsystem\n\nDisabled\napache\nauditd\n...\n```\n### 准备filebeat systemctl文件\n```bash\n[Unit]\nDescription=Filebeat sends log files to Logstash or directly to Elasticsearch.\nDocumentation=https://www.elastic.co/products/beats/filebeat\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nExecStart=/elastic/filebeat-7.0.1-linux-x86_64/filebeat -c /elastic/filebeat-7.0.1-linux-x86_64/filebeat.yml\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\n```\n### 启动filebeat\n```bash\n$ systemctl daemon-reload           # 加载systemctl配置文件\n\n$ systemctl start filebeat            # 启动filebeat\n\n$ systemctl enable filebeat           # 设置开机启动filebeat\n```\n至此简单的EFK集群搭建完成。在生成环境中 我们还会在filebeat和elasticsearch中间加入kafka和logstash来提高日志数据的高效传输和更强的日志过滤功能，而kafka又可以配置成集群模式。\n\n**在当前文档中我们并未说明kibana如何使用，请参考[官方使用教程](https://www.elastic.co/guide/cn/kibana/current/introduction.html)**","slug":"install-efk","published":1,"updated":"2019-05-28T02:02:23.505Z","_id":"cjw6jlf0o002fp4n7d54m45ap","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"试验环境\"><a href=\"#试验环境\" class=\"headerlink\" title=\"试验环境\"></a>试验环境</h2><p>本次试验的<code>elastic stack</code>软件都为<code>7.0.1</code>版本，现在官网最新的为7.1版本，用户可在官方下载<a href=\"https://www.elastic.co/cn/downloads/\" target=\"_blank\" rel=\"noopener\">下载地址</a>。</p>\n<table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>ip地址</th>\n<th>服务</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>efk-node1</td>\n<td>192.168.20.211</td>\n<td>elasticsearch、kibana、jdk8</td>\n</tr>\n<tr>\n<td>efk-node2</td>\n<td>192.168.20.212</td>\n<td>elasticsearch、cerebro、jdk8</td>\n</tr>\n<tr>\n<td>real-server</td>\n<td>192.168.20.250</td>\n<td>filebeat</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><h3 id=\"安装JDK\"><a href=\"#安装JDK\" class=\"headerlink\" title=\"安装JDK\"></a>安装JDK</h3><p>elasticsearch需要jdk环境的支持，7.0.1版本默认已经自带JDK了，但是为了日后扩展问题，我们还是手动配置一边JDK环境。以下操作在<code>efk-node1</code>和<code>efk-node2</code>主机上进行：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下面下载链接因授权问题，需用户前往JDK官网下载</span></span><br><span class=\"line\">$ wget https://download.oracle.com/otn/java/jdk/8u171-b12/478a62b7d4e34b78b671c754eaaf38ab/jdk-8u171-linux-x64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">$ tar zxvf jdk-8u171-linux-x64.tar.gz -C /usr/<span class=\"built_in\">local</span>/</span><br><span class=\"line\"></span><br><span class=\"line\">$ cat &gt;&gt; /etc/profile &lt;&lt; EOF</span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_HOME=/usr/<span class=\"built_in\">local</span>/jdk1.8.0_171</span><br><span class=\"line\"><span class=\"built_in\">export</span> CLASSPATH=.:<span class=\"variable\">$JAVA_HOME</span>/lib/dt.jar:<span class=\"variable\">$JAVA_HOME</span>/lib/tools.jar</span><br><span class=\"line\"><span class=\"built_in\">export</span> PATH=<span class=\"variable\">$JAVA_HOME</span>/bin:<span class=\"variable\">$PATH</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">source</span> /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证JDK, JDK配置完成</span></span><br><span class=\"line\">$ java -version</span><br><span class=\"line\">java version <span class=\"string\">\"1.8.0_171\"</span></span><br><span class=\"line\">Java(TM) SE Runtime Environment (build 1.8.0_171-b11)</span><br><span class=\"line\">Java HotSpot(TM) 64-Bit Server VM (build 25.171-b11, mixed mode)</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"设置服务器的最大文件数\"><a href=\"#设置服务器的最大文件数\" class=\"headerlink\" title=\"设置服务器的最大文件数\"></a>设置服务器的最大文件数</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class=\"line\"> * soft nofile 655350</span><br><span class=\"line\"> * hard nofile 655350</span><br><span class=\"line\"> * soft nproc 655350</span><br><span class=\"line\"> * hard nproc 655350</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h3 id=\"设置服务器打开的最大进程数\"><a href=\"#设置服务器打开的最大进程数\" class=\"headerlink\" title=\"设置服务器打开的最大进程数\"></a>设置服务器打开的最大进程数</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat &gt; /etc/security/limits.d/20-nproc.conf &lt;&lt; EOF</span><br><span class=\"line\">*          soft    nproc     4096</span><br><span class=\"line\">root       soft    nproc     unlimited</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h3 id=\"设置nmap数量对虚拟内存的支持\"><a href=\"#设置nmap数量对虚拟内存的支持\" class=\"headerlink\" title=\"设置nmap数量对虚拟内存的支持\"></a>设置nmap数量对虚拟内存的支持</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF</span><br><span class=\"line\">vm.max_map_count=262144</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">$  sysctl -p</span><br></pre></td></tr></table></figure>\n<h3 id=\"本地host解析\"><a href=\"#本地host解析\" class=\"headerlink\" title=\"本地host解析\"></a>本地host解析</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class=\"line\">efk-node1 192.168.20.211</span><br><span class=\"line\">efk-node2 192.168.20.212</span><br><span class=\"line\">real-server 192.168.20.250</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h2 id=\"安装elasticsearch\"><a href=\"#安装elasticsearch\" class=\"headerlink\" title=\"安装elasticsearch\"></a>安装elasticsearch</h2><p>以下操作在<code>efk-node1</code>和<code>efk-node2</code>主机上进行：</p>\n<h3 id=\"下载和解压\"><a href=\"#下载和解压\" class=\"headerlink\" title=\"下载和解压\"></a>下载和解压</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建elastic工作目录</span></span><br><span class=\"line\">$ mkdir /elastic &amp;&amp; <span class=\"built_in\">cd</span> /elastic</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 下载elasticsearch tar包</span></span><br><span class=\"line\">$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.0.1-linux-x86_64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解压到当前/elastic目录</span></span><br><span class=\"line\">$ tar zxvf elasticsearch-7.0.1-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<h3 id=\"修改配置文件\"><a href=\"#修改配置文件\" class=\"headerlink\" title=\"修改配置文件\"></a>修改配置文件</h3><p>下面只列出已配置的参数<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat elasticsearch-7.0.1/config/elasticsearch.yml | egrep -v <span class=\"string\">\"^$|^#\"</span></span><br><span class=\"line\">  cluster.name: efk-cluster     <span class=\"comment\"># 集群名称</span></span><br><span class=\"line\">  node.name: efk-node1          <span class=\"comment\"># 节点名称，212服务器改成efk-node2</span></span><br><span class=\"line\">  path.data: /var/lib/elasticsearch     <span class=\"comment\"># elasticsearch数据目录</span></span><br><span class=\"line\">  path.logs: /var/<span class=\"built_in\">log</span>/elasticsearch     <span class=\"comment\"># elasticsearch日志目录</span></span><br><span class=\"line\">  network.host: 0.0.0.0                 <span class=\"comment\"># elasticsearch绑定的地址</span></span><br><span class=\"line\">  http.port: 9200                       <span class=\"comment\"># elasticsearch绑定的端口</span></span><br><span class=\"line\">  discovery.seed_hosts: [<span class=\"string\">\"efk-node1\"</span>, <span class=\"string\">\"efk-node2\"</span>]  <span class=\"comment\">#集群发现</span></span><br><span class=\"line\">  cluster.initial_master_nodes: [<span class=\"string\">\"efk-node1\"</span>, <span class=\"string\">\"efk-node2\"</span>]  <span class=\"comment\">#第一次访问初始的集群节点</span></span><br><span class=\"line\">  xpack.security.enabled: <span class=\"literal\">true</span>          <span class=\"comment\"># ssl\\tls安全参数</span></span><br><span class=\"line\">  xpack.security.transport.ssl.enabled: <span class=\"literal\">true</span>    <span class=\"comment\"># ssl\\tls安全参数</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"创建运行elasticsearch用户\"><a href=\"#创建运行elasticsearch用户\" class=\"headerlink\" title=\"创建运行elasticsearch用户\"></a>创建运行elasticsearch用户</h3><blockquote>\n<p>elasticsearch默认是不运行root用户运行的，因此我们得创建一个新用户来运行elasticsearch。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ useradd elastic</span><br><span class=\"line\">$ passwd elastic</span><br></pre></td></tr></table></figure>\n<h3 id=\"创建依赖文件\"><a href=\"#创建依赖文件\" class=\"headerlink\" title=\"创建依赖文件\"></a>创建依赖文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir /var/<span class=\"built_in\">log</span>/elasticsearch      <span class=\"comment\"># 创建日志目录</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ mkdir /var/lib/elasticsearch      <span class=\"comment\"># 创建数据目录</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ touch /var/run/elasticsearch.pid  <span class=\"comment\"># 创建进程文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ chown -R elastic.elastic /elastic <span class=\"comment\"># 修改elastic工作目录所有者</span></span><br><span class=\"line\">$ chown -R elastic.elastic /var/<span class=\"built_in\">log</span>/elasticsearch &amp;&amp; \\</span><br><span class=\"line\">chown -R elastic.elastic /var/lib/elasticsearch &amp;&amp; \\</span><br><span class=\"line\">chown -R elastic.elastic /var/run/elasticsearch.pid   <span class=\"comment\"># 相关目录所有者都修改成运行elasticsearch服务的用户</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"准备elasticsearch-systemctl文件\"><a href=\"#准备elasticsearch-systemctl文件\" class=\"headerlink\" title=\"准备elasticsearch systemctl文件\"></a>准备elasticsearch systemctl文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Elasticsearch</span><br><span class=\"line\">Documentation=http://www.elastic.co</span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Environment=JAVA_HOME=/usr/<span class=\"built_in\">local</span>/jdk1.8.0_171</span><br><span class=\"line\">User=elastic</span><br><span class=\"line\">Group=elastic</span><br><span class=\"line\">ExecStart=/elastic/elasticsearch-7.0.1/bin/elasticsearch -p /var/run/elasticsearch.pid</span><br><span class=\"line\"></span><br><span class=\"line\">LimitNOFILE=65535</span><br><span class=\"line\">LimitNPROC=65535</span><br><span class=\"line\">LimitAS=infinity</span><br><span class=\"line\">LimitFSIZE=infinity</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动elasticsearch\"><a href=\"#启动elasticsearch\" class=\"headerlink\" title=\"启动elasticsearch\"></a>启动elasticsearch</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ systemctl daemon-reload           <span class=\"comment\"># 加载systemctl配置文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl start elasticsearch     <span class=\"comment\"># 启动elasticsearch</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> elasticsearch    <span class=\"comment\"># 设置开机启动elasticsearch</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>Tips</strong>: elasticsearch7.0.1安装完默认自带基础版的X-Pack功能，使用铂金版的需要购买或者参考<a href=\"https://www.ipyker.com/2019/03/13/elastic-x-pack/\">破解X-pack</a>进行破解。</p>\n</blockquote>\n<h3 id=\"验证集群状态\"><a href=\"#验证集群状态\" class=\"headerlink\" title=\"验证集群状态\"></a>验证集群状态</h3><p>通过上面的配置，我们的elasticsearch服务器已经启动，并且默认监听在<code>9200</code>和<code>9300</code>端口。<br><code>9200端口</code>: 为web访问提供服务；<code>9300端口</code>：为集群节点提供通信。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 验证集群节点数，其中master为*的代表该节点为主节点</span></span><br><span class=\"line\">$ curl http://192.168.20.211:9200/_cat/nodes?v</span><br><span class=\"line\">ip             heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class=\"line\">192.168.20.212           10          39   0    0.00    0.01     0.05 mdi       -      efk-node2</span><br><span class=\"line\">192.168.20.211           18          37   0    0.00    0.01     0.05 mdi       *      efk-node1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证集群健康状态，status为green表示正常</span></span><br><span class=\"line\">$ curl http://192.168.20.211:9200/_cat/health?v</span><br><span class=\"line\">epoch      timestamp cluster        status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class=\"line\">1558517253 09:27:33  efk-cluster green           2         2      6   3    0    0        0             0                  -                100.0%</span><br></pre></td></tr></table></figure></p>\n<div class=\"note success\">\n            <p>由上可知，我们的elasticsearch集群已经正常工作了，并且在2台集群节点下/var/lib/elasticsearch目录下都有相同的数据。更多关于elasticsearch REST API请参考官方说明。<br><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cluster.html\" target=\"_blank\" rel=\"noopener\">cluster apis</a> <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cat.html\" target=\"_blank\" rel=\"noopener\">_cat apis</a> <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.0/search.html\" target=\"_blank\" rel=\"noopener\">Search apis</a> <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docs.html\" target=\"_blank\" rel=\"noopener\">Document apis</a> </p>\n          </div>\n<h2 id=\"安装-Kibana\"><a href=\"#安装-Kibana\" class=\"headerlink\" title=\"安装 Kibana\"></a>安装 Kibana</h2><p>以下操作只在<code>efk-node1</code>主机上进行：</p>\n<h3 id=\"下载和解压-1\"><a href=\"#下载和解压-1\" class=\"headerlink\" title=\"下载和解压\"></a>下载和解压</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入elastic工作目录</span></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> /elastic</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 下载kibana tar包</span></span><br><span class=\"line\">$ wget https://artifacts.elastic.co/downloads/kibana/kibana-7.0.1-linux-x86_64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解压到当前/elastic目录</span></span><br><span class=\"line\">$ tar zxvf kibana-7.0.1-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<h3 id=\"修改配置文件-1\"><a href=\"#修改配置文件-1\" class=\"headerlink\" title=\"修改配置文件\"></a>修改配置文件</h3><p>下面只列出已配置的参数<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat kibana-7.0.1-linux-x86_64/config/kibana.yml | egrep -v <span class=\"string\">\"^$|^#\"</span></span><br><span class=\"line\">  server.port: 5601           <span class=\"comment\"># kibana服务端口</span></span><br><span class=\"line\">  server.host: <span class=\"string\">\"0.0.0.0\"</span>      <span class=\"comment\"># kibana服务地址</span></span><br><span class=\"line\">  elasticsearch.hosts: [<span class=\"string\">\"http://192.168.20.201:9200\"</span>]  <span class=\"comment\"># es访问地址，kibana需要和它通信</span></span><br><span class=\"line\">  elasticsearch.username: <span class=\"string\">\"elastic\"</span>            <span class=\"comment\"># es帐号，如果是X-pack铂金版可配</span></span><br><span class=\"line\">  elasticsearch.password: <span class=\"string\">\"pyker123456\"</span>        <span class=\"comment\"># es密码，如果是X-pack铂金版可配</span></span><br><span class=\"line\">  elasticsearch.logQueries: <span class=\"literal\">true</span>               <span class=\"comment\"># 查询日志是否发送到ES，配合logging.json: true</span></span><br><span class=\"line\">  pid.file: /var/run/kibana.pid                <span class=\"comment\"># kibana的进行id文件</span></span><br><span class=\"line\">  logging.dest: /var/<span class=\"built_in\">log</span>/kibana.log            <span class=\"comment\"># kibana日志文件</span></span><br><span class=\"line\">  logging.json: <span class=\"literal\">true</span>                           <span class=\"comment\"># 以json格式输出日志</span></span><br><span class=\"line\">  logging.verbose: <span class=\"literal\">true</span>                        <span class=\"comment\"># 记录所有事件，包括系统使用信息和所以请求</span></span><br><span class=\"line\">  i18n.locale: <span class=\"string\">\"zh-CN\"</span>                         <span class=\"comment\"># 设置kibana为中文</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"创建依赖文件-1\"><a href=\"#创建依赖文件-1\" class=\"headerlink\" title=\"创建依赖文件\"></a>创建依赖文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ touch /var/<span class=\"built_in\">log</span>/kibana.log      <span class=\"comment\"># 创建日志文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ touch /var/run/kibana.pid      <span class=\"comment\"># 创建进程文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ chown -R elastic.elastic /elastic &amp;&amp; \\</span><br><span class=\"line\">chown -R elastic.elastic /var/<span class=\"built_in\">log</span>/kibana.log &amp;&amp; \\</span><br><span class=\"line\">chown -R elastic.elastic /var/run/kibana.pid     <span class=\"comment\"># 修改elastic工作目录及相关工作文件所有者</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>Tips：默认Kibana是支持root运行的，我这里为了统一elasticsearch运行环境所以打算elastic用户运行。</p>\n</blockquote>\n<h3 id=\"准备kibana-systemctl文件\"><a href=\"#准备kibana-systemctl文件\" class=\"headerlink\" title=\"准备kibana systemctl文件\"></a>准备kibana systemctl文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kibana</span><br><span class=\"line\">Documentation=http://www.elastic.co</span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">User=elastic</span><br><span class=\"line\">Group=elastic</span><br><span class=\"line\">ExecStart=/elastic/kibana-7.0.1-linux-x86_64/bin/kibana</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动kibana\"><a href=\"#启动kibana\" class=\"headerlink\" title=\"启动kibana\"></a>启动kibana</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ systemctl daemon-reload           <span class=\"comment\"># 加载systemctl配置文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl start kibana            <span class=\"comment\"># 启动kibana</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> kibana           <span class=\"comment\"># 设置开机启动kibana</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>Kibana默认监控在5601端口上，此时可以通过<code>http://192.168.20.211:5601</code>访问kibana。</p>\n</blockquote>\n<h2 id=\"安装cerebro可视化集群管理工具\"><a href=\"#安装cerebro可视化集群管理工具\" class=\"headerlink\" title=\"安装cerebro可视化集群管理工具\"></a>安装cerebro可视化集群管理工具</h2><p>cerebro是一个使用Scala，Play Framework，AngularJS和Bootstrap构建的开源（MIT许可）elasticsearch web可视化的监控工具，<a href=\"https://github.com/lmenezes/cerebro\" target=\"_blank\" rel=\"noopener\">Github项目</a><br>以下操作只在<code>efk-node2</code>主机上进行：</p>\n<h3 id=\"下载和解压-2\"><a href=\"#下载和解压-2\" class=\"headerlink\" title=\"下载和解压\"></a>下载和解压</h3><p>请前往<a href=\"https://github.com/lmenezes/cerebro/releases\" target=\"_blank\" rel=\"noopener\">https://github.com/lmenezes/cerebro/releases</a> 地址下载cerebro工具<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tar zxvf cerebro-0.8.3.tgz</span><br><span class=\"line\">$ vim cerebro-0.8.3/conf/application.conf  </span><br><span class=\"line\"># 设置cerebro密码登陆认证</span><br><span class=\"line\">auth=&#123;</span><br><span class=\"line\">    type: basic</span><br><span class=\"line\">    settings: &#123;</span><br><span class=\"line\">        username=\"admin\"</span><br><span class=\"line\">        password=\"pyker123456\"</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"># 文件最后配置elasticsearch地址</span><br><span class=\"line\">hosts = [</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    host = \"http://192.168.20.211:9200\"</span><br><span class=\"line\">    name = \"efk-cluster\"</span><br><span class=\"line\">  &#125;,</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"准备cerebro-systemctl文件\"><a href=\"#准备cerebro-systemctl文件\" class=\"headerlink\" title=\"准备cerebro systemctl文件\"></a>准备cerebro systemctl文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Cerebro</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Environment=JAVA_HOME=/usr/<span class=\"built_in\">local</span>/jdk1.8.0_171</span><br><span class=\"line\">User=elastic</span><br><span class=\"line\">Group=elastic</span><br><span class=\"line\">LimitNOFILE=65535</span><br><span class=\"line\">ExecStart=/elastic/cerebro-0.8.3/bin/cerebro -Dconfig.file=/elastic/cerebro-0.8.3/conf/application.conf -Dhttp.port=1234</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">WorkingDirectory=/elastic/cerebro-0.8.3</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h3 id=\"命令启动cerebro\"><a href=\"#命令启动cerebro\" class=\"headerlink\" title=\"命令启动cerebro\"></a>命令启动cerebro</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认9000端口</span></span><br><span class=\"line\">$ nohup ./bin/cerebro -Dhttp.port=1234 -Dhttp.address=192.168.20.212 &amp;</span><br></pre></td></tr></table></figure>\n<h3 id=\"systemctl方式启动cerebro\"><a href=\"#systemctl方式启动cerebro\" class=\"headerlink\" title=\"systemctl方式启动cerebro\"></a>systemctl方式启动cerebro</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ systemctl daemon-reload           <span class=\"comment\"># 加载systemctl配置文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl start cerebro           <span class=\"comment\"># 启动cerebro</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> cerebro          <span class=\"comment\"># 设置开机启动cerebro</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"访问cerebro\"><a href=\"#访问cerebro\" class=\"headerlink\" title=\"访问cerebro\"></a>访问cerebro</h3><p>通过浏览器访问<code>http://192.168.20.212:1234</code>就可以cerebro工具了。该工具详细的显示了es集群状态、节点数、索引数、分片数、文档数以及数据大小等参数。<br><img src=\"/images/pic/cerebro.png\" alt></p>\n<h2 id=\"安装filebeat\"><a href=\"#安装filebeat\" class=\"headerlink\" title=\"安装filebeat\"></a>安装filebeat</h2><p><a href=\"https://www.ipyker.com/2019/03/14/filebeat/\">此前文档</a>我们已经说明了关于filebeat的原理，以及一些配置文件参数。现在我们只初略的说明我们已使用的配置参数。以下操作只在<code>real-server</code>主机上进行：（也就是我们业务所跑的服务器，我们要抓取的是业务日志，所以当然是安装在业务服务器上咯）</p>\n<h3 id=\"下载和解压-3\"><a href=\"#下载和解压-3\" class=\"headerlink\" title=\"下载和解压\"></a>下载和解压</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入elastic工作目录</span></span><br><span class=\"line\">$ mkdir /elastic &amp;&amp;&amp; <span class=\"built_in\">cd</span> /elastic</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 下载kibana tar包</span></span><br><span class=\"line\">$ wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.0.1-linux-x86_64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解压到当前/elastic目录</span></span><br><span class=\"line\">$ tar zxvf filebeat-7.0.1-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<blockquote>\n<span class=\"label info\">本例我们使用filebeat监控tomcat日志和nginx日志</span>\n</blockquote>\n<h3 id=\"修改配置文件-2\"><a href=\"#修改配置文件-2\" class=\"headerlink\" title=\"修改配置文件\"></a>修改配置文件</h3><h4 id=\"以配置文件方式支持tomcat日志输入\"><a href=\"#以配置文件方式支持tomcat日志输入\" class=\"headerlink\" title=\"以配置文件方式支持tomcat日志输入\"></a>以配置文件方式支持tomcat日志输入</h4><p>下面只列出已配置的参数，关于参数说明，请参考<a href=\"https://www.ipyker.com/2019/03/14/filebeat/\">此前文档</a><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">cat</span> <span class=\"string\">filebeat-7.0.1-linux-x86_64/filebeat.yml</span></span><br><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/usr/local/tomcat/logs/catalina.out</span>   <span class=\"comment\"># 监控tomcat控制台catalina.out日志文件</span></span><br><span class=\"line\"><span class=\"attr\">  fields:</span></span><br><span class=\"line\"><span class=\"attr\">    log_topic:</span> <span class=\"string\">tomcat_access_logs</span></span><br><span class=\"line\"><span class=\"attr\">  exclude_lines:</span> <span class=\"string\">['收到ping的消息']</span></span><br><span class=\"line\">  <span class=\"string\">multiline.pattern:</span> <span class=\"string\">'^[[:space:]]+|^Caused by:'</span></span><br><span class=\"line\">  <span class=\"string\">multiline.negate:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"string\">multiline.match:</span> <span class=\"string\">after</span></span><br><span class=\"line\"><span class=\"attr\">  ignore_older:</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">  close_inactive:</span> <span class=\"number\">2</span><span class=\"string\">m</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/usr/local/tomcat/logs/localhost_access.*</span>  <span class=\"comment\"># 监控tomcat访问localhost_access日志文件</span></span><br><span class=\"line\"><span class=\"attr\">  fields:</span></span><br><span class=\"line\"><span class=\"attr\">    log_topic:</span> <span class=\"string\">tomcat_catalina_logs</span></span><br><span class=\"line\"><span class=\"string\">filebeat.config.modules:</span></span><br><span class=\"line\"><span class=\"attr\">  path:</span> <span class=\"string\">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class=\"line\">  <span class=\"string\">reload.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">setup.template.settings:</span></span><br><span class=\"line\">  <span class=\"string\">index.number_of_shards:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"string\">setup.kibana:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"string\">\"192.168.20.211:5601\"</span></span><br><span class=\"line\"><span class=\"string\">output.elasticsearch:</span>     <span class=\"comment\"># 我们这里直接输出到ES，当然也可以输出到logstash、kafka等中间件</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"192.168.20.211:9200\"]</span></span><br><span class=\"line\">  <span class=\"comment\">#protocol: \"https\"</span></span><br><span class=\"line\"><span class=\"attr\">  username:</span> <span class=\"string\">\"elastic\"</span></span><br><span class=\"line\"><span class=\"attr\">  password:</span> <span class=\"string\">\"pyker123456\"</span></span><br><span class=\"line\"><span class=\"attr\">processors:</span></span><br><span class=\"line\"><span class=\"attr\">  - add_host_metadata:</span> <span class=\"string\">~</span></span><br><span class=\"line\"><span class=\"attr\">  - add_cloud_metadata:</span> <span class=\"string\">~</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<span class=\"label warning\">catalina.out和localhost_access都需要使用一定的格式。方便filebeat处理多行事件日志。</span>\n</blockquote>\n<h4 id=\"以模版方式支持nginx日志输入\"><a href=\"#以模版方式支持nginx日志输入\" class=\"headerlink\" title=\"以模版方式支持nginx日志输入\"></a>以模版方式支持nginx日志输入</h4><p>默认filebeat自带诸多服务日志模版，如：nginx、redis、apache、IIS、kafka等等。默认都在filebeat解压后<code>module</code>、<code>modules.d</code>目录中。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">cat</span> <span class=\"string\">/elastic/filebeat-7.0.1-linux-x86_64/modules.d/nginx.yml.disabled</span></span><br><span class=\"line\"><span class=\"attr\">- module:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  access:</span></span><br><span class=\"line\"><span class=\"attr\">    enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"string\">var.paths:</span> <span class=\"string\">[\"/data/wwwlogs/access.log*\"]</span>  <span class=\"comment\"># 配置nginx实际的访问日志路径，多个文件逗号分开</span></span><br><span class=\"line\"><span class=\"attr\">  error:</span></span><br><span class=\"line\"><span class=\"attr\">    enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"string\">var.paths:</span> <span class=\"string\">[\"/data/wwwlogs/error_nginx.log*\"]</span>  <span class=\"comment\"># 配置nginx实际的错误日志路径</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"启动nginx模版\"><a href=\"#启动nginx模版\" class=\"headerlink\" title=\"启动nginx模版\"></a>启动nginx模版</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> /elastic/filebeat-7.0.1-linux-x86_64</span><br><span class=\"line\">$ ./filebeat modules <span class=\"built_in\">enable</span> nginx </span><br><span class=\"line\"></span><br><span class=\"line\">$ ./filebeat modules list     <span class=\"comment\"># 列出已启动和未启动的模版</span></span><br><span class=\"line\">Enabled:</span><br><span class=\"line\">nginx</span><br><span class=\"line\">system</span><br><span class=\"line\"></span><br><span class=\"line\">Disabled</span><br><span class=\"line\">apache</span><br><span class=\"line\">auditd</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<h3 id=\"准备filebeat-systemctl文件\"><a href=\"#准备filebeat-systemctl文件\" class=\"headerlink\" title=\"准备filebeat systemctl文件\"></a>准备filebeat systemctl文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Filebeat sends <span class=\"built_in\">log</span> files to Logstash or directly to Elasticsearch.</span><br><span class=\"line\">Documentation=https://www.elastic.co/products/beats/filebeat</span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">ExecStart=/elastic/filebeat-7.0.1-linux-x86_64/filebeat -c /elastic/filebeat-7.0.1-linux-x86_64/filebeat.yml</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动filebeat\"><a href=\"#启动filebeat\" class=\"headerlink\" title=\"启动filebeat\"></a>启动filebeat</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ systemctl daemon-reload           <span class=\"comment\"># 加载systemctl配置文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl start filebeat            <span class=\"comment\"># 启动filebeat</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> filebeat           <span class=\"comment\"># 设置开机启动filebeat</span></span><br></pre></td></tr></table></figure>\n<p>至此简单的EFK集群搭建完成。在生成环境中 我们还会在filebeat和elasticsearch中间加入kafka和logstash来提高日志数据的高效传输和更强的日志过滤功能，而kafka又可以配置成集群模式。</p>\n<p><strong>在当前文档中我们并未说明kibana如何使用，请参考<a href=\"https://www.elastic.co/guide/cn/kibana/current/introduction.html\" target=\"_blank\" rel=\"noopener\">官方使用教程</a></strong></p>\n","site":{"data":{}},"length":10369,"excerpt":"","more":"<h2 id=\"试验环境\"><a href=\"#试验环境\" class=\"headerlink\" title=\"试验环境\"></a>试验环境</h2><p>本次试验的<code>elastic stack</code>软件都为<code>7.0.1</code>版本，现在官网最新的为7.1版本，用户可在官方下载<a href=\"https://www.elastic.co/cn/downloads/\" target=\"_blank\" rel=\"noopener\">下载地址</a>。</p>\n<table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>ip地址</th>\n<th>服务</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>efk-node1</td>\n<td>192.168.20.211</td>\n<td>elasticsearch、kibana、jdk8</td>\n</tr>\n<tr>\n<td>efk-node2</td>\n<td>192.168.20.212</td>\n<td>elasticsearch、cerebro、jdk8</td>\n</tr>\n<tr>\n<td>real-server</td>\n<td>192.168.20.250</td>\n<td>filebeat</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><h3 id=\"安装JDK\"><a href=\"#安装JDK\" class=\"headerlink\" title=\"安装JDK\"></a>安装JDK</h3><p>elasticsearch需要jdk环境的支持，7.0.1版本默认已经自带JDK了，但是为了日后扩展问题，我们还是手动配置一边JDK环境。以下操作在<code>efk-node1</code>和<code>efk-node2</code>主机上进行：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下面下载链接因授权问题，需用户前往JDK官网下载</span></span><br><span class=\"line\">$ wget https://download.oracle.com/otn/java/jdk/8u171-b12/478a62b7d4e34b78b671c754eaaf38ab/jdk-8u171-linux-x64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">$ tar zxvf jdk-8u171-linux-x64.tar.gz -C /usr/<span class=\"built_in\">local</span>/</span><br><span class=\"line\"></span><br><span class=\"line\">$ cat &gt;&gt; /etc/profile &lt;&lt; EOF</span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_HOME=/usr/<span class=\"built_in\">local</span>/jdk1.8.0_171</span><br><span class=\"line\"><span class=\"built_in\">export</span> CLASSPATH=.:<span class=\"variable\">$JAVA_HOME</span>/lib/dt.jar:<span class=\"variable\">$JAVA_HOME</span>/lib/tools.jar</span><br><span class=\"line\"><span class=\"built_in\">export</span> PATH=<span class=\"variable\">$JAVA_HOME</span>/bin:<span class=\"variable\">$PATH</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">source</span> /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证JDK, JDK配置完成</span></span><br><span class=\"line\">$ java -version</span><br><span class=\"line\">java version <span class=\"string\">\"1.8.0_171\"</span></span><br><span class=\"line\">Java(TM) SE Runtime Environment (build 1.8.0_171-b11)</span><br><span class=\"line\">Java HotSpot(TM) 64-Bit Server VM (build 25.171-b11, mixed mode)</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"设置服务器的最大文件数\"><a href=\"#设置服务器的最大文件数\" class=\"headerlink\" title=\"设置服务器的最大文件数\"></a>设置服务器的最大文件数</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class=\"line\"> * soft nofile 655350</span><br><span class=\"line\"> * hard nofile 655350</span><br><span class=\"line\"> * soft nproc 655350</span><br><span class=\"line\"> * hard nproc 655350</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h3 id=\"设置服务器打开的最大进程数\"><a href=\"#设置服务器打开的最大进程数\" class=\"headerlink\" title=\"设置服务器打开的最大进程数\"></a>设置服务器打开的最大进程数</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat &gt; /etc/security/limits.d/20-nproc.conf &lt;&lt; EOF</span><br><span class=\"line\">*          soft    nproc     4096</span><br><span class=\"line\">root       soft    nproc     unlimited</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h3 id=\"设置nmap数量对虚拟内存的支持\"><a href=\"#设置nmap数量对虚拟内存的支持\" class=\"headerlink\" title=\"设置nmap数量对虚拟内存的支持\"></a>设置nmap数量对虚拟内存的支持</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF</span><br><span class=\"line\">vm.max_map_count=262144</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">$  sysctl -p</span><br></pre></td></tr></table></figure>\n<h3 id=\"本地host解析\"><a href=\"#本地host解析\" class=\"headerlink\" title=\"本地host解析\"></a>本地host解析</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class=\"line\">efk-node1 192.168.20.211</span><br><span class=\"line\">efk-node2 192.168.20.212</span><br><span class=\"line\">real-server 192.168.20.250</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h2 id=\"安装elasticsearch\"><a href=\"#安装elasticsearch\" class=\"headerlink\" title=\"安装elasticsearch\"></a>安装elasticsearch</h2><p>以下操作在<code>efk-node1</code>和<code>efk-node2</code>主机上进行：</p>\n<h3 id=\"下载和解压\"><a href=\"#下载和解压\" class=\"headerlink\" title=\"下载和解压\"></a>下载和解压</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建elastic工作目录</span></span><br><span class=\"line\">$ mkdir /elastic &amp;&amp; <span class=\"built_in\">cd</span> /elastic</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 下载elasticsearch tar包</span></span><br><span class=\"line\">$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.0.1-linux-x86_64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解压到当前/elastic目录</span></span><br><span class=\"line\">$ tar zxvf elasticsearch-7.0.1-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<h3 id=\"修改配置文件\"><a href=\"#修改配置文件\" class=\"headerlink\" title=\"修改配置文件\"></a>修改配置文件</h3><p>下面只列出已配置的参数<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat elasticsearch-7.0.1/config/elasticsearch.yml | egrep -v <span class=\"string\">\"^$|^#\"</span></span><br><span class=\"line\">  cluster.name: efk-cluster     <span class=\"comment\"># 集群名称</span></span><br><span class=\"line\">  node.name: efk-node1          <span class=\"comment\"># 节点名称，212服务器改成efk-node2</span></span><br><span class=\"line\">  path.data: /var/lib/elasticsearch     <span class=\"comment\"># elasticsearch数据目录</span></span><br><span class=\"line\">  path.logs: /var/<span class=\"built_in\">log</span>/elasticsearch     <span class=\"comment\"># elasticsearch日志目录</span></span><br><span class=\"line\">  network.host: 0.0.0.0                 <span class=\"comment\"># elasticsearch绑定的地址</span></span><br><span class=\"line\">  http.port: 9200                       <span class=\"comment\"># elasticsearch绑定的端口</span></span><br><span class=\"line\">  discovery.seed_hosts: [<span class=\"string\">\"efk-node1\"</span>, <span class=\"string\">\"efk-node2\"</span>]  <span class=\"comment\">#集群发现</span></span><br><span class=\"line\">  cluster.initial_master_nodes: [<span class=\"string\">\"efk-node1\"</span>, <span class=\"string\">\"efk-node2\"</span>]  <span class=\"comment\">#第一次访问初始的集群节点</span></span><br><span class=\"line\">  xpack.security.enabled: <span class=\"literal\">true</span>          <span class=\"comment\"># ssl\\tls安全参数</span></span><br><span class=\"line\">  xpack.security.transport.ssl.enabled: <span class=\"literal\">true</span>    <span class=\"comment\"># ssl\\tls安全参数</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"创建运行elasticsearch用户\"><a href=\"#创建运行elasticsearch用户\" class=\"headerlink\" title=\"创建运行elasticsearch用户\"></a>创建运行elasticsearch用户</h3><blockquote>\n<p>elasticsearch默认是不运行root用户运行的，因此我们得创建一个新用户来运行elasticsearch。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ useradd elastic</span><br><span class=\"line\">$ passwd elastic</span><br></pre></td></tr></table></figure>\n<h3 id=\"创建依赖文件\"><a href=\"#创建依赖文件\" class=\"headerlink\" title=\"创建依赖文件\"></a>创建依赖文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir /var/<span class=\"built_in\">log</span>/elasticsearch      <span class=\"comment\"># 创建日志目录</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ mkdir /var/lib/elasticsearch      <span class=\"comment\"># 创建数据目录</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ touch /var/run/elasticsearch.pid  <span class=\"comment\"># 创建进程文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ chown -R elastic.elastic /elastic <span class=\"comment\"># 修改elastic工作目录所有者</span></span><br><span class=\"line\">$ chown -R elastic.elastic /var/<span class=\"built_in\">log</span>/elasticsearch &amp;&amp; \\</span><br><span class=\"line\">chown -R elastic.elastic /var/lib/elasticsearch &amp;&amp; \\</span><br><span class=\"line\">chown -R elastic.elastic /var/run/elasticsearch.pid   <span class=\"comment\"># 相关目录所有者都修改成运行elasticsearch服务的用户</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"准备elasticsearch-systemctl文件\"><a href=\"#准备elasticsearch-systemctl文件\" class=\"headerlink\" title=\"准备elasticsearch systemctl文件\"></a>准备elasticsearch systemctl文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Elasticsearch</span><br><span class=\"line\">Documentation=http://www.elastic.co</span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Environment=JAVA_HOME=/usr/<span class=\"built_in\">local</span>/jdk1.8.0_171</span><br><span class=\"line\">User=elastic</span><br><span class=\"line\">Group=elastic</span><br><span class=\"line\">ExecStart=/elastic/elasticsearch-7.0.1/bin/elasticsearch -p /var/run/elasticsearch.pid</span><br><span class=\"line\"></span><br><span class=\"line\">LimitNOFILE=65535</span><br><span class=\"line\">LimitNPROC=65535</span><br><span class=\"line\">LimitAS=infinity</span><br><span class=\"line\">LimitFSIZE=infinity</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动elasticsearch\"><a href=\"#启动elasticsearch\" class=\"headerlink\" title=\"启动elasticsearch\"></a>启动elasticsearch</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ systemctl daemon-reload           <span class=\"comment\"># 加载systemctl配置文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl start elasticsearch     <span class=\"comment\"># 启动elasticsearch</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> elasticsearch    <span class=\"comment\"># 设置开机启动elasticsearch</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>Tips</strong>: elasticsearch7.0.1安装完默认自带基础版的X-Pack功能，使用铂金版的需要购买或者参考<a href=\"https://www.ipyker.com/2019/03/13/elastic-x-pack/\">破解X-pack</a>进行破解。</p>\n</blockquote>\n<h3 id=\"验证集群状态\"><a href=\"#验证集群状态\" class=\"headerlink\" title=\"验证集群状态\"></a>验证集群状态</h3><p>通过上面的配置，我们的elasticsearch服务器已经启动，并且默认监听在<code>9200</code>和<code>9300</code>端口。<br><code>9200端口</code>: 为web访问提供服务；<code>9300端口</code>：为集群节点提供通信。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 验证集群节点数，其中master为*的代表该节点为主节点</span></span><br><span class=\"line\">$ curl http://192.168.20.211:9200/_cat/nodes?v</span><br><span class=\"line\">ip             heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class=\"line\">192.168.20.212           10          39   0    0.00    0.01     0.05 mdi       -      efk-node2</span><br><span class=\"line\">192.168.20.211           18          37   0    0.00    0.01     0.05 mdi       *      efk-node1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证集群健康状态，status为green表示正常</span></span><br><span class=\"line\">$ curl http://192.168.20.211:9200/_cat/health?v</span><br><span class=\"line\">epoch      timestamp cluster        status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class=\"line\">1558517253 09:27:33  efk-cluster green           2         2      6   3    0    0        0             0                  -                100.0%</span><br></pre></td></tr></table></figure></p>\n<div class=\"note success\">\n            <p>由上可知，我们的elasticsearch集群已经正常工作了，并且在2台集群节点下/var/lib/elasticsearch目录下都有相同的数据。更多关于elasticsearch REST API请参考官方说明。<br><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cluster.html\" target=\"_blank\" rel=\"noopener\">cluster apis</a> <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cat.html\" target=\"_blank\" rel=\"noopener\">_cat apis</a> <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.0/search.html\" target=\"_blank\" rel=\"noopener\">Search apis</a> <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docs.html\" target=\"_blank\" rel=\"noopener\">Document apis</a> </p>\n          </div>\n<h2 id=\"安装-Kibana\"><a href=\"#安装-Kibana\" class=\"headerlink\" title=\"安装 Kibana\"></a>安装 Kibana</h2><p>以下操作只在<code>efk-node1</code>主机上进行：</p>\n<h3 id=\"下载和解压-1\"><a href=\"#下载和解压-1\" class=\"headerlink\" title=\"下载和解压\"></a>下载和解压</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入elastic工作目录</span></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> /elastic</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 下载kibana tar包</span></span><br><span class=\"line\">$ wget https://artifacts.elastic.co/downloads/kibana/kibana-7.0.1-linux-x86_64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解压到当前/elastic目录</span></span><br><span class=\"line\">$ tar zxvf kibana-7.0.1-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<h3 id=\"修改配置文件-1\"><a href=\"#修改配置文件-1\" class=\"headerlink\" title=\"修改配置文件\"></a>修改配置文件</h3><p>下面只列出已配置的参数<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat kibana-7.0.1-linux-x86_64/config/kibana.yml | egrep -v <span class=\"string\">\"^$|^#\"</span></span><br><span class=\"line\">  server.port: 5601           <span class=\"comment\"># kibana服务端口</span></span><br><span class=\"line\">  server.host: <span class=\"string\">\"0.0.0.0\"</span>      <span class=\"comment\"># kibana服务地址</span></span><br><span class=\"line\">  elasticsearch.hosts: [<span class=\"string\">\"http://192.168.20.201:9200\"</span>]  <span class=\"comment\"># es访问地址，kibana需要和它通信</span></span><br><span class=\"line\">  elasticsearch.username: <span class=\"string\">\"elastic\"</span>            <span class=\"comment\"># es帐号，如果是X-pack铂金版可配</span></span><br><span class=\"line\">  elasticsearch.password: <span class=\"string\">\"pyker123456\"</span>        <span class=\"comment\"># es密码，如果是X-pack铂金版可配</span></span><br><span class=\"line\">  elasticsearch.logQueries: <span class=\"literal\">true</span>               <span class=\"comment\"># 查询日志是否发送到ES，配合logging.json: true</span></span><br><span class=\"line\">  pid.file: /var/run/kibana.pid                <span class=\"comment\"># kibana的进行id文件</span></span><br><span class=\"line\">  logging.dest: /var/<span class=\"built_in\">log</span>/kibana.log            <span class=\"comment\"># kibana日志文件</span></span><br><span class=\"line\">  logging.json: <span class=\"literal\">true</span>                           <span class=\"comment\"># 以json格式输出日志</span></span><br><span class=\"line\">  logging.verbose: <span class=\"literal\">true</span>                        <span class=\"comment\"># 记录所有事件，包括系统使用信息和所以请求</span></span><br><span class=\"line\">  i18n.locale: <span class=\"string\">\"zh-CN\"</span>                         <span class=\"comment\"># 设置kibana为中文</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"创建依赖文件-1\"><a href=\"#创建依赖文件-1\" class=\"headerlink\" title=\"创建依赖文件\"></a>创建依赖文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ touch /var/<span class=\"built_in\">log</span>/kibana.log      <span class=\"comment\"># 创建日志文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ touch /var/run/kibana.pid      <span class=\"comment\"># 创建进程文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ chown -R elastic.elastic /elastic &amp;&amp; \\</span><br><span class=\"line\">chown -R elastic.elastic /var/<span class=\"built_in\">log</span>/kibana.log &amp;&amp; \\</span><br><span class=\"line\">chown -R elastic.elastic /var/run/kibana.pid     <span class=\"comment\"># 修改elastic工作目录及相关工作文件所有者</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>Tips：默认Kibana是支持root运行的，我这里为了统一elasticsearch运行环境所以打算elastic用户运行。</p>\n</blockquote>\n<h3 id=\"准备kibana-systemctl文件\"><a href=\"#准备kibana-systemctl文件\" class=\"headerlink\" title=\"准备kibana systemctl文件\"></a>准备kibana systemctl文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kibana</span><br><span class=\"line\">Documentation=http://www.elastic.co</span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">User=elastic</span><br><span class=\"line\">Group=elastic</span><br><span class=\"line\">ExecStart=/elastic/kibana-7.0.1-linux-x86_64/bin/kibana</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动kibana\"><a href=\"#启动kibana\" class=\"headerlink\" title=\"启动kibana\"></a>启动kibana</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ systemctl daemon-reload           <span class=\"comment\"># 加载systemctl配置文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl start kibana            <span class=\"comment\"># 启动kibana</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> kibana           <span class=\"comment\"># 设置开机启动kibana</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>Kibana默认监控在5601端口上，此时可以通过<code>http://192.168.20.211:5601</code>访问kibana。</p>\n</blockquote>\n<h2 id=\"安装cerebro可视化集群管理工具\"><a href=\"#安装cerebro可视化集群管理工具\" class=\"headerlink\" title=\"安装cerebro可视化集群管理工具\"></a>安装cerebro可视化集群管理工具</h2><p>cerebro是一个使用Scala，Play Framework，AngularJS和Bootstrap构建的开源（MIT许可）elasticsearch web可视化的监控工具，<a href=\"https://github.com/lmenezes/cerebro\" target=\"_blank\" rel=\"noopener\">Github项目</a><br>以下操作只在<code>efk-node2</code>主机上进行：</p>\n<h3 id=\"下载和解压-2\"><a href=\"#下载和解压-2\" class=\"headerlink\" title=\"下载和解压\"></a>下载和解压</h3><p>请前往<a href=\"https://github.com/lmenezes/cerebro/releases\" target=\"_blank\" rel=\"noopener\">https://github.com/lmenezes/cerebro/releases</a> 地址下载cerebro工具<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tar zxvf cerebro-0.8.3.tgz</span><br><span class=\"line\">$ vim cerebro-0.8.3/conf/application.conf  </span><br><span class=\"line\"># 设置cerebro密码登陆认证</span><br><span class=\"line\">auth=&#123;</span><br><span class=\"line\">    type: basic</span><br><span class=\"line\">    settings: &#123;</span><br><span class=\"line\">        username=\"admin\"</span><br><span class=\"line\">        password=\"pyker123456\"</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"># 文件最后配置elasticsearch地址</span><br><span class=\"line\">hosts = [</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    host = \"http://192.168.20.211:9200\"</span><br><span class=\"line\">    name = \"efk-cluster\"</span><br><span class=\"line\">  &#125;,</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"准备cerebro-systemctl文件\"><a href=\"#准备cerebro-systemctl文件\" class=\"headerlink\" title=\"准备cerebro systemctl文件\"></a>准备cerebro systemctl文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Cerebro</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Environment=JAVA_HOME=/usr/<span class=\"built_in\">local</span>/jdk1.8.0_171</span><br><span class=\"line\">User=elastic</span><br><span class=\"line\">Group=elastic</span><br><span class=\"line\">LimitNOFILE=65535</span><br><span class=\"line\">ExecStart=/elastic/cerebro-0.8.3/bin/cerebro -Dconfig.file=/elastic/cerebro-0.8.3/conf/application.conf -Dhttp.port=1234</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">WorkingDirectory=/elastic/cerebro-0.8.3</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h3 id=\"命令启动cerebro\"><a href=\"#命令启动cerebro\" class=\"headerlink\" title=\"命令启动cerebro\"></a>命令启动cerebro</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认9000端口</span></span><br><span class=\"line\">$ nohup ./bin/cerebro -Dhttp.port=1234 -Dhttp.address=192.168.20.212 &amp;</span><br></pre></td></tr></table></figure>\n<h3 id=\"systemctl方式启动cerebro\"><a href=\"#systemctl方式启动cerebro\" class=\"headerlink\" title=\"systemctl方式启动cerebro\"></a>systemctl方式启动cerebro</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ systemctl daemon-reload           <span class=\"comment\"># 加载systemctl配置文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl start cerebro           <span class=\"comment\"># 启动cerebro</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> cerebro          <span class=\"comment\"># 设置开机启动cerebro</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"访问cerebro\"><a href=\"#访问cerebro\" class=\"headerlink\" title=\"访问cerebro\"></a>访问cerebro</h3><p>通过浏览器访问<code>http://192.168.20.212:1234</code>就可以cerebro工具了。该工具详细的显示了es集群状态、节点数、索引数、分片数、文档数以及数据大小等参数。<br><img src=\"/images/pic/cerebro.png\" alt></p>\n<h2 id=\"安装filebeat\"><a href=\"#安装filebeat\" class=\"headerlink\" title=\"安装filebeat\"></a>安装filebeat</h2><p><a href=\"https://www.ipyker.com/2019/03/14/filebeat/\">此前文档</a>我们已经说明了关于filebeat的原理，以及一些配置文件参数。现在我们只初略的说明我们已使用的配置参数。以下操作只在<code>real-server</code>主机上进行：（也就是我们业务所跑的服务器，我们要抓取的是业务日志，所以当然是安装在业务服务器上咯）</p>\n<h3 id=\"下载和解压-3\"><a href=\"#下载和解压-3\" class=\"headerlink\" title=\"下载和解压\"></a>下载和解压</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入elastic工作目录</span></span><br><span class=\"line\">$ mkdir /elastic &amp;&amp;&amp; <span class=\"built_in\">cd</span> /elastic</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 下载kibana tar包</span></span><br><span class=\"line\">$ wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.0.1-linux-x86_64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解压到当前/elastic目录</span></span><br><span class=\"line\">$ tar zxvf filebeat-7.0.1-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>\n<blockquote>\n<span class=\"label info\">本例我们使用filebeat监控tomcat日志和nginx日志</span>\n</blockquote>\n<h3 id=\"修改配置文件-2\"><a href=\"#修改配置文件-2\" class=\"headerlink\" title=\"修改配置文件\"></a>修改配置文件</h3><h4 id=\"以配置文件方式支持tomcat日志输入\"><a href=\"#以配置文件方式支持tomcat日志输入\" class=\"headerlink\" title=\"以配置文件方式支持tomcat日志输入\"></a>以配置文件方式支持tomcat日志输入</h4><p>下面只列出已配置的参数，关于参数说明，请参考<a href=\"https://www.ipyker.com/2019/03/14/filebeat/\">此前文档</a><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">cat</span> <span class=\"string\">filebeat-7.0.1-linux-x86_64/filebeat.yml</span></span><br><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/usr/local/tomcat/logs/catalina.out</span>   <span class=\"comment\"># 监控tomcat控制台catalina.out日志文件</span></span><br><span class=\"line\"><span class=\"attr\">  fields:</span></span><br><span class=\"line\"><span class=\"attr\">    log_topic:</span> <span class=\"string\">tomcat_access_logs</span></span><br><span class=\"line\"><span class=\"attr\">  exclude_lines:</span> <span class=\"string\">['收到ping的消息']</span></span><br><span class=\"line\">  <span class=\"string\">multiline.pattern:</span> <span class=\"string\">'^[[:space:]]+|^Caused by:'</span></span><br><span class=\"line\">  <span class=\"string\">multiline.negate:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"string\">multiline.match:</span> <span class=\"string\">after</span></span><br><span class=\"line\"><span class=\"attr\">  ignore_older:</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">  close_inactive:</span> <span class=\"number\">2</span><span class=\"string\">m</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/usr/local/tomcat/logs/localhost_access.*</span>  <span class=\"comment\"># 监控tomcat访问localhost_access日志文件</span></span><br><span class=\"line\"><span class=\"attr\">  fields:</span></span><br><span class=\"line\"><span class=\"attr\">    log_topic:</span> <span class=\"string\">tomcat_catalina_logs</span></span><br><span class=\"line\"><span class=\"string\">filebeat.config.modules:</span></span><br><span class=\"line\"><span class=\"attr\">  path:</span> <span class=\"string\">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class=\"line\">  <span class=\"string\">reload.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">setup.template.settings:</span></span><br><span class=\"line\">  <span class=\"string\">index.number_of_shards:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"string\">setup.kibana:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"string\">\"192.168.20.211:5601\"</span></span><br><span class=\"line\"><span class=\"string\">output.elasticsearch:</span>     <span class=\"comment\"># 我们这里直接输出到ES，当然也可以输出到logstash、kafka等中间件</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"192.168.20.211:9200\"]</span></span><br><span class=\"line\">  <span class=\"comment\">#protocol: \"https\"</span></span><br><span class=\"line\"><span class=\"attr\">  username:</span> <span class=\"string\">\"elastic\"</span></span><br><span class=\"line\"><span class=\"attr\">  password:</span> <span class=\"string\">\"pyker123456\"</span></span><br><span class=\"line\"><span class=\"attr\">processors:</span></span><br><span class=\"line\"><span class=\"attr\">  - add_host_metadata:</span> <span class=\"string\">~</span></span><br><span class=\"line\"><span class=\"attr\">  - add_cloud_metadata:</span> <span class=\"string\">~</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<span class=\"label warning\">catalina.out和localhost_access都需要使用一定的格式。方便filebeat处理多行事件日志。</span>\n</blockquote>\n<h4 id=\"以模版方式支持nginx日志输入\"><a href=\"#以模版方式支持nginx日志输入\" class=\"headerlink\" title=\"以模版方式支持nginx日志输入\"></a>以模版方式支持nginx日志输入</h4><p>默认filebeat自带诸多服务日志模版，如：nginx、redis、apache、IIS、kafka等等。默认都在filebeat解压后<code>module</code>、<code>modules.d</code>目录中。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">cat</span> <span class=\"string\">/elastic/filebeat-7.0.1-linux-x86_64/modules.d/nginx.yml.disabled</span></span><br><span class=\"line\"><span class=\"attr\">- module:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  access:</span></span><br><span class=\"line\"><span class=\"attr\">    enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"string\">var.paths:</span> <span class=\"string\">[\"/data/wwwlogs/access.log*\"]</span>  <span class=\"comment\"># 配置nginx实际的访问日志路径，多个文件逗号分开</span></span><br><span class=\"line\"><span class=\"attr\">  error:</span></span><br><span class=\"line\"><span class=\"attr\">    enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"string\">var.paths:</span> <span class=\"string\">[\"/data/wwwlogs/error_nginx.log*\"]</span>  <span class=\"comment\"># 配置nginx实际的错误日志路径</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"启动nginx模版\"><a href=\"#启动nginx模版\" class=\"headerlink\" title=\"启动nginx模版\"></a>启动nginx模版</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> /elastic/filebeat-7.0.1-linux-x86_64</span><br><span class=\"line\">$ ./filebeat modules <span class=\"built_in\">enable</span> nginx </span><br><span class=\"line\"></span><br><span class=\"line\">$ ./filebeat modules list     <span class=\"comment\"># 列出已启动和未启动的模版</span></span><br><span class=\"line\">Enabled:</span><br><span class=\"line\">nginx</span><br><span class=\"line\">system</span><br><span class=\"line\"></span><br><span class=\"line\">Disabled</span><br><span class=\"line\">apache</span><br><span class=\"line\">auditd</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<h3 id=\"准备filebeat-systemctl文件\"><a href=\"#准备filebeat-systemctl文件\" class=\"headerlink\" title=\"准备filebeat systemctl文件\"></a>准备filebeat systemctl文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Filebeat sends <span class=\"built_in\">log</span> files to Logstash or directly to Elasticsearch.</span><br><span class=\"line\">Documentation=https://www.elastic.co/products/beats/filebeat</span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">ExecStart=/elastic/filebeat-7.0.1-linux-x86_64/filebeat -c /elastic/filebeat-7.0.1-linux-x86_64/filebeat.yml</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动filebeat\"><a href=\"#启动filebeat\" class=\"headerlink\" title=\"启动filebeat\"></a>启动filebeat</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ systemctl daemon-reload           <span class=\"comment\"># 加载systemctl配置文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl start filebeat            <span class=\"comment\"># 启动filebeat</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> filebeat           <span class=\"comment\"># 设置开机启动filebeat</span></span><br></pre></td></tr></table></figure>\n<p>至此简单的EFK集群搭建完成。在生成环境中 我们还会在filebeat和elasticsearch中间加入kafka和logstash来提高日志数据的高效传输和更强的日志过滤功能，而kafka又可以配置成集群模式。</p>\n<p><strong>在当前文档中我们并未说明kibana如何使用，请参考<a href=\"https://www.elastic.co/guide/cn/kibana/current/introduction.html\" target=\"_blank\" rel=\"noopener\">官方使用教程</a></strong></p>\n"},{"layout":"post","title":"Markdown格式书写","author":"Pyker","img":"/images/bar/markdown.jpg","top":false,"cover":false,"date":"2017-07-23T02:20:00.000Z","_content":"## 区块元素\n\n### 标题\n\nMarkdown 支持两种标题的语法，类似 Setext 和类 atx 形式。\n类 Setext 形式是用底线的形式，利用 = （最高阶标题）和 - （第二阶标题），例如：\n```\nThis is an H1\n=============\nThis is an H2\n-------------\n```\n也可以是类 Atx 形式则是在行首插入 1 到 6 个 # ，对应到标题 1 到 6 阶，例如：\n```\n# 这是 H1\n## 这是 H2\n###### 这是 H6\n```\n### 区块引用 Blockquotes\n\n区块引用是使用类似 email 中用 > 的引用方式。例如:\n```\n> This is a blockquote with two paragraphs. Lorem ipsum dolor sit amet,\n> consectetuer adipiscing elit. Aliquam hendrerit mi posuere lectus.\n> Vestibulum enim wisi, viverra nec, fringilla in, laoreet vitae, risus.\n>\n> Donec sit amet nisl. Aliquam semper ipsum sit amet velit. Suspendisse\n```\n区块引用可以嵌套（例如：引用内的引用），只要根据层次加上不同数量的 > ：\n```\n> This is the first level of quoting.\n>\n> > This is nested blockquote.\n>\n> Back to the first level.\n```\n引用的区块内也可以使用其他的 Markdown 语法，包括标题、列表、代码区块等：\n```\n> ### 这是一个标题。\n> \n> 1.   这是第一行列表项。\n> 2.   这是第二行列表项。\n> \n> 给出一些例子代码：\n> \n>     return shell_exec(\"echo $input | $markdown_script\");\n```\n### 列表\n\nMarkdown 支持有序列表和无序列表。\n* 无序列表使用星号、加号或是减号作为列表标记：\n\n```\n*   Red\n*   Green\n*   Blue\n\n等同于：\n+   Red\n+   Green\n+   Blue\n\n也等同于：\n-   Red\n-   Green\n-   Blue\n```\n\n* 有序列表则使用数字接着一个英文句点：\n\n```\n1.  Bird\n2.  McHale\n3.  Parish\n```\n>要让列表看起来更漂亮，你可以把内容用固定的缩进整理好：\n>\n>\t * Lorem ipsum dolor sit amet, consectetuer adipiscing elit.\n>\t   Aliquam hendrerit mi posuere lectus. Vestibulum enim wisi,\n>\t   viverra nec, fringilla in, laoreet vitae, risus.\n>\t * Donec sit amet nisl. Aliquam semper ipsum sit amet velit.\n>\t   Suspendisse id sem consectetuer libero luctus adipiscing.\n\n>列表项目可以`包含多个段落`， 每个项目下的段落都必须缩进 4 个空格或是 1 个制表符：\n>\n>\t 1.  This is a list item with two paragraphs. Lorem ipsum dolor\n>         sit amet, consectetuer adipiscing elit. Aliquam hendrerit\n>         mi posuere lectus.\n>\n>         Vestibulum enim wisi, viverra nec, fringilla in, laoreet\n>         vitae, risus. Donec sit amet nisl. Aliquam semper ipsum\n>         sit amet velit.\n>\n>\t 2. Suspendisse id sem consectetuer libero luctus adipiscing.\n\n>如果要在列表项目内放进引用，那 > 就需要缩进：\n>\n>\t * A list item with a blockquote:\n>\n>\t   > This is a blockquote\n>\t   > inside a list item.\n\n>如果要放代码区块的话，该`区块就需要缩进两次`，也就是 8 个空格或是 2 个制表符：\n>\n> \t*   一列表项包含一个列表区块：\n>\n>         <代码写在这>\n\n### 代码区块\n\n和程序相关的写作或是标签语言原始码通常会有已经排版好的代码区块，通常这些区块我们并不希望它以一般段落文件的方式去排版，而是照原来的样子显示，要在 Markdown 中建立代码区块很简单，只要代码块每行简单地缩进 4 个空格或是 1 个制表符就可以，例如，下面的输入：\n```\n这是一个普通段落：\n\n    这是一个代码区块。\n```\n>markdown也支持html的源码格式，只需要复制贴上，再加上缩进就可以了，剩下的 Markdown 都会帮你处理，例如：\n>\n>  \t <div class=\"footer\">\n> \t  \t &copy; 2004 Foo Corporation\n>  \t </div>\n\n代码区块中，一般的 Markdown 语法不会被转换，像是星号便只是星号，这表示你可以很容易地以 Markdown 语法撰写 Markdown 语法相关的文件。\n\n### 分割线\n\n你可以在一行中用三个以上的星号、减号、底线来建立一个分隔线，行内不能有其他东西。你也可以在星号或是减号中间插入空格。下面每种写法都可以建立分隔线：\n```\n* * *\n\n***\n\n*****\n\n- - -\n```\n### 表格\n在markdown中也支持表格格式，格式如下：\n```\n菜单1 | 菜单2 | 菜单3 | 菜单n\n----: | :---：| :---- | :----\n内容1 | 内容1 | 内容1 | 内容1\n内容2 | 内容2 | 内容2 | 内容2\n内容3 | 内容3 | 内容3 | 内容3\n```\nMarkdown 插入的表格，单元格中默认左对齐；表头单元格中的内容会一直居中对齐，可以使用：来设置对齐方式，`:---:` 居中对齐，`---:` 右对齐， `:---` 左对齐，`-` 的个数不限制。\n\n## 区段元素\n\n### 链接\nMarkdown 支持两种形式的链接语法： `行内式` 和`参考式` 两种形式。\n不管是哪一种，链接文字都是用 [方括号] 来标记。\n要建立一个`行内式` 的链接，只要在方块括号后面紧接着圆括号并插入网址链接即可，如果你还想要加上链接的 title 文字，只要在网址后面，用双引号把 title 文字包起来即可，例如：\n```\nThis is [an example](http://example.com/ \"Title\") inline link.\n[This link](http://example.net/) has no title attribute.\n```\n> 如果你是要链接到同样主机的资源，你可以使用相对路径：\n>\n>\t See my [About](/about/) page for details.\n\n`参考式` 的链接是在链接文字的括号后面再接上另一个方括号，而在第二个方括号里面要填入用以辨识链接的标记,接着，在文件的任意处，你可以把这个标记的链接内容定义出来：：\n```\nThis is [an example][id] reference-style link.\n[id]: http://example.com/  \"Optional Title Here\"\n```\n\n链接内容定义的形式为：\n\n* 方括号（前面可以选择性地加上至多三个空格来缩进），里面输入链接文字\n* 接着一个冒号\n* 接着一个以上的空格或制表符\n* 接着链接的网址\n* 选择性地接着 title 内容，可以用单引号、双引号或是括弧包着\n\n下面这三种链接的定义都是相同：\n```\n[foo]: http://example.com/  \"Optional Title Here\"\n[foo]: http://example.com/  'Optional Title Here'\n[foo]: http://example.com/  (Optional Title Here)\n```\n**请注意：** 有一个已知的问题是 Markdown.pl 1.0.1 会忽略单引号包起来的链接 title。\n\n### 强调\nMarkdown 使用星号`（*）和底线（_）作为标记强调字词` 的符号，被 * 或 _ 包围的字词会被转成用 <em> 标签包围，用`两个 * 或 _ ` 包起来的话，则会被转成 <strong>，被`三个星号（*）` 包起来则为倾斜和加粗文字，被两个`波浪线（~~）` 包为起来是要在文字上加删除线。例如：\n```\n*single asterisks*\n\n_single underscores_\n\n**double asterisks**\n\n__double underscores__\n\n***double underscores***\n\n~~double underscores~~\n```\n你可以随便用你喜欢的样式，唯一的限制是，你用什么符号开启标签，就要用什么符号结束。\n<font color=#FF0000 >但是如果你的 * 和 _ 两边都有空白的话，它们就只会被当成普通的符号。</font>\n>如果要在文字前后直接插入普通的星号或底线，你可以用反斜线：\n>\n>\t \\*this text is surrounded by literal asterisks\\*\n\n### 代码\n* 单行短句\n\n如果要标记一小段行内代码，你可以用反引号把它包起来\\`  \\`，例如：\n```\nUse the `printf()` function.\n```\n> 如果要在代码区段内插入反引号，你可以用多个反引号来开启和结束代码区段：\n>\n>\t ``There is a literal backtick (`) here.``\n\n* 多行代码块 \n\n\t  ```\n\t  代码块1\n\t  代码块2\n\t  代码块3\n\t  ```\n其中\\`\\`\\`也可以用~~~代替，且\\`\\`\\`后也支持语言关键字书写，使代码块格式化。例如\\`\\`\\`bash\\`\\`\\`\n\n*语言对应关键字请参照本文最末尾。*\n\t  \n### 图片\n很明显地，要在纯文字应用中设计一个「自然」的语法来插入图片是有一定难度的。Markdown 使用一种和链接很相似的语法来标记图片，同样也允许两种样式： `行内式` 和`参考式` 。\n行内式的图片语法看起来像是：\n```\n![Alt text](/path/to/img.jpg)\n![Alt text](/path/to/img.jpg \"Optional title\")\n```\n详细叙述如下：\n\n* 一个惊叹号 !\n* 接着一个方括号，里面放上图片下面的说明文字，相当于对图片内容的解释。\n* 接着一个普通括号，里面放上图片的网址，最后还可以用引号包住并加上 选择性的 'title' 文字。\n\n`参考式` 的图片语法则长得像这样：\n```\n![Alt text][id]\n[id]: url/to/image  \"Optional title attribute\"\n```\n「id」是图片参考的名称，图片参考的定义方式则和连结参考一样：\n\n### 字体和颜色\nMarkdown是一种可以使用普通文本编辑器编写的标记语言，通过类似HTML的标记语法，它可以使普通文本内容具有一定的格式。但是它`本身是不支持修改字体、字号与颜色` 等功能的！\n为了使其修改字体和颜色，我们可以用html语法代替，如：\n```html\n<font face=\"黑体\">我是黑体字</font>\n<font face=\"微软雅黑\">我是微软雅黑</font>\n<font face=\"STCAIYUN\">我是华文彩云</font>\n<font color=#FF0000 size=3 face=\"黑体\">这是一行红色3号大小的黑体文本</font>\n<font color=#00ffff size=72>这是16位颜色值表示</font>\n<font color=gray size=72>也可以用颜色的英文单词表示</font>\n```\n>Size：规定文本的尺寸大小。可能的值：从 1 到 7 的数字。浏览器默认值是 3。\n颜色16进制值可以参考：<https://www.114la.com/other/rgb.htm>\n\n### note和label颜色\n下面是note显示的颜色：\n<div class=\"note default\"><p>default</p></div>\n<div class=\"note primary\"><p>primary</p></div>\n<div class=\"note success\"><p>success</p></div>\n<div class=\"note info\"><p>info</p></div>\n<div class=\"note warning\"><p>warning</p></div>\n<div class=\"note danger\"><p>danger</p></div>\n<div class=\"note danger no-icon\"><p>danger no-icon</p></div>\n```html\n<div class=\"note default\"><p>default</p></div>\n<div class=\"note primary\"><p>primary</p></div>\n<div class=\"note success\"><p>success</p></div>\n<div class=\"note info\"><p>info</p></div>\n<div class=\"note warning\"><p>warning</p></div>\n<div class=\"note danger\"><p>danger</p></div>\n<div class=\"note danger no-icon\"><p>danger no-icon</p></div>\n```\n下面是label显示的颜色\n{% label primary@primary %}\n{% label default@default %}\n{% label success@success %}\n{% label info@info %}\n{% label warning@warning %}\n{% label danger@danger %}\n```html\n{% label primary@primary %}\n{% label default@default %}\n{% label success@success %}\n{% label info@info %}\n{% label warning@warning %}\n{% label danger@danger %}\n```\n## 其他\n\n### 自动链接\nMarkdown 支持以比较简短的自动链接形式来处理网址和电子邮件信箱，只要是用方括号包起来， Markdown 就会自动把它转成链接。一般网址的链接文字就和链接地址一样，例如：\n```\n<http://example.com/>\n```\nMarkdown 会转为：\n\n\t <a href=\"http://example.com/\">http://example.com/</a>\n### 反斜杠\nMarkdown 可以利用反斜杠来插入一些在语法中有其它意义的符号，例如：如果你想要用星号加在文字旁边的方式来做出强调效果（但不用 <em> 标签），你可以在星号的前面加上反斜杠：\n```\n\\*literal asterisks\\*\n```\nMarkdown 支持以下这些符号前面加上反斜杠来帮助插入普通的符号：\n```\n\\   反斜线\n`   反引号\n*   星号\n_   底线\n{}  花括号\n[]  方括号\n()  括弧\n#   井字号\n+   加号\n-   减号\n.   英文句点\n!   惊叹号\n```\n\n***\n语言关键字\n\n语言名 | 关键字\n:----: | :----:\nBash | bash\nCoffeeScript | coffeescript\nC++ | cpp\nC# | cs\nCSS | css\nDiff | diff\nHTTP | http\nIni | ini\nJava | java\nJavaScript | javascript\nJSON | json\nXML | xml\nMakefile | makefile\nMarkdown | markdown\nObjective-C | objectivec\nPerl | perl\nPython | python\nRuby | ruby\nSQL | sql","source":"_posts/markdown-format.md","raw":"layout: post\ntitle: Markdown格式书写\nauthor: Pyker\ncategories: markdown\nimg: /images/bar/markdown.jpg\ntags:\n  - markdown\ntop: false\ncover: false\ndate: 2017-07-23 10:20:00\n---\n## 区块元素\n\n### 标题\n\nMarkdown 支持两种标题的语法，类似 Setext 和类 atx 形式。\n类 Setext 形式是用底线的形式，利用 = （最高阶标题）和 - （第二阶标题），例如：\n```\nThis is an H1\n=============\nThis is an H2\n-------------\n```\n也可以是类 Atx 形式则是在行首插入 1 到 6 个 # ，对应到标题 1 到 6 阶，例如：\n```\n# 这是 H1\n## 这是 H2\n###### 这是 H6\n```\n### 区块引用 Blockquotes\n\n区块引用是使用类似 email 中用 > 的引用方式。例如:\n```\n> This is a blockquote with two paragraphs. Lorem ipsum dolor sit amet,\n> consectetuer adipiscing elit. Aliquam hendrerit mi posuere lectus.\n> Vestibulum enim wisi, viverra nec, fringilla in, laoreet vitae, risus.\n>\n> Donec sit amet nisl. Aliquam semper ipsum sit amet velit. Suspendisse\n```\n区块引用可以嵌套（例如：引用内的引用），只要根据层次加上不同数量的 > ：\n```\n> This is the first level of quoting.\n>\n> > This is nested blockquote.\n>\n> Back to the first level.\n```\n引用的区块内也可以使用其他的 Markdown 语法，包括标题、列表、代码区块等：\n```\n> ### 这是一个标题。\n> \n> 1.   这是第一行列表项。\n> 2.   这是第二行列表项。\n> \n> 给出一些例子代码：\n> \n>     return shell_exec(\"echo $input | $markdown_script\");\n```\n### 列表\n\nMarkdown 支持有序列表和无序列表。\n* 无序列表使用星号、加号或是减号作为列表标记：\n\n```\n*   Red\n*   Green\n*   Blue\n\n等同于：\n+   Red\n+   Green\n+   Blue\n\n也等同于：\n-   Red\n-   Green\n-   Blue\n```\n\n* 有序列表则使用数字接着一个英文句点：\n\n```\n1.  Bird\n2.  McHale\n3.  Parish\n```\n>要让列表看起来更漂亮，你可以把内容用固定的缩进整理好：\n>\n>\t * Lorem ipsum dolor sit amet, consectetuer adipiscing elit.\n>\t   Aliquam hendrerit mi posuere lectus. Vestibulum enim wisi,\n>\t   viverra nec, fringilla in, laoreet vitae, risus.\n>\t * Donec sit amet nisl. Aliquam semper ipsum sit amet velit.\n>\t   Suspendisse id sem consectetuer libero luctus adipiscing.\n\n>列表项目可以`包含多个段落`， 每个项目下的段落都必须缩进 4 个空格或是 1 个制表符：\n>\n>\t 1.  This is a list item with two paragraphs. Lorem ipsum dolor\n>         sit amet, consectetuer adipiscing elit. Aliquam hendrerit\n>         mi posuere lectus.\n>\n>         Vestibulum enim wisi, viverra nec, fringilla in, laoreet\n>         vitae, risus. Donec sit amet nisl. Aliquam semper ipsum\n>         sit amet velit.\n>\n>\t 2. Suspendisse id sem consectetuer libero luctus adipiscing.\n\n>如果要在列表项目内放进引用，那 > 就需要缩进：\n>\n>\t * A list item with a blockquote:\n>\n>\t   > This is a blockquote\n>\t   > inside a list item.\n\n>如果要放代码区块的话，该`区块就需要缩进两次`，也就是 8 个空格或是 2 个制表符：\n>\n> \t*   一列表项包含一个列表区块：\n>\n>         <代码写在这>\n\n### 代码区块\n\n和程序相关的写作或是标签语言原始码通常会有已经排版好的代码区块，通常这些区块我们并不希望它以一般段落文件的方式去排版，而是照原来的样子显示，要在 Markdown 中建立代码区块很简单，只要代码块每行简单地缩进 4 个空格或是 1 个制表符就可以，例如，下面的输入：\n```\n这是一个普通段落：\n\n    这是一个代码区块。\n```\n>markdown也支持html的源码格式，只需要复制贴上，再加上缩进就可以了，剩下的 Markdown 都会帮你处理，例如：\n>\n>  \t <div class=\"footer\">\n> \t  \t &copy; 2004 Foo Corporation\n>  \t </div>\n\n代码区块中，一般的 Markdown 语法不会被转换，像是星号便只是星号，这表示你可以很容易地以 Markdown 语法撰写 Markdown 语法相关的文件。\n\n### 分割线\n\n你可以在一行中用三个以上的星号、减号、底线来建立一个分隔线，行内不能有其他东西。你也可以在星号或是减号中间插入空格。下面每种写法都可以建立分隔线：\n```\n* * *\n\n***\n\n*****\n\n- - -\n```\n### 表格\n在markdown中也支持表格格式，格式如下：\n```\n菜单1 | 菜单2 | 菜单3 | 菜单n\n----: | :---：| :---- | :----\n内容1 | 内容1 | 内容1 | 内容1\n内容2 | 内容2 | 内容2 | 内容2\n内容3 | 内容3 | 内容3 | 内容3\n```\nMarkdown 插入的表格，单元格中默认左对齐；表头单元格中的内容会一直居中对齐，可以使用：来设置对齐方式，`:---:` 居中对齐，`---:` 右对齐， `:---` 左对齐，`-` 的个数不限制。\n\n## 区段元素\n\n### 链接\nMarkdown 支持两种形式的链接语法： `行内式` 和`参考式` 两种形式。\n不管是哪一种，链接文字都是用 [方括号] 来标记。\n要建立一个`行内式` 的链接，只要在方块括号后面紧接着圆括号并插入网址链接即可，如果你还想要加上链接的 title 文字，只要在网址后面，用双引号把 title 文字包起来即可，例如：\n```\nThis is [an example](http://example.com/ \"Title\") inline link.\n[This link](http://example.net/) has no title attribute.\n```\n> 如果你是要链接到同样主机的资源，你可以使用相对路径：\n>\n>\t See my [About](/about/) page for details.\n\n`参考式` 的链接是在链接文字的括号后面再接上另一个方括号，而在第二个方括号里面要填入用以辨识链接的标记,接着，在文件的任意处，你可以把这个标记的链接内容定义出来：：\n```\nThis is [an example][id] reference-style link.\n[id]: http://example.com/  \"Optional Title Here\"\n```\n\n链接内容定义的形式为：\n\n* 方括号（前面可以选择性地加上至多三个空格来缩进），里面输入链接文字\n* 接着一个冒号\n* 接着一个以上的空格或制表符\n* 接着链接的网址\n* 选择性地接着 title 内容，可以用单引号、双引号或是括弧包着\n\n下面这三种链接的定义都是相同：\n```\n[foo]: http://example.com/  \"Optional Title Here\"\n[foo]: http://example.com/  'Optional Title Here'\n[foo]: http://example.com/  (Optional Title Here)\n```\n**请注意：** 有一个已知的问题是 Markdown.pl 1.0.1 会忽略单引号包起来的链接 title。\n\n### 强调\nMarkdown 使用星号`（*）和底线（_）作为标记强调字词` 的符号，被 * 或 _ 包围的字词会被转成用 <em> 标签包围，用`两个 * 或 _ ` 包起来的话，则会被转成 <strong>，被`三个星号（*）` 包起来则为倾斜和加粗文字，被两个`波浪线（~~）` 包为起来是要在文字上加删除线。例如：\n```\n*single asterisks*\n\n_single underscores_\n\n**double asterisks**\n\n__double underscores__\n\n***double underscores***\n\n~~double underscores~~\n```\n你可以随便用你喜欢的样式，唯一的限制是，你用什么符号开启标签，就要用什么符号结束。\n<font color=#FF0000 >但是如果你的 * 和 _ 两边都有空白的话，它们就只会被当成普通的符号。</font>\n>如果要在文字前后直接插入普通的星号或底线，你可以用反斜线：\n>\n>\t \\*this text is surrounded by literal asterisks\\*\n\n### 代码\n* 单行短句\n\n如果要标记一小段行内代码，你可以用反引号把它包起来\\`  \\`，例如：\n```\nUse the `printf()` function.\n```\n> 如果要在代码区段内插入反引号，你可以用多个反引号来开启和结束代码区段：\n>\n>\t ``There is a literal backtick (`) here.``\n\n* 多行代码块 \n\n\t  ```\n\t  代码块1\n\t  代码块2\n\t  代码块3\n\t  ```\n其中\\`\\`\\`也可以用~~~代替，且\\`\\`\\`后也支持语言关键字书写，使代码块格式化。例如\\`\\`\\`bash\\`\\`\\`\n\n*语言对应关键字请参照本文最末尾。*\n\t  \n### 图片\n很明显地，要在纯文字应用中设计一个「自然」的语法来插入图片是有一定难度的。Markdown 使用一种和链接很相似的语法来标记图片，同样也允许两种样式： `行内式` 和`参考式` 。\n行内式的图片语法看起来像是：\n```\n![Alt text](/path/to/img.jpg)\n![Alt text](/path/to/img.jpg \"Optional title\")\n```\n详细叙述如下：\n\n* 一个惊叹号 !\n* 接着一个方括号，里面放上图片下面的说明文字，相当于对图片内容的解释。\n* 接着一个普通括号，里面放上图片的网址，最后还可以用引号包住并加上 选择性的 'title' 文字。\n\n`参考式` 的图片语法则长得像这样：\n```\n![Alt text][id]\n[id]: url/to/image  \"Optional title attribute\"\n```\n「id」是图片参考的名称，图片参考的定义方式则和连结参考一样：\n\n### 字体和颜色\nMarkdown是一种可以使用普通文本编辑器编写的标记语言，通过类似HTML的标记语法，它可以使普通文本内容具有一定的格式。但是它`本身是不支持修改字体、字号与颜色` 等功能的！\n为了使其修改字体和颜色，我们可以用html语法代替，如：\n```html\n<font face=\"黑体\">我是黑体字</font>\n<font face=\"微软雅黑\">我是微软雅黑</font>\n<font face=\"STCAIYUN\">我是华文彩云</font>\n<font color=#FF0000 size=3 face=\"黑体\">这是一行红色3号大小的黑体文本</font>\n<font color=#00ffff size=72>这是16位颜色值表示</font>\n<font color=gray size=72>也可以用颜色的英文单词表示</font>\n```\n>Size：规定文本的尺寸大小。可能的值：从 1 到 7 的数字。浏览器默认值是 3。\n颜色16进制值可以参考：<https://www.114la.com/other/rgb.htm>\n\n### note和label颜色\n下面是note显示的颜色：\n<div class=\"note default\"><p>default</p></div>\n<div class=\"note primary\"><p>primary</p></div>\n<div class=\"note success\"><p>success</p></div>\n<div class=\"note info\"><p>info</p></div>\n<div class=\"note warning\"><p>warning</p></div>\n<div class=\"note danger\"><p>danger</p></div>\n<div class=\"note danger no-icon\"><p>danger no-icon</p></div>\n```html\n<div class=\"note default\"><p>default</p></div>\n<div class=\"note primary\"><p>primary</p></div>\n<div class=\"note success\"><p>success</p></div>\n<div class=\"note info\"><p>info</p></div>\n<div class=\"note warning\"><p>warning</p></div>\n<div class=\"note danger\"><p>danger</p></div>\n<div class=\"note danger no-icon\"><p>danger no-icon</p></div>\n```\n下面是label显示的颜色\n{% label primary@primary %}\n{% label default@default %}\n{% label success@success %}\n{% label info@info %}\n{% label warning@warning %}\n{% label danger@danger %}\n```html\n{% label primary@primary %}\n{% label default@default %}\n{% label success@success %}\n{% label info@info %}\n{% label warning@warning %}\n{% label danger@danger %}\n```\n## 其他\n\n### 自动链接\nMarkdown 支持以比较简短的自动链接形式来处理网址和电子邮件信箱，只要是用方括号包起来， Markdown 就会自动把它转成链接。一般网址的链接文字就和链接地址一样，例如：\n```\n<http://example.com/>\n```\nMarkdown 会转为：\n\n\t <a href=\"http://example.com/\">http://example.com/</a>\n### 反斜杠\nMarkdown 可以利用反斜杠来插入一些在语法中有其它意义的符号，例如：如果你想要用星号加在文字旁边的方式来做出强调效果（但不用 <em> 标签），你可以在星号的前面加上反斜杠：\n```\n\\*literal asterisks\\*\n```\nMarkdown 支持以下这些符号前面加上反斜杠来帮助插入普通的符号：\n```\n\\   反斜线\n`   反引号\n*   星号\n_   底线\n{}  花括号\n[]  方括号\n()  括弧\n#   井字号\n+   加号\n-   减号\n.   英文句点\n!   惊叹号\n```\n\n***\n语言关键字\n\n语言名 | 关键字\n:----: | :----:\nBash | bash\nCoffeeScript | coffeescript\nC++ | cpp\nC# | cs\nCSS | css\nDiff | diff\nHTTP | http\nIni | ini\nJava | java\nJavaScript | javascript\nJSON | json\nXML | xml\nMakefile | makefile\nMarkdown | markdown\nObjective-C | objectivec\nPerl | perl\nPython | python\nRuby | ruby\nSQL | sql","slug":"markdown-format","published":1,"updated":"2019-05-27T08:09:12.894Z","comments":1,"photos":[],"link":"","_id":"cjw6jlf0q002jp4n7qrjpt5es","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"区块元素\"><a href=\"#区块元素\" class=\"headerlink\" title=\"区块元素\"></a>区块元素</h2><h3 id=\"标题\"><a href=\"#标题\" class=\"headerlink\" title=\"标题\"></a>标题</h3><p>Markdown 支持两种标题的语法，类似 Setext 和类 atx 形式。<br>类 Setext 形式是用底线的形式，利用 = （最高阶标题）和 - （第二阶标题），例如：<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">This is an H1</span><br><span class=\"line\">=============</span><br><span class=\"line\">This is an H2</span><br><span class=\"line\">-------------</span><br></pre></td></tr></table></figure></p>\n<p>也可以是类 Atx 形式则是在行首插入 1 到 6 个 # ，对应到标题 1 到 6 阶，例如：<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 这是 H1</span><br><span class=\"line\">## 这是 H2</span><br><span class=\"line\">###### 这是 H6</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"区块引用-Blockquotes\"><a href=\"#区块引用-Blockquotes\" class=\"headerlink\" title=\"区块引用 Blockquotes\"></a>区块引用 Blockquotes</h3><p>区块引用是使用类似 email 中用 &gt; 的引用方式。例如:<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> This is a blockquote with two paragraphs. Lorem ipsum dolor sit amet,</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> consectetuer adipiscing elit. Aliquam hendrerit mi posuere lectus.</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> Vestibulum enim wisi, viverra nec, fringilla <span class=\"keyword\">in</span>, laoreet vitae, risus.</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"></span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> Donec sit amet nisl. Aliquam semper ipsum sit amet velit. Suspendisse</span></span><br></pre></td></tr></table></figure></p>\n<p>区块引用可以嵌套（例如：引用内的引用），只要根据层次加上不同数量的 &gt; ：<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; This <span class=\"keyword\">is</span> <span class=\"keyword\">the</span> <span class=\"keyword\">first</span> level <span class=\"keyword\">of</span> quoting.</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; &gt; This <span class=\"keyword\">is</span> nested blockquote.</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; Back <span class=\"keyword\">to</span> <span class=\"keyword\">the</span> <span class=\"keyword\">first</span> level.</span><br></pre></td></tr></table></figure></p>\n<p>引用的区块内也可以使用其他的 Markdown 语法，包括标题、列表、代码区块等：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> <span class=\"comment\">### 这是一个标题。</span></span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> </span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> 1.   这是第一行列表项。</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> 2.   这是第二行列表项。</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> </span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> 给出一些例子代码：</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> </span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">     <span class=\"built_in\">return</span> shell_exec(<span class=\"string\">\"echo <span class=\"variable\">$input</span> | <span class=\"variable\">$markdown_script</span>\"</span>);</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"列表\"><a href=\"#列表\" class=\"headerlink\" title=\"列表\"></a>列表</h3><p>Markdown 支持有序列表和无序列表。</p>\n<ul>\n<li>无序列表使用星号、加号或是减号作为列表标记：</li>\n</ul>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">*   </span>Red</span><br><span class=\"line\"><span class=\"bullet\">*   </span>Green</span><br><span class=\"line\"><span class=\"bullet\">*   </span>Blue</span><br><span class=\"line\"></span><br><span class=\"line\">等同于：</span><br><span class=\"line\"><span class=\"bullet\">+   </span>Red</span><br><span class=\"line\"><span class=\"bullet\">+   </span>Green</span><br><span class=\"line\"><span class=\"bullet\">+   </span>Blue</span><br><span class=\"line\"></span><br><span class=\"line\">也等同于：</span><br><span class=\"line\"><span class=\"bullet\">-   </span>Red</span><br><span class=\"line\"><span class=\"bullet\">-   </span>Green</span><br><span class=\"line\"><span class=\"bullet\">-   </span>Blue</span><br></pre></td></tr></table></figure>\n<ul>\n<li>有序列表则使用数字接着一个英文句点：</li>\n</ul>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">1.  </span>Bird</span><br><span class=\"line\"><span class=\"bullet\">2.  </span>McHale</span><br><span class=\"line\"><span class=\"bullet\">3.  </span>Parish</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>要让列表看起来更漂亮，你可以把内容用固定的缩进整理好：</p>\n<pre><code>* Lorem ipsum dolor sit amet, consectetuer adipiscing elit.\n  Aliquam hendrerit mi posuere lectus. Vestibulum enim wisi,\n  viverra nec, fringilla in, laoreet vitae, risus.\n* Donec sit amet nisl. Aliquam semper ipsum sit amet velit.\n  Suspendisse id sem consectetuer libero luctus adipiscing.\n</code></pre></blockquote>\n<blockquote>\n<p>列表项目可以<code>包含多个段落</code>， 每个项目下的段落都必须缩进 4 个空格或是 1 个制表符：</p>\n<pre><code>1.  This is a list item with two paragraphs. Lorem ipsum dolor\n    sit amet, consectetuer adipiscing elit. Aliquam hendrerit\n    mi posuere lectus.\n\n    Vestibulum enim wisi, viverra nec, fringilla in, laoreet\n    vitae, risus. Donec sit amet nisl. Aliquam semper ipsum\n    sit amet velit.\n\n2. Suspendisse id sem consectetuer libero luctus adipiscing.\n</code></pre></blockquote>\n<blockquote>\n<p>如果要在列表项目内放进引用，那 &gt; 就需要缩进：</p>\n<pre><code>* A list item with a blockquote:\n\n  &gt; This is a blockquote\n  &gt; inside a list item.\n</code></pre></blockquote>\n<blockquote>\n<p>如果要放代码区块的话，该<code>区块就需要缩进两次</code>，也就是 8 个空格或是 2 个制表符：</p>\n<pre><code>*   一列表项包含一个列表区块：\n\n    &lt;代码写在这&gt;\n</code></pre></blockquote>\n<h3 id=\"代码区块\"><a href=\"#代码区块\" class=\"headerlink\" title=\"代码区块\"></a>代码区块</h3><p>和程序相关的写作或是标签语言原始码通常会有已经排版好的代码区块，通常这些区块我们并不希望它以一般段落文件的方式去排版，而是照原来的样子显示，要在 Markdown 中建立代码区块很简单，只要代码块每行简单地缩进 4 个空格或是 1 个制表符就可以，例如，下面的输入：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这是一个普通段落：</span><br><span class=\"line\"></span><br><span class=\"line\">    这是一个代码区块。</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>markdown也支持html的源码格式，只需要复制贴上，再加上缩进就可以了，剩下的 Markdown 都会帮你处理，例如：</p>\n<pre><code>&lt;div class=&quot;footer&quot;&gt;\n     &amp;copy; 2004 Foo Corporation\n&lt;/div&gt;\n</code></pre></blockquote>\n<p>代码区块中，一般的 Markdown 语法不会被转换，像是星号便只是星号，这表示你可以很容易地以 Markdown 语法撰写 Markdown 语法相关的文件。</p>\n<h3 id=\"分割线\"><a href=\"#分割线\" class=\"headerlink\" title=\"分割线\"></a>分割线</h3><p>你可以在一行中用三个以上的星号、减号、底线来建立一个分隔线，行内不能有其他东西。你也可以在星号或是减号中间插入空格。下面每种写法都可以建立分隔线：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">* </span><span class=\"bullet\">* *</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"emphasis\">***</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"strong\">*****</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">- </span>- -</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"表格\"><a href=\"#表格\" class=\"headerlink\" title=\"表格\"></a>表格</h3><p>在markdown中也支持表格格式，格式如下：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">菜单1 |<span class=\"string\"> 菜单2 </span>|<span class=\"string\"> 菜单3 </span>|<span class=\"string\"> 菜单n</span></span><br><span class=\"line\"><span class=\"string\">----: </span>|<span class=\"string\"> :---：</span>|<span class=\"string\"> :---- </span>|<span class=\"string\"> :----</span></span><br><span class=\"line\"><span class=\"string\">内容1 </span>|<span class=\"string\"> 内容1 </span>|<span class=\"string\"> 内容1 </span>|<span class=\"string\"> 内容1</span></span><br><span class=\"line\"><span class=\"string\">内容2 </span>|<span class=\"string\"> 内容2 </span>|<span class=\"string\"> 内容2 </span>|<span class=\"string\"> 内容2</span></span><br><span class=\"line\"><span class=\"string\">内容3 </span>|<span class=\"string\"> 内容3 </span>|<span class=\"string\"> 内容3 </span>|<span class=\"string\"> 内容3</span></span><br></pre></td></tr></table></figure></p>\n<p>Markdown 插入的表格，单元格中默认左对齐；表头单元格中的内容会一直居中对齐，可以使用：来设置对齐方式，<code>:---:</code> 居中对齐，<code>---:</code> 右对齐， <code>:---</code> 左对齐，<code>-</code> 的个数不限制。</p>\n<h2 id=\"区段元素\"><a href=\"#区段元素\" class=\"headerlink\" title=\"区段元素\"></a>区段元素</h2><h3 id=\"链接\"><a href=\"#链接\" class=\"headerlink\" title=\"链接\"></a>链接</h3><p>Markdown 支持两种形式的链接语法： <code>行内式</code> 和<code>参考式</code> 两种形式。<br>不管是哪一种，链接文字都是用 [方括号] 来标记。<br>要建立一个<code>行内式</code> 的链接，只要在方块括号后面紧接着圆括号并插入网址链接即可，如果你还想要加上链接的 title 文字，只要在网址后面，用双引号把 title 文字包起来即可，例如：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">This is [<span class=\"string\">an example</span>](<span class=\"link\">http://example.com/ \"Title\"</span>) inline link.</span><br><span class=\"line\">[<span class=\"string\">This link</span>](<span class=\"link\">http://example.net/</span>) has no title attribute.</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>如果你是要链接到同样主机的资源，你可以使用相对路径：</p>\n<pre><code>See my [About](/about/) page for details.\n</code></pre></blockquote>\n<p><code>参考式</code> 的链接是在链接文字的括号后面再接上另一个方括号，而在第二个方括号里面要填入用以辨识链接的标记,接着，在文件的任意处，你可以把这个标记的链接内容定义出来：：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">This is [<span class=\"string\">an example</span>][<span class=\"symbol\">id</span>] reference-style link.</span><br><span class=\"line\">[<span class=\"symbol\">id</span>]: <span class=\"link\">http://example.com/  \"Optional Title Here\"</span></span><br></pre></td></tr></table></figure></p>\n<p>链接内容定义的形式为：</p>\n<ul>\n<li>方括号（前面可以选择性地加上至多三个空格来缩进），里面输入链接文字</li>\n<li>接着一个冒号</li>\n<li>接着一个以上的空格或制表符</li>\n<li>接着链接的网址</li>\n<li>选择性地接着 title 内容，可以用单引号、双引号或是括弧包着</li>\n</ul>\n<p>下面这三种链接的定义都是相同：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">foo</span>]: <span class=\"link\">http://example.com/  \"Optional Title Here\"</span></span><br><span class=\"line\">[<span class=\"symbol\">foo</span>]: <span class=\"link\">http://example.com/  'Optional Title Here'</span></span><br><span class=\"line\">[<span class=\"symbol\">foo</span>]: <span class=\"link\">http://example.com/  (Optional Title Here)</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>请注意：</strong> 有一个已知的问题是 Markdown.pl 1.0.1 会忽略单引号包起来的链接 title。</p>\n<h3 id=\"强调\"><a href=\"#强调\" class=\"headerlink\" title=\"强调\"></a>强调</h3><p>Markdown 使用星号<code>（*）和底线（_）作为标记强调字词</code> 的符号，被 <em> 或 _ 包围的字词会被转成用 <em> 标签包围，用`两个 </em> 或 _ <code>包起来的话，则会被转成 &lt;strong&gt;，被</code>三个星号（*）<code>包起来则为倾斜和加粗文字，被两个</code>波浪线（~~）` 包为起来是要在文字上加删除线。例如：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"emphasis\">*single asterisks*</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"emphasis\">_single underscores_</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"strong\">**double asterisks**</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"strong\">__double underscores__</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"strong\">***double underscores**</span>*</span><br><span class=\"line\"></span><br><span class=\"line\">~~double underscores~~</span><br></pre></td></tr></table></figure></em></p>\n<p>你可以随便用你喜欢的样式，唯一的限制是，你用什么符号开启标签，就要用什么符号结束。</p>\n<p><font color=\"#FF0000\">但是如果你的 * 和 _ 两边都有空白的话，它们就只会被当成普通的符号。</font></p>\n<blockquote>\n<p>如果要在文字前后直接插入普通的星号或底线，你可以用反斜线：</p>\n<pre><code>\\*this text is surrounded by literal asterisks\\*\n</code></pre></blockquote>\n<h3 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h3><ul>\n<li>单行短句</li>\n</ul>\n<p>如果要标记一小段行内代码，你可以用反引号把它包起来`  `，例如：<br><figure class=\"highlight fortran\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">Use</span> the `printf()` <span class=\"function\"><span class=\"keyword\">function</span>.</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>如果要在代码区段内插入反引号，你可以用多个反引号来开启和结束代码区段：</p>\n<pre><code>``There is a literal backtick (`) here.``\n</code></pre></blockquote>\n<ul>\n<li><p>多行代码块 </p>\n<pre><code><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">代码块<span class=\"number\">1</span></span><br><span class=\"line\">代码块<span class=\"number\">2</span></span><br><span class=\"line\">代码块<span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n</code></pre></li>\n</ul>\n<p>其中```也可以用~~~代替，且```后也支持语言关键字书写，使代码块格式化。例如```bash```</p>\n<p><em>语言对应关键字请参照本文最末尾。</em></p>\n<h3 id=\"图片\"><a href=\"#图片\" class=\"headerlink\" title=\"图片\"></a>图片</h3><p>很明显地，要在纯文字应用中设计一个「自然」的语法来插入图片是有一定难度的。Markdown 使用一种和链接很相似的语法来标记图片，同样也允许两种样式： <code>行内式</code> 和<code>参考式</code> 。<br>行内式的图片语法看起来像是：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">![<span class=\"string\">Alt text</span>](<span class=\"link\">/path/to/img.jpg</span>)</span><br><span class=\"line\">![<span class=\"string\">Alt text</span>](<span class=\"link\">/path/to/img.jpg \"Optional title\"</span>)</span><br></pre></td></tr></table></figure></p>\n<p>详细叙述如下：</p>\n<ul>\n<li>一个惊叹号 !</li>\n<li>接着一个方括号，里面放上图片下面的说明文字，相当于对图片内容的解释。</li>\n<li>接着一个普通括号，里面放上图片的网址，最后还可以用引号包住并加上 选择性的 ‘title’ 文字。</li>\n</ul>\n<p><code>参考式</code> 的图片语法则长得像这样：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">![<span class=\"string\">Alt text</span>][<span class=\"symbol\">id</span>]</span><br><span class=\"line\">[<span class=\"symbol\">id</span>]: <span class=\"link\">url/to/image  \"Optional title attribute\"</span></span><br></pre></td></tr></table></figure></p>\n<p>「id」是图片参考的名称，图片参考的定义方式则和连结参考一样：</p>\n<h3 id=\"字体和颜色\"><a href=\"#字体和颜色\" class=\"headerlink\" title=\"字体和颜色\"></a>字体和颜色</h3><p>Markdown是一种可以使用普通文本编辑器编写的标记语言，通过类似HTML的标记语法，它可以使普通文本内容具有一定的格式。但是它<code>本身是不支持修改字体、字号与颜色</code> 等功能的！<br>为了使其修改字体和颜色，我们可以用html语法代替，如：<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">face</span>=<span class=\"string\">\"黑体\"</span>&gt;</span>我是黑体字<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">face</span>=<span class=\"string\">\"微软雅黑\"</span>&gt;</span>我是微软雅黑<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">face</span>=<span class=\"string\">\"STCAIYUN\"</span>&gt;</span>我是华文彩云<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">color</span>=<span class=\"string\">#FF0000</span> <span class=\"attr\">size</span>=<span class=\"string\">3</span> <span class=\"attr\">face</span>=<span class=\"string\">\"黑体\"</span>&gt;</span>这是一行红色3号大小的黑体文本<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">color</span>=<span class=\"string\">#00ffff</span> <span class=\"attr\">size</span>=<span class=\"string\">72</span>&gt;</span>这是16位颜色值表示<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">color</span>=<span class=\"string\">gray</span> <span class=\"attr\">size</span>=<span class=\"string\">72</span>&gt;</span>也可以用颜色的英文单词表示<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>Size：规定文本的尺寸大小。可能的值：从 1 到 7 的数字。浏览器默认值是 3。<br>颜色16进制值可以参考：<a href=\"https://www.114la.com/other/rgb.htm\" target=\"_blank\" rel=\"noopener\">https://www.114la.com/other/rgb.htm</a></p>\n</blockquote>\n<h3 id=\"note和label颜色\"><a href=\"#note和label颜色\" class=\"headerlink\" title=\"note和label颜色\"></a>note和label颜色</h3><p>下面是note显示的颜色：</p>\n<p><div class=\"note default\"><p>default</p></div></p>\n<p><div class=\"note primary\"><p>primary</p></div></p>\n<p><div class=\"note success\"><p>success</p></div></p>\n<p><div class=\"note info\"><p>info</p></div></p>\n<p><div class=\"note warning\"><p>warning</p></div></p>\n<p><div class=\"note danger\"><p>danger</p></div></p>\n<p><div class=\"note danger no-icon\"><p>danger no-icon</p></div><br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note default\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>default<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note primary\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>primary<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note success\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>success<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note info\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>info<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note warning\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>warning<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note danger\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>danger<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note danger no-icon\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>danger no-icon<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>下面是label显示的颜色<br><span class=\"label primary\">primary</span><br><span class=\"label default\">default</span><br><span class=\"label success\">success</span><br><span class=\"label info\">info</span><br><span class=\"label warning\">warning</span><br><span class=\"label danger\">danger</span><br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% label primary@primary %&#125;</span><br><span class=\"line\">&#123;% label default@default %&#125;</span><br><span class=\"line\">&#123;% label success@success %&#125;</span><br><span class=\"line\">&#123;% label info@info %&#125;</span><br><span class=\"line\">&#123;% label warning@warning %&#125;</span><br><span class=\"line\">&#123;% label danger@danger %&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><h3 id=\"自动链接\"><a href=\"#自动链接\" class=\"headerlink\" title=\"自动链接\"></a>自动链接</h3><p>Markdown 支持以比较简短的自动链接形式来处理网址和电子邮件信箱，只要是用方括号包起来， Markdown 就会自动把它转成链接。一般网址的链接文字就和链接地址一样，例如：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;<span class=\"string\">http:</span><span class=\"comment\">//example.com/&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>Markdown 会转为：</p>\n<pre><code>&lt;a href=&quot;http://example.com/&quot;&gt;http://example.com/&lt;/a&gt;\n</code></pre><h3 id=\"反斜杠\"><a href=\"#反斜杠\" class=\"headerlink\" title=\"反斜杠\"></a>反斜杠</h3><p>Markdown 可以利用反斜杠来插入一些在语法中有其它意义的符号，例如：如果你想要用星号加在文字旁边的方式来做出强调效果（但不用 <em> 标签），你可以在星号的前面加上反斜杠：<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">\\*literal</span> asterisks<span class=\"string\">\\*</span></span><br></pre></td></tr></table></figure></em></p>\n<p>Markdown 支持以下这些符号前面加上反斜杠来帮助插入普通的符号：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\   反斜线</span><br><span class=\"line\">`   反引号</span><br><span class=\"line\"><span class=\"bullet\">*   </span>星号</span><br><span class=\"line\">_   底线</span><br><span class=\"line\">&#123;&#125;  花括号</span><br><span class=\"line\">[]  方括号</span><br><span class=\"line\">()  括弧</span><br><span class=\"line\"><span class=\"section\">#   井字号</span></span><br><span class=\"line\"><span class=\"bullet\">+   </span>加号</span><br><span class=\"line\"><span class=\"bullet\">-   </span>减号</span><br><span class=\"line\">.   英文句点</span><br><span class=\"line\">!   惊叹号</span><br></pre></td></tr></table></figure></p>\n<hr>\n<p>语言关键字</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">语言名</th>\n<th style=\"text-align:center\">关键字</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">Bash</td>\n<td style=\"text-align:center\">bash</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CoffeeScript</td>\n<td style=\"text-align:center\">coffeescript</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">C++</td>\n<td style=\"text-align:center\">cpp</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">C#</td>\n<td style=\"text-align:center\">cs</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CSS</td>\n<td style=\"text-align:center\">css</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Diff</td>\n<td style=\"text-align:center\">diff</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">HTTP</td>\n<td style=\"text-align:center\">http</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Ini</td>\n<td style=\"text-align:center\">ini</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Java</td>\n<td style=\"text-align:center\">java</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">JavaScript</td>\n<td style=\"text-align:center\">javascript</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">JSON</td>\n<td style=\"text-align:center\">json</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">XML</td>\n<td style=\"text-align:center\">xml</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Makefile</td>\n<td style=\"text-align:center\">makefile</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Markdown</td>\n<td style=\"text-align:center\">markdown</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Objective-C</td>\n<td style=\"text-align:center\">objectivec</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Perl</td>\n<td style=\"text-align:center\">perl</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Python</td>\n<td style=\"text-align:center\">python</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Ruby</td>\n<td style=\"text-align:center\">ruby</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">SQL</td>\n<td style=\"text-align:center\">sql</td>\n</tr>\n</tbody>\n</table>\n","site":{"data":{}},"length":6772,"excerpt":"","more":"<h2 id=\"区块元素\"><a href=\"#区块元素\" class=\"headerlink\" title=\"区块元素\"></a>区块元素</h2><h3 id=\"标题\"><a href=\"#标题\" class=\"headerlink\" title=\"标题\"></a>标题</h3><p>Markdown 支持两种标题的语法，类似 Setext 和类 atx 形式。<br>类 Setext 形式是用底线的形式，利用 = （最高阶标题）和 - （第二阶标题），例如：<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">This is an H1</span><br><span class=\"line\">=============</span><br><span class=\"line\">This is an H2</span><br><span class=\"line\">-------------</span><br></pre></td></tr></table></figure></p>\n<p>也可以是类 Atx 形式则是在行首插入 1 到 6 个 # ，对应到标题 1 到 6 阶，例如：<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 这是 H1</span><br><span class=\"line\">## 这是 H2</span><br><span class=\"line\">###### 这是 H6</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"区块引用-Blockquotes\"><a href=\"#区块引用-Blockquotes\" class=\"headerlink\" title=\"区块引用 Blockquotes\"></a>区块引用 Blockquotes</h3><p>区块引用是使用类似 email 中用 &gt; 的引用方式。例如:<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> This is a blockquote with two paragraphs. Lorem ipsum dolor sit amet,</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> consectetuer adipiscing elit. Aliquam hendrerit mi posuere lectus.</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> Vestibulum enim wisi, viverra nec, fringilla <span class=\"keyword\">in</span>, laoreet vitae, risus.</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"></span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> Donec sit amet nisl. Aliquam semper ipsum sit amet velit. Suspendisse</span></span><br></pre></td></tr></table></figure></p>\n<p>区块引用可以嵌套（例如：引用内的引用），只要根据层次加上不同数量的 &gt; ：<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; This <span class=\"keyword\">is</span> <span class=\"keyword\">the</span> <span class=\"keyword\">first</span> level <span class=\"keyword\">of</span> quoting.</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; &gt; This <span class=\"keyword\">is</span> nested blockquote.</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; Back <span class=\"keyword\">to</span> <span class=\"keyword\">the</span> <span class=\"keyword\">first</span> level.</span><br></pre></td></tr></table></figure></p>\n<p>引用的区块内也可以使用其他的 Markdown 语法，包括标题、列表、代码区块等：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> <span class=\"comment\">### 这是一个标题。</span></span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> </span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> 1.   这是第一行列表项。</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> 2.   这是第二行列表项。</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> </span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> 给出一些例子代码：</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\"> </span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">     <span class=\"built_in\">return</span> shell_exec(<span class=\"string\">\"echo <span class=\"variable\">$input</span> | <span class=\"variable\">$markdown_script</span>\"</span>);</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"列表\"><a href=\"#列表\" class=\"headerlink\" title=\"列表\"></a>列表</h3><p>Markdown 支持有序列表和无序列表。</p>\n<ul>\n<li>无序列表使用星号、加号或是减号作为列表标记：</li>\n</ul>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">*   </span>Red</span><br><span class=\"line\"><span class=\"bullet\">*   </span>Green</span><br><span class=\"line\"><span class=\"bullet\">*   </span>Blue</span><br><span class=\"line\"></span><br><span class=\"line\">等同于：</span><br><span class=\"line\"><span class=\"bullet\">+   </span>Red</span><br><span class=\"line\"><span class=\"bullet\">+   </span>Green</span><br><span class=\"line\"><span class=\"bullet\">+   </span>Blue</span><br><span class=\"line\"></span><br><span class=\"line\">也等同于：</span><br><span class=\"line\"><span class=\"bullet\">-   </span>Red</span><br><span class=\"line\"><span class=\"bullet\">-   </span>Green</span><br><span class=\"line\"><span class=\"bullet\">-   </span>Blue</span><br></pre></td></tr></table></figure>\n<ul>\n<li>有序列表则使用数字接着一个英文句点：</li>\n</ul>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">1.  </span>Bird</span><br><span class=\"line\"><span class=\"bullet\">2.  </span>McHale</span><br><span class=\"line\"><span class=\"bullet\">3.  </span>Parish</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>要让列表看起来更漂亮，你可以把内容用固定的缩进整理好：</p>\n<pre><code>* Lorem ipsum dolor sit amet, consectetuer adipiscing elit.\n  Aliquam hendrerit mi posuere lectus. Vestibulum enim wisi,\n  viverra nec, fringilla in, laoreet vitae, risus.\n* Donec sit amet nisl. Aliquam semper ipsum sit amet velit.\n  Suspendisse id sem consectetuer libero luctus adipiscing.\n</code></pre></blockquote>\n<blockquote>\n<p>列表项目可以<code>包含多个段落</code>， 每个项目下的段落都必须缩进 4 个空格或是 1 个制表符：</p>\n<pre><code>1.  This is a list item with two paragraphs. Lorem ipsum dolor\n    sit amet, consectetuer adipiscing elit. Aliquam hendrerit\n    mi posuere lectus.\n\n    Vestibulum enim wisi, viverra nec, fringilla in, laoreet\n    vitae, risus. Donec sit amet nisl. Aliquam semper ipsum\n    sit amet velit.\n\n2. Suspendisse id sem consectetuer libero luctus adipiscing.\n</code></pre></blockquote>\n<blockquote>\n<p>如果要在列表项目内放进引用，那 &gt; 就需要缩进：</p>\n<pre><code>* A list item with a blockquote:\n\n  &gt; This is a blockquote\n  &gt; inside a list item.\n</code></pre></blockquote>\n<blockquote>\n<p>如果要放代码区块的话，该<code>区块就需要缩进两次</code>，也就是 8 个空格或是 2 个制表符：</p>\n<pre><code>*   一列表项包含一个列表区块：\n\n    &lt;代码写在这&gt;\n</code></pre></blockquote>\n<h3 id=\"代码区块\"><a href=\"#代码区块\" class=\"headerlink\" title=\"代码区块\"></a>代码区块</h3><p>和程序相关的写作或是标签语言原始码通常会有已经排版好的代码区块，通常这些区块我们并不希望它以一般段落文件的方式去排版，而是照原来的样子显示，要在 Markdown 中建立代码区块很简单，只要代码块每行简单地缩进 4 个空格或是 1 个制表符就可以，例如，下面的输入：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这是一个普通段落：</span><br><span class=\"line\"></span><br><span class=\"line\">    这是一个代码区块。</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>markdown也支持html的源码格式，只需要复制贴上，再加上缩进就可以了，剩下的 Markdown 都会帮你处理，例如：</p>\n<pre><code>&lt;div class=&quot;footer&quot;&gt;\n     &amp;copy; 2004 Foo Corporation\n&lt;/div&gt;\n</code></pre></blockquote>\n<p>代码区块中，一般的 Markdown 语法不会被转换，像是星号便只是星号，这表示你可以很容易地以 Markdown 语法撰写 Markdown 语法相关的文件。</p>\n<h3 id=\"分割线\"><a href=\"#分割线\" class=\"headerlink\" title=\"分割线\"></a>分割线</h3><p>你可以在一行中用三个以上的星号、减号、底线来建立一个分隔线，行内不能有其他东西。你也可以在星号或是减号中间插入空格。下面每种写法都可以建立分隔线：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">* </span><span class=\"bullet\">* *</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"emphasis\">***</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"strong\">*****</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">- </span>- -</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"表格\"><a href=\"#表格\" class=\"headerlink\" title=\"表格\"></a>表格</h3><p>在markdown中也支持表格格式，格式如下：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">菜单1 |<span class=\"string\"> 菜单2 </span>|<span class=\"string\"> 菜单3 </span>|<span class=\"string\"> 菜单n</span></span><br><span class=\"line\"><span class=\"string\">----: </span>|<span class=\"string\"> :---：</span>|<span class=\"string\"> :---- </span>|<span class=\"string\"> :----</span></span><br><span class=\"line\"><span class=\"string\">内容1 </span>|<span class=\"string\"> 内容1 </span>|<span class=\"string\"> 内容1 </span>|<span class=\"string\"> 内容1</span></span><br><span class=\"line\"><span class=\"string\">内容2 </span>|<span class=\"string\"> 内容2 </span>|<span class=\"string\"> 内容2 </span>|<span class=\"string\"> 内容2</span></span><br><span class=\"line\"><span class=\"string\">内容3 </span>|<span class=\"string\"> 内容3 </span>|<span class=\"string\"> 内容3 </span>|<span class=\"string\"> 内容3</span></span><br></pre></td></tr></table></figure></p>\n<p>Markdown 插入的表格，单元格中默认左对齐；表头单元格中的内容会一直居中对齐，可以使用：来设置对齐方式，<code>:---:</code> 居中对齐，<code>---:</code> 右对齐， <code>:---</code> 左对齐，<code>-</code> 的个数不限制。</p>\n<h2 id=\"区段元素\"><a href=\"#区段元素\" class=\"headerlink\" title=\"区段元素\"></a>区段元素</h2><h3 id=\"链接\"><a href=\"#链接\" class=\"headerlink\" title=\"链接\"></a>链接</h3><p>Markdown 支持两种形式的链接语法： <code>行内式</code> 和<code>参考式</code> 两种形式。<br>不管是哪一种，链接文字都是用 [方括号] 来标记。<br>要建立一个<code>行内式</code> 的链接，只要在方块括号后面紧接着圆括号并插入网址链接即可，如果你还想要加上链接的 title 文字，只要在网址后面，用双引号把 title 文字包起来即可，例如：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">This is [<span class=\"string\">an example</span>](<span class=\"link\">http://example.com/ \"Title\"</span>) inline link.</span><br><span class=\"line\">[<span class=\"string\">This link</span>](<span class=\"link\">http://example.net/</span>) has no title attribute.</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>如果你是要链接到同样主机的资源，你可以使用相对路径：</p>\n<pre><code>See my [About](/about/) page for details.\n</code></pre></blockquote>\n<p><code>参考式</code> 的链接是在链接文字的括号后面再接上另一个方括号，而在第二个方括号里面要填入用以辨识链接的标记,接着，在文件的任意处，你可以把这个标记的链接内容定义出来：：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">This is [<span class=\"string\">an example</span>][<span class=\"symbol\">id</span>] reference-style link.</span><br><span class=\"line\">[<span class=\"symbol\">id</span>]: <span class=\"link\">http://example.com/  \"Optional Title Here\"</span></span><br></pre></td></tr></table></figure></p>\n<p>链接内容定义的形式为：</p>\n<ul>\n<li>方括号（前面可以选择性地加上至多三个空格来缩进），里面输入链接文字</li>\n<li>接着一个冒号</li>\n<li>接着一个以上的空格或制表符</li>\n<li>接着链接的网址</li>\n<li>选择性地接着 title 内容，可以用单引号、双引号或是括弧包着</li>\n</ul>\n<p>下面这三种链接的定义都是相同：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">foo</span>]: <span class=\"link\">http://example.com/  \"Optional Title Here\"</span></span><br><span class=\"line\">[<span class=\"symbol\">foo</span>]: <span class=\"link\">http://example.com/  'Optional Title Here'</span></span><br><span class=\"line\">[<span class=\"symbol\">foo</span>]: <span class=\"link\">http://example.com/  (Optional Title Here)</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>请注意：</strong> 有一个已知的问题是 Markdown.pl 1.0.1 会忽略单引号包起来的链接 title。</p>\n<h3 id=\"强调\"><a href=\"#强调\" class=\"headerlink\" title=\"强调\"></a>强调</h3><p>Markdown 使用星号<code>（*）和底线（_）作为标记强调字词</code> 的符号，被 <em> 或 _ 包围的字词会被转成用 <em> 标签包围，用`两个 </em> 或 _ <code>包起来的话，则会被转成 &lt;strong&gt;，被</code>三个星号（*）<code>包起来则为倾斜和加粗文字，被两个</code>波浪线（~~）` 包为起来是要在文字上加删除线。例如：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"emphasis\">*single asterisks*</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"emphasis\">_single underscores_</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"strong\">**double asterisks**</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"strong\">__double underscores__</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"strong\">***double underscores**</span>*</span><br><span class=\"line\"></span><br><span class=\"line\">~~double underscores~~</span><br></pre></td></tr></table></figure></em></p>\n<p>你可以随便用你喜欢的样式，唯一的限制是，你用什么符号开启标签，就要用什么符号结束。</p>\n<p><font color=\"#FF0000\">但是如果你的 * 和 _ 两边都有空白的话，它们就只会被当成普通的符号。</font></p>\n<blockquote>\n<p>如果要在文字前后直接插入普通的星号或底线，你可以用反斜线：</p>\n<pre><code>\\*this text is surrounded by literal asterisks\\*\n</code></pre></blockquote>\n<h3 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h3><ul>\n<li>单行短句</li>\n</ul>\n<p>如果要标记一小段行内代码，你可以用反引号把它包起来`  `，例如：<br><figure class=\"highlight fortran\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">Use</span> the `printf()` <span class=\"function\"><span class=\"keyword\">function</span>.</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>如果要在代码区段内插入反引号，你可以用多个反引号来开启和结束代码区段：</p>\n<pre><code>``There is a literal backtick (`) here.``\n</code></pre></blockquote>\n<ul>\n<li><p>多行代码块 </p>\n<pre><code><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">代码块<span class=\"number\">1</span></span><br><span class=\"line\">代码块<span class=\"number\">2</span></span><br><span class=\"line\">代码块<span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n</code></pre></li>\n</ul>\n<p>其中```也可以用~~~代替，且```后也支持语言关键字书写，使代码块格式化。例如```bash```</p>\n<p><em>语言对应关键字请参照本文最末尾。</em></p>\n<h3 id=\"图片\"><a href=\"#图片\" class=\"headerlink\" title=\"图片\"></a>图片</h3><p>很明显地，要在纯文字应用中设计一个「自然」的语法来插入图片是有一定难度的。Markdown 使用一种和链接很相似的语法来标记图片，同样也允许两种样式： <code>行内式</code> 和<code>参考式</code> 。<br>行内式的图片语法看起来像是：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">![<span class=\"string\">Alt text</span>](<span class=\"link\">/path/to/img.jpg</span>)</span><br><span class=\"line\">![<span class=\"string\">Alt text</span>](<span class=\"link\">/path/to/img.jpg \"Optional title\"</span>)</span><br></pre></td></tr></table></figure></p>\n<p>详细叙述如下：</p>\n<ul>\n<li>一个惊叹号 !</li>\n<li>接着一个方括号，里面放上图片下面的说明文字，相当于对图片内容的解释。</li>\n<li>接着一个普通括号，里面放上图片的网址，最后还可以用引号包住并加上 选择性的 ‘title’ 文字。</li>\n</ul>\n<p><code>参考式</code> 的图片语法则长得像这样：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">![<span class=\"string\">Alt text</span>][<span class=\"symbol\">id</span>]</span><br><span class=\"line\">[<span class=\"symbol\">id</span>]: <span class=\"link\">url/to/image  \"Optional title attribute\"</span></span><br></pre></td></tr></table></figure></p>\n<p>「id」是图片参考的名称，图片参考的定义方式则和连结参考一样：</p>\n<h3 id=\"字体和颜色\"><a href=\"#字体和颜色\" class=\"headerlink\" title=\"字体和颜色\"></a>字体和颜色</h3><p>Markdown是一种可以使用普通文本编辑器编写的标记语言，通过类似HTML的标记语法，它可以使普通文本内容具有一定的格式。但是它<code>本身是不支持修改字体、字号与颜色</code> 等功能的！<br>为了使其修改字体和颜色，我们可以用html语法代替，如：<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">face</span>=<span class=\"string\">\"黑体\"</span>&gt;</span>我是黑体字<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">face</span>=<span class=\"string\">\"微软雅黑\"</span>&gt;</span>我是微软雅黑<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">face</span>=<span class=\"string\">\"STCAIYUN\"</span>&gt;</span>我是华文彩云<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">color</span>=<span class=\"string\">#FF0000</span> <span class=\"attr\">size</span>=<span class=\"string\">3</span> <span class=\"attr\">face</span>=<span class=\"string\">\"黑体\"</span>&gt;</span>这是一行红色3号大小的黑体文本<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">color</span>=<span class=\"string\">#00ffff</span> <span class=\"attr\">size</span>=<span class=\"string\">72</span>&gt;</span>这是16位颜色值表示<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">font</span> <span class=\"attr\">color</span>=<span class=\"string\">gray</span> <span class=\"attr\">size</span>=<span class=\"string\">72</span>&gt;</span>也可以用颜色的英文单词表示<span class=\"tag\">&lt;/<span class=\"name\">font</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>Size：规定文本的尺寸大小。可能的值：从 1 到 7 的数字。浏览器默认值是 3。<br>颜色16进制值可以参考：<a href=\"https://www.114la.com/other/rgb.htm\" target=\"_blank\" rel=\"noopener\">https://www.114la.com/other/rgb.htm</a></p>\n</blockquote>\n<h3 id=\"note和label颜色\"><a href=\"#note和label颜色\" class=\"headerlink\" title=\"note和label颜色\"></a>note和label颜色</h3><p>下面是note显示的颜色：</p>\n<p><div class=\"note default\"><p>default</p></div></p>\n<p><div class=\"note primary\"><p>primary</p></div></p>\n<p><div class=\"note success\"><p>success</p></div></p>\n<p><div class=\"note info\"><p>info</p></div></p>\n<p><div class=\"note warning\"><p>warning</p></div></p>\n<p><div class=\"note danger\"><p>danger</p></div></p>\n<p><div class=\"note danger no-icon\"><p>danger no-icon</p></div><br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note default\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>default<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note primary\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>primary<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note success\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>success<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note info\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>info<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note warning\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>warning<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note danger\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>danger<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"note danger no-icon\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>danger no-icon<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>下面是label显示的颜色<br><span class=\"label primary\">primary</span><br><span class=\"label default\">default</span><br><span class=\"label success\">success</span><br><span class=\"label info\">info</span><br><span class=\"label warning\">warning</span><br><span class=\"label danger\">danger</span><br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% label primary@primary %&#125;</span><br><span class=\"line\">&#123;% label default@default %&#125;</span><br><span class=\"line\">&#123;% label success@success %&#125;</span><br><span class=\"line\">&#123;% label info@info %&#125;</span><br><span class=\"line\">&#123;% label warning@warning %&#125;</span><br><span class=\"line\">&#123;% label danger@danger %&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><h3 id=\"自动链接\"><a href=\"#自动链接\" class=\"headerlink\" title=\"自动链接\"></a>自动链接</h3><p>Markdown 支持以比较简短的自动链接形式来处理网址和电子邮件信箱，只要是用方括号包起来， Markdown 就会自动把它转成链接。一般网址的链接文字就和链接地址一样，例如：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;<span class=\"string\">http:</span><span class=\"comment\">//example.com/&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>Markdown 会转为：</p>\n<pre><code>&lt;a href=&quot;http://example.com/&quot;&gt;http://example.com/&lt;/a&gt;\n</code></pre><h3 id=\"反斜杠\"><a href=\"#反斜杠\" class=\"headerlink\" title=\"反斜杠\"></a>反斜杠</h3><p>Markdown 可以利用反斜杠来插入一些在语法中有其它意义的符号，例如：如果你想要用星号加在文字旁边的方式来做出强调效果（但不用 <em> 标签），你可以在星号的前面加上反斜杠：<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">\\*literal</span> asterisks<span class=\"string\">\\*</span></span><br></pre></td></tr></table></figure></em></p>\n<p>Markdown 支持以下这些符号前面加上反斜杠来帮助插入普通的符号：<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\   反斜线</span><br><span class=\"line\">`   反引号</span><br><span class=\"line\"><span class=\"bullet\">*   </span>星号</span><br><span class=\"line\">_   底线</span><br><span class=\"line\">&#123;&#125;  花括号</span><br><span class=\"line\">[]  方括号</span><br><span class=\"line\">()  括弧</span><br><span class=\"line\"><span class=\"section\">#   井字号</span></span><br><span class=\"line\"><span class=\"bullet\">+   </span>加号</span><br><span class=\"line\"><span class=\"bullet\">-   </span>减号</span><br><span class=\"line\">.   英文句点</span><br><span class=\"line\">!   惊叹号</span><br></pre></td></tr></table></figure></p>\n<hr>\n<p>语言关键字</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">语言名</th>\n<th style=\"text-align:center\">关键字</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">Bash</td>\n<td style=\"text-align:center\">bash</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CoffeeScript</td>\n<td style=\"text-align:center\">coffeescript</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">C++</td>\n<td style=\"text-align:center\">cpp</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">C#</td>\n<td style=\"text-align:center\">cs</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CSS</td>\n<td style=\"text-align:center\">css</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Diff</td>\n<td style=\"text-align:center\">diff</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">HTTP</td>\n<td style=\"text-align:center\">http</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Ini</td>\n<td style=\"text-align:center\">ini</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Java</td>\n<td style=\"text-align:center\">java</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">JavaScript</td>\n<td style=\"text-align:center\">javascript</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">JSON</td>\n<td style=\"text-align:center\">json</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">XML</td>\n<td style=\"text-align:center\">xml</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Makefile</td>\n<td style=\"text-align:center\">makefile</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Markdown</td>\n<td style=\"text-align:center\">markdown</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Objective-C</td>\n<td style=\"text-align:center\">objectivec</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Perl</td>\n<td style=\"text-align:center\">perl</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Python</td>\n<td style=\"text-align:center\">python</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Ruby</td>\n<td style=\"text-align:center\">ruby</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">SQL</td>\n<td style=\"text-align:center\">sql</td>\n</tr>\n</tbody>\n</table>\n"},{"layout":"post","title":"下一代监控Prometheus初识","author":"Pyker","img":"/images/bar/prometheus.jpg","top":false,"cover":false,"date":"2019-01-12T02:10:00.000Z","_content":"## Prometheus介绍\nPrometheus 是一套开源的系统监控报警框架。它启发于 Google 的 borgmon 监控系统，由工作在 SoundCloud 的 google 前员工在 2012 年创建，作为社区开源项目进行开发，并于 2015 年正式发布。2016 年，Prometheus 正式加入 Cloud Native Computing Foundation，成为受欢迎度仅次于 Kubernetes 的项目。\n### 什么是TSDB\nTSDB(Time Series Database)时序列数据库，我们可以简单的理解为一个优化后用来处理时间序列数据的软件，并且数据中的数组是由时间进行索引的。\n\n**Prometheus作为TSDB具有以下特点：**\n* 具有由指标名称和键/值对标识的时间序列数据的多维度数据模型。\n* PromQL灵活的查询语言。\n* 不依赖分布式存储，单个服务器节点是自主的。\n* 通过基于HTTP的pull方式采集时序数据。\n* 可以通过中间网关（Pushgateway）进行时序列数据推送。\n* 通过服务发现或者静态配置来发现目标服务对象。\n* 支持多种多样的图表和界面展示，比如Grafana等。\n\n## Prometheus组成和架构\nPrometheus 生态圈中包含了多个组件，其中许多组件是可选的：\n* `Prometheus Server`：它是Prometheus组件中的核心部分，负责实现对监控数据的获取，存储及查询。Prometheus Server可以通过静态配置管理监控目标，也可以配合使用Service Discovery的方式动态管理监控目标，并从这些监控目标中获取数据。其次Prometheus Sever需要对采集到的数据进行存储，Prometheus Server本身就是一个实时数据库，将采集到的监控数据按照时间序列的方式存储在本地磁盘当中。Prometheus Server对外提供了自定义的PromQL，实现对数据的查询以及分析。另外Prometheus Server的联邦集群能力可以使其从其他的Prometheus Server实例中获取数据。\n\n* `Exporters`：Exporter将监控数据采集的端点通过HTTP服务的形式暴露给Prometheus Server，将其转化为Prometheus支持的格式，Prometheus Server通过访问该Exporter提供的Endpoint端点，即可以获取到需要采集的监控数据。可以将Exporter分为2类：\n>`直接采集`：这一类Exporter直接内置了对Prometheus监控的支持，比如cAdvisor，Kubernetes，Etcd，Gokit等，都直接内置了用于向Prometheus暴露监控数据的端点。\n>\n>`间接采集`：原有监控目标并不直接支持Prometheus，因此需要通过Prometheus提供的Client Library编写该监控目标的监控采集程序。如：Mysql Exporter，JMX Exporter，Consul Exporter等。\n* `AlertManager`：在Prometheus Server中支持基于Prom QL创建告警规则，如果满足Prom QL定义的规则，则会产生一条告警。当AlertManager从 Prometheus server 端接收到 alerts后，会进行去除重复数据，分组，并路由到对收的接受方式，发出报警。常见的接收方式有：电子邮件，pagerduty，webhook 等。\n* `PushGateway`: 主要用于短期的jobs。由于这类 jobs 存在时间较短，可能在 Prometheus 来 pull 之前就消失了。为此，这次 jobs 可以直接向 Prometheus中间网关推送它们的 metrics。这种方式主要用于服务层面的 metrics，对于机器层面的 metrices，需要使用 node exporter。（PushGatway类似zabbix proxy）\n\n### Prometheus 架构图\n![](https://prometheus.io/assets/architecture.png)\n从上图可以看出，Prometheus 的主要模块包括：`Prometheus server`, `exporters`, `Pushgateway`, `PromQL`, `Alertmanager` 以及`图形界面`。Prometheus的基本原理是通过HTTP协议周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，比如VM、Docker、Kubernetes等。输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux系统信息(包括磁盘、内存、CPU、网络等等)。\n\n### Prometheus工作流程\n1. Prometheus server 定期从配置好的 jobs 或者 exporters 中拉取 metrics，或者从Pushgateway 拉取metrics，或者从其他的 Prometheus server 中拉 metrics。\n2. Prometheus server 在本地存储收集到的 metrics，并运行已定义好的 alert.rules，通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。记录新的时间序列或者向 Alertmanager 推送警报。\n3. Prometheus通过PromQL和其他API可视化地展示收集的数据。Prometheus支持很多方式的图表可视化，例如Grafana、自带的Promdash以及自身提供的模版引擎等等。Prometheus还提供HTTP API的查询方式，自定义所需要的输出。\n\n## Prometheus相关概念\n### 数据模型\nPrometheus 中存储的数据为时间序列，是由 metric 的名字和一系列的标签（键值对）唯一标识的，不同的标签则代表不同的时间序列。\n给定度量标准名称和一组标签，通常使用此表示法标识时间序列：\n```\n<metric name>{<label name>=<label value>, ...}\n```\n例如：度量名称的时间序列api_http_requests_total和标签method=\"POST\"，并handler=\"/messages\"可以这样写：\n```\napi_http_requests_total{method=\"POST\", handler=\"/messages\"}\n```\n### 四种Metric类型\n* **Counter**\n\t一种累加的 metric，计数器可以用于记录只会增加不会减少的指标类型,比如记录：应用请求的总数，cpu使用时间，结束的任务数， 出现的错误数等。 对于Counter类型的指标，只包含一个inc()方法，用于计数器+1。\n* **Gauge**\n\t一种常规的 metric，可以任意加减。 常用于反应应用的当前状态。典型的应用如：温度，运行的 goroutines 的个数。对于Gauge指标的对象则包含两个主要的方法inc()以及dec(),用户添加或者减少计数。\n* **Histogram**\n\t自带buckets区间用于统计分布直方图，主要用于在指定分布范围内(Buckets)记录大小或者事件发生的次数。典型的应用如：请求持续时间，响应大小。\n* **Summary**\n\t Summary和Histogram非常类型相似，都可以统计事件发生的次数或者大小，以及其分布情况。Summary和Histogram都提供了对于事件的计数`_count`以及值的汇总`_sum`。 因此使用_count,和_sum时间序列可以计算出相同的内容，例如http每秒的平均响应时间：rate(basename_sum[5m]) / rate(basename_count[5m])。\n\t 同时Summary和Histogram都可以计算和统计样本的分布情况，比如中位数，9分位数等等。其中 0.0<= 分位数Quantiles <= 1.0。\n\t 不同在于Histogram可以通过`histogram_quantile函数`在服务器端计算分位数。 而Sumamry的分位数则是直接在客户端进行定义。因此对于分位数的计算。 Summary在通过PromQL进行查询时有更好的性能表现，而Histogram则会消耗更多的资源。\n\n### Jobs 和 Instances\n在Prometheus术语中，您可以scrape的目标称为instance，通常对应于单个进程。具有相同目的的instance集合，例如，为可伸缩性或可靠性而复制的流程称为Job。例如：\n```\njob: api-server\n    instance 1: 1.2.3.4:5670\n    instance 2: 1.2.3.4:5671\n    instance 3: 5.6.7.8:5670\n    instance 4: 5.6.7.8:5671\n```\n当Prometheus进行scrape目标时，它会自动将job标签和instance标签附加到scrape到的时间序列中，用于识别被抓取的目标，如果这些标签中的任何一个已存在于已删除数据中，则行为取决于`honor_labels`配置选项。\n### 表达式语言类型\nPrometheus表达式或子表达式可以评估为一下四种类型之一：\n* 即时向量（Instant vector） - 包含每个时间序列单个样品的一组时间序列，共享相同的时间戳\n* 范围向量（Range vector） - 包含一个范围内数据点的一组时间序列\n* 标量（Scalar） - 一个简单的数字浮点值\n* 字符串（String） - 一个简单的字符串值；当前未使用\n\n### 时间序列选择器\n#### 即时向量选择\n即时向量选择器允许选择一组时间序列，或者某个给定的时间戳的样本数据。下面这个例子选择了具有http_requests_total的时间序列：\n```\nhttp_requests_total\n```\n你可以通过附加一组标签，并用{}括起来，来进一步筛选这些时间序列。下面这个例子只选择有http_requests_total名称的、有prometheus工作标签的、有canary组标签的时间序列：\n```\nhttp_requests_total{job=\"prometheus\",group=\"canary\"}\n```\n另外，也可以也可以将标签值反向匹配，或者对正则表达式匹配标签值。下面列举匹配操作符：\n* `=`：选择正好相等的字符串标签\n* `!=`：选择不相等的字符串标签\n* `=~`：选择匹配正则表达式的标签（或子标签）\n* `!~`：选择不匹配正则表达式的标签（或子标签）\n\n例如，选择staging、testing、development环境下的，GET之外的HTTP方法的http_requests_total的时间序列：\n\n```\nhttp_requests_total{environment=~\"staging|testing|development\",method!=\"GET\"}\n```\n#### 范围向量选择\n范围向量表达式正如即时向量表达式一样运行，但是前者返回从当前时刻开始的一定时间范围的时间序列集合回来。语法是，在一个向量表达式之后添加[]来表示时间范围，持续时间用数字表示，后接下面单元之一：\n* `s`：seconds\n* `m`：minutes\n* `h`：hours\n* `d`：days\n* `w`：weeks\n* `y`：years\n\n在下面这个例子中，我们选择最后5分钟的记录，metric名称为http_requests_total、作业标签为prometheus的时间序列的所有值：\n```\nhttp_requests_total{job=\"prometheus\"}[5m]\n```\n#### 偏移量Offset\n所述offset可以改变时间为查询中的个别时刻和范围矢量偏移。例如，以下表达式返回http_requests_total相对于当前查询评估时间的过去5分钟值 ：\n```\nhttp_requests_total offset 5m\n```\n同样适用于范围向量。这将返回http_requests_total一周前的5分钟费率 ：\n```\nrate(http_requests_total[5m] offset 1w)\n```\n### 操作符\n关于操作符的说明，请参考官网[操作符说明](https://prometheus.io/docs/prometheus/latest/querying/operators/)\n###  函数\n关于函数的说明，请参考官网[函数解释](https://prometheus.io/docs/prometheus/latest/querying/functions/)\n## Prometheus的安装\n### 下载prometheus二进制包\n```bash\n$ wget https://github.com/prometheus/prometheus/releases/download/v2.9.1/prometheus-2.9.1.linux-amd64.tar.gz\n```\n### 解压prometheus压缩包\n```bash\n$ tar zxvf prometheus-2.9.1.linux-amd64.tar.gz\n```\n### 将prometheus放到/usr/local目录下\n```bash\n$ mv prometheus-2.9.1.linux-amd64 /usr/local/prometheus\n```\n### 验证版本\n```bash\n$ /usr/local/prometheus/prometheus --version \n  prometheus, version 2.9.1 (branch: HEAD, revision: ad71f2785fc321092948e33706b04f3150eee44f)\n  build user:       root@09f919068df4\n  build date:       20190416-17:50:04\n  go version:       go1.12.4\n```\n### 配置prometheus用户\n```bash\n$ groupadd prometheus\n$ useradd -g prometheus -s /sbin/nologin prometheus\n```\n### 创建prometheus数据目录\n```bash\n$ mkdir -p /var/lib/prometheus\n```\n### 创建prometheus的systemctl文件\n```bash\n$ cat > /usr/lib/systemd/system/prometheus.service << EOF\n[Unit]\nDescription=Prometheus\nDocumentation=https://prometheus.io/\nAfter=network.target\n\n[Service]\nType=simple\nUser=prometheus\nExecStart=/usr/local/prometheus/prometheus --config.file=/usr/local/prometheus/prometheus.yml --storage.tsdb.path=/var/lib/prometheus\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n### prometheus权限配置\n```bash\n# prometheus主程序\n$ chown -R prometheus:prometheus /usr/local/prometheus/\n\n# prometheus数据目录\n$ chown -R prometheus:prometheus /var/lib/prometheus/\n\n# prometheus启动文件\n$ chown prometheus:prometheus /usr/lib/systemd/system/prometheus.service\n```\n\n### 启动服务并设为开机启动\n```bash\n$ systemctl start prometheus\n$ systemctl enable prometheus\n```\n## Prometheus.yml配置说明\nPrometheus通过命令行参数和配置文件进行配置。虽然命令行参数配置了不可变的系统参数（例如存储位置，保留在磁盘和内存中的数据量等），但配置文件定义了与抓取job及其instance相关的所有内容，以及哪些规则文件的加载。\nPrometheus可以在运行时重新加载其配置。如果新配置格式不正确，则不会应用更改。它有两种方式：\n* 通过向prometheus进程发送SIGHUP信号\n* 向Prometheus进程发送/-/reload的POST请求，`curl -X POST http://localdns:9090/-/reload`\n\n### 配置文件\n要指定要加载的配置文件，请使用该`--config.file`标志。该文件以[YAML格式](https://en.wikipedia.org/wiki/YAML)编写，由下面描述的方案定义。括号表示参数是可选的。对于非列表参数，该值设置为指定的默认值。\n\n**以下为一个简单的prometheus.yml示例：**\n\n```yaml\n# Prometheus全局配置项\nglobal:\n  scrape_interval:     15s # 设定抓取数据的周期，默认为1min\n  evaluation_interval: 15s # 设定更新rules文件的周期，默认为1min\n  scrape_timeout: 15s # 设定抓取数据的超时时间，默认为10s\n  external_labels: # 额外的属性，会添加到拉取得数据并存到数据库中\n   monitor: 'codelab_monitor'\n\n\n# Alertmanager配置\nalerting:\n alertmanagers:\n - static_configs:\n   - targets: [\"localhost:9093\"] # 设定alertmanager和prometheus交互的接口，即alertmanager监听的ip地址和端口\n\n# rule配置，首次读取默认加载，之后根据evaluation_interval设定的周期加载\nrule_files:\n - \"alertmanager_rules.yml\"\n - \"prometheus_rules.yml\"\n\n# scrape配置\nscrape_configs:\n- job_name: 'prometheus' # job_name默认写入timeseries的labels中，可以用于查询使用\n  scrape_interval: 15s # 抓取周期，默认采用global配置\n  static_configs: # 静态配置\n  - targets: ['localdns:9090'] # prometheus所要抓取数据的地址，即instance实例项\n\n- job_name: 'example-random'\n  static_configs:\n  - targets: ['localhost:8080']\n```\n更多关于prometheus配置文件参数以及自动发现规则，请参考官方[prometheus配置](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)","source":"_posts/prometheus.md","raw":"layout: post\ntitle: 下一代监控Prometheus初识\nauthor: Pyker\ncategories: prometheus\nimg: /images/bar/prometheus.jpg\ntags:\n  - prometheus\ntop: false\ncover: false\ndate: 2019-01-12 10:10:00\n---\n## Prometheus介绍\nPrometheus 是一套开源的系统监控报警框架。它启发于 Google 的 borgmon 监控系统，由工作在 SoundCloud 的 google 前员工在 2012 年创建，作为社区开源项目进行开发，并于 2015 年正式发布。2016 年，Prometheus 正式加入 Cloud Native Computing Foundation，成为受欢迎度仅次于 Kubernetes 的项目。\n### 什么是TSDB\nTSDB(Time Series Database)时序列数据库，我们可以简单的理解为一个优化后用来处理时间序列数据的软件，并且数据中的数组是由时间进行索引的。\n\n**Prometheus作为TSDB具有以下特点：**\n* 具有由指标名称和键/值对标识的时间序列数据的多维度数据模型。\n* PromQL灵活的查询语言。\n* 不依赖分布式存储，单个服务器节点是自主的。\n* 通过基于HTTP的pull方式采集时序数据。\n* 可以通过中间网关（Pushgateway）进行时序列数据推送。\n* 通过服务发现或者静态配置来发现目标服务对象。\n* 支持多种多样的图表和界面展示，比如Grafana等。\n\n## Prometheus组成和架构\nPrometheus 生态圈中包含了多个组件，其中许多组件是可选的：\n* `Prometheus Server`：它是Prometheus组件中的核心部分，负责实现对监控数据的获取，存储及查询。Prometheus Server可以通过静态配置管理监控目标，也可以配合使用Service Discovery的方式动态管理监控目标，并从这些监控目标中获取数据。其次Prometheus Sever需要对采集到的数据进行存储，Prometheus Server本身就是一个实时数据库，将采集到的监控数据按照时间序列的方式存储在本地磁盘当中。Prometheus Server对外提供了自定义的PromQL，实现对数据的查询以及分析。另外Prometheus Server的联邦集群能力可以使其从其他的Prometheus Server实例中获取数据。\n\n* `Exporters`：Exporter将监控数据采集的端点通过HTTP服务的形式暴露给Prometheus Server，将其转化为Prometheus支持的格式，Prometheus Server通过访问该Exporter提供的Endpoint端点，即可以获取到需要采集的监控数据。可以将Exporter分为2类：\n>`直接采集`：这一类Exporter直接内置了对Prometheus监控的支持，比如cAdvisor，Kubernetes，Etcd，Gokit等，都直接内置了用于向Prometheus暴露监控数据的端点。\n>\n>`间接采集`：原有监控目标并不直接支持Prometheus，因此需要通过Prometheus提供的Client Library编写该监控目标的监控采集程序。如：Mysql Exporter，JMX Exporter，Consul Exporter等。\n* `AlertManager`：在Prometheus Server中支持基于Prom QL创建告警规则，如果满足Prom QL定义的规则，则会产生一条告警。当AlertManager从 Prometheus server 端接收到 alerts后，会进行去除重复数据，分组，并路由到对收的接受方式，发出报警。常见的接收方式有：电子邮件，pagerduty，webhook 等。\n* `PushGateway`: 主要用于短期的jobs。由于这类 jobs 存在时间较短，可能在 Prometheus 来 pull 之前就消失了。为此，这次 jobs 可以直接向 Prometheus中间网关推送它们的 metrics。这种方式主要用于服务层面的 metrics，对于机器层面的 metrices，需要使用 node exporter。（PushGatway类似zabbix proxy）\n\n### Prometheus 架构图\n![](https://prometheus.io/assets/architecture.png)\n从上图可以看出，Prometheus 的主要模块包括：`Prometheus server`, `exporters`, `Pushgateway`, `PromQL`, `Alertmanager` 以及`图形界面`。Prometheus的基本原理是通过HTTP协议周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，比如VM、Docker、Kubernetes等。输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux系统信息(包括磁盘、内存、CPU、网络等等)。\n\n### Prometheus工作流程\n1. Prometheus server 定期从配置好的 jobs 或者 exporters 中拉取 metrics，或者从Pushgateway 拉取metrics，或者从其他的 Prometheus server 中拉 metrics。\n2. Prometheus server 在本地存储收集到的 metrics，并运行已定义好的 alert.rules，通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。记录新的时间序列或者向 Alertmanager 推送警报。\n3. Prometheus通过PromQL和其他API可视化地展示收集的数据。Prometheus支持很多方式的图表可视化，例如Grafana、自带的Promdash以及自身提供的模版引擎等等。Prometheus还提供HTTP API的查询方式，自定义所需要的输出。\n\n## Prometheus相关概念\n### 数据模型\nPrometheus 中存储的数据为时间序列，是由 metric 的名字和一系列的标签（键值对）唯一标识的，不同的标签则代表不同的时间序列。\n给定度量标准名称和一组标签，通常使用此表示法标识时间序列：\n```\n<metric name>{<label name>=<label value>, ...}\n```\n例如：度量名称的时间序列api_http_requests_total和标签method=\"POST\"，并handler=\"/messages\"可以这样写：\n```\napi_http_requests_total{method=\"POST\", handler=\"/messages\"}\n```\n### 四种Metric类型\n* **Counter**\n\t一种累加的 metric，计数器可以用于记录只会增加不会减少的指标类型,比如记录：应用请求的总数，cpu使用时间，结束的任务数， 出现的错误数等。 对于Counter类型的指标，只包含一个inc()方法，用于计数器+1。\n* **Gauge**\n\t一种常规的 metric，可以任意加减。 常用于反应应用的当前状态。典型的应用如：温度，运行的 goroutines 的个数。对于Gauge指标的对象则包含两个主要的方法inc()以及dec(),用户添加或者减少计数。\n* **Histogram**\n\t自带buckets区间用于统计分布直方图，主要用于在指定分布范围内(Buckets)记录大小或者事件发生的次数。典型的应用如：请求持续时间，响应大小。\n* **Summary**\n\t Summary和Histogram非常类型相似，都可以统计事件发生的次数或者大小，以及其分布情况。Summary和Histogram都提供了对于事件的计数`_count`以及值的汇总`_sum`。 因此使用_count,和_sum时间序列可以计算出相同的内容，例如http每秒的平均响应时间：rate(basename_sum[5m]) / rate(basename_count[5m])。\n\t 同时Summary和Histogram都可以计算和统计样本的分布情况，比如中位数，9分位数等等。其中 0.0<= 分位数Quantiles <= 1.0。\n\t 不同在于Histogram可以通过`histogram_quantile函数`在服务器端计算分位数。 而Sumamry的分位数则是直接在客户端进行定义。因此对于分位数的计算。 Summary在通过PromQL进行查询时有更好的性能表现，而Histogram则会消耗更多的资源。\n\n### Jobs 和 Instances\n在Prometheus术语中，您可以scrape的目标称为instance，通常对应于单个进程。具有相同目的的instance集合，例如，为可伸缩性或可靠性而复制的流程称为Job。例如：\n```\njob: api-server\n    instance 1: 1.2.3.4:5670\n    instance 2: 1.2.3.4:5671\n    instance 3: 5.6.7.8:5670\n    instance 4: 5.6.7.8:5671\n```\n当Prometheus进行scrape目标时，它会自动将job标签和instance标签附加到scrape到的时间序列中，用于识别被抓取的目标，如果这些标签中的任何一个已存在于已删除数据中，则行为取决于`honor_labels`配置选项。\n### 表达式语言类型\nPrometheus表达式或子表达式可以评估为一下四种类型之一：\n* 即时向量（Instant vector） - 包含每个时间序列单个样品的一组时间序列，共享相同的时间戳\n* 范围向量（Range vector） - 包含一个范围内数据点的一组时间序列\n* 标量（Scalar） - 一个简单的数字浮点值\n* 字符串（String） - 一个简单的字符串值；当前未使用\n\n### 时间序列选择器\n#### 即时向量选择\n即时向量选择器允许选择一组时间序列，或者某个给定的时间戳的样本数据。下面这个例子选择了具有http_requests_total的时间序列：\n```\nhttp_requests_total\n```\n你可以通过附加一组标签，并用{}括起来，来进一步筛选这些时间序列。下面这个例子只选择有http_requests_total名称的、有prometheus工作标签的、有canary组标签的时间序列：\n```\nhttp_requests_total{job=\"prometheus\",group=\"canary\"}\n```\n另外，也可以也可以将标签值反向匹配，或者对正则表达式匹配标签值。下面列举匹配操作符：\n* `=`：选择正好相等的字符串标签\n* `!=`：选择不相等的字符串标签\n* `=~`：选择匹配正则表达式的标签（或子标签）\n* `!~`：选择不匹配正则表达式的标签（或子标签）\n\n例如，选择staging、testing、development环境下的，GET之外的HTTP方法的http_requests_total的时间序列：\n\n```\nhttp_requests_total{environment=~\"staging|testing|development\",method!=\"GET\"}\n```\n#### 范围向量选择\n范围向量表达式正如即时向量表达式一样运行，但是前者返回从当前时刻开始的一定时间范围的时间序列集合回来。语法是，在一个向量表达式之后添加[]来表示时间范围，持续时间用数字表示，后接下面单元之一：\n* `s`：seconds\n* `m`：minutes\n* `h`：hours\n* `d`：days\n* `w`：weeks\n* `y`：years\n\n在下面这个例子中，我们选择最后5分钟的记录，metric名称为http_requests_total、作业标签为prometheus的时间序列的所有值：\n```\nhttp_requests_total{job=\"prometheus\"}[5m]\n```\n#### 偏移量Offset\n所述offset可以改变时间为查询中的个别时刻和范围矢量偏移。例如，以下表达式返回http_requests_total相对于当前查询评估时间的过去5分钟值 ：\n```\nhttp_requests_total offset 5m\n```\n同样适用于范围向量。这将返回http_requests_total一周前的5分钟费率 ：\n```\nrate(http_requests_total[5m] offset 1w)\n```\n### 操作符\n关于操作符的说明，请参考官网[操作符说明](https://prometheus.io/docs/prometheus/latest/querying/operators/)\n###  函数\n关于函数的说明，请参考官网[函数解释](https://prometheus.io/docs/prometheus/latest/querying/functions/)\n## Prometheus的安装\n### 下载prometheus二进制包\n```bash\n$ wget https://github.com/prometheus/prometheus/releases/download/v2.9.1/prometheus-2.9.1.linux-amd64.tar.gz\n```\n### 解压prometheus压缩包\n```bash\n$ tar zxvf prometheus-2.9.1.linux-amd64.tar.gz\n```\n### 将prometheus放到/usr/local目录下\n```bash\n$ mv prometheus-2.9.1.linux-amd64 /usr/local/prometheus\n```\n### 验证版本\n```bash\n$ /usr/local/prometheus/prometheus --version \n  prometheus, version 2.9.1 (branch: HEAD, revision: ad71f2785fc321092948e33706b04f3150eee44f)\n  build user:       root@09f919068df4\n  build date:       20190416-17:50:04\n  go version:       go1.12.4\n```\n### 配置prometheus用户\n```bash\n$ groupadd prometheus\n$ useradd -g prometheus -s /sbin/nologin prometheus\n```\n### 创建prometheus数据目录\n```bash\n$ mkdir -p /var/lib/prometheus\n```\n### 创建prometheus的systemctl文件\n```bash\n$ cat > /usr/lib/systemd/system/prometheus.service << EOF\n[Unit]\nDescription=Prometheus\nDocumentation=https://prometheus.io/\nAfter=network.target\n\n[Service]\nType=simple\nUser=prometheus\nExecStart=/usr/local/prometheus/prometheus --config.file=/usr/local/prometheus/prometheus.yml --storage.tsdb.path=/var/lib/prometheus\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n### prometheus权限配置\n```bash\n# prometheus主程序\n$ chown -R prometheus:prometheus /usr/local/prometheus/\n\n# prometheus数据目录\n$ chown -R prometheus:prometheus /var/lib/prometheus/\n\n# prometheus启动文件\n$ chown prometheus:prometheus /usr/lib/systemd/system/prometheus.service\n```\n\n### 启动服务并设为开机启动\n```bash\n$ systemctl start prometheus\n$ systemctl enable prometheus\n```\n## Prometheus.yml配置说明\nPrometheus通过命令行参数和配置文件进行配置。虽然命令行参数配置了不可变的系统参数（例如存储位置，保留在磁盘和内存中的数据量等），但配置文件定义了与抓取job及其instance相关的所有内容，以及哪些规则文件的加载。\nPrometheus可以在运行时重新加载其配置。如果新配置格式不正确，则不会应用更改。它有两种方式：\n* 通过向prometheus进程发送SIGHUP信号\n* 向Prometheus进程发送/-/reload的POST请求，`curl -X POST http://localdns:9090/-/reload`\n\n### 配置文件\n要指定要加载的配置文件，请使用该`--config.file`标志。该文件以[YAML格式](https://en.wikipedia.org/wiki/YAML)编写，由下面描述的方案定义。括号表示参数是可选的。对于非列表参数，该值设置为指定的默认值。\n\n**以下为一个简单的prometheus.yml示例：**\n\n```yaml\n# Prometheus全局配置项\nglobal:\n  scrape_interval:     15s # 设定抓取数据的周期，默认为1min\n  evaluation_interval: 15s # 设定更新rules文件的周期，默认为1min\n  scrape_timeout: 15s # 设定抓取数据的超时时间，默认为10s\n  external_labels: # 额外的属性，会添加到拉取得数据并存到数据库中\n   monitor: 'codelab_monitor'\n\n\n# Alertmanager配置\nalerting:\n alertmanagers:\n - static_configs:\n   - targets: [\"localhost:9093\"] # 设定alertmanager和prometheus交互的接口，即alertmanager监听的ip地址和端口\n\n# rule配置，首次读取默认加载，之后根据evaluation_interval设定的周期加载\nrule_files:\n - \"alertmanager_rules.yml\"\n - \"prometheus_rules.yml\"\n\n# scrape配置\nscrape_configs:\n- job_name: 'prometheus' # job_name默认写入timeseries的labels中，可以用于查询使用\n  scrape_interval: 15s # 抓取周期，默认采用global配置\n  static_configs: # 静态配置\n  - targets: ['localdns:9090'] # prometheus所要抓取数据的地址，即instance实例项\n\n- job_name: 'example-random'\n  static_configs:\n  - targets: ['localhost:8080']\n```\n更多关于prometheus配置文件参数以及自动发现规则，请参考官方[prometheus配置](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)","slug":"prometheus","published":1,"updated":"2019-05-28T02:02:23.507Z","_id":"cjw6jlf0s002lp4n76yld7u6h","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"Prometheus介绍\"><a href=\"#Prometheus介绍\" class=\"headerlink\" title=\"Prometheus介绍\"></a>Prometheus介绍</h2><p>Prometheus 是一套开源的系统监控报警框架。它启发于 Google 的 borgmon 监控系统，由工作在 SoundCloud 的 google 前员工在 2012 年创建，作为社区开源项目进行开发，并于 2015 年正式发布。2016 年，Prometheus 正式加入 Cloud Native Computing Foundation，成为受欢迎度仅次于 Kubernetes 的项目。</p>\n<h3 id=\"什么是TSDB\"><a href=\"#什么是TSDB\" class=\"headerlink\" title=\"什么是TSDB\"></a>什么是TSDB</h3><p>TSDB(Time Series Database)时序列数据库，我们可以简单的理解为一个优化后用来处理时间序列数据的软件，并且数据中的数组是由时间进行索引的。</p>\n<p><strong>Prometheus作为TSDB具有以下特点：</strong></p>\n<ul>\n<li>具有由指标名称和键/值对标识的时间序列数据的多维度数据模型。</li>\n<li>PromQL灵活的查询语言。</li>\n<li>不依赖分布式存储，单个服务器节点是自主的。</li>\n<li>通过基于HTTP的pull方式采集时序数据。</li>\n<li>可以通过中间网关（Pushgateway）进行时序列数据推送。</li>\n<li>通过服务发现或者静态配置来发现目标服务对象。</li>\n<li>支持多种多样的图表和界面展示，比如Grafana等。</li>\n</ul>\n<h2 id=\"Prometheus组成和架构\"><a href=\"#Prometheus组成和架构\" class=\"headerlink\" title=\"Prometheus组成和架构\"></a>Prometheus组成和架构</h2><p>Prometheus 生态圈中包含了多个组件，其中许多组件是可选的：</p>\n<ul>\n<li><p><code>Prometheus Server</code>：它是Prometheus组件中的核心部分，负责实现对监控数据的获取，存储及查询。Prometheus Server可以通过静态配置管理监控目标，也可以配合使用Service Discovery的方式动态管理监控目标，并从这些监控目标中获取数据。其次Prometheus Sever需要对采集到的数据进行存储，Prometheus Server本身就是一个实时数据库，将采集到的监控数据按照时间序列的方式存储在本地磁盘当中。Prometheus Server对外提供了自定义的PromQL，实现对数据的查询以及分析。另外Prometheus Server的联邦集群能力可以使其从其他的Prometheus Server实例中获取数据。</p>\n</li>\n<li><p><code>Exporters</code>：Exporter将监控数据采集的端点通过HTTP服务的形式暴露给Prometheus Server，将其转化为Prometheus支持的格式，Prometheus Server通过访问该Exporter提供的Endpoint端点，即可以获取到需要采集的监控数据。可以将Exporter分为2类：</p>\n<blockquote>\n<p><code>直接采集</code>：这一类Exporter直接内置了对Prometheus监控的支持，比如cAdvisor，Kubernetes，Etcd，Gokit等，都直接内置了用于向Prometheus暴露监控数据的端点。</p>\n<p><code>间接采集</code>：原有监控目标并不直接支持Prometheus，因此需要通过Prometheus提供的Client Library编写该监控目标的监控采集程序。如：Mysql Exporter，JMX Exporter，Consul Exporter等。</p>\n</blockquote>\n</li>\n<li><code>AlertManager</code>：在Prometheus Server中支持基于Prom QL创建告警规则，如果满足Prom QL定义的规则，则会产生一条告警。当AlertManager从 Prometheus server 端接收到 alerts后，会进行去除重复数据，分组，并路由到对收的接受方式，发出报警。常见的接收方式有：电子邮件，pagerduty，webhook 等。</li>\n<li><code>PushGateway</code>: 主要用于短期的jobs。由于这类 jobs 存在时间较短，可能在 Prometheus 来 pull 之前就消失了。为此，这次 jobs 可以直接向 Prometheus中间网关推送它们的 metrics。这种方式主要用于服务层面的 metrics，对于机器层面的 metrices，需要使用 node exporter。（PushGatway类似zabbix proxy）</li>\n</ul>\n<h3 id=\"Prometheus-架构图\"><a href=\"#Prometheus-架构图\" class=\"headerlink\" title=\"Prometheus 架构图\"></a>Prometheus 架构图</h3><p><img src=\"https://prometheus.io/assets/architecture.png\" alt><br>从上图可以看出，Prometheus 的主要模块包括：<code>Prometheus server</code>, <code>exporters</code>, <code>Pushgateway</code>, <code>PromQL</code>, <code>Alertmanager</code> 以及<code>图形界面</code>。Prometheus的基本原理是通过HTTP协议周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，比如VM、Docker、Kubernetes等。输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux系统信息(包括磁盘、内存、CPU、网络等等)。</p>\n<h3 id=\"Prometheus工作流程\"><a href=\"#Prometheus工作流程\" class=\"headerlink\" title=\"Prometheus工作流程\"></a>Prometheus工作流程</h3><ol>\n<li>Prometheus server 定期从配置好的 jobs 或者 exporters 中拉取 metrics，或者从Pushgateway 拉取metrics，或者从其他的 Prometheus server 中拉 metrics。</li>\n<li>Prometheus server 在本地存储收集到的 metrics，并运行已定义好的 alert.rules，通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。记录新的时间序列或者向 Alertmanager 推送警报。</li>\n<li>Prometheus通过PromQL和其他API可视化地展示收集的数据。Prometheus支持很多方式的图表可视化，例如Grafana、自带的Promdash以及自身提供的模版引擎等等。Prometheus还提供HTTP API的查询方式，自定义所需要的输出。</li>\n</ol>\n<h2 id=\"Prometheus相关概念\"><a href=\"#Prometheus相关概念\" class=\"headerlink\" title=\"Prometheus相关概念\"></a>Prometheus相关概念</h2><h3 id=\"数据模型\"><a href=\"#数据模型\" class=\"headerlink\" title=\"数据模型\"></a>数据模型</h3><p>Prometheus 中存储的数据为时间序列，是由 metric 的名字和一系列的标签（键值对）唯一标识的，不同的标签则代表不同的时间序列。<br>给定度量标准名称和一组标签，通常使用此表示法标识时间序列：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;metric name&gt;&#123;&lt;<span class=\"selector-tag\">label</span> name&gt;=&lt;<span class=\"selector-tag\">label</span> value&gt;, ...&#125;</span><br></pre></td></tr></table></figure></p>\n<p>例如：度量名称的时间序列api_http_requests_total和标签method=”POST”，并handler=”/messages”可以这样写：<br><figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">api_http_requests_total&#123;method=<span class=\"string\">\"<span class=\"keyword\">POST</span>\"</span>, handler=<span class=\"string\">\"/messages\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"四种Metric类型\"><a href=\"#四种Metric类型\" class=\"headerlink\" title=\"四种Metric类型\"></a>四种Metric类型</h3><ul>\n<li><strong>Counter</strong><br>  一种累加的 metric，计数器可以用于记录只会增加不会减少的指标类型,比如记录：应用请求的总数，cpu使用时间，结束的任务数， 出现的错误数等。 对于Counter类型的指标，只包含一个inc()方法，用于计数器+1。</li>\n<li><strong>Gauge</strong><br>  一种常规的 metric，可以任意加减。 常用于反应应用的当前状态。典型的应用如：温度，运行的 goroutines 的个数。对于Gauge指标的对象则包含两个主要的方法inc()以及dec(),用户添加或者减少计数。</li>\n<li><strong>Histogram</strong><br>  自带buckets区间用于统计分布直方图，主要用于在指定分布范围内(Buckets)记录大小或者事件发生的次数。典型的应用如：请求持续时间，响应大小。</li>\n<li><strong>Summary</strong><br>   Summary和Histogram非常类型相似，都可以统计事件发生的次数或者大小，以及其分布情况。Summary和Histogram都提供了对于事件的计数<code>_count</code>以及值的汇总<code>_sum</code>。 因此使用_count,和_sum时间序列可以计算出相同的内容，例如http每秒的平均响应时间：rate(basename_sum[5m]) / rate(basename_count[5m])。<br>   同时Summary和Histogram都可以计算和统计样本的分布情况，比如中位数，9分位数等等。其中 0.0&lt;= 分位数Quantiles &lt;= 1.0。<br>   不同在于Histogram可以通过<code>histogram_quantile函数</code>在服务器端计算分位数。 而Sumamry的分位数则是直接在客户端进行定义。因此对于分位数的计算。 Summary在通过PromQL进行查询时有更好的性能表现，而Histogram则会消耗更多的资源。</li>\n</ul>\n<h3 id=\"Jobs-和-Instances\"><a href=\"#Jobs-和-Instances\" class=\"headerlink\" title=\"Jobs 和 Instances\"></a>Jobs 和 Instances</h3><p>在Prometheus术语中，您可以scrape的目标称为instance，通常对应于单个进程。具有相同目的的instance集合，例如，为可伸缩性或可靠性而复制的流程称为Job。例如：<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">job: api-server</span><br><span class=\"line\">   <span class=\"built_in\"> instance </span>1: 1.2.3.4:5670</span><br><span class=\"line\">   <span class=\"built_in\"> instance </span>2: 1.2.3.4:5671</span><br><span class=\"line\">   <span class=\"built_in\"> instance </span>3: 5.6.7.8:5670</span><br><span class=\"line\">   <span class=\"built_in\"> instance </span>4: 5.6.7.8:5671</span><br></pre></td></tr></table></figure></p>\n<p>当Prometheus进行scrape目标时，它会自动将job标签和instance标签附加到scrape到的时间序列中，用于识别被抓取的目标，如果这些标签中的任何一个已存在于已删除数据中，则行为取决于<code>honor_labels</code>配置选项。</p>\n<h3 id=\"表达式语言类型\"><a href=\"#表达式语言类型\" class=\"headerlink\" title=\"表达式语言类型\"></a>表达式语言类型</h3><p>Prometheus表达式或子表达式可以评估为一下四种类型之一：</p>\n<ul>\n<li>即时向量（Instant vector） - 包含每个时间序列单个样品的一组时间序列，共享相同的时间戳</li>\n<li>范围向量（Range vector） - 包含一个范围内数据点的一组时间序列</li>\n<li>标量（Scalar） - 一个简单的数字浮点值</li>\n<li>字符串（String） - 一个简单的字符串值；当前未使用</li>\n</ul>\n<h3 id=\"时间序列选择器\"><a href=\"#时间序列选择器\" class=\"headerlink\" title=\"时间序列选择器\"></a>时间序列选择器</h3><h4 id=\"即时向量选择\"><a href=\"#即时向量选择\" class=\"headerlink\" title=\"即时向量选择\"></a>即时向量选择</h4><p>即时向量选择器允许选择一组时间序列，或者某个给定的时间戳的样本数据。下面这个例子选择了具有http_requests_total的时间序列：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http_requests_total</span><br></pre></td></tr></table></figure></p>\n<p>你可以通过附加一组标签，并用{}括起来，来进一步筛选这些时间序列。下面这个例子只选择有http_requests_total名称的、有prometheus工作标签的、有canary组标签的时间序列：<br><figure class=\"highlight axapta\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http_requests_total&#123;job=<span class=\"string\">\"prometheus\"</span>,<span class=\"keyword\">group</span>=<span class=\"string\">\"canary\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>另外，也可以也可以将标签值反向匹配，或者对正则表达式匹配标签值。下面列举匹配操作符：</p>\n<ul>\n<li><code>=</code>：选择正好相等的字符串标签</li>\n<li><code>!=</code>：选择不相等的字符串标签</li>\n<li><code>=~</code>：选择匹配正则表达式的标签（或子标签）</li>\n<li><code>!~</code>：选择不匹配正则表达式的标签（或子标签）</li>\n</ul>\n<p>例如，选择staging、testing、development环境下的，GET之外的HTTP方法的http_requests_total的时间序列：</p>\n<figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http_requests_total&#123;environment=~<span class=\"string\">\"staging|testing|development\"</span>,method!=<span class=\"string\">\"<span class=\"keyword\">GET</span>\"</span>&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"范围向量选择\"><a href=\"#范围向量选择\" class=\"headerlink\" title=\"范围向量选择\"></a>范围向量选择</h4><p>范围向量表达式正如即时向量表达式一样运行，但是前者返回从当前时刻开始的一定时间范围的时间序列集合回来。语法是，在一个向量表达式之后添加[]来表示时间范围，持续时间用数字表示，后接下面单元之一：</p>\n<ul>\n<li><code>s</code>：seconds</li>\n<li><code>m</code>：minutes</li>\n<li><code>h</code>：hours</li>\n<li><code>d</code>：days</li>\n<li><code>w</code>：weeks</li>\n<li><code>y</code>：years</li>\n</ul>\n<p>在下面这个例子中，我们选择最后5分钟的记录，metric名称为http_requests_total、作业标签为prometheus的时间序列的所有值：<br><figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http_requests_total&#123;job=<span class=\"string\">\"prometheus\"</span>&#125;<span class=\"string\">[5m]</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"偏移量Offset\"><a href=\"#偏移量Offset\" class=\"headerlink\" title=\"偏移量Offset\"></a>偏移量Offset</h4><p>所述offset可以改变时间为查询中的个别时刻和范围矢量偏移。例如，以下表达式返回http_requests_total相对于当前查询评估时间的过去5分钟值 ：<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http_requests_total <span class=\"built_in\">offset</span> <span class=\"number\">5</span>m</span><br></pre></td></tr></table></figure></p>\n<p>同样适用于范围向量。这将返回http_requests_total一周前的5分钟费率 ：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"title\">rate</span><span class=\"params\">(http_requests_total[<span class=\"number\">5</span>m] offset <span class=\"number\">1</span>w)</span></span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"操作符\"><a href=\"#操作符\" class=\"headerlink\" title=\"操作符\"></a>操作符</h3><p>关于操作符的说明，请参考官网<a href=\"https://prometheus.io/docs/prometheus/latest/querying/operators/\" target=\"_blank\" rel=\"noopener\">操作符说明</a></p>\n<h3 id=\"函数\"><a href=\"#函数\" class=\"headerlink\" title=\"函数\"></a>函数</h3><p>关于函数的说明，请参考官网<a href=\"https://prometheus.io/docs/prometheus/latest/querying/functions/\" target=\"_blank\" rel=\"noopener\">函数解释</a></p>\n<h2 id=\"Prometheus的安装\"><a href=\"#Prometheus的安装\" class=\"headerlink\" title=\"Prometheus的安装\"></a>Prometheus的安装</h2><h3 id=\"下载prometheus二进制包\"><a href=\"#下载prometheus二进制包\" class=\"headerlink\" title=\"下载prometheus二进制包\"></a>下载prometheus二进制包</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ wget https://github.com/prometheus/prometheus/releases/download/v2.9.1/prometheus-2.9.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>\n<h3 id=\"解压prometheus压缩包\"><a href=\"#解压prometheus压缩包\" class=\"headerlink\" title=\"解压prometheus压缩包\"></a>解压prometheus压缩包</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tar zxvf prometheus-2.9.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>\n<h3 id=\"将prometheus放到-usr-local目录下\"><a href=\"#将prometheus放到-usr-local目录下\" class=\"headerlink\" title=\"将prometheus放到/usr/local目录下\"></a>将prometheus放到/usr/local目录下</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mv prometheus-2.9.1.linux-amd64 /usr/<span class=\"built_in\">local</span>/prometheus</span><br></pre></td></tr></table></figure>\n<h3 id=\"验证版本\"><a href=\"#验证版本\" class=\"headerlink\" title=\"验证版本\"></a>验证版本</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ /usr/<span class=\"built_in\">local</span>/prometheus/prometheus --version </span><br><span class=\"line\">  prometheus, version 2.9.1 (branch: HEAD, revision: ad71f2785fc321092948e33706b04f3150eee44f)</span><br><span class=\"line\">  build user:       root@09f919068df4</span><br><span class=\"line\">  build date:       20190416-17:50:04</span><br><span class=\"line\">  go version:       go1.12.4</span><br></pre></td></tr></table></figure>\n<h3 id=\"配置prometheus用户\"><a href=\"#配置prometheus用户\" class=\"headerlink\" title=\"配置prometheus用户\"></a>配置prometheus用户</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ groupadd prometheus</span><br><span class=\"line\">$ useradd -g prometheus -s /sbin/nologin prometheus</span><br></pre></td></tr></table></figure>\n<h3 id=\"创建prometheus数据目录\"><a href=\"#创建prometheus数据目录\" class=\"headerlink\" title=\"创建prometheus数据目录\"></a>创建prometheus数据目录</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir -p /var/lib/prometheus</span><br></pre></td></tr></table></figure>\n<h3 id=\"创建prometheus的systemctl文件\"><a href=\"#创建prometheus的systemctl文件\" class=\"headerlink\" title=\"创建prometheus的systemctl文件\"></a>创建prometheus的systemctl文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat &gt; /usr/lib/systemd/system/prometheus.service &lt;&lt; EOF</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Prometheus</span><br><span class=\"line\">Documentation=https://prometheus.io/</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">User=prometheus</span><br><span class=\"line\">ExecStart=/usr/<span class=\"built_in\">local</span>/prometheus/prometheus --config.file=/usr/<span class=\"built_in\">local</span>/prometheus/prometheus.yml --storage.tsdb.path=/var/lib/prometheus</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h3 id=\"prometheus权限配置\"><a href=\"#prometheus权限配置\" class=\"headerlink\" title=\"prometheus权限配置\"></a>prometheus权限配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># prometheus主程序</span></span><br><span class=\"line\">$ chown -R prometheus:prometheus /usr/<span class=\"built_in\">local</span>/prometheus/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># prometheus数据目录</span></span><br><span class=\"line\">$ chown -R prometheus:prometheus /var/lib/prometheus/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># prometheus启动文件</span></span><br><span class=\"line\">$ chown prometheus:prometheus /usr/lib/systemd/system/prometheus.service</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动服务并设为开机启动\"><a href=\"#启动服务并设为开机启动\" class=\"headerlink\" title=\"启动服务并设为开机启动\"></a>启动服务并设为开机启动</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ systemctl start prometheus</span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> prometheus</span><br></pre></td></tr></table></figure>\n<h2 id=\"Prometheus-yml配置说明\"><a href=\"#Prometheus-yml配置说明\" class=\"headerlink\" title=\"Prometheus.yml配置说明\"></a>Prometheus.yml配置说明</h2><p>Prometheus通过命令行参数和配置文件进行配置。虽然命令行参数配置了不可变的系统参数（例如存储位置，保留在磁盘和内存中的数据量等），但配置文件定义了与抓取job及其instance相关的所有内容，以及哪些规则文件的加载。<br>Prometheus可以在运行时重新加载其配置。如果新配置格式不正确，则不会应用更改。它有两种方式：</p>\n<ul>\n<li>通过向prometheus进程发送SIGHUP信号</li>\n<li>向Prometheus进程发送/-/reload的POST请求，<code>curl -X POST http://localdns:9090/-/reload</code></li>\n</ul>\n<h3 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h3><p>要指定要加载的配置文件，请使用该<code>--config.file</code>标志。该文件以<a href=\"https://en.wikipedia.org/wiki/YAML\" target=\"_blank\" rel=\"noopener\">YAML格式</a>编写，由下面描述的方案定义。括号表示参数是可选的。对于非列表参数，该值设置为指定的默认值。</p>\n<p><strong>以下为一个简单的prometheus.yml示例：</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Prometheus全局配置项</span></span><br><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_interval:</span>     <span class=\"number\">15</span><span class=\"string\">s</span> <span class=\"comment\"># 设定抓取数据的周期，默认为1min</span></span><br><span class=\"line\"><span class=\"attr\">  evaluation_interval:</span> <span class=\"number\">15</span><span class=\"string\">s</span> <span class=\"comment\"># 设定更新rules文件的周期，默认为1min</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_timeout:</span> <span class=\"number\">15</span><span class=\"string\">s</span> <span class=\"comment\"># 设定抓取数据的超时时间，默认为10s</span></span><br><span class=\"line\"><span class=\"attr\">  external_labels:</span> <span class=\"comment\"># 额外的属性，会添加到拉取得数据并存到数据库中</span></span><br><span class=\"line\"><span class=\"attr\">   monitor:</span> <span class=\"string\">'codelab_monitor'</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Alertmanager配置</span></span><br><span class=\"line\"><span class=\"attr\">alerting:</span></span><br><span class=\"line\"><span class=\"attr\"> alertmanagers:</span></span><br><span class=\"line\"><span class=\"attr\"> - static_configs:</span></span><br><span class=\"line\"><span class=\"attr\">   - targets:</span> <span class=\"string\">[\"localhost:9093\"]</span> <span class=\"comment\"># 设定alertmanager和prometheus交互的接口，即alertmanager监听的ip地址和端口</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># rule配置，首次读取默认加载，之后根据evaluation_interval设定的周期加载</span></span><br><span class=\"line\"><span class=\"attr\">rule_files:</span></span><br><span class=\"line\"><span class=\"bullet\"> -</span> <span class=\"string\">\"alertmanager_rules.yml\"</span></span><br><span class=\"line\"><span class=\"bullet\"> -</span> <span class=\"string\">\"prometheus_rules.yml\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># scrape配置</span></span><br><span class=\"line\"><span class=\"attr\">scrape_configs:</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">'prometheus'</span> <span class=\"comment\"># job_name默认写入timeseries的labels中，可以用于查询使用</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_interval:</span> <span class=\"number\">15</span><span class=\"string\">s</span> <span class=\"comment\"># 抓取周期，默认采用global配置</span></span><br><span class=\"line\"><span class=\"attr\">  static_configs:</span> <span class=\"comment\"># 静态配置</span></span><br><span class=\"line\"><span class=\"attr\">  - targets:</span> <span class=\"string\">['localdns:9090']</span> <span class=\"comment\"># prometheus所要抓取数据的地址，即instance实例项</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">'example-random'</span></span><br><span class=\"line\"><span class=\"attr\">  static_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - targets:</span> <span class=\"string\">['localhost:8080']</span></span><br></pre></td></tr></table></figure>\n<p>更多关于prometheus配置文件参数以及自动发现规则，请参考官方<a href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/\" target=\"_blank\" rel=\"noopener\">prometheus配置</a></p>\n","site":{"data":{}},"length":7747,"excerpt":"","more":"<h2 id=\"Prometheus介绍\"><a href=\"#Prometheus介绍\" class=\"headerlink\" title=\"Prometheus介绍\"></a>Prometheus介绍</h2><p>Prometheus 是一套开源的系统监控报警框架。它启发于 Google 的 borgmon 监控系统，由工作在 SoundCloud 的 google 前员工在 2012 年创建，作为社区开源项目进行开发，并于 2015 年正式发布。2016 年，Prometheus 正式加入 Cloud Native Computing Foundation，成为受欢迎度仅次于 Kubernetes 的项目。</p>\n<h3 id=\"什么是TSDB\"><a href=\"#什么是TSDB\" class=\"headerlink\" title=\"什么是TSDB\"></a>什么是TSDB</h3><p>TSDB(Time Series Database)时序列数据库，我们可以简单的理解为一个优化后用来处理时间序列数据的软件，并且数据中的数组是由时间进行索引的。</p>\n<p><strong>Prometheus作为TSDB具有以下特点：</strong></p>\n<ul>\n<li>具有由指标名称和键/值对标识的时间序列数据的多维度数据模型。</li>\n<li>PromQL灵活的查询语言。</li>\n<li>不依赖分布式存储，单个服务器节点是自主的。</li>\n<li>通过基于HTTP的pull方式采集时序数据。</li>\n<li>可以通过中间网关（Pushgateway）进行时序列数据推送。</li>\n<li>通过服务发现或者静态配置来发现目标服务对象。</li>\n<li>支持多种多样的图表和界面展示，比如Grafana等。</li>\n</ul>\n<h2 id=\"Prometheus组成和架构\"><a href=\"#Prometheus组成和架构\" class=\"headerlink\" title=\"Prometheus组成和架构\"></a>Prometheus组成和架构</h2><p>Prometheus 生态圈中包含了多个组件，其中许多组件是可选的：</p>\n<ul>\n<li><p><code>Prometheus Server</code>：它是Prometheus组件中的核心部分，负责实现对监控数据的获取，存储及查询。Prometheus Server可以通过静态配置管理监控目标，也可以配合使用Service Discovery的方式动态管理监控目标，并从这些监控目标中获取数据。其次Prometheus Sever需要对采集到的数据进行存储，Prometheus Server本身就是一个实时数据库，将采集到的监控数据按照时间序列的方式存储在本地磁盘当中。Prometheus Server对外提供了自定义的PromQL，实现对数据的查询以及分析。另外Prometheus Server的联邦集群能力可以使其从其他的Prometheus Server实例中获取数据。</p>\n</li>\n<li><p><code>Exporters</code>：Exporter将监控数据采集的端点通过HTTP服务的形式暴露给Prometheus Server，将其转化为Prometheus支持的格式，Prometheus Server通过访问该Exporter提供的Endpoint端点，即可以获取到需要采集的监控数据。可以将Exporter分为2类：</p>\n<blockquote>\n<p><code>直接采集</code>：这一类Exporter直接内置了对Prometheus监控的支持，比如cAdvisor，Kubernetes，Etcd，Gokit等，都直接内置了用于向Prometheus暴露监控数据的端点。</p>\n<p><code>间接采集</code>：原有监控目标并不直接支持Prometheus，因此需要通过Prometheus提供的Client Library编写该监控目标的监控采集程序。如：Mysql Exporter，JMX Exporter，Consul Exporter等。</p>\n</blockquote>\n</li>\n<li><code>AlertManager</code>：在Prometheus Server中支持基于Prom QL创建告警规则，如果满足Prom QL定义的规则，则会产生一条告警。当AlertManager从 Prometheus server 端接收到 alerts后，会进行去除重复数据，分组，并路由到对收的接受方式，发出报警。常见的接收方式有：电子邮件，pagerduty，webhook 等。</li>\n<li><code>PushGateway</code>: 主要用于短期的jobs。由于这类 jobs 存在时间较短，可能在 Prometheus 来 pull 之前就消失了。为此，这次 jobs 可以直接向 Prometheus中间网关推送它们的 metrics。这种方式主要用于服务层面的 metrics，对于机器层面的 metrices，需要使用 node exporter。（PushGatway类似zabbix proxy）</li>\n</ul>\n<h3 id=\"Prometheus-架构图\"><a href=\"#Prometheus-架构图\" class=\"headerlink\" title=\"Prometheus 架构图\"></a>Prometheus 架构图</h3><p><img src=\"https://prometheus.io/assets/architecture.png\" alt><br>从上图可以看出，Prometheus 的主要模块包括：<code>Prometheus server</code>, <code>exporters</code>, <code>Pushgateway</code>, <code>PromQL</code>, <code>Alertmanager</code> 以及<code>图形界面</code>。Prometheus的基本原理是通过HTTP协议周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，比如VM、Docker、Kubernetes等。输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux系统信息(包括磁盘、内存、CPU、网络等等)。</p>\n<h3 id=\"Prometheus工作流程\"><a href=\"#Prometheus工作流程\" class=\"headerlink\" title=\"Prometheus工作流程\"></a>Prometheus工作流程</h3><ol>\n<li>Prometheus server 定期从配置好的 jobs 或者 exporters 中拉取 metrics，或者从Pushgateway 拉取metrics，或者从其他的 Prometheus server 中拉 metrics。</li>\n<li>Prometheus server 在本地存储收集到的 metrics，并运行已定义好的 alert.rules，通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。记录新的时间序列或者向 Alertmanager 推送警报。</li>\n<li>Prometheus通过PromQL和其他API可视化地展示收集的数据。Prometheus支持很多方式的图表可视化，例如Grafana、自带的Promdash以及自身提供的模版引擎等等。Prometheus还提供HTTP API的查询方式，自定义所需要的输出。</li>\n</ol>\n<h2 id=\"Prometheus相关概念\"><a href=\"#Prometheus相关概念\" class=\"headerlink\" title=\"Prometheus相关概念\"></a>Prometheus相关概念</h2><h3 id=\"数据模型\"><a href=\"#数据模型\" class=\"headerlink\" title=\"数据模型\"></a>数据模型</h3><p>Prometheus 中存储的数据为时间序列，是由 metric 的名字和一系列的标签（键值对）唯一标识的，不同的标签则代表不同的时间序列。<br>给定度量标准名称和一组标签，通常使用此表示法标识时间序列：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;metric name&gt;&#123;&lt;<span class=\"selector-tag\">label</span> name&gt;=&lt;<span class=\"selector-tag\">label</span> value&gt;, ...&#125;</span><br></pre></td></tr></table></figure></p>\n<p>例如：度量名称的时间序列api_http_requests_total和标签method=”POST”，并handler=”/messages”可以这样写：<br><figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">api_http_requests_total&#123;method=<span class=\"string\">\"<span class=\"keyword\">POST</span>\"</span>, handler=<span class=\"string\">\"/messages\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"四种Metric类型\"><a href=\"#四种Metric类型\" class=\"headerlink\" title=\"四种Metric类型\"></a>四种Metric类型</h3><ul>\n<li><strong>Counter</strong><br>  一种累加的 metric，计数器可以用于记录只会增加不会减少的指标类型,比如记录：应用请求的总数，cpu使用时间，结束的任务数， 出现的错误数等。 对于Counter类型的指标，只包含一个inc()方法，用于计数器+1。</li>\n<li><strong>Gauge</strong><br>  一种常规的 metric，可以任意加减。 常用于反应应用的当前状态。典型的应用如：温度，运行的 goroutines 的个数。对于Gauge指标的对象则包含两个主要的方法inc()以及dec(),用户添加或者减少计数。</li>\n<li><strong>Histogram</strong><br>  自带buckets区间用于统计分布直方图，主要用于在指定分布范围内(Buckets)记录大小或者事件发生的次数。典型的应用如：请求持续时间，响应大小。</li>\n<li><strong>Summary</strong><br>   Summary和Histogram非常类型相似，都可以统计事件发生的次数或者大小，以及其分布情况。Summary和Histogram都提供了对于事件的计数<code>_count</code>以及值的汇总<code>_sum</code>。 因此使用_count,和_sum时间序列可以计算出相同的内容，例如http每秒的平均响应时间：rate(basename_sum[5m]) / rate(basename_count[5m])。<br>   同时Summary和Histogram都可以计算和统计样本的分布情况，比如中位数，9分位数等等。其中 0.0&lt;= 分位数Quantiles &lt;= 1.0。<br>   不同在于Histogram可以通过<code>histogram_quantile函数</code>在服务器端计算分位数。 而Sumamry的分位数则是直接在客户端进行定义。因此对于分位数的计算。 Summary在通过PromQL进行查询时有更好的性能表现，而Histogram则会消耗更多的资源。</li>\n</ul>\n<h3 id=\"Jobs-和-Instances\"><a href=\"#Jobs-和-Instances\" class=\"headerlink\" title=\"Jobs 和 Instances\"></a>Jobs 和 Instances</h3><p>在Prometheus术语中，您可以scrape的目标称为instance，通常对应于单个进程。具有相同目的的instance集合，例如，为可伸缩性或可靠性而复制的流程称为Job。例如：<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">job: api-server</span><br><span class=\"line\">   <span class=\"built_in\"> instance </span>1: 1.2.3.4:5670</span><br><span class=\"line\">   <span class=\"built_in\"> instance </span>2: 1.2.3.4:5671</span><br><span class=\"line\">   <span class=\"built_in\"> instance </span>3: 5.6.7.8:5670</span><br><span class=\"line\">   <span class=\"built_in\"> instance </span>4: 5.6.7.8:5671</span><br></pre></td></tr></table></figure></p>\n<p>当Prometheus进行scrape目标时，它会自动将job标签和instance标签附加到scrape到的时间序列中，用于识别被抓取的目标，如果这些标签中的任何一个已存在于已删除数据中，则行为取决于<code>honor_labels</code>配置选项。</p>\n<h3 id=\"表达式语言类型\"><a href=\"#表达式语言类型\" class=\"headerlink\" title=\"表达式语言类型\"></a>表达式语言类型</h3><p>Prometheus表达式或子表达式可以评估为一下四种类型之一：</p>\n<ul>\n<li>即时向量（Instant vector） - 包含每个时间序列单个样品的一组时间序列，共享相同的时间戳</li>\n<li>范围向量（Range vector） - 包含一个范围内数据点的一组时间序列</li>\n<li>标量（Scalar） - 一个简单的数字浮点值</li>\n<li>字符串（String） - 一个简单的字符串值；当前未使用</li>\n</ul>\n<h3 id=\"时间序列选择器\"><a href=\"#时间序列选择器\" class=\"headerlink\" title=\"时间序列选择器\"></a>时间序列选择器</h3><h4 id=\"即时向量选择\"><a href=\"#即时向量选择\" class=\"headerlink\" title=\"即时向量选择\"></a>即时向量选择</h4><p>即时向量选择器允许选择一组时间序列，或者某个给定的时间戳的样本数据。下面这个例子选择了具有http_requests_total的时间序列：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http_requests_total</span><br></pre></td></tr></table></figure></p>\n<p>你可以通过附加一组标签，并用{}括起来，来进一步筛选这些时间序列。下面这个例子只选择有http_requests_total名称的、有prometheus工作标签的、有canary组标签的时间序列：<br><figure class=\"highlight axapta\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http_requests_total&#123;job=<span class=\"string\">\"prometheus\"</span>,<span class=\"keyword\">group</span>=<span class=\"string\">\"canary\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>另外，也可以也可以将标签值反向匹配，或者对正则表达式匹配标签值。下面列举匹配操作符：</p>\n<ul>\n<li><code>=</code>：选择正好相等的字符串标签</li>\n<li><code>!=</code>：选择不相等的字符串标签</li>\n<li><code>=~</code>：选择匹配正则表达式的标签（或子标签）</li>\n<li><code>!~</code>：选择不匹配正则表达式的标签（或子标签）</li>\n</ul>\n<p>例如，选择staging、testing、development环境下的，GET之外的HTTP方法的http_requests_total的时间序列：</p>\n<figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http_requests_total&#123;environment=~<span class=\"string\">\"staging|testing|development\"</span>,method!=<span class=\"string\">\"<span class=\"keyword\">GET</span>\"</span>&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"范围向量选择\"><a href=\"#范围向量选择\" class=\"headerlink\" title=\"范围向量选择\"></a>范围向量选择</h4><p>范围向量表达式正如即时向量表达式一样运行，但是前者返回从当前时刻开始的一定时间范围的时间序列集合回来。语法是，在一个向量表达式之后添加[]来表示时间范围，持续时间用数字表示，后接下面单元之一：</p>\n<ul>\n<li><code>s</code>：seconds</li>\n<li><code>m</code>：minutes</li>\n<li><code>h</code>：hours</li>\n<li><code>d</code>：days</li>\n<li><code>w</code>：weeks</li>\n<li><code>y</code>：years</li>\n</ul>\n<p>在下面这个例子中，我们选择最后5分钟的记录，metric名称为http_requests_total、作业标签为prometheus的时间序列的所有值：<br><figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http_requests_total&#123;job=<span class=\"string\">\"prometheus\"</span>&#125;<span class=\"string\">[5m]</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"偏移量Offset\"><a href=\"#偏移量Offset\" class=\"headerlink\" title=\"偏移量Offset\"></a>偏移量Offset</h4><p>所述offset可以改变时间为查询中的个别时刻和范围矢量偏移。例如，以下表达式返回http_requests_total相对于当前查询评估时间的过去5分钟值 ：<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http_requests_total <span class=\"built_in\">offset</span> <span class=\"number\">5</span>m</span><br></pre></td></tr></table></figure></p>\n<p>同样适用于范围向量。这将返回http_requests_total一周前的5分钟费率 ：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"title\">rate</span><span class=\"params\">(http_requests_total[<span class=\"number\">5</span>m] offset <span class=\"number\">1</span>w)</span></span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"操作符\"><a href=\"#操作符\" class=\"headerlink\" title=\"操作符\"></a>操作符</h3><p>关于操作符的说明，请参考官网<a href=\"https://prometheus.io/docs/prometheus/latest/querying/operators/\" target=\"_blank\" rel=\"noopener\">操作符说明</a></p>\n<h3 id=\"函数\"><a href=\"#函数\" class=\"headerlink\" title=\"函数\"></a>函数</h3><p>关于函数的说明，请参考官网<a href=\"https://prometheus.io/docs/prometheus/latest/querying/functions/\" target=\"_blank\" rel=\"noopener\">函数解释</a></p>\n<h2 id=\"Prometheus的安装\"><a href=\"#Prometheus的安装\" class=\"headerlink\" title=\"Prometheus的安装\"></a>Prometheus的安装</h2><h3 id=\"下载prometheus二进制包\"><a href=\"#下载prometheus二进制包\" class=\"headerlink\" title=\"下载prometheus二进制包\"></a>下载prometheus二进制包</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ wget https://github.com/prometheus/prometheus/releases/download/v2.9.1/prometheus-2.9.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>\n<h3 id=\"解压prometheus压缩包\"><a href=\"#解压prometheus压缩包\" class=\"headerlink\" title=\"解压prometheus压缩包\"></a>解压prometheus压缩包</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tar zxvf prometheus-2.9.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>\n<h3 id=\"将prometheus放到-usr-local目录下\"><a href=\"#将prometheus放到-usr-local目录下\" class=\"headerlink\" title=\"将prometheus放到/usr/local目录下\"></a>将prometheus放到/usr/local目录下</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mv prometheus-2.9.1.linux-amd64 /usr/<span class=\"built_in\">local</span>/prometheus</span><br></pre></td></tr></table></figure>\n<h3 id=\"验证版本\"><a href=\"#验证版本\" class=\"headerlink\" title=\"验证版本\"></a>验证版本</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ /usr/<span class=\"built_in\">local</span>/prometheus/prometheus --version </span><br><span class=\"line\">  prometheus, version 2.9.1 (branch: HEAD, revision: ad71f2785fc321092948e33706b04f3150eee44f)</span><br><span class=\"line\">  build user:       root@09f919068df4</span><br><span class=\"line\">  build date:       20190416-17:50:04</span><br><span class=\"line\">  go version:       go1.12.4</span><br></pre></td></tr></table></figure>\n<h3 id=\"配置prometheus用户\"><a href=\"#配置prometheus用户\" class=\"headerlink\" title=\"配置prometheus用户\"></a>配置prometheus用户</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ groupadd prometheus</span><br><span class=\"line\">$ useradd -g prometheus -s /sbin/nologin prometheus</span><br></pre></td></tr></table></figure>\n<h3 id=\"创建prometheus数据目录\"><a href=\"#创建prometheus数据目录\" class=\"headerlink\" title=\"创建prometheus数据目录\"></a>创建prometheus数据目录</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir -p /var/lib/prometheus</span><br></pre></td></tr></table></figure>\n<h3 id=\"创建prometheus的systemctl文件\"><a href=\"#创建prometheus的systemctl文件\" class=\"headerlink\" title=\"创建prometheus的systemctl文件\"></a>创建prometheus的systemctl文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat &gt; /usr/lib/systemd/system/prometheus.service &lt;&lt; EOF</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Prometheus</span><br><span class=\"line\">Documentation=https://prometheus.io/</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">User=prometheus</span><br><span class=\"line\">ExecStart=/usr/<span class=\"built_in\">local</span>/prometheus/prometheus --config.file=/usr/<span class=\"built_in\">local</span>/prometheus/prometheus.yml --storage.tsdb.path=/var/lib/prometheus</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h3 id=\"prometheus权限配置\"><a href=\"#prometheus权限配置\" class=\"headerlink\" title=\"prometheus权限配置\"></a>prometheus权限配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># prometheus主程序</span></span><br><span class=\"line\">$ chown -R prometheus:prometheus /usr/<span class=\"built_in\">local</span>/prometheus/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># prometheus数据目录</span></span><br><span class=\"line\">$ chown -R prometheus:prometheus /var/lib/prometheus/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># prometheus启动文件</span></span><br><span class=\"line\">$ chown prometheus:prometheus /usr/lib/systemd/system/prometheus.service</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动服务并设为开机启动\"><a href=\"#启动服务并设为开机启动\" class=\"headerlink\" title=\"启动服务并设为开机启动\"></a>启动服务并设为开机启动</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ systemctl start prometheus</span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> prometheus</span><br></pre></td></tr></table></figure>\n<h2 id=\"Prometheus-yml配置说明\"><a href=\"#Prometheus-yml配置说明\" class=\"headerlink\" title=\"Prometheus.yml配置说明\"></a>Prometheus.yml配置说明</h2><p>Prometheus通过命令行参数和配置文件进行配置。虽然命令行参数配置了不可变的系统参数（例如存储位置，保留在磁盘和内存中的数据量等），但配置文件定义了与抓取job及其instance相关的所有内容，以及哪些规则文件的加载。<br>Prometheus可以在运行时重新加载其配置。如果新配置格式不正确，则不会应用更改。它有两种方式：</p>\n<ul>\n<li>通过向prometheus进程发送SIGHUP信号</li>\n<li>向Prometheus进程发送/-/reload的POST请求，<code>curl -X POST http://localdns:9090/-/reload</code></li>\n</ul>\n<h3 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h3><p>要指定要加载的配置文件，请使用该<code>--config.file</code>标志。该文件以<a href=\"https://en.wikipedia.org/wiki/YAML\" target=\"_blank\" rel=\"noopener\">YAML格式</a>编写，由下面描述的方案定义。括号表示参数是可选的。对于非列表参数，该值设置为指定的默认值。</p>\n<p><strong>以下为一个简单的prometheus.yml示例：</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Prometheus全局配置项</span></span><br><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_interval:</span>     <span class=\"number\">15</span><span class=\"string\">s</span> <span class=\"comment\"># 设定抓取数据的周期，默认为1min</span></span><br><span class=\"line\"><span class=\"attr\">  evaluation_interval:</span> <span class=\"number\">15</span><span class=\"string\">s</span> <span class=\"comment\"># 设定更新rules文件的周期，默认为1min</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_timeout:</span> <span class=\"number\">15</span><span class=\"string\">s</span> <span class=\"comment\"># 设定抓取数据的超时时间，默认为10s</span></span><br><span class=\"line\"><span class=\"attr\">  external_labels:</span> <span class=\"comment\"># 额外的属性，会添加到拉取得数据并存到数据库中</span></span><br><span class=\"line\"><span class=\"attr\">   monitor:</span> <span class=\"string\">'codelab_monitor'</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Alertmanager配置</span></span><br><span class=\"line\"><span class=\"attr\">alerting:</span></span><br><span class=\"line\"><span class=\"attr\"> alertmanagers:</span></span><br><span class=\"line\"><span class=\"attr\"> - static_configs:</span></span><br><span class=\"line\"><span class=\"attr\">   - targets:</span> <span class=\"string\">[\"localhost:9093\"]</span> <span class=\"comment\"># 设定alertmanager和prometheus交互的接口，即alertmanager监听的ip地址和端口</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># rule配置，首次读取默认加载，之后根据evaluation_interval设定的周期加载</span></span><br><span class=\"line\"><span class=\"attr\">rule_files:</span></span><br><span class=\"line\"><span class=\"bullet\"> -</span> <span class=\"string\">\"alertmanager_rules.yml\"</span></span><br><span class=\"line\"><span class=\"bullet\"> -</span> <span class=\"string\">\"prometheus_rules.yml\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># scrape配置</span></span><br><span class=\"line\"><span class=\"attr\">scrape_configs:</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">'prometheus'</span> <span class=\"comment\"># job_name默认写入timeseries的labels中，可以用于查询使用</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_interval:</span> <span class=\"number\">15</span><span class=\"string\">s</span> <span class=\"comment\"># 抓取周期，默认采用global配置</span></span><br><span class=\"line\"><span class=\"attr\">  static_configs:</span> <span class=\"comment\"># 静态配置</span></span><br><span class=\"line\"><span class=\"attr\">  - targets:</span> <span class=\"string\">['localdns:9090']</span> <span class=\"comment\"># prometheus所要抓取数据的地址，即instance实例项</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">'example-random'</span></span><br><span class=\"line\"><span class=\"attr\">  static_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - targets:</span> <span class=\"string\">['localhost:8080']</span></span><br></pre></td></tr></table></figure>\n<p>更多关于prometheus配置文件参数以及自动发现规则，请参考官方<a href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/\" target=\"_blank\" rel=\"noopener\">prometheus配置</a></p>\n"},{"layout":"post","title":"Ansible playbook详解","author":"Pyker","img":"/images/bar/playbook.jpg","top":false,"cover":false,"date":"2018-03-23T02:20:00.000Z","_content":"## Playbook简介\nPlaybooks与Ad-Hoc相比，是一种完全不同的运用Ansible的方式，而且是非常之强大的；也是系统ansible命令的集合，其利用[yaml语法](http://www.ansible.com.cn/docs/YAMLSyntax.html)编写，运行过程，ansbile-playbook命令根据`自上而下的顺序`依次执行任务。playbook 由一个或多个 ‘plays’ 组成.它的内容是一个以 ‘plays’为元素的列表，在 play 之中,一组机器被映射为定义好的角色.在 ansible 中,play 的内容,被称为 tasks,即任务.在基本层次的应用中,一个任务是一个对 ansible模块的调用。当第一个任务依次在所有主机上执行完毕后，开始执行第二个任务。如果某个主机执行时发生错误，则所有操作将会回滚。\n\n## Playbook基础组件\n* `hosts`：运行执行任务（task）的目标主机\n* `remote_user`：在远程主机上执行任务的用户\n* `tasks`：任务列表\n* `handlers`：任务，与tasks不同的是只有在接受到通知时才会被触发\n* `templates`：使用模板语言的文本文件，使用jinja2语法。\n* `variables`：变量，变量替换{{ variable_name }}\n* `tag`：标签，为某tasks指定标签，运行该标签可以即运行特定的tasks，定义为always的tag总会执行\n* `when`: 条件判断，当条件成立则执行tasks，不成立不执行表达式 判断表达式如：`not` `or` `and` `!=` `=`\n* `with_items`：循环迭代需要重复执行的任务列表，用`{item}}`引用列表值\n\n例如一个简单的playbook文件：\n```yaml\n ---\n    - hosts: test                                  # 指定运行任务的主机组\n      remote_user: root                            # 指定远程执行任务的用户\n      vars:                                        # 指定变量\n        - bsh: b.sh\n        - httprpm: httpd\n      task:                                        # 任务的开始\n        - name: install httpd                      # 一个安装httpd的任务\n          yum: name={{ httprpm }} state=present    # ansible的yum模块\n          tags: install_httpd                      # 为该任务打一个install_httpd的标签\n        - name: copy b.sh                          # 又一个复制b.sh脚本的任务\n          copy: src=/root/{{ bsh }} dest=/root/ owner=ala group=ala mode=0644\n          notify:                                  # 如果copy的文件内容发生改变就会触发\n            - reload httpd                         # 指定通知的哪个handlers\n          when: ansible_distribution == \"CentOS\"   # 通过变量判断系统为CentOS时才执行该copy任务\n        - name: copy b.sh                          \n          copy: src=/root/{{ bsh }} dest=/opt/ owner=ala group=ala mode=0644\n          notify:                                  \n            - reload httpd                         \n          when: ansible_distribution == \"Ubuntu\"   # 通过变量判断系统为Ubuntu时才执行该copy任务\n        - name: start httpd                        # 又一个启动httpd服务的任务\n          service: name=httpd state=started enabled=yes\n      handlers:                                    # 满足触发条件则执行的任务\n        - name: reload httpd                       # 满足触发条件的任务名\n          service: name=httpd state=reloaded       # 该任务为重新加载一下httpd服务\n```\n> 其中的`ansible_distribution`是ansible收集的facts变量。\n\n## playbook定义变量\n** ansible 常见定义变量有以下 6 种**\n* /etc/ansible/hosts文件主机中定义\n* /etc/ansible/hosts/文件主机组中定义\n* playbook的yaml文件中通过vars定义\n* 获取系统变量，也称facts变量\n* 分文件定义主机和主机组的变量\n* playbook 的role中定义\n\n\n```bash\n# /etc/ansible/hosts文件主机中定义 主机变量\n192.168.200.136 http_port=808 maxRequestsPerChild=808\n192.168.200.137 http_port=8080 maxRequestsPerChild=909\n \n# /etc/ansible/hosts文件主机中定义 主机组变量\n[websers]\n192.168.200.136\n192.168.200.137\n \n[websers:vars]  \nntp_server=ntp.exampl.com\nproxy=proxy.exampl.com                # ntp_server和proxy变量可为websers组中主机使用\n\n# playbook的yaml文件中通过vars定义\n ---\n    - hosts: test                                  \n      remote_user: root                            \n      vars:                           # 定义bsh和httprpm的两个变量\n        - bsh: b.sh\n        - httprpm: httpd\n\n# 获取系统facts变量\nansible 192.168.200.136 -m setup      # 可以获取主机所有的facts变量，通过{{variable_name}}引用\n\n# 分文件定义主机和主机组的变量\n/etc/ansible/group_vars/websers       # 定义主机组名为websers的变量文件\n/etc/ansible/host_vars/hostpc         # 定义主机名为hostpc的变量文件\n\n$ cat /etc/ansible/host_vars/hostpc   # 变量文件内容格式如下\n---\nntp_server: acme.example.org\ndatabase_server: storage.example.org\n\n# role中定义   （目录结构下文讲述）\n$ cat /etc/ansible/roles/nginx/vars/main.yml\n---\nnginx_port: 80\nnginx_domain: www.abc.com\nnginx_user: nginx\n```\n## playbook role目录结构\n### Roles简介\nAnsible为了层次化、结构化地组织Playbook，使用了角色（roles）。Roles能够根据层次型结构自动装载变量文件、task及handlers等。简单来讲，roles就是通过分别将变量、文件、任务、模块及处理器放置于单独的目录中，并可以便捷地include它们，roles一般用于基于主机构建服务的场景中，但也可以用于构建守护进程等场景中。\n\n### 创建Roles\n创建roles时一般需要以下步骤：首先创建以roles命名的目录。然后在roles目标下分别创建以这个角色名称命令的目录，如websevers等，然后在每个角色命令的目录中分别创建files、handlers、tasks、templates、meta、defaults和vars目录，用不到的目录可以创建为空目录。最后在Playbook文件中调用各角色进行使用。\n\n### roles内各目录含义解释\n* `files`：用来存放由copy模块或script模块调用的文件。\n* `templates`：用来存放jinjia2模板，template模块会自动在此目录中寻找jinjia2模板文件。\n* `tasks`：此目录应当包含一个main.yml文件，用于定义此角色的任务列表，此文件可以使用include包含其它的位于此目录的task文件。\n* `handlers`：此目录应当包含一个main.yml文件，用于定义此角色中触发条件时执行的动作。\n* `vars`：此目录应当包含一个main.yml文件，用于定义此角色用到的变量。\n* `defaults`：此目录应当包含一个main.yml文件，用于为当前角色设定默认变量。\n* `meta`：此目录应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系。\n\n如下定义了一个nginx服务的playbook目录结构树。\n```bash\n[root@k8s-master1 roles]# tree /etc/ansible/roles/nginx\n/etc/ansible/roles/nginx\n├── defaults\n│   └── main.yml\n├── files\n│   └── nginx.tar.gz\n├── handlers\n│   └── main.yml\n├── meta\n│   └── main.yml\n├── tasks\n│   └── main.yml\n├── templates\n│   └── nginx.conf.j2\n│   └── default.conf.j2\n└── vars\n    └── main.yml\n```\n\n## 使用roles安装nginx案例\n### 实例环境\n主机名 | IP | 系统 | 角色\n--- | --- | --- | ---\nansible | 192.168.20.210 | centos7.5 | ansible控制器\nweb-nginx | 192.168.20.213 | centos7.5 | web服务器 \n\n### hosts主机组清单\n```bash\n$ cat /etc/ansilbe/hosts          # ansible hosts主机组配置\n  [web-node]\n  192.168.20.213\n```\n### 生成ssh密钥\n```bash\n# 在ansible控制机上生成ssh密钥对\n \n$ ssh-keygen -t rsa\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/root/.ssh/id_rsa): \nEnter passphrase (empty for no passphrase): \nEnter same passphrase again: \nYour identification has been saved in /root/.ssh/id_rsa.\nYour public key has been saved in /root/.ssh/id_rsa.pub.\nThe key fingerprint is:\nSHA256:m4+23Eh+dJ8r/9zSjpUbHJECh1iFQU8Z0QMlygrRm98 root@k8s-node1\nThe key's randomart image is:\n+---[RSA 2048]----+\n|       .. +==OB. |\n|        .o.o*..o.|\n|       .  oo o o.|\n|        .o.   . .|\n|        S.. .  . |\n|         o...E. o|\n|        +. . . *.|\n|       +.=. . ++=|\n|       .*oo  o+*=|\n+----[SHA256]-----+\n\n# 复制ansible控制机上的公钥到nginx web服务器\n\n$ ssh-copy-id -i ~/.ssh/id_rsa.pub 192.168.20.213\n\n这里是root用户验证，输入完root密码后，就可以在ansible主机上无密码ssh登陆nginx web服务器了。\n```\n### 创建nginx的roles结构目录\n```bash\n$ mkdir -pv /etc/ansible/roles/nginx/{defaults,files,handlers,meta,tasks,templates,vars}\n```\n### 准备安装包和依赖包\n```bash\ncd /etc/ansible/roles/nginx/files\n$ wget http://nginx.org/download/nginx-1.16.0.tar.gz\n$ wget https://www.openssl.org/source/openssl-1.0.2r.tar.gz\n$ wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.42.tar.gz\n$ wget http://www.zlib.net/zlib-1.2.11.tar.gz\n```\n### 准备安装脚本\n>该脚本已在手动安装测试过，建议各位在通过ansible playbook安装服务器前，先手动安装一遍确保无误。\n\n```bash\n$ cat /etc/ansible/roles/nginx/files/install_nginx.sh\n#!/bin/sh\n#info: source code install nginx 1.16.0\n#author: pyker <pyker@qq.com>\nexport PATH=`echo $PATH`\nPWD=\"/opt\"\nNGINX=nginx-1.16.0\nOPENSSL=openssl-1.0.2r\nPCRE=pcre-8.42\nZLIB=zlib-1.2.11\nRUN_USER=nginx\nid -u ${RUN_USER} >/dev/null 2>&1\n[ $? -ne 0 ] && useradd -M -s /sbin/nologin ${RUN_USER}\nmkdir -p /var/log/nginx\nyum install -y epel-release \nyum install -y jemalloc jemalloc-devel\nyum install -y gcc \\\n             gcc-c++ \\\n             gcc++ \\\n             perl \\\n             perl-devel \\\n             perl-ExtUtils-Embed \\\n             libxslt \\\n             libxslt-devel \\\n             libxml2 \\\n             libxml2-devel \\\n             gd \\\n             gd-devel \\\n             GeoIP \\\n             GeoIP-devel\ncd $PWD\nfor tar in `ls *.tar.gz`; do\n  tar zxf $tar\ndone\n\ncd $PWD/$NGINX && ./configure --prefix=/usr/local/nginx \\\n            --sbin-path=/usr/sbin/nginx \\\n            --user=nginx \\\n            --group=nginx \\\n            --pid-path=/var/run/nginx.pid \\\n            --lock-path=/var/run/nginx.lock \\\n            --error-log-path=/var/log/nginx/error.log \\\n            --http-log-path=/var/log/nginx/access.log \\\n            --with-select_module \\\n            --with-poll_module \\\n            --with-threads \\\n            --with-file-aio \\\n            --with-http_ssl_module \\\n            --with-http_v2_module \\\n            --with-http_realip_module \\\n            --with-http_addition_module \\\n            --with-http_xslt_module=dynamic \\\n            --with-http_image_filter_module=dynamic \\\n            --with-http_geoip_module=dynamic \\\n            --with-http_sub_module \\\n            --with-http_dav_module \\\n            --with-http_flv_module \\\n            --with-http_mp4_module \\\n            --with-http_gunzip_module \\\n            --with-http_gzip_static_module \\\n            --with-http_auth_request_module \\\n            --with-http_random_index_module \\\n            --with-http_secure_link_module \\\n            --with-http_degradation_module \\\n            --with-http_slice_module \\\n            --with-http_stub_status_module \\\n            --with-mail=dynamic \\\n            --with-mail_ssl_module \\\n            --with-stream \\\n            --with-stream_ssl_module \\\n            --with-stream_realip_module \\\n            --with-stream_geoip_module=dynamic \\\n            --with-stream_ssl_preread_module \\\n            --with-compat \\\n            --with-ld-opt=\"-ljemalloc\" \\\n            --with-pcre=../${PCRE} \\\n            --with-pcre-jit \\\n            --with-zlib=../${ZLIB} \\\n            --with-openssl=../${OPENSSL}\\\n            --with-openssl-opt=no-nextprotoneg \\\n            --with-debug && make -j 4 && make install\n```\n ### 配置变量\n 在安装nginx的时候或者其他服务的时候常常用到变量，下面配置变量是通过roles方式配置。\n ```bash\n$ cat /etc/ansible/roles/nginx/vas/main.yml\ncat nginx/vars/main.yml \nnginx_user: nginx\nnginx_port: 80\nnginx_dir: /usr/local/nginx\n ```\n ### 准备nginx.conf模版\n ```bash\n$ cat /etc/ansible/roles/nginx/templates/nginx.conf.j2\nuser {{ nginx_user }};\nworker_processes {{ ansible_processor_vcpus }};\n\nerror_log /var/log/nginx/error_nginx.log crit;\npid /var/run/nginx.pid;\nworker_rlimit_nofile 51200;\n\nevents {\n  use epoll;\n  worker_connections 51200;\n  multi_accept on;\n}\n\nhttp {\n  map $http_upgrade $connection_upgrade {\n    default upgrade;\n    ''      close;\n  }\n  include mime.types;\n  default_type application/octet-stream;\n  server_names_hash_bucket_size 128;\n  client_header_buffer_size 32k;\n  large_client_header_buffers 4 32k;\n  client_max_body_size 1024m;\n  client_body_buffer_size 10m;\n  sendfile on;\n  tcp_nopush on;\n  keepalive_timeout 120;\n  server_tokens off;\n  tcp_nodelay on;\n\n  #Gzip Compression\n  gzip on;\n  gzip_buffers 16 8k;\n  gzip_comp_level 6;\n  gzip_http_version 1.1;\n  gzip_min_length 256;\n  gzip_proxied any;\n  gzip_vary on;\n  gzip_types\n    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml\n    text/javascript application/javascript application/x-javascript\n    text/x-json application/json application/x-web-app-manifest+json\n    text/css text/plain text/x-component\n    font/opentype application/x-font-ttf application/vnd.ms-fontobject\n    image/x-icon;\n  gzip_disable \"MSIE [1-6]\\.(?!.*SV1)\";\n\n  #If you have a lot of static files to serve through Nginx then caching of the files' metadata (not the actual files' contents) can save some latency.\n  open_file_cache max=1000 inactive=20s;\n  open_file_cache_valid 30s;\n  open_file_cache_min_uses 2;\n  open_file_cache_errors on;\n\n########################## vhost #############################\n  include upstream/*.conf;\n  include vhost/*.conf;\n}\n ```\n >nginx.conf.j2文件中`nginx_user`和`ansible_processor_vcpus`分别为用户自定义变量和`-m setup`获取的facts。\n\n ### 定义默认server模版\n ```bash\n ```bash\n$ cat /etc/ansible/roles/nginx/templates/default.conf.j2\nserver {\n        listen {{ nginx_port }};\n        server_name {{ ansible_all_ipv4_addresses }};\n        index index.html index.htm index.jsp index.do;\n        access_log  off;\n\n        location / {\n            root /data/wwwroot;\n        }\n\n         location /nginx_status {\n            stub_status on;\n            access_log   off;\n  }\n}\n ```\n >default.conf.j2文件中`nginx_port`和`ansible_all_ipv4_addresses`分别为用户自定义变量和`-m setup`获取的facts。\n\n### 定义一个测试index.html文件\n```bash\n$ cat /etc/ansible/roles/nginx/templates/index.html\n this is test pages!\n```\n### 定义nginx启动脚本\n```bash\n$ cat /etc/ansible/roles/nginx/files/nginx.service\n[Unit]\nDescription=The NGINX HTTP and reverse proxy server\nAfter=syslog.target network.target remote-fs.target nss-lookup.target\n\n[Service]\nType=forking\nPIDFile=/var/run/nginx.pid\nExecStartPre=/usr/sbin/nginx -t\nExecStart=/usr/sbin/nginx\nExecReload=/usr/sbin/nginx -s reload\nExecStop=/usr/bin/kill -s QUIT $MAINPID\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\n```\n### 定义tasks任务\n```yaml\n# 在tasks目录中定义了一个copy.yaml文件用户复制files目录下的文件到nginx服务器\n# 定义完成后，需要在tasks/main.yaml文件中用-include包含该copy.yaml\n\n$ cat /etc/ansible/roles/nginx/tasks/copy.yaml\n- name: copy nginx-1.16.0.tar.gz to client\n  copy: src=/etc/ansible/roles/nginx/files/nginx-1.16.0.tar.gz dest=/opt/nginx-1.16.0.tar.gz\n- name: copy install_nginx.sh to client\n  copy: src=/etc/ansible/roles/nginx/files/install_nginx.sh dest=/opt/install_nginx.sh\n- name: mkdir nginx data directory\n  file: path=/data/wwwroot state=directory recurse=yes\n- name: copy index.html\n  copy: src=/etc/ansible/roles/nginx/files/index.html dest=/data/wwwroot/index.html\n- name: copy nginx systemctl file\n  copy: src=/etc/ansible/roles/nginx/files/nginx.service dest=/usr/lib/systemd/system/nginx.service\n- name: copy dependency package\n  copy: src=/etc/ansible/roles/nginx/files/{{ item }} dest=/opt/{{ item }}\n  with_items:\n    - openssl-1.0.2r.tar.gz\n    - pcre-8.42.tar.gz\n    - zlib-1.2.11.tar.gz\n```\n```yaml\n# 定义main.yaml文件\n\n$ cat /etc/ansible/roles/nginx/tasks/main.yml \n---\n- include: copy.yml       # 使用include将上面copy.yaml文件包含进来\n- name: install nginx\n  shell: /usr/bin/sh /opt/install_nginx.sh\n- name: replace nginx.conf file\n  template: src=/etc/ansible/roles/nginx/templates/nginx.conf.j2 dest={{ nginx_dir }}/conf/nginx.conf\n- name: mkdir nginx vhost directory\n  file: path={{nginx_dir}}/conf/vhost state=directory\n- name: relpace default.conf file\n  template: src=/etc/ansible/roles/nginx/templates/default.conf.j2 dest={{nginx_dir}}/conf/vhost/default.conf\n  tags: ngxdef            # 定义一个tag，当default.conf发生改变时可以指定运行该任务\n  notify:\n    - reload nginx        # 该名称需要和handler中定义的一样\n- name: start nginx\n  command: /usr/sbin/nginx # 由于配置了nginx启动服务，也可以使用 shell: systemctl start nginx\n```\n### 定义触发通知handlers\n```yaml\n$ cat /etc/ansible/roles/nginx/handlers/main.yml \n---\n- name: reload nginx\n  shell: /usr/sbin/nginx -t; /usr/sbin/nginx -s reload  # 也可以使用 shell: systemctl reload nginx\n```\n### 定义role入口文件\n```bash\n$ cat /etc/ansible/roles/nginx.yml \n---\n- hosts: web-node      # 定义要执行该playbook的主机组\n  remote_user: root    # 定义远程执行命令的用户\n  roles:               # \n    - nginx            # 主机组中的主机使用哪个playbook剧本\n```\n### 查看当前nginx roles目录树结构\n```bash\n$ tree /etc/ansible/roles/\n/etc/ansible/roles/\n├── nginx\n│   ├── defaults\n│   ├── files\n│   │   ├── index.html\n│   │   ├── nginx.service\n│   │   ├── install_nginx.sh\n│   │   ├── nginx-1.16.0.tar.gz\n│   │   ├── openssl-1.0.2r.tar.gz\n│   │   ├── pcre-8.42.tar.gz\n│   │   └── zlib-1.2.11.tar.gz\n│   ├── handlers\n│   │   └── main.yml\n│   ├── meta\n│   ├── tasks\n│   │   ├── copy.yml\n│   │   └── main.yml\n│   ├── templates\n│   │   ├── default.conf.j2\n│   │   └── nginx.conf.j2\n│   └── vars\n│       └── main.yml\n└── nginx.yml\n```\n### playbook语法检测\n通过上面的配置，我们已经完成了使用playbook方式安装nginx所需要的步骤，现在我们应该在执行该playbook前检查一下上述语法有没有错误。\n```bash\n$ ansible-playbook --syntax-check /etc/ansible/roles/nginx.yml \n\nplaybook: /etc/ansible/roles/nginx.yml  # 如果语法没问题，将直接显示文件名称，如果有错误将告知你那里错了\n```\n\n### 测试安装\n`ansible-playbook -C` 命令可以测试运行playbook剧本，而非真正在远端服务器上执行，这样可以方便查看playbook在执行过程中将会做哪些事情。\n```bash\n$ ansible-playbook -C nginx.yml \n\nPLAY [web-node] ************************************************************************************************************************************************\n\nTASK [nginx : copy nginx-1.16.0.tar.gz to client] **************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : copy install_nginx.sh to client] *****************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : mkdir nginx data directory] **********************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : copy index.html] *********************************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : copy nginx systemctl file] ***********************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : copy dependency package] *************************************************************************************************************************\nchanged: [192.168.20.213] => (item=openssl-1.0.2r.tar.gz)\nchanged: [192.168.20.213] => (item=pcre-8.42.tar.gz)\nchanged: [192.168.20.213] => (item=zlib-1.2.11.tar.gz)\n\nTASK [nginx : install nginx] ***********************************************************************************************************************************\nskipping: [192.168.20.213]\n\nTASK [nginx : replace nginx.conf file] *************************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : mkdir nginx vhost directory] *********************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : relpace default.conf file] ***********************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : start nginx] *************************************************************************************************************************************\nskipping: [192.168.20.213]\n\nRUNNING HANDLER [nginx : reload nginx] *************************************************************************************************************************\nskipping: [192.168.20.213]\n\nPLAY RECAP *****************************************************************************************************************************************************\n192.168.20.213             : ok=8    changed=8    unreachable=0    failed=0\n```\n### 运行nginx playbook\n```bash\n$ ansible-playbook nginx.yml\n```\n>执行`ansible-playbook nginx.yml`命令后，ansible将会按照刚刚测试安装的步骤在远端进行安装nginx服务并且启动。\n\n### 验证安装结果\n等待一会nginx playbook将会在远端服务器上安装完毕，现在我们来验证一下结果：\n```bash\n# 在web服务器上查看nginx端口\n$ netstat -ptln | grep 80\ntcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      14461/nginx: master\n\n# 查看nginx进程\n$ ps -ef | grep nginx\nroot      14461      1  0 00:39 ?        00:00:00 nginx: master process /usr/sbin/nginx\nnginx     14474  14461  0 00:39 ?        00:00:00 nginx: worker process\nnginx     14475  14461  0 00:39 ?        00:00:00 nginx: worker process\nnginx     14476  14461  0 00:39 ?        00:00:00 nginx: worker process\nnginx     14477  14461  0 00:39 ?        00:00:00 nginx: worker process\nroot      39501   1664  0 11:38 pts/0    00:00:00 grep --color=auto nginx\n\n# 让我们在内网任意一台电脑上来访问一下该nginx页面\n$ curl http://192.168.20.213\nthis is a test pages!       # 结果是我们前面定义的index.html内容\n\n# 访问一下nginx_status的uri\n$ curl http://192.168.20.213/nginx_status     #前面default.conf.j2文件中定义的nginx location\nActive connections: 1 \nserver accepts handled requests\n 8 8 10 \nReading: 0 Writing: 1 Waiting: 0\n```\n至此，一个使用ansible-playbook安装nginx服务已完成。","source":"_posts/ansible-playbook.md","raw":"layout: post\ntitle: Ansible playbook详解\nauthor: Pyker\ncategories: CI/CD\nimg: /images/bar/playbook.jpg\ntags:\n  - ansible\ntop: false\ncover: false\ndate: 2018-03-23 10:20:00\n---\n## Playbook简介\nPlaybooks与Ad-Hoc相比，是一种完全不同的运用Ansible的方式，而且是非常之强大的；也是系统ansible命令的集合，其利用[yaml语法](http://www.ansible.com.cn/docs/YAMLSyntax.html)编写，运行过程，ansbile-playbook命令根据`自上而下的顺序`依次执行任务。playbook 由一个或多个 ‘plays’ 组成.它的内容是一个以 ‘plays’为元素的列表，在 play 之中,一组机器被映射为定义好的角色.在 ansible 中,play 的内容,被称为 tasks,即任务.在基本层次的应用中,一个任务是一个对 ansible模块的调用。当第一个任务依次在所有主机上执行完毕后，开始执行第二个任务。如果某个主机执行时发生错误，则所有操作将会回滚。\n\n## Playbook基础组件\n* `hosts`：运行执行任务（task）的目标主机\n* `remote_user`：在远程主机上执行任务的用户\n* `tasks`：任务列表\n* `handlers`：任务，与tasks不同的是只有在接受到通知时才会被触发\n* `templates`：使用模板语言的文本文件，使用jinja2语法。\n* `variables`：变量，变量替换{{ variable_name }}\n* `tag`：标签，为某tasks指定标签，运行该标签可以即运行特定的tasks，定义为always的tag总会执行\n* `when`: 条件判断，当条件成立则执行tasks，不成立不执行表达式 判断表达式如：`not` `or` `and` `!=` `=`\n* `with_items`：循环迭代需要重复执行的任务列表，用`{item}}`引用列表值\n\n例如一个简单的playbook文件：\n```yaml\n ---\n    - hosts: test                                  # 指定运行任务的主机组\n      remote_user: root                            # 指定远程执行任务的用户\n      vars:                                        # 指定变量\n        - bsh: b.sh\n        - httprpm: httpd\n      task:                                        # 任务的开始\n        - name: install httpd                      # 一个安装httpd的任务\n          yum: name={{ httprpm }} state=present    # ansible的yum模块\n          tags: install_httpd                      # 为该任务打一个install_httpd的标签\n        - name: copy b.sh                          # 又一个复制b.sh脚本的任务\n          copy: src=/root/{{ bsh }} dest=/root/ owner=ala group=ala mode=0644\n          notify:                                  # 如果copy的文件内容发生改变就会触发\n            - reload httpd                         # 指定通知的哪个handlers\n          when: ansible_distribution == \"CentOS\"   # 通过变量判断系统为CentOS时才执行该copy任务\n        - name: copy b.sh                          \n          copy: src=/root/{{ bsh }} dest=/opt/ owner=ala group=ala mode=0644\n          notify:                                  \n            - reload httpd                         \n          when: ansible_distribution == \"Ubuntu\"   # 通过变量判断系统为Ubuntu时才执行该copy任务\n        - name: start httpd                        # 又一个启动httpd服务的任务\n          service: name=httpd state=started enabled=yes\n      handlers:                                    # 满足触发条件则执行的任务\n        - name: reload httpd                       # 满足触发条件的任务名\n          service: name=httpd state=reloaded       # 该任务为重新加载一下httpd服务\n```\n> 其中的`ansible_distribution`是ansible收集的facts变量。\n\n## playbook定义变量\n** ansible 常见定义变量有以下 6 种**\n* /etc/ansible/hosts文件主机中定义\n* /etc/ansible/hosts/文件主机组中定义\n* playbook的yaml文件中通过vars定义\n* 获取系统变量，也称facts变量\n* 分文件定义主机和主机组的变量\n* playbook 的role中定义\n\n\n```bash\n# /etc/ansible/hosts文件主机中定义 主机变量\n192.168.200.136 http_port=808 maxRequestsPerChild=808\n192.168.200.137 http_port=8080 maxRequestsPerChild=909\n \n# /etc/ansible/hosts文件主机中定义 主机组变量\n[websers]\n192.168.200.136\n192.168.200.137\n \n[websers:vars]  \nntp_server=ntp.exampl.com\nproxy=proxy.exampl.com                # ntp_server和proxy变量可为websers组中主机使用\n\n# playbook的yaml文件中通过vars定义\n ---\n    - hosts: test                                  \n      remote_user: root                            \n      vars:                           # 定义bsh和httprpm的两个变量\n        - bsh: b.sh\n        - httprpm: httpd\n\n# 获取系统facts变量\nansible 192.168.200.136 -m setup      # 可以获取主机所有的facts变量，通过{{variable_name}}引用\n\n# 分文件定义主机和主机组的变量\n/etc/ansible/group_vars/websers       # 定义主机组名为websers的变量文件\n/etc/ansible/host_vars/hostpc         # 定义主机名为hostpc的变量文件\n\n$ cat /etc/ansible/host_vars/hostpc   # 变量文件内容格式如下\n---\nntp_server: acme.example.org\ndatabase_server: storage.example.org\n\n# role中定义   （目录结构下文讲述）\n$ cat /etc/ansible/roles/nginx/vars/main.yml\n---\nnginx_port: 80\nnginx_domain: www.abc.com\nnginx_user: nginx\n```\n## playbook role目录结构\n### Roles简介\nAnsible为了层次化、结构化地组织Playbook，使用了角色（roles）。Roles能够根据层次型结构自动装载变量文件、task及handlers等。简单来讲，roles就是通过分别将变量、文件、任务、模块及处理器放置于单独的目录中，并可以便捷地include它们，roles一般用于基于主机构建服务的场景中，但也可以用于构建守护进程等场景中。\n\n### 创建Roles\n创建roles时一般需要以下步骤：首先创建以roles命名的目录。然后在roles目标下分别创建以这个角色名称命令的目录，如websevers等，然后在每个角色命令的目录中分别创建files、handlers、tasks、templates、meta、defaults和vars目录，用不到的目录可以创建为空目录。最后在Playbook文件中调用各角色进行使用。\n\n### roles内各目录含义解释\n* `files`：用来存放由copy模块或script模块调用的文件。\n* `templates`：用来存放jinjia2模板，template模块会自动在此目录中寻找jinjia2模板文件。\n* `tasks`：此目录应当包含一个main.yml文件，用于定义此角色的任务列表，此文件可以使用include包含其它的位于此目录的task文件。\n* `handlers`：此目录应当包含一个main.yml文件，用于定义此角色中触发条件时执行的动作。\n* `vars`：此目录应当包含一个main.yml文件，用于定义此角色用到的变量。\n* `defaults`：此目录应当包含一个main.yml文件，用于为当前角色设定默认变量。\n* `meta`：此目录应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系。\n\n如下定义了一个nginx服务的playbook目录结构树。\n```bash\n[root@k8s-master1 roles]# tree /etc/ansible/roles/nginx\n/etc/ansible/roles/nginx\n├── defaults\n│   └── main.yml\n├── files\n│   └── nginx.tar.gz\n├── handlers\n│   └── main.yml\n├── meta\n│   └── main.yml\n├── tasks\n│   └── main.yml\n├── templates\n│   └── nginx.conf.j2\n│   └── default.conf.j2\n└── vars\n    └── main.yml\n```\n\n## 使用roles安装nginx案例\n### 实例环境\n主机名 | IP | 系统 | 角色\n--- | --- | --- | ---\nansible | 192.168.20.210 | centos7.5 | ansible控制器\nweb-nginx | 192.168.20.213 | centos7.5 | web服务器 \n\n### hosts主机组清单\n```bash\n$ cat /etc/ansilbe/hosts          # ansible hosts主机组配置\n  [web-node]\n  192.168.20.213\n```\n### 生成ssh密钥\n```bash\n# 在ansible控制机上生成ssh密钥对\n \n$ ssh-keygen -t rsa\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/root/.ssh/id_rsa): \nEnter passphrase (empty for no passphrase): \nEnter same passphrase again: \nYour identification has been saved in /root/.ssh/id_rsa.\nYour public key has been saved in /root/.ssh/id_rsa.pub.\nThe key fingerprint is:\nSHA256:m4+23Eh+dJ8r/9zSjpUbHJECh1iFQU8Z0QMlygrRm98 root@k8s-node1\nThe key's randomart image is:\n+---[RSA 2048]----+\n|       .. +==OB. |\n|        .o.o*..o.|\n|       .  oo o o.|\n|        .o.   . .|\n|        S.. .  . |\n|         o...E. o|\n|        +. . . *.|\n|       +.=. . ++=|\n|       .*oo  o+*=|\n+----[SHA256]-----+\n\n# 复制ansible控制机上的公钥到nginx web服务器\n\n$ ssh-copy-id -i ~/.ssh/id_rsa.pub 192.168.20.213\n\n这里是root用户验证，输入完root密码后，就可以在ansible主机上无密码ssh登陆nginx web服务器了。\n```\n### 创建nginx的roles结构目录\n```bash\n$ mkdir -pv /etc/ansible/roles/nginx/{defaults,files,handlers,meta,tasks,templates,vars}\n```\n### 准备安装包和依赖包\n```bash\ncd /etc/ansible/roles/nginx/files\n$ wget http://nginx.org/download/nginx-1.16.0.tar.gz\n$ wget https://www.openssl.org/source/openssl-1.0.2r.tar.gz\n$ wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.42.tar.gz\n$ wget http://www.zlib.net/zlib-1.2.11.tar.gz\n```\n### 准备安装脚本\n>该脚本已在手动安装测试过，建议各位在通过ansible playbook安装服务器前，先手动安装一遍确保无误。\n\n```bash\n$ cat /etc/ansible/roles/nginx/files/install_nginx.sh\n#!/bin/sh\n#info: source code install nginx 1.16.0\n#author: pyker <pyker@qq.com>\nexport PATH=`echo $PATH`\nPWD=\"/opt\"\nNGINX=nginx-1.16.0\nOPENSSL=openssl-1.0.2r\nPCRE=pcre-8.42\nZLIB=zlib-1.2.11\nRUN_USER=nginx\nid -u ${RUN_USER} >/dev/null 2>&1\n[ $? -ne 0 ] && useradd -M -s /sbin/nologin ${RUN_USER}\nmkdir -p /var/log/nginx\nyum install -y epel-release \nyum install -y jemalloc jemalloc-devel\nyum install -y gcc \\\n             gcc-c++ \\\n             gcc++ \\\n             perl \\\n             perl-devel \\\n             perl-ExtUtils-Embed \\\n             libxslt \\\n             libxslt-devel \\\n             libxml2 \\\n             libxml2-devel \\\n             gd \\\n             gd-devel \\\n             GeoIP \\\n             GeoIP-devel\ncd $PWD\nfor tar in `ls *.tar.gz`; do\n  tar zxf $tar\ndone\n\ncd $PWD/$NGINX && ./configure --prefix=/usr/local/nginx \\\n            --sbin-path=/usr/sbin/nginx \\\n            --user=nginx \\\n            --group=nginx \\\n            --pid-path=/var/run/nginx.pid \\\n            --lock-path=/var/run/nginx.lock \\\n            --error-log-path=/var/log/nginx/error.log \\\n            --http-log-path=/var/log/nginx/access.log \\\n            --with-select_module \\\n            --with-poll_module \\\n            --with-threads \\\n            --with-file-aio \\\n            --with-http_ssl_module \\\n            --with-http_v2_module \\\n            --with-http_realip_module \\\n            --with-http_addition_module \\\n            --with-http_xslt_module=dynamic \\\n            --with-http_image_filter_module=dynamic \\\n            --with-http_geoip_module=dynamic \\\n            --with-http_sub_module \\\n            --with-http_dav_module \\\n            --with-http_flv_module \\\n            --with-http_mp4_module \\\n            --with-http_gunzip_module \\\n            --with-http_gzip_static_module \\\n            --with-http_auth_request_module \\\n            --with-http_random_index_module \\\n            --with-http_secure_link_module \\\n            --with-http_degradation_module \\\n            --with-http_slice_module \\\n            --with-http_stub_status_module \\\n            --with-mail=dynamic \\\n            --with-mail_ssl_module \\\n            --with-stream \\\n            --with-stream_ssl_module \\\n            --with-stream_realip_module \\\n            --with-stream_geoip_module=dynamic \\\n            --with-stream_ssl_preread_module \\\n            --with-compat \\\n            --with-ld-opt=\"-ljemalloc\" \\\n            --with-pcre=../${PCRE} \\\n            --with-pcre-jit \\\n            --with-zlib=../${ZLIB} \\\n            --with-openssl=../${OPENSSL}\\\n            --with-openssl-opt=no-nextprotoneg \\\n            --with-debug && make -j 4 && make install\n```\n ### 配置变量\n 在安装nginx的时候或者其他服务的时候常常用到变量，下面配置变量是通过roles方式配置。\n ```bash\n$ cat /etc/ansible/roles/nginx/vas/main.yml\ncat nginx/vars/main.yml \nnginx_user: nginx\nnginx_port: 80\nnginx_dir: /usr/local/nginx\n ```\n ### 准备nginx.conf模版\n ```bash\n$ cat /etc/ansible/roles/nginx/templates/nginx.conf.j2\nuser {{ nginx_user }};\nworker_processes {{ ansible_processor_vcpus }};\n\nerror_log /var/log/nginx/error_nginx.log crit;\npid /var/run/nginx.pid;\nworker_rlimit_nofile 51200;\n\nevents {\n  use epoll;\n  worker_connections 51200;\n  multi_accept on;\n}\n\nhttp {\n  map $http_upgrade $connection_upgrade {\n    default upgrade;\n    ''      close;\n  }\n  include mime.types;\n  default_type application/octet-stream;\n  server_names_hash_bucket_size 128;\n  client_header_buffer_size 32k;\n  large_client_header_buffers 4 32k;\n  client_max_body_size 1024m;\n  client_body_buffer_size 10m;\n  sendfile on;\n  tcp_nopush on;\n  keepalive_timeout 120;\n  server_tokens off;\n  tcp_nodelay on;\n\n  #Gzip Compression\n  gzip on;\n  gzip_buffers 16 8k;\n  gzip_comp_level 6;\n  gzip_http_version 1.1;\n  gzip_min_length 256;\n  gzip_proxied any;\n  gzip_vary on;\n  gzip_types\n    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml\n    text/javascript application/javascript application/x-javascript\n    text/x-json application/json application/x-web-app-manifest+json\n    text/css text/plain text/x-component\n    font/opentype application/x-font-ttf application/vnd.ms-fontobject\n    image/x-icon;\n  gzip_disable \"MSIE [1-6]\\.(?!.*SV1)\";\n\n  #If you have a lot of static files to serve through Nginx then caching of the files' metadata (not the actual files' contents) can save some latency.\n  open_file_cache max=1000 inactive=20s;\n  open_file_cache_valid 30s;\n  open_file_cache_min_uses 2;\n  open_file_cache_errors on;\n\n########################## vhost #############################\n  include upstream/*.conf;\n  include vhost/*.conf;\n}\n ```\n >nginx.conf.j2文件中`nginx_user`和`ansible_processor_vcpus`分别为用户自定义变量和`-m setup`获取的facts。\n\n ### 定义默认server模版\n ```bash\n ```bash\n$ cat /etc/ansible/roles/nginx/templates/default.conf.j2\nserver {\n        listen {{ nginx_port }};\n        server_name {{ ansible_all_ipv4_addresses }};\n        index index.html index.htm index.jsp index.do;\n        access_log  off;\n\n        location / {\n            root /data/wwwroot;\n        }\n\n         location /nginx_status {\n            stub_status on;\n            access_log   off;\n  }\n}\n ```\n >default.conf.j2文件中`nginx_port`和`ansible_all_ipv4_addresses`分别为用户自定义变量和`-m setup`获取的facts。\n\n### 定义一个测试index.html文件\n```bash\n$ cat /etc/ansible/roles/nginx/templates/index.html\n this is test pages!\n```\n### 定义nginx启动脚本\n```bash\n$ cat /etc/ansible/roles/nginx/files/nginx.service\n[Unit]\nDescription=The NGINX HTTP and reverse proxy server\nAfter=syslog.target network.target remote-fs.target nss-lookup.target\n\n[Service]\nType=forking\nPIDFile=/var/run/nginx.pid\nExecStartPre=/usr/sbin/nginx -t\nExecStart=/usr/sbin/nginx\nExecReload=/usr/sbin/nginx -s reload\nExecStop=/usr/bin/kill -s QUIT $MAINPID\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\n```\n### 定义tasks任务\n```yaml\n# 在tasks目录中定义了一个copy.yaml文件用户复制files目录下的文件到nginx服务器\n# 定义完成后，需要在tasks/main.yaml文件中用-include包含该copy.yaml\n\n$ cat /etc/ansible/roles/nginx/tasks/copy.yaml\n- name: copy nginx-1.16.0.tar.gz to client\n  copy: src=/etc/ansible/roles/nginx/files/nginx-1.16.0.tar.gz dest=/opt/nginx-1.16.0.tar.gz\n- name: copy install_nginx.sh to client\n  copy: src=/etc/ansible/roles/nginx/files/install_nginx.sh dest=/opt/install_nginx.sh\n- name: mkdir nginx data directory\n  file: path=/data/wwwroot state=directory recurse=yes\n- name: copy index.html\n  copy: src=/etc/ansible/roles/nginx/files/index.html dest=/data/wwwroot/index.html\n- name: copy nginx systemctl file\n  copy: src=/etc/ansible/roles/nginx/files/nginx.service dest=/usr/lib/systemd/system/nginx.service\n- name: copy dependency package\n  copy: src=/etc/ansible/roles/nginx/files/{{ item }} dest=/opt/{{ item }}\n  with_items:\n    - openssl-1.0.2r.tar.gz\n    - pcre-8.42.tar.gz\n    - zlib-1.2.11.tar.gz\n```\n```yaml\n# 定义main.yaml文件\n\n$ cat /etc/ansible/roles/nginx/tasks/main.yml \n---\n- include: copy.yml       # 使用include将上面copy.yaml文件包含进来\n- name: install nginx\n  shell: /usr/bin/sh /opt/install_nginx.sh\n- name: replace nginx.conf file\n  template: src=/etc/ansible/roles/nginx/templates/nginx.conf.j2 dest={{ nginx_dir }}/conf/nginx.conf\n- name: mkdir nginx vhost directory\n  file: path={{nginx_dir}}/conf/vhost state=directory\n- name: relpace default.conf file\n  template: src=/etc/ansible/roles/nginx/templates/default.conf.j2 dest={{nginx_dir}}/conf/vhost/default.conf\n  tags: ngxdef            # 定义一个tag，当default.conf发生改变时可以指定运行该任务\n  notify:\n    - reload nginx        # 该名称需要和handler中定义的一样\n- name: start nginx\n  command: /usr/sbin/nginx # 由于配置了nginx启动服务，也可以使用 shell: systemctl start nginx\n```\n### 定义触发通知handlers\n```yaml\n$ cat /etc/ansible/roles/nginx/handlers/main.yml \n---\n- name: reload nginx\n  shell: /usr/sbin/nginx -t; /usr/sbin/nginx -s reload  # 也可以使用 shell: systemctl reload nginx\n```\n### 定义role入口文件\n```bash\n$ cat /etc/ansible/roles/nginx.yml \n---\n- hosts: web-node      # 定义要执行该playbook的主机组\n  remote_user: root    # 定义远程执行命令的用户\n  roles:               # \n    - nginx            # 主机组中的主机使用哪个playbook剧本\n```\n### 查看当前nginx roles目录树结构\n```bash\n$ tree /etc/ansible/roles/\n/etc/ansible/roles/\n├── nginx\n│   ├── defaults\n│   ├── files\n│   │   ├── index.html\n│   │   ├── nginx.service\n│   │   ├── install_nginx.sh\n│   │   ├── nginx-1.16.0.tar.gz\n│   │   ├── openssl-1.0.2r.tar.gz\n│   │   ├── pcre-8.42.tar.gz\n│   │   └── zlib-1.2.11.tar.gz\n│   ├── handlers\n│   │   └── main.yml\n│   ├── meta\n│   ├── tasks\n│   │   ├── copy.yml\n│   │   └── main.yml\n│   ├── templates\n│   │   ├── default.conf.j2\n│   │   └── nginx.conf.j2\n│   └── vars\n│       └── main.yml\n└── nginx.yml\n```\n### playbook语法检测\n通过上面的配置，我们已经完成了使用playbook方式安装nginx所需要的步骤，现在我们应该在执行该playbook前检查一下上述语法有没有错误。\n```bash\n$ ansible-playbook --syntax-check /etc/ansible/roles/nginx.yml \n\nplaybook: /etc/ansible/roles/nginx.yml  # 如果语法没问题，将直接显示文件名称，如果有错误将告知你那里错了\n```\n\n### 测试安装\n`ansible-playbook -C` 命令可以测试运行playbook剧本，而非真正在远端服务器上执行，这样可以方便查看playbook在执行过程中将会做哪些事情。\n```bash\n$ ansible-playbook -C nginx.yml \n\nPLAY [web-node] ************************************************************************************************************************************************\n\nTASK [nginx : copy nginx-1.16.0.tar.gz to client] **************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : copy install_nginx.sh to client] *****************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : mkdir nginx data directory] **********************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : copy index.html] *********************************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : copy nginx systemctl file] ***********************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : copy dependency package] *************************************************************************************************************************\nchanged: [192.168.20.213] => (item=openssl-1.0.2r.tar.gz)\nchanged: [192.168.20.213] => (item=pcre-8.42.tar.gz)\nchanged: [192.168.20.213] => (item=zlib-1.2.11.tar.gz)\n\nTASK [nginx : install nginx] ***********************************************************************************************************************************\nskipping: [192.168.20.213]\n\nTASK [nginx : replace nginx.conf file] *************************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : mkdir nginx vhost directory] *********************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : relpace default.conf file] ***********************************************************************************************************************\nchanged: [192.168.20.213]\n\nTASK [nginx : start nginx] *************************************************************************************************************************************\nskipping: [192.168.20.213]\n\nRUNNING HANDLER [nginx : reload nginx] *************************************************************************************************************************\nskipping: [192.168.20.213]\n\nPLAY RECAP *****************************************************************************************************************************************************\n192.168.20.213             : ok=8    changed=8    unreachable=0    failed=0\n```\n### 运行nginx playbook\n```bash\n$ ansible-playbook nginx.yml\n```\n>执行`ansible-playbook nginx.yml`命令后，ansible将会按照刚刚测试安装的步骤在远端进行安装nginx服务并且启动。\n\n### 验证安装结果\n等待一会nginx playbook将会在远端服务器上安装完毕，现在我们来验证一下结果：\n```bash\n# 在web服务器上查看nginx端口\n$ netstat -ptln | grep 80\ntcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      14461/nginx: master\n\n# 查看nginx进程\n$ ps -ef | grep nginx\nroot      14461      1  0 00:39 ?        00:00:00 nginx: master process /usr/sbin/nginx\nnginx     14474  14461  0 00:39 ?        00:00:00 nginx: worker process\nnginx     14475  14461  0 00:39 ?        00:00:00 nginx: worker process\nnginx     14476  14461  0 00:39 ?        00:00:00 nginx: worker process\nnginx     14477  14461  0 00:39 ?        00:00:00 nginx: worker process\nroot      39501   1664  0 11:38 pts/0    00:00:00 grep --color=auto nginx\n\n# 让我们在内网任意一台电脑上来访问一下该nginx页面\n$ curl http://192.168.20.213\nthis is a test pages!       # 结果是我们前面定义的index.html内容\n\n# 访问一下nginx_status的uri\n$ curl http://192.168.20.213/nginx_status     #前面default.conf.j2文件中定义的nginx location\nActive connections: 1 \nserver accepts handled requests\n 8 8 10 \nReading: 0 Writing: 1 Waiting: 0\n```\n至此，一个使用ansible-playbook安装nginx服务已完成。","slug":"ansible-playbook","published":1,"updated":"2019-05-28T02:02:23.501Z","_id":"cjw6jlf1v0035p4n7ir2wqrou","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"Playbook简介\"><a href=\"#Playbook简介\" class=\"headerlink\" title=\"Playbook简介\"></a>Playbook简介</h2><p>Playbooks与Ad-Hoc相比，是一种完全不同的运用Ansible的方式，而且是非常之强大的；也是系统ansible命令的集合，其利用<a href=\"http://www.ansible.com.cn/docs/YAMLSyntax.html\" target=\"_blank\" rel=\"noopener\">yaml语法</a>编写，运行过程，ansbile-playbook命令根据<code>自上而下的顺序</code>依次执行任务。playbook 由一个或多个 ‘plays’ 组成.它的内容是一个以 ‘plays’为元素的列表，在 play 之中,一组机器被映射为定义好的角色.在 ansible 中,play 的内容,被称为 tasks,即任务.在基本层次的应用中,一个任务是一个对 ansible模块的调用。当第一个任务依次在所有主机上执行完毕后，开始执行第二个任务。如果某个主机执行时发生错误，则所有操作将会回滚。</p>\n<h2 id=\"Playbook基础组件\"><a href=\"#Playbook基础组件\" class=\"headerlink\" title=\"Playbook基础组件\"></a>Playbook基础组件</h2><ul>\n<li><code>hosts</code>：运行执行任务（task）的目标主机</li>\n<li><code>remote_user</code>：在远程主机上执行任务的用户</li>\n<li><code>tasks</code>：任务列表</li>\n<li><code>handlers</code>：任务，与tasks不同的是只有在接受到通知时才会被触发</li>\n<li><code>templates</code>：使用模板语言的文本文件，使用jinja2语法。</li>\n<li><code>variables</code>：变量，变量替换</li>\n<li><code>tag</code>：标签，为某tasks指定标签，运行该标签可以即运行特定的tasks，定义为always的tag总会执行</li>\n<li><code>when</code>: 条件判断，当条件成立则执行tasks，不成立不执行表达式 判断表达式如：<code>not</code> <code>or</code> <code>and</code> <code>!=</code> <code>=</code></li>\n<li><code>with_items</code>：循环迭代需要重复执行的任务列表，用<code>{item}}</code>引用列表值</li>\n</ul>\n<p>例如一个简单的playbook文件：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">   - hosts:</span> <span class=\"string\">test</span>                                  <span class=\"comment\"># 指定运行任务的主机组</span></span><br><span class=\"line\"><span class=\"attr\">     remote_user:</span> <span class=\"string\">root</span>                            <span class=\"comment\"># 指定远程执行任务的用户</span></span><br><span class=\"line\"><span class=\"attr\">     vars:</span>                                        <span class=\"comment\"># 指定变量</span></span><br><span class=\"line\"><span class=\"attr\">       - bsh:</span> <span class=\"string\">b.sh</span></span><br><span class=\"line\"><span class=\"attr\">       - httprpm:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"attr\">     task:</span>                                        <span class=\"comment\"># 任务的开始</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">install</span> <span class=\"string\">httpd</span>                      <span class=\"comment\"># 一个安装httpd的任务</span></span><br><span class=\"line\"><span class=\"attr\">         yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">httprpm</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=present</span>    <span class=\"comment\"># ansible的yum模块</span></span><br><span class=\"line\"><span class=\"attr\">         tags:</span> <span class=\"string\">install_httpd</span>                      <span class=\"comment\"># 为该任务打一个install_httpd的标签</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">copy</span> <span class=\"string\">b.sh</span>                          <span class=\"comment\"># 又一个复制b.sh脚本的任务</span></span><br><span class=\"line\"><span class=\"attr\">         copy:</span> <span class=\"string\">src=/root/&#123;&#123;</span> <span class=\"string\">bsh</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">dest=/root/</span> <span class=\"string\">owner=ala</span> <span class=\"string\">group=ala</span> <span class=\"string\">mode=0644</span></span><br><span class=\"line\"><span class=\"attr\">         notify:</span>                                  <span class=\"comment\"># 如果copy的文件内容发生改变就会触发</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"string\">reload</span> <span class=\"string\">httpd</span>                         <span class=\"comment\"># 指定通知的哪个handlers</span></span><br><span class=\"line\"><span class=\"attr\">         when:</span> <span class=\"string\">ansible_distribution</span> <span class=\"string\">==</span> <span class=\"string\">\"CentOS\"</span>   <span class=\"comment\"># 通过变量判断系统为CentOS时才执行该copy任务</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">copy</span> <span class=\"string\">b.sh</span>                          </span><br><span class=\"line\"><span class=\"attr\">         copy:</span> <span class=\"string\">src=/root/&#123;&#123;</span> <span class=\"string\">bsh</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">dest=/opt/</span> <span class=\"string\">owner=ala</span> <span class=\"string\">group=ala</span> <span class=\"string\">mode=0644</span></span><br><span class=\"line\"><span class=\"attr\">         notify:</span>                                  </span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"string\">reload</span> <span class=\"string\">httpd</span>                         </span><br><span class=\"line\"><span class=\"attr\">         when:</span> <span class=\"string\">ansible_distribution</span> <span class=\"string\">==</span> <span class=\"string\">\"Ubuntu\"</span>   <span class=\"comment\"># 通过变量判断系统为Ubuntu时才执行该copy任务</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">start</span> <span class=\"string\">httpd</span>                        <span class=\"comment\"># 又一个启动httpd服务的任务</span></span><br><span class=\"line\"><span class=\"attr\">         service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=started</span> <span class=\"string\">enabled=yes</span></span><br><span class=\"line\"><span class=\"attr\">     handlers:</span>                                    <span class=\"comment\"># 满足触发条件则执行的任务</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">reload</span> <span class=\"string\">httpd</span>                       <span class=\"comment\"># 满足触发条件的任务名</span></span><br><span class=\"line\"><span class=\"attr\">         service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=reloaded</span>       <span class=\"comment\"># 该任务为重新加载一下httpd服务</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>其中的<code>ansible_distribution</code>是ansible收集的facts变量。</p>\n</blockquote>\n<h2 id=\"playbook定义变量\"><a href=\"#playbook定义变量\" class=\"headerlink\" title=\"playbook定义变量\"></a>playbook定义变量</h2><p><strong> ansible 常见定义变量有以下 6 种</strong></p>\n<ul>\n<li>/etc/ansible/hosts文件主机中定义</li>\n<li>/etc/ansible/hosts/文件主机组中定义</li>\n<li>playbook的yaml文件中通过vars定义</li>\n<li>获取系统变量，也称facts变量</li>\n<li>分文件定义主机和主机组的变量</li>\n<li>playbook 的role中定义</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /etc/ansible/hosts文件主机中定义 主机变量</span></span><br><span class=\"line\">192.168.200.136 http_port=808 maxRequestsPerChild=808</span><br><span class=\"line\">192.168.200.137 http_port=8080 maxRequestsPerChild=909</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\"># /etc/ansible/hosts文件主机中定义 主机组变量</span></span><br><span class=\"line\">[websers]</span><br><span class=\"line\">192.168.200.136</span><br><span class=\"line\">192.168.200.137</span><br><span class=\"line\"> </span><br><span class=\"line\">[websers:vars]  </span><br><span class=\"line\">ntp_server=ntp.exampl.com</span><br><span class=\"line\">proxy=proxy.exampl.com                <span class=\"comment\"># ntp_server和proxy变量可为websers组中主机使用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># playbook的yaml文件中通过vars定义</span></span><br><span class=\"line\"> ---</span><br><span class=\"line\">    - hosts: <span class=\"built_in\">test</span>                                  </span><br><span class=\"line\">      remote_user: root                            </span><br><span class=\"line\">      vars:                           <span class=\"comment\"># 定义bsh和httprpm的两个变量</span></span><br><span class=\"line\">        - bsh: b.sh</span><br><span class=\"line\">        - httprpm: httpd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取系统facts变量</span></span><br><span class=\"line\">ansible 192.168.200.136 -m setup      <span class=\"comment\"># 可以获取主机所有的facts变量，通过&#123;&#123;variable_name&#125;&#125;引用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 分文件定义主机和主机组的变量</span></span><br><span class=\"line\">/etc/ansible/group_vars/websers       <span class=\"comment\"># 定义主机组名为websers的变量文件</span></span><br><span class=\"line\">/etc/ansible/host_vars/hostpc         <span class=\"comment\"># 定义主机名为hostpc的变量文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ cat /etc/ansible/host_vars/hostpc   <span class=\"comment\"># 变量文件内容格式如下</span></span><br><span class=\"line\">---</span><br><span class=\"line\">ntp_server: acme.example.org</span><br><span class=\"line\">database_server: storage.example.org</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># role中定义   （目录结构下文讲述）</span></span><br><span class=\"line\">$ cat /etc/ansible/roles/nginx/vars/main.yml</span><br><span class=\"line\">---</span><br><span class=\"line\">nginx_port: 80</span><br><span class=\"line\">nginx_domain: www.abc.com</span><br><span class=\"line\">nginx_user: nginx</span><br></pre></td></tr></table></figure>\n<h2 id=\"playbook-role目录结构\"><a href=\"#playbook-role目录结构\" class=\"headerlink\" title=\"playbook role目录结构\"></a>playbook role目录结构</h2><h3 id=\"Roles简介\"><a href=\"#Roles简介\" class=\"headerlink\" title=\"Roles简介\"></a>Roles简介</h3><p>Ansible为了层次化、结构化地组织Playbook，使用了角色（roles）。Roles能够根据层次型结构自动装载变量文件、task及handlers等。简单来讲，roles就是通过分别将变量、文件、任务、模块及处理器放置于单独的目录中，并可以便捷地include它们，roles一般用于基于主机构建服务的场景中，但也可以用于构建守护进程等场景中。</p>\n<h3 id=\"创建Roles\"><a href=\"#创建Roles\" class=\"headerlink\" title=\"创建Roles\"></a>创建Roles</h3><p>创建roles时一般需要以下步骤：首先创建以roles命名的目录。然后在roles目标下分别创建以这个角色名称命令的目录，如websevers等，然后在每个角色命令的目录中分别创建files、handlers、tasks、templates、meta、defaults和vars目录，用不到的目录可以创建为空目录。最后在Playbook文件中调用各角色进行使用。</p>\n<h3 id=\"roles内各目录含义解释\"><a href=\"#roles内各目录含义解释\" class=\"headerlink\" title=\"roles内各目录含义解释\"></a>roles内各目录含义解释</h3><ul>\n<li><code>files</code>：用来存放由copy模块或script模块调用的文件。</li>\n<li><code>templates</code>：用来存放jinjia2模板，template模块会自动在此目录中寻找jinjia2模板文件。</li>\n<li><code>tasks</code>：此目录应当包含一个main.yml文件，用于定义此角色的任务列表，此文件可以使用include包含其它的位于此目录的task文件。</li>\n<li><code>handlers</code>：此目录应当包含一个main.yml文件，用于定义此角色中触发条件时执行的动作。</li>\n<li><code>vars</code>：此目录应当包含一个main.yml文件，用于定义此角色用到的变量。</li>\n<li><code>defaults</code>：此目录应当包含一个main.yml文件，用于为当前角色设定默认变量。</li>\n<li><code>meta</code>：此目录应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系。</li>\n</ul>\n<p>如下定义了一个nginx服务的playbook目录结构树。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@k8s-master1 roles]<span class=\"comment\"># tree /etc/ansible/roles/nginx</span></span><br><span class=\"line\">/etc/ansible/roles/nginx</span><br><span class=\"line\">├── defaults</span><br><span class=\"line\">│   └── main.yml</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── nginx.tar.gz</span><br><span class=\"line\">├── handlers</span><br><span class=\"line\">│   └── main.yml</span><br><span class=\"line\">├── meta</span><br><span class=\"line\">│   └── main.yml</span><br><span class=\"line\">├── tasks</span><br><span class=\"line\">│   └── main.yml</span><br><span class=\"line\">├── templates</span><br><span class=\"line\">│   └── nginx.conf.j2</span><br><span class=\"line\">│   └── default.conf.j2</span><br><span class=\"line\">└── vars</span><br><span class=\"line\">    └── main.yml</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"使用roles安装nginx案例\"><a href=\"#使用roles安装nginx案例\" class=\"headerlink\" title=\"使用roles安装nginx案例\"></a>使用roles安装nginx案例</h2><h3 id=\"实例环境\"><a href=\"#实例环境\" class=\"headerlink\" title=\"实例环境\"></a>实例环境</h3><table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>IP</th>\n<th>系统</th>\n<th>角色</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ansible</td>\n<td>192.168.20.210</td>\n<td>centos7.5</td>\n<td>ansible控制器</td>\n</tr>\n<tr>\n<td>web-nginx</td>\n<td>192.168.20.213</td>\n<td>centos7.5</td>\n<td>web服务器 </td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"hosts主机组清单\"><a href=\"#hosts主机组清单\" class=\"headerlink\" title=\"hosts主机组清单\"></a>hosts主机组清单</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansilbe/hosts          <span class=\"comment\"># ansible hosts主机组配置</span></span><br><span class=\"line\">  [web-node]</span><br><span class=\"line\">  192.168.20.213</span><br></pre></td></tr></table></figure>\n<h3 id=\"生成ssh密钥\"><a href=\"#生成ssh密钥\" class=\"headerlink\" title=\"生成ssh密钥\"></a>生成ssh密钥</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在ansible控制机上生成ssh密钥对</span></span><br><span class=\"line\"> </span><br><span class=\"line\">$ ssh-keygen -t rsa</span><br><span class=\"line\">Generating public/private rsa key pair.</span><br><span class=\"line\">Enter file <span class=\"keyword\">in</span> <span class=\"built_in\">which</span> to save the key (/root/.ssh/id_rsa): </span><br><span class=\"line\">Enter passphrase (empty <span class=\"keyword\">for</span> no passphrase): </span><br><span class=\"line\">Enter same passphrase again: </span><br><span class=\"line\">Your identification has been saved <span class=\"keyword\">in</span> /root/.ssh/id_rsa.</span><br><span class=\"line\">Your public key has been saved <span class=\"keyword\">in</span> /root/.ssh/id_rsa.pub.</span><br><span class=\"line\">The key fingerprint is:</span><br><span class=\"line\">SHA256:m4+23Eh+dJ8r/9zSjpUbHJECh1iFQU8Z0QMlygrRm98 root@k8s-node1</span><br><span class=\"line\">The key<span class=\"string\">'s randomart image is:</span></span><br><span class=\"line\"><span class=\"string\">+---[RSA 2048]----+</span></span><br><span class=\"line\"><span class=\"string\">|       .. +==OB. |</span></span><br><span class=\"line\"><span class=\"string\">|        .o.o*..o.|</span></span><br><span class=\"line\"><span class=\"string\">|       .  oo o o.|</span></span><br><span class=\"line\"><span class=\"string\">|        .o.   . .|</span></span><br><span class=\"line\"><span class=\"string\">|        S.. .  . |</span></span><br><span class=\"line\"><span class=\"string\">|         o...E. o|</span></span><br><span class=\"line\"><span class=\"string\">|        +. . . *.|</span></span><br><span class=\"line\"><span class=\"string\">|       +.=. . ++=|</span></span><br><span class=\"line\"><span class=\"string\">|       .*oo  o+*=|</span></span><br><span class=\"line\"><span class=\"string\">+----[SHA256]-----+</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># 复制ansible控制机上的公钥到nginx web服务器</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">$ ssh-copy-id -i ~/.ssh/id_rsa.pub 192.168.20.213</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">这里是root用户验证，输入完root密码后，就可以在ansible主机上无密码ssh登陆nginx web服务器了。</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"创建nginx的roles结构目录\"><a href=\"#创建nginx的roles结构目录\" class=\"headerlink\" title=\"创建nginx的roles结构目录\"></a>创建nginx的roles结构目录</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir -pv /etc/ansible/roles/nginx/&#123;defaults,files,handlers,meta,tasks,templates,vars&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"准备安装包和依赖包\"><a href=\"#准备安装包和依赖包\" class=\"headerlink\" title=\"准备安装包和依赖包\"></a>准备安装包和依赖包</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /etc/ansible/roles/nginx/files</span><br><span class=\"line\">$ wget http://nginx.org/download/nginx-1.16.0.tar.gz</span><br><span class=\"line\">$ wget https://www.openssl.org/<span class=\"built_in\">source</span>/openssl-1.0.2r.tar.gz</span><br><span class=\"line\">$ wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.42.tar.gz</span><br><span class=\"line\">$ wget http://www.zlib.net/zlib-1.2.11.tar.gz</span><br></pre></td></tr></table></figure>\n<h3 id=\"准备安装脚本\"><a href=\"#准备安装脚本\" class=\"headerlink\" title=\"准备安装脚本\"></a>准备安装脚本</h3><blockquote>\n<p>该脚本已在手动安装测试过，建议各位在通过ansible playbook安装服务器前，先手动安装一遍确保无误。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx/files/install_nginx.sh</span><br><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"><span class=\"comment\">#info: source code install nginx 1.16.0</span></span><br><span class=\"line\"><span class=\"comment\">#author: pyker &lt;pyker@qq.com&gt;</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> PATH=`<span class=\"built_in\">echo</span> <span class=\"variable\">$PATH</span>`</span><br><span class=\"line\">PWD=<span class=\"string\">\"/opt\"</span></span><br><span class=\"line\">NGINX=nginx-1.16.0</span><br><span class=\"line\">OPENSSL=openssl-1.0.2r</span><br><span class=\"line\">PCRE=pcre-8.42</span><br><span class=\"line\">ZLIB=zlib-1.2.11</span><br><span class=\"line\">RUN_USER=nginx</span><br><span class=\"line\">id -u <span class=\"variable\">$&#123;RUN_USER&#125;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class=\"line\">[ $? -ne 0 ] &amp;&amp; useradd -M -s /sbin/nologin <span class=\"variable\">$&#123;RUN_USER&#125;</span></span><br><span class=\"line\">mkdir -p /var/<span class=\"built_in\">log</span>/nginx</span><br><span class=\"line\">yum install -y epel-release </span><br><span class=\"line\">yum install -y jemalloc jemalloc-devel</span><br><span class=\"line\">yum install -y gcc \\</span><br><span class=\"line\">             gcc-c++ \\</span><br><span class=\"line\">             gcc++ \\</span><br><span class=\"line\">             perl \\</span><br><span class=\"line\">             perl-devel \\</span><br><span class=\"line\">             perl-ExtUtils-Embed \\</span><br><span class=\"line\">             libxslt \\</span><br><span class=\"line\">             libxslt-devel \\</span><br><span class=\"line\">             libxml2 \\</span><br><span class=\"line\">             libxml2-devel \\</span><br><span class=\"line\">             gd \\</span><br><span class=\"line\">             gd-devel \\</span><br><span class=\"line\">             GeoIP \\</span><br><span class=\"line\">             GeoIP-devel</span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$PWD</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> tar <span class=\"keyword\">in</span> `ls *.tar.gz`; <span class=\"keyword\">do</span></span><br><span class=\"line\">  tar zxf <span class=\"variable\">$tar</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$PWD</span>/<span class=\"variable\">$NGINX</span> &amp;&amp; ./configure --prefix=/usr/<span class=\"built_in\">local</span>/nginx \\</span><br><span class=\"line\">            --sbin-path=/usr/sbin/nginx \\</span><br><span class=\"line\">            --user=nginx \\</span><br><span class=\"line\">            --group=nginx \\</span><br><span class=\"line\">            --pid-path=/var/run/nginx.pid \\</span><br><span class=\"line\">            --lock-path=/var/run/nginx.lock \\</span><br><span class=\"line\">            --error-log-path=/var/<span class=\"built_in\">log</span>/nginx/error.log \\</span><br><span class=\"line\">            --http-log-path=/var/<span class=\"built_in\">log</span>/nginx/access.log \\</span><br><span class=\"line\">            --with-select_module \\</span><br><span class=\"line\">            --with-poll_module \\</span><br><span class=\"line\">            --with-threads \\</span><br><span class=\"line\">            --with-file-aio \\</span><br><span class=\"line\">            --with-http_ssl_module \\</span><br><span class=\"line\">            --with-http_v2_module \\</span><br><span class=\"line\">            --with-http_realip_module \\</span><br><span class=\"line\">            --with-http_addition_module \\</span><br><span class=\"line\">            --with-http_xslt_module=dynamic \\</span><br><span class=\"line\">            --with-http_image_filter_module=dynamic \\</span><br><span class=\"line\">            --with-http_geoip_module=dynamic \\</span><br><span class=\"line\">            --with-http_sub_module \\</span><br><span class=\"line\">            --with-http_dav_module \\</span><br><span class=\"line\">            --with-http_flv_module \\</span><br><span class=\"line\">            --with-http_mp4_module \\</span><br><span class=\"line\">            --with-http_gunzip_module \\</span><br><span class=\"line\">            --with-http_gzip_static_module \\</span><br><span class=\"line\">            --with-http_auth_request_module \\</span><br><span class=\"line\">            --with-http_random_index_module \\</span><br><span class=\"line\">            --with-http_secure_link_module \\</span><br><span class=\"line\">            --with-http_degradation_module \\</span><br><span class=\"line\">            --with-http_slice_module \\</span><br><span class=\"line\">            --with-http_stub_status_module \\</span><br><span class=\"line\">            --with-mail=dynamic \\</span><br><span class=\"line\">            --with-mail_ssl_module \\</span><br><span class=\"line\">            --with-stream \\</span><br><span class=\"line\">            --with-stream_ssl_module \\</span><br><span class=\"line\">            --with-stream_realip_module \\</span><br><span class=\"line\">            --with-stream_geoip_module=dynamic \\</span><br><span class=\"line\">            --with-stream_ssl_preread_module \\</span><br><span class=\"line\">            --with-compat \\</span><br><span class=\"line\">            --with-ld-opt=<span class=\"string\">\"-ljemalloc\"</span> \\</span><br><span class=\"line\">            --with-pcre=../<span class=\"variable\">$&#123;PCRE&#125;</span> \\</span><br><span class=\"line\">            --with-pcre-jit \\</span><br><span class=\"line\">            --with-zlib=../<span class=\"variable\">$&#123;ZLIB&#125;</span> \\</span><br><span class=\"line\">            --with-openssl=../<span class=\"variable\">$&#123;OPENSSL&#125;</span>\\</span><br><span class=\"line\">            --with-openssl-opt=no-nextprotoneg \\</span><br><span class=\"line\">            --with-debug &amp;&amp; make -j 4 &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n<h3 id=\"配置变量\"><a href=\"#配置变量\" class=\"headerlink\" title=\"配置变量\"></a>配置变量</h3><p> 在安装nginx的时候或者其他服务的时候常常用到变量，下面配置变量是通过roles方式配置。<br> <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx/vas/main.yml</span><br><span class=\"line\">cat nginx/vars/main.yml </span><br><span class=\"line\">nginx_user: nginx</span><br><span class=\"line\">nginx_port: 80</span><br><span class=\"line\">nginx_dir: /usr/<span class=\"built_in\">local</span>/nginx</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"准备nginx-conf模版\"><a href=\"#准备nginx-conf模版\" class=\"headerlink\" title=\"准备nginx.conf模版\"></a>准备nginx.conf模版</h3> <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx/templates/nginx.conf.j2</span><br><span class=\"line\">user &#123;&#123; nginx_user &#125;&#125;;</span><br><span class=\"line\">worker_processes &#123;&#123; ansible_processor_vcpus &#125;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">error_log /var/<span class=\"built_in\">log</span>/nginx/error_nginx.log crit;</span><br><span class=\"line\">pid /var/run/nginx.pid;</span><br><span class=\"line\">worker_rlimit_nofile 51200;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">  use epoll;</span><br><span class=\"line\">  worker_connections 51200;</span><br><span class=\"line\">  multi_accept on;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">  map <span class=\"variable\">$http_upgrade</span> <span class=\"variable\">$connection_upgrade</span> &#123;</span><br><span class=\"line\">    default upgrade;</span><br><span class=\"line\">    <span class=\"string\">''</span>      close;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  include mime.types;</span><br><span class=\"line\">  default_type application/octet-stream;</span><br><span class=\"line\">  server_names_hash_bucket_size 128;</span><br><span class=\"line\">  client_header_buffer_size 32k;</span><br><span class=\"line\">  large_client_header_buffers 4 32k;</span><br><span class=\"line\">  client_max_body_size 1024m;</span><br><span class=\"line\">  client_body_buffer_size 10m;</span><br><span class=\"line\">  sendfile on;</span><br><span class=\"line\">  tcp_nopush on;</span><br><span class=\"line\">  keepalive_timeout 120;</span><br><span class=\"line\">  server_tokens off;</span><br><span class=\"line\">  tcp_nodelay on;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#Gzip Compression</span></span><br><span class=\"line\">  gzip on;</span><br><span class=\"line\">  gzip_buffers 16 8k;</span><br><span class=\"line\">  gzip_comp_level 6;</span><br><span class=\"line\">  gzip_http_version 1.1;</span><br><span class=\"line\">  gzip_min_length 256;</span><br><span class=\"line\">  gzip_proxied any;</span><br><span class=\"line\">  gzip_vary on;</span><br><span class=\"line\">  gzip_types</span><br><span class=\"line\">    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml</span><br><span class=\"line\">    text/javascript application/javascript application/x-javascript</span><br><span class=\"line\">    text/x-json application/json application/x-web-app-manifest+json</span><br><span class=\"line\">    text/css text/plain text/x-component</span><br><span class=\"line\">    font/opentype application/x-font-ttf application/vnd.ms-fontobject</span><br><span class=\"line\">    image/x-icon;</span><br><span class=\"line\">  gzip_disable <span class=\"string\">\"MSIE [1-6]\\.(?!.*SV1)\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#If you have a lot of static files to serve through Nginx then caching of the files' metadata (not the actual files' contents) can save some latency.</span></span><br><span class=\"line\">  open_file_cache max=1000 inactive=20s;</span><br><span class=\"line\">  open_file_cache_valid 30s;</span><br><span class=\"line\">  open_file_cache_min_uses 2;</span><br><span class=\"line\">  open_file_cache_errors on;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">########################## vhost #############################</span></span><br><span class=\"line\">  include upstream/*.conf;</span><br><span class=\"line\">  include vhost/*.conf;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>nginx.conf.j2文件中<code>nginx_user</code>和<code>ansible_processor_vcpus</code>分别为用户自定义变量和<code>-m setup</code>获取的facts。</p>\n</blockquote>\n<h3 id=\"定义默认server模版\"><a href=\"#定义默认server模版\" class=\"headerlink\" title=\"定义默认server模版\"></a>定义默认server模版</h3> <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> ```bash</span><br><span class=\"line\">$ cat /etc/ansible/roles/nginx/templates/default.conf.j2</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen &#123;&#123; nginx_port &#125;&#125;;</span><br><span class=\"line\">        server_name &#123;&#123; ansible_all_ipv4_addresses &#125;&#125;;</span><br><span class=\"line\">        index index.html index.htm index.jsp index.do;</span><br><span class=\"line\">        access_log  off;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            root /data/wwwroot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">         location /nginx_status &#123;</span><br><span class=\"line\">            stub_status on;</span><br><span class=\"line\">            access_log   off;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>default.conf.j2文件中<code>nginx_port</code>和<code>ansible_all_ipv4_addresses</code>分别为用户自定义变量和<code>-m setup</code>获取的facts。</p>\n</blockquote>\n<h3 id=\"定义一个测试index-html文件\"><a href=\"#定义一个测试index-html文件\" class=\"headerlink\" title=\"定义一个测试index.html文件\"></a>定义一个测试index.html文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx/templates/index.html</span><br><span class=\"line\"> this is <span class=\"built_in\">test</span> pages!</span><br></pre></td></tr></table></figure>\n<h3 id=\"定义nginx启动脚本\"><a href=\"#定义nginx启动脚本\" class=\"headerlink\" title=\"定义nginx启动脚本\"></a>定义nginx启动脚本</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx/files/nginx.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=The NGINX HTTP and reverse proxy server</span><br><span class=\"line\">After=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">PIDFile=/var/run/nginx.pid</span><br><span class=\"line\">ExecStartPre=/usr/sbin/nginx -t</span><br><span class=\"line\">ExecStart=/usr/sbin/nginx</span><br><span class=\"line\">ExecReload=/usr/sbin/nginx -s reload</span><br><span class=\"line\">ExecStop=/usr/bin/<span class=\"built_in\">kill</span> -s QUIT <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\">PrivateTmp=<span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h3 id=\"定义tasks任务\"><a href=\"#定义tasks任务\" class=\"headerlink\" title=\"定义tasks任务\"></a>定义tasks任务</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在tasks目录中定义了一个copy.yaml文件用户复制files目录下的文件到nginx服务器</span></span><br><span class=\"line\"><span class=\"comment\"># 定义完成后，需要在tasks/main.yaml文件中用-include包含该copy.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">cat</span> <span class=\"string\">/etc/ansible/roles/nginx/tasks/copy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">copy</span> <span class=\"string\">nginx-1.16.0.tar.gz</span> <span class=\"string\">to</span> <span class=\"string\">client</span></span><br><span class=\"line\"><span class=\"attr\">  copy:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/files/nginx-1.16.0.tar.gz</span> <span class=\"string\">dest=/opt/nginx-1.16.0.tar.gz</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">copy</span> <span class=\"string\">install_nginx.sh</span> <span class=\"string\">to</span> <span class=\"string\">client</span></span><br><span class=\"line\"><span class=\"attr\">  copy:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/files/install_nginx.sh</span> <span class=\"string\">dest=/opt/install_nginx.sh</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">mkdir</span> <span class=\"string\">nginx</span> <span class=\"string\">data</span> <span class=\"string\">directory</span></span><br><span class=\"line\"><span class=\"attr\">  file:</span> <span class=\"string\">path=/data/wwwroot</span> <span class=\"string\">state=directory</span> <span class=\"string\">recurse=yes</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">copy</span> <span class=\"string\">index.html</span></span><br><span class=\"line\"><span class=\"attr\">  copy:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/files/index.html</span> <span class=\"string\">dest=/data/wwwroot/index.html</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">copy</span> <span class=\"string\">nginx</span> <span class=\"string\">systemctl</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">  copy:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/files/nginx.service</span> <span class=\"string\">dest=/usr/lib/systemd/system/nginx.service</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">copy</span> <span class=\"string\">dependency</span> <span class=\"string\">package</span></span><br><span class=\"line\"><span class=\"attr\">  copy:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/files/&#123;&#123;</span> <span class=\"string\">item</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">dest=/opt/&#123;&#123;</span> <span class=\"string\">item</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">  with_items:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">openssl-1.0.2r.tar.gz</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">pcre-8.42.tar.gz</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">zlib-1.2.11.tar.gz</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义main.yaml文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">cat</span> <span class=\"string\">/etc/ansible/roles/nginx/tasks/main.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- include:</span> <span class=\"string\">copy.yml</span>       <span class=\"comment\"># 使用include将上面copy.yaml文件包含进来</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">install</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  shell:</span> <span class=\"string\">/usr/bin/sh</span> <span class=\"string\">/opt/install_nginx.sh</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">replace</span> <span class=\"string\">nginx.conf</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/templates/nginx.conf.j2</span> <span class=\"string\">dest=&#123;&#123;</span> <span class=\"string\">nginx_dir</span> <span class=\"string\">&#125;&#125;/conf/nginx.conf</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">mkdir</span> <span class=\"string\">nginx</span> <span class=\"string\">vhost</span> <span class=\"string\">directory</span></span><br><span class=\"line\"><span class=\"attr\">  file:</span> <span class=\"string\">path=&#123;&#123;nginx_dir&#125;&#125;/conf/vhost</span> <span class=\"string\">state=directory</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">relpace</span> <span class=\"string\">default.conf</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/templates/default.conf.j2</span> <span class=\"string\">dest=&#123;&#123;nginx_dir&#125;&#125;/conf/vhost/default.conf</span></span><br><span class=\"line\"><span class=\"attr\">  tags:</span> <span class=\"string\">ngxdef</span>            <span class=\"comment\"># 定义一个tag，当default.conf发生改变时可以指定运行该任务</span></span><br><span class=\"line\"><span class=\"attr\">  notify:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">reload</span> <span class=\"string\">nginx</span>        <span class=\"comment\"># 该名称需要和handler中定义的一样</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">start</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  command:</span> <span class=\"string\">/usr/sbin/nginx</span> <span class=\"comment\"># 由于配置了nginx启动服务，也可以使用 shell: systemctl start nginx</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"定义触发通知handlers\"><a href=\"#定义触发通知handlers\" class=\"headerlink\" title=\"定义触发通知handlers\"></a>定义触发通知handlers</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">cat</span> <span class=\"string\">/etc/ansible/roles/nginx/handlers/main.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">reload</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  shell:</span> <span class=\"string\">/usr/sbin/nginx</span> <span class=\"bullet\">-t;</span> <span class=\"string\">/usr/sbin/nginx</span> <span class=\"bullet\">-s</span> <span class=\"string\">reload</span>  <span class=\"comment\"># 也可以使用 shell: systemctl reload nginx</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"定义role入口文件\"><a href=\"#定义role入口文件\" class=\"headerlink\" title=\"定义role入口文件\"></a>定义role入口文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx.yml </span><br><span class=\"line\">---</span><br><span class=\"line\">- hosts: web-node      <span class=\"comment\"># 定义要执行该playbook的主机组</span></span><br><span class=\"line\">  remote_user: root    <span class=\"comment\"># 定义远程执行命令的用户</span></span><br><span class=\"line\">  roles:               <span class=\"comment\"># </span></span><br><span class=\"line\">    - nginx            <span class=\"comment\"># 主机组中的主机使用哪个playbook剧本</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"查看当前nginx-roles目录树结构\"><a href=\"#查看当前nginx-roles目录树结构\" class=\"headerlink\" title=\"查看当前nginx roles目录树结构\"></a>查看当前nginx roles目录树结构</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tree /etc/ansible/roles/</span><br><span class=\"line\">/etc/ansible/roles/</span><br><span class=\"line\">├── nginx</span><br><span class=\"line\">│   ├── defaults</span><br><span class=\"line\">│   ├── files</span><br><span class=\"line\">│   │   ├── index.html</span><br><span class=\"line\">│   │   ├── nginx.service</span><br><span class=\"line\">│   │   ├── install_nginx.sh</span><br><span class=\"line\">│   │   ├── nginx-1.16.0.tar.gz</span><br><span class=\"line\">│   │   ├── openssl-1.0.2r.tar.gz</span><br><span class=\"line\">│   │   ├── pcre-8.42.tar.gz</span><br><span class=\"line\">│   │   └── zlib-1.2.11.tar.gz</span><br><span class=\"line\">│   ├── handlers</span><br><span class=\"line\">│   │   └── main.yml</span><br><span class=\"line\">│   ├── meta</span><br><span class=\"line\">│   ├── tasks</span><br><span class=\"line\">│   │   ├── copy.yml</span><br><span class=\"line\">│   │   └── main.yml</span><br><span class=\"line\">│   ├── templates</span><br><span class=\"line\">│   │   ├── default.conf.j2</span><br><span class=\"line\">│   │   └── nginx.conf.j2</span><br><span class=\"line\">│   └── vars</span><br><span class=\"line\">│       └── main.yml</span><br><span class=\"line\">└── nginx.yml</span><br></pre></td></tr></table></figure>\n<h3 id=\"playbook语法检测\"><a href=\"#playbook语法检测\" class=\"headerlink\" title=\"playbook语法检测\"></a>playbook语法检测</h3><p>通过上面的配置，我们已经完成了使用playbook方式安装nginx所需要的步骤，现在我们应该在执行该playbook前检查一下上述语法有没有错误。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible-playbook --syntax-check /etc/ansible/roles/nginx.yml </span><br><span class=\"line\"></span><br><span class=\"line\">playbook: /etc/ansible/roles/nginx.yml  <span class=\"comment\"># 如果语法没问题，将直接显示文件名称，如果有错误将告知你那里错了</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"测试安装\"><a href=\"#测试安装\" class=\"headerlink\" title=\"测试安装\"></a>测试安装</h3><p><code>ansible-playbook -C</code> 命令可以测试运行playbook剧本，而非真正在远端服务器上执行，这样可以方便查看playbook在执行过程中将会做哪些事情。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible-playbook -C nginx.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [web-node] ************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : copy nginx-1.16.0.tar.gz to client] **************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : copy install_nginx.sh to client] *****************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : mkdir nginx data directory] **********************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : copy index.html] *********************************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : copy nginx systemctl file] ***********************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : copy dependency package] *************************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213] =&gt; (item=openssl-1.0.2r.tar.gz)</span><br><span class=\"line\">changed: [192.168.20.213] =&gt; (item=pcre-8.42.tar.gz)</span><br><span class=\"line\">changed: [192.168.20.213] =&gt; (item=zlib-1.2.11.tar.gz)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : install nginx] ***********************************************************************************************************************************</span><br><span class=\"line\">skipping: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : replace nginx.conf file] *************************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : mkdir nginx vhost directory] *********************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : relpace default.conf file] ***********************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : start nginx] *************************************************************************************************************************************</span><br><span class=\"line\">skipping: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [nginx : reload nginx] *************************************************************************************************************************</span><br><span class=\"line\">skipping: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *****************************************************************************************************************************************************</span><br><span class=\"line\">192.168.20.213             : ok=8    changed=8    unreachable=0    failed=0</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"运行nginx-playbook\"><a href=\"#运行nginx-playbook\" class=\"headerlink\" title=\"运行nginx playbook\"></a>运行nginx playbook</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible-playbook nginx.yml</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>执行<code>ansible-playbook nginx.yml</code>命令后，ansible将会按照刚刚测试安装的步骤在远端进行安装nginx服务并且启动。</p>\n</blockquote>\n<h3 id=\"验证安装结果\"><a href=\"#验证安装结果\" class=\"headerlink\" title=\"验证安装结果\"></a>验证安装结果</h3><p>等待一会nginx playbook将会在远端服务器上安装完毕，现在我们来验证一下结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在web服务器上查看nginx端口</span></span><br><span class=\"line\">$ netstat -ptln | grep 80</span><br><span class=\"line\">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      14461/nginx: master</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看nginx进程</span></span><br><span class=\"line\">$ ps -ef | grep nginx</span><br><span class=\"line\">root      14461      1  0 00:39 ?        00:00:00 nginx: master process /usr/sbin/nginx</span><br><span class=\"line\">nginx     14474  14461  0 00:39 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">nginx     14475  14461  0 00:39 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">nginx     14476  14461  0 00:39 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">nginx     14477  14461  0 00:39 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">root      39501   1664  0 11:38 pts/0    00:00:00 grep --color=auto nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 让我们在内网任意一台电脑上来访问一下该nginx页面</span></span><br><span class=\"line\">$ curl http://192.168.20.213</span><br><span class=\"line\">this is a <span class=\"built_in\">test</span> pages!       <span class=\"comment\"># 结果是我们前面定义的index.html内容</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 访问一下nginx_status的uri</span></span><br><span class=\"line\">$ curl http://192.168.20.213/nginx_status     <span class=\"comment\">#前面default.conf.j2文件中定义的nginx location</span></span><br><span class=\"line\">Active connections: 1 </span><br><span class=\"line\">server accepts handled requests</span><br><span class=\"line\"> 8 8 10 </span><br><span class=\"line\">Reading: 0 Writing: 1 Waiting: 0</span><br></pre></td></tr></table></figure></p>\n<p>至此，一个使用ansible-playbook安装nginx服务已完成。</p>\n","site":{"data":{}},"length":18705,"excerpt":"","more":"<h2 id=\"Playbook简介\"><a href=\"#Playbook简介\" class=\"headerlink\" title=\"Playbook简介\"></a>Playbook简介</h2><p>Playbooks与Ad-Hoc相比，是一种完全不同的运用Ansible的方式，而且是非常之强大的；也是系统ansible命令的集合，其利用<a href=\"http://www.ansible.com.cn/docs/YAMLSyntax.html\" target=\"_blank\" rel=\"noopener\">yaml语法</a>编写，运行过程，ansbile-playbook命令根据<code>自上而下的顺序</code>依次执行任务。playbook 由一个或多个 ‘plays’ 组成.它的内容是一个以 ‘plays’为元素的列表，在 play 之中,一组机器被映射为定义好的角色.在 ansible 中,play 的内容,被称为 tasks,即任务.在基本层次的应用中,一个任务是一个对 ansible模块的调用。当第一个任务依次在所有主机上执行完毕后，开始执行第二个任务。如果某个主机执行时发生错误，则所有操作将会回滚。</p>\n<h2 id=\"Playbook基础组件\"><a href=\"#Playbook基础组件\" class=\"headerlink\" title=\"Playbook基础组件\"></a>Playbook基础组件</h2><ul>\n<li><code>hosts</code>：运行执行任务（task）的目标主机</li>\n<li><code>remote_user</code>：在远程主机上执行任务的用户</li>\n<li><code>tasks</code>：任务列表</li>\n<li><code>handlers</code>：任务，与tasks不同的是只有在接受到通知时才会被触发</li>\n<li><code>templates</code>：使用模板语言的文本文件，使用jinja2语法。</li>\n<li><code>variables</code>：变量，变量替换</li>\n<li><code>tag</code>：标签，为某tasks指定标签，运行该标签可以即运行特定的tasks，定义为always的tag总会执行</li>\n<li><code>when</code>: 条件判断，当条件成立则执行tasks，不成立不执行表达式 判断表达式如：<code>not</code> <code>or</code> <code>and</code> <code>!=</code> <code>=</code></li>\n<li><code>with_items</code>：循环迭代需要重复执行的任务列表，用<code>{item}}</code>引用列表值</li>\n</ul>\n<p>例如一个简单的playbook文件：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">   - hosts:</span> <span class=\"string\">test</span>                                  <span class=\"comment\"># 指定运行任务的主机组</span></span><br><span class=\"line\"><span class=\"attr\">     remote_user:</span> <span class=\"string\">root</span>                            <span class=\"comment\"># 指定远程执行任务的用户</span></span><br><span class=\"line\"><span class=\"attr\">     vars:</span>                                        <span class=\"comment\"># 指定变量</span></span><br><span class=\"line\"><span class=\"attr\">       - bsh:</span> <span class=\"string\">b.sh</span></span><br><span class=\"line\"><span class=\"attr\">       - httprpm:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"attr\">     task:</span>                                        <span class=\"comment\"># 任务的开始</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">install</span> <span class=\"string\">httpd</span>                      <span class=\"comment\"># 一个安装httpd的任务</span></span><br><span class=\"line\"><span class=\"attr\">         yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">httprpm</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=present</span>    <span class=\"comment\"># ansible的yum模块</span></span><br><span class=\"line\"><span class=\"attr\">         tags:</span> <span class=\"string\">install_httpd</span>                      <span class=\"comment\"># 为该任务打一个install_httpd的标签</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">copy</span> <span class=\"string\">b.sh</span>                          <span class=\"comment\"># 又一个复制b.sh脚本的任务</span></span><br><span class=\"line\"><span class=\"attr\">         copy:</span> <span class=\"string\">src=/root/&#123;&#123;</span> <span class=\"string\">bsh</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">dest=/root/</span> <span class=\"string\">owner=ala</span> <span class=\"string\">group=ala</span> <span class=\"string\">mode=0644</span></span><br><span class=\"line\"><span class=\"attr\">         notify:</span>                                  <span class=\"comment\"># 如果copy的文件内容发生改变就会触发</span></span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"string\">reload</span> <span class=\"string\">httpd</span>                         <span class=\"comment\"># 指定通知的哪个handlers</span></span><br><span class=\"line\"><span class=\"attr\">         when:</span> <span class=\"string\">ansible_distribution</span> <span class=\"string\">==</span> <span class=\"string\">\"CentOS\"</span>   <span class=\"comment\"># 通过变量判断系统为CentOS时才执行该copy任务</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">copy</span> <span class=\"string\">b.sh</span>                          </span><br><span class=\"line\"><span class=\"attr\">         copy:</span> <span class=\"string\">src=/root/&#123;&#123;</span> <span class=\"string\">bsh</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">dest=/opt/</span> <span class=\"string\">owner=ala</span> <span class=\"string\">group=ala</span> <span class=\"string\">mode=0644</span></span><br><span class=\"line\"><span class=\"attr\">         notify:</span>                                  </span><br><span class=\"line\"><span class=\"bullet\">           -</span> <span class=\"string\">reload</span> <span class=\"string\">httpd</span>                         </span><br><span class=\"line\"><span class=\"attr\">         when:</span> <span class=\"string\">ansible_distribution</span> <span class=\"string\">==</span> <span class=\"string\">\"Ubuntu\"</span>   <span class=\"comment\"># 通过变量判断系统为Ubuntu时才执行该copy任务</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">start</span> <span class=\"string\">httpd</span>                        <span class=\"comment\"># 又一个启动httpd服务的任务</span></span><br><span class=\"line\"><span class=\"attr\">         service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=started</span> <span class=\"string\">enabled=yes</span></span><br><span class=\"line\"><span class=\"attr\">     handlers:</span>                                    <span class=\"comment\"># 满足触发条件则执行的任务</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">reload</span> <span class=\"string\">httpd</span>                       <span class=\"comment\"># 满足触发条件的任务名</span></span><br><span class=\"line\"><span class=\"attr\">         service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=reloaded</span>       <span class=\"comment\"># 该任务为重新加载一下httpd服务</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>其中的<code>ansible_distribution</code>是ansible收集的facts变量。</p>\n</blockquote>\n<h2 id=\"playbook定义变量\"><a href=\"#playbook定义变量\" class=\"headerlink\" title=\"playbook定义变量\"></a>playbook定义变量</h2><p><strong> ansible 常见定义变量有以下 6 种</strong></p>\n<ul>\n<li>/etc/ansible/hosts文件主机中定义</li>\n<li>/etc/ansible/hosts/文件主机组中定义</li>\n<li>playbook的yaml文件中通过vars定义</li>\n<li>获取系统变量，也称facts变量</li>\n<li>分文件定义主机和主机组的变量</li>\n<li>playbook 的role中定义</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /etc/ansible/hosts文件主机中定义 主机变量</span></span><br><span class=\"line\">192.168.200.136 http_port=808 maxRequestsPerChild=808</span><br><span class=\"line\">192.168.200.137 http_port=8080 maxRequestsPerChild=909</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\"># /etc/ansible/hosts文件主机中定义 主机组变量</span></span><br><span class=\"line\">[websers]</span><br><span class=\"line\">192.168.200.136</span><br><span class=\"line\">192.168.200.137</span><br><span class=\"line\"> </span><br><span class=\"line\">[websers:vars]  </span><br><span class=\"line\">ntp_server=ntp.exampl.com</span><br><span class=\"line\">proxy=proxy.exampl.com                <span class=\"comment\"># ntp_server和proxy变量可为websers组中主机使用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># playbook的yaml文件中通过vars定义</span></span><br><span class=\"line\"> ---</span><br><span class=\"line\">    - hosts: <span class=\"built_in\">test</span>                                  </span><br><span class=\"line\">      remote_user: root                            </span><br><span class=\"line\">      vars:                           <span class=\"comment\"># 定义bsh和httprpm的两个变量</span></span><br><span class=\"line\">        - bsh: b.sh</span><br><span class=\"line\">        - httprpm: httpd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取系统facts变量</span></span><br><span class=\"line\">ansible 192.168.200.136 -m setup      <span class=\"comment\"># 可以获取主机所有的facts变量，通过&#123;&#123;variable_name&#125;&#125;引用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 分文件定义主机和主机组的变量</span></span><br><span class=\"line\">/etc/ansible/group_vars/websers       <span class=\"comment\"># 定义主机组名为websers的变量文件</span></span><br><span class=\"line\">/etc/ansible/host_vars/hostpc         <span class=\"comment\"># 定义主机名为hostpc的变量文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ cat /etc/ansible/host_vars/hostpc   <span class=\"comment\"># 变量文件内容格式如下</span></span><br><span class=\"line\">---</span><br><span class=\"line\">ntp_server: acme.example.org</span><br><span class=\"line\">database_server: storage.example.org</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># role中定义   （目录结构下文讲述）</span></span><br><span class=\"line\">$ cat /etc/ansible/roles/nginx/vars/main.yml</span><br><span class=\"line\">---</span><br><span class=\"line\">nginx_port: 80</span><br><span class=\"line\">nginx_domain: www.abc.com</span><br><span class=\"line\">nginx_user: nginx</span><br></pre></td></tr></table></figure>\n<h2 id=\"playbook-role目录结构\"><a href=\"#playbook-role目录结构\" class=\"headerlink\" title=\"playbook role目录结构\"></a>playbook role目录结构</h2><h3 id=\"Roles简介\"><a href=\"#Roles简介\" class=\"headerlink\" title=\"Roles简介\"></a>Roles简介</h3><p>Ansible为了层次化、结构化地组织Playbook，使用了角色（roles）。Roles能够根据层次型结构自动装载变量文件、task及handlers等。简单来讲，roles就是通过分别将变量、文件、任务、模块及处理器放置于单独的目录中，并可以便捷地include它们，roles一般用于基于主机构建服务的场景中，但也可以用于构建守护进程等场景中。</p>\n<h3 id=\"创建Roles\"><a href=\"#创建Roles\" class=\"headerlink\" title=\"创建Roles\"></a>创建Roles</h3><p>创建roles时一般需要以下步骤：首先创建以roles命名的目录。然后在roles目标下分别创建以这个角色名称命令的目录，如websevers等，然后在每个角色命令的目录中分别创建files、handlers、tasks、templates、meta、defaults和vars目录，用不到的目录可以创建为空目录。最后在Playbook文件中调用各角色进行使用。</p>\n<h3 id=\"roles内各目录含义解释\"><a href=\"#roles内各目录含义解释\" class=\"headerlink\" title=\"roles内各目录含义解释\"></a>roles内各目录含义解释</h3><ul>\n<li><code>files</code>：用来存放由copy模块或script模块调用的文件。</li>\n<li><code>templates</code>：用来存放jinjia2模板，template模块会自动在此目录中寻找jinjia2模板文件。</li>\n<li><code>tasks</code>：此目录应当包含一个main.yml文件，用于定义此角色的任务列表，此文件可以使用include包含其它的位于此目录的task文件。</li>\n<li><code>handlers</code>：此目录应当包含一个main.yml文件，用于定义此角色中触发条件时执行的动作。</li>\n<li><code>vars</code>：此目录应当包含一个main.yml文件，用于定义此角色用到的变量。</li>\n<li><code>defaults</code>：此目录应当包含一个main.yml文件，用于为当前角色设定默认变量。</li>\n<li><code>meta</code>：此目录应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系。</li>\n</ul>\n<p>如下定义了一个nginx服务的playbook目录结构树。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@k8s-master1 roles]<span class=\"comment\"># tree /etc/ansible/roles/nginx</span></span><br><span class=\"line\">/etc/ansible/roles/nginx</span><br><span class=\"line\">├── defaults</span><br><span class=\"line\">│   └── main.yml</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── nginx.tar.gz</span><br><span class=\"line\">├── handlers</span><br><span class=\"line\">│   └── main.yml</span><br><span class=\"line\">├── meta</span><br><span class=\"line\">│   └── main.yml</span><br><span class=\"line\">├── tasks</span><br><span class=\"line\">│   └── main.yml</span><br><span class=\"line\">├── templates</span><br><span class=\"line\">│   └── nginx.conf.j2</span><br><span class=\"line\">│   └── default.conf.j2</span><br><span class=\"line\">└── vars</span><br><span class=\"line\">    └── main.yml</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"使用roles安装nginx案例\"><a href=\"#使用roles安装nginx案例\" class=\"headerlink\" title=\"使用roles安装nginx案例\"></a>使用roles安装nginx案例</h2><h3 id=\"实例环境\"><a href=\"#实例环境\" class=\"headerlink\" title=\"实例环境\"></a>实例环境</h3><table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>IP</th>\n<th>系统</th>\n<th>角色</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ansible</td>\n<td>192.168.20.210</td>\n<td>centos7.5</td>\n<td>ansible控制器</td>\n</tr>\n<tr>\n<td>web-nginx</td>\n<td>192.168.20.213</td>\n<td>centos7.5</td>\n<td>web服务器 </td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"hosts主机组清单\"><a href=\"#hosts主机组清单\" class=\"headerlink\" title=\"hosts主机组清单\"></a>hosts主机组清单</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansilbe/hosts          <span class=\"comment\"># ansible hosts主机组配置</span></span><br><span class=\"line\">  [web-node]</span><br><span class=\"line\">  192.168.20.213</span><br></pre></td></tr></table></figure>\n<h3 id=\"生成ssh密钥\"><a href=\"#生成ssh密钥\" class=\"headerlink\" title=\"生成ssh密钥\"></a>生成ssh密钥</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在ansible控制机上生成ssh密钥对</span></span><br><span class=\"line\"> </span><br><span class=\"line\">$ ssh-keygen -t rsa</span><br><span class=\"line\">Generating public/private rsa key pair.</span><br><span class=\"line\">Enter file <span class=\"keyword\">in</span> <span class=\"built_in\">which</span> to save the key (/root/.ssh/id_rsa): </span><br><span class=\"line\">Enter passphrase (empty <span class=\"keyword\">for</span> no passphrase): </span><br><span class=\"line\">Enter same passphrase again: </span><br><span class=\"line\">Your identification has been saved <span class=\"keyword\">in</span> /root/.ssh/id_rsa.</span><br><span class=\"line\">Your public key has been saved <span class=\"keyword\">in</span> /root/.ssh/id_rsa.pub.</span><br><span class=\"line\">The key fingerprint is:</span><br><span class=\"line\">SHA256:m4+23Eh+dJ8r/9zSjpUbHJECh1iFQU8Z0QMlygrRm98 root@k8s-node1</span><br><span class=\"line\">The key<span class=\"string\">'s randomart image is:</span></span><br><span class=\"line\"><span class=\"string\">+---[RSA 2048]----+</span></span><br><span class=\"line\"><span class=\"string\">|       .. +==OB. |</span></span><br><span class=\"line\"><span class=\"string\">|        .o.o*..o.|</span></span><br><span class=\"line\"><span class=\"string\">|       .  oo o o.|</span></span><br><span class=\"line\"><span class=\"string\">|        .o.   . .|</span></span><br><span class=\"line\"><span class=\"string\">|        S.. .  . |</span></span><br><span class=\"line\"><span class=\"string\">|         o...E. o|</span></span><br><span class=\"line\"><span class=\"string\">|        +. . . *.|</span></span><br><span class=\"line\"><span class=\"string\">|       +.=. . ++=|</span></span><br><span class=\"line\"><span class=\"string\">|       .*oo  o+*=|</span></span><br><span class=\"line\"><span class=\"string\">+----[SHA256]-----+</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># 复制ansible控制机上的公钥到nginx web服务器</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">$ ssh-copy-id -i ~/.ssh/id_rsa.pub 192.168.20.213</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">这里是root用户验证，输入完root密码后，就可以在ansible主机上无密码ssh登陆nginx web服务器了。</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"创建nginx的roles结构目录\"><a href=\"#创建nginx的roles结构目录\" class=\"headerlink\" title=\"创建nginx的roles结构目录\"></a>创建nginx的roles结构目录</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir -pv /etc/ansible/roles/nginx/&#123;defaults,files,handlers,meta,tasks,templates,vars&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"准备安装包和依赖包\"><a href=\"#准备安装包和依赖包\" class=\"headerlink\" title=\"准备安装包和依赖包\"></a>准备安装包和依赖包</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /etc/ansible/roles/nginx/files</span><br><span class=\"line\">$ wget http://nginx.org/download/nginx-1.16.0.tar.gz</span><br><span class=\"line\">$ wget https://www.openssl.org/<span class=\"built_in\">source</span>/openssl-1.0.2r.tar.gz</span><br><span class=\"line\">$ wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.42.tar.gz</span><br><span class=\"line\">$ wget http://www.zlib.net/zlib-1.2.11.tar.gz</span><br></pre></td></tr></table></figure>\n<h3 id=\"准备安装脚本\"><a href=\"#准备安装脚本\" class=\"headerlink\" title=\"准备安装脚本\"></a>准备安装脚本</h3><blockquote>\n<p>该脚本已在手动安装测试过，建议各位在通过ansible playbook安装服务器前，先手动安装一遍确保无误。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx/files/install_nginx.sh</span><br><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"><span class=\"comment\">#info: source code install nginx 1.16.0</span></span><br><span class=\"line\"><span class=\"comment\">#author: pyker &lt;pyker@qq.com&gt;</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> PATH=`<span class=\"built_in\">echo</span> <span class=\"variable\">$PATH</span>`</span><br><span class=\"line\">PWD=<span class=\"string\">\"/opt\"</span></span><br><span class=\"line\">NGINX=nginx-1.16.0</span><br><span class=\"line\">OPENSSL=openssl-1.0.2r</span><br><span class=\"line\">PCRE=pcre-8.42</span><br><span class=\"line\">ZLIB=zlib-1.2.11</span><br><span class=\"line\">RUN_USER=nginx</span><br><span class=\"line\">id -u <span class=\"variable\">$&#123;RUN_USER&#125;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class=\"line\">[ $? -ne 0 ] &amp;&amp; useradd -M -s /sbin/nologin <span class=\"variable\">$&#123;RUN_USER&#125;</span></span><br><span class=\"line\">mkdir -p /var/<span class=\"built_in\">log</span>/nginx</span><br><span class=\"line\">yum install -y epel-release </span><br><span class=\"line\">yum install -y jemalloc jemalloc-devel</span><br><span class=\"line\">yum install -y gcc \\</span><br><span class=\"line\">             gcc-c++ \\</span><br><span class=\"line\">             gcc++ \\</span><br><span class=\"line\">             perl \\</span><br><span class=\"line\">             perl-devel \\</span><br><span class=\"line\">             perl-ExtUtils-Embed \\</span><br><span class=\"line\">             libxslt \\</span><br><span class=\"line\">             libxslt-devel \\</span><br><span class=\"line\">             libxml2 \\</span><br><span class=\"line\">             libxml2-devel \\</span><br><span class=\"line\">             gd \\</span><br><span class=\"line\">             gd-devel \\</span><br><span class=\"line\">             GeoIP \\</span><br><span class=\"line\">             GeoIP-devel</span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$PWD</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> tar <span class=\"keyword\">in</span> `ls *.tar.gz`; <span class=\"keyword\">do</span></span><br><span class=\"line\">  tar zxf <span class=\"variable\">$tar</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$PWD</span>/<span class=\"variable\">$NGINX</span> &amp;&amp; ./configure --prefix=/usr/<span class=\"built_in\">local</span>/nginx \\</span><br><span class=\"line\">            --sbin-path=/usr/sbin/nginx \\</span><br><span class=\"line\">            --user=nginx \\</span><br><span class=\"line\">            --group=nginx \\</span><br><span class=\"line\">            --pid-path=/var/run/nginx.pid \\</span><br><span class=\"line\">            --lock-path=/var/run/nginx.lock \\</span><br><span class=\"line\">            --error-log-path=/var/<span class=\"built_in\">log</span>/nginx/error.log \\</span><br><span class=\"line\">            --http-log-path=/var/<span class=\"built_in\">log</span>/nginx/access.log \\</span><br><span class=\"line\">            --with-select_module \\</span><br><span class=\"line\">            --with-poll_module \\</span><br><span class=\"line\">            --with-threads \\</span><br><span class=\"line\">            --with-file-aio \\</span><br><span class=\"line\">            --with-http_ssl_module \\</span><br><span class=\"line\">            --with-http_v2_module \\</span><br><span class=\"line\">            --with-http_realip_module \\</span><br><span class=\"line\">            --with-http_addition_module \\</span><br><span class=\"line\">            --with-http_xslt_module=dynamic \\</span><br><span class=\"line\">            --with-http_image_filter_module=dynamic \\</span><br><span class=\"line\">            --with-http_geoip_module=dynamic \\</span><br><span class=\"line\">            --with-http_sub_module \\</span><br><span class=\"line\">            --with-http_dav_module \\</span><br><span class=\"line\">            --with-http_flv_module \\</span><br><span class=\"line\">            --with-http_mp4_module \\</span><br><span class=\"line\">            --with-http_gunzip_module \\</span><br><span class=\"line\">            --with-http_gzip_static_module \\</span><br><span class=\"line\">            --with-http_auth_request_module \\</span><br><span class=\"line\">            --with-http_random_index_module \\</span><br><span class=\"line\">            --with-http_secure_link_module \\</span><br><span class=\"line\">            --with-http_degradation_module \\</span><br><span class=\"line\">            --with-http_slice_module \\</span><br><span class=\"line\">            --with-http_stub_status_module \\</span><br><span class=\"line\">            --with-mail=dynamic \\</span><br><span class=\"line\">            --with-mail_ssl_module \\</span><br><span class=\"line\">            --with-stream \\</span><br><span class=\"line\">            --with-stream_ssl_module \\</span><br><span class=\"line\">            --with-stream_realip_module \\</span><br><span class=\"line\">            --with-stream_geoip_module=dynamic \\</span><br><span class=\"line\">            --with-stream_ssl_preread_module \\</span><br><span class=\"line\">            --with-compat \\</span><br><span class=\"line\">            --with-ld-opt=<span class=\"string\">\"-ljemalloc\"</span> \\</span><br><span class=\"line\">            --with-pcre=../<span class=\"variable\">$&#123;PCRE&#125;</span> \\</span><br><span class=\"line\">            --with-pcre-jit \\</span><br><span class=\"line\">            --with-zlib=../<span class=\"variable\">$&#123;ZLIB&#125;</span> \\</span><br><span class=\"line\">            --with-openssl=../<span class=\"variable\">$&#123;OPENSSL&#125;</span>\\</span><br><span class=\"line\">            --with-openssl-opt=no-nextprotoneg \\</span><br><span class=\"line\">            --with-debug &amp;&amp; make -j 4 &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n<h3 id=\"配置变量\"><a href=\"#配置变量\" class=\"headerlink\" title=\"配置变量\"></a>配置变量</h3><p> 在安装nginx的时候或者其他服务的时候常常用到变量，下面配置变量是通过roles方式配置。<br> <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx/vas/main.yml</span><br><span class=\"line\">cat nginx/vars/main.yml </span><br><span class=\"line\">nginx_user: nginx</span><br><span class=\"line\">nginx_port: 80</span><br><span class=\"line\">nginx_dir: /usr/<span class=\"built_in\">local</span>/nginx</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"准备nginx-conf模版\"><a href=\"#准备nginx-conf模版\" class=\"headerlink\" title=\"准备nginx.conf模版\"></a>准备nginx.conf模版</h3> <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx/templates/nginx.conf.j2</span><br><span class=\"line\">user &#123;&#123; nginx_user &#125;&#125;;</span><br><span class=\"line\">worker_processes &#123;&#123; ansible_processor_vcpus &#125;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">error_log /var/<span class=\"built_in\">log</span>/nginx/error_nginx.log crit;</span><br><span class=\"line\">pid /var/run/nginx.pid;</span><br><span class=\"line\">worker_rlimit_nofile 51200;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">  use epoll;</span><br><span class=\"line\">  worker_connections 51200;</span><br><span class=\"line\">  multi_accept on;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">  map <span class=\"variable\">$http_upgrade</span> <span class=\"variable\">$connection_upgrade</span> &#123;</span><br><span class=\"line\">    default upgrade;</span><br><span class=\"line\">    <span class=\"string\">''</span>      close;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  include mime.types;</span><br><span class=\"line\">  default_type application/octet-stream;</span><br><span class=\"line\">  server_names_hash_bucket_size 128;</span><br><span class=\"line\">  client_header_buffer_size 32k;</span><br><span class=\"line\">  large_client_header_buffers 4 32k;</span><br><span class=\"line\">  client_max_body_size 1024m;</span><br><span class=\"line\">  client_body_buffer_size 10m;</span><br><span class=\"line\">  sendfile on;</span><br><span class=\"line\">  tcp_nopush on;</span><br><span class=\"line\">  keepalive_timeout 120;</span><br><span class=\"line\">  server_tokens off;</span><br><span class=\"line\">  tcp_nodelay on;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#Gzip Compression</span></span><br><span class=\"line\">  gzip on;</span><br><span class=\"line\">  gzip_buffers 16 8k;</span><br><span class=\"line\">  gzip_comp_level 6;</span><br><span class=\"line\">  gzip_http_version 1.1;</span><br><span class=\"line\">  gzip_min_length 256;</span><br><span class=\"line\">  gzip_proxied any;</span><br><span class=\"line\">  gzip_vary on;</span><br><span class=\"line\">  gzip_types</span><br><span class=\"line\">    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml</span><br><span class=\"line\">    text/javascript application/javascript application/x-javascript</span><br><span class=\"line\">    text/x-json application/json application/x-web-app-manifest+json</span><br><span class=\"line\">    text/css text/plain text/x-component</span><br><span class=\"line\">    font/opentype application/x-font-ttf application/vnd.ms-fontobject</span><br><span class=\"line\">    image/x-icon;</span><br><span class=\"line\">  gzip_disable <span class=\"string\">\"MSIE [1-6]\\.(?!.*SV1)\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#If you have a lot of static files to serve through Nginx then caching of the files' metadata (not the actual files' contents) can save some latency.</span></span><br><span class=\"line\">  open_file_cache max=1000 inactive=20s;</span><br><span class=\"line\">  open_file_cache_valid 30s;</span><br><span class=\"line\">  open_file_cache_min_uses 2;</span><br><span class=\"line\">  open_file_cache_errors on;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">########################## vhost #############################</span></span><br><span class=\"line\">  include upstream/*.conf;</span><br><span class=\"line\">  include vhost/*.conf;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>nginx.conf.j2文件中<code>nginx_user</code>和<code>ansible_processor_vcpus</code>分别为用户自定义变量和<code>-m setup</code>获取的facts。</p>\n</blockquote>\n<h3 id=\"定义默认server模版\"><a href=\"#定义默认server模版\" class=\"headerlink\" title=\"定义默认server模版\"></a>定义默认server模版</h3> <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> ```bash</span><br><span class=\"line\">$ cat /etc/ansible/roles/nginx/templates/default.conf.j2</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen &#123;&#123; nginx_port &#125;&#125;;</span><br><span class=\"line\">        server_name &#123;&#123; ansible_all_ipv4_addresses &#125;&#125;;</span><br><span class=\"line\">        index index.html index.htm index.jsp index.do;</span><br><span class=\"line\">        access_log  off;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            root /data/wwwroot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">         location /nginx_status &#123;</span><br><span class=\"line\">            stub_status on;</span><br><span class=\"line\">            access_log   off;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>default.conf.j2文件中<code>nginx_port</code>和<code>ansible_all_ipv4_addresses</code>分别为用户自定义变量和<code>-m setup</code>获取的facts。</p>\n</blockquote>\n<h3 id=\"定义一个测试index-html文件\"><a href=\"#定义一个测试index-html文件\" class=\"headerlink\" title=\"定义一个测试index.html文件\"></a>定义一个测试index.html文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx/templates/index.html</span><br><span class=\"line\"> this is <span class=\"built_in\">test</span> pages!</span><br></pre></td></tr></table></figure>\n<h3 id=\"定义nginx启动脚本\"><a href=\"#定义nginx启动脚本\" class=\"headerlink\" title=\"定义nginx启动脚本\"></a>定义nginx启动脚本</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx/files/nginx.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=The NGINX HTTP and reverse proxy server</span><br><span class=\"line\">After=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">PIDFile=/var/run/nginx.pid</span><br><span class=\"line\">ExecStartPre=/usr/sbin/nginx -t</span><br><span class=\"line\">ExecStart=/usr/sbin/nginx</span><br><span class=\"line\">ExecReload=/usr/sbin/nginx -s reload</span><br><span class=\"line\">ExecStop=/usr/bin/<span class=\"built_in\">kill</span> -s QUIT <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\">PrivateTmp=<span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n<h3 id=\"定义tasks任务\"><a href=\"#定义tasks任务\" class=\"headerlink\" title=\"定义tasks任务\"></a>定义tasks任务</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在tasks目录中定义了一个copy.yaml文件用户复制files目录下的文件到nginx服务器</span></span><br><span class=\"line\"><span class=\"comment\"># 定义完成后，需要在tasks/main.yaml文件中用-include包含该copy.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">cat</span> <span class=\"string\">/etc/ansible/roles/nginx/tasks/copy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">copy</span> <span class=\"string\">nginx-1.16.0.tar.gz</span> <span class=\"string\">to</span> <span class=\"string\">client</span></span><br><span class=\"line\"><span class=\"attr\">  copy:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/files/nginx-1.16.0.tar.gz</span> <span class=\"string\">dest=/opt/nginx-1.16.0.tar.gz</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">copy</span> <span class=\"string\">install_nginx.sh</span> <span class=\"string\">to</span> <span class=\"string\">client</span></span><br><span class=\"line\"><span class=\"attr\">  copy:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/files/install_nginx.sh</span> <span class=\"string\">dest=/opt/install_nginx.sh</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">mkdir</span> <span class=\"string\">nginx</span> <span class=\"string\">data</span> <span class=\"string\">directory</span></span><br><span class=\"line\"><span class=\"attr\">  file:</span> <span class=\"string\">path=/data/wwwroot</span> <span class=\"string\">state=directory</span> <span class=\"string\">recurse=yes</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">copy</span> <span class=\"string\">index.html</span></span><br><span class=\"line\"><span class=\"attr\">  copy:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/files/index.html</span> <span class=\"string\">dest=/data/wwwroot/index.html</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">copy</span> <span class=\"string\">nginx</span> <span class=\"string\">systemctl</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">  copy:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/files/nginx.service</span> <span class=\"string\">dest=/usr/lib/systemd/system/nginx.service</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">copy</span> <span class=\"string\">dependency</span> <span class=\"string\">package</span></span><br><span class=\"line\"><span class=\"attr\">  copy:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/files/&#123;&#123;</span> <span class=\"string\">item</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">dest=/opt/&#123;&#123;</span> <span class=\"string\">item</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">  with_items:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">openssl-1.0.2r.tar.gz</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">pcre-8.42.tar.gz</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">zlib-1.2.11.tar.gz</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义main.yaml文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">cat</span> <span class=\"string\">/etc/ansible/roles/nginx/tasks/main.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- include:</span> <span class=\"string\">copy.yml</span>       <span class=\"comment\"># 使用include将上面copy.yaml文件包含进来</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">install</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  shell:</span> <span class=\"string\">/usr/bin/sh</span> <span class=\"string\">/opt/install_nginx.sh</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">replace</span> <span class=\"string\">nginx.conf</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/templates/nginx.conf.j2</span> <span class=\"string\">dest=&#123;&#123;</span> <span class=\"string\">nginx_dir</span> <span class=\"string\">&#125;&#125;/conf/nginx.conf</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">mkdir</span> <span class=\"string\">nginx</span> <span class=\"string\">vhost</span> <span class=\"string\">directory</span></span><br><span class=\"line\"><span class=\"attr\">  file:</span> <span class=\"string\">path=&#123;&#123;nginx_dir&#125;&#125;/conf/vhost</span> <span class=\"string\">state=directory</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">relpace</span> <span class=\"string\">default.conf</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span> <span class=\"string\">src=/etc/ansible/roles/nginx/templates/default.conf.j2</span> <span class=\"string\">dest=&#123;&#123;nginx_dir&#125;&#125;/conf/vhost/default.conf</span></span><br><span class=\"line\"><span class=\"attr\">  tags:</span> <span class=\"string\">ngxdef</span>            <span class=\"comment\"># 定义一个tag，当default.conf发生改变时可以指定运行该任务</span></span><br><span class=\"line\"><span class=\"attr\">  notify:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">reload</span> <span class=\"string\">nginx</span>        <span class=\"comment\"># 该名称需要和handler中定义的一样</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">start</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  command:</span> <span class=\"string\">/usr/sbin/nginx</span> <span class=\"comment\"># 由于配置了nginx启动服务，也可以使用 shell: systemctl start nginx</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"定义触发通知handlers\"><a href=\"#定义触发通知handlers\" class=\"headerlink\" title=\"定义触发通知handlers\"></a>定义触发通知handlers</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">cat</span> <span class=\"string\">/etc/ansible/roles/nginx/handlers/main.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">reload</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  shell:</span> <span class=\"string\">/usr/sbin/nginx</span> <span class=\"bullet\">-t;</span> <span class=\"string\">/usr/sbin/nginx</span> <span class=\"bullet\">-s</span> <span class=\"string\">reload</span>  <span class=\"comment\"># 也可以使用 shell: systemctl reload nginx</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"定义role入口文件\"><a href=\"#定义role入口文件\" class=\"headerlink\" title=\"定义role入口文件\"></a>定义role入口文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/ansible/roles/nginx.yml </span><br><span class=\"line\">---</span><br><span class=\"line\">- hosts: web-node      <span class=\"comment\"># 定义要执行该playbook的主机组</span></span><br><span class=\"line\">  remote_user: root    <span class=\"comment\"># 定义远程执行命令的用户</span></span><br><span class=\"line\">  roles:               <span class=\"comment\"># </span></span><br><span class=\"line\">    - nginx            <span class=\"comment\"># 主机组中的主机使用哪个playbook剧本</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"查看当前nginx-roles目录树结构\"><a href=\"#查看当前nginx-roles目录树结构\" class=\"headerlink\" title=\"查看当前nginx roles目录树结构\"></a>查看当前nginx roles目录树结构</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tree /etc/ansible/roles/</span><br><span class=\"line\">/etc/ansible/roles/</span><br><span class=\"line\">├── nginx</span><br><span class=\"line\">│   ├── defaults</span><br><span class=\"line\">│   ├── files</span><br><span class=\"line\">│   │   ├── index.html</span><br><span class=\"line\">│   │   ├── nginx.service</span><br><span class=\"line\">│   │   ├── install_nginx.sh</span><br><span class=\"line\">│   │   ├── nginx-1.16.0.tar.gz</span><br><span class=\"line\">│   │   ├── openssl-1.0.2r.tar.gz</span><br><span class=\"line\">│   │   ├── pcre-8.42.tar.gz</span><br><span class=\"line\">│   │   └── zlib-1.2.11.tar.gz</span><br><span class=\"line\">│   ├── handlers</span><br><span class=\"line\">│   │   └── main.yml</span><br><span class=\"line\">│   ├── meta</span><br><span class=\"line\">│   ├── tasks</span><br><span class=\"line\">│   │   ├── copy.yml</span><br><span class=\"line\">│   │   └── main.yml</span><br><span class=\"line\">│   ├── templates</span><br><span class=\"line\">│   │   ├── default.conf.j2</span><br><span class=\"line\">│   │   └── nginx.conf.j2</span><br><span class=\"line\">│   └── vars</span><br><span class=\"line\">│       └── main.yml</span><br><span class=\"line\">└── nginx.yml</span><br></pre></td></tr></table></figure>\n<h3 id=\"playbook语法检测\"><a href=\"#playbook语法检测\" class=\"headerlink\" title=\"playbook语法检测\"></a>playbook语法检测</h3><p>通过上面的配置，我们已经完成了使用playbook方式安装nginx所需要的步骤，现在我们应该在执行该playbook前检查一下上述语法有没有错误。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible-playbook --syntax-check /etc/ansible/roles/nginx.yml </span><br><span class=\"line\"></span><br><span class=\"line\">playbook: /etc/ansible/roles/nginx.yml  <span class=\"comment\"># 如果语法没问题，将直接显示文件名称，如果有错误将告知你那里错了</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"测试安装\"><a href=\"#测试安装\" class=\"headerlink\" title=\"测试安装\"></a>测试安装</h3><p><code>ansible-playbook -C</code> 命令可以测试运行playbook剧本，而非真正在远端服务器上执行，这样可以方便查看playbook在执行过程中将会做哪些事情。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible-playbook -C nginx.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [web-node] ************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : copy nginx-1.16.0.tar.gz to client] **************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : copy install_nginx.sh to client] *****************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : mkdir nginx data directory] **********************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : copy index.html] *********************************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : copy nginx systemctl file] ***********************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : copy dependency package] *************************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213] =&gt; (item=openssl-1.0.2r.tar.gz)</span><br><span class=\"line\">changed: [192.168.20.213] =&gt; (item=pcre-8.42.tar.gz)</span><br><span class=\"line\">changed: [192.168.20.213] =&gt; (item=zlib-1.2.11.tar.gz)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : install nginx] ***********************************************************************************************************************************</span><br><span class=\"line\">skipping: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : replace nginx.conf file] *************************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : mkdir nginx vhost directory] *********************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : relpace default.conf file] ***********************************************************************************************************************</span><br><span class=\"line\">changed: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [nginx : start nginx] *************************************************************************************************************************************</span><br><span class=\"line\">skipping: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [nginx : reload nginx] *************************************************************************************************************************</span><br><span class=\"line\">skipping: [192.168.20.213]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *****************************************************************************************************************************************************</span><br><span class=\"line\">192.168.20.213             : ok=8    changed=8    unreachable=0    failed=0</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"运行nginx-playbook\"><a href=\"#运行nginx-playbook\" class=\"headerlink\" title=\"运行nginx playbook\"></a>运行nginx playbook</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ansible-playbook nginx.yml</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>执行<code>ansible-playbook nginx.yml</code>命令后，ansible将会按照刚刚测试安装的步骤在远端进行安装nginx服务并且启动。</p>\n</blockquote>\n<h3 id=\"验证安装结果\"><a href=\"#验证安装结果\" class=\"headerlink\" title=\"验证安装结果\"></a>验证安装结果</h3><p>等待一会nginx playbook将会在远端服务器上安装完毕，现在我们来验证一下结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在web服务器上查看nginx端口</span></span><br><span class=\"line\">$ netstat -ptln | grep 80</span><br><span class=\"line\">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      14461/nginx: master</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看nginx进程</span></span><br><span class=\"line\">$ ps -ef | grep nginx</span><br><span class=\"line\">root      14461      1  0 00:39 ?        00:00:00 nginx: master process /usr/sbin/nginx</span><br><span class=\"line\">nginx     14474  14461  0 00:39 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">nginx     14475  14461  0 00:39 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">nginx     14476  14461  0 00:39 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">nginx     14477  14461  0 00:39 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">root      39501   1664  0 11:38 pts/0    00:00:00 grep --color=auto nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 让我们在内网任意一台电脑上来访问一下该nginx页面</span></span><br><span class=\"line\">$ curl http://192.168.20.213</span><br><span class=\"line\">this is a <span class=\"built_in\">test</span> pages!       <span class=\"comment\"># 结果是我们前面定义的index.html内容</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 访问一下nginx_status的uri</span></span><br><span class=\"line\">$ curl http://192.168.20.213/nginx_status     <span class=\"comment\">#前面default.conf.j2文件中定义的nginx location</span></span><br><span class=\"line\">Active connections: 1 </span><br><span class=\"line\">server accepts handled requests</span><br><span class=\"line\"> 8 8 10 </span><br><span class=\"line\">Reading: 0 Writing: 1 Waiting: 0</span><br></pre></td></tr></table></figure></p>\n<p>至此，一个使用ansible-playbook安装nginx服务已完成。</p>\n"},{"layout":"post","title":"Elastic Stack之Filebeat7.0详解","author":"Pyker","img":"/images/bar/beats.png","top":false,"cover":false,"date":"2019-03-14T04:10:00.000Z","_content":"## 一：认识Filebeat\n* `Filebeat`是beats其中一个组件，它是一个`轻量型日志采集器`，可以直接（或者通过Logstash）将数据发送到Elasticsearch，在那里你可以进一步处理和增强数据，然后在Kibana中将其可视化。\n\n* 当您要面对成百上千、甚至成千上万的服务器、虚拟机和容器生成的日志时，请告别 SSH 吧。Filebeat 将为您提供一种轻量型方法，用于转发和汇总日志与文件，让简单的事情不再繁杂。\n\n* 它性能稳健，不错过任何检测信号，无论在任何环境中，随时都潜伏着应用程序中断的风险。Filebeat 能够读取并转发日志行，如果出现中断，还会在一切恢复正常后，从中断前停止的位置继续开始。\n\n* `Filebeat` 内置有多种模块（auditd、Apache、NGINX、System、MySQL 等等），可针对常见格式的日志大大简化收集、解析和可视化过程，只需一条命令即可。之所以能实现这一点，是因为它将自动默认路径（因操作系统而异）与 Elasticsearch 采集节点管道的定义和 Kibana 仪表板组合在一起。不仅如此，数个 Filebeat 模块还包括预配置的 Machine Learning 任务。\n\n## 二：Filebeat工作原理\nFilebeat由两个主要组件组成：`inputs` 和 `harvesters`（直译：收割机，采集器）。这些组件一起工作以跟踪文件，并将事件数据发送到你指定的输出。\n### 2.1 harvester是什么\n一个`harvester`负责读取一个单个文件的内容。harvester逐行读取每个文件（一行一行地读取每个文件），并把这些内容发送到输出。每个文件启动一个harvester负责打开和关闭这个文件，这就意味着在harvester运行时文件描述符保持打开状态。而在harvester正在读取文件内容的时候，文件被删除或者重命名了，那么Filebeat会继续读这个文件。这就有一个问题了，就是只要负责这个文件的harvester没用关闭，那么磁盘空间就不会释放。默认情况下，Filebeat保存文件打开直到close_inactive到达。\n### 2.2 input是什么\n一个`input`负责管理当前的harvesters，并找到所有要读取的源。如果input类型是log，则input查找paths已定义的glob路径匹配的所有日志文件，并为每个文件启动一个harvester。\n下面的例子配置Filebeat从所有匹配指定的glob模式的文件中读取行：\n```yaml\nfilebeat.inputs:\n- type: log\n  paths:\n    - /var/log/*.log\n    - /var/path2/*.log\n```\n### 2.3 Filebeat如何保持文件状态\nFilebeat保存每个文件的状态，并经常刷新状态到磁盘上的注册文件（registry）。状态用于记住harvester读取文件的最后一个偏移量（行），并确保所有日志行被发送到输出（如Elasticsearch 或者 Logstash等），当输出无法访问时，那么Filebeat会跟踪已经发送的最后一行，并只要输出再次变得可用时继续读取文件。当Filebeat运行时，会将每个文件的状态新保存在内存中。当Filebeat重新启动时，将使用注册文件中的数据重新构建状态，Filebeat将在最后一个已知行位置继续每个harvester。对于每个输入，Filebeat保存它找到的每个文件的状态。因为文件可以重命名或移动，所以文件名和路径不足以标识文件。对于每个文件，Filebeat存储惟一标识符，以检测文件是否以前读取过。\n如果你的情况涉及每天创建大量的新文件，你可能会发现注册表文件变得太大了。为了减小注册表文件的大小，有两个配置选项可用：`clean_remove`和`clean_inactive`。对于你不再访问且被忽略的旧文件，建议您使用`clean_inactive`。如果想从磁盘上删除旧文件，那么使用`clean_remove`选项。\n### 2.4 Filebeat如何确保至少投递一次（at-least-once）\nFilebeat保证事件将被投递到配置的输出中至少一次，并且不会丢失数据。Filebeat能够实现这种行为，因为它将每个事件的投递状态存储在注册表文件中。\n在定义的输出被阻塞且没有确认所有事件的情况下，Filebeat将继续尝试发送事件，直到输出确认收到事件为止。\n如果Filebeat在发送事件的过程中关闭了，则在关闭之前它不会等待输出确认所有事件。当Filebeat重新启动时，发送到输出（但在Filebeat关闭前未确认）的任何事件将再次发送。这确保每个事件至少被发送一次，但是你最终可能会将重复的事件发送到输出。你可以通过设置`shutdown_timeout`选项，将Filebeat配置为在关闭之前等待特定的时间。\n## 三：配置Filebeat\n为了配置Filebeat，你可以编辑配置文件`filebeat.yml`。此外同级目录下还有一个完整的配置文件示例`filebeat.reference.yml`\n### 3.1 指定运行哪个模块\nFilebeat提供了几种启用模块的不同方式：\n* 用`modules.d`目录下的配置启用模块\n* 运行Filebea命令的时候启用模块\n* 配置`filebeat.yml`文件启用模块配置\n\n```bash\n# 用modules.d目录启用模块配置\n$ ./filebeat modules enable apache2 mysql\n\n# 运行Filebea命令的时候启用模块\n$ ./filebeat --modules nginx,mysql,system\n\n# 配置`filebeat.yml`文件启用模块配置\nfilebeat.modules:\n - module: nginx\n - module: mysql\n - module: system\n```\n### 3.2 配置inputs\n为了手动配置Filebeat（代替用模块），你可以在filebeat.yml中的`filebeat.inputs`区域下指定一个inputs列表。列表是一个YMAL数组，并且你还可以指定多个inputs，相同input类型也可以指定多个。例如：\n```yaml\nfilebeat.inputs:\n- type: log\n  paths:\n    - /var/log/system.log\n    - /var/log/wifi.log\n- type: log\n  paths:\n    - \"/var/log/apache2/*\"\n  fields:\n    apache: true\n  fields_under_root: true\n```\n上面案例是从日志文件中读取行，类型为`log`的input需要指定一个paths列表，列表中的每一项必须能够定位并抓取到日志行。此外你还可以配置其它额外的配置项（比如，fields, include_lines, exclude_lines, multiline等等）来从这些文件中过滤读取行。你设置的这些配置对当前所有这种类型的input在获取日志行的时候都生效。为了对不同的文件应用不同的配置，你需要定义多个input区域。\n### 3.3 其他配置项\n* `paths`：从预定义的目录级别下抓取所有文件。\n例如：/var/log/*/*.log 将会抓取/var/log子目录目录下所有.log文件。它不会抓取/var/log本身目录下的日志文件。也不会抓取子目录的子目录下的日志文件。如果你应用`recursive_glob: true`设置的话，它将递归地抓取所有子目录下的所有.log文件。\n\n* `recursive_glob.enabled`\n允许将\\*\\*扩展为递归glob模式。启用这个特性后，每个路径中最右边的\\*\\*被扩展为固定数量的glob模式。例如：`/foo/**`扩展到`/foo`， `/foo/*`， `/foo/**`，等等。如果启用，它将单个\\*\\*扩展为8级深度\\*模式。这个特性默认是启用的，设置`recursive_glob.enabled: false`可以禁用它。\n\n* `encoding`\n按照[W3C推荐的HTML5](http://www.w3.org/TR/encoding)读取的文件的编码。例如：`plain`, `latin1`, `utf-8`, `utf-16be-bom`, `utf-16be`, `utf-16le`, `big5`, `gb18030`, `gbk`, `hz-gb-2312`。`plain`编码是特殊的，因为它不校验或者转换任何输入。\n\n* `exclude_lines`\n一组正则表达式，用于匹配你想要排除的行。Filebeat会删除这组正则表达式匹配的行。默认情况下，没有行被删除。空行被忽略。如果指定了`multiline`，那么在用`exclude_lines`过滤之前会将每个多行消息合并成一个单行。（PS：也就是说，多行合并成单行后再支持排除行的过滤）\n例如配置Filebeat删除以DBG开头的行：\n    ```yaml\n    filebeat.inputs:\n    - type: log\n      ...\n      exclude_lines: ['^DBG']\n    ```\n* `include_lines`\n一组正则表达式，用于匹配你想要包含的行。Filebeat只会导出匹配这组正则表达式的行。默认情况下，所有行都被导出。空行被忽略。如果指定了`multipline`设置，每个多行消息先被合并成单行后再执行`include_lines`过滤。\n例如配置Filebeat`导出以ERR或者WARN开头`的行：\n    ```yaml\n    filebeat.inputs:\n    - type: log\n      ...\n      include_lines: ['^ERR', '^WARN']\n    ```\n>如果`include_lines` 和 `exclude_lines` 都被定义了，那么Filebeat先执行include_lines后执行exclude_lines，而与这两个选项被定义的顺序没有关系。\n例如导出那些除了以DGB开头的所有包含sometext的行：\n    ```yaml\n    filebeat.inputs:\n    - type: log\n      ...\n      include_lines: ['sometext']\n      exclude_lines: ['^DBG']\n    ```\n* `exclude_files`\n需要排除的日志文件。 要匹配的正则表达式列表。 Filebeat从列表中删除与任何正则表达式匹配的文件。 默认情况下，不会删除任何文件。\n例如忽略.gz的文件:\n    ```yaml\n    filebeat.inputs:\n    - type: log\n      ...\n      exclude_files: ['\\.gz$']\n    ```\n\n\n* `fields`\n可选的附加字段。 可以自由选择这些字段，以便将其他信息添加到已抓取到的日志文件中进行过滤。\n\n* `fields_under_root`\n设置为true可将其他字段存储为顶级字段，而不是“字段”子字典下。 如果名称与Filebeat本身添加的字段冲突，则自定义字段会覆盖默认字段。\n\n* `harvester_buffer_size`\n当抓取一个文件时每个harvester使用的buffer的字节数。默认是16384。\n\n* `max_bytes`\n单个日志消息允许的最大字节数。超过max_bytes的字节将被丢弃且不会发送到输出。对于多行日志消息来说这个设置是很有用的，因为它们往往很大。默认是10MB（10485760）。\n\n* `json`\n    `json.keys_under_root`\n    默认情况下，解码后的JSON被放置在一个以\"json\"为key的输出文档中。如果你启用这个设置，那么这个key在文档中被复制为顶级。默认是false。\n\n    `json.overwrite_keys`\n    如果启用了keys_under_root和该设置，则解码的JSON对象中的值将覆盖Filebeat通常添加的字段（类型，来源，偏移等），以防发生冲突。\n\n    `json.add_error_key`\n    如果启用次设置，则当JSON解析出现错误的时候Filebeat添加 `error.message`和 `error.type: json`两个key，或者当没有使用message_key的时候。\n\n    `json.message_key`\n    一个可选的配置，用于在应用行过滤和多行设置的时候指定一个JSON key。指定的这个key必须在JSON对象中是顶级的，而且其关联的值必须是一个字符串，否则没有过滤或者多行聚集发送。\n\n    `ignore_decoding_error`\n    一个可选的配置，用于指定是否JSON解码错误应该被记录到日志中。如果设为true，错误将被记录。默认是false。\n    ```yaml\n    json.keys_under_root: true\n    json.add_error_key: true\n    json.message_key: log\n    ```\n* `multiline`\n    `multiline.pattern`\n    指定要匹配的正则表达式模式。根据您配置其他多行选项的方式，与指定正则表达式匹配的行被视为前一行的延续或新多行事件的开始。 您可以设置negate选项来否定模式。\n    `multiline.negate`\n    定义模式是否被否定。 默认值为false。\n    `multiline.match`\n    指定Filebeat如何将匹配行组合到事件中。 设置是在之前或之后。 这些设置的行为取决于您为negate指定的内容。\n    ```yaml\n    multiline.pattern: '^\\['\n    multiline.negate: true\n    multiline.match: after\n    ```\n\nmultiline.negate | multiline.match | Result\n--- | --- | ---\nfalse | after | 与模式匹配的连续行和前面不匹配的行合并成一条完整日志\nfalse | before | 与模式匹配的连续行和后面不匹配的行合并成一条完整日志\ntrue | after | 与模式匹配的行和后面不匹配的行组成一条完整日志\ntrue | before | 与模式匹配的行和前面不匹配的行组成一条完整日志\n![官方说明](/images/pic/multiline.jpg)\n\n例如Java堆栈跟踪由多行组成，在初始行之后的每一行都以空格开头，例如下面这样：\n```\nException in thread \"main\" java.lang.NullPointerException\n        at com.example.myproject.Book.getTitle(Book.java:16)\n        at com.example.myproject.Author.getBookTitles(Author.java:25)\n        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)\n```\n为了把这些行合并成单个事件，用写了多行配置：\n```yaml\nmultiline.pattern: '^[[:space:]]'\nmultiline.negate: false\nmultiline.match: after\n```\n下面是一个稍微更复杂的例子\n```\nException in thread \"main\" java.lang.IllegalStateException: A book has a null property\n       at com.example.myproject.Author.getBookIds(Author.java:38)\n       at com.example.myproject.Bootstrap.main(Bootstrap.java:14)\nCaused by: java.lang.NullPointerException\n       at com.example.myproject.Book.getId(Book.java:22)\n       at com.example.myproject.Author.getBookIds(Author.java:35)\n       ... 1 more\n```\n为了合并这个，用下面的配置：\n```yaml\nmultiline.pattern: '^[[:space:]]+(at|\\.{3})\\b|^Caused by:'\nmultiline.negate: false\nmultiline.match: after\n```\n在这个例子中，模式匹配下列行：\n1. 以空格开头，后面跟 at 或者 ... 的行\n2. 以 Caused by: 开头的行\n\n* `ignore_older`\n如果启用，那么Filebeat会忽略在指定的时间跨度之前被修改的文件。如果你想要保留日志文件一个较长的时间，那么配置`ignore_older`是很有用的。例如，如果你想要开始Filebeat，但是你只想发送最近一周最新的文件，这个情况下你可以配置这个选项。你可以用时间字符串，比如2h（2小时），5m（5分钟）。默认是0，意思是禁用这个设置。你必须设置`ignore_older`比`close_inactive`更大。\n\n* `close_*`\nclose_*配置项用于在一个确定的条件或者时间点之后`关闭harvester`。关闭harvester意味着关闭文件处理器。如果在harvester关闭以后文件被更新，那么在`scan_frequency`结束后改文件将再次被拾起。然而，当harvester关闭的时候如果文件被删除或者被移动，那么Filebeat将不会被再次拾起，并且这个harvester还没有读取的数据将会丢失。\n\n    `close_inactive`\n    当启用此选项时，如果文件在指定的持续时间内未被获取，则Filebeat将关闭文件句柄。当harvester读取最后一行日志时，指定周期的计数器就开始工作了。它不基于文件的修改时间。如果关闭的文件再次更改，则会启动一个新的harvester，并且在`scan_frequency`结束后，将获得最新的更改。\n    推荐给`close_inactive`设置一个比你的日志文件更新频率更大一点儿的值。例如，如果你的日志文件每隔几秒就会更新，你可以设置`close_inactive`为1m。如果日志文件的更新速率不固定，那么可以用多个配置。将`close_inactive`设置为更低的值意味着文件句柄可以更早关闭。然而，这样做的副作用是，如果harvester关闭了，新的日志行不会实时发送。\n    关闭文件的时间戳不依赖于文件的修改时间。代替的，Filebeat用一个内部时间戳来反映最后一次读取文件的时间。例如，如果`close_inactive`被设置为5分钟，那么在harvester读取文件的最后一行以后，这个5分钟的倒计时就开始了。你可以用时间字符串，比如2h（2小时），5m（5分钟）。默认是5m。\n\n    `close_renamed`\n    当启用此选项时，Filebeat会在重命名文件时关闭文件处理器。默认情况下，harvester保持打开状态并继续读取文件，因为文件处理器不依赖于文件名。如果启用了`close_rename`选项，并且重命名或者移动的文件不再匹配文件模式的话，那么文件将不会再次被选中。Filebeat将无法完成文件的读取。\n\n    `close_removed`\n    当启用此选项时，Filebeat会在删除文件时关闭harvester。通常，一个文件只有在它在由`close_inactive`指定的期间内不活跃的情况下才会被删除。但是，如果一个文件被提前删除，并且你不启用`close_removed`，则Filebeat将保持文件打开，以确保harvester已经完成。如果由于文件过早地从磁盘中删除而导致文件不能完全读取，请禁用此选项。\n\n    `close_eof`\n    抓取到达文件末尾后立即关闭文件处理程序。默认情况下，此选项被禁用。 注意：潜在的数据丢失。 请务必阅读并理解此选项的文档。\n\n    `close_timeout` \n    当启用此选项是，Filebeat会给每个harvester一个预定义的生命时间。无论读到文件的什么位置，只要`close_timeout`周期到了以后就会停止读取。当你想要在文件上只花费预定义的时间时，这个选项对旧的日志文件很有用。尽管在`close_timeout`时间以后文件就关闭了，但如果文件仍然在更新，则Filebeat将根据已定义的`scan_frequency`再次启动一个新的harvester。这个harvester的`close_timeout`将再次启动，为超时倒计时。\n\n* `scan_frequency`\nFilebeat多久检查一次指定路径下的新文件（PS：检查的频率）。例如，如果你指定的路径是 /var/log/* ，那么会以指定的`scan_frequency`频率去扫描目录下的文件（PS：周期性扫描）。指定1秒钟扫描一次目录，默认值10秒。如果你需要近实时的发送日志行的话，不要设置`scan_frequency`为一个很低的值，而应该调整`close_inactive`以至于文件处理器保持打开状态，并不断地轮询你的文件。\n\n更多关于类型为`log`的输入配置，请参考[官方配置文档](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html)\n## 四：加载外部配置文件\nFilebeat可以为输入和模块加载外部配置文件，允许您将配置分成多个较小的配置文件。 \n### 4.1 配置input\n对于输入配置，请在filebeat.yml文件的filebeat.config.inputs部分中指定path选项。 例如：\n```yaml\nfilebeat.config.inputs:\n  enabled: true\n  path: configs/*.yml\n```\n每一个在path下的文件都必须包含一个或多个input定义，例如：\n```yaml\n- type: log\n  paths:\n    - /var/log/mysql.log\n  scan_frequency: 10s\n\n- type: log\n  paths:\n    - /var/log/apache.log\n  scan_frequency: 5s\n```\n### 4.2 模块配置\n对于模块配置，请在filebeat.yml文件的filebeat.config.modules部分中指定path选项。 默认情况下，Filebeat会加载modules.d目录中启用的模块配置。 例如：\n```yaml\nfilebeat.config.modules:\n  enabled: true\n  path: ${path.config}/modules.d/*.yml\n```\n每个被发现的配置文件必须包含一个或多个模块定义，例如：\n```\n- module: apache2\n  access:\n    enabled: true\n    var.paths: [/var/log/apache2/access.log*]\n  error:\n    enabled: true\n    var.paths: [/var/log/apache2/error.log*]\n```\n### 4.3 配置output\n您可以通过在filebeat.yml配置文件的输出部分中设置选项来配置Filebeat以写入特定输出。 只能定义一个输出。支持的输出如：`Elasticsearch`, `Logstash`, `Kafka`, `Redis`, `File`, `Console`, `Cloud`。\n#### 4.3.1 配置Elasticsearch输出\n为输出指定Elasticsearch时，Filebeat会使用Elasticsearch HTTP API将事务直接发送到Elasticsearch。例如：\n```yaml\noutput.elasticsearch:\n  hosts: [\"https://localhost:9200\"]\n  index: \"filebeat-%{[beat.version]}-%{+yyyy.MM.dd}\"\n  ssl.certificate_authorities: [\"/etc/pki/root/ca.pem\"]\n  ssl.certificate: \"/etc/pki/client/cert.pem\"\n  ssl.key: \"/etc/pki/client/cert.key\"\n```\n为了启用SSL，只需要在hosts下的所有URL添加https即可\n```yaml\noutput.elasticsearch:\n  hosts: [\"https://localhost:9200\"]\n  username: \"filebeat_internal\"\n  password: \"YOUR_PASSWORD\"\n```\n如果Elasticsearch节点是用IP:PORT的形式定义的，那么添加protocol:https。\n```yaml\noutput.elasticsearch:\n  hosts: [\"localhost\"]\n  protocol: \"https\"\n  username: \"{beatname_lc}_internal\"\n  password: \"{pwd}\"\n```\n#### 4.3.2 Elasticsearch输出配置项\n`enabled`\n启用或禁用该输出。默认true。\n\n`hosts`\nElasticsearch节点列表。事件以循环顺序发送到这些节点。如果一个节点变得不可访问，那么自动发送到下一个节点。每个节点可以是URL形式，也可以是IP:PORT形式。如果端口没有指定，用9200。\n```yaml\noutput.elasticsearch:\n  hosts: [\"10.45.3.2:9220\", \"10.45.3.1:9230\"]\n  protocol: https\n  path: /elasticsearch\n```\n`username`\n用于认证的用户名\n\n`password`\n用户认证的密码\n\n`protocol`\n可选值是：http 或者 https。默认是http。\n\n`path`\nHTTP API调用前的HTTP路径前缀。这对于Elasticsearch监听HTTP反向代理的情况很有用。\n\n`headers`\n将自定义HTTP头添加到Elasticsearch输出的每个请求。\n\n`index`\n索引名字。（PS：意思是要发到哪个索引中去）。默认是`\"filebeat-%{[beat.version]}-%{+yyyy.MM.dd}\"`（例如，\"filebeat-6.3.2-2017.04.26\"）。如果你想改变这个设置，你需要配置 `setup.template.name` 和 `setup.template.pattern` 选项。如果你用内置的Kibana dashboards，你也需要设置`setup.dashboards.index`选项。\n\n`indices`\n索引选择器规则数组，支持条件、基于格式字符串的字段访问和名称映射。如果索引缺失或没有匹配规则，将使用index字段。例如：\n```yaml\noutput.elasticsearch:\n  hosts: [\"http://localhost:9200\"]\n  index: \"logs-%{[beat.version]}-%{+yyyy.MM.dd}\"\n  indices:\n    - index: \"critical-%{[beat.version]}-%{+yyyy.MM.dd}\"\n      when.contains:\n        message: \"CRITICAL\"\n    - index: \"error-%{[beat.version]}-%{+yyyy.MM.dd}\"\n      when.contains:\n        message: \"ERR\"\n```\n`timeout`\n请求超时时间。默认90秒。\n\n更多关于elasticsearch输出配置请参考[官方文档](https://www.elastic.co/guide/en/beats/filebeat/current/elasticsearch-output.html#_configuration_options_8)\n这里只以elasticsearch输出类型为例，更多关于output 输出类型配置，请参考官方[配置输出类型](https://www.elastic.co/guide/en/beats/filebeat/current/configuring-output.html)\n### 4.4 加载索引模板\n在filebeat.yml配置文件的`setup.template`区域指定索引模板，用来设置在Elasticsearch中的映射。如果模板加载是启用的（默认的），Filebeat在成功连接到Elasticsearch后自动加载索引模板。你可以调整下列设置或者覆盖一个已经存在的模板。\n\n`setup.template.enabled`\n设为false表示禁用模板加载\n\n`setup.template.name`\n模板的名字。默认是filebeat。Filebeat的版本总是跟在名字后面，所以最终的名字是 filebeat-%{[beat.version]}\n\n`setup.template.pattern`\n模板的模式。默认模式是filebeat-*。例如：\n```yaml\nsetup.template.name: \"filebeat\"\nsetup.template.pattern: \"filebeat-*\"\n```\n`setup.template.fields`\n描述字段的YAML文件路径。默认是 fields.yml。\n\n`setup.template.overwrite`\n是否覆盖存在的模板。默认false。\n\n`setup.template.settings._source`\n```yaml\nsetup.template.name: \"filebeat\"\nsetup.template.fields: \"fields.yml\"\nsetup.template.overwrite: false\nsetup.template.settings:\n  _source.enabled: false\n```\n有关filebeat完整的配置文档，请参考(https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-getting-started.html)","source":"_posts/filebeat.md","raw":"layout: post\ntitle: Elastic Stack之Filebeat7.0详解\nauthor: Pyker\ncategories: elastic\nimg: /images/bar/beats.png\ntags:\n  - filebeat\n  - efk\ntop: false\ncover: false\ndate: 2019-03-14 12:10:00\n---\n## 一：认识Filebeat\n* `Filebeat`是beats其中一个组件，它是一个`轻量型日志采集器`，可以直接（或者通过Logstash）将数据发送到Elasticsearch，在那里你可以进一步处理和增强数据，然后在Kibana中将其可视化。\n\n* 当您要面对成百上千、甚至成千上万的服务器、虚拟机和容器生成的日志时，请告别 SSH 吧。Filebeat 将为您提供一种轻量型方法，用于转发和汇总日志与文件，让简单的事情不再繁杂。\n\n* 它性能稳健，不错过任何检测信号，无论在任何环境中，随时都潜伏着应用程序中断的风险。Filebeat 能够读取并转发日志行，如果出现中断，还会在一切恢复正常后，从中断前停止的位置继续开始。\n\n* `Filebeat` 内置有多种模块（auditd、Apache、NGINX、System、MySQL 等等），可针对常见格式的日志大大简化收集、解析和可视化过程，只需一条命令即可。之所以能实现这一点，是因为它将自动默认路径（因操作系统而异）与 Elasticsearch 采集节点管道的定义和 Kibana 仪表板组合在一起。不仅如此，数个 Filebeat 模块还包括预配置的 Machine Learning 任务。\n\n## 二：Filebeat工作原理\nFilebeat由两个主要组件组成：`inputs` 和 `harvesters`（直译：收割机，采集器）。这些组件一起工作以跟踪文件，并将事件数据发送到你指定的输出。\n### 2.1 harvester是什么\n一个`harvester`负责读取一个单个文件的内容。harvester逐行读取每个文件（一行一行地读取每个文件），并把这些内容发送到输出。每个文件启动一个harvester负责打开和关闭这个文件，这就意味着在harvester运行时文件描述符保持打开状态。而在harvester正在读取文件内容的时候，文件被删除或者重命名了，那么Filebeat会继续读这个文件。这就有一个问题了，就是只要负责这个文件的harvester没用关闭，那么磁盘空间就不会释放。默认情况下，Filebeat保存文件打开直到close_inactive到达。\n### 2.2 input是什么\n一个`input`负责管理当前的harvesters，并找到所有要读取的源。如果input类型是log，则input查找paths已定义的glob路径匹配的所有日志文件，并为每个文件启动一个harvester。\n下面的例子配置Filebeat从所有匹配指定的glob模式的文件中读取行：\n```yaml\nfilebeat.inputs:\n- type: log\n  paths:\n    - /var/log/*.log\n    - /var/path2/*.log\n```\n### 2.3 Filebeat如何保持文件状态\nFilebeat保存每个文件的状态，并经常刷新状态到磁盘上的注册文件（registry）。状态用于记住harvester读取文件的最后一个偏移量（行），并确保所有日志行被发送到输出（如Elasticsearch 或者 Logstash等），当输出无法访问时，那么Filebeat会跟踪已经发送的最后一行，并只要输出再次变得可用时继续读取文件。当Filebeat运行时，会将每个文件的状态新保存在内存中。当Filebeat重新启动时，将使用注册文件中的数据重新构建状态，Filebeat将在最后一个已知行位置继续每个harvester。对于每个输入，Filebeat保存它找到的每个文件的状态。因为文件可以重命名或移动，所以文件名和路径不足以标识文件。对于每个文件，Filebeat存储惟一标识符，以检测文件是否以前读取过。\n如果你的情况涉及每天创建大量的新文件，你可能会发现注册表文件变得太大了。为了减小注册表文件的大小，有两个配置选项可用：`clean_remove`和`clean_inactive`。对于你不再访问且被忽略的旧文件，建议您使用`clean_inactive`。如果想从磁盘上删除旧文件，那么使用`clean_remove`选项。\n### 2.4 Filebeat如何确保至少投递一次（at-least-once）\nFilebeat保证事件将被投递到配置的输出中至少一次，并且不会丢失数据。Filebeat能够实现这种行为，因为它将每个事件的投递状态存储在注册表文件中。\n在定义的输出被阻塞且没有确认所有事件的情况下，Filebeat将继续尝试发送事件，直到输出确认收到事件为止。\n如果Filebeat在发送事件的过程中关闭了，则在关闭之前它不会等待输出确认所有事件。当Filebeat重新启动时，发送到输出（但在Filebeat关闭前未确认）的任何事件将再次发送。这确保每个事件至少被发送一次，但是你最终可能会将重复的事件发送到输出。你可以通过设置`shutdown_timeout`选项，将Filebeat配置为在关闭之前等待特定的时间。\n## 三：配置Filebeat\n为了配置Filebeat，你可以编辑配置文件`filebeat.yml`。此外同级目录下还有一个完整的配置文件示例`filebeat.reference.yml`\n### 3.1 指定运行哪个模块\nFilebeat提供了几种启用模块的不同方式：\n* 用`modules.d`目录下的配置启用模块\n* 运行Filebea命令的时候启用模块\n* 配置`filebeat.yml`文件启用模块配置\n\n```bash\n# 用modules.d目录启用模块配置\n$ ./filebeat modules enable apache2 mysql\n\n# 运行Filebea命令的时候启用模块\n$ ./filebeat --modules nginx,mysql,system\n\n# 配置`filebeat.yml`文件启用模块配置\nfilebeat.modules:\n - module: nginx\n - module: mysql\n - module: system\n```\n### 3.2 配置inputs\n为了手动配置Filebeat（代替用模块），你可以在filebeat.yml中的`filebeat.inputs`区域下指定一个inputs列表。列表是一个YMAL数组，并且你还可以指定多个inputs，相同input类型也可以指定多个。例如：\n```yaml\nfilebeat.inputs:\n- type: log\n  paths:\n    - /var/log/system.log\n    - /var/log/wifi.log\n- type: log\n  paths:\n    - \"/var/log/apache2/*\"\n  fields:\n    apache: true\n  fields_under_root: true\n```\n上面案例是从日志文件中读取行，类型为`log`的input需要指定一个paths列表，列表中的每一项必须能够定位并抓取到日志行。此外你还可以配置其它额外的配置项（比如，fields, include_lines, exclude_lines, multiline等等）来从这些文件中过滤读取行。你设置的这些配置对当前所有这种类型的input在获取日志行的时候都生效。为了对不同的文件应用不同的配置，你需要定义多个input区域。\n### 3.3 其他配置项\n* `paths`：从预定义的目录级别下抓取所有文件。\n例如：/var/log/*/*.log 将会抓取/var/log子目录目录下所有.log文件。它不会抓取/var/log本身目录下的日志文件。也不会抓取子目录的子目录下的日志文件。如果你应用`recursive_glob: true`设置的话，它将递归地抓取所有子目录下的所有.log文件。\n\n* `recursive_glob.enabled`\n允许将\\*\\*扩展为递归glob模式。启用这个特性后，每个路径中最右边的\\*\\*被扩展为固定数量的glob模式。例如：`/foo/**`扩展到`/foo`， `/foo/*`， `/foo/**`，等等。如果启用，它将单个\\*\\*扩展为8级深度\\*模式。这个特性默认是启用的，设置`recursive_glob.enabled: false`可以禁用它。\n\n* `encoding`\n按照[W3C推荐的HTML5](http://www.w3.org/TR/encoding)读取的文件的编码。例如：`plain`, `latin1`, `utf-8`, `utf-16be-bom`, `utf-16be`, `utf-16le`, `big5`, `gb18030`, `gbk`, `hz-gb-2312`。`plain`编码是特殊的，因为它不校验或者转换任何输入。\n\n* `exclude_lines`\n一组正则表达式，用于匹配你想要排除的行。Filebeat会删除这组正则表达式匹配的行。默认情况下，没有行被删除。空行被忽略。如果指定了`multiline`，那么在用`exclude_lines`过滤之前会将每个多行消息合并成一个单行。（PS：也就是说，多行合并成单行后再支持排除行的过滤）\n例如配置Filebeat删除以DBG开头的行：\n    ```yaml\n    filebeat.inputs:\n    - type: log\n      ...\n      exclude_lines: ['^DBG']\n    ```\n* `include_lines`\n一组正则表达式，用于匹配你想要包含的行。Filebeat只会导出匹配这组正则表达式的行。默认情况下，所有行都被导出。空行被忽略。如果指定了`multipline`设置，每个多行消息先被合并成单行后再执行`include_lines`过滤。\n例如配置Filebeat`导出以ERR或者WARN开头`的行：\n    ```yaml\n    filebeat.inputs:\n    - type: log\n      ...\n      include_lines: ['^ERR', '^WARN']\n    ```\n>如果`include_lines` 和 `exclude_lines` 都被定义了，那么Filebeat先执行include_lines后执行exclude_lines，而与这两个选项被定义的顺序没有关系。\n例如导出那些除了以DGB开头的所有包含sometext的行：\n    ```yaml\n    filebeat.inputs:\n    - type: log\n      ...\n      include_lines: ['sometext']\n      exclude_lines: ['^DBG']\n    ```\n* `exclude_files`\n需要排除的日志文件。 要匹配的正则表达式列表。 Filebeat从列表中删除与任何正则表达式匹配的文件。 默认情况下，不会删除任何文件。\n例如忽略.gz的文件:\n    ```yaml\n    filebeat.inputs:\n    - type: log\n      ...\n      exclude_files: ['\\.gz$']\n    ```\n\n\n* `fields`\n可选的附加字段。 可以自由选择这些字段，以便将其他信息添加到已抓取到的日志文件中进行过滤。\n\n* `fields_under_root`\n设置为true可将其他字段存储为顶级字段，而不是“字段”子字典下。 如果名称与Filebeat本身添加的字段冲突，则自定义字段会覆盖默认字段。\n\n* `harvester_buffer_size`\n当抓取一个文件时每个harvester使用的buffer的字节数。默认是16384。\n\n* `max_bytes`\n单个日志消息允许的最大字节数。超过max_bytes的字节将被丢弃且不会发送到输出。对于多行日志消息来说这个设置是很有用的，因为它们往往很大。默认是10MB（10485760）。\n\n* `json`\n    `json.keys_under_root`\n    默认情况下，解码后的JSON被放置在一个以\"json\"为key的输出文档中。如果你启用这个设置，那么这个key在文档中被复制为顶级。默认是false。\n\n    `json.overwrite_keys`\n    如果启用了keys_under_root和该设置，则解码的JSON对象中的值将覆盖Filebeat通常添加的字段（类型，来源，偏移等），以防发生冲突。\n\n    `json.add_error_key`\n    如果启用次设置，则当JSON解析出现错误的时候Filebeat添加 `error.message`和 `error.type: json`两个key，或者当没有使用message_key的时候。\n\n    `json.message_key`\n    一个可选的配置，用于在应用行过滤和多行设置的时候指定一个JSON key。指定的这个key必须在JSON对象中是顶级的，而且其关联的值必须是一个字符串，否则没有过滤或者多行聚集发送。\n\n    `ignore_decoding_error`\n    一个可选的配置，用于指定是否JSON解码错误应该被记录到日志中。如果设为true，错误将被记录。默认是false。\n    ```yaml\n    json.keys_under_root: true\n    json.add_error_key: true\n    json.message_key: log\n    ```\n* `multiline`\n    `multiline.pattern`\n    指定要匹配的正则表达式模式。根据您配置其他多行选项的方式，与指定正则表达式匹配的行被视为前一行的延续或新多行事件的开始。 您可以设置negate选项来否定模式。\n    `multiline.negate`\n    定义模式是否被否定。 默认值为false。\n    `multiline.match`\n    指定Filebeat如何将匹配行组合到事件中。 设置是在之前或之后。 这些设置的行为取决于您为negate指定的内容。\n    ```yaml\n    multiline.pattern: '^\\['\n    multiline.negate: true\n    multiline.match: after\n    ```\n\nmultiline.negate | multiline.match | Result\n--- | --- | ---\nfalse | after | 与模式匹配的连续行和前面不匹配的行合并成一条完整日志\nfalse | before | 与模式匹配的连续行和后面不匹配的行合并成一条完整日志\ntrue | after | 与模式匹配的行和后面不匹配的行组成一条完整日志\ntrue | before | 与模式匹配的行和前面不匹配的行组成一条完整日志\n![官方说明](/images/pic/multiline.jpg)\n\n例如Java堆栈跟踪由多行组成，在初始行之后的每一行都以空格开头，例如下面这样：\n```\nException in thread \"main\" java.lang.NullPointerException\n        at com.example.myproject.Book.getTitle(Book.java:16)\n        at com.example.myproject.Author.getBookTitles(Author.java:25)\n        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)\n```\n为了把这些行合并成单个事件，用写了多行配置：\n```yaml\nmultiline.pattern: '^[[:space:]]'\nmultiline.negate: false\nmultiline.match: after\n```\n下面是一个稍微更复杂的例子\n```\nException in thread \"main\" java.lang.IllegalStateException: A book has a null property\n       at com.example.myproject.Author.getBookIds(Author.java:38)\n       at com.example.myproject.Bootstrap.main(Bootstrap.java:14)\nCaused by: java.lang.NullPointerException\n       at com.example.myproject.Book.getId(Book.java:22)\n       at com.example.myproject.Author.getBookIds(Author.java:35)\n       ... 1 more\n```\n为了合并这个，用下面的配置：\n```yaml\nmultiline.pattern: '^[[:space:]]+(at|\\.{3})\\b|^Caused by:'\nmultiline.negate: false\nmultiline.match: after\n```\n在这个例子中，模式匹配下列行：\n1. 以空格开头，后面跟 at 或者 ... 的行\n2. 以 Caused by: 开头的行\n\n* `ignore_older`\n如果启用，那么Filebeat会忽略在指定的时间跨度之前被修改的文件。如果你想要保留日志文件一个较长的时间，那么配置`ignore_older`是很有用的。例如，如果你想要开始Filebeat，但是你只想发送最近一周最新的文件，这个情况下你可以配置这个选项。你可以用时间字符串，比如2h（2小时），5m（5分钟）。默认是0，意思是禁用这个设置。你必须设置`ignore_older`比`close_inactive`更大。\n\n* `close_*`\nclose_*配置项用于在一个确定的条件或者时间点之后`关闭harvester`。关闭harvester意味着关闭文件处理器。如果在harvester关闭以后文件被更新，那么在`scan_frequency`结束后改文件将再次被拾起。然而，当harvester关闭的时候如果文件被删除或者被移动，那么Filebeat将不会被再次拾起，并且这个harvester还没有读取的数据将会丢失。\n\n    `close_inactive`\n    当启用此选项时，如果文件在指定的持续时间内未被获取，则Filebeat将关闭文件句柄。当harvester读取最后一行日志时，指定周期的计数器就开始工作了。它不基于文件的修改时间。如果关闭的文件再次更改，则会启动一个新的harvester，并且在`scan_frequency`结束后，将获得最新的更改。\n    推荐给`close_inactive`设置一个比你的日志文件更新频率更大一点儿的值。例如，如果你的日志文件每隔几秒就会更新，你可以设置`close_inactive`为1m。如果日志文件的更新速率不固定，那么可以用多个配置。将`close_inactive`设置为更低的值意味着文件句柄可以更早关闭。然而，这样做的副作用是，如果harvester关闭了，新的日志行不会实时发送。\n    关闭文件的时间戳不依赖于文件的修改时间。代替的，Filebeat用一个内部时间戳来反映最后一次读取文件的时间。例如，如果`close_inactive`被设置为5分钟，那么在harvester读取文件的最后一行以后，这个5分钟的倒计时就开始了。你可以用时间字符串，比如2h（2小时），5m（5分钟）。默认是5m。\n\n    `close_renamed`\n    当启用此选项时，Filebeat会在重命名文件时关闭文件处理器。默认情况下，harvester保持打开状态并继续读取文件，因为文件处理器不依赖于文件名。如果启用了`close_rename`选项，并且重命名或者移动的文件不再匹配文件模式的话，那么文件将不会再次被选中。Filebeat将无法完成文件的读取。\n\n    `close_removed`\n    当启用此选项时，Filebeat会在删除文件时关闭harvester。通常，一个文件只有在它在由`close_inactive`指定的期间内不活跃的情况下才会被删除。但是，如果一个文件被提前删除，并且你不启用`close_removed`，则Filebeat将保持文件打开，以确保harvester已经完成。如果由于文件过早地从磁盘中删除而导致文件不能完全读取，请禁用此选项。\n\n    `close_eof`\n    抓取到达文件末尾后立即关闭文件处理程序。默认情况下，此选项被禁用。 注意：潜在的数据丢失。 请务必阅读并理解此选项的文档。\n\n    `close_timeout` \n    当启用此选项是，Filebeat会给每个harvester一个预定义的生命时间。无论读到文件的什么位置，只要`close_timeout`周期到了以后就会停止读取。当你想要在文件上只花费预定义的时间时，这个选项对旧的日志文件很有用。尽管在`close_timeout`时间以后文件就关闭了，但如果文件仍然在更新，则Filebeat将根据已定义的`scan_frequency`再次启动一个新的harvester。这个harvester的`close_timeout`将再次启动，为超时倒计时。\n\n* `scan_frequency`\nFilebeat多久检查一次指定路径下的新文件（PS：检查的频率）。例如，如果你指定的路径是 /var/log/* ，那么会以指定的`scan_frequency`频率去扫描目录下的文件（PS：周期性扫描）。指定1秒钟扫描一次目录，默认值10秒。如果你需要近实时的发送日志行的话，不要设置`scan_frequency`为一个很低的值，而应该调整`close_inactive`以至于文件处理器保持打开状态，并不断地轮询你的文件。\n\n更多关于类型为`log`的输入配置，请参考[官方配置文档](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html)\n## 四：加载外部配置文件\nFilebeat可以为输入和模块加载外部配置文件，允许您将配置分成多个较小的配置文件。 \n### 4.1 配置input\n对于输入配置，请在filebeat.yml文件的filebeat.config.inputs部分中指定path选项。 例如：\n```yaml\nfilebeat.config.inputs:\n  enabled: true\n  path: configs/*.yml\n```\n每一个在path下的文件都必须包含一个或多个input定义，例如：\n```yaml\n- type: log\n  paths:\n    - /var/log/mysql.log\n  scan_frequency: 10s\n\n- type: log\n  paths:\n    - /var/log/apache.log\n  scan_frequency: 5s\n```\n### 4.2 模块配置\n对于模块配置，请在filebeat.yml文件的filebeat.config.modules部分中指定path选项。 默认情况下，Filebeat会加载modules.d目录中启用的模块配置。 例如：\n```yaml\nfilebeat.config.modules:\n  enabled: true\n  path: ${path.config}/modules.d/*.yml\n```\n每个被发现的配置文件必须包含一个或多个模块定义，例如：\n```\n- module: apache2\n  access:\n    enabled: true\n    var.paths: [/var/log/apache2/access.log*]\n  error:\n    enabled: true\n    var.paths: [/var/log/apache2/error.log*]\n```\n### 4.3 配置output\n您可以通过在filebeat.yml配置文件的输出部分中设置选项来配置Filebeat以写入特定输出。 只能定义一个输出。支持的输出如：`Elasticsearch`, `Logstash`, `Kafka`, `Redis`, `File`, `Console`, `Cloud`。\n#### 4.3.1 配置Elasticsearch输出\n为输出指定Elasticsearch时，Filebeat会使用Elasticsearch HTTP API将事务直接发送到Elasticsearch。例如：\n```yaml\noutput.elasticsearch:\n  hosts: [\"https://localhost:9200\"]\n  index: \"filebeat-%{[beat.version]}-%{+yyyy.MM.dd}\"\n  ssl.certificate_authorities: [\"/etc/pki/root/ca.pem\"]\n  ssl.certificate: \"/etc/pki/client/cert.pem\"\n  ssl.key: \"/etc/pki/client/cert.key\"\n```\n为了启用SSL，只需要在hosts下的所有URL添加https即可\n```yaml\noutput.elasticsearch:\n  hosts: [\"https://localhost:9200\"]\n  username: \"filebeat_internal\"\n  password: \"YOUR_PASSWORD\"\n```\n如果Elasticsearch节点是用IP:PORT的形式定义的，那么添加protocol:https。\n```yaml\noutput.elasticsearch:\n  hosts: [\"localhost\"]\n  protocol: \"https\"\n  username: \"{beatname_lc}_internal\"\n  password: \"{pwd}\"\n```\n#### 4.3.2 Elasticsearch输出配置项\n`enabled`\n启用或禁用该输出。默认true。\n\n`hosts`\nElasticsearch节点列表。事件以循环顺序发送到这些节点。如果一个节点变得不可访问，那么自动发送到下一个节点。每个节点可以是URL形式，也可以是IP:PORT形式。如果端口没有指定，用9200。\n```yaml\noutput.elasticsearch:\n  hosts: [\"10.45.3.2:9220\", \"10.45.3.1:9230\"]\n  protocol: https\n  path: /elasticsearch\n```\n`username`\n用于认证的用户名\n\n`password`\n用户认证的密码\n\n`protocol`\n可选值是：http 或者 https。默认是http。\n\n`path`\nHTTP API调用前的HTTP路径前缀。这对于Elasticsearch监听HTTP反向代理的情况很有用。\n\n`headers`\n将自定义HTTP头添加到Elasticsearch输出的每个请求。\n\n`index`\n索引名字。（PS：意思是要发到哪个索引中去）。默认是`\"filebeat-%{[beat.version]}-%{+yyyy.MM.dd}\"`（例如，\"filebeat-6.3.2-2017.04.26\"）。如果你想改变这个设置，你需要配置 `setup.template.name` 和 `setup.template.pattern` 选项。如果你用内置的Kibana dashboards，你也需要设置`setup.dashboards.index`选项。\n\n`indices`\n索引选择器规则数组，支持条件、基于格式字符串的字段访问和名称映射。如果索引缺失或没有匹配规则，将使用index字段。例如：\n```yaml\noutput.elasticsearch:\n  hosts: [\"http://localhost:9200\"]\n  index: \"logs-%{[beat.version]}-%{+yyyy.MM.dd}\"\n  indices:\n    - index: \"critical-%{[beat.version]}-%{+yyyy.MM.dd}\"\n      when.contains:\n        message: \"CRITICAL\"\n    - index: \"error-%{[beat.version]}-%{+yyyy.MM.dd}\"\n      when.contains:\n        message: \"ERR\"\n```\n`timeout`\n请求超时时间。默认90秒。\n\n更多关于elasticsearch输出配置请参考[官方文档](https://www.elastic.co/guide/en/beats/filebeat/current/elasticsearch-output.html#_configuration_options_8)\n这里只以elasticsearch输出类型为例，更多关于output 输出类型配置，请参考官方[配置输出类型](https://www.elastic.co/guide/en/beats/filebeat/current/configuring-output.html)\n### 4.4 加载索引模板\n在filebeat.yml配置文件的`setup.template`区域指定索引模板，用来设置在Elasticsearch中的映射。如果模板加载是启用的（默认的），Filebeat在成功连接到Elasticsearch后自动加载索引模板。你可以调整下列设置或者覆盖一个已经存在的模板。\n\n`setup.template.enabled`\n设为false表示禁用模板加载\n\n`setup.template.name`\n模板的名字。默认是filebeat。Filebeat的版本总是跟在名字后面，所以最终的名字是 filebeat-%{[beat.version]}\n\n`setup.template.pattern`\n模板的模式。默认模式是filebeat-*。例如：\n```yaml\nsetup.template.name: \"filebeat\"\nsetup.template.pattern: \"filebeat-*\"\n```\n`setup.template.fields`\n描述字段的YAML文件路径。默认是 fields.yml。\n\n`setup.template.overwrite`\n是否覆盖存在的模板。默认false。\n\n`setup.template.settings._source`\n```yaml\nsetup.template.name: \"filebeat\"\nsetup.template.fields: \"fields.yml\"\nsetup.template.overwrite: false\nsetup.template.settings:\n  _source.enabled: false\n```\n有关filebeat完整的配置文档，请参考(https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-getting-started.html)","slug":"filebeat","published":1,"updated":"2019-05-28T02:02:23.504Z","_id":"cjw6jlf1w0036p4n7tcq9wuxw","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h2 id=\"一：认识Filebeat\"><a href=\"#一：认识Filebeat\" class=\"headerlink\" title=\"一：认识Filebeat\"></a>一：认识Filebeat</h2><ul>\n<li><p><code>Filebeat</code>是beats其中一个组件，它是一个<code>轻量型日志采集器</code>，可以直接（或者通过Logstash）将数据发送到Elasticsearch，在那里你可以进一步处理和增强数据，然后在Kibana中将其可视化。</p>\n</li>\n<li><p>当您要面对成百上千、甚至成千上万的服务器、虚拟机和容器生成的日志时，请告别 SSH 吧。Filebeat 将为您提供一种轻量型方法，用于转发和汇总日志与文件，让简单的事情不再繁杂。</p>\n</li>\n<li><p>它性能稳健，不错过任何检测信号，无论在任何环境中，随时都潜伏着应用程序中断的风险。Filebeat 能够读取并转发日志行，如果出现中断，还会在一切恢复正常后，从中断前停止的位置继续开始。</p>\n</li>\n<li><p><code>Filebeat</code> 内置有多种模块（auditd、Apache、NGINX、System、MySQL 等等），可针对常见格式的日志大大简化收集、解析和可视化过程，只需一条命令即可。之所以能实现这一点，是因为它将自动默认路径（因操作系统而异）与 Elasticsearch 采集节点管道的定义和 Kibana 仪表板组合在一起。不仅如此，数个 Filebeat 模块还包括预配置的 Machine Learning 任务。</p>\n</li>\n</ul>\n<h2 id=\"二：Filebeat工作原理\"><a href=\"#二：Filebeat工作原理\" class=\"headerlink\" title=\"二：Filebeat工作原理\"></a>二：Filebeat工作原理</h2><p>Filebeat由两个主要组件组成：<code>inputs</code> 和 <code>harvesters</code>（直译：收割机，采集器）。这些组件一起工作以跟踪文件，并将事件数据发送到你指定的输出。</p>\n<h3 id=\"2-1-harvester是什么\"><a href=\"#2-1-harvester是什么\" class=\"headerlink\" title=\"2.1 harvester是什么\"></a>2.1 harvester是什么</h3><p>一个<code>harvester</code>负责读取一个单个文件的内容。harvester逐行读取每个文件（一行一行地读取每个文件），并把这些内容发送到输出。每个文件启动一个harvester负责打开和关闭这个文件，这就意味着在harvester运行时文件描述符保持打开状态。而在harvester正在读取文件内容的时候，文件被删除或者重命名了，那么Filebeat会继续读这个文件。这就有一个问题了，就是只要负责这个文件的harvester没用关闭，那么磁盘空间就不会释放。默认情况下，Filebeat保存文件打开直到close_inactive到达。</p>\n<h3 id=\"2-2-input是什么\"><a href=\"#2-2-input是什么\" class=\"headerlink\" title=\"2.2 input是什么\"></a>2.2 input是什么</h3><p>一个<code>input</code>负责管理当前的harvesters，并找到所有要读取的源。如果input类型是log，则input查找paths已定义的glob路径匹配的所有日志文件，并为每个文件启动一个harvester。<br>下面的例子配置Filebeat从所有匹配指定的glob模式的文件中读取行：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/log/*.log</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/path2/*.log</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"2-3-Filebeat如何保持文件状态\"><a href=\"#2-3-Filebeat如何保持文件状态\" class=\"headerlink\" title=\"2.3 Filebeat如何保持文件状态\"></a>2.3 Filebeat如何保持文件状态</h3><p>Filebeat保存每个文件的状态，并经常刷新状态到磁盘上的注册文件（registry）。状态用于记住harvester读取文件的最后一个偏移量（行），并确保所有日志行被发送到输出（如Elasticsearch 或者 Logstash等），当输出无法访问时，那么Filebeat会跟踪已经发送的最后一行，并只要输出再次变得可用时继续读取文件。当Filebeat运行时，会将每个文件的状态新保存在内存中。当Filebeat重新启动时，将使用注册文件中的数据重新构建状态，Filebeat将在最后一个已知行位置继续每个harvester。对于每个输入，Filebeat保存它找到的每个文件的状态。因为文件可以重命名或移动，所以文件名和路径不足以标识文件。对于每个文件，Filebeat存储惟一标识符，以检测文件是否以前读取过。<br>如果你的情况涉及每天创建大量的新文件，你可能会发现注册表文件变得太大了。为了减小注册表文件的大小，有两个配置选项可用：<code>clean_remove</code>和<code>clean_inactive</code>。对于你不再访问且被忽略的旧文件，建议您使用<code>clean_inactive</code>。如果想从磁盘上删除旧文件，那么使用<code>clean_remove</code>选项。</p>\n<h3 id=\"2-4-Filebeat如何确保至少投递一次（at-least-once）\"><a href=\"#2-4-Filebeat如何确保至少投递一次（at-least-once）\" class=\"headerlink\" title=\"2.4 Filebeat如何确保至少投递一次（at-least-once）\"></a>2.4 Filebeat如何确保至少投递一次（at-least-once）</h3><p>Filebeat保证事件将被投递到配置的输出中至少一次，并且不会丢失数据。Filebeat能够实现这种行为，因为它将每个事件的投递状态存储在注册表文件中。<br>在定义的输出被阻塞且没有确认所有事件的情况下，Filebeat将继续尝试发送事件，直到输出确认收到事件为止。<br>如果Filebeat在发送事件的过程中关闭了，则在关闭之前它不会等待输出确认所有事件。当Filebeat重新启动时，发送到输出（但在Filebeat关闭前未确认）的任何事件将再次发送。这确保每个事件至少被发送一次，但是你最终可能会将重复的事件发送到输出。你可以通过设置<code>shutdown_timeout</code>选项，将Filebeat配置为在关闭之前等待特定的时间。</p>\n<h2 id=\"三：配置Filebeat\"><a href=\"#三：配置Filebeat\" class=\"headerlink\" title=\"三：配置Filebeat\"></a>三：配置Filebeat</h2><p>为了配置Filebeat，你可以编辑配置文件<code>filebeat.yml</code>。此外同级目录下还有一个完整的配置文件示例<code>filebeat.reference.yml</code></p>\n<h3 id=\"3-1-指定运行哪个模块\"><a href=\"#3-1-指定运行哪个模块\" class=\"headerlink\" title=\"3.1 指定运行哪个模块\"></a>3.1 指定运行哪个模块</h3><p>Filebeat提供了几种启用模块的不同方式：</p>\n<ul>\n<li>用<code>modules.d</code>目录下的配置启用模块</li>\n<li>运行Filebea命令的时候启用模块</li>\n<li>配置<code>filebeat.yml</code>文件启用模块配置</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 用modules.d目录启用模块配置</span></span><br><span class=\"line\">$ ./filebeat modules <span class=\"built_in\">enable</span> apache2 mysql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 运行Filebea命令的时候启用模块</span></span><br><span class=\"line\">$ ./filebeat --modules nginx,mysql,system</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置`filebeat.yml`文件启用模块配置</span></span><br><span class=\"line\">filebeat.modules:</span><br><span class=\"line\"> - module: nginx</span><br><span class=\"line\"> - module: mysql</span><br><span class=\"line\"> - module: system</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-2-配置inputs\"><a href=\"#3-2-配置inputs\" class=\"headerlink\" title=\"3.2 配置inputs\"></a>3.2 配置inputs</h3><p>为了手动配置Filebeat（代替用模块），你可以在filebeat.yml中的<code>filebeat.inputs</code>区域下指定一个inputs列表。列表是一个YMAL数组，并且你还可以指定多个inputs，相同input类型也可以指定多个。例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/log/system.log</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/log/wifi.log</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">\"/var/log/apache2/*\"</span></span><br><span class=\"line\"><span class=\"attr\">  fields:</span></span><br><span class=\"line\"><span class=\"attr\">    apache:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  fields_under_root:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></p>\n<p>上面案例是从日志文件中读取行，类型为<code>log</code>的input需要指定一个paths列表，列表中的每一项必须能够定位并抓取到日志行。此外你还可以配置其它额外的配置项（比如，fields, include_lines, exclude_lines, multiline等等）来从这些文件中过滤读取行。你设置的这些配置对当前所有这种类型的input在获取日志行的时候都生效。为了对不同的文件应用不同的配置，你需要定义多个input区域。</p>\n<h3 id=\"3-3-其他配置项\"><a href=\"#3-3-其他配置项\" class=\"headerlink\" title=\"3.3 其他配置项\"></a>3.3 其他配置项</h3><ul>\n<li><p><code>paths</code>：从预定义的目录级别下抓取所有文件。<br>例如：/var/log/<em>/</em>.log 将会抓取/var/log子目录目录下所有.log文件。它不会抓取/var/log本身目录下的日志文件。也不会抓取子目录的子目录下的日志文件。如果你应用<code>recursive_glob: true</code>设置的话，它将递归地抓取所有子目录下的所有.log文件。</p>\n</li>\n<li><p><code>recursive_glob.enabled</code><br>允许将**扩展为递归glob模式。启用这个特性后，每个路径中最右边的**被扩展为固定数量的glob模式。例如：<code>/foo/**</code>扩展到<code>/foo</code>， <code>/foo/*</code>， <code>/foo/**</code>，等等。如果启用，它将单个**扩展为8级深度*模式。这个特性默认是启用的，设置<code>recursive_glob.enabled: false</code>可以禁用它。</p>\n</li>\n<li><p><code>encoding</code><br>按照<a href=\"http://www.w3.org/TR/encoding\" target=\"_blank\" rel=\"noopener\">W3C推荐的HTML5</a>读取的文件的编码。例如：<code>plain</code>, <code>latin1</code>, <code>utf-8</code>, <code>utf-16be-bom</code>, <code>utf-16be</code>, <code>utf-16le</code>, <code>big5</code>, <code>gb18030</code>, <code>gbk</code>, <code>hz-gb-2312</code>。<code>plain</code>编码是特殊的，因为它不校验或者转换任何输入。</p>\n</li>\n<li><p><code>exclude_lines</code><br>一组正则表达式，用于匹配你想要排除的行。Filebeat会删除这组正则表达式匹配的行。默认情况下，没有行被删除。空行被忽略。如果指定了<code>multiline</code>，那么在用<code>exclude_lines</code>过滤之前会将每个多行消息合并成一个单行。（PS：也就是说，多行合并成单行后再支持排除行的过滤）<br>例如配置Filebeat删除以DBG开头的行：</p>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\">  <span class=\"string\">...</span></span><br><span class=\"line\"><span class=\"attr\">  exclude_lines:</span> <span class=\"string\">['^DBG']</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>include_lines</code><br>一组正则表达式，用于匹配你想要包含的行。Filebeat只会导出匹配这组正则表达式的行。默认情况下，所有行都被导出。空行被忽略。如果指定了<code>multipline</code>设置，每个多行消息先被合并成单行后再执行<code>include_lines</code>过滤。<br>例如配置Filebeat<code>导出以ERR或者WARN开头</code>的行：</p>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\">  <span class=\"string\">...</span></span><br><span class=\"line\"><span class=\"attr\">  include_lines:</span> <span class=\"string\">['^ERR',</span> <span class=\"string\">'^WARN'</span><span class=\"string\">]</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>如果<code>include_lines</code> 和 <code>exclude_lines</code> 都被定义了，那么Filebeat先执行include_lines后执行exclude_lines，而与这两个选项被定义的顺序没有关系。<br>例如导出那些除了以DGB开头的所有包含sometext的行：<br>    <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\">  <span class=\"string\">...</span></span><br><span class=\"line\"><span class=\"attr\">  include_lines:</span> <span class=\"string\">['sometext']</span></span><br><span class=\"line\"><span class=\"attr\">  exclude_lines:</span> <span class=\"string\">['^DBG']</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<ul>\n<li><p><code>exclude_files</code><br>需要排除的日志文件。 要匹配的正则表达式列表。 Filebeat从列表中删除与任何正则表达式匹配的文件。 默认情况下，不会删除任何文件。<br>例如忽略.gz的文件:</p>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\">  <span class=\"string\">...</span></span><br><span class=\"line\"><span class=\"attr\">  exclude_files:</span> <span class=\"string\">['\\.gz$']</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>fields</code><br>可选的附加字段。 可以自由选择这些字段，以便将其他信息添加到已抓取到的日志文件中进行过滤。</p>\n</li>\n<li><p><code>fields_under_root</code><br>设置为true可将其他字段存储为顶级字段，而不是“字段”子字典下。 如果名称与Filebeat本身添加的字段冲突，则自定义字段会覆盖默认字段。</p>\n</li>\n<li><p><code>harvester_buffer_size</code><br>当抓取一个文件时每个harvester使用的buffer的字节数。默认是16384。</p>\n</li>\n<li><p><code>max_bytes</code><br>单个日志消息允许的最大字节数。超过max_bytes的字节将被丢弃且不会发送到输出。对于多行日志消息来说这个设置是很有用的，因为它们往往很大。默认是10MB（10485760）。</p>\n</li>\n<li><p><code>json</code><br>  <code>json.keys_under_root</code><br>  默认情况下，解码后的JSON被放置在一个以”json”为key的输出文档中。如果你启用这个设置，那么这个key在文档中被复制为顶级。默认是false。</p>\n<p>  <code>json.overwrite_keys</code><br>  如果启用了keys_under_root和该设置，则解码的JSON对象中的值将覆盖Filebeat通常添加的字段（类型，来源，偏移等），以防发生冲突。</p>\n<p>  <code>json.add_error_key</code><br>  如果启用次设置，则当JSON解析出现错误的时候Filebeat添加 <code>error.message</code>和 <code>error.type: json</code>两个key，或者当没有使用message_key的时候。</p>\n<p>  <code>json.message_key</code><br>  一个可选的配置，用于在应用行过滤和多行设置的时候指定一个JSON key。指定的这个key必须在JSON对象中是顶级的，而且其关联的值必须是一个字符串，否则没有过滤或者多行聚集发送。</p>\n<p>  <code>ignore_decoding_error</code><br>  一个可选的配置，用于指定是否JSON解码错误应该被记录到日志中。如果设为true，错误将被记录。默认是false。</p>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">json.keys_under_root:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">json.add_error_key:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">json.message_key:</span> <span class=\"string\">log</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>multiline</code><br>  <code>multiline.pattern</code><br>  指定要匹配的正则表达式模式。根据您配置其他多行选项的方式，与指定正则表达式匹配的行被视为前一行的延续或新多行事件的开始。 您可以设置negate选项来否定模式。<br>  <code>multiline.negate</code><br>  定义模式是否被否定。 默认值为false。<br>  <code>multiline.match</code><br>  指定Filebeat如何将匹配行组合到事件中。 设置是在之前或之后。 这些设置的行为取决于您为negate指定的内容。</p>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">multiline.pattern:</span> <span class=\"string\">'^\\['</span></span><br><span class=\"line\"><span class=\"string\">multiline.negate:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">multiline.match:</span> <span class=\"string\">after</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>multiline.negate</th>\n<th>multiline.match</th>\n<th>Result</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>false</td>\n<td>after</td>\n<td>与模式匹配的连续行和前面不匹配的行合并成一条完整日志</td>\n</tr>\n<tr>\n<td>false</td>\n<td>before</td>\n<td>与模式匹配的连续行和后面不匹配的行合并成一条完整日志</td>\n</tr>\n<tr>\n<td>true</td>\n<td>after</td>\n<td>与模式匹配的行和后面不匹配的行组成一条完整日志</td>\n</tr>\n<tr>\n<td>true</td>\n<td>before</td>\n<td>与模式匹配的行和前面不匹配的行组成一条完整日志</td>\n</tr>\n</tbody>\n</table>\n<p><img src=\"/images/pic/multiline.jpg\" alt=\"官方说明\"></p>\n<p>例如Java堆栈跟踪由多行组成，在初始行之后的每一行都以空格开头，例如下面这样：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Exception <span class=\"keyword\">in</span> thread <span class=\"string\">\"main\"</span> java<span class=\"selector-class\">.lang</span><span class=\"selector-class\">.NullPointerException</span></span><br><span class=\"line\">        at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Book</span><span class=\"selector-class\">.getTitle</span>(Book<span class=\"selector-class\">.java</span>:<span class=\"number\">16</span>)</span><br><span class=\"line\">        at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Author</span><span class=\"selector-class\">.getBookTitles</span>(Author<span class=\"selector-class\">.java</span>:<span class=\"number\">25</span>)</span><br><span class=\"line\">        at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Bootstrap</span><span class=\"selector-class\">.main</span>(Bootstrap<span class=\"selector-class\">.java</span>:<span class=\"number\">14</span>)</span><br></pre></td></tr></table></figure></p>\n<p>为了把这些行合并成单个事件，用写了多行配置：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">multiline.pattern:</span> <span class=\"string\">'^[[:space:]]'</span></span><br><span class=\"line\"><span class=\"string\">multiline.negate:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"string\">multiline.match:</span> <span class=\"string\">after</span></span><br></pre></td></tr></table></figure></p>\n<p>下面是一个稍微更复杂的例子<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Exception <span class=\"keyword\">in</span> thread <span class=\"string\">\"main\"</span> java<span class=\"selector-class\">.lang</span><span class=\"selector-class\">.IllegalStateException</span>: A book has <span class=\"selector-tag\">a</span> null property</span><br><span class=\"line\">       at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Author</span><span class=\"selector-class\">.getBookIds</span>(Author<span class=\"selector-class\">.java</span>:<span class=\"number\">38</span>)</span><br><span class=\"line\">       at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Bootstrap</span><span class=\"selector-class\">.main</span>(Bootstrap<span class=\"selector-class\">.java</span>:<span class=\"number\">14</span>)</span><br><span class=\"line\">Caused by: java<span class=\"selector-class\">.lang</span><span class=\"selector-class\">.NullPointerException</span></span><br><span class=\"line\">       at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Book</span><span class=\"selector-class\">.getId</span>(Book<span class=\"selector-class\">.java</span>:<span class=\"number\">22</span>)</span><br><span class=\"line\">       at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Author</span><span class=\"selector-class\">.getBookIds</span>(Author<span class=\"selector-class\">.java</span>:<span class=\"number\">35</span>)</span><br><span class=\"line\">       ... <span class=\"number\">1</span> more</span><br></pre></td></tr></table></figure></p>\n<p>为了合并这个，用下面的配置：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">multiline.pattern:</span> <span class=\"string\">'^[[:space:]]+(at|\\.&#123;3&#125;)\\b|^Caused by:'</span></span><br><span class=\"line\"><span class=\"string\">multiline.negate:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"string\">multiline.match:</span> <span class=\"string\">after</span></span><br></pre></td></tr></table></figure></p>\n<p>在这个例子中，模式匹配下列行：</p>\n<ol>\n<li>以空格开头，后面跟 at 或者 … 的行</li>\n<li>以 Caused by: 开头的行</li>\n</ol>\n<ul>\n<li><p><code>ignore_older</code><br>如果启用，那么Filebeat会忽略在指定的时间跨度之前被修改的文件。如果你想要保留日志文件一个较长的时间，那么配置<code>ignore_older</code>是很有用的。例如，如果你想要开始Filebeat，但是你只想发送最近一周最新的文件，这个情况下你可以配置这个选项。你可以用时间字符串，比如2h（2小时），5m（5分钟）。默认是0，意思是禁用这个设置。你必须设置<code>ignore_older</code>比<code>close_inactive</code>更大。</p>\n</li>\n<li><p><code>close_*</code><br>close_*配置项用于在一个确定的条件或者时间点之后<code>关闭harvester</code>。关闭harvester意味着关闭文件处理器。如果在harvester关闭以后文件被更新，那么在<code>scan_frequency</code>结束后改文件将再次被拾起。然而，当harvester关闭的时候如果文件被删除或者被移动，那么Filebeat将不会被再次拾起，并且这个harvester还没有读取的数据将会丢失。</p>\n<p>  <code>close_inactive</code><br>  当启用此选项时，如果文件在指定的持续时间内未被获取，则Filebeat将关闭文件句柄。当harvester读取最后一行日志时，指定周期的计数器就开始工作了。它不基于文件的修改时间。如果关闭的文件再次更改，则会启动一个新的harvester，并且在<code>scan_frequency</code>结束后，将获得最新的更改。<br>  推荐给<code>close_inactive</code>设置一个比你的日志文件更新频率更大一点儿的值。例如，如果你的日志文件每隔几秒就会更新，你可以设置<code>close_inactive</code>为1m。如果日志文件的更新速率不固定，那么可以用多个配置。将<code>close_inactive</code>设置为更低的值意味着文件句柄可以更早关闭。然而，这样做的副作用是，如果harvester关闭了，新的日志行不会实时发送。<br>  关闭文件的时间戳不依赖于文件的修改时间。代替的，Filebeat用一个内部时间戳来反映最后一次读取文件的时间。例如，如果<code>close_inactive</code>被设置为5分钟，那么在harvester读取文件的最后一行以后，这个5分钟的倒计时就开始了。你可以用时间字符串，比如2h（2小时），5m（5分钟）。默认是5m。</p>\n<p>  <code>close_renamed</code><br>  当启用此选项时，Filebeat会在重命名文件时关闭文件处理器。默认情况下，harvester保持打开状态并继续读取文件，因为文件处理器不依赖于文件名。如果启用了<code>close_rename</code>选项，并且重命名或者移动的文件不再匹配文件模式的话，那么文件将不会再次被选中。Filebeat将无法完成文件的读取。</p>\n<p>  <code>close_removed</code><br>  当启用此选项时，Filebeat会在删除文件时关闭harvester。通常，一个文件只有在它在由<code>close_inactive</code>指定的期间内不活跃的情况下才会被删除。但是，如果一个文件被提前删除，并且你不启用<code>close_removed</code>，则Filebeat将保持文件打开，以确保harvester已经完成。如果由于文件过早地从磁盘中删除而导致文件不能完全读取，请禁用此选项。</p>\n<p>  <code>close_eof</code><br>  抓取到达文件末尾后立即关闭文件处理程序。默认情况下，此选项被禁用。 注意：潜在的数据丢失。 请务必阅读并理解此选项的文档。</p>\n<p>  <code>close_timeout</code><br>  当启用此选项是，Filebeat会给每个harvester一个预定义的生命时间。无论读到文件的什么位置，只要<code>close_timeout</code>周期到了以后就会停止读取。当你想要在文件上只花费预定义的时间时，这个选项对旧的日志文件很有用。尽管在<code>close_timeout</code>时间以后文件就关闭了，但如果文件仍然在更新，则Filebeat将根据已定义的<code>scan_frequency</code>再次启动一个新的harvester。这个harvester的<code>close_timeout</code>将再次启动，为超时倒计时。</p>\n</li>\n<li><p><code>scan_frequency</code><br>Filebeat多久检查一次指定路径下的新文件（PS：检查的频率）。例如，如果你指定的路径是 /var/log/* ，那么会以指定的<code>scan_frequency</code>频率去扫描目录下的文件（PS：周期性扫描）。指定1秒钟扫描一次目录，默认值10秒。如果你需要近实时的发送日志行的话，不要设置<code>scan_frequency</code>为一个很低的值，而应该调整<code>close_inactive</code>以至于文件处理器保持打开状态，并不断地轮询你的文件。</p>\n</li>\n</ul>\n<p>更多关于类型为<code>log</code>的输入配置，请参考<a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html\" target=\"_blank\" rel=\"noopener\">官方配置文档</a></p>\n<h2 id=\"四：加载外部配置文件\"><a href=\"#四：加载外部配置文件\" class=\"headerlink\" title=\"四：加载外部配置文件\"></a>四：加载外部配置文件</h2><p>Filebeat可以为输入和模块加载外部配置文件，允许您将配置分成多个较小的配置文件。 </p>\n<h3 id=\"4-1-配置input\"><a href=\"#4-1-配置input\" class=\"headerlink\" title=\"4.1 配置input\"></a>4.1 配置input</h3><p>对于输入配置，请在filebeat.yml文件的filebeat.config.inputs部分中指定path选项。 例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.config.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">  enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  path:</span> <span class=\"string\">configs/*.yml</span></span><br></pre></td></tr></table></figure></p>\n<p>每一个在path下的文件都必须包含一个或多个input定义，例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/log/mysql.log</span></span><br><span class=\"line\"><span class=\"attr\">  scan_frequency:</span> <span class=\"number\">10</span><span class=\"string\">s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/log/apache.log</span></span><br><span class=\"line\"><span class=\"attr\">  scan_frequency:</span> <span class=\"number\">5</span><span class=\"string\">s</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"4-2-模块配置\"><a href=\"#4-2-模块配置\" class=\"headerlink\" title=\"4.2 模块配置\"></a>4.2 模块配置</h3><p>对于模块配置，请在filebeat.yml文件的filebeat.config.modules部分中指定path选项。 默认情况下，Filebeat会加载modules.d目录中启用的模块配置。 例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.config.modules:</span></span><br><span class=\"line\"><span class=\"attr\">  enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  path:</span> <span class=\"string\">$&#123;path.config&#125;/modules.d/*.yml</span></span><br></pre></td></tr></table></figure></p>\n<p>每个被发现的配置文件必须包含一个或多个模块定义，例如：<br><figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- module: apache2</span><br><span class=\"line\">  access:</span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"built_in\">var</span>.paths: [/<span class=\"built_in\">var</span>/<span class=\"built_in\">log</span>/apache2/access.<span class=\"built_in\">log</span>*]</span><br><span class=\"line\">  <span class=\"built_in\">error</span>:</span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"built_in\">var</span>.paths: [/<span class=\"built_in\">var</span>/<span class=\"built_in\">log</span>/apache2/<span class=\"built_in\">error</span>.<span class=\"built_in\">log</span>*]</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"4-3-配置output\"><a href=\"#4-3-配置output\" class=\"headerlink\" title=\"4.3 配置output\"></a>4.3 配置output</h3><p>您可以通过在filebeat.yml配置文件的输出部分中设置选项来配置Filebeat以写入特定输出。 只能定义一个输出。支持的输出如：<code>Elasticsearch</code>, <code>Logstash</code>, <code>Kafka</code>, <code>Redis</code>, <code>File</code>, <code>Console</code>, <code>Cloud</code>。</p>\n<h4 id=\"4-3-1-配置Elasticsearch输出\"><a href=\"#4-3-1-配置Elasticsearch输出\" class=\"headerlink\" title=\"4.3.1 配置Elasticsearch输出\"></a>4.3.1 配置Elasticsearch输出</h4><p>为输出指定Elasticsearch时，Filebeat会使用Elasticsearch HTTP API将事务直接发送到Elasticsearch。例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">output.elasticsearch:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"https://localhost:9200\"]</span></span><br><span class=\"line\"><span class=\"attr\">  index:</span> <span class=\"string\">\"filebeat-<span class=\"template-variable\">%&#123;[beat.version]&#125;</span>-<span class=\"template-variable\">%&#123;+yyyy.MM.dd&#125;</span>\"</span></span><br><span class=\"line\">  <span class=\"string\">ssl.certificate_authorities:</span> <span class=\"string\">[\"/etc/pki/root/ca.pem\"]</span></span><br><span class=\"line\">  <span class=\"string\">ssl.certificate:</span> <span class=\"string\">\"/etc/pki/client/cert.pem\"</span></span><br><span class=\"line\">  <span class=\"string\">ssl.key:</span> <span class=\"string\">\"/etc/pki/client/cert.key\"</span></span><br></pre></td></tr></table></figure></p>\n<p>为了启用SSL，只需要在hosts下的所有URL添加https即可<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">output.elasticsearch:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"https://localhost:9200\"]</span></span><br><span class=\"line\"><span class=\"attr\">  username:</span> <span class=\"string\">\"filebeat_internal\"</span></span><br><span class=\"line\"><span class=\"attr\">  password:</span> <span class=\"string\">\"YOUR_PASSWORD\"</span></span><br></pre></td></tr></table></figure></p>\n<p>如果Elasticsearch节点是用IP:PORT的形式定义的，那么添加protocol:https。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">output.elasticsearch:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"localhost\"]</span></span><br><span class=\"line\"><span class=\"attr\">  protocol:</span> <span class=\"string\">\"https\"</span></span><br><span class=\"line\"><span class=\"attr\">  username:</span> <span class=\"string\">\"&#123;beatname_lc&#125;_internal\"</span></span><br><span class=\"line\"><span class=\"attr\">  password:</span> <span class=\"string\">\"&#123;pwd&#125;\"</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"4-3-2-Elasticsearch输出配置项\"><a href=\"#4-3-2-Elasticsearch输出配置项\" class=\"headerlink\" title=\"4.3.2 Elasticsearch输出配置项\"></a>4.3.2 Elasticsearch输出配置项</h4><p><code>enabled</code><br>启用或禁用该输出。默认true。</p>\n<p><code>hosts</code><br>Elasticsearch节点列表。事件以循环顺序发送到这些节点。如果一个节点变得不可访问，那么自动发送到下一个节点。每个节点可以是URL形式，也可以是IP:PORT形式。如果端口没有指定，用9200。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">output.elasticsearch:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"10.45.3.2:9220\",</span> <span class=\"string\">\"10.45.3.1:9230\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  protocol:</span> <span class=\"string\">https</span></span><br><span class=\"line\"><span class=\"attr\">  path:</span> <span class=\"string\">/elasticsearch</span></span><br></pre></td></tr></table></figure></p>\n<p><code>username</code><br>用于认证的用户名</p>\n<p><code>password</code><br>用户认证的密码</p>\n<p><code>protocol</code><br>可选值是：http 或者 https。默认是http。</p>\n<p><code>path</code><br>HTTP API调用前的HTTP路径前缀。这对于Elasticsearch监听HTTP反向代理的情况很有用。</p>\n<p><code>headers</code><br>将自定义HTTP头添加到Elasticsearch输出的每个请求。</p>\n<p><code>index</code><br>索引名字。（PS：意思是要发到哪个索引中去）。默认是<code>&quot;filebeat-%{[beat.version]}-%{+yyyy.MM.dd}&quot;</code>（例如，”filebeat-6.3.2-2017.04.26”）。如果你想改变这个设置，你需要配置 <code>setup.template.name</code> 和 <code>setup.template.pattern</code> 选项。如果你用内置的Kibana dashboards，你也需要设置<code>setup.dashboards.index</code>选项。</p>\n<p><code>indices</code><br>索引选择器规则数组，支持条件、基于格式字符串的字段访问和名称映射。如果索引缺失或没有匹配规则，将使用index字段。例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">output.elasticsearch:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"http://localhost:9200\"]</span></span><br><span class=\"line\"><span class=\"attr\">  index:</span> <span class=\"string\">\"logs-<span class=\"template-variable\">%&#123;[beat.version]&#125;</span>-<span class=\"template-variable\">%&#123;+yyyy.MM.dd&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">  indices:</span></span><br><span class=\"line\"><span class=\"attr\">    - index:</span> <span class=\"string\">\"critical-<span class=\"template-variable\">%&#123;[beat.version]&#125;</span>-<span class=\"template-variable\">%&#123;+yyyy.MM.dd&#125;</span>\"</span></span><br><span class=\"line\">      <span class=\"string\">when.contains:</span></span><br><span class=\"line\"><span class=\"attr\">        message:</span> <span class=\"string\">\"CRITICAL\"</span></span><br><span class=\"line\"><span class=\"attr\">    - index:</span> <span class=\"string\">\"error-<span class=\"template-variable\">%&#123;[beat.version]&#125;</span>-<span class=\"template-variable\">%&#123;+yyyy.MM.dd&#125;</span>\"</span></span><br><span class=\"line\">      <span class=\"string\">when.contains:</span></span><br><span class=\"line\"><span class=\"attr\">        message:</span> <span class=\"string\">\"ERR\"</span></span><br></pre></td></tr></table></figure></p>\n<p><code>timeout</code><br>请求超时时间。默认90秒。</p>\n<p>更多关于elasticsearch输出配置请参考<a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/elasticsearch-output.html#_configuration_options_8\" target=\"_blank\" rel=\"noopener\">官方文档</a><br>这里只以elasticsearch输出类型为例，更多关于output 输出类型配置，请参考官方<a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/configuring-output.html\" target=\"_blank\" rel=\"noopener\">配置输出类型</a></p>\n<h3 id=\"4-4-加载索引模板\"><a href=\"#4-4-加载索引模板\" class=\"headerlink\" title=\"4.4 加载索引模板\"></a>4.4 加载索引模板</h3><p>在filebeat.yml配置文件的<code>setup.template</code>区域指定索引模板，用来设置在Elasticsearch中的映射。如果模板加载是启用的（默认的），Filebeat在成功连接到Elasticsearch后自动加载索引模板。你可以调整下列设置或者覆盖一个已经存在的模板。</p>\n<p><code>setup.template.enabled</code><br>设为false表示禁用模板加载</p>\n<p><code>setup.template.name</code><br>模板的名字。默认是filebeat。Filebeat的版本总是跟在名字后面，所以最终的名字是 filebeat-%{[beat.version]}</p>\n<p><code>setup.template.pattern</code><br>模板的模式。默认模式是filebeat-*。例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">setup.template.name:</span> <span class=\"string\">\"filebeat\"</span></span><br><span class=\"line\"><span class=\"string\">setup.template.pattern:</span> <span class=\"string\">\"filebeat-*\"</span></span><br></pre></td></tr></table></figure></p>\n<p><code>setup.template.fields</code><br>描述字段的YAML文件路径。默认是 fields.yml。</p>\n<p><code>setup.template.overwrite</code><br>是否覆盖存在的模板。默认false。</p>\n<p><code>setup.template.settings._source</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">setup.template.name:</span> <span class=\"string\">\"filebeat\"</span></span><br><span class=\"line\"><span class=\"string\">setup.template.fields:</span> <span class=\"string\">\"fields.yml\"</span></span><br><span class=\"line\"><span class=\"string\">setup.template.overwrite:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"string\">setup.template.settings:</span></span><br><span class=\"line\">  <span class=\"string\">_source.enabled:</span> <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure></p>\n<p>有关filebeat完整的配置文档，请参考(<a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-getting-started.html\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-getting-started.html</a>)</p>\n","site":{"data":{}},"length":12138,"excerpt":"","more":"<h2 id=\"一：认识Filebeat\"><a href=\"#一：认识Filebeat\" class=\"headerlink\" title=\"一：认识Filebeat\"></a>一：认识Filebeat</h2><ul>\n<li><p><code>Filebeat</code>是beats其中一个组件，它是一个<code>轻量型日志采集器</code>，可以直接（或者通过Logstash）将数据发送到Elasticsearch，在那里你可以进一步处理和增强数据，然后在Kibana中将其可视化。</p>\n</li>\n<li><p>当您要面对成百上千、甚至成千上万的服务器、虚拟机和容器生成的日志时，请告别 SSH 吧。Filebeat 将为您提供一种轻量型方法，用于转发和汇总日志与文件，让简单的事情不再繁杂。</p>\n</li>\n<li><p>它性能稳健，不错过任何检测信号，无论在任何环境中，随时都潜伏着应用程序中断的风险。Filebeat 能够读取并转发日志行，如果出现中断，还会在一切恢复正常后，从中断前停止的位置继续开始。</p>\n</li>\n<li><p><code>Filebeat</code> 内置有多种模块（auditd、Apache、NGINX、System、MySQL 等等），可针对常见格式的日志大大简化收集、解析和可视化过程，只需一条命令即可。之所以能实现这一点，是因为它将自动默认路径（因操作系统而异）与 Elasticsearch 采集节点管道的定义和 Kibana 仪表板组合在一起。不仅如此，数个 Filebeat 模块还包括预配置的 Machine Learning 任务。</p>\n</li>\n</ul>\n<h2 id=\"二：Filebeat工作原理\"><a href=\"#二：Filebeat工作原理\" class=\"headerlink\" title=\"二：Filebeat工作原理\"></a>二：Filebeat工作原理</h2><p>Filebeat由两个主要组件组成：<code>inputs</code> 和 <code>harvesters</code>（直译：收割机，采集器）。这些组件一起工作以跟踪文件，并将事件数据发送到你指定的输出。</p>\n<h3 id=\"2-1-harvester是什么\"><a href=\"#2-1-harvester是什么\" class=\"headerlink\" title=\"2.1 harvester是什么\"></a>2.1 harvester是什么</h3><p>一个<code>harvester</code>负责读取一个单个文件的内容。harvester逐行读取每个文件（一行一行地读取每个文件），并把这些内容发送到输出。每个文件启动一个harvester负责打开和关闭这个文件，这就意味着在harvester运行时文件描述符保持打开状态。而在harvester正在读取文件内容的时候，文件被删除或者重命名了，那么Filebeat会继续读这个文件。这就有一个问题了，就是只要负责这个文件的harvester没用关闭，那么磁盘空间就不会释放。默认情况下，Filebeat保存文件打开直到close_inactive到达。</p>\n<h3 id=\"2-2-input是什么\"><a href=\"#2-2-input是什么\" class=\"headerlink\" title=\"2.2 input是什么\"></a>2.2 input是什么</h3><p>一个<code>input</code>负责管理当前的harvesters，并找到所有要读取的源。如果input类型是log，则input查找paths已定义的glob路径匹配的所有日志文件，并为每个文件启动一个harvester。<br>下面的例子配置Filebeat从所有匹配指定的glob模式的文件中读取行：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/log/*.log</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/path2/*.log</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"2-3-Filebeat如何保持文件状态\"><a href=\"#2-3-Filebeat如何保持文件状态\" class=\"headerlink\" title=\"2.3 Filebeat如何保持文件状态\"></a>2.3 Filebeat如何保持文件状态</h3><p>Filebeat保存每个文件的状态，并经常刷新状态到磁盘上的注册文件（registry）。状态用于记住harvester读取文件的最后一个偏移量（行），并确保所有日志行被发送到输出（如Elasticsearch 或者 Logstash等），当输出无法访问时，那么Filebeat会跟踪已经发送的最后一行，并只要输出再次变得可用时继续读取文件。当Filebeat运行时，会将每个文件的状态新保存在内存中。当Filebeat重新启动时，将使用注册文件中的数据重新构建状态，Filebeat将在最后一个已知行位置继续每个harvester。对于每个输入，Filebeat保存它找到的每个文件的状态。因为文件可以重命名或移动，所以文件名和路径不足以标识文件。对于每个文件，Filebeat存储惟一标识符，以检测文件是否以前读取过。<br>如果你的情况涉及每天创建大量的新文件，你可能会发现注册表文件变得太大了。为了减小注册表文件的大小，有两个配置选项可用：<code>clean_remove</code>和<code>clean_inactive</code>。对于你不再访问且被忽略的旧文件，建议您使用<code>clean_inactive</code>。如果想从磁盘上删除旧文件，那么使用<code>clean_remove</code>选项。</p>\n<h3 id=\"2-4-Filebeat如何确保至少投递一次（at-least-once）\"><a href=\"#2-4-Filebeat如何确保至少投递一次（at-least-once）\" class=\"headerlink\" title=\"2.4 Filebeat如何确保至少投递一次（at-least-once）\"></a>2.4 Filebeat如何确保至少投递一次（at-least-once）</h3><p>Filebeat保证事件将被投递到配置的输出中至少一次，并且不会丢失数据。Filebeat能够实现这种行为，因为它将每个事件的投递状态存储在注册表文件中。<br>在定义的输出被阻塞且没有确认所有事件的情况下，Filebeat将继续尝试发送事件，直到输出确认收到事件为止。<br>如果Filebeat在发送事件的过程中关闭了，则在关闭之前它不会等待输出确认所有事件。当Filebeat重新启动时，发送到输出（但在Filebeat关闭前未确认）的任何事件将再次发送。这确保每个事件至少被发送一次，但是你最终可能会将重复的事件发送到输出。你可以通过设置<code>shutdown_timeout</code>选项，将Filebeat配置为在关闭之前等待特定的时间。</p>\n<h2 id=\"三：配置Filebeat\"><a href=\"#三：配置Filebeat\" class=\"headerlink\" title=\"三：配置Filebeat\"></a>三：配置Filebeat</h2><p>为了配置Filebeat，你可以编辑配置文件<code>filebeat.yml</code>。此外同级目录下还有一个完整的配置文件示例<code>filebeat.reference.yml</code></p>\n<h3 id=\"3-1-指定运行哪个模块\"><a href=\"#3-1-指定运行哪个模块\" class=\"headerlink\" title=\"3.1 指定运行哪个模块\"></a>3.1 指定运行哪个模块</h3><p>Filebeat提供了几种启用模块的不同方式：</p>\n<ul>\n<li>用<code>modules.d</code>目录下的配置启用模块</li>\n<li>运行Filebea命令的时候启用模块</li>\n<li>配置<code>filebeat.yml</code>文件启用模块配置</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 用modules.d目录启用模块配置</span></span><br><span class=\"line\">$ ./filebeat modules <span class=\"built_in\">enable</span> apache2 mysql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 运行Filebea命令的时候启用模块</span></span><br><span class=\"line\">$ ./filebeat --modules nginx,mysql,system</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置`filebeat.yml`文件启用模块配置</span></span><br><span class=\"line\">filebeat.modules:</span><br><span class=\"line\"> - module: nginx</span><br><span class=\"line\"> - module: mysql</span><br><span class=\"line\"> - module: system</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-2-配置inputs\"><a href=\"#3-2-配置inputs\" class=\"headerlink\" title=\"3.2 配置inputs\"></a>3.2 配置inputs</h3><p>为了手动配置Filebeat（代替用模块），你可以在filebeat.yml中的<code>filebeat.inputs</code>区域下指定一个inputs列表。列表是一个YMAL数组，并且你还可以指定多个inputs，相同input类型也可以指定多个。例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/log/system.log</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/log/wifi.log</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">\"/var/log/apache2/*\"</span></span><br><span class=\"line\"><span class=\"attr\">  fields:</span></span><br><span class=\"line\"><span class=\"attr\">    apache:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  fields_under_root:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></p>\n<p>上面案例是从日志文件中读取行，类型为<code>log</code>的input需要指定一个paths列表，列表中的每一项必须能够定位并抓取到日志行。此外你还可以配置其它额外的配置项（比如，fields, include_lines, exclude_lines, multiline等等）来从这些文件中过滤读取行。你设置的这些配置对当前所有这种类型的input在获取日志行的时候都生效。为了对不同的文件应用不同的配置，你需要定义多个input区域。</p>\n<h3 id=\"3-3-其他配置项\"><a href=\"#3-3-其他配置项\" class=\"headerlink\" title=\"3.3 其他配置项\"></a>3.3 其他配置项</h3><ul>\n<li><p><code>paths</code>：从预定义的目录级别下抓取所有文件。<br>例如：/var/log/<em>/</em>.log 将会抓取/var/log子目录目录下所有.log文件。它不会抓取/var/log本身目录下的日志文件。也不会抓取子目录的子目录下的日志文件。如果你应用<code>recursive_glob: true</code>设置的话，它将递归地抓取所有子目录下的所有.log文件。</p>\n</li>\n<li><p><code>recursive_glob.enabled</code><br>允许将**扩展为递归glob模式。启用这个特性后，每个路径中最右边的**被扩展为固定数量的glob模式。例如：<code>/foo/**</code>扩展到<code>/foo</code>， <code>/foo/*</code>， <code>/foo/**</code>，等等。如果启用，它将单个**扩展为8级深度*模式。这个特性默认是启用的，设置<code>recursive_glob.enabled: false</code>可以禁用它。</p>\n</li>\n<li><p><code>encoding</code><br>按照<a href=\"http://www.w3.org/TR/encoding\" target=\"_blank\" rel=\"noopener\">W3C推荐的HTML5</a>读取的文件的编码。例如：<code>plain</code>, <code>latin1</code>, <code>utf-8</code>, <code>utf-16be-bom</code>, <code>utf-16be</code>, <code>utf-16le</code>, <code>big5</code>, <code>gb18030</code>, <code>gbk</code>, <code>hz-gb-2312</code>。<code>plain</code>编码是特殊的，因为它不校验或者转换任何输入。</p>\n</li>\n<li><p><code>exclude_lines</code><br>一组正则表达式，用于匹配你想要排除的行。Filebeat会删除这组正则表达式匹配的行。默认情况下，没有行被删除。空行被忽略。如果指定了<code>multiline</code>，那么在用<code>exclude_lines</code>过滤之前会将每个多行消息合并成一个单行。（PS：也就是说，多行合并成单行后再支持排除行的过滤）<br>例如配置Filebeat删除以DBG开头的行：</p>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\">  <span class=\"string\">...</span></span><br><span class=\"line\"><span class=\"attr\">  exclude_lines:</span> <span class=\"string\">['^DBG']</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>include_lines</code><br>一组正则表达式，用于匹配你想要包含的行。Filebeat只会导出匹配这组正则表达式的行。默认情况下，所有行都被导出。空行被忽略。如果指定了<code>multipline</code>设置，每个多行消息先被合并成单行后再执行<code>include_lines</code>过滤。<br>例如配置Filebeat<code>导出以ERR或者WARN开头</code>的行：</p>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\">  <span class=\"string\">...</span></span><br><span class=\"line\"><span class=\"attr\">  include_lines:</span> <span class=\"string\">['^ERR',</span> <span class=\"string\">'^WARN'</span><span class=\"string\">]</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>如果<code>include_lines</code> 和 <code>exclude_lines</code> 都被定义了，那么Filebeat先执行include_lines后执行exclude_lines，而与这两个选项被定义的顺序没有关系。<br>例如导出那些除了以DGB开头的所有包含sometext的行：<br>    <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\">  <span class=\"string\">...</span></span><br><span class=\"line\"><span class=\"attr\">  include_lines:</span> <span class=\"string\">['sometext']</span></span><br><span class=\"line\"><span class=\"attr\">  exclude_lines:</span> <span class=\"string\">['^DBG']</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<ul>\n<li><p><code>exclude_files</code><br>需要排除的日志文件。 要匹配的正则表达式列表。 Filebeat从列表中删除与任何正则表达式匹配的文件。 默认情况下，不会删除任何文件。<br>例如忽略.gz的文件:</p>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\">  <span class=\"string\">...</span></span><br><span class=\"line\"><span class=\"attr\">  exclude_files:</span> <span class=\"string\">['\\.gz$']</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>fields</code><br>可选的附加字段。 可以自由选择这些字段，以便将其他信息添加到已抓取到的日志文件中进行过滤。</p>\n</li>\n<li><p><code>fields_under_root</code><br>设置为true可将其他字段存储为顶级字段，而不是“字段”子字典下。 如果名称与Filebeat本身添加的字段冲突，则自定义字段会覆盖默认字段。</p>\n</li>\n<li><p><code>harvester_buffer_size</code><br>当抓取一个文件时每个harvester使用的buffer的字节数。默认是16384。</p>\n</li>\n<li><p><code>max_bytes</code><br>单个日志消息允许的最大字节数。超过max_bytes的字节将被丢弃且不会发送到输出。对于多行日志消息来说这个设置是很有用的，因为它们往往很大。默认是10MB（10485760）。</p>\n</li>\n<li><p><code>json</code><br>  <code>json.keys_under_root</code><br>  默认情况下，解码后的JSON被放置在一个以”json”为key的输出文档中。如果你启用这个设置，那么这个key在文档中被复制为顶级。默认是false。</p>\n<p>  <code>json.overwrite_keys</code><br>  如果启用了keys_under_root和该设置，则解码的JSON对象中的值将覆盖Filebeat通常添加的字段（类型，来源，偏移等），以防发生冲突。</p>\n<p>  <code>json.add_error_key</code><br>  如果启用次设置，则当JSON解析出现错误的时候Filebeat添加 <code>error.message</code>和 <code>error.type: json</code>两个key，或者当没有使用message_key的时候。</p>\n<p>  <code>json.message_key</code><br>  一个可选的配置，用于在应用行过滤和多行设置的时候指定一个JSON key。指定的这个key必须在JSON对象中是顶级的，而且其关联的值必须是一个字符串，否则没有过滤或者多行聚集发送。</p>\n<p>  <code>ignore_decoding_error</code><br>  一个可选的配置，用于指定是否JSON解码错误应该被记录到日志中。如果设为true，错误将被记录。默认是false。</p>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">json.keys_under_root:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">json.add_error_key:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">json.message_key:</span> <span class=\"string\">log</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>multiline</code><br>  <code>multiline.pattern</code><br>  指定要匹配的正则表达式模式。根据您配置其他多行选项的方式，与指定正则表达式匹配的行被视为前一行的延续或新多行事件的开始。 您可以设置negate选项来否定模式。<br>  <code>multiline.negate</code><br>  定义模式是否被否定。 默认值为false。<br>  <code>multiline.match</code><br>  指定Filebeat如何将匹配行组合到事件中。 设置是在之前或之后。 这些设置的行为取决于您为negate指定的内容。</p>\n  <figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">multiline.pattern:</span> <span class=\"string\">'^\\['</span></span><br><span class=\"line\"><span class=\"string\">multiline.negate:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">multiline.match:</span> <span class=\"string\">after</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>multiline.negate</th>\n<th>multiline.match</th>\n<th>Result</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>false</td>\n<td>after</td>\n<td>与模式匹配的连续行和前面不匹配的行合并成一条完整日志</td>\n</tr>\n<tr>\n<td>false</td>\n<td>before</td>\n<td>与模式匹配的连续行和后面不匹配的行合并成一条完整日志</td>\n</tr>\n<tr>\n<td>true</td>\n<td>after</td>\n<td>与模式匹配的行和后面不匹配的行组成一条完整日志</td>\n</tr>\n<tr>\n<td>true</td>\n<td>before</td>\n<td>与模式匹配的行和前面不匹配的行组成一条完整日志</td>\n</tr>\n</tbody>\n</table>\n<p><img src=\"/images/pic/multiline.jpg\" alt=\"官方说明\"></p>\n<p>例如Java堆栈跟踪由多行组成，在初始行之后的每一行都以空格开头，例如下面这样：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Exception <span class=\"keyword\">in</span> thread <span class=\"string\">\"main\"</span> java<span class=\"selector-class\">.lang</span><span class=\"selector-class\">.NullPointerException</span></span><br><span class=\"line\">        at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Book</span><span class=\"selector-class\">.getTitle</span>(Book<span class=\"selector-class\">.java</span>:<span class=\"number\">16</span>)</span><br><span class=\"line\">        at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Author</span><span class=\"selector-class\">.getBookTitles</span>(Author<span class=\"selector-class\">.java</span>:<span class=\"number\">25</span>)</span><br><span class=\"line\">        at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Bootstrap</span><span class=\"selector-class\">.main</span>(Bootstrap<span class=\"selector-class\">.java</span>:<span class=\"number\">14</span>)</span><br></pre></td></tr></table></figure></p>\n<p>为了把这些行合并成单个事件，用写了多行配置：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">multiline.pattern:</span> <span class=\"string\">'^[[:space:]]'</span></span><br><span class=\"line\"><span class=\"string\">multiline.negate:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"string\">multiline.match:</span> <span class=\"string\">after</span></span><br></pre></td></tr></table></figure></p>\n<p>下面是一个稍微更复杂的例子<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Exception <span class=\"keyword\">in</span> thread <span class=\"string\">\"main\"</span> java<span class=\"selector-class\">.lang</span><span class=\"selector-class\">.IllegalStateException</span>: A book has <span class=\"selector-tag\">a</span> null property</span><br><span class=\"line\">       at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Author</span><span class=\"selector-class\">.getBookIds</span>(Author<span class=\"selector-class\">.java</span>:<span class=\"number\">38</span>)</span><br><span class=\"line\">       at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Bootstrap</span><span class=\"selector-class\">.main</span>(Bootstrap<span class=\"selector-class\">.java</span>:<span class=\"number\">14</span>)</span><br><span class=\"line\">Caused by: java<span class=\"selector-class\">.lang</span><span class=\"selector-class\">.NullPointerException</span></span><br><span class=\"line\">       at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Book</span><span class=\"selector-class\">.getId</span>(Book<span class=\"selector-class\">.java</span>:<span class=\"number\">22</span>)</span><br><span class=\"line\">       at com<span class=\"selector-class\">.example</span><span class=\"selector-class\">.myproject</span><span class=\"selector-class\">.Author</span><span class=\"selector-class\">.getBookIds</span>(Author<span class=\"selector-class\">.java</span>:<span class=\"number\">35</span>)</span><br><span class=\"line\">       ... <span class=\"number\">1</span> more</span><br></pre></td></tr></table></figure></p>\n<p>为了合并这个，用下面的配置：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">multiline.pattern:</span> <span class=\"string\">'^[[:space:]]+(at|\\.&#123;3&#125;)\\b|^Caused by:'</span></span><br><span class=\"line\"><span class=\"string\">multiline.negate:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"string\">multiline.match:</span> <span class=\"string\">after</span></span><br></pre></td></tr></table></figure></p>\n<p>在这个例子中，模式匹配下列行：</p>\n<ol>\n<li>以空格开头，后面跟 at 或者 … 的行</li>\n<li>以 Caused by: 开头的行</li>\n</ol>\n<ul>\n<li><p><code>ignore_older</code><br>如果启用，那么Filebeat会忽略在指定的时间跨度之前被修改的文件。如果你想要保留日志文件一个较长的时间，那么配置<code>ignore_older</code>是很有用的。例如，如果你想要开始Filebeat，但是你只想发送最近一周最新的文件，这个情况下你可以配置这个选项。你可以用时间字符串，比如2h（2小时），5m（5分钟）。默认是0，意思是禁用这个设置。你必须设置<code>ignore_older</code>比<code>close_inactive</code>更大。</p>\n</li>\n<li><p><code>close_*</code><br>close_*配置项用于在一个确定的条件或者时间点之后<code>关闭harvester</code>。关闭harvester意味着关闭文件处理器。如果在harvester关闭以后文件被更新，那么在<code>scan_frequency</code>结束后改文件将再次被拾起。然而，当harvester关闭的时候如果文件被删除或者被移动，那么Filebeat将不会被再次拾起，并且这个harvester还没有读取的数据将会丢失。</p>\n<p>  <code>close_inactive</code><br>  当启用此选项时，如果文件在指定的持续时间内未被获取，则Filebeat将关闭文件句柄。当harvester读取最后一行日志时，指定周期的计数器就开始工作了。它不基于文件的修改时间。如果关闭的文件再次更改，则会启动一个新的harvester，并且在<code>scan_frequency</code>结束后，将获得最新的更改。<br>  推荐给<code>close_inactive</code>设置一个比你的日志文件更新频率更大一点儿的值。例如，如果你的日志文件每隔几秒就会更新，你可以设置<code>close_inactive</code>为1m。如果日志文件的更新速率不固定，那么可以用多个配置。将<code>close_inactive</code>设置为更低的值意味着文件句柄可以更早关闭。然而，这样做的副作用是，如果harvester关闭了，新的日志行不会实时发送。<br>  关闭文件的时间戳不依赖于文件的修改时间。代替的，Filebeat用一个内部时间戳来反映最后一次读取文件的时间。例如，如果<code>close_inactive</code>被设置为5分钟，那么在harvester读取文件的最后一行以后，这个5分钟的倒计时就开始了。你可以用时间字符串，比如2h（2小时），5m（5分钟）。默认是5m。</p>\n<p>  <code>close_renamed</code><br>  当启用此选项时，Filebeat会在重命名文件时关闭文件处理器。默认情况下，harvester保持打开状态并继续读取文件，因为文件处理器不依赖于文件名。如果启用了<code>close_rename</code>选项，并且重命名或者移动的文件不再匹配文件模式的话，那么文件将不会再次被选中。Filebeat将无法完成文件的读取。</p>\n<p>  <code>close_removed</code><br>  当启用此选项时，Filebeat会在删除文件时关闭harvester。通常，一个文件只有在它在由<code>close_inactive</code>指定的期间内不活跃的情况下才会被删除。但是，如果一个文件被提前删除，并且你不启用<code>close_removed</code>，则Filebeat将保持文件打开，以确保harvester已经完成。如果由于文件过早地从磁盘中删除而导致文件不能完全读取，请禁用此选项。</p>\n<p>  <code>close_eof</code><br>  抓取到达文件末尾后立即关闭文件处理程序。默认情况下，此选项被禁用。 注意：潜在的数据丢失。 请务必阅读并理解此选项的文档。</p>\n<p>  <code>close_timeout</code><br>  当启用此选项是，Filebeat会给每个harvester一个预定义的生命时间。无论读到文件的什么位置，只要<code>close_timeout</code>周期到了以后就会停止读取。当你想要在文件上只花费预定义的时间时，这个选项对旧的日志文件很有用。尽管在<code>close_timeout</code>时间以后文件就关闭了，但如果文件仍然在更新，则Filebeat将根据已定义的<code>scan_frequency</code>再次启动一个新的harvester。这个harvester的<code>close_timeout</code>将再次启动，为超时倒计时。</p>\n</li>\n<li><p><code>scan_frequency</code><br>Filebeat多久检查一次指定路径下的新文件（PS：检查的频率）。例如，如果你指定的路径是 /var/log/* ，那么会以指定的<code>scan_frequency</code>频率去扫描目录下的文件（PS：周期性扫描）。指定1秒钟扫描一次目录，默认值10秒。如果你需要近实时的发送日志行的话，不要设置<code>scan_frequency</code>为一个很低的值，而应该调整<code>close_inactive</code>以至于文件处理器保持打开状态，并不断地轮询你的文件。</p>\n</li>\n</ul>\n<p>更多关于类型为<code>log</code>的输入配置，请参考<a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html\" target=\"_blank\" rel=\"noopener\">官方配置文档</a></p>\n<h2 id=\"四：加载外部配置文件\"><a href=\"#四：加载外部配置文件\" class=\"headerlink\" title=\"四：加载外部配置文件\"></a>四：加载外部配置文件</h2><p>Filebeat可以为输入和模块加载外部配置文件，允许您将配置分成多个较小的配置文件。 </p>\n<h3 id=\"4-1-配置input\"><a href=\"#4-1-配置input\" class=\"headerlink\" title=\"4.1 配置input\"></a>4.1 配置input</h3><p>对于输入配置，请在filebeat.yml文件的filebeat.config.inputs部分中指定path选项。 例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.config.inputs:</span></span><br><span class=\"line\"><span class=\"attr\">  enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  path:</span> <span class=\"string\">configs/*.yml</span></span><br></pre></td></tr></table></figure></p>\n<p>每一个在path下的文件都必须包含一个或多个input定义，例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/log/mysql.log</span></span><br><span class=\"line\"><span class=\"attr\">  scan_frequency:</span> <span class=\"number\">10</span><span class=\"string\">s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- type:</span> <span class=\"string\">log</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/var/log/apache.log</span></span><br><span class=\"line\"><span class=\"attr\">  scan_frequency:</span> <span class=\"number\">5</span><span class=\"string\">s</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"4-2-模块配置\"><a href=\"#4-2-模块配置\" class=\"headerlink\" title=\"4.2 模块配置\"></a>4.2 模块配置</h3><p>对于模块配置，请在filebeat.yml文件的filebeat.config.modules部分中指定path选项。 默认情况下，Filebeat会加载modules.d目录中启用的模块配置。 例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">filebeat.config.modules:</span></span><br><span class=\"line\"><span class=\"attr\">  enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  path:</span> <span class=\"string\">$&#123;path.config&#125;/modules.d/*.yml</span></span><br></pre></td></tr></table></figure></p>\n<p>每个被发现的配置文件必须包含一个或多个模块定义，例如：<br><figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- module: apache2</span><br><span class=\"line\">  access:</span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"built_in\">var</span>.paths: [/<span class=\"built_in\">var</span>/<span class=\"built_in\">log</span>/apache2/access.<span class=\"built_in\">log</span>*]</span><br><span class=\"line\">  <span class=\"built_in\">error</span>:</span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"built_in\">var</span>.paths: [/<span class=\"built_in\">var</span>/<span class=\"built_in\">log</span>/apache2/<span class=\"built_in\">error</span>.<span class=\"built_in\">log</span>*]</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"4-3-配置output\"><a href=\"#4-3-配置output\" class=\"headerlink\" title=\"4.3 配置output\"></a>4.3 配置output</h3><p>您可以通过在filebeat.yml配置文件的输出部分中设置选项来配置Filebeat以写入特定输出。 只能定义一个输出。支持的输出如：<code>Elasticsearch</code>, <code>Logstash</code>, <code>Kafka</code>, <code>Redis</code>, <code>File</code>, <code>Console</code>, <code>Cloud</code>。</p>\n<h4 id=\"4-3-1-配置Elasticsearch输出\"><a href=\"#4-3-1-配置Elasticsearch输出\" class=\"headerlink\" title=\"4.3.1 配置Elasticsearch输出\"></a>4.3.1 配置Elasticsearch输出</h4><p>为输出指定Elasticsearch时，Filebeat会使用Elasticsearch HTTP API将事务直接发送到Elasticsearch。例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">output.elasticsearch:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"https://localhost:9200\"]</span></span><br><span class=\"line\"><span class=\"attr\">  index:</span> <span class=\"string\">\"filebeat-<span class=\"template-variable\">%&#123;[beat.version]&#125;</span>-<span class=\"template-variable\">%&#123;+yyyy.MM.dd&#125;</span>\"</span></span><br><span class=\"line\">  <span class=\"string\">ssl.certificate_authorities:</span> <span class=\"string\">[\"/etc/pki/root/ca.pem\"]</span></span><br><span class=\"line\">  <span class=\"string\">ssl.certificate:</span> <span class=\"string\">\"/etc/pki/client/cert.pem\"</span></span><br><span class=\"line\">  <span class=\"string\">ssl.key:</span> <span class=\"string\">\"/etc/pki/client/cert.key\"</span></span><br></pre></td></tr></table></figure></p>\n<p>为了启用SSL，只需要在hosts下的所有URL添加https即可<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">output.elasticsearch:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"https://localhost:9200\"]</span></span><br><span class=\"line\"><span class=\"attr\">  username:</span> <span class=\"string\">\"filebeat_internal\"</span></span><br><span class=\"line\"><span class=\"attr\">  password:</span> <span class=\"string\">\"YOUR_PASSWORD\"</span></span><br></pre></td></tr></table></figure></p>\n<p>如果Elasticsearch节点是用IP:PORT的形式定义的，那么添加protocol:https。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">output.elasticsearch:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"localhost\"]</span></span><br><span class=\"line\"><span class=\"attr\">  protocol:</span> <span class=\"string\">\"https\"</span></span><br><span class=\"line\"><span class=\"attr\">  username:</span> <span class=\"string\">\"&#123;beatname_lc&#125;_internal\"</span></span><br><span class=\"line\"><span class=\"attr\">  password:</span> <span class=\"string\">\"&#123;pwd&#125;\"</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"4-3-2-Elasticsearch输出配置项\"><a href=\"#4-3-2-Elasticsearch输出配置项\" class=\"headerlink\" title=\"4.3.2 Elasticsearch输出配置项\"></a>4.3.2 Elasticsearch输出配置项</h4><p><code>enabled</code><br>启用或禁用该输出。默认true。</p>\n<p><code>hosts</code><br>Elasticsearch节点列表。事件以循环顺序发送到这些节点。如果一个节点变得不可访问，那么自动发送到下一个节点。每个节点可以是URL形式，也可以是IP:PORT形式。如果端口没有指定，用9200。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">output.elasticsearch:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"10.45.3.2:9220\",</span> <span class=\"string\">\"10.45.3.1:9230\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  protocol:</span> <span class=\"string\">https</span></span><br><span class=\"line\"><span class=\"attr\">  path:</span> <span class=\"string\">/elasticsearch</span></span><br></pre></td></tr></table></figure></p>\n<p><code>username</code><br>用于认证的用户名</p>\n<p><code>password</code><br>用户认证的密码</p>\n<p><code>protocol</code><br>可选值是：http 或者 https。默认是http。</p>\n<p><code>path</code><br>HTTP API调用前的HTTP路径前缀。这对于Elasticsearch监听HTTP反向代理的情况很有用。</p>\n<p><code>headers</code><br>将自定义HTTP头添加到Elasticsearch输出的每个请求。</p>\n<p><code>index</code><br>索引名字。（PS：意思是要发到哪个索引中去）。默认是<code>&quot;filebeat-%{[beat.version]}-%{+yyyy.MM.dd}&quot;</code>（例如，”filebeat-6.3.2-2017.04.26”）。如果你想改变这个设置，你需要配置 <code>setup.template.name</code> 和 <code>setup.template.pattern</code> 选项。如果你用内置的Kibana dashboards，你也需要设置<code>setup.dashboards.index</code>选项。</p>\n<p><code>indices</code><br>索引选择器规则数组，支持条件、基于格式字符串的字段访问和名称映射。如果索引缺失或没有匹配规则，将使用index字段。例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">output.elasticsearch:</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">[\"http://localhost:9200\"]</span></span><br><span class=\"line\"><span class=\"attr\">  index:</span> <span class=\"string\">\"logs-<span class=\"template-variable\">%&#123;[beat.version]&#125;</span>-<span class=\"template-variable\">%&#123;+yyyy.MM.dd&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">  indices:</span></span><br><span class=\"line\"><span class=\"attr\">    - index:</span> <span class=\"string\">\"critical-<span class=\"template-variable\">%&#123;[beat.version]&#125;</span>-<span class=\"template-variable\">%&#123;+yyyy.MM.dd&#125;</span>\"</span></span><br><span class=\"line\">      <span class=\"string\">when.contains:</span></span><br><span class=\"line\"><span class=\"attr\">        message:</span> <span class=\"string\">\"CRITICAL\"</span></span><br><span class=\"line\"><span class=\"attr\">    - index:</span> <span class=\"string\">\"error-<span class=\"template-variable\">%&#123;[beat.version]&#125;</span>-<span class=\"template-variable\">%&#123;+yyyy.MM.dd&#125;</span>\"</span></span><br><span class=\"line\">      <span class=\"string\">when.contains:</span></span><br><span class=\"line\"><span class=\"attr\">        message:</span> <span class=\"string\">\"ERR\"</span></span><br></pre></td></tr></table></figure></p>\n<p><code>timeout</code><br>请求超时时间。默认90秒。</p>\n<p>更多关于elasticsearch输出配置请参考<a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/elasticsearch-output.html#_configuration_options_8\" target=\"_blank\" rel=\"noopener\">官方文档</a><br>这里只以elasticsearch输出类型为例，更多关于output 输出类型配置，请参考官方<a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/configuring-output.html\" target=\"_blank\" rel=\"noopener\">配置输出类型</a></p>\n<h3 id=\"4-4-加载索引模板\"><a href=\"#4-4-加载索引模板\" class=\"headerlink\" title=\"4.4 加载索引模板\"></a>4.4 加载索引模板</h3><p>在filebeat.yml配置文件的<code>setup.template</code>区域指定索引模板，用来设置在Elasticsearch中的映射。如果模板加载是启用的（默认的），Filebeat在成功连接到Elasticsearch后自动加载索引模板。你可以调整下列设置或者覆盖一个已经存在的模板。</p>\n<p><code>setup.template.enabled</code><br>设为false表示禁用模板加载</p>\n<p><code>setup.template.name</code><br>模板的名字。默认是filebeat。Filebeat的版本总是跟在名字后面，所以最终的名字是 filebeat-%{[beat.version]}</p>\n<p><code>setup.template.pattern</code><br>模板的模式。默认模式是filebeat-*。例如：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">setup.template.name:</span> <span class=\"string\">\"filebeat\"</span></span><br><span class=\"line\"><span class=\"string\">setup.template.pattern:</span> <span class=\"string\">\"filebeat-*\"</span></span><br></pre></td></tr></table></figure></p>\n<p><code>setup.template.fields</code><br>描述字段的YAML文件路径。默认是 fields.yml。</p>\n<p><code>setup.template.overwrite</code><br>是否覆盖存在的模板。默认false。</p>\n<p><code>setup.template.settings._source</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">setup.template.name:</span> <span class=\"string\">\"filebeat\"</span></span><br><span class=\"line\"><span class=\"string\">setup.template.fields:</span> <span class=\"string\">\"fields.yml\"</span></span><br><span class=\"line\"><span class=\"string\">setup.template.overwrite:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"string\">setup.template.settings:</span></span><br><span class=\"line\">  <span class=\"string\">_source.enabled:</span> <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure></p>\n<p>有关filebeat完整的配置文档，请参考(<a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-getting-started.html\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-getting-started.html</a>)</p>\n"},{"layout":"post","title":"Mysql状态信息查询","author":"Pyker","img":"/images/bar/mysql.jpg","top":false,"cover":false,"date":"2018-10-22T13:47:00.000Z","_content":"Mysql在安装运行后，其性能并不一定为实际需要的性能，因此我们常常会在mysql运行一段时间后进行mysql的性能状态查询来了解mysql服务器的性能指标，从而来优化mysql。\n\n### 查看mysql性能状态命令\n\n#### 查看mysql全局状态\n```\nmysql> show global status;\n可以列出MySQL服务器运行各种状态值，另外，查询MySQL服务器配置信息语句。\n```\n```\nmysql> show variables;\n可以查看Mysql系统变量及其值。\n```\n```\nmysql> show processlist;\n可以查看Mysql当前连接数的进程以及状态。\n```\n#### 慢查询\n```\nmysql> show variables like '%slow%'; \n+------------------+-------+ \n| Variable_name | Value | \n+------------------+-------+ \n| log_slow_queries | ON | \n| slow_launch_time | 2 | \n+------------------+-------+ \n\nmysql> show global status like '%slow%'; \n+---------------------+-------+ \n| Variable_name | Value | \n+---------------------+-------+ \n| Slow_launch_threads | 0 | \n| Slow_queries | 4148 | \n+---------------------+-------+　　\n```\n配置中打开了记录慢查询，执行时间超过2秒的即为慢查询，系统显示有4148个慢查询，你可以分析慢查询日志，找出有问题的SQL语句，慢查询时间不宜设置过长，否则意义不大，最好在5秒以内，如果你需要微秒级别的慢查询，可以考虑给[MySQL打补丁](http://www.percona.com/docs/wiki/release:start) ，记得找对应的版本。\n\n打开慢查询日志可能会对系统性能有一点点影响，如果你的MySQL是主-从结构，可以考虑打开其中一台从服务器的慢查询日志，这样既可以监控慢查询，对系统性能影响又小。\n\n#### 连接数\n经常会遇见`”MySQL: ERROR 1040: Too many connections”`的情况，一种是访问量确实很高，MySQL服务器抗不住，这个时候就要考虑增加从服务器分散读压力，另外一种情况是MySQL配置文件中max_connections值过小：\n```\nmysql> show variables like 'max_connections'; \n+-----------------+-------+ \n| Variable_name | Value | \n+-----------------+-------+ \n| max_connections | 256 | \n+-----------------+-------+　\n```\n这台MySQL服务器最大连接数是256，然后查询一下服务器响应的最大连接数：\n```\nmysql> show global status like ‘Max_used_connections’;\n```\nMySQL服务器过去的最大连接数是245，没有达到服务器连接数上限256，应该没有出现1040错误，比较理想的设置是：`Max_used_connections / max_connections * 100% ≈ 85%` 最大连接数占上限连接数的85%左右，如果发现比例在10%以下，MySQL服务器连接数上限设置的过高了。\n\n#### Key_buffer_size \nkey_buffer_size是对MyISAM表性能影响最大的一个参数，下面一台以MyISAM为主要存储引擎服务器的配置： \n```\nmysql> show variables like ‘key_buffer_size’; \n+-----------------+------------+ \n| Variable_name | Value | \n+-----------------+------------+ \n| key_buffer_size | 536870912 | \n+-----------------+------------+　　\n```\n分配了512MB内存给key_buffer_size，我们再看一下key_buffer_size的使用情况： \n```\nmysql> show global status like 'key_read%'; \n+------------------------+-------------+ \n| Variable_name | Value | mysql \n+------------------------+-------------+ \n| Key_read_requests | 27813678764 | \n| Key_reads | 6798830 | \n+------------------------+-------------+　　\n```\n一共有27813678764个索引读取请求，有6798830个请求在内存中没有找到直接从硬盘读取索引，计算索引未命中缓存的概率：`key_cache_miss_rate = Key_reads / Key_read_requests * 100%`\n比如上面的数据，key_cache_miss_rate为0.0244%，4000个索引读取请求才有一个直接读硬盘，已经很BT了,key_cache_miss_rate在0.1%以下都很好(每1000个请求有一个直接读硬盘)，如果key_cache_miss_rate在0.01%以下的话，key_buffer_size分配的过多，可以适当减少。\nMySQL服务器还提供了key_blocks_*参数： \n```\nmysql> show global status like 'key_blocks_u%'; \n+------------------------+-------------+ \n| Variable_name | Value | \n+------------------------+-------------+ \n| Key_blocks_unused | 0 | \n| Key_blocks_used | 413543 | \n+------------------------+-------------+　　\n```\nKey_blocks_unused表示未使用的缓存簇(blocks)数，Key_blocks_used表示曾经用到的最大的blocks数，比如这台服务器，所有的缓存都用到了，要么增加key_buffer_size，要么就是过渡索引了，把缓存占满了。比较理想的设置： \nKey_blocks_used / (Key_blocks_unused + Key_blocks_used) * 100% ≈ 80%\n\n#### 临时表\n``` \nmysql> show global status like 'created_tmp%'; \n+-------------------------+---------+ \n| Variable_name | Value | \n+-------------------------+---------+ \n| Created_tmp_disk_tables | 21197 | \n| Created_tmp_files | 58 | \n| Created_tmp_tables | 1771587 | \n+-------------------------+---------+　　\n```\n每次创建临时表，Created_tmp_tables增加，如果是在磁盘上创建临时表，Created_tmp_disk_tables也增加,Created_tmp_files表示MySQL服务创建的临时文件文件数，比较理想的配置是：\n`Created_tmp_disk_tables / Created_tmp_tables * 100% <= 25% `\n比如上面的服务器`Created_tmp_disk_tables / Created_tmp_tables * 100% = 1.20%`, 应该相当好了。我们再看一下MySQL服务器对临时表的配置： \n```\nmysql> show variables where Variable_name in ('tmp_table_size', 'max_heap_table_size'); \n+---------------------+-----------+ \n| Variable_name | Value | \n+---------------------+-----------+ \n| max_heap_table_size | 268435456 | \n| tmp_table_size | 536870912 | \n+---------------------+-----------+　　\n```\n只有256MB以下的临时表才能全部放内存，超过的就会用到硬盘临时表。\n\n#### Open Table\n```\nmysql> show global status like 'open%tables%'; \n+---------------+-------+ \n| Variable_name | Value | \n+---------------+-------+ \n| Open_tables | 919 | \n| Opened_tables | 1951 | \n+---------------+-------+　　\n```\nOpen_tables表示打开表的数量，Opened_tables表示打开过的表数量，如果Opened_tables数量过大，说明配置中table_cache(5.1.3之后这个值叫做table_open_cache)值可能太小，我们查询一下服务器table_cache值： \n```\nmysql> show variables like 'table_cache'; \n+---------------+-------+ \n| Variable_name | Value | \n+---------------+-------+ \n| table_cache | 2048 | \n+---------------+-------+\n```\n比较合适的值为： \n`Open_tables / Opened_tables * 100% >= 85%`, 及`Open_tables / table_cache * 100% <= 95%``\n\n六、进程使用情况\n```\nmysql> show global status like ‘Thread%’; \n+-------------------+-------+ \n| Variable_name | Value | \n+-------------------+-------+ \n| Threads_cached | 46 | \n| Threads_connected | 2 | \n| Threads_created | 570 | \n| Threads_running | 1 | \n+-------------------+-------+　　\n```\n如果我们在MySQL服务器配置文件中设置了`thread_cache_size`， 当客户端断开之后，服务器处理此客户的线程将会缓存起来以响应下一个客户而不是销毁(前提是缓存数未达上限)。Threads_created表示创建过的线程数，如果发现Threads_created值过大的话，表明MySQL服务器一直在创建线程，这也是比较耗资源，可以适当增加配置文件中thread_cache_size值，查询服务器thread_cache_size配置： \n```\nmysql> show variables like 'thread_cache_size'; \n+-------------------+-------+ \n| Variable_name | Value | \n+-------------------+-------+ \n| thread_cache_size | 64 | \n+-------------------+-------+　　\n```\n示例中的服务器还是挺健康的。\n\n#### 查询缓存(query cache) \n```\nmysql> show global status like 'qcache%'; \n+-------------------------+-----------+ \n| Variable_name | Value | \n+-------------------------+-----------+ \n| Qcache_free_blocks | 22756 | \n| Qcache_free_memory | 76764704 | \n| Qcache_hits | 213028692 | \n| Qcache_inserts | 208894227 | \n| Qcache_lowmem_prunes | 4010916 | \n| Qcache_not_cached | 13385031 | \n| Qcache_queries_in_cache | 43560 | \n| Qcache_total_blocks | 111212 | \n+-------------------------+-----------+　　\n```\nMySQL查询缓存变量解释：\n`Qcache_free_blocks`： 缓存中相邻内存块的个数。数目大说明可能有碎片。FLUSH QUERY CACHE会对缓存中的碎片进行整理，从而得到一个空闲块。\n`Qcache_free_memory`： 缓存中的空闲内存。 \n`Qcache_hits`： 每次查询在缓存中命中时就增大\n`Qcache_inserts`： 每次插入一个查询时就增大。命中次数除以插入次数就是不中比率。\n`Qcache_lowmem_prunes`： 缓存出现内存不足并且必须要进行清理以便为更多查询提供空间的次数。这个数字最好长时间来看;如果这个数字在不断增长，就表示可能碎片非常严重，或者内存很少。(上面的 free_blocks和free_memory可以告诉您属于哪种情况) \n`Qcache_not_cached`： 不适合进行缓存的查询的数量，通常是由于这些查询不是 SELECT 语句或者用了now()之类的函数。\n`Qcache_queries_in_cache`： 当前缓存的查询(和响应)的数量。\n`Qcache_total_blocks`： 缓存中块的数量。\n\n我们再查询一下服务器关于query_cache的配置： \n```\nmysql> show variables like 'query_cache%'; \n+------------------------------+-----------+ \n| Variable_name | Value | \n+------------------------------+-----------+ \n| query_cache_limit | 2097152 | \n| query_cache_min_res_unit | 4096 | \n| query_cache_size | 203423744 | \n| query_cache_type | ON | \n| query_cache_wlock_invalidate | OFF |\n+——————————+———–+\n```\n各字段的解释：\n`query_cache_limit`： 超过此大小的查询将不缓存\n`query_cache_min_res_unit`： 缓存块的最小大小\n`query_cache_size`： 查询缓存大小\n`query_cache_type`： 缓存类型，决定缓存什么样的查询，示例中表示不缓存 select sql_no_cache 查询 \n`query_cache_wlock_invalidate`： 当有其他客户端正在对MyISAM表进行写操作时，如果查询在query cache中，是否返回cache结果还是等写操作完成再读表获取结果。\n`query_cache_min_res_unit` 的配置是一柄”双刃剑”，默认是4KB，设置值大对大数据查询有好处，但如果你的查询都是小数据查询，就容易造成内存碎片和浪费。\n\n查询缓存碎片率 = `Qcache_free_blocks / Qcache_total_blocks * 100%`\n如果查询缓存碎片率超过20%，可以用FLUSH QUERY CACHE整理缓存碎片，或者试试减小query_cache_min_res_unit，如果你的查询都是小数据量的话。\n查询缓存利用率 = `(query_cache_size - Qcache_free_memory) / query_cache_size * 100%`\n查询缓存利用率在25%以下的话说明`query_cache_size`设置的过大，可适当减小;查询缓存利用率在80%以上而且Qcache_lowmem_prunes > 50的话说明query_cache_size可能有点小，要不就是碎片太多。 \n查询缓存命中率 = `(Qcache_hits - Qcache_inserts) / Qcache_hits * 100%`\n示例服务器 查询缓存碎片率 = 20.46%，查询缓存利用率 = 62.26%，查询缓存命中率 = 1.94%，命中率很差，可能写操作比较频繁吧，而且可能有些碎片。\n\n#### 排序使用情况 \n```\nmysql> show global status like 'sort%'; \n+-------------------+------------+ \n| Variable_name | Value | \n+-------------------+------------+ \n| Sort_merge_passes | 29 | \n| Sort_range | 37432840 | \n| Sort_rows | 9178691532 | \n| Sort_scan | 1860569 | \n+-------------------+------------+　　\n```\n`Sort_merge_passes` 包括两步。MySQL 首先会尝试在内存中做排序，使用的内存大小由系统变量 Sort_buffer_size 决定，如果它的大小不够把所有的记录都读到内存中，MySQL 就会把每次在内存中排序的结果存到临时文件中，等 MySQL 找到所有记录之后，再把临时文件中的记录做一次排序。这再次排序就会增加 Sort_merge_passes。实际上，MySQL 会用另一个临时文件来存再次排序的结果，所以通常会看到 Sort_merge_passes 增加的数值是建临时文件数的两倍。因为用到了临时文件，所以速度可能会比较慢，增加 Sort_buffer_size 会减少 Sort_merge_passes 和 创建临时文件的次数。但盲目的增加 Sort_buffer_size 并不一定能提高速度。\n另外，增加read_rnd_buffer_size(3.2.3是record_rnd_buffer_size)的值对排序的操作也有一点的好处，参见：<http://www.mysqlperformanceblog.com/2007/07/24/what-exactly-is-read_rnd_buffer_size/>\n\n#### 文件打开数(open_files) \n```\nmysql> show global status like 'open_files'; \n+---------------+-------+ \n| Variable_name | Value | \n+---------------+-------+ \n| Open_files | 1410 | \n+---------------+-------+ \nmysql> show variables like 'open_files_limit'; \n+------------------+-------+ \n| Variable_name | Value | \n+------------------+-------+ \n| open_files_limit | 4590 | \n+------------------+-------+　　\n```\n比较合适的设置：`Open_files / open_files_limit * 100% <= 75%`\n\n#### 表锁情况 \n```\nmysql> show global status like 'table_locks%'; \n+-----------------------+-----------+ \n| Variable_name | Value | \n+-----------------------+-----------+ \n| Table_locks_immediate | 490206328 | \n| Table_locks_waited | 2084912 | \n+-----------------------+-----------+　　\n```\n`Table_locks_immediate` 表示立即释放表锁数，`Table_locks_waited` 表示需要等待的表锁数，如果Table_locks_immediate / Table_locks_waited > 5000，最好采用InnoDB引擎，因为InnoDB是行锁而MyISAM是表锁，对于高并发写入的应用InnoDB效果会好些。示例中的服务器Table_locks_immediate / Table_locks_waited = 235，MyISAM就足够了。\n\n#### 表扫描情况 \n```\nmysql> show global status like 'handler_read%'; \n+-----------------------+-------------+ \n| Variable_name | Value | \n+-----------------------+-------------+ \n| Handler_read_first | 5803750 | \n| Handler_read_key | 6049319850 | \n| Handler_read_next | 94440908210 | \n| Handler_read_prev | 34822001724 | \n| Handler_read_rnd | 405482605 | \n| Handler_read_rnd_next | 18912877839 | \n+-----------------------+-------------+　　\n\nmysql> show global status like 'com_select'; \n+---------------+-----------+ \n| Variable_name | Value | \n+---------------+-----------+ \n| Com_select | 222693559 | \n+---------------+-----------+　　\n```\n计算表扫描率：\n表扫描率 = Handler_read_rnd_next / Com_select\n如果表扫描率超过4000，说明进行了太多表扫描，很有可能索引没有建好，增加read_buffer_size值会有一些好处，但最好不要超过8MB。\n### 查看Mysql状态QPS/TPS/缓存命中率\n#### QPS(每秒Query量) \n```\nQPS = Questions(or Queries) / seconds \nmysql > show  global  status like 'Question%'; \n ```\n#### TPS(每秒事务量) \n```\nTPS = (Com_commit + Com_rollback) / seconds \nmysql > show global status like 'Com_commit'; \nmysql > show global status like 'Com_rollback'; \n```\n#### key Buffer 命中率 \n```\nmysql>show  global   status  like   'key%'; \nkey_buffer_read_hits = (1-key_reads / key_read_requests) * 100% \nkey_buffer_write_hits = (1-key_writes / key_write_requests) * 100% \n``` \n#### InnoDB Buffer命中率 \n```\nmysql> show status like 'innodb_buffer_pool_read%'; \ninnodb_buffer_read_hits = (1 - innodb_buffer_pool_reads / innodb_buffer_pool_read_requests) * 100% \n```\n#### Query Cache命中率 \n````\nmysql> show status like 'Qcache%'; \nQuery_cache_hits = (Qcahce_hits / (Qcache_hits + Qcache_inserts )) * 100%; \n``` \n#### Table Cache状态量 \n```\nmysql> show global  status like 'open%'; \n```\n比较 open_tables  与 opend_tables 值 \n \n#### Thread Cache 命中率 \n```\nmysql> show global status like 'Thread%'; \nmysql> show global status like 'Connections'; \nThread_cache_hits = (1 - Threads_created / connections ) * 100% \n``` \n#### 锁定状态 \n```\nmysql> show global  status like '%lock%'; \nTable_locks_waited/Table_locks_immediate=0.3%  如果这个比值比较大的话，说明表锁造成的阻塞比较严重 \nInnodb_row_lock_waits innodb行锁，太大可能是间隙锁造成的 \n```\n#### 复制延时量 \n```\nmysql > show slave status \n查看延时时间 \n``` \n#### Tmp Table 状况(临时表状况) \n```\nmysql > show status like 'Create_tmp%'; \nCreated_tmp_disk_tables/Created_tmp_tables比值最好不要超过10%，如果Created_tmp_tables值比较大， \n可能是排序句子过多或者是连接句子不够优化 \n``` \n#### Binlog Cache 使用状况 \n```\nmysql > show status like 'Binlog_cache%'; \n如果Binlog_cache_disk_use值不为0 ，可能需要调大 binlog_cache_size大小 \n```\n#### Innodb_log_waits 量 \n```\nmysql > show status like 'innodb_log_waits'; \nInnodb_log_waits值不等于0的话，表明 innodb log  buffer 因为空间不足而等待 \n```\n### Mysql查看死锁和解除锁\n所谓死锁<DeadLock>：是指两个或两个以上的进程在执行过程中,因争夺资源而造成的一种互相等待的现象,若无外力作用，它们都将无法推进下去.此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程。表级锁不会产生死锁.所以解决死锁主要还是针对于最常用的InnoDB。\n\n解除正在死锁的状态有两种方法：\n* **第一种**\n1.查询是否锁表\n```\nmysql> show OPEN TABLES where In_use > 0;\n```\n2.查询进程（如果您有SUPER权限，您可以看到所有线程。否则，您只能看到您自己的线程）\n```\nmysql> show processlist;\n```\n3.杀死进程id（就是上面命令的id列）\n```\nmysql> kill id\n```\n* **第二种**\n1.查看下在锁的事务 \n```\nmysql> SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;\n```\n2.杀死进程id（就是上面命令的trx_mysql_thread_id列）\n```\nmysql> kill 线程ID\n```\n\n>例子：\n查出死锁进程：mysql> SHOW PROCESSLIST\n杀掉进程: mysql> KILL 420821;\n\n\n其它关于查看死锁的命令：\n```\n1：查看当前的事务\nmysql> SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;\n2：查看当前锁定的事务\nmysql> SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;\n3：查看当前等锁的事务\nmysql> SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;\n```\n\n后记： \n文中提到一些数字都是参考值，了解基本原理就可以，除了MySQL提供的各种status值外，操作系统的一些性能指标也很重要，比如常用的top,iostat等，尤其是iostat，现在的系统瓶颈一般都在磁盘IO上，关于iostat的使用.\n在尝试学习新的语言之前先理解这门语言的设计原理能够让你在探索这门新语言时保持一个清醒而且开发的状态。","source":"_posts/mysql-status.md","raw":"layout: post\ntitle: Mysql状态信息查询\nauthor: Pyker\ncategories: SQL\nimg: /images/bar/mysql.jpg\ntags:\n  - mysql\ntop: false\ncover: false\ndate: 2018-10-22 21:47:00\n---\nMysql在安装运行后，其性能并不一定为实际需要的性能，因此我们常常会在mysql运行一段时间后进行mysql的性能状态查询来了解mysql服务器的性能指标，从而来优化mysql。\n\n### 查看mysql性能状态命令\n\n#### 查看mysql全局状态\n```\nmysql> show global status;\n可以列出MySQL服务器运行各种状态值，另外，查询MySQL服务器配置信息语句。\n```\n```\nmysql> show variables;\n可以查看Mysql系统变量及其值。\n```\n```\nmysql> show processlist;\n可以查看Mysql当前连接数的进程以及状态。\n```\n#### 慢查询\n```\nmysql> show variables like '%slow%'; \n+------------------+-------+ \n| Variable_name | Value | \n+------------------+-------+ \n| log_slow_queries | ON | \n| slow_launch_time | 2 | \n+------------------+-------+ \n\nmysql> show global status like '%slow%'; \n+---------------------+-------+ \n| Variable_name | Value | \n+---------------------+-------+ \n| Slow_launch_threads | 0 | \n| Slow_queries | 4148 | \n+---------------------+-------+　　\n```\n配置中打开了记录慢查询，执行时间超过2秒的即为慢查询，系统显示有4148个慢查询，你可以分析慢查询日志，找出有问题的SQL语句，慢查询时间不宜设置过长，否则意义不大，最好在5秒以内，如果你需要微秒级别的慢查询，可以考虑给[MySQL打补丁](http://www.percona.com/docs/wiki/release:start) ，记得找对应的版本。\n\n打开慢查询日志可能会对系统性能有一点点影响，如果你的MySQL是主-从结构，可以考虑打开其中一台从服务器的慢查询日志，这样既可以监控慢查询，对系统性能影响又小。\n\n#### 连接数\n经常会遇见`”MySQL: ERROR 1040: Too many connections”`的情况，一种是访问量确实很高，MySQL服务器抗不住，这个时候就要考虑增加从服务器分散读压力，另外一种情况是MySQL配置文件中max_connections值过小：\n```\nmysql> show variables like 'max_connections'; \n+-----------------+-------+ \n| Variable_name | Value | \n+-----------------+-------+ \n| max_connections | 256 | \n+-----------------+-------+　\n```\n这台MySQL服务器最大连接数是256，然后查询一下服务器响应的最大连接数：\n```\nmysql> show global status like ‘Max_used_connections’;\n```\nMySQL服务器过去的最大连接数是245，没有达到服务器连接数上限256，应该没有出现1040错误，比较理想的设置是：`Max_used_connections / max_connections * 100% ≈ 85%` 最大连接数占上限连接数的85%左右，如果发现比例在10%以下，MySQL服务器连接数上限设置的过高了。\n\n#### Key_buffer_size \nkey_buffer_size是对MyISAM表性能影响最大的一个参数，下面一台以MyISAM为主要存储引擎服务器的配置： \n```\nmysql> show variables like ‘key_buffer_size’; \n+-----------------+------------+ \n| Variable_name | Value | \n+-----------------+------------+ \n| key_buffer_size | 536870912 | \n+-----------------+------------+　　\n```\n分配了512MB内存给key_buffer_size，我们再看一下key_buffer_size的使用情况： \n```\nmysql> show global status like 'key_read%'; \n+------------------------+-------------+ \n| Variable_name | Value | mysql \n+------------------------+-------------+ \n| Key_read_requests | 27813678764 | \n| Key_reads | 6798830 | \n+------------------------+-------------+　　\n```\n一共有27813678764个索引读取请求，有6798830个请求在内存中没有找到直接从硬盘读取索引，计算索引未命中缓存的概率：`key_cache_miss_rate = Key_reads / Key_read_requests * 100%`\n比如上面的数据，key_cache_miss_rate为0.0244%，4000个索引读取请求才有一个直接读硬盘，已经很BT了,key_cache_miss_rate在0.1%以下都很好(每1000个请求有一个直接读硬盘)，如果key_cache_miss_rate在0.01%以下的话，key_buffer_size分配的过多，可以适当减少。\nMySQL服务器还提供了key_blocks_*参数： \n```\nmysql> show global status like 'key_blocks_u%'; \n+------------------------+-------------+ \n| Variable_name | Value | \n+------------------------+-------------+ \n| Key_blocks_unused | 0 | \n| Key_blocks_used | 413543 | \n+------------------------+-------------+　　\n```\nKey_blocks_unused表示未使用的缓存簇(blocks)数，Key_blocks_used表示曾经用到的最大的blocks数，比如这台服务器，所有的缓存都用到了，要么增加key_buffer_size，要么就是过渡索引了，把缓存占满了。比较理想的设置： \nKey_blocks_used / (Key_blocks_unused + Key_blocks_used) * 100% ≈ 80%\n\n#### 临时表\n``` \nmysql> show global status like 'created_tmp%'; \n+-------------------------+---------+ \n| Variable_name | Value | \n+-------------------------+---------+ \n| Created_tmp_disk_tables | 21197 | \n| Created_tmp_files | 58 | \n| Created_tmp_tables | 1771587 | \n+-------------------------+---------+　　\n```\n每次创建临时表，Created_tmp_tables增加，如果是在磁盘上创建临时表，Created_tmp_disk_tables也增加,Created_tmp_files表示MySQL服务创建的临时文件文件数，比较理想的配置是：\n`Created_tmp_disk_tables / Created_tmp_tables * 100% <= 25% `\n比如上面的服务器`Created_tmp_disk_tables / Created_tmp_tables * 100% = 1.20%`, 应该相当好了。我们再看一下MySQL服务器对临时表的配置： \n```\nmysql> show variables where Variable_name in ('tmp_table_size', 'max_heap_table_size'); \n+---------------------+-----------+ \n| Variable_name | Value | \n+---------------------+-----------+ \n| max_heap_table_size | 268435456 | \n| tmp_table_size | 536870912 | \n+---------------------+-----------+　　\n```\n只有256MB以下的临时表才能全部放内存，超过的就会用到硬盘临时表。\n\n#### Open Table\n```\nmysql> show global status like 'open%tables%'; \n+---------------+-------+ \n| Variable_name | Value | \n+---------------+-------+ \n| Open_tables | 919 | \n| Opened_tables | 1951 | \n+---------------+-------+　　\n```\nOpen_tables表示打开表的数量，Opened_tables表示打开过的表数量，如果Opened_tables数量过大，说明配置中table_cache(5.1.3之后这个值叫做table_open_cache)值可能太小，我们查询一下服务器table_cache值： \n```\nmysql> show variables like 'table_cache'; \n+---------------+-------+ \n| Variable_name | Value | \n+---------------+-------+ \n| table_cache | 2048 | \n+---------------+-------+\n```\n比较合适的值为： \n`Open_tables / Opened_tables * 100% >= 85%`, 及`Open_tables / table_cache * 100% <= 95%``\n\n六、进程使用情况\n```\nmysql> show global status like ‘Thread%’; \n+-------------------+-------+ \n| Variable_name | Value | \n+-------------------+-------+ \n| Threads_cached | 46 | \n| Threads_connected | 2 | \n| Threads_created | 570 | \n| Threads_running | 1 | \n+-------------------+-------+　　\n```\n如果我们在MySQL服务器配置文件中设置了`thread_cache_size`， 当客户端断开之后，服务器处理此客户的线程将会缓存起来以响应下一个客户而不是销毁(前提是缓存数未达上限)。Threads_created表示创建过的线程数，如果发现Threads_created值过大的话，表明MySQL服务器一直在创建线程，这也是比较耗资源，可以适当增加配置文件中thread_cache_size值，查询服务器thread_cache_size配置： \n```\nmysql> show variables like 'thread_cache_size'; \n+-------------------+-------+ \n| Variable_name | Value | \n+-------------------+-------+ \n| thread_cache_size | 64 | \n+-------------------+-------+　　\n```\n示例中的服务器还是挺健康的。\n\n#### 查询缓存(query cache) \n```\nmysql> show global status like 'qcache%'; \n+-------------------------+-----------+ \n| Variable_name | Value | \n+-------------------------+-----------+ \n| Qcache_free_blocks | 22756 | \n| Qcache_free_memory | 76764704 | \n| Qcache_hits | 213028692 | \n| Qcache_inserts | 208894227 | \n| Qcache_lowmem_prunes | 4010916 | \n| Qcache_not_cached | 13385031 | \n| Qcache_queries_in_cache | 43560 | \n| Qcache_total_blocks | 111212 | \n+-------------------------+-----------+　　\n```\nMySQL查询缓存变量解释：\n`Qcache_free_blocks`： 缓存中相邻内存块的个数。数目大说明可能有碎片。FLUSH QUERY CACHE会对缓存中的碎片进行整理，从而得到一个空闲块。\n`Qcache_free_memory`： 缓存中的空闲内存。 \n`Qcache_hits`： 每次查询在缓存中命中时就增大\n`Qcache_inserts`： 每次插入一个查询时就增大。命中次数除以插入次数就是不中比率。\n`Qcache_lowmem_prunes`： 缓存出现内存不足并且必须要进行清理以便为更多查询提供空间的次数。这个数字最好长时间来看;如果这个数字在不断增长，就表示可能碎片非常严重，或者内存很少。(上面的 free_blocks和free_memory可以告诉您属于哪种情况) \n`Qcache_not_cached`： 不适合进行缓存的查询的数量，通常是由于这些查询不是 SELECT 语句或者用了now()之类的函数。\n`Qcache_queries_in_cache`： 当前缓存的查询(和响应)的数量。\n`Qcache_total_blocks`： 缓存中块的数量。\n\n我们再查询一下服务器关于query_cache的配置： \n```\nmysql> show variables like 'query_cache%'; \n+------------------------------+-----------+ \n| Variable_name | Value | \n+------------------------------+-----------+ \n| query_cache_limit | 2097152 | \n| query_cache_min_res_unit | 4096 | \n| query_cache_size | 203423744 | \n| query_cache_type | ON | \n| query_cache_wlock_invalidate | OFF |\n+——————————+———–+\n```\n各字段的解释：\n`query_cache_limit`： 超过此大小的查询将不缓存\n`query_cache_min_res_unit`： 缓存块的最小大小\n`query_cache_size`： 查询缓存大小\n`query_cache_type`： 缓存类型，决定缓存什么样的查询，示例中表示不缓存 select sql_no_cache 查询 \n`query_cache_wlock_invalidate`： 当有其他客户端正在对MyISAM表进行写操作时，如果查询在query cache中，是否返回cache结果还是等写操作完成再读表获取结果。\n`query_cache_min_res_unit` 的配置是一柄”双刃剑”，默认是4KB，设置值大对大数据查询有好处，但如果你的查询都是小数据查询，就容易造成内存碎片和浪费。\n\n查询缓存碎片率 = `Qcache_free_blocks / Qcache_total_blocks * 100%`\n如果查询缓存碎片率超过20%，可以用FLUSH QUERY CACHE整理缓存碎片，或者试试减小query_cache_min_res_unit，如果你的查询都是小数据量的话。\n查询缓存利用率 = `(query_cache_size - Qcache_free_memory) / query_cache_size * 100%`\n查询缓存利用率在25%以下的话说明`query_cache_size`设置的过大，可适当减小;查询缓存利用率在80%以上而且Qcache_lowmem_prunes > 50的话说明query_cache_size可能有点小，要不就是碎片太多。 \n查询缓存命中率 = `(Qcache_hits - Qcache_inserts) / Qcache_hits * 100%`\n示例服务器 查询缓存碎片率 = 20.46%，查询缓存利用率 = 62.26%，查询缓存命中率 = 1.94%，命中率很差，可能写操作比较频繁吧，而且可能有些碎片。\n\n#### 排序使用情况 \n```\nmysql> show global status like 'sort%'; \n+-------------------+------------+ \n| Variable_name | Value | \n+-------------------+------------+ \n| Sort_merge_passes | 29 | \n| Sort_range | 37432840 | \n| Sort_rows | 9178691532 | \n| Sort_scan | 1860569 | \n+-------------------+------------+　　\n```\n`Sort_merge_passes` 包括两步。MySQL 首先会尝试在内存中做排序，使用的内存大小由系统变量 Sort_buffer_size 决定，如果它的大小不够把所有的记录都读到内存中，MySQL 就会把每次在内存中排序的结果存到临时文件中，等 MySQL 找到所有记录之后，再把临时文件中的记录做一次排序。这再次排序就会增加 Sort_merge_passes。实际上，MySQL 会用另一个临时文件来存再次排序的结果，所以通常会看到 Sort_merge_passes 增加的数值是建临时文件数的两倍。因为用到了临时文件，所以速度可能会比较慢，增加 Sort_buffer_size 会减少 Sort_merge_passes 和 创建临时文件的次数。但盲目的增加 Sort_buffer_size 并不一定能提高速度。\n另外，增加read_rnd_buffer_size(3.2.3是record_rnd_buffer_size)的值对排序的操作也有一点的好处，参见：<http://www.mysqlperformanceblog.com/2007/07/24/what-exactly-is-read_rnd_buffer_size/>\n\n#### 文件打开数(open_files) \n```\nmysql> show global status like 'open_files'; \n+---------------+-------+ \n| Variable_name | Value | \n+---------------+-------+ \n| Open_files | 1410 | \n+---------------+-------+ \nmysql> show variables like 'open_files_limit'; \n+------------------+-------+ \n| Variable_name | Value | \n+------------------+-------+ \n| open_files_limit | 4590 | \n+------------------+-------+　　\n```\n比较合适的设置：`Open_files / open_files_limit * 100% <= 75%`\n\n#### 表锁情况 \n```\nmysql> show global status like 'table_locks%'; \n+-----------------------+-----------+ \n| Variable_name | Value | \n+-----------------------+-----------+ \n| Table_locks_immediate | 490206328 | \n| Table_locks_waited | 2084912 | \n+-----------------------+-----------+　　\n```\n`Table_locks_immediate` 表示立即释放表锁数，`Table_locks_waited` 表示需要等待的表锁数，如果Table_locks_immediate / Table_locks_waited > 5000，最好采用InnoDB引擎，因为InnoDB是行锁而MyISAM是表锁，对于高并发写入的应用InnoDB效果会好些。示例中的服务器Table_locks_immediate / Table_locks_waited = 235，MyISAM就足够了。\n\n#### 表扫描情况 \n```\nmysql> show global status like 'handler_read%'; \n+-----------------------+-------------+ \n| Variable_name | Value | \n+-----------------------+-------------+ \n| Handler_read_first | 5803750 | \n| Handler_read_key | 6049319850 | \n| Handler_read_next | 94440908210 | \n| Handler_read_prev | 34822001724 | \n| Handler_read_rnd | 405482605 | \n| Handler_read_rnd_next | 18912877839 | \n+-----------------------+-------------+　　\n\nmysql> show global status like 'com_select'; \n+---------------+-----------+ \n| Variable_name | Value | \n+---------------+-----------+ \n| Com_select | 222693559 | \n+---------------+-----------+　　\n```\n计算表扫描率：\n表扫描率 = Handler_read_rnd_next / Com_select\n如果表扫描率超过4000，说明进行了太多表扫描，很有可能索引没有建好，增加read_buffer_size值会有一些好处，但最好不要超过8MB。\n### 查看Mysql状态QPS/TPS/缓存命中率\n#### QPS(每秒Query量) \n```\nQPS = Questions(or Queries) / seconds \nmysql > show  global  status like 'Question%'; \n ```\n#### TPS(每秒事务量) \n```\nTPS = (Com_commit + Com_rollback) / seconds \nmysql > show global status like 'Com_commit'; \nmysql > show global status like 'Com_rollback'; \n```\n#### key Buffer 命中率 \n```\nmysql>show  global   status  like   'key%'; \nkey_buffer_read_hits = (1-key_reads / key_read_requests) * 100% \nkey_buffer_write_hits = (1-key_writes / key_write_requests) * 100% \n``` \n#### InnoDB Buffer命中率 \n```\nmysql> show status like 'innodb_buffer_pool_read%'; \ninnodb_buffer_read_hits = (1 - innodb_buffer_pool_reads / innodb_buffer_pool_read_requests) * 100% \n```\n#### Query Cache命中率 \n````\nmysql> show status like 'Qcache%'; \nQuery_cache_hits = (Qcahce_hits / (Qcache_hits + Qcache_inserts )) * 100%; \n``` \n#### Table Cache状态量 \n```\nmysql> show global  status like 'open%'; \n```\n比较 open_tables  与 opend_tables 值 \n \n#### Thread Cache 命中率 \n```\nmysql> show global status like 'Thread%'; \nmysql> show global status like 'Connections'; \nThread_cache_hits = (1 - Threads_created / connections ) * 100% \n``` \n#### 锁定状态 \n```\nmysql> show global  status like '%lock%'; \nTable_locks_waited/Table_locks_immediate=0.3%  如果这个比值比较大的话，说明表锁造成的阻塞比较严重 \nInnodb_row_lock_waits innodb行锁，太大可能是间隙锁造成的 \n```\n#### 复制延时量 \n```\nmysql > show slave status \n查看延时时间 \n``` \n#### Tmp Table 状况(临时表状况) \n```\nmysql > show status like 'Create_tmp%'; \nCreated_tmp_disk_tables/Created_tmp_tables比值最好不要超过10%，如果Created_tmp_tables值比较大， \n可能是排序句子过多或者是连接句子不够优化 \n``` \n#### Binlog Cache 使用状况 \n```\nmysql > show status like 'Binlog_cache%'; \n如果Binlog_cache_disk_use值不为0 ，可能需要调大 binlog_cache_size大小 \n```\n#### Innodb_log_waits 量 \n```\nmysql > show status like 'innodb_log_waits'; \nInnodb_log_waits值不等于0的话，表明 innodb log  buffer 因为空间不足而等待 \n```\n### Mysql查看死锁和解除锁\n所谓死锁<DeadLock>：是指两个或两个以上的进程在执行过程中,因争夺资源而造成的一种互相等待的现象,若无外力作用，它们都将无法推进下去.此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程。表级锁不会产生死锁.所以解决死锁主要还是针对于最常用的InnoDB。\n\n解除正在死锁的状态有两种方法：\n* **第一种**\n1.查询是否锁表\n```\nmysql> show OPEN TABLES where In_use > 0;\n```\n2.查询进程（如果您有SUPER权限，您可以看到所有线程。否则，您只能看到您自己的线程）\n```\nmysql> show processlist;\n```\n3.杀死进程id（就是上面命令的id列）\n```\nmysql> kill id\n```\n* **第二种**\n1.查看下在锁的事务 \n```\nmysql> SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;\n```\n2.杀死进程id（就是上面命令的trx_mysql_thread_id列）\n```\nmysql> kill 线程ID\n```\n\n>例子：\n查出死锁进程：mysql> SHOW PROCESSLIST\n杀掉进程: mysql> KILL 420821;\n\n\n其它关于查看死锁的命令：\n```\n1：查看当前的事务\nmysql> SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;\n2：查看当前锁定的事务\nmysql> SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;\n3：查看当前等锁的事务\nmysql> SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;\n```\n\n后记： \n文中提到一些数字都是参考值，了解基本原理就可以，除了MySQL提供的各种status值外，操作系统的一些性能指标也很重要，比如常用的top,iostat等，尤其是iostat，现在的系统瓶颈一般都在磁盘IO上，关于iostat的使用.\n在尝试学习新的语言之前先理解这门语言的设计原理能够让你在探索这门新语言时保持一个清醒而且开发的状态。","slug":"mysql-status","published":1,"updated":"2019-05-28T02:02:23.506Z","_id":"cjw6jlf200038p4n7lavirhxc","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>Mysql在安装运行后，其性能并不一定为实际需要的性能，因此我们常常会在mysql运行一段时间后进行mysql的性能状态查询来了解mysql服务器的性能指标，从而来优化mysql。</p>\n<h3 id=\"查看mysql性能状态命令\"><a href=\"#查看mysql性能状态命令\" class=\"headerlink\" title=\"查看mysql性能状态命令\"></a>查看mysql性能状态命令</h3><h4 id=\"查看mysql全局状态\"><a href=\"#查看mysql全局状态\" class=\"headerlink\" title=\"查看mysql全局状态\"></a>查看mysql全局状态</h4><figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"built_in\">show</span> global <span class=\"built_in\">status</span>;</span><br><span class=\"line\">可以列出MySQL服务器运行各种状态值，另外，查询MySQL服务器配置信息语句。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show <span class=\"keyword\">variables</span>;</span><br><span class=\"line\">可以查看Mysql系统变量及其值。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"keyword\">show </span>processlist<span class=\"comment\">;</span></span><br><span class=\"line\">可以查看Mysql当前连接数的进程以及状态。</span><br></pre></td></tr></table></figure>\n<h4 id=\"慢查询\"><a href=\"#慢查询\" class=\"headerlink\" title=\"慢查询\"></a>慢查询</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like '%slow%'; </span><br><span class=\"line\">+------------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> log_slow_queries </span>|<span class=\"string\"> ON </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> slow_launch_time </span>|<span class=\"string\"> 2 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------+-------+ </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">mysql&gt; show global status like '%slow%'; </span></span><br><span class=\"line\"><span class=\"string\">+---------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Slow_launch_threads </span>|<span class=\"string\"> 0 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Slow_queries </span>|<span class=\"string\"> 4148 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------------+-------+</span></span><br></pre></td></tr></table></figure>\n<p>配置中打开了记录慢查询，执行时间超过2秒的即为慢查询，系统显示有4148个慢查询，你可以分析慢查询日志，找出有问题的SQL语句，慢查询时间不宜设置过长，否则意义不大，最好在5秒以内，如果你需要微秒级别的慢查询，可以考虑给<a href=\"http://www.percona.com/docs/wiki/release:start\" target=\"_blank\" rel=\"noopener\">MySQL打补丁</a> ，记得找对应的版本。</p>\n<p>打开慢查询日志可能会对系统性能有一点点影响，如果你的MySQL是主-从结构，可以考虑打开其中一台从服务器的慢查询日志，这样既可以监控慢查询，对系统性能影响又小。</p>\n<h4 id=\"连接数\"><a href=\"#连接数\" class=\"headerlink\" title=\"连接数\"></a>连接数</h4><p>经常会遇见<code>”MySQL: ERROR 1040: Too many connections”</code>的情况，一种是访问量确实很高，MySQL服务器抗不住，这个时候就要考虑增加从服务器分散读压力，另外一种情况是MySQL配置文件中max_connections值过小：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like 'max_connections'; </span><br><span class=\"line\">+-----------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> max_connections </span>|<span class=\"string\"> 256 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------+-------+</span></span><br></pre></td></tr></table></figure></p>\n<p>这台MySQL服务器最大连接数是256，然后查询一下服务器响应的最大连接数：<br><figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"built_in\">show</span> global <span class=\"built_in\">status</span> like ‘Max_used_connections’;</span><br></pre></td></tr></table></figure></p>\n<p>MySQL服务器过去的最大连接数是245，没有达到服务器连接数上限256，应该没有出现1040错误，比较理想的设置是：<code>Max_used_connections / max_connections * 100% ≈ 85%</code> 最大连接数占上限连接数的85%左右，如果发现比例在10%以下，MySQL服务器连接数上限设置的过高了。</p>\n<h4 id=\"Key-buffer-size\"><a href=\"#Key-buffer-size\" class=\"headerlink\" title=\"Key_buffer_size\"></a>Key_buffer_size</h4><p>key_buffer_size是对MyISAM表性能影响最大的一个参数，下面一台以MyISAM为主要存储引擎服务器的配置：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like ‘key_buffer_size’; </span><br><span class=\"line\">+-----------------+------------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------+------------+ </span></span><br><span class=\"line\">|<span class=\"string\"> key_buffer_size </span>|<span class=\"string\"> 536870912 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------+------------+</span></span><br></pre></td></tr></table></figure></p>\n<p>分配了512MB内存给key_buffer_size，我们再看一下key_buffer_size的使用情况：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'key_read%'; </span><br><span class=\"line\">+------------------------+-------------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> mysql </span></span><br><span class=\"line\"><span class=\"string\">+------------------------+-------------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Key_read_requests </span>|<span class=\"string\"> 27813678764 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Key_reads </span>|<span class=\"string\"> 6798830 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------------+-------------+</span></span><br></pre></td></tr></table></figure></p>\n<p>一共有27813678764个索引读取请求，有6798830个请求在内存中没有找到直接从硬盘读取索引，计算索引未命中缓存的概率：<code>key_cache_miss_rate = Key_reads / Key_read_requests * 100%</code><br>比如上面的数据，key_cache_miss_rate为0.0244%，4000个索引读取请求才有一个直接读硬盘，已经很BT了,key_cache_miss_rate在0.1%以下都很好(每1000个请求有一个直接读硬盘)，如果key_cache_miss_rate在0.01%以下的话，key_buffer_size分配的过多，可以适当减少。<br>MySQL服务器还提供了key_blocks_*参数：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'key_blocks_u%'; </span><br><span class=\"line\">+------------------------+-------------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------------+-------------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Key_blocks_unused </span>|<span class=\"string\"> 0 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Key_blocks_used </span>|<span class=\"string\"> 413543 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------------+-------------+</span></span><br></pre></td></tr></table></figure></p>\n<p>Key_blocks_unused表示未使用的缓存簇(blocks)数，Key_blocks_used表示曾经用到的最大的blocks数，比如这台服务器，所有的缓存都用到了，要么增加key_buffer_size，要么就是过渡索引了，把缓存占满了。比较理想的设置：<br>Key_blocks_used / (Key_blocks_unused + Key_blocks_used) * 100% ≈ 80%</p>\n<h4 id=\"临时表\"><a href=\"#临时表\" class=\"headerlink\" title=\"临时表\"></a>临时表</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'created_tmp%'; </span><br><span class=\"line\">+-------------------------+---------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------------+---------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Created_tmp_disk_tables </span>|<span class=\"string\"> 21197 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Created_tmp_files </span>|<span class=\"string\"> 58 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Created_tmp_tables </span>|<span class=\"string\"> 1771587 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------------+---------+</span></span><br></pre></td></tr></table></figure>\n<p>每次创建临时表，Created_tmp_tables增加，如果是在磁盘上创建临时表，Created_tmp_disk_tables也增加,Created_tmp_files表示MySQL服务创建的临时文件文件数，比较理想的配置是：<br><code>Created_tmp_disk_tables / Created_tmp_tables * 100% &lt;= 25%</code><br>比如上面的服务器<code>Created_tmp_disk_tables / Created_tmp_tables * 100% = 1.20%</code>, 应该相当好了。我们再看一下MySQL服务器对临时表的配置：<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables where Variable<span class=\"emphasis\">_name in ('tmp_</span>table<span class=\"emphasis\">_size', 'max_</span>heap<span class=\"emphasis\">_table_</span>size'); </span><br><span class=\"line\"><span class=\"code\">+---------------------+</span>-----------+ </span><br><span class=\"line\">| Variable<span class=\"emphasis\">_name | Value | </span></span><br><span class=\"line\"><span class=\"emphasis\">+---------------------+-----------+ </span></span><br><span class=\"line\"><span class=\"emphasis\">| max_</span>heap<span class=\"emphasis\">_table_</span>size | 268435456 | </span><br><span class=\"line\">| tmp<span class=\"emphasis\">_table_</span>size | 536870912 | </span><br><span class=\"line\"><span class=\"code\">+---------------------+</span>-----------+</span><br></pre></td></tr></table></figure></p>\n<p>只有256MB以下的临时表才能全部放内存，超过的就会用到硬盘临时表。</p>\n<h4 id=\"Open-Table\"><a href=\"#Open-Table\" class=\"headerlink\" title=\"Open Table\"></a>Open Table</h4><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like <span class=\"emphasis\">'open%tables%'</span>; </span><br><span class=\"line\"><span class=\"code\">+---------------+</span>-------+ </span><br><span class=\"line\">| Variable<span class=\"emphasis\">_name | Value | </span></span><br><span class=\"line\"><span class=\"emphasis\">+---------------+-------+ </span></span><br><span class=\"line\"><span class=\"emphasis\">| Open_</span>tables | 919 | </span><br><span class=\"line\">| Opened<span class=\"emphasis\">_tables | 1951 | </span></span><br><span class=\"line\"><span class=\"emphasis\">+---------------+-------+</span></span><br></pre></td></tr></table></figure>\n<p>Open_tables表示打开表的数量，Opened_tables表示打开过的表数量，如果Opened_tables数量过大，说明配置中table_cache(5.1.3之后这个值叫做table_open_cache)值可能太小，我们查询一下服务器table_cache值：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like 'table_cache'; </span><br><span class=\"line\">+---------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> table_cache </span>|<span class=\"string\"> 2048 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-------+</span></span><br></pre></td></tr></table></figure></p>\n<p>比较合适的值为：<br><code>Open_tables / Opened_tables * 100% &gt;= 85%</code>, 及<code>Open_tables / table_cache * 100% &lt;= 95%`</code></p>\n<p>六、进程使用情况<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like ‘Thread%’; </span><br><span class=\"line\">+-------------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Threads_cached </span>|<span class=\"string\"> 46 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Threads_connected </span>|<span class=\"string\"> 2 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Threads_created </span>|<span class=\"string\"> 570 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Threads_running </span>|<span class=\"string\"> 1 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+-------+</span></span><br></pre></td></tr></table></figure></p>\n<p>如果我们在MySQL服务器配置文件中设置了<code>thread_cache_size</code>， 当客户端断开之后，服务器处理此客户的线程将会缓存起来以响应下一个客户而不是销毁(前提是缓存数未达上限)。Threads_created表示创建过的线程数，如果发现Threads_created值过大的话，表明MySQL服务器一直在创建线程，这也是比较耗资源，可以适当增加配置文件中thread_cache_size值，查询服务器thread_cache_size配置：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like 'thread_cache_size'; </span><br><span class=\"line\">+-------------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> thread_cache_size </span>|<span class=\"string\"> 64 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+-------+</span></span><br></pre></td></tr></table></figure></p>\n<p>示例中的服务器还是挺健康的。</p>\n<h4 id=\"查询缓存-query-cache\"><a href=\"#查询缓存-query-cache\" class=\"headerlink\" title=\"查询缓存(query cache)\"></a>查询缓存(query cache)</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'qcache%'; </span><br><span class=\"line\">+-------------------------+-----------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------------+-----------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_free_blocks </span>|<span class=\"string\"> 22756 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_free_memory </span>|<span class=\"string\"> 76764704 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_hits </span>|<span class=\"string\"> 213028692 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_inserts </span>|<span class=\"string\"> 208894227 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_lowmem_prunes </span>|<span class=\"string\"> 4010916 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_not_cached </span>|<span class=\"string\"> 13385031 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_queries_in_cache </span>|<span class=\"string\"> 43560 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_total_blocks </span>|<span class=\"string\"> 111212 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------------+-----------+</span></span><br></pre></td></tr></table></figure>\n<p>MySQL查询缓存变量解释：<br><code>Qcache_free_blocks</code>： 缓存中相邻内存块的个数。数目大说明可能有碎片。FLUSH QUERY CACHE会对缓存中的碎片进行整理，从而得到一个空闲块。<br><code>Qcache_free_memory</code>： 缓存中的空闲内存。<br><code>Qcache_hits</code>： 每次查询在缓存中命中时就增大<br><code>Qcache_inserts</code>： 每次插入一个查询时就增大。命中次数除以插入次数就是不中比率。<br><code>Qcache_lowmem_prunes</code>： 缓存出现内存不足并且必须要进行清理以便为更多查询提供空间的次数。这个数字最好长时间来看;如果这个数字在不断增长，就表示可能碎片非常严重，或者内存很少。(上面的 free_blocks和free_memory可以告诉您属于哪种情况)<br><code>Qcache_not_cached</code>： 不适合进行缓存的查询的数量，通常是由于这些查询不是 SELECT 语句或者用了now()之类的函数。<br><code>Qcache_queries_in_cache</code>： 当前缓存的查询(和响应)的数量。<br><code>Qcache_total_blocks</code>： 缓存中块的数量。</p>\n<p>我们再查询一下服务器关于query_cache的配置：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like 'query_cache%'; </span><br><span class=\"line\">+------------------------------+-----------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------------------+-----------+ </span></span><br><span class=\"line\">|<span class=\"string\"> query_cache_limit </span>|<span class=\"string\"> 2097152 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> query_cache_min_res_unit </span>|<span class=\"string\"> 4096 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> query_cache_size </span>|<span class=\"string\"> 203423744 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> query_cache_type </span>|<span class=\"string\"> ON </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> query_cache_wlock_invalidate </span>|<span class=\"string\"> OFF </span>|</span><br><span class=\"line\">+——————————+———–+</span><br></pre></td></tr></table></figure></p>\n<p>各字段的解释：<br><code>query_cache_limit</code>： 超过此大小的查询将不缓存<br><code>query_cache_min_res_unit</code>： 缓存块的最小大小<br><code>query_cache_size</code>： 查询缓存大小<br><code>query_cache_type</code>： 缓存类型，决定缓存什么样的查询，示例中表示不缓存 select sql_no_cache 查询<br><code>query_cache_wlock_invalidate</code>： 当有其他客户端正在对MyISAM表进行写操作时，如果查询在query cache中，是否返回cache结果还是等写操作完成再读表获取结果。<br><code>query_cache_min_res_unit</code> 的配置是一柄”双刃剑”，默认是4KB，设置值大对大数据查询有好处，但如果你的查询都是小数据查询，就容易造成内存碎片和浪费。</p>\n<p>查询缓存碎片率 = <code>Qcache_free_blocks / Qcache_total_blocks * 100%</code><br>如果查询缓存碎片率超过20%，可以用FLUSH QUERY CACHE整理缓存碎片，或者试试减小query_cache_min_res_unit，如果你的查询都是小数据量的话。<br>查询缓存利用率 = <code>(query_cache_size - Qcache_free_memory) / query_cache_size * 100%</code><br>查询缓存利用率在25%以下的话说明<code>query_cache_size</code>设置的过大，可适当减小;查询缓存利用率在80%以上而且Qcache_lowmem_prunes &gt; 50的话说明query_cache_size可能有点小，要不就是碎片太多。<br>查询缓存命中率 = <code>(Qcache_hits - Qcache_inserts) / Qcache_hits * 100%</code><br>示例服务器 查询缓存碎片率 = 20.46%，查询缓存利用率 = 62.26%，查询缓存命中率 = 1.94%，命中率很差，可能写操作比较频繁吧，而且可能有些碎片。</p>\n<h4 id=\"排序使用情况\"><a href=\"#排序使用情况\" class=\"headerlink\" title=\"排序使用情况\"></a>排序使用情况</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'sort%'; </span><br><span class=\"line\">+-------------------+------------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+------------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Sort_merge_passes </span>|<span class=\"string\"> 29 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Sort_range </span>|<span class=\"string\"> 37432840 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Sort_rows </span>|<span class=\"string\"> 9178691532 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Sort_scan </span>|<span class=\"string\"> 1860569 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+------------+</span></span><br></pre></td></tr></table></figure>\n<p><code>Sort_merge_passes</code> 包括两步。MySQL 首先会尝试在内存中做排序，使用的内存大小由系统变量 Sort_buffer_size 决定，如果它的大小不够把所有的记录都读到内存中，MySQL 就会把每次在内存中排序的结果存到临时文件中，等 MySQL 找到所有记录之后，再把临时文件中的记录做一次排序。这再次排序就会增加 Sort_merge_passes。实际上，MySQL 会用另一个临时文件来存再次排序的结果，所以通常会看到 Sort_merge_passes 增加的数值是建临时文件数的两倍。因为用到了临时文件，所以速度可能会比较慢，增加 Sort_buffer_size 会减少 Sort_merge_passes 和 创建临时文件的次数。但盲目的增加 Sort_buffer_size 并不一定能提高速度。<br>另外，增加read_rnd_buffer_size(3.2.3是record_rnd_buffer_size)的值对排序的操作也有一点的好处，参见：<a href=\"http://www.mysqlperformanceblog.com/2007/07/24/what-exactly-is-read_rnd_buffer_size/\" target=\"_blank\" rel=\"noopener\">http://www.mysqlperformanceblog.com/2007/07/24/what-exactly-is-read_rnd_buffer_size/</a></p>\n<h4 id=\"文件打开数-open-files\"><a href=\"#文件打开数-open-files\" class=\"headerlink\" title=\"文件打开数(open_files)\"></a>文件打开数(open_files)</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'open_files'; </span><br><span class=\"line\">+---------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Open_files </span>|<span class=\"string\"> 1410 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-------+ </span></span><br><span class=\"line\"><span class=\"string\">mysql&gt; show variables like 'open_files_limit'; </span></span><br><span class=\"line\"><span class=\"string\">+------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> open_files_limit </span>|<span class=\"string\"> 4590 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------+-------+</span></span><br></pre></td></tr></table></figure>\n<p>比较合适的设置：<code>Open_files / open_files_limit * 100% &lt;= 75%</code></p>\n<h4 id=\"表锁情况\"><a href=\"#表锁情况\" class=\"headerlink\" title=\"表锁情况\"></a>表锁情况</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'table_locks%'; </span><br><span class=\"line\">+-----------------------+-----------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------------+-----------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Table_locks_immediate </span>|<span class=\"string\"> 490206328 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Table_locks_waited </span>|<span class=\"string\"> 2084912 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------------+-----------+</span></span><br></pre></td></tr></table></figure>\n<p><code>Table_locks_immediate</code> 表示立即释放表锁数，<code>Table_locks_waited</code> 表示需要等待的表锁数，如果Table_locks_immediate / Table_locks_waited &gt; 5000，最好采用InnoDB引擎，因为InnoDB是行锁而MyISAM是表锁，对于高并发写入的应用InnoDB效果会好些。示例中的服务器Table_locks_immediate / Table_locks_waited = 235，MyISAM就足够了。</p>\n<h4 id=\"表扫描情况\"><a href=\"#表扫描情况\" class=\"headerlink\" title=\"表扫描情况\"></a>表扫描情况</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'handler_read%'; </span><br><span class=\"line\">+-----------------------+-------------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------------+-------------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_first </span>|<span class=\"string\"> 5803750 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_key </span>|<span class=\"string\"> 6049319850 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_next </span>|<span class=\"string\"> 94440908210 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_prev </span>|<span class=\"string\"> 34822001724 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_rnd </span>|<span class=\"string\"> 405482605 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_rnd_next </span>|<span class=\"string\"> 18912877839 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------------+-------------+　　</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">mysql&gt; show global status like 'com_select'; </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-----------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-----------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Com_select </span>|<span class=\"string\"> 222693559 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-----------+</span></span><br></pre></td></tr></table></figure>\n<p>计算表扫描率：<br>表扫描率 = Handler_read_rnd_next / Com_select<br>如果表扫描率超过4000，说明进行了太多表扫描，很有可能索引没有建好，增加read_buffer_size值会有一些好处，但最好不要超过8MB。</p>\n<h3 id=\"查看Mysql状态QPS-TPS-缓存命中率\"><a href=\"#查看Mysql状态QPS-TPS-缓存命中率\" class=\"headerlink\" title=\"查看Mysql状态QPS/TPS/缓存命中率\"></a>查看Mysql状态QPS/TPS/缓存命中率</h3><h4 id=\"QPS-每秒Query量\"><a href=\"#QPS-每秒Query量\" class=\"headerlink\" title=\"QPS(每秒Query量)\"></a>QPS(每秒Query量)</h4><figure class=\"highlight vbnet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">QPS = Questions(<span class=\"keyword\">or</span> Queries) / seconds </span><br><span class=\"line\">mysql &gt; show  <span class=\"keyword\">global</span>  status <span class=\"keyword\">like</span> <span class=\"comment\">'Question%';</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"TPS-每秒事务量\"><a href=\"#TPS-每秒事务量\" class=\"headerlink\" title=\"TPS(每秒事务量)\"></a>TPS(每秒事务量)</h4><figure class=\"highlight vbnet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TPS = (Com_commit + Com_rollback) / seconds </span><br><span class=\"line\">mysql &gt; show <span class=\"keyword\">global</span> status <span class=\"keyword\">like</span> <span class=\"comment\">'Com_commit'; </span></span><br><span class=\"line\">mysql &gt; show <span class=\"keyword\">global</span> status <span class=\"keyword\">like</span> <span class=\"comment\">'Com_rollback';</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"key-Buffer-命中率\"><a href=\"#key-Buffer-命中率\" class=\"headerlink\" title=\"key Buffer 命中率\"></a>key Buffer 命中率</h4><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt;show  global   status  like   <span class=\"string\">'key%'</span>; </span><br><span class=\"line\">key_buffer_read_hits = (<span class=\"number\">1</span>-key_reads / key_read_requests) * <span class=\"number\">100</span>% </span><br><span class=\"line\">key_buffer_write_hits = (<span class=\"number\">1</span>-key_writes / key_write_requests) * <span class=\"number\">100</span>% </span><br><span class=\"line\">``` </span><br><span class=\"line\">#### InnoDB Buffer命中率</span><br></pre></td></tr></table></figure>\n<p>mysql&gt; show status like ‘innodb_buffer_pool_read%’;<br>innodb_buffer_read_hits = (1 - innodb_buffer_pool_reads / innodb_buffer_pool_read_requests) * 100%<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### Query Cache命中率 </span><br><span class=\"line\">`</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show status like ‘Qcache%’;<br>Query_cache_hits = (Qcahce_hits / (Qcache_hits + Qcache_inserts )) * 100%;<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### Table Cache状态量</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show global  status like ‘open%’;<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">比较 open_tables  与 opend_tables 值 </span><br><span class=\"line\"> </span><br><span class=\"line\">#### Thread Cache 命中率</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show global status like ‘Thread%’;<br>mysql&gt; show global status like ‘Connections’;<br>Thread_cache_hits = (1 - Threads_created / connections ) * 100%<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### 锁定状态</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show global  status like ‘%lock%’;<br>Table_locks_waited/Table_locks_immediate=0.3%  如果这个比值比较大的话，说明表锁造成的阻塞比较严重<br>Innodb_row_lock_waits innodb行锁，太大可能是间隙锁造成的<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### 复制延时量</span><br></pre></td></tr></table></figure></p>\n<p>mysql &gt; show slave status<br>查看延时时间<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### Tmp Table 状况(临时表状况)</span><br></pre></td></tr></table></figure></p>\n<p>mysql &gt; show status like ‘Create_tmp%’;<br>Created_tmp_disk_tables/Created_tmp_tables比值最好不要超过10%，如果Created_tmp_tables值比较大，<br>可能是排序句子过多或者是连接句子不够优化<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### Binlog Cache 使用状况</span><br></pre></td></tr></table></figure></p>\n<p>mysql &gt; show status like ‘Binlog_cache%’;<br>如果Binlog_cache_disk_use值不为0 ，可能需要调大 binlog_cache_size大小<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### Innodb_log_waits 量</span><br></pre></td></tr></table></figure></p>\n<p>mysql &gt; show status like ‘innodb_log_waits’;<br>Innodb_log_waits值不等于0的话，表明 innodb log  buffer 因为空间不足而等待<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">### Mysql查看死锁和解除锁</span><br><span class=\"line\">所谓死锁&lt;DeadLock&gt;：是指两个或两个以上的进程在执行过程中,因争夺资源而造成的一种互相等待的现象,若无外力作用，它们都将无法推进下去.此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程。表级锁不会产生死锁.所以解决死锁主要还是针对于最常用的InnoDB。</span><br><span class=\"line\"></span><br><span class=\"line\">解除正在死锁的状态有两种方法：</span><br><span class=\"line\">* **第一种**</span><br><span class=\"line\"><span class=\"number\">1.</span>查询是否锁表</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show OPEN TABLES where In_use &gt; 0;<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2</span>.查询进程（如果您有<span class=\"keyword\">SUPER</span>权限，您可以看到所有线程。否则，您只能看到您自己的线程）</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show processlist;<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">3.</span>杀死进程<span class=\"built_in\">id</span>（就是上面命令的<span class=\"built_in\">id</span>列）</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; kill id<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">* </span>*<span class=\"strong\">*第二种*</span><span class=\"strong\">*</span></span><br><span class=\"line\"><span class=\"strong\">1.查看下在锁的事务</span></span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2.</span>杀死进程<span class=\"built_in\">id</span>（就是上面命令的trx_mysql_thread_id列）</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; kill 线程ID<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&gt;例子：</span><br><span class=\"line\">查出死锁进程：mysql&gt; <span class=\"keyword\">SHOW </span>PROCESSLIST</span><br><span class=\"line\">杀掉进程: mysql&gt; KILL <span class=\"number\">420821</span><span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">其它关于查看死锁的命令：</span><br></pre></td></tr></table></figure></p>\n<p>1：查看当前的事务<br>mysql&gt; SELECT <em> FROM INFORMATION_SCHEMA.INNODB_TRX;<br>2：查看当前锁定的事务<br>mysql&gt; SELECT </em> FROM INFORMATION_SCHEMA.INNODB_LOCKS;<br>3：查看当前等锁的事务<br>mysql&gt; SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;<br><code>`</code></p>\n<p>后记：<br>文中提到一些数字都是参考值，了解基本原理就可以，除了MySQL提供的各种status值外，操作系统的一些性能指标也很重要，比如常用的top,iostat等，尤其是iostat，现在的系统瓶颈一般都在磁盘IO上，关于iostat的使用.<br>在尝试学习新的语言之前先理解这门语言的设计原理能够让你在探索这门新语言时保持一个清醒而且开发的状态。</p>\n","site":{"data":{}},"length":12329,"excerpt":"","more":"<p>Mysql在安装运行后，其性能并不一定为实际需要的性能，因此我们常常会在mysql运行一段时间后进行mysql的性能状态查询来了解mysql服务器的性能指标，从而来优化mysql。</p>\n<h3 id=\"查看mysql性能状态命令\"><a href=\"#查看mysql性能状态命令\" class=\"headerlink\" title=\"查看mysql性能状态命令\"></a>查看mysql性能状态命令</h3><h4 id=\"查看mysql全局状态\"><a href=\"#查看mysql全局状态\" class=\"headerlink\" title=\"查看mysql全局状态\"></a>查看mysql全局状态</h4><figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"built_in\">show</span> global <span class=\"built_in\">status</span>;</span><br><span class=\"line\">可以列出MySQL服务器运行各种状态值，另外，查询MySQL服务器配置信息语句。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show <span class=\"keyword\">variables</span>;</span><br><span class=\"line\">可以查看Mysql系统变量及其值。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"keyword\">show </span>processlist<span class=\"comment\">;</span></span><br><span class=\"line\">可以查看Mysql当前连接数的进程以及状态。</span><br></pre></td></tr></table></figure>\n<h4 id=\"慢查询\"><a href=\"#慢查询\" class=\"headerlink\" title=\"慢查询\"></a>慢查询</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like '%slow%'; </span><br><span class=\"line\">+------------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> log_slow_queries </span>|<span class=\"string\"> ON </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> slow_launch_time </span>|<span class=\"string\"> 2 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------+-------+ </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">mysql&gt; show global status like '%slow%'; </span></span><br><span class=\"line\"><span class=\"string\">+---------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Slow_launch_threads </span>|<span class=\"string\"> 0 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Slow_queries </span>|<span class=\"string\"> 4148 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------------+-------+</span></span><br></pre></td></tr></table></figure>\n<p>配置中打开了记录慢查询，执行时间超过2秒的即为慢查询，系统显示有4148个慢查询，你可以分析慢查询日志，找出有问题的SQL语句，慢查询时间不宜设置过长，否则意义不大，最好在5秒以内，如果你需要微秒级别的慢查询，可以考虑给<a href=\"http://www.percona.com/docs/wiki/release:start\" target=\"_blank\" rel=\"noopener\">MySQL打补丁</a> ，记得找对应的版本。</p>\n<p>打开慢查询日志可能会对系统性能有一点点影响，如果你的MySQL是主-从结构，可以考虑打开其中一台从服务器的慢查询日志，这样既可以监控慢查询，对系统性能影响又小。</p>\n<h4 id=\"连接数\"><a href=\"#连接数\" class=\"headerlink\" title=\"连接数\"></a>连接数</h4><p>经常会遇见<code>”MySQL: ERROR 1040: Too many connections”</code>的情况，一种是访问量确实很高，MySQL服务器抗不住，这个时候就要考虑增加从服务器分散读压力，另外一种情况是MySQL配置文件中max_connections值过小：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like 'max_connections'; </span><br><span class=\"line\">+-----------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> max_connections </span>|<span class=\"string\"> 256 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------+-------+</span></span><br></pre></td></tr></table></figure></p>\n<p>这台MySQL服务器最大连接数是256，然后查询一下服务器响应的最大连接数：<br><figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"built_in\">show</span> global <span class=\"built_in\">status</span> like ‘Max_used_connections’;</span><br></pre></td></tr></table></figure></p>\n<p>MySQL服务器过去的最大连接数是245，没有达到服务器连接数上限256，应该没有出现1040错误，比较理想的设置是：<code>Max_used_connections / max_connections * 100% ≈ 85%</code> 最大连接数占上限连接数的85%左右，如果发现比例在10%以下，MySQL服务器连接数上限设置的过高了。</p>\n<h4 id=\"Key-buffer-size\"><a href=\"#Key-buffer-size\" class=\"headerlink\" title=\"Key_buffer_size\"></a>Key_buffer_size</h4><p>key_buffer_size是对MyISAM表性能影响最大的一个参数，下面一台以MyISAM为主要存储引擎服务器的配置：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like ‘key_buffer_size’; </span><br><span class=\"line\">+-----------------+------------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------+------------+ </span></span><br><span class=\"line\">|<span class=\"string\"> key_buffer_size </span>|<span class=\"string\"> 536870912 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------+------------+</span></span><br></pre></td></tr></table></figure></p>\n<p>分配了512MB内存给key_buffer_size，我们再看一下key_buffer_size的使用情况：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'key_read%'; </span><br><span class=\"line\">+------------------------+-------------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> mysql </span></span><br><span class=\"line\"><span class=\"string\">+------------------------+-------------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Key_read_requests </span>|<span class=\"string\"> 27813678764 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Key_reads </span>|<span class=\"string\"> 6798830 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------------+-------------+</span></span><br></pre></td></tr></table></figure></p>\n<p>一共有27813678764个索引读取请求，有6798830个请求在内存中没有找到直接从硬盘读取索引，计算索引未命中缓存的概率：<code>key_cache_miss_rate = Key_reads / Key_read_requests * 100%</code><br>比如上面的数据，key_cache_miss_rate为0.0244%，4000个索引读取请求才有一个直接读硬盘，已经很BT了,key_cache_miss_rate在0.1%以下都很好(每1000个请求有一个直接读硬盘)，如果key_cache_miss_rate在0.01%以下的话，key_buffer_size分配的过多，可以适当减少。<br>MySQL服务器还提供了key_blocks_*参数：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'key_blocks_u%'; </span><br><span class=\"line\">+------------------------+-------------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------------+-------------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Key_blocks_unused </span>|<span class=\"string\"> 0 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Key_blocks_used </span>|<span class=\"string\"> 413543 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------------+-------------+</span></span><br></pre></td></tr></table></figure></p>\n<p>Key_blocks_unused表示未使用的缓存簇(blocks)数，Key_blocks_used表示曾经用到的最大的blocks数，比如这台服务器，所有的缓存都用到了，要么增加key_buffer_size，要么就是过渡索引了，把缓存占满了。比较理想的设置：<br>Key_blocks_used / (Key_blocks_unused + Key_blocks_used) * 100% ≈ 80%</p>\n<h4 id=\"临时表\"><a href=\"#临时表\" class=\"headerlink\" title=\"临时表\"></a>临时表</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'created_tmp%'; </span><br><span class=\"line\">+-------------------------+---------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------------+---------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Created_tmp_disk_tables </span>|<span class=\"string\"> 21197 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Created_tmp_files </span>|<span class=\"string\"> 58 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Created_tmp_tables </span>|<span class=\"string\"> 1771587 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------------+---------+</span></span><br></pre></td></tr></table></figure>\n<p>每次创建临时表，Created_tmp_tables增加，如果是在磁盘上创建临时表，Created_tmp_disk_tables也增加,Created_tmp_files表示MySQL服务创建的临时文件文件数，比较理想的配置是：<br><code>Created_tmp_disk_tables / Created_tmp_tables * 100% &lt;= 25%</code><br>比如上面的服务器<code>Created_tmp_disk_tables / Created_tmp_tables * 100% = 1.20%</code>, 应该相当好了。我们再看一下MySQL服务器对临时表的配置：<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables where Variable<span class=\"emphasis\">_name in ('tmp_</span>table<span class=\"emphasis\">_size', 'max_</span>heap<span class=\"emphasis\">_table_</span>size'); </span><br><span class=\"line\"><span class=\"code\">+---------------------+</span>-----------+ </span><br><span class=\"line\">| Variable<span class=\"emphasis\">_name | Value | </span></span><br><span class=\"line\"><span class=\"emphasis\">+---------------------+-----------+ </span></span><br><span class=\"line\"><span class=\"emphasis\">| max_</span>heap<span class=\"emphasis\">_table_</span>size | 268435456 | </span><br><span class=\"line\">| tmp<span class=\"emphasis\">_table_</span>size | 536870912 | </span><br><span class=\"line\"><span class=\"code\">+---------------------+</span>-----------+</span><br></pre></td></tr></table></figure></p>\n<p>只有256MB以下的临时表才能全部放内存，超过的就会用到硬盘临时表。</p>\n<h4 id=\"Open-Table\"><a href=\"#Open-Table\" class=\"headerlink\" title=\"Open Table\"></a>Open Table</h4><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like <span class=\"emphasis\">'open%tables%'</span>; </span><br><span class=\"line\"><span class=\"code\">+---------------+</span>-------+ </span><br><span class=\"line\">| Variable<span class=\"emphasis\">_name | Value | </span></span><br><span class=\"line\"><span class=\"emphasis\">+---------------+-------+ </span></span><br><span class=\"line\"><span class=\"emphasis\">| Open_</span>tables | 919 | </span><br><span class=\"line\">| Opened<span class=\"emphasis\">_tables | 1951 | </span></span><br><span class=\"line\"><span class=\"emphasis\">+---------------+-------+</span></span><br></pre></td></tr></table></figure>\n<p>Open_tables表示打开表的数量，Opened_tables表示打开过的表数量，如果Opened_tables数量过大，说明配置中table_cache(5.1.3之后这个值叫做table_open_cache)值可能太小，我们查询一下服务器table_cache值：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like 'table_cache'; </span><br><span class=\"line\">+---------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> table_cache </span>|<span class=\"string\"> 2048 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-------+</span></span><br></pre></td></tr></table></figure></p>\n<p>比较合适的值为：<br><code>Open_tables / Opened_tables * 100% &gt;= 85%</code>, 及<code>Open_tables / table_cache * 100% &lt;= 95%`</code></p>\n<p>六、进程使用情况<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like ‘Thread%’; </span><br><span class=\"line\">+-------------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Threads_cached </span>|<span class=\"string\"> 46 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Threads_connected </span>|<span class=\"string\"> 2 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Threads_created </span>|<span class=\"string\"> 570 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Threads_running </span>|<span class=\"string\"> 1 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+-------+</span></span><br></pre></td></tr></table></figure></p>\n<p>如果我们在MySQL服务器配置文件中设置了<code>thread_cache_size</code>， 当客户端断开之后，服务器处理此客户的线程将会缓存起来以响应下一个客户而不是销毁(前提是缓存数未达上限)。Threads_created表示创建过的线程数，如果发现Threads_created值过大的话，表明MySQL服务器一直在创建线程，这也是比较耗资源，可以适当增加配置文件中thread_cache_size值，查询服务器thread_cache_size配置：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like 'thread_cache_size'; </span><br><span class=\"line\">+-------------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> thread_cache_size </span>|<span class=\"string\"> 64 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+-------+</span></span><br></pre></td></tr></table></figure></p>\n<p>示例中的服务器还是挺健康的。</p>\n<h4 id=\"查询缓存-query-cache\"><a href=\"#查询缓存-query-cache\" class=\"headerlink\" title=\"查询缓存(query cache)\"></a>查询缓存(query cache)</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'qcache%'; </span><br><span class=\"line\">+-------------------------+-----------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------------+-----------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_free_blocks </span>|<span class=\"string\"> 22756 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_free_memory </span>|<span class=\"string\"> 76764704 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_hits </span>|<span class=\"string\"> 213028692 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_inserts </span>|<span class=\"string\"> 208894227 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_lowmem_prunes </span>|<span class=\"string\"> 4010916 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_not_cached </span>|<span class=\"string\"> 13385031 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_queries_in_cache </span>|<span class=\"string\"> 43560 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Qcache_total_blocks </span>|<span class=\"string\"> 111212 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------------+-----------+</span></span><br></pre></td></tr></table></figure>\n<p>MySQL查询缓存变量解释：<br><code>Qcache_free_blocks</code>： 缓存中相邻内存块的个数。数目大说明可能有碎片。FLUSH QUERY CACHE会对缓存中的碎片进行整理，从而得到一个空闲块。<br><code>Qcache_free_memory</code>： 缓存中的空闲内存。<br><code>Qcache_hits</code>： 每次查询在缓存中命中时就增大<br><code>Qcache_inserts</code>： 每次插入一个查询时就增大。命中次数除以插入次数就是不中比率。<br><code>Qcache_lowmem_prunes</code>： 缓存出现内存不足并且必须要进行清理以便为更多查询提供空间的次数。这个数字最好长时间来看;如果这个数字在不断增长，就表示可能碎片非常严重，或者内存很少。(上面的 free_blocks和free_memory可以告诉您属于哪种情况)<br><code>Qcache_not_cached</code>： 不适合进行缓存的查询的数量，通常是由于这些查询不是 SELECT 语句或者用了now()之类的函数。<br><code>Qcache_queries_in_cache</code>： 当前缓存的查询(和响应)的数量。<br><code>Qcache_total_blocks</code>： 缓存中块的数量。</p>\n<p>我们再查询一下服务器关于query_cache的配置：<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like 'query_cache%'; </span><br><span class=\"line\">+------------------------------+-----------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------------------+-----------+ </span></span><br><span class=\"line\">|<span class=\"string\"> query_cache_limit </span>|<span class=\"string\"> 2097152 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> query_cache_min_res_unit </span>|<span class=\"string\"> 4096 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> query_cache_size </span>|<span class=\"string\"> 203423744 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> query_cache_type </span>|<span class=\"string\"> ON </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> query_cache_wlock_invalidate </span>|<span class=\"string\"> OFF </span>|</span><br><span class=\"line\">+——————————+———–+</span><br></pre></td></tr></table></figure></p>\n<p>各字段的解释：<br><code>query_cache_limit</code>： 超过此大小的查询将不缓存<br><code>query_cache_min_res_unit</code>： 缓存块的最小大小<br><code>query_cache_size</code>： 查询缓存大小<br><code>query_cache_type</code>： 缓存类型，决定缓存什么样的查询，示例中表示不缓存 select sql_no_cache 查询<br><code>query_cache_wlock_invalidate</code>： 当有其他客户端正在对MyISAM表进行写操作时，如果查询在query cache中，是否返回cache结果还是等写操作完成再读表获取结果。<br><code>query_cache_min_res_unit</code> 的配置是一柄”双刃剑”，默认是4KB，设置值大对大数据查询有好处，但如果你的查询都是小数据查询，就容易造成内存碎片和浪费。</p>\n<p>查询缓存碎片率 = <code>Qcache_free_blocks / Qcache_total_blocks * 100%</code><br>如果查询缓存碎片率超过20%，可以用FLUSH QUERY CACHE整理缓存碎片，或者试试减小query_cache_min_res_unit，如果你的查询都是小数据量的话。<br>查询缓存利用率 = <code>(query_cache_size - Qcache_free_memory) / query_cache_size * 100%</code><br>查询缓存利用率在25%以下的话说明<code>query_cache_size</code>设置的过大，可适当减小;查询缓存利用率在80%以上而且Qcache_lowmem_prunes &gt; 50的话说明query_cache_size可能有点小，要不就是碎片太多。<br>查询缓存命中率 = <code>(Qcache_hits - Qcache_inserts) / Qcache_hits * 100%</code><br>示例服务器 查询缓存碎片率 = 20.46%，查询缓存利用率 = 62.26%，查询缓存命中率 = 1.94%，命中率很差，可能写操作比较频繁吧，而且可能有些碎片。</p>\n<h4 id=\"排序使用情况\"><a href=\"#排序使用情况\" class=\"headerlink\" title=\"排序使用情况\"></a>排序使用情况</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'sort%'; </span><br><span class=\"line\">+-------------------+------------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+------------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Sort_merge_passes </span>|<span class=\"string\"> 29 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Sort_range </span>|<span class=\"string\"> 37432840 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Sort_rows </span>|<span class=\"string\"> 9178691532 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Sort_scan </span>|<span class=\"string\"> 1860569 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-------------------+------------+</span></span><br></pre></td></tr></table></figure>\n<p><code>Sort_merge_passes</code> 包括两步。MySQL 首先会尝试在内存中做排序，使用的内存大小由系统变量 Sort_buffer_size 决定，如果它的大小不够把所有的记录都读到内存中，MySQL 就会把每次在内存中排序的结果存到临时文件中，等 MySQL 找到所有记录之后，再把临时文件中的记录做一次排序。这再次排序就会增加 Sort_merge_passes。实际上，MySQL 会用另一个临时文件来存再次排序的结果，所以通常会看到 Sort_merge_passes 增加的数值是建临时文件数的两倍。因为用到了临时文件，所以速度可能会比较慢，增加 Sort_buffer_size 会减少 Sort_merge_passes 和 创建临时文件的次数。但盲目的增加 Sort_buffer_size 并不一定能提高速度。<br>另外，增加read_rnd_buffer_size(3.2.3是record_rnd_buffer_size)的值对排序的操作也有一点的好处，参见：<a href=\"http://www.mysqlperformanceblog.com/2007/07/24/what-exactly-is-read_rnd_buffer_size/\" target=\"_blank\" rel=\"noopener\">http://www.mysqlperformanceblog.com/2007/07/24/what-exactly-is-read_rnd_buffer_size/</a></p>\n<h4 id=\"文件打开数-open-files\"><a href=\"#文件打开数-open-files\" class=\"headerlink\" title=\"文件打开数(open_files)\"></a>文件打开数(open_files)</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'open_files'; </span><br><span class=\"line\">+---------------+-------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Open_files </span>|<span class=\"string\"> 1410 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-------+ </span></span><br><span class=\"line\"><span class=\"string\">mysql&gt; show variables like 'open_files_limit'; </span></span><br><span class=\"line\"><span class=\"string\">+------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------+-------+ </span></span><br><span class=\"line\">|<span class=\"string\"> open_files_limit </span>|<span class=\"string\"> 4590 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+------------------+-------+</span></span><br></pre></td></tr></table></figure>\n<p>比较合适的设置：<code>Open_files / open_files_limit * 100% &lt;= 75%</code></p>\n<h4 id=\"表锁情况\"><a href=\"#表锁情况\" class=\"headerlink\" title=\"表锁情况\"></a>表锁情况</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'table_locks%'; </span><br><span class=\"line\">+-----------------------+-----------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------------+-----------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Table_locks_immediate </span>|<span class=\"string\"> 490206328 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Table_locks_waited </span>|<span class=\"string\"> 2084912 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------------+-----------+</span></span><br></pre></td></tr></table></figure>\n<p><code>Table_locks_immediate</code> 表示立即释放表锁数，<code>Table_locks_waited</code> 表示需要等待的表锁数，如果Table_locks_immediate / Table_locks_waited &gt; 5000，最好采用InnoDB引擎，因为InnoDB是行锁而MyISAM是表锁，对于高并发写入的应用InnoDB效果会好些。示例中的服务器Table_locks_immediate / Table_locks_waited = 235，MyISAM就足够了。</p>\n<h4 id=\"表扫描情况\"><a href=\"#表扫描情况\" class=\"headerlink\" title=\"表扫描情况\"></a>表扫描情况</h4><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show global status like 'handler_read%'; </span><br><span class=\"line\">+-----------------------+-------------+ </span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------------+-------------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_first </span>|<span class=\"string\"> 5803750 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_key </span>|<span class=\"string\"> 6049319850 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_next </span>|<span class=\"string\"> 94440908210 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_prev </span>|<span class=\"string\"> 34822001724 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_rnd </span>|<span class=\"string\"> 405482605 </span>|<span class=\"string\"> </span></span><br><span class=\"line\">|<span class=\"string\"> Handler_read_rnd_next </span>|<span class=\"string\"> 18912877839 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+-----------------------+-------------+　　</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">mysql&gt; show global status like 'com_select'; </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-----------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Variable_name </span>|<span class=\"string\"> Value </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-----------+ </span></span><br><span class=\"line\">|<span class=\"string\"> Com_select </span>|<span class=\"string\"> 222693559 </span>|<span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">+---------------+-----------+</span></span><br></pre></td></tr></table></figure>\n<p>计算表扫描率：<br>表扫描率 = Handler_read_rnd_next / Com_select<br>如果表扫描率超过4000，说明进行了太多表扫描，很有可能索引没有建好，增加read_buffer_size值会有一些好处，但最好不要超过8MB。</p>\n<h3 id=\"查看Mysql状态QPS-TPS-缓存命中率\"><a href=\"#查看Mysql状态QPS-TPS-缓存命中率\" class=\"headerlink\" title=\"查看Mysql状态QPS/TPS/缓存命中率\"></a>查看Mysql状态QPS/TPS/缓存命中率</h3><h4 id=\"QPS-每秒Query量\"><a href=\"#QPS-每秒Query量\" class=\"headerlink\" title=\"QPS(每秒Query量)\"></a>QPS(每秒Query量)</h4><figure class=\"highlight vbnet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">QPS = Questions(<span class=\"keyword\">or</span> Queries) / seconds </span><br><span class=\"line\">mysql &gt; show  <span class=\"keyword\">global</span>  status <span class=\"keyword\">like</span> <span class=\"comment\">'Question%';</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"TPS-每秒事务量\"><a href=\"#TPS-每秒事务量\" class=\"headerlink\" title=\"TPS(每秒事务量)\"></a>TPS(每秒事务量)</h4><figure class=\"highlight vbnet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TPS = (Com_commit + Com_rollback) / seconds </span><br><span class=\"line\">mysql &gt; show <span class=\"keyword\">global</span> status <span class=\"keyword\">like</span> <span class=\"comment\">'Com_commit'; </span></span><br><span class=\"line\">mysql &gt; show <span class=\"keyword\">global</span> status <span class=\"keyword\">like</span> <span class=\"comment\">'Com_rollback';</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"key-Buffer-命中率\"><a href=\"#key-Buffer-命中率\" class=\"headerlink\" title=\"key Buffer 命中率\"></a>key Buffer 命中率</h4><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt;show  global   status  like   <span class=\"string\">'key%'</span>; </span><br><span class=\"line\">key_buffer_read_hits = (<span class=\"number\">1</span>-key_reads / key_read_requests) * <span class=\"number\">100</span>% </span><br><span class=\"line\">key_buffer_write_hits = (<span class=\"number\">1</span>-key_writes / key_write_requests) * <span class=\"number\">100</span>% </span><br><span class=\"line\">``` </span><br><span class=\"line\">#### InnoDB Buffer命中率</span><br></pre></td></tr></table></figure>\n<p>mysql&gt; show status like ‘innodb_buffer_pool_read%’;<br>innodb_buffer_read_hits = (1 - innodb_buffer_pool_reads / innodb_buffer_pool_read_requests) * 100%<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### Query Cache命中率 </span><br><span class=\"line\">`</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show status like ‘Qcache%’;<br>Query_cache_hits = (Qcahce_hits / (Qcache_hits + Qcache_inserts )) * 100%;<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### Table Cache状态量</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show global  status like ‘open%’;<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">比较 open_tables  与 opend_tables 值 </span><br><span class=\"line\"> </span><br><span class=\"line\">#### Thread Cache 命中率</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show global status like ‘Thread%’;<br>mysql&gt; show global status like ‘Connections’;<br>Thread_cache_hits = (1 - Threads_created / connections ) * 100%<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### 锁定状态</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show global  status like ‘%lock%’;<br>Table_locks_waited/Table_locks_immediate=0.3%  如果这个比值比较大的话，说明表锁造成的阻塞比较严重<br>Innodb_row_lock_waits innodb行锁，太大可能是间隙锁造成的<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### 复制延时量</span><br></pre></td></tr></table></figure></p>\n<p>mysql &gt; show slave status<br>查看延时时间<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### Tmp Table 状况(临时表状况)</span><br></pre></td></tr></table></figure></p>\n<p>mysql &gt; show status like ‘Create_tmp%’;<br>Created_tmp_disk_tables/Created_tmp_tables比值最好不要超过10%，如果Created_tmp_tables值比较大，<br>可能是排序句子过多或者是连接句子不够优化<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### Binlog Cache 使用状况</span><br></pre></td></tr></table></figure></p>\n<p>mysql &gt; show status like ‘Binlog_cache%’;<br>如果Binlog_cache_disk_use值不为0 ，可能需要调大 binlog_cache_size大小<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#### Innodb_log_waits 量</span><br></pre></td></tr></table></figure></p>\n<p>mysql &gt; show status like ‘innodb_log_waits’;<br>Innodb_log_waits值不等于0的话，表明 innodb log  buffer 因为空间不足而等待<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">### Mysql查看死锁和解除锁</span><br><span class=\"line\">所谓死锁&lt;DeadLock&gt;：是指两个或两个以上的进程在执行过程中,因争夺资源而造成的一种互相等待的现象,若无外力作用，它们都将无法推进下去.此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程。表级锁不会产生死锁.所以解决死锁主要还是针对于最常用的InnoDB。</span><br><span class=\"line\"></span><br><span class=\"line\">解除正在死锁的状态有两种方法：</span><br><span class=\"line\">* **第一种**</span><br><span class=\"line\"><span class=\"number\">1.</span>查询是否锁表</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show OPEN TABLES where In_use &gt; 0;<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2</span>.查询进程（如果您有<span class=\"keyword\">SUPER</span>权限，您可以看到所有线程。否则，您只能看到您自己的线程）</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; show processlist;<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">3.</span>杀死进程<span class=\"built_in\">id</span>（就是上面命令的<span class=\"built_in\">id</span>列）</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; kill id<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">* </span>*<span class=\"strong\">*第二种*</span><span class=\"strong\">*</span></span><br><span class=\"line\"><span class=\"strong\">1.查看下在锁的事务</span></span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2.</span>杀死进程<span class=\"built_in\">id</span>（就是上面命令的trx_mysql_thread_id列）</span><br></pre></td></tr></table></figure></p>\n<p>mysql&gt; kill 线程ID<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&gt;例子：</span><br><span class=\"line\">查出死锁进程：mysql&gt; <span class=\"keyword\">SHOW </span>PROCESSLIST</span><br><span class=\"line\">杀掉进程: mysql&gt; KILL <span class=\"number\">420821</span><span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">其它关于查看死锁的命令：</span><br></pre></td></tr></table></figure></p>\n<p>1：查看当前的事务<br>mysql&gt; SELECT <em> FROM INFORMATION_SCHEMA.INNODB_TRX;<br>2：查看当前锁定的事务<br>mysql&gt; SELECT </em> FROM INFORMATION_SCHEMA.INNODB_LOCKS;<br>3：查看当前等锁的事务<br>mysql&gt; SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;<br><code>`</code></p>\n<p>后记：<br>文中提到一些数字都是参考值，了解基本原理就可以，除了MySQL提供的各种status值外，操作系统的一些性能指标也很重要，比如常用的top,iostat等，尤其是iostat，现在的系统瓶颈一般都在磁盘IO上，关于iostat的使用.<br>在尝试学习新的语言之前先理解这门语言的设计原理能够让你在探索这门新语言时保持一个清醒而且开发的状态。</p>\n"},{"layout":"post","title":"详解nginx之location误区","author":"Pyker","img":"/images/bar/nginx.jpg","top":true,"cover":false,"date":"2018-01-23T10:47:00.000Z","_content":"### location 的匹配顺序是“先匹配正则，再匹配普通”。\n矫正： location 的匹配顺序其实是“先匹配普通，再匹配正则”。我这么说，大家一定会反驳我，因为按“先匹配普通，再匹配正则”解释不了大家平时习惯的按“先匹配正则，再匹配普通”的实践经验。这里我只能暂时解释下，造成这种误解的原因是：正则匹配会覆盖普通匹配（实际的规则，比这复杂，后面会详细解释）。\n###  location 的执行逻辑跟 location 的编辑顺序无关。\n矫正：这句话不全对，“普通 location ”的匹配规则是“最大前缀”，因此“普通 location ”的确与 location 编辑顺序无关；但是“正则 location ”的匹配规则是“顺序匹配，且只要匹配到第一个就停止后面的匹配”；“普通location ”与“正则 location ”之间的匹配顺序是？先匹配普通 location ，再“考虑”匹配正则 location 。注意这里的“考虑”是“可能”的意思，也就是说匹配完“普通 location ”后，有的时候需要继续匹配“正则 location ”，有的时候则不需要继续匹配“正则 location ”。两种情况下，不需要继续匹配正则 location ：（ 1 ）当普通 location 前面指定了“ ^~ ”，特别告诉 Nginx 本条普通 location 一旦匹配上，则不需要继续正则匹配；（ 2 ）当普通location 恰好严格匹配上，不是最大前缀匹配，则不再继续匹配正则。\n\n**总结一句话：  “正则 location 匹配让步普通 location 的严格精确匹配结果；但覆盖普通 location 的最大前缀匹配结果”**\n>匹配优先级为： (location =) > (location 完整路径) > (location ^~ 路径) > (location ~,~* 正则顺序) > (location 部分起始路径) > (/)\n\n**官方文档解释**：<http://wiki.nginx.org/NginxHttpCoreModule#location>\n```\nlocation\nsyntax: `location [=|~|~*|^~|@] /uri/ { … }`\ndefault: no\ncontext: server\n```\n>This directive allows different configurations depending on the URI.\n\n（译者注：1 、different configurations depending on the URI 说的就是语法格式：`location [=|~|~*|^~|@] /uri/ { … }` ，依据不同的前缀`“= ”，“^~ ”，“~ ”，“~* ”`和不带任何前缀的（因为[A] 表示可选，可以不要的），表达不同的含义, 简单的说尽管location 的/uri/ 配置一样，但前缀不一样，表达的是不同的指令含义。2 、查询字符串不在URI范围内。例如：/films.htm?fid=123 的URI 是/films.htm 。）\nIt can be configured using both literal strings and regular expressions. To use regular expressions, you must use a prefix:\n`“~”`for case sensitive matching\n`“~*”`for case insensitive matching\n译文：上文讲到`location /uri/` 可通过使用不同的前缀，表达不同的含义。对这些不同前缀，分下类，就2 大类：正则location ，英文说法是location using regular expressions 和普通location ，英文说法是location using literal strings 。那么其中“~ ”和“~* ”前缀表示正则location ，“~ ”区分大小写，“~* ”不区分大小写；其他前缀（包括：“=”，“^~ ”和“@ ”）和无任何前缀的都属于普通location 。\n\n>To determine which location directive matches a particular query, the literal strings are checked first.\n\n译文：对于一个特定的 HTTP 请求（ a particular query ）， nginx 应该匹配哪个 location 块的指令呢（注意：我们在 nginx.conf 配置文件里面一般会定义多个 location 的）？匹配 规则是：先匹配普通location （再匹配正则表达式）。注意：官方文档这句话就明确说了，先普通location ，而不是有些同学的误区“先匹配正则location ”。\n>Literal strings match the beginning portion of the query – the most specific match will be used.\n\n前面说了“普通location ”与“正则location ”之间的匹配规则是：先匹配普通location ，再匹配正则location 。那么，“普通location ”内部（普通location 与普通location ）是如何匹配的呢？简单的说：最大前缀匹配。原文：1、match the beginning portion of the query （说的是匹配URI 的前缀部分beginning portion ）； 2 、the most specific match will be used （因为location 不是“严格匹配”，而是“前缀匹配”，就会产生一个HTTP 请求，可以“前缀匹配”到多个普通location ，例如：``location /prefix/mid/ {}`` 和`location /prefix/ {}` ，对于HTTP 请求/prefix/mid/t.html ，前缀匹配的话两个location 都满足，选哪个？原则是：the most specific match ，于是选的是`location /prefix/mid/ {}` ）。\n>Afterwards, regular expressions are checked in the order defined in the configuration file. The first regular expression to match the query will stop the search.\n\n这段话说了两层意思，第一层是：“Afterwards, regular expressions are checked ”, 意思是普通location 先匹配，而且选择了最大前缀匹配后，就不能停止后面的匹配，最大前缀匹配只是一个临时的结果，nginx 还需要继续检查正则location （但至于最终是和普通location 的最大前缀匹配，还是正则location 的匹配，截止当前的内容还没讲，但后面会讲）。第二层是“regular expressions are checked in the order defined in the configuration file. The first regular expression to match the query will stop the search. ”，意思是说“正则location ”与“正则location”内部的匹配规则是：按照正则location 在配置文件中的物理顺序（编辑顺序）匹配的（这句话就说明location 并不是一定跟顺序无关，只是普通location 与顺序无关，正则location 还是与顺序有关的），并且只要匹配到一条正则location ，就不再考虑后面的（这与“普通location ”与“正则location ”之间的规则不一样，“普通location ”与“正则location ”之间的规则是：选择出“普通location ”的最大前缀匹配结果后，还需要继续搜索正则location ）。\n>If no regular expression matches are found, the result from the literal string search is used.\n\n这句话回答了“普通location ”的最大前缀匹配结果与继续搜索的“正则location ”匹配结果的决策关系。如果继续搜索的“正则location ”也有匹配上的，那么“正则location ”覆盖 “普通location ”的最大前缀匹配（因为有这个覆盖关系，所以造成有些同学以为正则location 先于普通location 执行的错误理解）；但是如果“正则location ”没有能匹配上，那么就用“普通location ”的最大前缀匹配结果。\nFor case insensitive operating systems, like Mac OS X or Windows with Cygwin, literal string matching is done in a case insensitive way (0.7.7). However, comparison is limited to single-byte locale’s only.\nRegular expression may contain captures (0.7.40), which can then be used in other directives.\n\n>It is possible to disable regular expression checks after literal string matching by using “^~” prefix.If the most specific match literal location has this prefix: regular expressions aren’t checked.\n\n通常的规则是，匹配完了“普通location ”指令，还需要继续匹配“正则location ”，但是你也可以告诉Nginx ：匹配到了“普通location ”后，不再需要继续匹配“正则location ”了，要做到这一点只要在“普通location ”前面加上“^~ ”符号（^ 表示“非”，~ 表示“正则”，字符意思是：不要继续匹配正则）。\n>By using the “=” prefix we define the exact match between request URI and location. When matched search stops immediately. E.g., if the request “/” occurs frequently, using “location = /” will speed up processing of this request a bit as search will stop after first comparison.\n\n除了上文的“^~ ”可以阻止继续搜索正则location 外，你还可以加“= ”。那么如果“^~ ”和“= ”都能阻止继续搜索正则location 的话，那它们之间有什么区别呢？区别很简单，共同点是它们都能阻止继续搜索正则location ，不同点是“^~ ”依然遵守“最大前缀”匹配规则，然而“= ”不是“最大前缀”，而是必须是严格匹配（exact match ）。\n这里顺便讲下`“location / {} ”和“location = / {} ”`的区别，“location / {} ”遵守普通location 的最大前缀匹配，由于任何URI 都必然以“/ ”根开头，所以对于一个URI ，如果有更specific 的匹配，那自然是选这个更specific 的，如果没有，“/ ”一定能为这个URI 垫背（至少能匹配到“/ ”），也就是说“location / {} ”有点默认配置的味道，其他更specific的配置能覆盖overwrite 这个默认配置（这也是为什么我们总能看到location / {} 这个配置的一个很重要的原因）。而“location = / {} ”遵守的是“严格精确匹配exact match ”，也就是只能匹配 http://host:port/ 请求，同时会禁止继续搜索正则location 。因此如果我们只想对“GET / ”请求配置作用指令，那么我们可以选“location = / {} ”这样能减少正则location 的搜索，因此效率比“location / {}” 高（注：前提是我们的目的仅仅只想对“GET / ”起作用）。\n>On exact match with literal location without “=” or “^~” prefixes search is also immediately terminated.\n\n前面我们说了，普通location 匹配完后，还会继续匹配正则location ；但是nginx 允许你阻止这种行为，方法很简单，只需要在普通location 前加“^~ ”或“= ”。但其实还有一种“隐含”的方式来阻止正则location 的搜索，这种隐含的方式就是：当“最大前缀”匹配恰好就是一个“严格精确（exact match ）”匹配，照样会停止后面的搜索。原文字面意思是：只要遇到“精确匹配exact match ”，即使普通location 没有带“= ”或“^~ ”前缀，也一样会终止后面的匹配。\n\n先举例解释下，后面例题会用实践告诉大家。假设当前配置是：location /exact/match/test.html { 配置指令块1}，location /prefix/ { 配置指令块2} 和 location ~ \\.html$ { 配置指令块3} ，如果我们请求 GET /prefix/index.html ，则会被匹配到指令块3 ，因为普通location /prefix/ 依据最大匹配原则能匹配当前请求，但是会被后面的正则location 覆盖；当请求GET /exact/match/test.html ，会匹配到指令块1 ，因为这个是普通location 的exact match ，会禁止继续搜索正则location 。\n\n**To summarize, the order in which directives are checked is as follows:**\n1. Directives with the “=” prefix that match the query exactly. If found, searching stops.\n2. All remaining directives with conventional strings. If this match used the “^~” prefix, searching stops.\n3. Regular expressions, in the order they are defined in the configuration file.\n4. If #3 yielded a match, that result is used. Otherwise, the match from #2 is used.\n\n这个顺序没必要再过多解释了。但我想用自己的话概括下上面的意思“正则 location 匹配让步普通location 的严格精确匹配结果；但覆盖普通 location 的最大前缀匹配结果”。\n>It is important to know that nginx does the comparison against decoded URIs. For example, if you wish to match “/images/ /test”, then you must use “/images/ /test” to determine the location.\n\n在浏览器上显示的URL 一般都会进行URLEncode ，例如“空格”会被编码为  ，但是Nginx 的URL 的匹配都是针对URLDecode 之后的。也就是说，如果你要匹配“/images/ /test ”，你写location 的时候匹配目标应该是：“/images/ /test ”。\n\n**Example:**\n```\nlocation   = / {\n # matches the query / only.\n [ configuration A ]\n}\n\nlocation   / {\n  # matches any query, since all queries begin with /, but regular\n  # expressions and any longer conventional blocks will be\n  # matched first.\n [ configuration B ]\n}\n\nlocation ^~ /images/ {\n    # matches any query beginning with /images/ and halts searching,\n    # so regular expressions will not be checked.\n [ configuration C ]\n}\n\nlocation ~* \\.(gif|jpg|jpeg)$ {\n # matches any request ending in gif, jpg, or jpeg. However, all\n # requests to the /images/ directory will be handled by\n # Configuration C.  \n [ configuration D ]\n}\n```\n上述这4 个location 的配置，没什么好解释的，唯一需要说明的是location / {[configuration B]} ，原文的注释严格来说是错误的，但我相信原文作者是了解规则的，只是文字描述上简化了下，但这个简化容易给读者造成“误解：先检查正则location ，再检查普通location ”。原文：“matches any query, since all queries begin with /, butregular expressions and any longer conventional blocks will be matched first. ”大意是说：“location / {} 能够匹配所有HTTP 请求，因为任何HTTP 请求都必然是以‘/ ’开始的（这半句没有错误）。但是，正则location 和其他任何比‘/ ’更长的普通location （location / {} 是普通location 里面最短的，因此其他任何普通location 都会比它更长，当然location = / {} 和 location ^~ / {} 是一样长的）会优先匹配（matched first ）。” 原文作者说“ but regular expressions will be matched first. ”应该只是想说正则 location 会覆盖这里的 location / {} ，但依然是普通location / {} 先于正则 location 匹配，接着再正则 location 匹配；但其他更长的普通 location （ any longer conventional blocks ）的确会先于 location / {} 匹配。\n\nExample requests:\n\n* / -> configuration A\n* /documents/document.html -> configuration B\n* /images/1.gif -> configuration C\n* /documents/1.jpg -> configuration D\n\n>Note that you could define these 4 configurations in any order and the results would remain the same.\n\n需要提醒下：这里说“in any order ”和“… remain the same ”是因为上面只有一个正则location 。文章前面已经说了正则location 的匹配是跟编辑顺序有关系的。\n>While nested locations are allowed by the configuration file parser, their use is discouraged and may produce unexpected results.\n\n实际上 nginx 的配置文件解析程序是允许 location 嵌套定义的（ location / { location /uri/ {} } ）。但是我们平时却很少看见这样的配置，那是因为 nginx 官方并不建议大家这么做，因为这样会导致很多意想不到的后果。\n>The prefix “@” specifies a named location. Such locations are not used during normal processing of requests, they are intended only to process internally redirected requests (see error_page ,try_files ).\n\n文章开始说了location 的语法中，可以有“= ”，“^~ ”，“~ ”和“~* ”前缀，或者干脆没有任何前缀，还有“@ ”前缀，但是后面的分析我们始终没有谈到“@ ”前缀。文章最后点内容，介绍了“＠”的用途：“@ ”是用来定义“Named Location ”的（你可以理解为独立于“普通location （location using literal strings ）”和“正则location （location using regular expressions ）”之外的第三种类型），这种“Named Location ”不是用来处理普通的HTTP 请求的，它是专门用来处理“内部重定向（internally redirected ）”请求的。注意：这里说的“内部重定向（internally redirected ）”或许说成“forward ”会好点，以为内internally redirected 是不需要跟浏览器交互的，纯粹是服务端的一个转发行为。\n\n### location 实例练习\nNginx 的语法形式是：`location [=|~|~*|^~|@] /uri/ { … } `，意思是可以以“ = ”或“ ~* ”或“ ~ ”或“ ^~ ”或“ @ ”符号为前缀，当然也可以没有前缀（因为 [A] 是表示可选的 A ； A|B 表示 A 和 B 选一个），紧接着是 /uri/ ，再接着是{…} 指令块，整个意思是对于满足这样条件的 /uri/ 适用指令块 {…} 的指令。\n\n上述各种 location 可分两大类，分别是：“普通 location ”，官方英文说法是 location using   literal strings 和“正则 location ”，英文说法是 location using regular expressions 。其中“普通 location ”是以“ = ”或“ ^~ ”为前缀或者没有任何前缀的 /uri/ ；“正则 location ”是以“ ~ ”或“ ~* ”为前缀的 /uri/ 。\n那么，当我们在一个 server 上下文编写了多个 location 的时候， Nginx 对于一个 HTTP 请求，是如何匹配到一个 location 做处理呢？用一句话简单概括 Nginx 的 location 匹配规则是：“正则 location ”让步 “普通 location”的严格精确匹配结果；但覆盖 “普通 location ”的最大前缀匹配结果。理解这句话，我想通过下面的实例来说明。\n\n* **先普通 location ，再正则 location**\n周边不少童鞋告诉我， nginx 是“先匹配正则 location 再匹配普通 location ”，其实这是一个误区， nginx 其实是“先匹配普通 location ，再匹配正则 location ”，但是普通 location 的匹配结果又分两种：一种是“严格精确匹配”，官方英文说法是“ exact match ”；另一种是“最大前缀匹配”，官方英文说法是“ Literal strings match the beginning portion of the query – the most specific match will be used. ”。我们做个实验：\n\n例题 1 ：假设 nginx 的配置如下\n```\nserver {\n       listen       9090;\n       server_name  localhost;\n       location / {\n           root   html;\n           index  index.html index.htm;\n           deny all;\n       }\n       location ~ \\.html$ {\n           allow all;\n       }\n}\n```\n附录 nginx 的目录结构是： nginx->html->index.html\n上述配置的意思是： location / {… deny all;} 普通 location 以“ / ”开始的 URI 请求（注意任何 HTTP 请求都必然以“/ ”开始，所以“ / ”的意思是所有的请求都能被匹配上），都拒绝访问； location ~\\.html$ {allow all;} 正则 location以 .html 结尾的 URI 请求，都允许访问。\n\n测试结果：\n```bash\n[root@web108 ~]# curl http://localhost:9090/\n<html>\n<head><title>403 Forbidden</title></head>\n<body bgcolor=”white”>\n<center><h1>403 Forbidden</h1></center>\n<hr><center>nginx/1.1.0</center>\n</body>\n</html>\n\n[root@web108 ~]# curl http://localhost:9090/index.html\n<html>\n<head>\n<title>Welcome to nginx!</title>\n</head>\n<body bgcolor=”white” text=”black”>\n<center><h1>Welcome to nginx!</h1></center>\n</body>\n</html>\n\n[root@web108 ~]# curl http://localhost:9090/index_notfound.html\n<html>\n<head><title>404 Not Found</title></head>\n<body bgcolor=”white”>\n<center><h1>404 Not Found</h1></center>\n<hr><center>nginx/1.1.0</center>\n</body>\n</html>\n```\n测试结果如下：\n\nURI请求 | HTTP响应\n:--- | :---:\ncurl http://localhost:9090/ | 403 Forbidden\ncurl http://localhost:9090/index.html|Welcome to nginx!\ncurl http://localhost:9090/index_notfound.html|404 Not Found\n\n`curl http://localhost:9090/` 的结果是“ 403 Forbidden ”，说明被匹配到“ location / {..deny all;} ”了，原因很简单HTTP 请求 GET / 被“严格精确”匹配到了普通 location / {} ，则会停止搜索正则 location ；\n\n`curl http://localhost:9090/index.html` 结果是“ Welcome to nginx! ”，说明没有被“ location / {…deny all;} ”匹配，否则会 403 Forbidden ，但 /index.html 的确也是以“ / ”开头的，只不过此时的普通 location / 的匹配结果是“最大前缀”匹配，所以 Nginx 会继续搜索正则 location ， location ~ \\.html$ 表达了以 .html 结尾的都 allow all; 于是接着就访问到了实际存在的 index.html 页面。\n\n`curl http://localhost:9090/index_notfound.html`   同样的道理先匹配 location / {} ，但属于“普通 location 的最大前缀匹配”，于是后面被“正则 location ” location ~ \\.html$ {} 覆盖了，最终 allow all ； 但的确目录下不存在index_notfound.html 页面，于是 404 Not Found 。\n\n如果此时我们访问 http://localhost:9090/index.txt 会是什么结果呢？显然是 deny all ；因为先匹配上了 location / {..deny all;} 尽管属于“普通 location ”的最大前缀匹配结果，继续搜索正则 location ，但是 /index.txt 不是以 .html结尾的，正则 location 失败，最终采纳普通 location 的最大前缀匹配结果，于是 deny all 了。\n```bash\n[root@web108 ~]# curl http://localhost:9090/index.txt\n<html>\n<head><title>403 Forbidden</title></head>\n<body bgcolor=”white”>\n<center><h1>403 Forbidden</h1></center>\n<hr><center>nginx/1.1.0</center>\n</body>\n</html>\n```\n* **普通 location 的“隐式”严格匹配**\n\n例题 2 ：我们在例题 1 的基础上增加精确配置\n\n```\nserver {\n       listen       9090;\n       server_name  localhost;\n       location /exact/match.html {\n           allow all;\n       }\n       location / {\n           root   html;\n           index  index.html index.htm;\n           deny all;\n       }\n       location ~ \\.html$ {\n           allow all;\n       }\n}\n```\n测试请求：\n```bash\n[root@web108 ~]# curl http://localhost:9090/exact/match.html\n<html>\n<head><title>404 Not Found</title></head>\n<body bgcolor=”white”>\n<center><h1>404 Not Found</h1></center>\n<hr><center>nginx/1.1.0</center>\n</body>\n</html>\n```\n\n结果进一步验证了“普通 location ”的“严格精确”匹配会终止对正则 location 的搜索。这里我们小结下“普通 location”与“正则 location ”的匹配规则：先匹配普通 location ，再匹配正则 location ，但是如果普通 location 的匹配结果恰好是“严格精确（ exact match ）”的，则 nginx 不再尝试后面的正则 location ；如果普通 location 的匹配结果是“最大前缀”，则正则 location 的匹配覆盖普通 location 的匹配。也就是前面说的“正则 location 让步普通location 的严格精确匹配结果，但覆盖普通 location 的最大前缀匹配结果”。\n\n* **普通 location 的“显式”严格匹配和“ ^~ ” 前缀**\n\n上面我们演示的普通 location 都是不加任何前缀的，其实普通 location 也可以加前缀：“ ^~ ”和“ = ”。其中“ ^~”的意思是“非正则，不需要继续正则匹配”，也就是通常我们的普通 location ，还会继续搜索正则 location （恰好严格精确匹配除外），但是 nginx 很人性化允许配置人员告诉 nginx 某条普通 location ，无论最大前缀匹配，还是严格精确匹配都终止继续搜索正则 location ；而“ = ”则表达的是普通 location 不允许“最大前缀”匹配结果，必须严格等于，严格精确匹配。\n\n例题 3 ：“ ^~ ”前缀的使用\n```bash\nserver {\n       listen       9090;\n       server_name  localhost;\n       location /exact/match.html {\n           allow all;\n       }\n       location ^~ / {\n           root   html;\n           index  index.html index.htm;\n           deny all;\n       }\n       location ~ \\.html$ {\n           allow all;\n       }\n}\n```\n把例题 2 中的 location / {} 修改成 location ^~ / {} ，再看看测试结果：\n\nURL请求 | 修改前 | 修改后\n---- | :----: | :----:\ncurl http://localhost:9090/ | 403 Forbidden | 403 Forbidden\ncurl http://localhost:9090/index.html | Welcome to nginx! | 403 Forbidden\ncurl http://localhost:9090/index_notfound.html | 404 Not Found | 403 Forbidden\ncurl http://localhost:9090/exact/match.html | 404 Not Found | 404 Not Found\n\n除了 GET /exact/match.html 是 404 Not Found ，其余都是 403 Forbidden ，原因很简单所有请求都是以“ / ”开头，所以所有请求都能匹配上“ / ”普通 location ，但普通 location 的匹配原则是“最大前缀”，所以只有/exact/match.html 匹配到 location /exact/match.html {allow all;} ，其余都 location ^~ / {deny all;} 并终止正则搜索。\n\n例题 4 ：“ = ”前缀的使用\n```bash\nserver {\n       listen       9090;\n       server_name  localhost;\n       location /exact/match.html {\n           allow all;\n       }\n       location = / {\n           root   html;\n           index  index.html index.htm;\n           deny all;\n       }\n       location ~ \\.html$ {\n           allow all;\n       }\n}\n```\n例题 4 相对例题 2 把 location / {} 修改成了 location = / {} ，再次测试结果：\n\nURL请求 | 修改前 | 修改后\n---- | :----: | :----:\ncurl http://localhost:9090/ | 403 Forbidden | 403 Forbidden\ncurl http://localhost:9090/index.html | Welcome to nginx! | Welcome to nginx!\ncurl http://localhost:9090/index_notfound.html | 404 Not Found | 404 Not Found\ncurl http://localhost:9090/exact/match.html | 404 Not Found | 404 Not Found\ncurl http://localhost:9090/test.jsp | 403 Forbidden | 404 Not Found\n\n最能说明问题的测试是 GET /test.jsp ，实际上 /test.jsp 没有匹配正则 location （ location ~\\.html$ ），也没有匹配 location = / {} ，如果按照 location / {} 的话，会“最大前缀”匹配到普通 location / {} ，结果是 deny all 。\n\n* **正则 location 与编辑顺序**\nlocation 的指令与编辑顺序无关，这句话不全对。对于普通 location 指令，匹配规则是：最大前缀匹配（与顺序无关），如果恰好是严格精确匹配结果或者加有前缀“ ^~ ”或“ = ”（符号“ = ”只能严格匹配，不能前缀匹配），则停止搜索正则 location ；但对于正则 location 的匹配规则是：按编辑顺序逐个匹配（与顺序有关），只要匹配上，就立即停止后面的搜索。\n\n```bash\n配置 3.1\n\nserver {\n       listen       9090;\n       server_name  localhost;\n       location ~ \\.html$ {\n           allow all; \n       }  \n       location ~ ^/prefix/.*\\.html$ {\n           deny all;  \n       }  \n}\n配置 3.2\n\nserver {\n       listen       9090;\n       server_name  localhost;     \n       location ~ ^/prefix/.*\\.html$ {\n           deny all;  \n       }            \n       location ~ \\.html$ {\n           allow all; \n       } \n}\n```\n测试结果：\n\nURL请求 | 配置3.1 | 配置3.2\n---- | :----: | :----:\ncurl http://localhost:9090/regextest.html | 404 Not Found | 404 Not Found\ncurl http://localhost:9090/prefix/regextest.html | 404 Not Found | 403 Forbidden\n\n解释：\n`Location ~ ^/prefix/.*\\.html$ {deny all;}` 表示正则 location 对于以 /prefix/ 开头， .html 结尾的所有 URI 请求，都拒绝访问；   `location ~\\.html${allow all;}` 表示正则 location 对于以 .html 结尾的 URI 请求，都允许访问。 实际上，prefix 的是 ~\\.html$ 的子集。\n\n在“配置 3.1 ”下，两个请求都匹配上 `location ~\\.html$ {allow all;}` ，并且停止后面的搜索，于是都允许访问， 404 Not Found ；在“配置 3.2 ”下， /regextest.html 无法匹配 prefix ，于是继续搜索 ~\\.html$ ，允许访问，于是 404 Not Found ；然而 /prefix/regextest.html 匹配到 prefix ，于是 deny all ， 403 Forbidden 。\n```\n配置 3.3\n\nserver {\n       listen       9090;\n       server_name  localhost; \n       location  /prefix/ {\n               deny all;  \n       }           \n       location  /prefix/mid/ {\n               allow all; \n       }  \n}\n配置 3.4\n\nserver {\n       listen       9090;\n       server_name  localhost;    \n       location  /prefix/mid/ {\n               allow all; \n       }  \n        location  /prefix/ {\n               deny all;  \n       }  \n}\n```\n测试结果：\n\nURL请求 | 配置3.3 | 配置3.4\n---- | :----: | :----:\ncurl http://localhost:9090/prefix/t.html | 403 Forbidden | 403 Forbidden\ncurl http://localhost:9090/prefix/mid/t.html | 404 Not Found | 404 Not Found\n\n测试结果表明：普通 location 的匹配规则是“最大前缀”匹配，而且与编辑顺序无关。\n\n* **“@” 前缀 Named Location 使用**\nREFER:  <http://wiki.nginx.org/HttpCoreModule#error_page>\n假设配置如下：\n```bash\nserver {\n       listen       9090;\n       server_name  localhost;\n       location  / {\n           root   html;\n           index  index.html index.htm;\n           allow all;\n       }\n       #error_page 404 http://www.baidu.com # 直接这样是不允许的\n       error_page 404 = @fallback;\n\t   \n       location @fallback {\n           proxy_pass http://www.baidu.com;\n       }\n}\n```\n上述配置文件的意思是：如果请求的 URI 存在，则本 nginx 返回对应的页面；如果不存在，则把请求代理到baidu.com 上去做个弥补（注： nginx 当发现 URI 对应的页面不存在， HTTP_StatusCode 会是 404 ，此时error_page 404 指令能捕获它）。\n\n测试一：\n\n```bash\n[root@web108 ~]# curl http://localhost:9090/nofound.html -i\nHTTP/1.1 302 Found\nServer: nginx/1.1.0\nDate: Sat, 06 Aug 2011 08:17:21 GMT\nContent-Type: text/html; charset=iso-8859-1\nLocation: http://localhost:9090/search/error.html\nConnection: keep-alive\nCache-Control: max-age=86400\nExpires: Sun, 07 Aug 2011 08:17:21 GMT\nContent-Length: 222\n\n<!DOCTYPE HTML PUBLIC “-//IETF//DTD HTML 2.0//EN”>\n<html><head>\n<title>302 Found</title>\n</head><body>\n<h1>Found</h1>\n<p>The document has moved <a href=”http://www.baidu.com/search/error.html”>here</a>.</p>\n</body></html>\n```\n当我们 GET /nofound.html 发送给本 nginx ， nginx 找不到对应的页面，于是 error_page 404 = @fallback ，请求被代理到 http://www.baidu.com ，于是 nginx 给 http://www.baidu.com 发送了 GET /nofound.html ，但/nofound.html 页面在百度也不存在，百度 302 跳转到错误页。\n直接访问 http://www.baidu.com/nofound.html 结果：\n\n```bash\n[root@web108 ~]# curl http://www.baidu.com/nofound.html -i\nHTTP/1.1 302 Found\nDate: Sat, 06 Aug 2011 08:20:05 GMT\nServer: Apache\nLocation: http://www.baidu.com/search/error.html\nCache-Control: max-age=86400\nExpires: Sun, 07 Aug 2011 08:20:05 GMT\nContent-Length: 222\nConnection: Keep-Alive\nContent-Type: text/html; charset=iso-8859-1\n \n<!DOCTYPE HTML PUBLIC “-//IETF//DTD HTML 2.0//EN”>\n<html><head>\n<title>302 Found</title>\n</head><body>\n<h1>Found</h1>\n<p>The document has moved <a href=”http://www.baidu.com/search/error.html”>here</a>.</p>\n</body></html>\n```\n测试二：访问一个 nginx 不存在，但 baidu 存在的页面\n```bash\n[root@web108 ~]# curl http://www.baidu.com/duty/ -i\nHTTP/1.1 200 OK\nDate: Sat, 06 Aug 2011 08:21:56 GMT\nServer: Apache\nP3P: CP=” OTI DSP COR IVA OUR IND COM ”\nP3P: CP=” OTI DSP COR IVA OUR IND COM ”\nSet-Cookie: BAIDUID=5C5D2B2FD083737A0C88CA7075A6601A:FG=1; expires=Sun, 05-Aug-12 08:21:56 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1\nSet-Cookie: BAIDUID=5C5D2B2FD083737A2337F78F909CCB90:FG=1; expires=Sun, 05-Aug-12 08:21:56 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1\nLast-Modified: Wed, 05 Jan 2011 06:44:53 GMT\nETag: “d66-49913b8efe340″\nAccept-Ranges: bytes\nContent-Length: 3430\nCache-Control: max-age=86400\nExpires: Sun, 07 Aug 2011 08:21:56 GMT\nVary: Accept-Encoding,User-Agent\nConnection: Keep-Alive\nContent-Type: text/html\n\n<!DOCTYPE HTML PUBLIC “-//W3C//DTD HTML 4.01 Transitional//EN”\n“http://www.w3.org/TR/html4/loose.dtd”>\n。。。。\n</body>\n</html>\n```\n显示，的确百度这个页面是存在的。\n\n```bash\n[root@web108 ~]# curl http://localhost:9090/duty/ -i\nHTTP/1.1 200 OK\nServer: nginx/1.1.0\nDate: Sat, 06 Aug 2011 08:23:23 GMT\nContent-Type: text/html\nConnection: keep-alive\nP3P: CP=” OTI DSP COR IVA OUR IND COM ”\nP3P: CP=” OTI DSP COR IVA OUR IND COM ”\nSet-Cookie: BAIDUID=8FEF0A3A2C31D277DCB4CC5F80B7F457:FG=1; expires=Sun, 05-Aug-12 08:23:23 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1\nSet-Cookie: BAIDUID=8FEF0A3A2C31D277B1F87691AFFD7440:FG=1; expires=Sun, 05-Aug-12 08:23:23 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1\nLast-Modified: Wed, 05 Jan 2011 06:44:53 GMT\nETag: “d66-49913b8efe340″\nAccept-Ranges: bytes\nContent-Length: 3430\nCache-Control: max-age=86400\nExpires: Sun, 07 Aug 2011 08:23:23 GMT\nVary: Accept-Encoding,User-Agent\n\n<!DOCTYPE HTML PUBLIC “-//W3C//DTD HTML 4.01 Transitional//EN”\n“http://www.w3.org/TR/html4/loose.dtd”>\n<html>\n。。。\n</body>\n</html>\n```\n当 `curl http://localhost:9090/duty/ -i` 时， nginx 没找到对应的页面，于是 error_page = @fallback ，把请求代理到 baidu.com 。注意这里的 error_page = @fallback 不是靠重定向实现的，而是所说的“ internally redirected （forward ）”。\n\n### proxy_pass URL 末尾加与不加/（斜线）的区别\n>Proxy_pass末尾带”/”和不带是有区别的：\n不带斜杠转发的是除hostname以外的部分，包括目录。可以使用正则表达式匹配location，且任意正则匹配成功后，转发的都是完整目录路径。\n带斜杠转发的是除hostname及目录外的所有部分。不能使用正则表达式匹配location块，只能使用完整路径名准确匹配。\n\n```\n配置1\nlocation /tobaidu {\n    proxy_pass http://127.0.0.1:8087;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | http://127.0.0.1:8087/tobaidu\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/tobaidu/\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/tobaidu/xxxx\n\n```\n配置2\nlocation /tobaidu {\n    proxy_pass http://127.0.0.1:8087/define;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | http://127.0.0.1:8087/define\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/define/\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/define/xxxx\n\n```\n配置3\nlocation /tobaidu/ {\n    proxy_pass http://127.0.0.1:8087;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | 重定向到http://127.0.0.1/tobaidu/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/tobaidu/\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/tobaidu/xxxx\n\n```\n配置4\nlocation /tobaidu/ {\n    proxy_pass http://127.0.0.1:8087/define;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | 重定向到http://127.0.0.1/tobaidu/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/define\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/define/xxxx\n\n```\n配置5\nlocation /tobaidu {\n    proxy_pass http://127.0.0.1:8087/;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | http://127.0.0.1:8087/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087//\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087//xxxx\n\n```\n配置6\nlocation /tobaidu {\n    proxy_pass http://127.0.0.1:8087/define/;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | http://127.0.0.1:8087/define/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/define//\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/define//xxxx\n\n```\n配置7\nlocation /tobaidu/ {\n    proxy_pass http://127.0.0.1:8087/;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | 重定向到http://127.0.0.1/tobaidu/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/xxxx\n\n```\n配置8\nlocation /tobaidu/ {\n    proxy_pass http://127.0.0.1:8087/define/;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | 重定向到http://127.0.0.1/tobaidu/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/define/\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/define/xxxx\n\n**结论**\n*URL符合 `protocol://ip:port` 同时结尾不加/,则nginx会代理匹配路径部分,否则不代理匹配路径,同时自动添加不匹配路径”部分”,比如/tobaidu/xxxx的/xxxx部分*","source":"_posts/Nginx-location.md","raw":"layout: post\ntitle: 详解nginx之location误区\nauthor: Pyker\ncategories: web\nimg: /images/bar/nginx.jpg\ntags:\n  - nginx\ntop: true\ncover: false\ndate: 2018-01-23 18:47:00\n---\n### location 的匹配顺序是“先匹配正则，再匹配普通”。\n矫正： location 的匹配顺序其实是“先匹配普通，再匹配正则”。我这么说，大家一定会反驳我，因为按“先匹配普通，再匹配正则”解释不了大家平时习惯的按“先匹配正则，再匹配普通”的实践经验。这里我只能暂时解释下，造成这种误解的原因是：正则匹配会覆盖普通匹配（实际的规则，比这复杂，后面会详细解释）。\n###  location 的执行逻辑跟 location 的编辑顺序无关。\n矫正：这句话不全对，“普通 location ”的匹配规则是“最大前缀”，因此“普通 location ”的确与 location 编辑顺序无关；但是“正则 location ”的匹配规则是“顺序匹配，且只要匹配到第一个就停止后面的匹配”；“普通location ”与“正则 location ”之间的匹配顺序是？先匹配普通 location ，再“考虑”匹配正则 location 。注意这里的“考虑”是“可能”的意思，也就是说匹配完“普通 location ”后，有的时候需要继续匹配“正则 location ”，有的时候则不需要继续匹配“正则 location ”。两种情况下，不需要继续匹配正则 location ：（ 1 ）当普通 location 前面指定了“ ^~ ”，特别告诉 Nginx 本条普通 location 一旦匹配上，则不需要继续正则匹配；（ 2 ）当普通location 恰好严格匹配上，不是最大前缀匹配，则不再继续匹配正则。\n\n**总结一句话：  “正则 location 匹配让步普通 location 的严格精确匹配结果；但覆盖普通 location 的最大前缀匹配结果”**\n>匹配优先级为： (location =) > (location 完整路径) > (location ^~ 路径) > (location ~,~* 正则顺序) > (location 部分起始路径) > (/)\n\n**官方文档解释**：<http://wiki.nginx.org/NginxHttpCoreModule#location>\n```\nlocation\nsyntax: `location [=|~|~*|^~|@] /uri/ { … }`\ndefault: no\ncontext: server\n```\n>This directive allows different configurations depending on the URI.\n\n（译者注：1 、different configurations depending on the URI 说的就是语法格式：`location [=|~|~*|^~|@] /uri/ { … }` ，依据不同的前缀`“= ”，“^~ ”，“~ ”，“~* ”`和不带任何前缀的（因为[A] 表示可选，可以不要的），表达不同的含义, 简单的说尽管location 的/uri/ 配置一样，但前缀不一样，表达的是不同的指令含义。2 、查询字符串不在URI范围内。例如：/films.htm?fid=123 的URI 是/films.htm 。）\nIt can be configured using both literal strings and regular expressions. To use regular expressions, you must use a prefix:\n`“~”`for case sensitive matching\n`“~*”`for case insensitive matching\n译文：上文讲到`location /uri/` 可通过使用不同的前缀，表达不同的含义。对这些不同前缀，分下类，就2 大类：正则location ，英文说法是location using regular expressions 和普通location ，英文说法是location using literal strings 。那么其中“~ ”和“~* ”前缀表示正则location ，“~ ”区分大小写，“~* ”不区分大小写；其他前缀（包括：“=”，“^~ ”和“@ ”）和无任何前缀的都属于普通location 。\n\n>To determine which location directive matches a particular query, the literal strings are checked first.\n\n译文：对于一个特定的 HTTP 请求（ a particular query ）， nginx 应该匹配哪个 location 块的指令呢（注意：我们在 nginx.conf 配置文件里面一般会定义多个 location 的）？匹配 规则是：先匹配普通location （再匹配正则表达式）。注意：官方文档这句话就明确说了，先普通location ，而不是有些同学的误区“先匹配正则location ”。\n>Literal strings match the beginning portion of the query – the most specific match will be used.\n\n前面说了“普通location ”与“正则location ”之间的匹配规则是：先匹配普通location ，再匹配正则location 。那么，“普通location ”内部（普通location 与普通location ）是如何匹配的呢？简单的说：最大前缀匹配。原文：1、match the beginning portion of the query （说的是匹配URI 的前缀部分beginning portion ）； 2 、the most specific match will be used （因为location 不是“严格匹配”，而是“前缀匹配”，就会产生一个HTTP 请求，可以“前缀匹配”到多个普通location ，例如：``location /prefix/mid/ {}`` 和`location /prefix/ {}` ，对于HTTP 请求/prefix/mid/t.html ，前缀匹配的话两个location 都满足，选哪个？原则是：the most specific match ，于是选的是`location /prefix/mid/ {}` ）。\n>Afterwards, regular expressions are checked in the order defined in the configuration file. The first regular expression to match the query will stop the search.\n\n这段话说了两层意思，第一层是：“Afterwards, regular expressions are checked ”, 意思是普通location 先匹配，而且选择了最大前缀匹配后，就不能停止后面的匹配，最大前缀匹配只是一个临时的结果，nginx 还需要继续检查正则location （但至于最终是和普通location 的最大前缀匹配，还是正则location 的匹配，截止当前的内容还没讲，但后面会讲）。第二层是“regular expressions are checked in the order defined in the configuration file. The first regular expression to match the query will stop the search. ”，意思是说“正则location ”与“正则location”内部的匹配规则是：按照正则location 在配置文件中的物理顺序（编辑顺序）匹配的（这句话就说明location 并不是一定跟顺序无关，只是普通location 与顺序无关，正则location 还是与顺序有关的），并且只要匹配到一条正则location ，就不再考虑后面的（这与“普通location ”与“正则location ”之间的规则不一样，“普通location ”与“正则location ”之间的规则是：选择出“普通location ”的最大前缀匹配结果后，还需要继续搜索正则location ）。\n>If no regular expression matches are found, the result from the literal string search is used.\n\n这句话回答了“普通location ”的最大前缀匹配结果与继续搜索的“正则location ”匹配结果的决策关系。如果继续搜索的“正则location ”也有匹配上的，那么“正则location ”覆盖 “普通location ”的最大前缀匹配（因为有这个覆盖关系，所以造成有些同学以为正则location 先于普通location 执行的错误理解）；但是如果“正则location ”没有能匹配上，那么就用“普通location ”的最大前缀匹配结果。\nFor case insensitive operating systems, like Mac OS X or Windows with Cygwin, literal string matching is done in a case insensitive way (0.7.7). However, comparison is limited to single-byte locale’s only.\nRegular expression may contain captures (0.7.40), which can then be used in other directives.\n\n>It is possible to disable regular expression checks after literal string matching by using “^~” prefix.If the most specific match literal location has this prefix: regular expressions aren’t checked.\n\n通常的规则是，匹配完了“普通location ”指令，还需要继续匹配“正则location ”，但是你也可以告诉Nginx ：匹配到了“普通location ”后，不再需要继续匹配“正则location ”了，要做到这一点只要在“普通location ”前面加上“^~ ”符号（^ 表示“非”，~ 表示“正则”，字符意思是：不要继续匹配正则）。\n>By using the “=” prefix we define the exact match between request URI and location. When matched search stops immediately. E.g., if the request “/” occurs frequently, using “location = /” will speed up processing of this request a bit as search will stop after first comparison.\n\n除了上文的“^~ ”可以阻止继续搜索正则location 外，你还可以加“= ”。那么如果“^~ ”和“= ”都能阻止继续搜索正则location 的话，那它们之间有什么区别呢？区别很简单，共同点是它们都能阻止继续搜索正则location ，不同点是“^~ ”依然遵守“最大前缀”匹配规则，然而“= ”不是“最大前缀”，而是必须是严格匹配（exact match ）。\n这里顺便讲下`“location / {} ”和“location = / {} ”`的区别，“location / {} ”遵守普通location 的最大前缀匹配，由于任何URI 都必然以“/ ”根开头，所以对于一个URI ，如果有更specific 的匹配，那自然是选这个更specific 的，如果没有，“/ ”一定能为这个URI 垫背（至少能匹配到“/ ”），也就是说“location / {} ”有点默认配置的味道，其他更specific的配置能覆盖overwrite 这个默认配置（这也是为什么我们总能看到location / {} 这个配置的一个很重要的原因）。而“location = / {} ”遵守的是“严格精确匹配exact match ”，也就是只能匹配 http://host:port/ 请求，同时会禁止继续搜索正则location 。因此如果我们只想对“GET / ”请求配置作用指令，那么我们可以选“location = / {} ”这样能减少正则location 的搜索，因此效率比“location / {}” 高（注：前提是我们的目的仅仅只想对“GET / ”起作用）。\n>On exact match with literal location without “=” or “^~” prefixes search is also immediately terminated.\n\n前面我们说了，普通location 匹配完后，还会继续匹配正则location ；但是nginx 允许你阻止这种行为，方法很简单，只需要在普通location 前加“^~ ”或“= ”。但其实还有一种“隐含”的方式来阻止正则location 的搜索，这种隐含的方式就是：当“最大前缀”匹配恰好就是一个“严格精确（exact match ）”匹配，照样会停止后面的搜索。原文字面意思是：只要遇到“精确匹配exact match ”，即使普通location 没有带“= ”或“^~ ”前缀，也一样会终止后面的匹配。\n\n先举例解释下，后面例题会用实践告诉大家。假设当前配置是：location /exact/match/test.html { 配置指令块1}，location /prefix/ { 配置指令块2} 和 location ~ \\.html$ { 配置指令块3} ，如果我们请求 GET /prefix/index.html ，则会被匹配到指令块3 ，因为普通location /prefix/ 依据最大匹配原则能匹配当前请求，但是会被后面的正则location 覆盖；当请求GET /exact/match/test.html ，会匹配到指令块1 ，因为这个是普通location 的exact match ，会禁止继续搜索正则location 。\n\n**To summarize, the order in which directives are checked is as follows:**\n1. Directives with the “=” prefix that match the query exactly. If found, searching stops.\n2. All remaining directives with conventional strings. If this match used the “^~” prefix, searching stops.\n3. Regular expressions, in the order they are defined in the configuration file.\n4. If #3 yielded a match, that result is used. Otherwise, the match from #2 is used.\n\n这个顺序没必要再过多解释了。但我想用自己的话概括下上面的意思“正则 location 匹配让步普通location 的严格精确匹配结果；但覆盖普通 location 的最大前缀匹配结果”。\n>It is important to know that nginx does the comparison against decoded URIs. For example, if you wish to match “/images/ /test”, then you must use “/images/ /test” to determine the location.\n\n在浏览器上显示的URL 一般都会进行URLEncode ，例如“空格”会被编码为  ，但是Nginx 的URL 的匹配都是针对URLDecode 之后的。也就是说，如果你要匹配“/images/ /test ”，你写location 的时候匹配目标应该是：“/images/ /test ”。\n\n**Example:**\n```\nlocation   = / {\n # matches the query / only.\n [ configuration A ]\n}\n\nlocation   / {\n  # matches any query, since all queries begin with /, but regular\n  # expressions and any longer conventional blocks will be\n  # matched first.\n [ configuration B ]\n}\n\nlocation ^~ /images/ {\n    # matches any query beginning with /images/ and halts searching,\n    # so regular expressions will not be checked.\n [ configuration C ]\n}\n\nlocation ~* \\.(gif|jpg|jpeg)$ {\n # matches any request ending in gif, jpg, or jpeg. However, all\n # requests to the /images/ directory will be handled by\n # Configuration C.  \n [ configuration D ]\n}\n```\n上述这4 个location 的配置，没什么好解释的，唯一需要说明的是location / {[configuration B]} ，原文的注释严格来说是错误的，但我相信原文作者是了解规则的，只是文字描述上简化了下，但这个简化容易给读者造成“误解：先检查正则location ，再检查普通location ”。原文：“matches any query, since all queries begin with /, butregular expressions and any longer conventional blocks will be matched first. ”大意是说：“location / {} 能够匹配所有HTTP 请求，因为任何HTTP 请求都必然是以‘/ ’开始的（这半句没有错误）。但是，正则location 和其他任何比‘/ ’更长的普通location （location / {} 是普通location 里面最短的，因此其他任何普通location 都会比它更长，当然location = / {} 和 location ^~ / {} 是一样长的）会优先匹配（matched first ）。” 原文作者说“ but regular expressions will be matched first. ”应该只是想说正则 location 会覆盖这里的 location / {} ，但依然是普通location / {} 先于正则 location 匹配，接着再正则 location 匹配；但其他更长的普通 location （ any longer conventional blocks ）的确会先于 location / {} 匹配。\n\nExample requests:\n\n* / -> configuration A\n* /documents/document.html -> configuration B\n* /images/1.gif -> configuration C\n* /documents/1.jpg -> configuration D\n\n>Note that you could define these 4 configurations in any order and the results would remain the same.\n\n需要提醒下：这里说“in any order ”和“… remain the same ”是因为上面只有一个正则location 。文章前面已经说了正则location 的匹配是跟编辑顺序有关系的。\n>While nested locations are allowed by the configuration file parser, their use is discouraged and may produce unexpected results.\n\n实际上 nginx 的配置文件解析程序是允许 location 嵌套定义的（ location / { location /uri/ {} } ）。但是我们平时却很少看见这样的配置，那是因为 nginx 官方并不建议大家这么做，因为这样会导致很多意想不到的后果。\n>The prefix “@” specifies a named location. Such locations are not used during normal processing of requests, they are intended only to process internally redirected requests (see error_page ,try_files ).\n\n文章开始说了location 的语法中，可以有“= ”，“^~ ”，“~ ”和“~* ”前缀，或者干脆没有任何前缀，还有“@ ”前缀，但是后面的分析我们始终没有谈到“@ ”前缀。文章最后点内容，介绍了“＠”的用途：“@ ”是用来定义“Named Location ”的（你可以理解为独立于“普通location （location using literal strings ）”和“正则location （location using regular expressions ）”之外的第三种类型），这种“Named Location ”不是用来处理普通的HTTP 请求的，它是专门用来处理“内部重定向（internally redirected ）”请求的。注意：这里说的“内部重定向（internally redirected ）”或许说成“forward ”会好点，以为内internally redirected 是不需要跟浏览器交互的，纯粹是服务端的一个转发行为。\n\n### location 实例练习\nNginx 的语法形式是：`location [=|~|~*|^~|@] /uri/ { … } `，意思是可以以“ = ”或“ ~* ”或“ ~ ”或“ ^~ ”或“ @ ”符号为前缀，当然也可以没有前缀（因为 [A] 是表示可选的 A ； A|B 表示 A 和 B 选一个），紧接着是 /uri/ ，再接着是{…} 指令块，整个意思是对于满足这样条件的 /uri/ 适用指令块 {…} 的指令。\n\n上述各种 location 可分两大类，分别是：“普通 location ”，官方英文说法是 location using   literal strings 和“正则 location ”，英文说法是 location using regular expressions 。其中“普通 location ”是以“ = ”或“ ^~ ”为前缀或者没有任何前缀的 /uri/ ；“正则 location ”是以“ ~ ”或“ ~* ”为前缀的 /uri/ 。\n那么，当我们在一个 server 上下文编写了多个 location 的时候， Nginx 对于一个 HTTP 请求，是如何匹配到一个 location 做处理呢？用一句话简单概括 Nginx 的 location 匹配规则是：“正则 location ”让步 “普通 location”的严格精确匹配结果；但覆盖 “普通 location ”的最大前缀匹配结果。理解这句话，我想通过下面的实例来说明。\n\n* **先普通 location ，再正则 location**\n周边不少童鞋告诉我， nginx 是“先匹配正则 location 再匹配普通 location ”，其实这是一个误区， nginx 其实是“先匹配普通 location ，再匹配正则 location ”，但是普通 location 的匹配结果又分两种：一种是“严格精确匹配”，官方英文说法是“ exact match ”；另一种是“最大前缀匹配”，官方英文说法是“ Literal strings match the beginning portion of the query – the most specific match will be used. ”。我们做个实验：\n\n例题 1 ：假设 nginx 的配置如下\n```\nserver {\n       listen       9090;\n       server_name  localhost;\n       location / {\n           root   html;\n           index  index.html index.htm;\n           deny all;\n       }\n       location ~ \\.html$ {\n           allow all;\n       }\n}\n```\n附录 nginx 的目录结构是： nginx->html->index.html\n上述配置的意思是： location / {… deny all;} 普通 location 以“ / ”开始的 URI 请求（注意任何 HTTP 请求都必然以“/ ”开始，所以“ / ”的意思是所有的请求都能被匹配上），都拒绝访问； location ~\\.html$ {allow all;} 正则 location以 .html 结尾的 URI 请求，都允许访问。\n\n测试结果：\n```bash\n[root@web108 ~]# curl http://localhost:9090/\n<html>\n<head><title>403 Forbidden</title></head>\n<body bgcolor=”white”>\n<center><h1>403 Forbidden</h1></center>\n<hr><center>nginx/1.1.0</center>\n</body>\n</html>\n\n[root@web108 ~]# curl http://localhost:9090/index.html\n<html>\n<head>\n<title>Welcome to nginx!</title>\n</head>\n<body bgcolor=”white” text=”black”>\n<center><h1>Welcome to nginx!</h1></center>\n</body>\n</html>\n\n[root@web108 ~]# curl http://localhost:9090/index_notfound.html\n<html>\n<head><title>404 Not Found</title></head>\n<body bgcolor=”white”>\n<center><h1>404 Not Found</h1></center>\n<hr><center>nginx/1.1.0</center>\n</body>\n</html>\n```\n测试结果如下：\n\nURI请求 | HTTP响应\n:--- | :---:\ncurl http://localhost:9090/ | 403 Forbidden\ncurl http://localhost:9090/index.html|Welcome to nginx!\ncurl http://localhost:9090/index_notfound.html|404 Not Found\n\n`curl http://localhost:9090/` 的结果是“ 403 Forbidden ”，说明被匹配到“ location / {..deny all;} ”了，原因很简单HTTP 请求 GET / 被“严格精确”匹配到了普通 location / {} ，则会停止搜索正则 location ；\n\n`curl http://localhost:9090/index.html` 结果是“ Welcome to nginx! ”，说明没有被“ location / {…deny all;} ”匹配，否则会 403 Forbidden ，但 /index.html 的确也是以“ / ”开头的，只不过此时的普通 location / 的匹配结果是“最大前缀”匹配，所以 Nginx 会继续搜索正则 location ， location ~ \\.html$ 表达了以 .html 结尾的都 allow all; 于是接着就访问到了实际存在的 index.html 页面。\n\n`curl http://localhost:9090/index_notfound.html`   同样的道理先匹配 location / {} ，但属于“普通 location 的最大前缀匹配”，于是后面被“正则 location ” location ~ \\.html$ {} 覆盖了，最终 allow all ； 但的确目录下不存在index_notfound.html 页面，于是 404 Not Found 。\n\n如果此时我们访问 http://localhost:9090/index.txt 会是什么结果呢？显然是 deny all ；因为先匹配上了 location / {..deny all;} 尽管属于“普通 location ”的最大前缀匹配结果，继续搜索正则 location ，但是 /index.txt 不是以 .html结尾的，正则 location 失败，最终采纳普通 location 的最大前缀匹配结果，于是 deny all 了。\n```bash\n[root@web108 ~]# curl http://localhost:9090/index.txt\n<html>\n<head><title>403 Forbidden</title></head>\n<body bgcolor=”white”>\n<center><h1>403 Forbidden</h1></center>\n<hr><center>nginx/1.1.0</center>\n</body>\n</html>\n```\n* **普通 location 的“隐式”严格匹配**\n\n例题 2 ：我们在例题 1 的基础上增加精确配置\n\n```\nserver {\n       listen       9090;\n       server_name  localhost;\n       location /exact/match.html {\n           allow all;\n       }\n       location / {\n           root   html;\n           index  index.html index.htm;\n           deny all;\n       }\n       location ~ \\.html$ {\n           allow all;\n       }\n}\n```\n测试请求：\n```bash\n[root@web108 ~]# curl http://localhost:9090/exact/match.html\n<html>\n<head><title>404 Not Found</title></head>\n<body bgcolor=”white”>\n<center><h1>404 Not Found</h1></center>\n<hr><center>nginx/1.1.0</center>\n</body>\n</html>\n```\n\n结果进一步验证了“普通 location ”的“严格精确”匹配会终止对正则 location 的搜索。这里我们小结下“普通 location”与“正则 location ”的匹配规则：先匹配普通 location ，再匹配正则 location ，但是如果普通 location 的匹配结果恰好是“严格精确（ exact match ）”的，则 nginx 不再尝试后面的正则 location ；如果普通 location 的匹配结果是“最大前缀”，则正则 location 的匹配覆盖普通 location 的匹配。也就是前面说的“正则 location 让步普通location 的严格精确匹配结果，但覆盖普通 location 的最大前缀匹配结果”。\n\n* **普通 location 的“显式”严格匹配和“ ^~ ” 前缀**\n\n上面我们演示的普通 location 都是不加任何前缀的，其实普通 location 也可以加前缀：“ ^~ ”和“ = ”。其中“ ^~”的意思是“非正则，不需要继续正则匹配”，也就是通常我们的普通 location ，还会继续搜索正则 location （恰好严格精确匹配除外），但是 nginx 很人性化允许配置人员告诉 nginx 某条普通 location ，无论最大前缀匹配，还是严格精确匹配都终止继续搜索正则 location ；而“ = ”则表达的是普通 location 不允许“最大前缀”匹配结果，必须严格等于，严格精确匹配。\n\n例题 3 ：“ ^~ ”前缀的使用\n```bash\nserver {\n       listen       9090;\n       server_name  localhost;\n       location /exact/match.html {\n           allow all;\n       }\n       location ^~ / {\n           root   html;\n           index  index.html index.htm;\n           deny all;\n       }\n       location ~ \\.html$ {\n           allow all;\n       }\n}\n```\n把例题 2 中的 location / {} 修改成 location ^~ / {} ，再看看测试结果：\n\nURL请求 | 修改前 | 修改后\n---- | :----: | :----:\ncurl http://localhost:9090/ | 403 Forbidden | 403 Forbidden\ncurl http://localhost:9090/index.html | Welcome to nginx! | 403 Forbidden\ncurl http://localhost:9090/index_notfound.html | 404 Not Found | 403 Forbidden\ncurl http://localhost:9090/exact/match.html | 404 Not Found | 404 Not Found\n\n除了 GET /exact/match.html 是 404 Not Found ，其余都是 403 Forbidden ，原因很简单所有请求都是以“ / ”开头，所以所有请求都能匹配上“ / ”普通 location ，但普通 location 的匹配原则是“最大前缀”，所以只有/exact/match.html 匹配到 location /exact/match.html {allow all;} ，其余都 location ^~ / {deny all;} 并终止正则搜索。\n\n例题 4 ：“ = ”前缀的使用\n```bash\nserver {\n       listen       9090;\n       server_name  localhost;\n       location /exact/match.html {\n           allow all;\n       }\n       location = / {\n           root   html;\n           index  index.html index.htm;\n           deny all;\n       }\n       location ~ \\.html$ {\n           allow all;\n       }\n}\n```\n例题 4 相对例题 2 把 location / {} 修改成了 location = / {} ，再次测试结果：\n\nURL请求 | 修改前 | 修改后\n---- | :----: | :----:\ncurl http://localhost:9090/ | 403 Forbidden | 403 Forbidden\ncurl http://localhost:9090/index.html | Welcome to nginx! | Welcome to nginx!\ncurl http://localhost:9090/index_notfound.html | 404 Not Found | 404 Not Found\ncurl http://localhost:9090/exact/match.html | 404 Not Found | 404 Not Found\ncurl http://localhost:9090/test.jsp | 403 Forbidden | 404 Not Found\n\n最能说明问题的测试是 GET /test.jsp ，实际上 /test.jsp 没有匹配正则 location （ location ~\\.html$ ），也没有匹配 location = / {} ，如果按照 location / {} 的话，会“最大前缀”匹配到普通 location / {} ，结果是 deny all 。\n\n* **正则 location 与编辑顺序**\nlocation 的指令与编辑顺序无关，这句话不全对。对于普通 location 指令，匹配规则是：最大前缀匹配（与顺序无关），如果恰好是严格精确匹配结果或者加有前缀“ ^~ ”或“ = ”（符号“ = ”只能严格匹配，不能前缀匹配），则停止搜索正则 location ；但对于正则 location 的匹配规则是：按编辑顺序逐个匹配（与顺序有关），只要匹配上，就立即停止后面的搜索。\n\n```bash\n配置 3.1\n\nserver {\n       listen       9090;\n       server_name  localhost;\n       location ~ \\.html$ {\n           allow all; \n       }  \n       location ~ ^/prefix/.*\\.html$ {\n           deny all;  \n       }  \n}\n配置 3.2\n\nserver {\n       listen       9090;\n       server_name  localhost;     \n       location ~ ^/prefix/.*\\.html$ {\n           deny all;  \n       }            \n       location ~ \\.html$ {\n           allow all; \n       } \n}\n```\n测试结果：\n\nURL请求 | 配置3.1 | 配置3.2\n---- | :----: | :----:\ncurl http://localhost:9090/regextest.html | 404 Not Found | 404 Not Found\ncurl http://localhost:9090/prefix/regextest.html | 404 Not Found | 403 Forbidden\n\n解释：\n`Location ~ ^/prefix/.*\\.html$ {deny all;}` 表示正则 location 对于以 /prefix/ 开头， .html 结尾的所有 URI 请求，都拒绝访问；   `location ~\\.html${allow all;}` 表示正则 location 对于以 .html 结尾的 URI 请求，都允许访问。 实际上，prefix 的是 ~\\.html$ 的子集。\n\n在“配置 3.1 ”下，两个请求都匹配上 `location ~\\.html$ {allow all;}` ，并且停止后面的搜索，于是都允许访问， 404 Not Found ；在“配置 3.2 ”下， /regextest.html 无法匹配 prefix ，于是继续搜索 ~\\.html$ ，允许访问，于是 404 Not Found ；然而 /prefix/regextest.html 匹配到 prefix ，于是 deny all ， 403 Forbidden 。\n```\n配置 3.3\n\nserver {\n       listen       9090;\n       server_name  localhost; \n       location  /prefix/ {\n               deny all;  \n       }           \n       location  /prefix/mid/ {\n               allow all; \n       }  \n}\n配置 3.4\n\nserver {\n       listen       9090;\n       server_name  localhost;    \n       location  /prefix/mid/ {\n               allow all; \n       }  \n        location  /prefix/ {\n               deny all;  \n       }  \n}\n```\n测试结果：\n\nURL请求 | 配置3.3 | 配置3.4\n---- | :----: | :----:\ncurl http://localhost:9090/prefix/t.html | 403 Forbidden | 403 Forbidden\ncurl http://localhost:9090/prefix/mid/t.html | 404 Not Found | 404 Not Found\n\n测试结果表明：普通 location 的匹配规则是“最大前缀”匹配，而且与编辑顺序无关。\n\n* **“@” 前缀 Named Location 使用**\nREFER:  <http://wiki.nginx.org/HttpCoreModule#error_page>\n假设配置如下：\n```bash\nserver {\n       listen       9090;\n       server_name  localhost;\n       location  / {\n           root   html;\n           index  index.html index.htm;\n           allow all;\n       }\n       #error_page 404 http://www.baidu.com # 直接这样是不允许的\n       error_page 404 = @fallback;\n\t   \n       location @fallback {\n           proxy_pass http://www.baidu.com;\n       }\n}\n```\n上述配置文件的意思是：如果请求的 URI 存在，则本 nginx 返回对应的页面；如果不存在，则把请求代理到baidu.com 上去做个弥补（注： nginx 当发现 URI 对应的页面不存在， HTTP_StatusCode 会是 404 ，此时error_page 404 指令能捕获它）。\n\n测试一：\n\n```bash\n[root@web108 ~]# curl http://localhost:9090/nofound.html -i\nHTTP/1.1 302 Found\nServer: nginx/1.1.0\nDate: Sat, 06 Aug 2011 08:17:21 GMT\nContent-Type: text/html; charset=iso-8859-1\nLocation: http://localhost:9090/search/error.html\nConnection: keep-alive\nCache-Control: max-age=86400\nExpires: Sun, 07 Aug 2011 08:17:21 GMT\nContent-Length: 222\n\n<!DOCTYPE HTML PUBLIC “-//IETF//DTD HTML 2.0//EN”>\n<html><head>\n<title>302 Found</title>\n</head><body>\n<h1>Found</h1>\n<p>The document has moved <a href=”http://www.baidu.com/search/error.html”>here</a>.</p>\n</body></html>\n```\n当我们 GET /nofound.html 发送给本 nginx ， nginx 找不到对应的页面，于是 error_page 404 = @fallback ，请求被代理到 http://www.baidu.com ，于是 nginx 给 http://www.baidu.com 发送了 GET /nofound.html ，但/nofound.html 页面在百度也不存在，百度 302 跳转到错误页。\n直接访问 http://www.baidu.com/nofound.html 结果：\n\n```bash\n[root@web108 ~]# curl http://www.baidu.com/nofound.html -i\nHTTP/1.1 302 Found\nDate: Sat, 06 Aug 2011 08:20:05 GMT\nServer: Apache\nLocation: http://www.baidu.com/search/error.html\nCache-Control: max-age=86400\nExpires: Sun, 07 Aug 2011 08:20:05 GMT\nContent-Length: 222\nConnection: Keep-Alive\nContent-Type: text/html; charset=iso-8859-1\n \n<!DOCTYPE HTML PUBLIC “-//IETF//DTD HTML 2.0//EN”>\n<html><head>\n<title>302 Found</title>\n</head><body>\n<h1>Found</h1>\n<p>The document has moved <a href=”http://www.baidu.com/search/error.html”>here</a>.</p>\n</body></html>\n```\n测试二：访问一个 nginx 不存在，但 baidu 存在的页面\n```bash\n[root@web108 ~]# curl http://www.baidu.com/duty/ -i\nHTTP/1.1 200 OK\nDate: Sat, 06 Aug 2011 08:21:56 GMT\nServer: Apache\nP3P: CP=” OTI DSP COR IVA OUR IND COM ”\nP3P: CP=” OTI DSP COR IVA OUR IND COM ”\nSet-Cookie: BAIDUID=5C5D2B2FD083737A0C88CA7075A6601A:FG=1; expires=Sun, 05-Aug-12 08:21:56 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1\nSet-Cookie: BAIDUID=5C5D2B2FD083737A2337F78F909CCB90:FG=1; expires=Sun, 05-Aug-12 08:21:56 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1\nLast-Modified: Wed, 05 Jan 2011 06:44:53 GMT\nETag: “d66-49913b8efe340″\nAccept-Ranges: bytes\nContent-Length: 3430\nCache-Control: max-age=86400\nExpires: Sun, 07 Aug 2011 08:21:56 GMT\nVary: Accept-Encoding,User-Agent\nConnection: Keep-Alive\nContent-Type: text/html\n\n<!DOCTYPE HTML PUBLIC “-//W3C//DTD HTML 4.01 Transitional//EN”\n“http://www.w3.org/TR/html4/loose.dtd”>\n。。。。\n</body>\n</html>\n```\n显示，的确百度这个页面是存在的。\n\n```bash\n[root@web108 ~]# curl http://localhost:9090/duty/ -i\nHTTP/1.1 200 OK\nServer: nginx/1.1.0\nDate: Sat, 06 Aug 2011 08:23:23 GMT\nContent-Type: text/html\nConnection: keep-alive\nP3P: CP=” OTI DSP COR IVA OUR IND COM ”\nP3P: CP=” OTI DSP COR IVA OUR IND COM ”\nSet-Cookie: BAIDUID=8FEF0A3A2C31D277DCB4CC5F80B7F457:FG=1; expires=Sun, 05-Aug-12 08:23:23 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1\nSet-Cookie: BAIDUID=8FEF0A3A2C31D277B1F87691AFFD7440:FG=1; expires=Sun, 05-Aug-12 08:23:23 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1\nLast-Modified: Wed, 05 Jan 2011 06:44:53 GMT\nETag: “d66-49913b8efe340″\nAccept-Ranges: bytes\nContent-Length: 3430\nCache-Control: max-age=86400\nExpires: Sun, 07 Aug 2011 08:23:23 GMT\nVary: Accept-Encoding,User-Agent\n\n<!DOCTYPE HTML PUBLIC “-//W3C//DTD HTML 4.01 Transitional//EN”\n“http://www.w3.org/TR/html4/loose.dtd”>\n<html>\n。。。\n</body>\n</html>\n```\n当 `curl http://localhost:9090/duty/ -i` 时， nginx 没找到对应的页面，于是 error_page = @fallback ，把请求代理到 baidu.com 。注意这里的 error_page = @fallback 不是靠重定向实现的，而是所说的“ internally redirected （forward ）”。\n\n### proxy_pass URL 末尾加与不加/（斜线）的区别\n>Proxy_pass末尾带”/”和不带是有区别的：\n不带斜杠转发的是除hostname以外的部分，包括目录。可以使用正则表达式匹配location，且任意正则匹配成功后，转发的都是完整目录路径。\n带斜杠转发的是除hostname及目录外的所有部分。不能使用正则表达式匹配location块，只能使用完整路径名准确匹配。\n\n```\n配置1\nlocation /tobaidu {\n    proxy_pass http://127.0.0.1:8087;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | http://127.0.0.1:8087/tobaidu\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/tobaidu/\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/tobaidu/xxxx\n\n```\n配置2\nlocation /tobaidu {\n    proxy_pass http://127.0.0.1:8087/define;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | http://127.0.0.1:8087/define\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/define/\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/define/xxxx\n\n```\n配置3\nlocation /tobaidu/ {\n    proxy_pass http://127.0.0.1:8087;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | 重定向到http://127.0.0.1/tobaidu/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/tobaidu/\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/tobaidu/xxxx\n\n```\n配置4\nlocation /tobaidu/ {\n    proxy_pass http://127.0.0.1:8087/define;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | 重定向到http://127.0.0.1/tobaidu/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/define\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/define/xxxx\n\n```\n配置5\nlocation /tobaidu {\n    proxy_pass http://127.0.0.1:8087/;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | http://127.0.0.1:8087/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087//\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087//xxxx\n\n```\n配置6\nlocation /tobaidu {\n    proxy_pass http://127.0.0.1:8087/define/;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | http://127.0.0.1:8087/define/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/define//\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/define//xxxx\n\n```\n配置7\nlocation /tobaidu/ {\n    proxy_pass http://127.0.0.1:8087/;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | 重定向到http://127.0.0.1/tobaidu/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/xxxx\n\n```\n配置8\nlocation /tobaidu/ {\n    proxy_pass http://127.0.0.1:8087/define/;\n}\n```\n测试结果：\n\n请求URL | 请求结果\n---- | ----\ncurl http://127.0.0.1/tobaidu | 重定向到http://127.0.0.1/tobaidu/\ncurl http://127.0.0.1/tobaidu/ | http://127.0.0.1:8087/define/\ncurl http://127.0.0.1/tobaidu/xxxx | http://127.0.0.1:8087/define/xxxx\n\n**结论**\n*URL符合 `protocol://ip:port` 同时结尾不加/,则nginx会代理匹配路径部分,否则不代理匹配路径,同时自动添加不匹配路径”部分”,比如/tobaidu/xxxx的/xxxx部分*","slug":"Nginx-location","published":1,"updated":"2019-05-28T02:02:23.500Z","_id":"cjw6jlf52003ip4n79gf889i9","comments":1,"photos":[],"link":"","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><h3 id=\"location-的匹配顺序是“先匹配正则，再匹配普通”。\"><a href=\"#location-的匹配顺序是“先匹配正则，再匹配普通”。\" class=\"headerlink\" title=\"location 的匹配顺序是“先匹配正则，再匹配普通”。\"></a>location 的匹配顺序是“先匹配正则，再匹配普通”。</h3><p>矫正： location 的匹配顺序其实是“先匹配普通，再匹配正则”。我这么说，大家一定会反驳我，因为按“先匹配普通，再匹配正则”解释不了大家平时习惯的按“先匹配正则，再匹配普通”的实践经验。这里我只能暂时解释下，造成这种误解的原因是：正则匹配会覆盖普通匹配（实际的规则，比这复杂，后面会详细解释）。</p>\n<h3 id=\"location-的执行逻辑跟-location-的编辑顺序无关。\"><a href=\"#location-的执行逻辑跟-location-的编辑顺序无关。\" class=\"headerlink\" title=\"location 的执行逻辑跟 location 的编辑顺序无关。\"></a>location 的执行逻辑跟 location 的编辑顺序无关。</h3><p>矫正：这句话不全对，“普通 location ”的匹配规则是“最大前缀”，因此“普通 location ”的确与 location 编辑顺序无关；但是“正则 location ”的匹配规则是“顺序匹配，且只要匹配到第一个就停止后面的匹配”；“普通location ”与“正则 location ”之间的匹配顺序是？先匹配普通 location ，再“考虑”匹配正则 location 。注意这里的“考虑”是“可能”的意思，也就是说匹配完“普通 location ”后，有的时候需要继续匹配“正则 location ”，有的时候则不需要继续匹配“正则 location ”。两种情况下，不需要继续匹配正则 location ：（ 1 ）当普通 location 前面指定了“ ^~ ”，特别告诉 Nginx 本条普通 location 一旦匹配上，则不需要继续正则匹配；（ 2 ）当普通location 恰好严格匹配上，不是最大前缀匹配，则不再继续匹配正则。</p>\n<p><strong>总结一句话：  “正则 location 匹配让步普通 location 的严格精确匹配结果；但覆盖普通 location 的最大前缀匹配结果”</strong></p>\n<blockquote>\n<p>匹配优先级为： (location =) &gt; (location 完整路径) &gt; (location ^~ 路径) &gt; (location ~,~* 正则顺序) &gt; (location 部分起始路径) &gt; (/)</p>\n</blockquote>\n<p><strong>官方文档解释</strong>：<a href=\"http://wiki.nginx.org/NginxHttpCoreModule#location\" target=\"_blank\" rel=\"noopener\">http://wiki.nginx.org/NginxHttpCoreModule#location</a><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location</span><br><span class=\"line\">syntax: `<span class=\"keyword\">location</span> <span class=\"title\">[=|~|~*|^~|@] /uri</span>/ &#123; … &#125;`</span><br><span class=\"line\">default: no</span><br><span class=\"line\">context: server</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>This directive allows different configurations depending on the URI.</p>\n</blockquote>\n<p>（译者注：1 、different configurations depending on the URI 说的就是语法格式：<code>location [=|~|~*|^~|@] /uri/ { … }</code> ，依据不同的前缀<code>“= ”，“^~ ”，“~ ”，“~* ”</code>和不带任何前缀的（因为[A] 表示可选，可以不要的），表达不同的含义, 简单的说尽管location 的/uri/ 配置一样，但前缀不一样，表达的是不同的指令含义。2 、查询字符串不在URI范围内。例如：/films.htm?fid=123 的URI 是/films.htm 。）<br>It can be configured using both literal strings and regular expressions. To use regular expressions, you must use a prefix:<br><code>“~”</code>for case sensitive matching<br><code>“~*”</code>for case insensitive matching<br>译文：上文讲到<code>location /uri/</code> 可通过使用不同的前缀，表达不同的含义。对这些不同前缀，分下类，就2 大类：正则location ，英文说法是location using regular expressions 和普通location ，英文说法是location using literal strings 。那么其中“~ ”和“~<em> ”前缀表示正则location ，“~ ”区分大小写，“~</em> ”不区分大小写；其他前缀（包括：“=”，“^~ ”和“@ ”）和无任何前缀的都属于普通location 。</p>\n<blockquote>\n<p>To determine which location directive matches a particular query, the literal strings are checked first.</p>\n</blockquote>\n<p>译文：对于一个特定的 HTTP 请求（ a particular query ）， nginx 应该匹配哪个 location 块的指令呢（注意：我们在 nginx.conf 配置文件里面一般会定义多个 location 的）？匹配 规则是：先匹配普通location （再匹配正则表达式）。注意：官方文档这句话就明确说了，先普通location ，而不是有些同学的误区“先匹配正则location ”。</p>\n<blockquote>\n<p>Literal strings match the beginning portion of the query – the most specific match will be used.</p>\n</blockquote>\n<p>前面说了“普通location ”与“正则location ”之间的匹配规则是：先匹配普通location ，再匹配正则location 。那么，“普通location ”内部（普通location 与普通location ）是如何匹配的呢？简单的说：最大前缀匹配。原文：1、match the beginning portion of the query （说的是匹配URI 的前缀部分beginning portion ）； 2 、the most specific match will be used （因为location 不是“严格匹配”，而是“前缀匹配”，就会产生一个HTTP 请求，可以“前缀匹配”到多个普通location ，例如：<code>location /prefix/mid/ {}</code> 和<code>location /prefix/ {}</code> ，对于HTTP 请求/prefix/mid/t.html ，前缀匹配的话两个location 都满足，选哪个？原则是：the most specific match ，于是选的是<code>location /prefix/mid/ {}</code> ）。</p>\n<blockquote>\n<p>Afterwards, regular expressions are checked in the order defined in the configuration file. The first regular expression to match the query will stop the search.</p>\n</blockquote>\n<p>这段话说了两层意思，第一层是：“Afterwards, regular expressions are checked ”, 意思是普通location 先匹配，而且选择了最大前缀匹配后，就不能停止后面的匹配，最大前缀匹配只是一个临时的结果，nginx 还需要继续检查正则location （但至于最终是和普通location 的最大前缀匹配，还是正则location 的匹配，截止当前的内容还没讲，但后面会讲）。第二层是“regular expressions are checked in the order defined in the configuration file. The first regular expression to match the query will stop the search. ”，意思是说“正则location ”与“正则location”内部的匹配规则是：按照正则location 在配置文件中的物理顺序（编辑顺序）匹配的（这句话就说明location 并不是一定跟顺序无关，只是普通location 与顺序无关，正则location 还是与顺序有关的），并且只要匹配到一条正则location ，就不再考虑后面的（这与“普通location ”与“正则location ”之间的规则不一样，“普通location ”与“正则location ”之间的规则是：选择出“普通location ”的最大前缀匹配结果后，还需要继续搜索正则location ）。</p>\n<blockquote>\n<p>If no regular expression matches are found, the result from the literal string search is used.</p>\n</blockquote>\n<p>这句话回答了“普通location ”的最大前缀匹配结果与继续搜索的“正则location ”匹配结果的决策关系。如果继续搜索的“正则location ”也有匹配上的，那么“正则location ”覆盖 “普通location ”的最大前缀匹配（因为有这个覆盖关系，所以造成有些同学以为正则location 先于普通location 执行的错误理解）；但是如果“正则location ”没有能匹配上，那么就用“普通location ”的最大前缀匹配结果。<br>For case insensitive operating systems, like Mac OS X or Windows with Cygwin, literal string matching is done in a case insensitive way (0.7.7). However, comparison is limited to single-byte locale’s only.<br>Regular expression may contain captures (0.7.40), which can then be used in other directives.</p>\n<blockquote>\n<p>It is possible to disable regular expression checks after literal string matching by using “^~” prefix.If the most specific match literal location has this prefix: regular expressions aren’t checked.</p>\n</blockquote>\n<p>通常的规则是，匹配完了“普通location ”指令，还需要继续匹配“正则location ”，但是你也可以告诉Nginx ：匹配到了“普通location ”后，不再需要继续匹配“正则location ”了，要做到这一点只要在“普通location ”前面加上“^~ ”符号（^ 表示“非”，~ 表示“正则”，字符意思是：不要继续匹配正则）。</p>\n<blockquote>\n<p>By using the “=” prefix we define the exact match between request URI and location. When matched search stops immediately. E.g., if the request “/” occurs frequently, using “location = /” will speed up processing of this request a bit as search will stop after first comparison.</p>\n</blockquote>\n<p>除了上文的“^~ ”可以阻止继续搜索正则location 外，你还可以加“= ”。那么如果“^~ ”和“= ”都能阻止继续搜索正则location 的话，那它们之间有什么区别呢？区别很简单，共同点是它们都能阻止继续搜索正则location ，不同点是“^~ ”依然遵守“最大前缀”匹配规则，然而“= ”不是“最大前缀”，而是必须是严格匹配（exact match ）。<br>这里顺便讲下<code>“location / {} ”和“location = / {} ”</code>的区别，“location / {} ”遵守普通location 的最大前缀匹配，由于任何URI 都必然以“/ ”根开头，所以对于一个URI ，如果有更specific 的匹配，那自然是选这个更specific 的，如果没有，“/ ”一定能为这个URI 垫背（至少能匹配到“/ ”），也就是说“location / {} ”有点默认配置的味道，其他更specific的配置能覆盖overwrite 这个默认配置（这也是为什么我们总能看到location / {} 这个配置的一个很重要的原因）。而“location = / {} ”遵守的是“严格精确匹配exact match ”，也就是只能匹配 <a href=\"http://host:port/\" target=\"_blank\" rel=\"noopener\">http://host:port/</a> 请求，同时会禁止继续搜索正则location 。因此如果我们只想对“GET / ”请求配置作用指令，那么我们可以选“location = / {} ”这样能减少正则location 的搜索，因此效率比“location / {}” 高（注：前提是我们的目的仅仅只想对“GET / ”起作用）。</p>\n<blockquote>\n<p>On exact match with literal location without “=” or “^~” prefixes search is also immediately terminated.</p>\n</blockquote>\n<p>前面我们说了，普通location 匹配完后，还会继续匹配正则location ；但是nginx 允许你阻止这种行为，方法很简单，只需要在普通location 前加“^~ ”或“= ”。但其实还有一种“隐含”的方式来阻止正则location 的搜索，这种隐含的方式就是：当“最大前缀”匹配恰好就是一个“严格精确（exact match ）”匹配，照样会停止后面的搜索。原文字面意思是：只要遇到“精确匹配exact match ”，即使普通location 没有带“= ”或“^~ ”前缀，也一样会终止后面的匹配。</p>\n<p>先举例解释下，后面例题会用实践告诉大家。假设当前配置是：location /exact/match/test.html { 配置指令块1}，location /prefix/ { 配置指令块2} 和 location ~ .html$ { 配置指令块3} ，如果我们请求 GET /prefix/index.html ，则会被匹配到指令块3 ，因为普通location /prefix/ 依据最大匹配原则能匹配当前请求，但是会被后面的正则location 覆盖；当请求GET /exact/match/test.html ，会匹配到指令块1 ，因为这个是普通location 的exact match ，会禁止继续搜索正则location 。</p>\n<p><strong>To summarize, the order in which directives are checked is as follows:</strong></p>\n<ol>\n<li>Directives with the “=” prefix that match the query exactly. If found, searching stops.</li>\n<li>All remaining directives with conventional strings. If this match used the “^~” prefix, searching stops.</li>\n<li>Regular expressions, in the order they are defined in the configuration file.</li>\n<li>If #3 yielded a match, that result is used. Otherwise, the match from #2 is used.</li>\n</ol>\n<p>这个顺序没必要再过多解释了。但我想用自己的话概括下上面的意思“正则 location 匹配让步普通location 的严格精确匹配结果；但覆盖普通 location 的最大前缀匹配结果”。</p>\n<blockquote>\n<p>It is important to know that nginx does the comparison against decoded URIs. For example, if you wish to match “/images/ /test”, then you must use “/images/ /test” to determine the location.</p>\n</blockquote>\n<p>在浏览器上显示的URL 一般都会进行URLEncode ，例如“空格”会被编码为  ，但是Nginx 的URL 的匹配都是针对URLDecode 之后的。也就是说，如果你要匹配“/images/ /test ”，你写location 的时候匹配目标应该是：“/images/ /test ”。</p>\n<p><strong>Example:</strong><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">location</span>   <span class=\"title\">= / &#123;</span></span><br><span class=\"line\"><span class=\"title\"> # matches</span> the query / only.</span><br><span class=\"line\"> [ configuration A ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">location</span>   <span class=\"title\">/ &#123;</span></span><br><span class=\"line\"><span class=\"title\">  # matches</span> any query, since all queries begin with /, but regular</span><br><span class=\"line\">  <span class=\"comment\"># expressions and any longer conventional blocks will be</span></span><br><span class=\"line\">  <span class=\"comment\"># matched first.</span></span><br><span class=\"line\"> [ configuration B ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">^~ /images</span>/ &#123;</span><br><span class=\"line\">    <span class=\"comment\"># matches any query beginning with /images/ and halts searching,</span></span><br><span class=\"line\">    <span class=\"comment\"># so regular expressions will not be checked.</span></span><br><span class=\"line\"> [ configuration C ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">~* \\.(gif</span>|jpg|jpeg)$ &#123;</span><br><span class=\"line\"> <span class=\"comment\"># matches any request ending in gif, jpg, or jpeg. However, all</span></span><br><span class=\"line\"> <span class=\"comment\"># requests to the /images/ directory will be handled by</span></span><br><span class=\"line\"> <span class=\"comment\"># Configuration C.  </span></span><br><span class=\"line\"> [ configuration D ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>上述这4 个location 的配置，没什么好解释的，唯一需要说明的是location / {[configuration B]} ，原文的注释严格来说是错误的，但我相信原文作者是了解规则的，只是文字描述上简化了下，但这个简化容易给读者造成“误解：先检查正则location ，再检查普通location ”。原文：“matches any query, since all queries begin with /, butregular expressions and any longer conventional blocks will be matched first. ”大意是说：“location / {} 能够匹配所有HTTP 请求，因为任何HTTP 请求都必然是以‘/ ’开始的（这半句没有错误）。但是，正则location 和其他任何比‘/ ’更长的普通location （location / {} 是普通location 里面最短的，因此其他任何普通location 都会比它更长，当然location = / {} 和 location ^~ / {} 是一样长的）会优先匹配（matched first ）。” 原文作者说“ but regular expressions will be matched first. ”应该只是想说正则 location 会覆盖这里的 location / {} ，但依然是普通location / {} 先于正则 location 匹配，接着再正则 location 匹配；但其他更长的普通 location （ any longer conventional blocks ）的确会先于 location / {} 匹配。</p>\n<p>Example requests:</p>\n<ul>\n<li>/ -&gt; configuration A</li>\n<li>/documents/document.html -&gt; configuration B</li>\n<li>/images/1.gif -&gt; configuration C</li>\n<li>/documents/1.jpg -&gt; configuration D</li>\n</ul>\n<blockquote>\n<p>Note that you could define these 4 configurations in any order and the results would remain the same.</p>\n</blockquote>\n<p>需要提醒下：这里说“in any order ”和“… remain the same ”是因为上面只有一个正则location 。文章前面已经说了正则location 的匹配是跟编辑顺序有关系的。</p>\n<blockquote>\n<p>While nested locations are allowed by the configuration file parser, their use is discouraged and may produce unexpected results.</p>\n</blockquote>\n<p>实际上 nginx 的配置文件解析程序是允许 location 嵌套定义的（ location / { location /uri/ {} } ）。但是我们平时却很少看见这样的配置，那是因为 nginx 官方并不建议大家这么做，因为这样会导致很多意想不到的后果。</p>\n<blockquote>\n<p>The prefix “@” specifies a named location. Such locations are not used during normal processing of requests, they are intended only to process internally redirected requests (see error_page ,try_files ).</p>\n</blockquote>\n<p>文章开始说了location 的语法中，可以有“= ”，“^~ ”，“~ ”和“~* ”前缀，或者干脆没有任何前缀，还有“@ ”前缀，但是后面的分析我们始终没有谈到“@ ”前缀。文章最后点内容，介绍了“＠”的用途：“@ ”是用来定义“Named Location ”的（你可以理解为独立于“普通location （location using literal strings ）”和“正则location （location using regular expressions ）”之外的第三种类型），这种“Named Location ”不是用来处理普通的HTTP 请求的，它是专门用来处理“内部重定向（internally redirected ）”请求的。注意：这里说的“内部重定向（internally redirected ）”或许说成“forward ”会好点，以为内internally redirected 是不需要跟浏览器交互的，纯粹是服务端的一个转发行为。</p>\n<h3 id=\"location-实例练习\"><a href=\"#location-实例练习\" class=\"headerlink\" title=\"location 实例练习\"></a>location 实例练习</h3><p>Nginx 的语法形式是：<code>location [=|~|~*|^~|@] /uri/ { … }</code>，意思是可以以“ = ”或“ ~* ”或“ ~ ”或“ ^~ ”或“ @ ”符号为前缀，当然也可以没有前缀（因为 [A] 是表示可选的 A ； A|B 表示 A 和 B 选一个），紧接着是 /uri/ ，再接着是{…} 指令块，整个意思是对于满足这样条件的 /uri/ 适用指令块 {…} 的指令。</p>\n<p>上述各种 location 可分两大类，分别是：“普通 location ”，官方英文说法是 location using   literal strings 和“正则 location ”，英文说法是 location using regular expressions 。其中“普通 location ”是以“ = ”或“ ^~ ”为前缀或者没有任何前缀的 /uri/ ；“正则 location ”是以“ ~ ”或“ ~* ”为前缀的 /uri/ 。<br>那么，当我们在一个 server 上下文编写了多个 location 的时候， Nginx 对于一个 HTTP 请求，是如何匹配到一个 location 做处理呢？用一句话简单概括 Nginx 的 location 匹配规则是：“正则 location ”让步 “普通 location”的严格精确匹配结果；但覆盖 “普通 location ”的最大前缀匹配结果。理解这句话，我想通过下面的实例来说明。</p>\n<ul>\n<li><strong>先普通 location ，再正则 location</strong><br>周边不少童鞋告诉我， nginx 是“先匹配正则 location 再匹配普通 location ”，其实这是一个误区， nginx 其实是“先匹配普通 location ，再匹配正则 location ”，但是普通 location 的匹配结果又分两种：一种是“严格精确匹配”，官方英文说法是“ exact match ”；另一种是“最大前缀匹配”，官方英文说法是“ Literal strings match the beginning portion of the query – the most specific match will be used. ”。我们做个实验：</li>\n</ul>\n<p>例题 1 ：假设 nginx 的配置如下<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span>       <span class=\"number\">9090</span>;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">       <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">           <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">           <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"attribute\">location</span> <span class=\"regexp\">~ \\.html$</span> &#123;</span><br><span class=\"line\">           <span class=\"attribute\">allow</span> all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>附录 nginx 的目录结构是： nginx-&gt;html-&gt;index.html<br>上述配置的意思是： location / {… deny all;} 普通 location 以“ / ”开始的 URI 请求（注意任何 HTTP 请求都必然以“/ ”开始，所以“ / ”的意思是所有的请求都能被匹配上），都拒绝访问； location ~.html$ {allow all;} 正则 location以 .html 结尾的 URI 请求，都允许访问。</p>\n<p>测试结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class=\"line\">&lt;body bgcolor=”white”&gt;</span><br><span class=\"line\">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class=\"line\">&lt;hr&gt;&lt;center&gt;nginx/1.1.0&lt;/center&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/index.html</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body bgcolor=”white” text=”black”&gt;</span><br><span class=\"line\">&lt;center&gt;&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;&lt;/center&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/index_notfound.html</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class=\"line\">&lt;body bgcolor=”white”&gt;</span><br><span class=\"line\">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class=\"line\">&lt;hr&gt;&lt;center&gt;nginx/1.1.0&lt;/center&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>\n<p>测试结果如下：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">URI请求</th>\n<th style=\"text-align:center\">HTTP响应</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">curl <a href=\"http://localhost:9090/\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/</a></td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">curl <a href=\"http://localhost:9090/index.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index.html</a></td>\n<td style=\"text-align:center\">Welcome to nginx!</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">curl <a href=\"http://localhost:9090/index_notfound.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index_notfound.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n</tbody>\n</table>\n<p><code>curl http://localhost:9090/</code> 的结果是“ 403 Forbidden ”，说明被匹配到“ location / {..deny all;} ”了，原因很简单HTTP 请求 GET / 被“严格精确”匹配到了普通 location / {} ，则会停止搜索正则 location ；</p>\n<p><code>curl http://localhost:9090/index.html</code> 结果是“ Welcome to nginx! ”，说明没有被“ location / {…deny all;} ”匹配，否则会 403 Forbidden ，但 /index.html 的确也是以“ / ”开头的，只不过此时的普通 location / 的匹配结果是“最大前缀”匹配，所以 Nginx 会继续搜索正则 location ， location ~ .html$ 表达了以 .html 结尾的都 allow all; 于是接着就访问到了实际存在的 index.html 页面。</p>\n<p><code>curl http://localhost:9090/index_notfound.html</code>   同样的道理先匹配 location / {} ，但属于“普通 location 的最大前缀匹配”，于是后面被“正则 location ” location ~ .html$ {} 覆盖了，最终 allow all ； 但的确目录下不存在index_notfound.html 页面，于是 404 Not Found 。</p>\n<p>如果此时我们访问 <a href=\"http://localhost:9090/index.txt\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index.txt</a> 会是什么结果呢？显然是 deny all ；因为先匹配上了 location / {..deny all;} 尽管属于“普通 location ”的最大前缀匹配结果，继续搜索正则 location ，但是 /index.txt 不是以 .html结尾的，正则 location 失败，最终采纳普通 location 的最大前缀匹配结果，于是 deny all 了。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/index.txt</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class=\"line\">&lt;body bgcolor=”white”&gt;</span><br><span class=\"line\">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class=\"line\">&lt;hr&gt;&lt;center&gt;nginx/1.1.0&lt;/center&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li><strong>普通 location 的“隐式”严格匹配</strong></li>\n</ul>\n<p>例题 2 ：我们在例题 1 的基础上增加精确配置</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span>       <span class=\"number\">9090</span>;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">       <span class=\"attribute\">location</span> /exact/match.html &#123;</span><br><span class=\"line\">           <span class=\"attribute\">allow</span> all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">           <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">           <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"attribute\">location</span> <span class=\"regexp\">~ \\.html$</span> &#123;</span><br><span class=\"line\">           <span class=\"attribute\">allow</span> all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试请求：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/exact/match.html</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class=\"line\">&lt;body bgcolor=”white”&gt;</span><br><span class=\"line\">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class=\"line\">&lt;hr&gt;&lt;center&gt;nginx/1.1.0&lt;/center&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>\n<p>结果进一步验证了“普通 location ”的“严格精确”匹配会终止对正则 location 的搜索。这里我们小结下“普通 location”与“正则 location ”的匹配规则：先匹配普通 location ，再匹配正则 location ，但是如果普通 location 的匹配结果恰好是“严格精确（ exact match ）”的，则 nginx 不再尝试后面的正则 location ；如果普通 location 的匹配结果是“最大前缀”，则正则 location 的匹配覆盖普通 location 的匹配。也就是前面说的“正则 location 让步普通location 的严格精确匹配结果，但覆盖普通 location 的最大前缀匹配结果”。</p>\n<ul>\n<li><strong>普通 location 的“显式”严格匹配和“ ^~ ” 前缀</strong></li>\n</ul>\n<p>上面我们演示的普通 location 都是不加任何前缀的，其实普通 location 也可以加前缀：“ ^~ ”和“ = ”。其中“ ^~”的意思是“非正则，不需要继续正则匹配”，也就是通常我们的普通 location ，还会继续搜索正则 location （恰好严格精确匹配除外），但是 nginx 很人性化允许配置人员告诉 nginx 某条普通 location ，无论最大前缀匹配，还是严格精确匹配都终止继续搜索正则 location ；而“ = ”则表达的是普通 location 不允许“最大前缀”匹配结果，必须严格等于，严格精确匹配。</p>\n<p>例题 3 ：“ ^~ ”前缀的使用<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;</span><br><span class=\"line\">       location /exact/match.html &#123;</span><br><span class=\"line\">           allow all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       location ^~ / &#123;</span><br><span class=\"line\">           root   html;</span><br><span class=\"line\">           index  index.html index.htm;</span><br><span class=\"line\">           deny all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       location ~ \\.html$ &#123;</span><br><span class=\"line\">           allow all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>把例题 2 中的 location / {} 修改成 location ^~ / {} ，再看看测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>URL请求</th>\n<th style=\"text-align:center\">修改前</th>\n<th style=\"text-align:center\">修改后</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://localhost:9090/\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/</a></td>\n<td style=\"text-align:center\">403 Forbidden</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/index.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index.html</a></td>\n<td style=\"text-align:center\">Welcome to nginx!</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/index_notfound.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index_notfound.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/exact/match.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/exact/match.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n</tbody>\n</table>\n<p>除了 GET /exact/match.html 是 404 Not Found ，其余都是 403 Forbidden ，原因很简单所有请求都是以“ / ”开头，所以所有请求都能匹配上“ / ”普通 location ，但普通 location 的匹配原则是“最大前缀”，所以只有/exact/match.html 匹配到 location /exact/match.html {allow all;} ，其余都 location ^~ / {deny all;} 并终止正则搜索。</p>\n<p>例题 4 ：“ = ”前缀的使用<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;</span><br><span class=\"line\">       location /exact/match.html &#123;</span><br><span class=\"line\">           allow all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       location = / &#123;</span><br><span class=\"line\">           root   html;</span><br><span class=\"line\">           index  index.html index.htm;</span><br><span class=\"line\">           deny all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       location ~ \\.html$ &#123;</span><br><span class=\"line\">           allow all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>例题 4 相对例题 2 把 location / {} 修改成了 location = / {} ，再次测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>URL请求</th>\n<th style=\"text-align:center\">修改前</th>\n<th style=\"text-align:center\">修改后</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://localhost:9090/\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/</a></td>\n<td style=\"text-align:center\">403 Forbidden</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/index.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index.html</a></td>\n<td style=\"text-align:center\">Welcome to nginx!</td>\n<td style=\"text-align:center\">Welcome to nginx!</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/index_notfound.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index_notfound.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/exact/match.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/exact/match.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/test.jsp\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/test.jsp</a></td>\n<td style=\"text-align:center\">403 Forbidden</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n</tbody>\n</table>\n<p>最能说明问题的测试是 GET /test.jsp ，实际上 /test.jsp 没有匹配正则 location （ location ~.html$ ），也没有匹配 location = / {} ，如果按照 location / {} 的话，会“最大前缀”匹配到普通 location / {} ，结果是 deny all 。</p>\n<ul>\n<li><strong>正则 location 与编辑顺序</strong><br>location 的指令与编辑顺序无关，这句话不全对。对于普通 location 指令，匹配规则是：最大前缀匹配（与顺序无关），如果恰好是严格精确匹配结果或者加有前缀“ ^~ ”或“ = ”（符号“ = ”只能严格匹配，不能前缀匹配），则停止搜索正则 location ；但对于正则 location 的匹配规则是：按编辑顺序逐个匹配（与顺序有关），只要匹配上，就立即停止后面的搜索。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置 3.1</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;</span><br><span class=\"line\">       location ~ \\.html$ &#123;</span><br><span class=\"line\">           allow all; </span><br><span class=\"line\">       &#125;  </span><br><span class=\"line\">       location ~ ^/prefix/.*\\.html$ &#123;</span><br><span class=\"line\">           deny all;  </span><br><span class=\"line\">       &#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">配置 3.2</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;     </span><br><span class=\"line\">       location ~ ^/prefix/.*\\.html$ &#123;</span><br><span class=\"line\">           deny all;  </span><br><span class=\"line\">       &#125;            </span><br><span class=\"line\">       location ~ \\.html$ &#123;</span><br><span class=\"line\">           allow all; </span><br><span class=\"line\">       &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>URL请求</th>\n<th style=\"text-align:center\">配置3.1</th>\n<th style=\"text-align:center\">配置3.2</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://localhost:9090/regextest.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/regextest.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/prefix/regextest.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/prefix/regextest.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n</tbody>\n</table>\n<p>解释：<br><code>Location ~ ^/prefix/.*\\.html$ {deny all;}</code> 表示正则 location 对于以 /prefix/ 开头， .html 结尾的所有 URI 请求，都拒绝访问；   <code>location ~\\.html${allow all;}</code> 表示正则 location 对于以 .html 结尾的 URI 请求，都允许访问。 实际上，prefix 的是 ~.html$ 的子集。</p>\n<p>在“配置 3.1 ”下，两个请求都匹配上 <code>location ~\\.html$ {allow all;}</code> ，并且停止后面的搜索，于是都允许访问， 404 Not Found ；在“配置 3.2 ”下， /regextest.html 无法匹配 prefix ，于是继续搜索 ~.html$ ，允许访问，于是 404 Not Found ；然而 /prefix/regextest.html 匹配到 prefix ，于是 deny all ， 403 Forbidden 。<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置 3.3</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost; </span><br><span class=\"line\">       location  /prefix/ &#123;</span><br><span class=\"line\">               deny all;  </span><br><span class=\"line\">       &#125;           </span><br><span class=\"line\">       location  /prefix/mid/ &#123;</span><br><span class=\"line\">               allow all; </span><br><span class=\"line\">       &#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">配置 3.4</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;    </span><br><span class=\"line\">       location  /prefix/mid/ &#123;</span><br><span class=\"line\">               allow all; </span><br><span class=\"line\">       &#125;  </span><br><span class=\"line\">        location  /prefix/ &#123;</span><br><span class=\"line\">               deny all;  </span><br><span class=\"line\">       &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>URL请求</th>\n<th style=\"text-align:center\">配置3.3</th>\n<th style=\"text-align:center\">配置3.4</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://localhost:9090/prefix/t.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/prefix/t.html</a></td>\n<td style=\"text-align:center\">403 Forbidden</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/prefix/mid/t.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/prefix/mid/t.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n</tbody>\n</table>\n<p>测试结果表明：普通 location 的匹配规则是“最大前缀”匹配，而且与编辑顺序无关。</p>\n<ul>\n<li><strong>“@” 前缀 Named Location 使用</strong><br>REFER:  <a href=\"http://wiki.nginx.org/HttpCoreModule#error_page\" target=\"_blank\" rel=\"noopener\">http://wiki.nginx.org/HttpCoreModule#error_page</a><br>假设配置如下：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;</span><br><span class=\"line\">       location  / &#123;</span><br><span class=\"line\">           root   html;</span><br><span class=\"line\">           index  index.html index.htm;</span><br><span class=\"line\">           allow all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"comment\">#error_page 404 http://www.baidu.com # 直接这样是不允许的</span></span><br><span class=\"line\">       error_page 404 = @fallback;</span><br><span class=\"line\">\t   </span><br><span class=\"line\">       location @fallback &#123;</span><br><span class=\"line\">           proxy_pass http://www.baidu.com;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>上述配置文件的意思是：如果请求的 URI 存在，则本 nginx 返回对应的页面；如果不存在，则把请求代理到baidu.com 上去做个弥补（注： nginx 当发现 URI 对应的页面不存在， HTTP_StatusCode 会是 404 ，此时error_page 404 指令能捕获它）。</p>\n<p>测试一：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/nofound.html -i</span></span><br><span class=\"line\">HTTP/1.1 302 Found</span><br><span class=\"line\">Server: nginx/1.1.0</span><br><span class=\"line\">Date: Sat, 06 Aug 2011 08:17:21 GMT</span><br><span class=\"line\">Content-Type: text/html; charset=iso-8859-1</span><br><span class=\"line\">Location: http://localhost:9090/search/error.html</span><br><span class=\"line\">Connection: keep-alive</span><br><span class=\"line\">Cache-Control: max-age=86400</span><br><span class=\"line\">Expires: Sun, 07 Aug 2011 08:17:21 GMT</span><br><span class=\"line\">Content-Length: 222</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC “-//IETF//DTD HTML 2.0//EN”&gt;</span><br><span class=\"line\">&lt;html&gt;&lt;head&gt;</span><br><span class=\"line\">&lt;title&gt;302 Found&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;&lt;body&gt;</span><br><span class=\"line\">&lt;h1&gt;Found&lt;/h1&gt;</span><br><span class=\"line\">&lt;p&gt;The document has moved &lt;a href=”http://www.baidu.com/search/error.html”&gt;here&lt;/a&gt;.&lt;/p&gt;</span><br><span class=\"line\">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>当我们 GET /nofound.html 发送给本 nginx ， nginx 找不到对应的页面，于是 error_page 404 = @fallback ，请求被代理到 <a href=\"http://www.baidu.com\" target=\"_blank\" rel=\"noopener\">http://www.baidu.com</a> ，于是 nginx 给 <a href=\"http://www.baidu.com\" target=\"_blank\" rel=\"noopener\">http://www.baidu.com</a> 发送了 GET /nofound.html ，但/nofound.html 页面在百度也不存在，百度 302 跳转到错误页。<br>直接访问 <a href=\"http://www.baidu.com/nofound.html\" target=\"_blank\" rel=\"noopener\">http://www.baidu.com/nofound.html</a> 结果：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://www.baidu.com/nofound.html -i</span></span><br><span class=\"line\">HTTP/1.1 302 Found</span><br><span class=\"line\">Date: Sat, 06 Aug 2011 08:20:05 GMT</span><br><span class=\"line\">Server: Apache</span><br><span class=\"line\">Location: http://www.baidu.com/search/error.html</span><br><span class=\"line\">Cache-Control: max-age=86400</span><br><span class=\"line\">Expires: Sun, 07 Aug 2011 08:20:05 GMT</span><br><span class=\"line\">Content-Length: 222</span><br><span class=\"line\">Connection: Keep-Alive</span><br><span class=\"line\">Content-Type: text/html; charset=iso-8859-1</span><br><span class=\"line\"> </span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC “-//IETF//DTD HTML 2.0//EN”&gt;</span><br><span class=\"line\">&lt;html&gt;&lt;head&gt;</span><br><span class=\"line\">&lt;title&gt;302 Found&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;&lt;body&gt;</span><br><span class=\"line\">&lt;h1&gt;Found&lt;/h1&gt;</span><br><span class=\"line\">&lt;p&gt;The document has moved &lt;a href=”http://www.baidu.com/search/error.html”&gt;here&lt;/a&gt;.&lt;/p&gt;</span><br><span class=\"line\">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>测试二：访问一个 nginx 不存在，但 baidu 存在的页面<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://www.baidu.com/duty/ -i</span></span><br><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">Date: Sat, 06 Aug 2011 08:21:56 GMT</span><br><span class=\"line\">Server: Apache</span><br><span class=\"line\">P3P: CP=” OTI DSP COR IVA OUR IND COM ”</span><br><span class=\"line\">P3P: CP=” OTI DSP COR IVA OUR IND COM ”</span><br><span class=\"line\">Set-Cookie: BAIDUID=5C5D2B2FD083737A0C88CA7075A6601A:FG=1; expires=Sun, 05-Aug-12 08:21:56 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1</span><br><span class=\"line\">Set-Cookie: BAIDUID=5C5D2B2FD083737A2337F78F909CCB90:FG=1; expires=Sun, 05-Aug-12 08:21:56 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1</span><br><span class=\"line\">Last-Modified: Wed, 05 Jan 2011 06:44:53 GMT</span><br><span class=\"line\">ETag: “d66-49913b8efe340″</span><br><span class=\"line\">Accept-Ranges: bytes</span><br><span class=\"line\">Content-Length: 3430</span><br><span class=\"line\">Cache-Control: max-age=86400</span><br><span class=\"line\">Expires: Sun, 07 Aug 2011 08:21:56 GMT</span><br><span class=\"line\">Vary: Accept-Encoding,User-Agent</span><br><span class=\"line\">Connection: Keep-Alive</span><br><span class=\"line\">Content-Type: text/html</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC “-//W3C//DTD HTML 4.01 Transitional//EN”</span><br><span class=\"line\">“http://www.w3.org/TR/html4/loose.dtd”&gt;</span><br><span class=\"line\">。。。。</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>\n<p>显示，的确百度这个页面是存在的。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/duty/ -i</span></span><br><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">Server: nginx/1.1.0</span><br><span class=\"line\">Date: Sat, 06 Aug 2011 08:23:23 GMT</span><br><span class=\"line\">Content-Type: text/html</span><br><span class=\"line\">Connection: keep-alive</span><br><span class=\"line\">P3P: CP=” OTI DSP COR IVA OUR IND COM ”</span><br><span class=\"line\">P3P: CP=” OTI DSP COR IVA OUR IND COM ”</span><br><span class=\"line\">Set-Cookie: BAIDUID=8FEF0A3A2C31D277DCB4CC5F80B7F457:FG=1; expires=Sun, 05-Aug-12 08:23:23 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1</span><br><span class=\"line\">Set-Cookie: BAIDUID=8FEF0A3A2C31D277B1F87691AFFD7440:FG=1; expires=Sun, 05-Aug-12 08:23:23 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1</span><br><span class=\"line\">Last-Modified: Wed, 05 Jan 2011 06:44:53 GMT</span><br><span class=\"line\">ETag: “d66-49913b8efe340″</span><br><span class=\"line\">Accept-Ranges: bytes</span><br><span class=\"line\">Content-Length: 3430</span><br><span class=\"line\">Cache-Control: max-age=86400</span><br><span class=\"line\">Expires: Sun, 07 Aug 2011 08:23:23 GMT</span><br><span class=\"line\">Vary: Accept-Encoding,User-Agent</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC “-//W3C//DTD HTML 4.01 Transitional//EN”</span><br><span class=\"line\">“http://www.w3.org/TR/html4/loose.dtd”&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">。。。</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>当 <code>curl http://localhost:9090/duty/ -i</code> 时， nginx 没找到对应的页面，于是 error_page = @fallback ，把请求代理到 baidu.com 。注意这里的 error_page = @fallback 不是靠重定向实现的，而是所说的“ internally redirected （forward ）”。</p>\n<h3 id=\"proxy-pass-URL-末尾加与不加-（斜线）的区别\"><a href=\"#proxy-pass-URL-末尾加与不加-（斜线）的区别\" class=\"headerlink\" title=\"proxy_pass URL 末尾加与不加/（斜线）的区别\"></a>proxy_pass URL 末尾加与不加/（斜线）的区别</h3><blockquote>\n<p>Proxy_pass末尾带”/”和不带是有区别的：<br>不带斜杠转发的是除hostname以外的部分，包括目录。可以使用正则表达式匹配location，且任意正则匹配成功后，转发的都是完整目录路径。<br>带斜杠转发的是除hostname及目录外的所有部分。不能使用正则表达式匹配location块，只能使用完整路径名准确匹配。</p>\n</blockquote>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span> &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td><a href=\"http://127.0.0.1:8087/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/tobaidu</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/tobaidu/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span> &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>/define;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td><a href=\"http://127.0.0.1:8087/define\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span>/ &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td>重定向到<a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/tobaidu/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span>/ &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>/define;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td>重定向到<a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/define\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span> &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td><a href=\"http://127.0.0.1:8087/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087//\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087//</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087//xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087//xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">6</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span> &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>/define/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/define//\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define//</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/define//xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define//xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">7</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span>/ &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td>重定向到<a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">8</span></span><br><span class=\"line\">location <span class=\"regexp\">/tobaidu/</span> &#123;</span><br><span class=\"line\">    proxy_pass http:<span class=\"regexp\">//</span><span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span><span class=\"regexp\">/define/</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td>重定向到<a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<p><strong>结论</strong><br><em>URL符合 <code>protocol://ip:port</code> 同时结尾不加/,则nginx会代理匹配路径部分,否则不代理匹配路径,同时自动添加不匹配路径”部分”,比如/tobaidu/xxxx的/xxxx部分</em></p>\n","site":{"data":{}},"length":25385,"excerpt":"","more":"<h3 id=\"location-的匹配顺序是“先匹配正则，再匹配普通”。\"><a href=\"#location-的匹配顺序是“先匹配正则，再匹配普通”。\" class=\"headerlink\" title=\"location 的匹配顺序是“先匹配正则，再匹配普通”。\"></a>location 的匹配顺序是“先匹配正则，再匹配普通”。</h3><p>矫正： location 的匹配顺序其实是“先匹配普通，再匹配正则”。我这么说，大家一定会反驳我，因为按“先匹配普通，再匹配正则”解释不了大家平时习惯的按“先匹配正则，再匹配普通”的实践经验。这里我只能暂时解释下，造成这种误解的原因是：正则匹配会覆盖普通匹配（实际的规则，比这复杂，后面会详细解释）。</p>\n<h3 id=\"location-的执行逻辑跟-location-的编辑顺序无关。\"><a href=\"#location-的执行逻辑跟-location-的编辑顺序无关。\" class=\"headerlink\" title=\"location 的执行逻辑跟 location 的编辑顺序无关。\"></a>location 的执行逻辑跟 location 的编辑顺序无关。</h3><p>矫正：这句话不全对，“普通 location ”的匹配规则是“最大前缀”，因此“普通 location ”的确与 location 编辑顺序无关；但是“正则 location ”的匹配规则是“顺序匹配，且只要匹配到第一个就停止后面的匹配”；“普通location ”与“正则 location ”之间的匹配顺序是？先匹配普通 location ，再“考虑”匹配正则 location 。注意这里的“考虑”是“可能”的意思，也就是说匹配完“普通 location ”后，有的时候需要继续匹配“正则 location ”，有的时候则不需要继续匹配“正则 location ”。两种情况下，不需要继续匹配正则 location ：（ 1 ）当普通 location 前面指定了“ ^~ ”，特别告诉 Nginx 本条普通 location 一旦匹配上，则不需要继续正则匹配；（ 2 ）当普通location 恰好严格匹配上，不是最大前缀匹配，则不再继续匹配正则。</p>\n<p><strong>总结一句话：  “正则 location 匹配让步普通 location 的严格精确匹配结果；但覆盖普通 location 的最大前缀匹配结果”</strong></p>\n<blockquote>\n<p>匹配优先级为： (location =) &gt; (location 完整路径) &gt; (location ^~ 路径) &gt; (location ~,~* 正则顺序) &gt; (location 部分起始路径) &gt; (/)</p>\n</blockquote>\n<p><strong>官方文档解释</strong>：<a href=\"http://wiki.nginx.org/NginxHttpCoreModule#location\" target=\"_blank\" rel=\"noopener\">http://wiki.nginx.org/NginxHttpCoreModule#location</a><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location</span><br><span class=\"line\">syntax: `<span class=\"keyword\">location</span> <span class=\"title\">[=|~|~*|^~|@] /uri</span>/ &#123; … &#125;`</span><br><span class=\"line\">default: no</span><br><span class=\"line\">context: server</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>This directive allows different configurations depending on the URI.</p>\n</blockquote>\n<p>（译者注：1 、different configurations depending on the URI 说的就是语法格式：<code>location [=|~|~*|^~|@] /uri/ { … }</code> ，依据不同的前缀<code>“= ”，“^~ ”，“~ ”，“~* ”</code>和不带任何前缀的（因为[A] 表示可选，可以不要的），表达不同的含义, 简单的说尽管location 的/uri/ 配置一样，但前缀不一样，表达的是不同的指令含义。2 、查询字符串不在URI范围内。例如：/films.htm?fid=123 的URI 是/films.htm 。）<br>It can be configured using both literal strings and regular expressions. To use regular expressions, you must use a prefix:<br><code>“~”</code>for case sensitive matching<br><code>“~*”</code>for case insensitive matching<br>译文：上文讲到<code>location /uri/</code> 可通过使用不同的前缀，表达不同的含义。对这些不同前缀，分下类，就2 大类：正则location ，英文说法是location using regular expressions 和普通location ，英文说法是location using literal strings 。那么其中“~ ”和“~<em> ”前缀表示正则location ，“~ ”区分大小写，“~</em> ”不区分大小写；其他前缀（包括：“=”，“^~ ”和“@ ”）和无任何前缀的都属于普通location 。</p>\n<blockquote>\n<p>To determine which location directive matches a particular query, the literal strings are checked first.</p>\n</blockquote>\n<p>译文：对于一个特定的 HTTP 请求（ a particular query ）， nginx 应该匹配哪个 location 块的指令呢（注意：我们在 nginx.conf 配置文件里面一般会定义多个 location 的）？匹配 规则是：先匹配普通location （再匹配正则表达式）。注意：官方文档这句话就明确说了，先普通location ，而不是有些同学的误区“先匹配正则location ”。</p>\n<blockquote>\n<p>Literal strings match the beginning portion of the query – the most specific match will be used.</p>\n</blockquote>\n<p>前面说了“普通location ”与“正则location ”之间的匹配规则是：先匹配普通location ，再匹配正则location 。那么，“普通location ”内部（普通location 与普通location ）是如何匹配的呢？简单的说：最大前缀匹配。原文：1、match the beginning portion of the query （说的是匹配URI 的前缀部分beginning portion ）； 2 、the most specific match will be used （因为location 不是“严格匹配”，而是“前缀匹配”，就会产生一个HTTP 请求，可以“前缀匹配”到多个普通location ，例如：<code>location /prefix/mid/ {}</code> 和<code>location /prefix/ {}</code> ，对于HTTP 请求/prefix/mid/t.html ，前缀匹配的话两个location 都满足，选哪个？原则是：the most specific match ，于是选的是<code>location /prefix/mid/ {}</code> ）。</p>\n<blockquote>\n<p>Afterwards, regular expressions are checked in the order defined in the configuration file. The first regular expression to match the query will stop the search.</p>\n</blockquote>\n<p>这段话说了两层意思，第一层是：“Afterwards, regular expressions are checked ”, 意思是普通location 先匹配，而且选择了最大前缀匹配后，就不能停止后面的匹配，最大前缀匹配只是一个临时的结果，nginx 还需要继续检查正则location （但至于最终是和普通location 的最大前缀匹配，还是正则location 的匹配，截止当前的内容还没讲，但后面会讲）。第二层是“regular expressions are checked in the order defined in the configuration file. The first regular expression to match the query will stop the search. ”，意思是说“正则location ”与“正则location”内部的匹配规则是：按照正则location 在配置文件中的物理顺序（编辑顺序）匹配的（这句话就说明location 并不是一定跟顺序无关，只是普通location 与顺序无关，正则location 还是与顺序有关的），并且只要匹配到一条正则location ，就不再考虑后面的（这与“普通location ”与“正则location ”之间的规则不一样，“普通location ”与“正则location ”之间的规则是：选择出“普通location ”的最大前缀匹配结果后，还需要继续搜索正则location ）。</p>\n<blockquote>\n<p>If no regular expression matches are found, the result from the literal string search is used.</p>\n</blockquote>\n<p>这句话回答了“普通location ”的最大前缀匹配结果与继续搜索的“正则location ”匹配结果的决策关系。如果继续搜索的“正则location ”也有匹配上的，那么“正则location ”覆盖 “普通location ”的最大前缀匹配（因为有这个覆盖关系，所以造成有些同学以为正则location 先于普通location 执行的错误理解）；但是如果“正则location ”没有能匹配上，那么就用“普通location ”的最大前缀匹配结果。<br>For case insensitive operating systems, like Mac OS X or Windows with Cygwin, literal string matching is done in a case insensitive way (0.7.7). However, comparison is limited to single-byte locale’s only.<br>Regular expression may contain captures (0.7.40), which can then be used in other directives.</p>\n<blockquote>\n<p>It is possible to disable regular expression checks after literal string matching by using “^~” prefix.If the most specific match literal location has this prefix: regular expressions aren’t checked.</p>\n</blockquote>\n<p>通常的规则是，匹配完了“普通location ”指令，还需要继续匹配“正则location ”，但是你也可以告诉Nginx ：匹配到了“普通location ”后，不再需要继续匹配“正则location ”了，要做到这一点只要在“普通location ”前面加上“^~ ”符号（^ 表示“非”，~ 表示“正则”，字符意思是：不要继续匹配正则）。</p>\n<blockquote>\n<p>By using the “=” prefix we define the exact match between request URI and location. When matched search stops immediately. E.g., if the request “/” occurs frequently, using “location = /” will speed up processing of this request a bit as search will stop after first comparison.</p>\n</blockquote>\n<p>除了上文的“^~ ”可以阻止继续搜索正则location 外，你还可以加“= ”。那么如果“^~ ”和“= ”都能阻止继续搜索正则location 的话，那它们之间有什么区别呢？区别很简单，共同点是它们都能阻止继续搜索正则location ，不同点是“^~ ”依然遵守“最大前缀”匹配规则，然而“= ”不是“最大前缀”，而是必须是严格匹配（exact match ）。<br>这里顺便讲下<code>“location / {} ”和“location = / {} ”</code>的区别，“location / {} ”遵守普通location 的最大前缀匹配，由于任何URI 都必然以“/ ”根开头，所以对于一个URI ，如果有更specific 的匹配，那自然是选这个更specific 的，如果没有，“/ ”一定能为这个URI 垫背（至少能匹配到“/ ”），也就是说“location / {} ”有点默认配置的味道，其他更specific的配置能覆盖overwrite 这个默认配置（这也是为什么我们总能看到location / {} 这个配置的一个很重要的原因）。而“location = / {} ”遵守的是“严格精确匹配exact match ”，也就是只能匹配 <a href=\"http://host:port/\" target=\"_blank\" rel=\"noopener\">http://host:port/</a> 请求，同时会禁止继续搜索正则location 。因此如果我们只想对“GET / ”请求配置作用指令，那么我们可以选“location = / {} ”这样能减少正则location 的搜索，因此效率比“location / {}” 高（注：前提是我们的目的仅仅只想对“GET / ”起作用）。</p>\n<blockquote>\n<p>On exact match with literal location without “=” or “^~” prefixes search is also immediately terminated.</p>\n</blockquote>\n<p>前面我们说了，普通location 匹配完后，还会继续匹配正则location ；但是nginx 允许你阻止这种行为，方法很简单，只需要在普通location 前加“^~ ”或“= ”。但其实还有一种“隐含”的方式来阻止正则location 的搜索，这种隐含的方式就是：当“最大前缀”匹配恰好就是一个“严格精确（exact match ）”匹配，照样会停止后面的搜索。原文字面意思是：只要遇到“精确匹配exact match ”，即使普通location 没有带“= ”或“^~ ”前缀，也一样会终止后面的匹配。</p>\n<p>先举例解释下，后面例题会用实践告诉大家。假设当前配置是：location /exact/match/test.html { 配置指令块1}，location /prefix/ { 配置指令块2} 和 location ~ .html$ { 配置指令块3} ，如果我们请求 GET /prefix/index.html ，则会被匹配到指令块3 ，因为普通location /prefix/ 依据最大匹配原则能匹配当前请求，但是会被后面的正则location 覆盖；当请求GET /exact/match/test.html ，会匹配到指令块1 ，因为这个是普通location 的exact match ，会禁止继续搜索正则location 。</p>\n<p><strong>To summarize, the order in which directives are checked is as follows:</strong></p>\n<ol>\n<li>Directives with the “=” prefix that match the query exactly. If found, searching stops.</li>\n<li>All remaining directives with conventional strings. If this match used the “^~” prefix, searching stops.</li>\n<li>Regular expressions, in the order they are defined in the configuration file.</li>\n<li>If #3 yielded a match, that result is used. Otherwise, the match from #2 is used.</li>\n</ol>\n<p>这个顺序没必要再过多解释了。但我想用自己的话概括下上面的意思“正则 location 匹配让步普通location 的严格精确匹配结果；但覆盖普通 location 的最大前缀匹配结果”。</p>\n<blockquote>\n<p>It is important to know that nginx does the comparison against decoded URIs. For example, if you wish to match “/images/ /test”, then you must use “/images/ /test” to determine the location.</p>\n</blockquote>\n<p>在浏览器上显示的URL 一般都会进行URLEncode ，例如“空格”会被编码为  ，但是Nginx 的URL 的匹配都是针对URLDecode 之后的。也就是说，如果你要匹配“/images/ /test ”，你写location 的时候匹配目标应该是：“/images/ /test ”。</p>\n<p><strong>Example:</strong><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">location</span>   <span class=\"title\">= / &#123;</span></span><br><span class=\"line\"><span class=\"title\"> # matches</span> the query / only.</span><br><span class=\"line\"> [ configuration A ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">location</span>   <span class=\"title\">/ &#123;</span></span><br><span class=\"line\"><span class=\"title\">  # matches</span> any query, since all queries begin with /, but regular</span><br><span class=\"line\">  <span class=\"comment\"># expressions and any longer conventional blocks will be</span></span><br><span class=\"line\">  <span class=\"comment\"># matched first.</span></span><br><span class=\"line\"> [ configuration B ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">^~ /images</span>/ &#123;</span><br><span class=\"line\">    <span class=\"comment\"># matches any query beginning with /images/ and halts searching,</span></span><br><span class=\"line\">    <span class=\"comment\"># so regular expressions will not be checked.</span></span><br><span class=\"line\"> [ configuration C ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">~* \\.(gif</span>|jpg|jpeg)$ &#123;</span><br><span class=\"line\"> <span class=\"comment\"># matches any request ending in gif, jpg, or jpeg. However, all</span></span><br><span class=\"line\"> <span class=\"comment\"># requests to the /images/ directory will be handled by</span></span><br><span class=\"line\"> <span class=\"comment\"># Configuration C.  </span></span><br><span class=\"line\"> [ configuration D ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>上述这4 个location 的配置，没什么好解释的，唯一需要说明的是location / {[configuration B]} ，原文的注释严格来说是错误的，但我相信原文作者是了解规则的，只是文字描述上简化了下，但这个简化容易给读者造成“误解：先检查正则location ，再检查普通location ”。原文：“matches any query, since all queries begin with /, butregular expressions and any longer conventional blocks will be matched first. ”大意是说：“location / {} 能够匹配所有HTTP 请求，因为任何HTTP 请求都必然是以‘/ ’开始的（这半句没有错误）。但是，正则location 和其他任何比‘/ ’更长的普通location （location / {} 是普通location 里面最短的，因此其他任何普通location 都会比它更长，当然location = / {} 和 location ^~ / {} 是一样长的）会优先匹配（matched first ）。” 原文作者说“ but regular expressions will be matched first. ”应该只是想说正则 location 会覆盖这里的 location / {} ，但依然是普通location / {} 先于正则 location 匹配，接着再正则 location 匹配；但其他更长的普通 location （ any longer conventional blocks ）的确会先于 location / {} 匹配。</p>\n<p>Example requests:</p>\n<ul>\n<li>/ -&gt; configuration A</li>\n<li>/documents/document.html -&gt; configuration B</li>\n<li>/images/1.gif -&gt; configuration C</li>\n<li>/documents/1.jpg -&gt; configuration D</li>\n</ul>\n<blockquote>\n<p>Note that you could define these 4 configurations in any order and the results would remain the same.</p>\n</blockquote>\n<p>需要提醒下：这里说“in any order ”和“… remain the same ”是因为上面只有一个正则location 。文章前面已经说了正则location 的匹配是跟编辑顺序有关系的。</p>\n<blockquote>\n<p>While nested locations are allowed by the configuration file parser, their use is discouraged and may produce unexpected results.</p>\n</blockquote>\n<p>实际上 nginx 的配置文件解析程序是允许 location 嵌套定义的（ location / { location /uri/ {} } ）。但是我们平时却很少看见这样的配置，那是因为 nginx 官方并不建议大家这么做，因为这样会导致很多意想不到的后果。</p>\n<blockquote>\n<p>The prefix “@” specifies a named location. Such locations are not used during normal processing of requests, they are intended only to process internally redirected requests (see error_page ,try_files ).</p>\n</blockquote>\n<p>文章开始说了location 的语法中，可以有“= ”，“^~ ”，“~ ”和“~* ”前缀，或者干脆没有任何前缀，还有“@ ”前缀，但是后面的分析我们始终没有谈到“@ ”前缀。文章最后点内容，介绍了“＠”的用途：“@ ”是用来定义“Named Location ”的（你可以理解为独立于“普通location （location using literal strings ）”和“正则location （location using regular expressions ）”之外的第三种类型），这种“Named Location ”不是用来处理普通的HTTP 请求的，它是专门用来处理“内部重定向（internally redirected ）”请求的。注意：这里说的“内部重定向（internally redirected ）”或许说成“forward ”会好点，以为内internally redirected 是不需要跟浏览器交互的，纯粹是服务端的一个转发行为。</p>\n<h3 id=\"location-实例练习\"><a href=\"#location-实例练习\" class=\"headerlink\" title=\"location 实例练习\"></a>location 实例练习</h3><p>Nginx 的语法形式是：<code>location [=|~|~*|^~|@] /uri/ { … }</code>，意思是可以以“ = ”或“ ~* ”或“ ~ ”或“ ^~ ”或“ @ ”符号为前缀，当然也可以没有前缀（因为 [A] 是表示可选的 A ； A|B 表示 A 和 B 选一个），紧接着是 /uri/ ，再接着是{…} 指令块，整个意思是对于满足这样条件的 /uri/ 适用指令块 {…} 的指令。</p>\n<p>上述各种 location 可分两大类，分别是：“普通 location ”，官方英文说法是 location using   literal strings 和“正则 location ”，英文说法是 location using regular expressions 。其中“普通 location ”是以“ = ”或“ ^~ ”为前缀或者没有任何前缀的 /uri/ ；“正则 location ”是以“ ~ ”或“ ~* ”为前缀的 /uri/ 。<br>那么，当我们在一个 server 上下文编写了多个 location 的时候， Nginx 对于一个 HTTP 请求，是如何匹配到一个 location 做处理呢？用一句话简单概括 Nginx 的 location 匹配规则是：“正则 location ”让步 “普通 location”的严格精确匹配结果；但覆盖 “普通 location ”的最大前缀匹配结果。理解这句话，我想通过下面的实例来说明。</p>\n<ul>\n<li><strong>先普通 location ，再正则 location</strong><br>周边不少童鞋告诉我， nginx 是“先匹配正则 location 再匹配普通 location ”，其实这是一个误区， nginx 其实是“先匹配普通 location ，再匹配正则 location ”，但是普通 location 的匹配结果又分两种：一种是“严格精确匹配”，官方英文说法是“ exact match ”；另一种是“最大前缀匹配”，官方英文说法是“ Literal strings match the beginning portion of the query – the most specific match will be used. ”。我们做个实验：</li>\n</ul>\n<p>例题 1 ：假设 nginx 的配置如下<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span>       <span class=\"number\">9090</span>;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">       <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">           <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">           <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"attribute\">location</span> <span class=\"regexp\">~ \\.html$</span> &#123;</span><br><span class=\"line\">           <span class=\"attribute\">allow</span> all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>附录 nginx 的目录结构是： nginx-&gt;html-&gt;index.html<br>上述配置的意思是： location / {… deny all;} 普通 location 以“ / ”开始的 URI 请求（注意任何 HTTP 请求都必然以“/ ”开始，所以“ / ”的意思是所有的请求都能被匹配上），都拒绝访问； location ~.html$ {allow all;} 正则 location以 .html 结尾的 URI 请求，都允许访问。</p>\n<p>测试结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class=\"line\">&lt;body bgcolor=”white”&gt;</span><br><span class=\"line\">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class=\"line\">&lt;hr&gt;&lt;center&gt;nginx/1.1.0&lt;/center&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/index.html</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body bgcolor=”white” text=”black”&gt;</span><br><span class=\"line\">&lt;center&gt;&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;&lt;/center&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/index_notfound.html</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class=\"line\">&lt;body bgcolor=”white”&gt;</span><br><span class=\"line\">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class=\"line\">&lt;hr&gt;&lt;center&gt;nginx/1.1.0&lt;/center&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>\n<p>测试结果如下：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">URI请求</th>\n<th style=\"text-align:center\">HTTP响应</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">curl <a href=\"http://localhost:9090/\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/</a></td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">curl <a href=\"http://localhost:9090/index.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index.html</a></td>\n<td style=\"text-align:center\">Welcome to nginx!</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">curl <a href=\"http://localhost:9090/index_notfound.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index_notfound.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n</tbody>\n</table>\n<p><code>curl http://localhost:9090/</code> 的结果是“ 403 Forbidden ”，说明被匹配到“ location / {..deny all;} ”了，原因很简单HTTP 请求 GET / 被“严格精确”匹配到了普通 location / {} ，则会停止搜索正则 location ；</p>\n<p><code>curl http://localhost:9090/index.html</code> 结果是“ Welcome to nginx! ”，说明没有被“ location / {…deny all;} ”匹配，否则会 403 Forbidden ，但 /index.html 的确也是以“ / ”开头的，只不过此时的普通 location / 的匹配结果是“最大前缀”匹配，所以 Nginx 会继续搜索正则 location ， location ~ .html$ 表达了以 .html 结尾的都 allow all; 于是接着就访问到了实际存在的 index.html 页面。</p>\n<p><code>curl http://localhost:9090/index_notfound.html</code>   同样的道理先匹配 location / {} ，但属于“普通 location 的最大前缀匹配”，于是后面被“正则 location ” location ~ .html$ {} 覆盖了，最终 allow all ； 但的确目录下不存在index_notfound.html 页面，于是 404 Not Found 。</p>\n<p>如果此时我们访问 <a href=\"http://localhost:9090/index.txt\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index.txt</a> 会是什么结果呢？显然是 deny all ；因为先匹配上了 location / {..deny all;} 尽管属于“普通 location ”的最大前缀匹配结果，继续搜索正则 location ，但是 /index.txt 不是以 .html结尾的，正则 location 失败，最终采纳普通 location 的最大前缀匹配结果，于是 deny all 了。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/index.txt</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class=\"line\">&lt;body bgcolor=”white”&gt;</span><br><span class=\"line\">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class=\"line\">&lt;hr&gt;&lt;center&gt;nginx/1.1.0&lt;/center&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li><strong>普通 location 的“隐式”严格匹配</strong></li>\n</ul>\n<p>例题 2 ：我们在例题 1 的基础上增加精确配置</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span>       <span class=\"number\">9090</span>;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">       <span class=\"attribute\">location</span> /exact/match.html &#123;</span><br><span class=\"line\">           <span class=\"attribute\">allow</span> all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">           <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">           <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"attribute\">location</span> <span class=\"regexp\">~ \\.html$</span> &#123;</span><br><span class=\"line\">           <span class=\"attribute\">allow</span> all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试请求：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/exact/match.html</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class=\"line\">&lt;body bgcolor=”white”&gt;</span><br><span class=\"line\">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class=\"line\">&lt;hr&gt;&lt;center&gt;nginx/1.1.0&lt;/center&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>\n<p>结果进一步验证了“普通 location ”的“严格精确”匹配会终止对正则 location 的搜索。这里我们小结下“普通 location”与“正则 location ”的匹配规则：先匹配普通 location ，再匹配正则 location ，但是如果普通 location 的匹配结果恰好是“严格精确（ exact match ）”的，则 nginx 不再尝试后面的正则 location ；如果普通 location 的匹配结果是“最大前缀”，则正则 location 的匹配覆盖普通 location 的匹配。也就是前面说的“正则 location 让步普通location 的严格精确匹配结果，但覆盖普通 location 的最大前缀匹配结果”。</p>\n<ul>\n<li><strong>普通 location 的“显式”严格匹配和“ ^~ ” 前缀</strong></li>\n</ul>\n<p>上面我们演示的普通 location 都是不加任何前缀的，其实普通 location 也可以加前缀：“ ^~ ”和“ = ”。其中“ ^~”的意思是“非正则，不需要继续正则匹配”，也就是通常我们的普通 location ，还会继续搜索正则 location （恰好严格精确匹配除外），但是 nginx 很人性化允许配置人员告诉 nginx 某条普通 location ，无论最大前缀匹配，还是严格精确匹配都终止继续搜索正则 location ；而“ = ”则表达的是普通 location 不允许“最大前缀”匹配结果，必须严格等于，严格精确匹配。</p>\n<p>例题 3 ：“ ^~ ”前缀的使用<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;</span><br><span class=\"line\">       location /exact/match.html &#123;</span><br><span class=\"line\">           allow all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       location ^~ / &#123;</span><br><span class=\"line\">           root   html;</span><br><span class=\"line\">           index  index.html index.htm;</span><br><span class=\"line\">           deny all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       location ~ \\.html$ &#123;</span><br><span class=\"line\">           allow all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>把例题 2 中的 location / {} 修改成 location ^~ / {} ，再看看测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>URL请求</th>\n<th style=\"text-align:center\">修改前</th>\n<th style=\"text-align:center\">修改后</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://localhost:9090/\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/</a></td>\n<td style=\"text-align:center\">403 Forbidden</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/index.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index.html</a></td>\n<td style=\"text-align:center\">Welcome to nginx!</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/index_notfound.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index_notfound.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/exact/match.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/exact/match.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n</tbody>\n</table>\n<p>除了 GET /exact/match.html 是 404 Not Found ，其余都是 403 Forbidden ，原因很简单所有请求都是以“ / ”开头，所以所有请求都能匹配上“ / ”普通 location ，但普通 location 的匹配原则是“最大前缀”，所以只有/exact/match.html 匹配到 location /exact/match.html {allow all;} ，其余都 location ^~ / {deny all;} 并终止正则搜索。</p>\n<p>例题 4 ：“ = ”前缀的使用<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;</span><br><span class=\"line\">       location /exact/match.html &#123;</span><br><span class=\"line\">           allow all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       location = / &#123;</span><br><span class=\"line\">           root   html;</span><br><span class=\"line\">           index  index.html index.htm;</span><br><span class=\"line\">           deny all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       location ~ \\.html$ &#123;</span><br><span class=\"line\">           allow all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>例题 4 相对例题 2 把 location / {} 修改成了 location = / {} ，再次测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>URL请求</th>\n<th style=\"text-align:center\">修改前</th>\n<th style=\"text-align:center\">修改后</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://localhost:9090/\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/</a></td>\n<td style=\"text-align:center\">403 Forbidden</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/index.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index.html</a></td>\n<td style=\"text-align:center\">Welcome to nginx!</td>\n<td style=\"text-align:center\">Welcome to nginx!</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/index_notfound.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/index_notfound.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/exact/match.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/exact/match.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/test.jsp\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/test.jsp</a></td>\n<td style=\"text-align:center\">403 Forbidden</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n</tbody>\n</table>\n<p>最能说明问题的测试是 GET /test.jsp ，实际上 /test.jsp 没有匹配正则 location （ location ~.html$ ），也没有匹配 location = / {} ，如果按照 location / {} 的话，会“最大前缀”匹配到普通 location / {} ，结果是 deny all 。</p>\n<ul>\n<li><strong>正则 location 与编辑顺序</strong><br>location 的指令与编辑顺序无关，这句话不全对。对于普通 location 指令，匹配规则是：最大前缀匹配（与顺序无关），如果恰好是严格精确匹配结果或者加有前缀“ ^~ ”或“ = ”（符号“ = ”只能严格匹配，不能前缀匹配），则停止搜索正则 location ；但对于正则 location 的匹配规则是：按编辑顺序逐个匹配（与顺序有关），只要匹配上，就立即停止后面的搜索。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置 3.1</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;</span><br><span class=\"line\">       location ~ \\.html$ &#123;</span><br><span class=\"line\">           allow all; </span><br><span class=\"line\">       &#125;  </span><br><span class=\"line\">       location ~ ^/prefix/.*\\.html$ &#123;</span><br><span class=\"line\">           deny all;  </span><br><span class=\"line\">       &#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">配置 3.2</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;     </span><br><span class=\"line\">       location ~ ^/prefix/.*\\.html$ &#123;</span><br><span class=\"line\">           deny all;  </span><br><span class=\"line\">       &#125;            </span><br><span class=\"line\">       location ~ \\.html$ &#123;</span><br><span class=\"line\">           allow all; </span><br><span class=\"line\">       &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>URL请求</th>\n<th style=\"text-align:center\">配置3.1</th>\n<th style=\"text-align:center\">配置3.2</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://localhost:9090/regextest.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/regextest.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/prefix/regextest.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/prefix/regextest.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n</tbody>\n</table>\n<p>解释：<br><code>Location ~ ^/prefix/.*\\.html$ {deny all;}</code> 表示正则 location 对于以 /prefix/ 开头， .html 结尾的所有 URI 请求，都拒绝访问；   <code>location ~\\.html${allow all;}</code> 表示正则 location 对于以 .html 结尾的 URI 请求，都允许访问。 实际上，prefix 的是 ~.html$ 的子集。</p>\n<p>在“配置 3.1 ”下，两个请求都匹配上 <code>location ~\\.html$ {allow all;}</code> ，并且停止后面的搜索，于是都允许访问， 404 Not Found ；在“配置 3.2 ”下， /regextest.html 无法匹配 prefix ，于是继续搜索 ~.html$ ，允许访问，于是 404 Not Found ；然而 /prefix/regextest.html 匹配到 prefix ，于是 deny all ， 403 Forbidden 。<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置 3.3</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost; </span><br><span class=\"line\">       location  /prefix/ &#123;</span><br><span class=\"line\">               deny all;  </span><br><span class=\"line\">       &#125;           </span><br><span class=\"line\">       location  /prefix/mid/ &#123;</span><br><span class=\"line\">               allow all; </span><br><span class=\"line\">       &#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">配置 3.4</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;    </span><br><span class=\"line\">       location  /prefix/mid/ &#123;</span><br><span class=\"line\">               allow all; </span><br><span class=\"line\">       &#125;  </span><br><span class=\"line\">        location  /prefix/ &#123;</span><br><span class=\"line\">               deny all;  </span><br><span class=\"line\">       &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>URL请求</th>\n<th style=\"text-align:center\">配置3.3</th>\n<th style=\"text-align:center\">配置3.4</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://localhost:9090/prefix/t.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/prefix/t.html</a></td>\n<td style=\"text-align:center\">403 Forbidden</td>\n<td style=\"text-align:center\">403 Forbidden</td>\n</tr>\n<tr>\n<td>curl <a href=\"http://localhost:9090/prefix/mid/t.html\" target=\"_blank\" rel=\"noopener\">http://localhost:9090/prefix/mid/t.html</a></td>\n<td style=\"text-align:center\">404 Not Found</td>\n<td style=\"text-align:center\">404 Not Found</td>\n</tr>\n</tbody>\n</table>\n<p>测试结果表明：普通 location 的匹配规则是“最大前缀”匹配，而且与编辑顺序无关。</p>\n<ul>\n<li><strong>“@” 前缀 Named Location 使用</strong><br>REFER:  <a href=\"http://wiki.nginx.org/HttpCoreModule#error_page\" target=\"_blank\" rel=\"noopener\">http://wiki.nginx.org/HttpCoreModule#error_page</a><br>假设配置如下：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">       listen       9090;</span><br><span class=\"line\">       server_name  localhost;</span><br><span class=\"line\">       location  / &#123;</span><br><span class=\"line\">           root   html;</span><br><span class=\"line\">           index  index.html index.htm;</span><br><span class=\"line\">           allow all;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"comment\">#error_page 404 http://www.baidu.com # 直接这样是不允许的</span></span><br><span class=\"line\">       error_page 404 = @fallback;</span><br><span class=\"line\">\t   </span><br><span class=\"line\">       location @fallback &#123;</span><br><span class=\"line\">           proxy_pass http://www.baidu.com;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>上述配置文件的意思是：如果请求的 URI 存在，则本 nginx 返回对应的页面；如果不存在，则把请求代理到baidu.com 上去做个弥补（注： nginx 当发现 URI 对应的页面不存在， HTTP_StatusCode 会是 404 ，此时error_page 404 指令能捕获它）。</p>\n<p>测试一：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/nofound.html -i</span></span><br><span class=\"line\">HTTP/1.1 302 Found</span><br><span class=\"line\">Server: nginx/1.1.0</span><br><span class=\"line\">Date: Sat, 06 Aug 2011 08:17:21 GMT</span><br><span class=\"line\">Content-Type: text/html; charset=iso-8859-1</span><br><span class=\"line\">Location: http://localhost:9090/search/error.html</span><br><span class=\"line\">Connection: keep-alive</span><br><span class=\"line\">Cache-Control: max-age=86400</span><br><span class=\"line\">Expires: Sun, 07 Aug 2011 08:17:21 GMT</span><br><span class=\"line\">Content-Length: 222</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC “-//IETF//DTD HTML 2.0//EN”&gt;</span><br><span class=\"line\">&lt;html&gt;&lt;head&gt;</span><br><span class=\"line\">&lt;title&gt;302 Found&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;&lt;body&gt;</span><br><span class=\"line\">&lt;h1&gt;Found&lt;/h1&gt;</span><br><span class=\"line\">&lt;p&gt;The document has moved &lt;a href=”http://www.baidu.com/search/error.html”&gt;here&lt;/a&gt;.&lt;/p&gt;</span><br><span class=\"line\">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>当我们 GET /nofound.html 发送给本 nginx ， nginx 找不到对应的页面，于是 error_page 404 = @fallback ，请求被代理到 <a href=\"http://www.baidu.com\" target=\"_blank\" rel=\"noopener\">http://www.baidu.com</a> ，于是 nginx 给 <a href=\"http://www.baidu.com\" target=\"_blank\" rel=\"noopener\">http://www.baidu.com</a> 发送了 GET /nofound.html ，但/nofound.html 页面在百度也不存在，百度 302 跳转到错误页。<br>直接访问 <a href=\"http://www.baidu.com/nofound.html\" target=\"_blank\" rel=\"noopener\">http://www.baidu.com/nofound.html</a> 结果：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://www.baidu.com/nofound.html -i</span></span><br><span class=\"line\">HTTP/1.1 302 Found</span><br><span class=\"line\">Date: Sat, 06 Aug 2011 08:20:05 GMT</span><br><span class=\"line\">Server: Apache</span><br><span class=\"line\">Location: http://www.baidu.com/search/error.html</span><br><span class=\"line\">Cache-Control: max-age=86400</span><br><span class=\"line\">Expires: Sun, 07 Aug 2011 08:20:05 GMT</span><br><span class=\"line\">Content-Length: 222</span><br><span class=\"line\">Connection: Keep-Alive</span><br><span class=\"line\">Content-Type: text/html; charset=iso-8859-1</span><br><span class=\"line\"> </span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC “-//IETF//DTD HTML 2.0//EN”&gt;</span><br><span class=\"line\">&lt;html&gt;&lt;head&gt;</span><br><span class=\"line\">&lt;title&gt;302 Found&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;&lt;body&gt;</span><br><span class=\"line\">&lt;h1&gt;Found&lt;/h1&gt;</span><br><span class=\"line\">&lt;p&gt;The document has moved &lt;a href=”http://www.baidu.com/search/error.html”&gt;here&lt;/a&gt;.&lt;/p&gt;</span><br><span class=\"line\">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>测试二：访问一个 nginx 不存在，但 baidu 存在的页面<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://www.baidu.com/duty/ -i</span></span><br><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">Date: Sat, 06 Aug 2011 08:21:56 GMT</span><br><span class=\"line\">Server: Apache</span><br><span class=\"line\">P3P: CP=” OTI DSP COR IVA OUR IND COM ”</span><br><span class=\"line\">P3P: CP=” OTI DSP COR IVA OUR IND COM ”</span><br><span class=\"line\">Set-Cookie: BAIDUID=5C5D2B2FD083737A0C88CA7075A6601A:FG=1; expires=Sun, 05-Aug-12 08:21:56 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1</span><br><span class=\"line\">Set-Cookie: BAIDUID=5C5D2B2FD083737A2337F78F909CCB90:FG=1; expires=Sun, 05-Aug-12 08:21:56 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1</span><br><span class=\"line\">Last-Modified: Wed, 05 Jan 2011 06:44:53 GMT</span><br><span class=\"line\">ETag: “d66-49913b8efe340″</span><br><span class=\"line\">Accept-Ranges: bytes</span><br><span class=\"line\">Content-Length: 3430</span><br><span class=\"line\">Cache-Control: max-age=86400</span><br><span class=\"line\">Expires: Sun, 07 Aug 2011 08:21:56 GMT</span><br><span class=\"line\">Vary: Accept-Encoding,User-Agent</span><br><span class=\"line\">Connection: Keep-Alive</span><br><span class=\"line\">Content-Type: text/html</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC “-//W3C//DTD HTML 4.01 Transitional//EN”</span><br><span class=\"line\">“http://www.w3.org/TR/html4/loose.dtd”&gt;</span><br><span class=\"line\">。。。。</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>\n<p>显示，的确百度这个页面是存在的。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@web108 ~]<span class=\"comment\"># curl http://localhost:9090/duty/ -i</span></span><br><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">Server: nginx/1.1.0</span><br><span class=\"line\">Date: Sat, 06 Aug 2011 08:23:23 GMT</span><br><span class=\"line\">Content-Type: text/html</span><br><span class=\"line\">Connection: keep-alive</span><br><span class=\"line\">P3P: CP=” OTI DSP COR IVA OUR IND COM ”</span><br><span class=\"line\">P3P: CP=” OTI DSP COR IVA OUR IND COM ”</span><br><span class=\"line\">Set-Cookie: BAIDUID=8FEF0A3A2C31D277DCB4CC5F80B7F457:FG=1; expires=Sun, 05-Aug-12 08:23:23 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1</span><br><span class=\"line\">Set-Cookie: BAIDUID=8FEF0A3A2C31D277B1F87691AFFD7440:FG=1; expires=Sun, 05-Aug-12 08:23:23 GMT; max-age=31536000; path=/; domain=.baidu.com; version=1</span><br><span class=\"line\">Last-Modified: Wed, 05 Jan 2011 06:44:53 GMT</span><br><span class=\"line\">ETag: “d66-49913b8efe340″</span><br><span class=\"line\">Accept-Ranges: bytes</span><br><span class=\"line\">Content-Length: 3430</span><br><span class=\"line\">Cache-Control: max-age=86400</span><br><span class=\"line\">Expires: Sun, 07 Aug 2011 08:23:23 GMT</span><br><span class=\"line\">Vary: Accept-Encoding,User-Agent</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC “-//W3C//DTD HTML 4.01 Transitional//EN”</span><br><span class=\"line\">“http://www.w3.org/TR/html4/loose.dtd”&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">。。。</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>当 <code>curl http://localhost:9090/duty/ -i</code> 时， nginx 没找到对应的页面，于是 error_page = @fallback ，把请求代理到 baidu.com 。注意这里的 error_page = @fallback 不是靠重定向实现的，而是所说的“ internally redirected （forward ）”。</p>\n<h3 id=\"proxy-pass-URL-末尾加与不加-（斜线）的区别\"><a href=\"#proxy-pass-URL-末尾加与不加-（斜线）的区别\" class=\"headerlink\" title=\"proxy_pass URL 末尾加与不加/（斜线）的区别\"></a>proxy_pass URL 末尾加与不加/（斜线）的区别</h3><blockquote>\n<p>Proxy_pass末尾带”/”和不带是有区别的：<br>不带斜杠转发的是除hostname以外的部分，包括目录。可以使用正则表达式匹配location，且任意正则匹配成功后，转发的都是完整目录路径。<br>带斜杠转发的是除hostname及目录外的所有部分。不能使用正则表达式匹配location块，只能使用完整路径名准确匹配。</p>\n</blockquote>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span> &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td><a href=\"http://127.0.0.1:8087/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/tobaidu</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/tobaidu/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span> &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>/define;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td><a href=\"http://127.0.0.1:8087/define\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span>/ &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td>重定向到<a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/tobaidu/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span>/ &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>/define;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td>重定向到<a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/define\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span> &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td><a href=\"http://127.0.0.1:8087/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087//\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087//</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087//xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087//xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">6</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span> &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>/define/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/define//\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define//</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/define//xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define//xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">7</span></span><br><span class=\"line\"><span class=\"keyword\">location</span> <span class=\"title\">/tobaidu</span>/ &#123;</span><br><span class=\"line\">    proxy_pass http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span>/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td>重定向到<a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置<span class=\"number\">8</span></span><br><span class=\"line\">location <span class=\"regexp\">/tobaidu/</span> &#123;</span><br><span class=\"line\">    proxy_pass http:<span class=\"regexp\">//</span><span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">8087</span><span class=\"regexp\">/define/</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试结果：</p>\n<table>\n<thead>\n<tr>\n<th>请求URL</th>\n<th>请求结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu</a></td>\n<td>重定向到<a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/</a></td>\n</tr>\n<tr>\n<td>curl <a href=\"http://127.0.0.1/tobaidu/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/tobaidu/xxxx</a></td>\n<td><a href=\"http://127.0.0.1:8087/define/xxxx\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8087/define/xxxx</a></td>\n</tr>\n</tbody>\n</table>\n<p><strong>结论</strong><br><em>URL符合 <code>protocol://ip:port</code> 同时结尾不加/,则nginx会代理匹配路径部分,否则不代理匹配路径,同时自动添加不匹配路径”部分”,比如/tobaidu/xxxx的/xxxx部分</em></p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cjw6jley00000p4n7rtkrzy0g","category_id":"cjw6jleyc0004p4n73b3ire6w","_id":"cjw6jleyq000hp4n7f5i4jabo"},{"post_id":"cjw6jley60002p4n7xpj2w6m8","category_id":"cjw6jleyc0004p4n73b3ire6w","_id":"cjw6jleyu000mp4n7lxku6vhe"},{"post_id":"cjw6jleyr000jp4n722c6b6pr","category_id":"cjw6jleyc0004p4n73b3ire6w","_id":"cjw6jleyy000tp4n75yv01fs5"},{"post_id":"cjw6jleye0006p4n7qla5itt2","category_id":"cjw6jleyq000gp4n73z1rp93k","_id":"cjw6jlez0000xp4n70dw6yfsl"},{"post_id":"cjw6jleyh0008p4n7w4j459wm","category_id":"cjw6jleyu000np4n72e96y9pf","_id":"cjw6jlez10010p4n7uvseq0xd"},{"post_id":"cjw6jleyk000ap4n74ccnzwe3","category_id":"cjw6jleyy000up4n7a1l4gum4","_id":"cjw6jlez40015p4n7rjwjx4f2"},{"post_id":"cjw6jleyo000ep4n7yaqnmszi","category_id":"cjw6jlez20011p4n7evn1dq8l","_id":"cjw6jlez6001ap4n7hbqcfwt7"},{"post_id":"cjw6jleyp000fp4n70fhjbu6m","category_id":"cjw6jleyu000np4n72e96y9pf","_id":"cjw6jlez8001fp4n7jnnzzyrx"},{"post_id":"cjw6jleyt000lp4n7lluv22oa","category_id":"cjw6jleyu000np4n72e96y9pf","_id":"cjw6jlez9001ip4n74nu4s64c"},{"post_id":"cjw6jleyv000qp4n781v9gg52","category_id":"cjw6jlez7001ep4n7saz58jkg","_id":"cjw6jlezb001np4n7ctzxfi2n"},{"post_id":"cjw6jleyx000sp4n74h3vtq2v","category_id":"cjw6jlez7001ep4n7saz58jkg","_id":"cjw6jleze001rp4n7fbue09dp"},{"post_id":"cjw6jleyz000wp4n7owjt9azi","category_id":"cjw6jlez7001ep4n7saz58jkg","_id":"cjw6jlezf001vp4n7c8tb5qgt"},{"post_id":"cjw6jlez0000zp4n79apd6t0b","category_id":"cjw6jlez7001ep4n7saz58jkg","_id":"cjw6jlezh001zp4n7lj15zw0n"},{"post_id":"cjw6jlez20012p4n7xaq1nk9y","category_id":"cjw6jlez7001ep4n7saz58jkg","_id":"cjw6jlezj0022p4n71uln7b0k"},{"post_id":"cjw6jlez30014p4n7ypdhtw9j","category_id":"cjw6jlez7001ep4n7saz58jkg","_id":"cjw6jlezk0025p4n7b7ln9u2i"},{"post_id":"cjw6jlf0j0027p4n77u7evesf","category_id":"cjw6jlez20011p4n7evn1dq8l","_id":"cjw6jlf0n002dp4n73f6jvld3"},{"post_id":"cjw6jlf0k0028p4n7auqz2ccw","category_id":"cjw6jleyu000np4n72e96y9pf","_id":"cjw6jlf0p002gp4n70nr9djij"},{"post_id":"cjw6jlf0m002cp4n7dqhjquuz","category_id":"cjw6jlez20011p4n7evn1dq8l","_id":"cjw6jlf0s002mp4n7i6mpjbld"},{"post_id":"cjw6jlf0l002ap4n7m0pm300j","category_id":"cjw6jlf0n002ep4n7u2z2i4fl","_id":"cjw6jlf0u002rp4n7a3rprlpm"},{"post_id":"cjw6jlf0o002fp4n7d54m45ap","category_id":"cjw6jlf0n002ep4n7u2z2i4fl","_id":"cjw6jlf0v002tp4n7q87ncszn"},{"post_id":"cjw6jlf0q002jp4n7qrjpt5es","category_id":"cjw6jlf0u002qp4n7r13m2w8g","_id":"cjw6jlf0w002wp4n7ymhna2wt"},{"post_id":"cjw6jlf0s002lp4n76yld7u6h","category_id":"cjw6jlf0v002up4n7p5twjbg0","_id":"cjw6jlf0x002zp4n7kta587j8"},{"post_id":"cjw6jlf1v0035p4n7ir2wqrou","category_id":"cjw6jlez20011p4n7evn1dq8l","_id":"cjw6jlf22003ap4n7e7gy1um6"},{"post_id":"cjw6jlf1w0036p4n7tcq9wuxw","category_id":"cjw6jlf0n002ep4n7u2z2i4fl","_id":"cjw6jlf24003cp4n7cdpabmby"},{"post_id":"cjw6jlf200038p4n7lavirhxc","category_id":"cjw6jlf23003bp4n7ti3zh1b5","_id":"cjw6jlf27003gp4n7j62hzqa3"},{"post_id":"cjw6jlf52003ip4n79gf889i9","category_id":"cjw6jleyu000np4n72e96y9pf","_id":"cjw6jlf55003lp4n7ipysnwif"}],"PostTag":[{"post_id":"cjw6jley00000p4n7rtkrzy0g","tag_id":"cjw6jleyd0005p4n79gffs39f","_id":"cjw6jleyn000dp4n7yse063n1"},{"post_id":"cjw6jley60002p4n7xpj2w6m8","tag_id":"cjw6jleyl000cp4n76p6ey7zz","_id":"cjw6jleys000kp4n7izr35hrh"},{"post_id":"cjw6jleyr000jp4n722c6b6pr","tag_id":"cjw6jleyl000cp4n76p6ey7zz","_id":"cjw6jleyv000pp4n765oxjwqb"},{"post_id":"cjw6jleye0006p4n7qla5itt2","tag_id":"cjw6jleyr000ip4n7et5xzxyp","_id":"cjw6jleyw000rp4n7yzodrz4v"},{"post_id":"cjw6jleyh0008p4n7w4j459wm","tag_id":"cjw6jleyu000op4n772s02g8o","_id":"cjw6jlez0000yp4n7go2s2o52"},{"post_id":"cjw6jleyk000ap4n74ccnzwe3","tag_id":"cjw6jleyy000vp4n7fs8vrgj0","_id":"cjw6jlez50018p4n7tjzhvhww"},{"post_id":"cjw6jleyk000ap4n74ccnzwe3","tag_id":"cjw6jlez30013p4n74ove8bv3","_id":"cjw6jlez6001bp4n7mmmvyf37"},{"post_id":"cjw6jleyo000ep4n7yaqnmszi","tag_id":"cjw6jlez50017p4n7pfpdzegl","_id":"cjw6jlez7001dp4n7i974jb2j"},{"post_id":"cjw6jleyp000fp4n70fhjbu6m","tag_id":"cjw6jlez7001cp4n73aka15ab","_id":"cjw6jlez9001hp4n78fsrqmm1"},{"post_id":"cjw6jleyt000lp4n7lluv22oa","tag_id":"cjw6jlez9001gp4n7iuohej1i","_id":"cjw6jlezb001lp4n7dvbexyyz"},{"post_id":"cjw6jleyv000qp4n781v9gg52","tag_id":"cjw6jleza001kp4n74f4vskz3","_id":"cjw6jlezd001pp4n7gfnf4tkx"},{"post_id":"cjw6jleyx000sp4n74h3vtq2v","tag_id":"cjw6jleza001kp4n74f4vskz3","_id":"cjw6jlezf001tp4n7l71ktutl"},{"post_id":"cjw6jleyz000wp4n7owjt9azi","tag_id":"cjw6jleza001kp4n74f4vskz3","_id":"cjw6jlezh001xp4n7epv0wsh7"},{"post_id":"cjw6jlez0000zp4n79apd6t0b","tag_id":"cjw6jleza001kp4n74f4vskz3","_id":"cjw6jlezj0021p4n7bo2ztzx5"},{"post_id":"cjw6jlez20012p4n7xaq1nk9y","tag_id":"cjw6jleza001kp4n74f4vskz3","_id":"cjw6jlezk0024p4n7e4iqicl7"},{"post_id":"cjw6jlez30014p4n7ypdhtw9j","tag_id":"cjw6jleza001kp4n74f4vskz3","_id":"cjw6jlezk0026p4n7tqnx0q4u"},{"post_id":"cjw6jlf0k0028p4n7auqz2ccw","tag_id":"cjw6jleyu000op4n772s02g8o","_id":"cjw6jlf0m002bp4n7ylc0hgx8"},{"post_id":"cjw6jlf0m002cp4n7dqhjquuz","tag_id":"cjw6jlez50017p4n7pfpdzegl","_id":"cjw6jlf0q002ip4n7e81ms78g"},{"post_id":"cjw6jlf0j0027p4n77u7evesf","tag_id":"cjw6jlf0k0029p4n7dw11ci2a","_id":"cjw6jlf0s002kp4n78jadpnxl"},{"post_id":"cjw6jlf0l002ap4n7m0pm300j","tag_id":"cjw6jlf0p002hp4n72u9f85f2","_id":"cjw6jlf0u002pp4n7a5xps7iv"},{"post_id":"cjw6jlf0o002fp4n7d54m45ap","tag_id":"cjw6jlf0t002op4n7dly6kahs","_id":"cjw6jlf0x002yp4n7f1euohb4"},{"post_id":"cjw6jlf0o002fp4n7d54m45ap","tag_id":"cjw6jlf0v002sp4n7c40k308i","_id":"cjw6jlf0x0030p4n7forhiard"},{"post_id":"cjw6jlf0o002fp4n7d54m45ap","tag_id":"cjw6jlf0w002vp4n7i2bz78m2","_id":"cjw6jlf0y0032p4n7kmgsl3qp"},{"post_id":"cjw6jlf0q002jp4n7qrjpt5es","tag_id":"cjw6jlf0w002xp4n7b2qts5i1","_id":"cjw6jlf0y0033p4n7y3ny5blv"},{"post_id":"cjw6jlf0s002lp4n76yld7u6h","tag_id":"cjw6jlf0y0031p4n7ltdgsqk3","_id":"cjw6jlf0z0034p4n7zskzjwds"},{"post_id":"cjw6jlf1v0035p4n7ir2wqrou","tag_id":"cjw6jlf0k0029p4n7dw11ci2a","_id":"cjw6jlf1z0037p4n7vzpdsngk"},{"post_id":"cjw6jlf1w0036p4n7tcq9wuxw","tag_id":"cjw6jlf0v002sp4n7c40k308i","_id":"cjw6jlf26003ep4n72bd7q8hk"},{"post_id":"cjw6jlf1w0036p4n7tcq9wuxw","tag_id":"cjw6jlf220039p4n7w32f0zqz","_id":"cjw6jlf27003fp4n7w4x0ws0g"},{"post_id":"cjw6jlf200038p4n7lavirhxc","tag_id":"cjw6jlf26003dp4n7a0m2g0fb","_id":"cjw6jlf27003hp4n78uma8mix"},{"post_id":"cjw6jlf52003ip4n79gf889i9","tag_id":"cjw6jlez7001cp4n73aka15ab","_id":"cjw6jlf54003kp4n7o3kz8m0a"}],"Tag":[{"name":"aliyun","_id":"cjw6jleyd0005p4n79gffs39f"},{"name":"Linux","_id":"cjw6jleyl000cp4n76p6ey7zz"},{"name":"hexo","_id":"cjw6jleyr000ip4n7et5xzxyp"},{"name":"https","_id":"cjw6jleyu000op4n772s02g8o"},{"name":"docker","_id":"cjw6jleyy000vp4n7fs8vrgj0"},{"name":"kubernetes","_id":"cjw6jlez30013p4n74ove8bv3"},{"name":"git","_id":"cjw6jlez50017p4n7pfpdzegl"},{"name":"nginx","_id":"cjw6jlez7001cp4n73aka15ab"},{"name":"tomcat","_id":"cjw6jlez9001gp4n7iuohej1i"},{"name":"zabbix","_id":"cjw6jleza001kp4n74f4vskz3"},{"name":"ansible","_id":"cjw6jlf0k0029p4n7dw11ci2a"},{"name":"x-pack","_id":"cjw6jlf0p002hp4n72u9f85f2"},{"name":"elasticsearch","_id":"cjw6jlf0t002op4n7dly6kahs"},{"name":"filebeat","_id":"cjw6jlf0v002sp4n7c40k308i"},{"name":"kibana","_id":"cjw6jlf0w002vp4n7i2bz78m2"},{"name":"markdown","_id":"cjw6jlf0w002xp4n7b2qts5i1"},{"name":"prometheus","_id":"cjw6jlf0y0031p4n7ltdgsqk3"},{"name":"efk","_id":"cjw6jlf220039p4n7w32f0zqz"},{"name":"mysql","_id":"cjw6jlf26003dp4n7a0m2g0fb"}]}}